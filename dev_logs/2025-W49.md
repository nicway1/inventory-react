# Development Log - Week 49 (Dec 1-7, 2025)

## Monday, Dec 1

### Tasks Completed

- **Asset Company Grouping Enforcement in Inventory Views**
  - Issue: Company grouping (parent/child relationships) was not being enforced when filtering inventory
  - When selecting a parent company, child company assets were not included in results

  **Backend Changes (`routes/inventory.py`):**
  - Updated `api_sf_filters()` to include parent/child company relationship info:
    - `parent_company` - name of parent company (if any)
    - `is_parent` - boolean flag for parent companies
    - `child_companies` - list of child company names
    - `company_grouping` - mapping of child company -> parent company
  - Updated `api_sf_assets()` to include `parent_company` field for each asset
  - Pre-fetch company grouping info for efficiency
  - Updated `filter_inventory()` to filter by parent + all child companies when parent is selected
  - Updated `view_inventory()` to return companies as dicts with `value`, `label`, and `is_parent`

  **Frontend Changes (SF View - `templates/inventory/view_sf.html`):**
  - Updated company filter logic to match assets by:
    - Direct company match OR
    - Parent company match (for child company assets)
  - Filter now shows grouped display names (e.g., "Wise (Firstbase)")

  **Frontend Changes (Old View - `templates/inventory/view.html`):**
  - Updated company dropdown to show grouped display names
  - Added visual indicator (▼) for parent companies with children

- **Extended Company Permission Filtering to SUPERVISOR Users**
  - Previously only COUNTRY_ADMIN had company-based filtering
  - Now SUPERVISOR users also filter by `UserCompanyPermission` records

  **Backend Changes:**
  - `routes/inventory.py` - Added SUPERVISOR to permission checks in:
    - `view_inventory()` - counts and initial data
    - `view_tech_assets()` - API endpoint for DataTable
  - `routes/main.py` - Home page dashboard counts filter by company permissions
  - `routes/dashboard.py` - `load_widget_data()` filters inventory stats

- **Admin UI for SUPERVISOR Company Permissions**
  - Super Admins can now assign company permissions to SUPERVISOR users
  - `routes/admin.py` - Updated `edit_user()` and `create_user()` to handle SUPERVISOR
  - `templates/admin/edit_user.html` - JS toggle shows company selection for SUPERVISOR
  - `templates/admin/create_user.html` - JS toggle shows company selection for SUPERVISOR

- **SQLAlchemy Session Concurrency Fix**
  - Fixed `with db_manager as db:` pattern causing shared session issues
  - Changed to `db_session = db_manager.get_session()` with proper cleanup
  - Affected: `routes/main.py` index route

- **Debug/Fix Routes for Company Permissions**
  - Added `/debug-user-company-permissions/<user_id>` to check permissions
  - Added `/fix-user-company-permissions/<user_id>` to auto-fix missing permissions

- **Quick Actions Widget Permission Fixes**
  - Issue: SUPERVISOR users could see links they don't have permission to access
  - `templates/widgets/quick_actions.html` - Added conditional rendering:
    - New Ticket - available to all users
    - Add Asset - SUPER_ADMIN, DEVELOPER, COUNTRY_ADMIN only
    - Add Customer - SUPER_ADMIN, DEVELOPER, COUNTRY_ADMIN only
    - Reports - SUPER_ADMIN, DEVELOPER only
    - Inventory - SUPER_ADMIN, DEVELOPER, SUPERVISOR, COUNTRY_ADMIN

- **Launchpad (App Launcher) Widget Permission Fixes**
  - Issue: SUPERVISOR users could see admin links in the launcher
  - `templates/widgets/launchpad.html` - Added conditional rendering:
    - Tickets, New Ticket, Knowledge, Documents, Settings, Profile - all users
    - Inventory, Accessories - SUPER_ADMIN, DEVELOPER, SUPERVISOR, COUNTRY_ADMIN
    - Add Asset, Customers - SUPER_ADMIN, DEVELOPER, COUNTRY_ADMIN only
    - Reports, Companies, Users, Queues, Activity - SUPER_ADMIN, DEVELOPER only
    - Billing - SUPER_ADMIN only

- **Widget Availability Permission Fix**
  - `models/dashboard_widget.py` - Fixed `get_available_widgets_for_user()`
  - Now properly looks up permissions from Permission table by user_type
  - Previously `user.permissions` didn't exist, causing all widgets to show

### Files Modified
- `routes/inventory.py` - Backend filtering logic + SUPERVISOR support
- `routes/main.py` - Home page counts + debug routes + session fix
- `routes/dashboard.py` - Widget data filtering
- `routes/admin.py` - SUPERVISOR company permission management
- `templates/inventory/view_sf.html` - SF inventory view JavaScript
- `templates/inventory/view.html` - Old inventory view template
- `templates/admin/edit_user.html` - SUPERVISOR company selection
- `templates/admin/create_user.html` - SUPERVISOR company selection
- `templates/widgets/quick_actions.html` - Permission-based link visibility
- `templates/widgets/launchpad.html` - Permission-based link visibility
- `models/dashboard_widget.py` - Widget permission checking

### How It Works Now
1. Parent companies show with their grouped display name in filters
2. Selecting a parent company filter includes all child company assets
3. The `▼` indicator shows which companies are parent companies
4. Example: Selecting "Firstbase" will show assets from Firstbase AND all child companies like "Wise"
5. SUPERVISOR and COUNTRY_ADMIN users only see assets from their permitted companies
6. Dashboard counts and widgets respect company permissions
7. Quick Actions widget only shows links user has permission to access

---

## Tuesday, Dec 2

### Tasks Completed
- (pending)

---

## Wednesday, Dec 3

### Tasks Completed
- (pending)

---

## Thursday, Dec 4

### Tasks Completed
- (pending)

---

## Friday, Dec 5

### Tasks Completed
- (pending)

---

## Weekend Notes
- (if applicable)
