{% extends "base.html" %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Salesforce-style colors */
    :root {
        --sf-blue: #0176d3;
        --sf-blue-dark: #014486;
        --sf-blue-light: #1b96ff;
        --sf-gray-100: #f3f3f3;
        --sf-gray-200: #e5e5e5;
        --sf-gray-300: #c9c9c9;
        --sf-gray-600: #706e6b;
        --sf-gray-800: #3e3e3c;
        --sf-success: #2e844a;
        --sf-warning: #fe9339;
        --sf-error: #ea001e;
    }

    /* Main layout */
    .sf-page {
        background: var(--sf-gray-100);
        min-height: 100vh;
    }

    /* Header bar */
    .sf-header {
        background: white;
        border-bottom: 1px solid var(--sf-gray-200);
        padding: 0.75rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .sf-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .sf-breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--sf-gray-600);
    }

    .sf-breadcrumb a {
        color: var(--sf-blue);
        text-decoration: none;
    }

    .sf-breadcrumb a:hover {
        text-decoration: underline;
    }

    .sf-page-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--sf-gray-800);
    }

    .sf-header-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sf-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
        font-weight: 600;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.15s ease;
        border: 1px solid transparent;
    }

    .sf-btn-neutral {
        background: white;
        border-color: var(--sf-gray-300);
        color: var(--sf-gray-800);
    }

    .sf-btn-neutral:hover {
        background: var(--sf-gray-100);
    }

    .sf-btn-brand {
        background: var(--sf-blue);
        color: white;
    }

    .sf-btn-brand:hover {
        background: var(--sf-blue-dark);
    }

    .sf-btn-success {
        background: var(--sf-success);
        color: white;
    }

    .sf-btn-success:hover {
        background: #236839;
    }

    /* Main content area */
    .sf-content {
        display: flex;
        height: calc(100vh - 60px);
    }

    /* Filters sidebar */
    .sf-sidebar {
        width: 280px;
        background: white;
        border-right: 1px solid var(--sf-gray-200);
        overflow-y: auto;
        flex-shrink: 0;
        transition: width 0.2s ease;
    }

    .sf-sidebar.collapsed {
        width: 0;
        overflow: hidden;
    }

    .sf-sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--sf-gray-100);
    }

    .sf-sidebar-title {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--sf-gray-600);
    }

    .sf-filter-section {
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-filter-header {
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
    }

    .sf-filter-header:hover {
        background: var(--sf-gray-100);
    }

    .sf-filter-label {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--sf-gray-800);
    }

    .sf-filter-count {
        font-size: 0.75rem;
        color: var(--sf-gray-600);
        background: var(--sf-gray-200);
        padding: 0.125rem 0.5rem;
        border-radius: 1rem;
    }

    .sf-filter-content {
        padding: 0 1rem 1rem;
        max-height: 200px;
        overflow-y: auto;
    }

    .sf-filter-content.collapsed {
        display: none;
    }

    .sf-checkbox-item {
        display: flex;
        align-items: center;
        padding: 0.375rem 0;
        font-size: 0.8125rem;
        color: var(--sf-gray-800);
    }

    .sf-checkbox-item input {
        margin-right: 0.5rem;
        accent-color: var(--sf-blue);
    }

    .sf-checkbox-item .count {
        margin-left: auto;
        font-size: 0.75rem;
        color: var(--sf-gray-600);
    }

    /* Date range */
    .sf-date-range {
        padding: 1rem;
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-date-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--sf-gray-600);
        margin-bottom: 0.5rem;
        display: block;
    }

    .sf-date-inputs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .sf-date-input {
        flex: 1;
        padding: 0.5rem;
        font-size: 0.8125rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
    }

    .sf-date-presets {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    .sf-date-preset {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        background: var(--sf-gray-100);
        border: 1px solid var(--sf-gray-200);
        border-radius: 0.25rem;
        cursor: pointer;
    }

    .sf-date-preset:hover,
    .sf-date-preset.active {
        background: var(--sf-blue);
        color: white;
        border-color: var(--sf-blue);
    }

    /* Main area */
    .sf-main {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background: var(--sf-gray-100);
    }

    /* Summary cards */
    .sf-summary-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .sf-summary-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.25rem;
        border: 1px solid var(--sf-gray-200);
    }

    .sf-summary-card.highlight {
        border-left: 4px solid var(--sf-blue);
    }

    .sf-summary-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--sf-gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .sf-summary-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--sf-gray-800);
    }

    .sf-summary-value.blue { color: var(--sf-blue); }
    .sf-summary-value.green { color: var(--sf-success); }
    .sf-summary-value.orange { color: var(--sf-warning); }
    .sf-summary-value.red { color: var(--sf-error); }

    .sf-summary-subtitle {
        font-size: 0.75rem;
        color: var(--sf-gray-600);
        margin-top: 0.25rem;
    }

    /* Data preview section */
    .sf-preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .sf-preview-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--sf-gray-800);
    }

    .sf-preview-subtitle {
        font-size: 0.75rem;
        color: var(--sf-gray-600);
    }

    /* Chart container */
    .sf-chart-container {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid var(--sf-gray-200);
        margin-bottom: 1.5rem;
    }

    .sf-chart-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .sf-chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--sf-gray-800);
    }

    .sf-chart-body {
        padding: 1.5rem;
        height: 350px;
        position: relative;
    }

    .sf-chart-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--sf-gray-200);
        background: var(--sf-gray-100);
    }

    .sf-legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8125rem;
        color: var(--sf-gray-800);
    }

    .sf-legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }

    /* Data table */
    .sf-table-container {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid var(--sf-gray-200);
        overflow: hidden;
    }

    .sf-table-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .sf-table-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--sf-gray-800);
    }

    .sf-table {
        width: 100%;
        border-collapse: collapse;
    }

    .sf-table th {
        background: var(--sf-gray-100);
        padding: 0.75rem 1rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--sf-gray-600);
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-table td {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: var(--sf-gray-800);
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-table tr:hover {
        background: var(--sf-gray-100);
    }

    .sf-table-link {
        color: var(--sf-blue);
        text-decoration: none;
    }

    .sf-table-link:hover {
        text-decoration: underline;
    }

    /* Status badges */
    .sf-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 0.25rem;
    }

    .sf-badge-new { background: #e8f4ff; color: #0176d3; }
    .sf-badge-progress { background: #fef3cd; color: #856404; }
    .sf-badge-resolved { background: #d4edda; color: #155724; }
    .sf-badge-high { background: #f8d7da; color: #721c24; }
    .sf-badge-medium { background: #fff3cd; color: #856404; }
    .sf-badge-low { background: #d1ecf1; color: #0c5460; }

    /* Loading spinner */
    .sf-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--sf-gray-600);
    }

    .sf-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--sf-gray-200);
        border-top-color: var(--sf-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Toggle sidebar button */
    .sf-toggle-sidebar {
        position: fixed;
        left: 290px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 48px;
        background: white;
        border: 1px solid var(--sf-gray-200);
        border-left: none;
        border-radius: 0 4px 4px 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        transition: left 0.2s ease;
    }

    .sf-toggle-sidebar.collapsed {
        left: 0;
    }

    .sf-toggle-sidebar:hover {
        background: var(--sf-gray-100);
    }

    /* Group by selector */
    .sf-groupby {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sf-groupby-label {
        font-size: 0.8125rem;
        color: var(--sf-gray-600);
    }

    .sf-groupby-select {
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
        background: white;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .sf-summary-cards {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .sf-sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            height: calc(100vh - 60px);
            z-index: 200;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }

        .sf-summary-cards {
            grid-template-columns: 1fr;
        }
    }

    /* No data state */
    .sf-no-data {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--sf-gray-600);
    }

    .sf-no-data-icon {
        width: 48px;
        height: 48px;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="sf-page">
    <!-- Header -->
    <div class="sf-header">
        <div class="sf-header-left">
            <div class="sf-breadcrumb">
                <a href="{{ url_for('reports.index') }}">Reports</a>
                <span>/</span>
                <span>Advanced Case Reports</span>
            </div>
        </div>
        <div class="sf-header-actions">
            <button class="sf-btn sf-btn-neutral" onclick="resetFilters()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
                Reset All
            </button>
            <button class="sf-btn sf-btn-neutral" onclick="saveReport()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17,21 17,13 7,13 7,21"/>
                    <polyline points="7,3 7,8 15,8"/>
                </svg>
                Save Report
            </button>
            <button class="sf-btn sf-btn-success" onclick="exportReport()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export Report
            </button>
        </div>
    </div>

    <!-- Main content -->
    <div class="sf-content">
        <!-- Filters sidebar -->
        <div class="sf-sidebar" id="filterSidebar">
            <div class="sf-sidebar-header">
                <span class="sf-sidebar-title">Filters</span>
                <button class="sf-btn sf-btn-neutral" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="applyFilters()">
                    Apply
                </button>
            </div>

            <!-- Date Range -->
            <div class="sf-date-range">
                <label class="sf-date-label">Date Range</label>
                <div class="sf-date-inputs">
                    <input type="date" id="startDate" class="sf-date-input" onchange="updateDatePreset()">
                    <input type="date" id="endDate" class="sf-date-input" onchange="updateDatePreset()">
                </div>
                <div class="sf-date-presets">
                    <button class="sf-date-preset" data-days="7" onclick="setDateRange(7)">7d</button>
                    <button class="sf-date-preset active" data-days="30" onclick="setDateRange(30)">30d</button>
                    <button class="sf-date-preset" data-days="90" onclick="setDateRange(90)">90d</button>
                    <button class="sf-date-preset" data-days="365" onclick="setDateRange(365)">1y</button>
                </div>
            </div>

            <!-- Status Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('status')">
                    <span class="sf-filter-label">Status</span>
                    <span class="sf-filter-count" id="statusCount">0</span>
                </div>
                <div class="sf-filter-content" id="statusFilter"></div>
            </div>

            <!-- Priority Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('priority')">
                    <span class="sf-filter-label">Priority</span>
                    <span class="sf-filter-count" id="priorityCount">0</span>
                </div>
                <div class="sf-filter-content" id="priorityFilter"></div>
            </div>

            <!-- Category Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('category')">
                    <span class="sf-filter-label">Category</span>
                    <span class="sf-filter-count" id="categoryCount">0</span>
                </div>
                <div class="sf-filter-content" id="categoryFilter"></div>
            </div>

            <!-- Assigned To Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('assignedTo')">
                    <span class="sf-filter-label">Assigned To</span>
                    <span class="sf-filter-count" id="assignedToCount">0</span>
                </div>
                <div class="sf-filter-content" id="assignedToFilter"></div>
            </div>

            <!-- Country Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('country')">
                    <span class="sf-filter-label">Country</span>
                    <span class="sf-filter-count" id="countryCount">0</span>
                </div>
                <div class="sf-filter-content" id="countryFilter"></div>
            </div>
        </div>

        <!-- Toggle sidebar button -->
        <button class="sf-toggle-sidebar" id="toggleSidebar" onclick="toggleSidebar()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="toggleIcon">
                <polyline points="15,18 9,12 15,6"/>
            </svg>
        </button>

        <!-- Main area -->
        <div class="sf-main">
            <!-- Preview header -->
            <div class="sf-preview-header">
                <div>
                    <div class="sf-preview-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Data Preview
                    </div>
                    <div class="sf-preview-subtitle" id="ticketCountText">Found 0 tickets with your current filters</div>
                </div>
                <div class="sf-groupby">
                    <span class="sf-groupby-label">Group by:</span>
                    <select class="sf-groupby-select" id="groupBy" onchange="applyFilters()">
                        <option value="status">Status</option>
                        <option value="priority">Priority</option>
                        <option value="category">Category</option>
                        <option value="assigned_to">Assigned To</option>
                        <option value="country">Country</option>
                    </select>
                </div>
            </div>

            <!-- Summary cards -->
            <div class="sf-summary-cards">
                <div class="sf-summary-card highlight">
                    <div class="sf-summary-label">Total Tickets</div>
                    <div class="sf-summary-value blue" id="totalTickets">0</div>
                </div>
                <div class="sf-summary-card">
                    <div class="sf-summary-label">Resolved</div>
                    <div class="sf-summary-value green" id="resolvedTickets">0</div>
                </div>
                <div class="sf-summary-card">
                    <div class="sf-summary-label">Open</div>
                    <div class="sf-summary-value orange" id="openTickets">0</div>
                </div>
                <div class="sf-summary-card">
                    <div class="sf-summary-label">Resolution Rate</div>
                    <div class="sf-summary-value" id="resolutionRate">0%</div>
                    <div class="sf-summary-subtitle">Based on selected filters</div>
                </div>
            </div>

            <!-- Chart -->
            <div class="sf-chart-container">
                <div class="sf-chart-header">
                    <span class="sf-chart-title">Distribution by <span id="chartGroupLabel">status</span></span>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="sf-btn sf-btn-brand" style="padding: 0.25rem 0.5rem;" onclick="setChartType('pie')" id="btnPie">
                            Pie
                        </button>
                        <button class="sf-btn sf-btn-neutral" style="padding: 0.25rem 0.5rem;" onclick="setChartType('doughnut')" id="btnDoughnut">
                            Doughnut
                        </button>
                        <button class="sf-btn sf-btn-neutral" style="padding: 0.25rem 0.5rem;" onclick="setChartType('bar')" id="btnBar">
                            Bar
                        </button>
                        <button class="sf-btn sf-btn-neutral" style="padding: 0.25rem 0.5rem;" onclick="setChartType('horizontalBar')" id="btnHorizontalBar">
                            H-Bar
                        </button>
                        <button class="sf-btn sf-btn-neutral" style="padding: 0.25rem 0.5rem;" onclick="setChartType('line')" id="btnLine">
                            Line
                        </button>
                        <button class="sf-btn sf-btn-neutral" style="padding: 0.25rem 0.5rem;" onclick="setChartType('polarArea')" id="btnPolarArea">
                            Polar
                        </button>
                    </div>
                </div>
                <div class="sf-chart-body">
                    <canvas id="mainChart"></canvas>
                    <div class="sf-loading" id="chartLoading" style="display: none;">
                        <div class="sf-spinner"></div>
                    </div>
                    <div class="sf-no-data" id="chartNoData" style="display: none;">
                        <svg class="sf-no-data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span>No data available for the selected filters</span>
                    </div>
                </div>
            </div>

            <!-- Data table -->
            <div class="sf-table-container">
                <div class="sf-table-header">
                    <span class="sf-table-title">Ticket Details</span>
                    <span style="font-size: 0.8125rem; color: var(--sf-gray-600);">Showing first 100 results</span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="sf-table">
                        <thead>
                            <tr>
                                <th>Case ID</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Category</th>
                                <th>Assigned To</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="7" class="sf-loading">
                                    <div class="sf-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let mainChart = null;
let reportData = null;
let currentChartType = 'pie';
let filterOptions = {};

// Color palette
const colors = [
    '#0176d3', '#1b96ff', '#3ba755', '#fe9339', '#ea001e',
    '#9050e9', '#04844b', '#ff538a', '#00b4d8', '#7c868d'
];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeDateRange();
    loadFilters();
});

// Set initial date range to last 30 days
function initializeDateRange() {
    setDateRange(30);
}

// Set date range based on days
function setDateRange(days) {
    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate() - days);

    document.getElementById('startDate').value = start.toISOString().split('T')[0];
    document.getElementById('endDate').value = end.toISOString().split('T')[0];

    // Update preset buttons
    document.querySelectorAll('.sf-date-preset').forEach(btn => {
        btn.classList.remove('active');
        if (parseInt(btn.dataset.days) === days) {
            btn.classList.add('active');
        }
    });

    applyFilters();
}

// Update preset selection when dates change manually
function updateDatePreset() {
    document.querySelectorAll('.sf-date-preset').forEach(btn => {
        btn.classList.remove('active');
    });
    applyFilters();
}

// Load filter options from API
async function loadFilters() {
    try {
        const response = await fetch('/reports/api/filters');
        const data = await response.json();

        if (data.success) {
            filterOptions = data;
            populateFilter('statusFilter', data.statuses, 'status');
            populateFilter('priorityFilter', data.priorities, 'priority');
            populateFilter('categoryFilter', data.categories, 'category');
            populateFilter('assignedToFilter', data.users, 'assignedTo');
            populateFilter('countryFilter', data.countries, 'country');
        }
    } catch (error) {
        console.error('Error loading filters:', error);
    }
}

// Populate a filter section
function populateFilter(containerId, options, filterType) {
    const container = document.getElementById(containerId);
    const countEl = document.getElementById(filterType + 'Count');

    if (countEl) {
        countEl.textContent = options.length;
    }

    container.innerHTML = options.map(opt => `
        <label class="sf-checkbox-item">
            <input type="checkbox" value="${opt.value}" data-filter="${filterType}" checked>
            <span>${opt.label}</span>
            <span class="count">${opt.count}</span>
        </label>
    `).join('');
}

// Toggle filter section
function toggleFilter(filterName) {
    const content = document.getElementById(filterName + 'Filter');
    content.classList.toggle('collapsed');
}

// Toggle sidebar
function toggleSidebar() {
    const sidebar = document.getElementById('filterSidebar');
    const toggle = document.getElementById('toggleSidebar');
    const icon = document.getElementById('toggleIcon');

    sidebar.classList.toggle('collapsed');
    toggle.classList.toggle('collapsed');

    if (sidebar.classList.contains('collapsed')) {
        icon.innerHTML = '<polyline points="9,18 15,12 9,6"/>';
    } else {
        icon.innerHTML = '<polyline points="15,18 9,12 15,6"/>';
    }
}

// Get selected filter values
function getSelectedFilters() {
    const filters = {
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        groupBy: document.getElementById('groupBy').value,
        statuses: [],
        priorities: [],
        categories: [],
        assignedTo: [],
        countries: []
    };

    document.querySelectorAll('input[data-filter="status"]:checked').forEach(cb => {
        filters.statuses.push(cb.value);
    });
    document.querySelectorAll('input[data-filter="priority"]:checked').forEach(cb => {
        filters.priorities.push(cb.value);
    });
    document.querySelectorAll('input[data-filter="category"]:checked').forEach(cb => {
        filters.categories.push(cb.value);
    });
    document.querySelectorAll('input[data-filter="assignedTo"]:checked').forEach(cb => {
        filters.assignedTo.push(cb.value);
    });
    document.querySelectorAll('input[data-filter="country"]:checked').forEach(cb => {
        filters.countries.push(cb.value);
    });

    return filters;
}

// Apply filters and fetch data
async function applyFilters() {
    const filters = getSelectedFilters();

    // Show loading
    document.getElementById('chartLoading').style.display = 'flex';
    document.getElementById('chartNoData').style.display = 'none';
    if (mainChart) {
        mainChart.destroy();
        mainChart = null;
    }

    try {
        const response = await fetch('/reports/api/case-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            body: JSON.stringify(filters)
        });

        const data = await response.json();
        reportData = data;

        // Update UI
        updateSummaryCards(data.summary);
        updateChart(data.groupedData, filters.groupBy);
        updateTable(data.tableData);

        // Update count text
        document.getElementById('ticketCountText').textContent =
            `Found ${data.total} tickets with your current filters`;

        // Update chart label
        document.getElementById('chartGroupLabel').textContent = filters.groupBy.replace('_', ' ');

    } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('chartLoading').style.display = 'none';
        document.getElementById('chartNoData').style.display = 'flex';
    }
}

// Update summary cards
function updateSummaryCards(summary) {
    document.getElementById('totalTickets').textContent = summary.total.toLocaleString();
    document.getElementById('resolvedTickets').textContent = summary.resolved.toLocaleString();
    document.getElementById('openTickets').textContent = summary.open.toLocaleString();
    document.getElementById('resolutionRate').textContent = summary.resolution_rate + '%';

    // Color the resolution rate
    const rateEl = document.getElementById('resolutionRate');
    rateEl.className = 'sf-summary-value';
    if (summary.resolution_rate >= 80) {
        rateEl.classList.add('green');
    } else if (summary.resolution_rate >= 50) {
        rateEl.classList.add('orange');
    } else {
        rateEl.classList.add('red');
    }
}

// Update chart
function updateChart(groupedData, groupBy) {
    document.getElementById('chartLoading').style.display = 'none';

    const data = groupedData[groupBy] || {};
    const labels = Object.keys(data);
    const values = Object.values(data);

    if (labels.length === 0) {
        document.getElementById('chartNoData').style.display = 'flex';
        return;
    }

    document.getElementById('chartNoData').style.display = 'none';

    const ctx = document.getElementById('mainChart').getContext('2d');

    // Determine chart type for Chart.js (horizontalBar is now 'bar' with indexAxis)
    let chartType = currentChartType;
    if (currentChartType === 'horizontalBar') {
        chartType = 'bar';
    }

    // Configure based on chart type
    const isCircular = ['pie', 'doughnut', 'polarArea'].includes(currentChartType);
    const isHorizontal = currentChartType === 'horizontalBar';

    const chartConfig = {
        type: chartType,
        data: {
            labels: labels,
            datasets: [{
                label: 'Tickets',
                data: values,
                backgroundColor: colors.slice(0, labels.length),
                borderColor: isCircular ? 'white' : colors.slice(0, labels.length),
                borderWidth: isCircular ? 2 : 1,
                tension: 0.3,
                fill: currentChartType === 'line' ? false : undefined
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: isHorizontal ? 'y' : 'x',
            plugins: {
                legend: {
                    display: isCircular,
                    position: 'right'
                }
            },
            scales: isCircular ? {} : {
                x: {
                    beginAtZero: isHorizontal,
                    ticks: {
                        precision: 0
                    }
                },
                y: {
                    beginAtZero: !isHorizontal,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    };

    if (mainChart) {
        mainChart.destroy();
    }
    mainChart = new Chart(ctx, chartConfig);

    // Update all button states
    const chartTypes = ['pie', 'doughnut', 'bar', 'horizontalBar', 'line', 'polarArea'];
    chartTypes.forEach(type => {
        const btn = document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1));
        if (btn) {
            btn.classList.toggle('sf-btn-brand', currentChartType === type);
            btn.classList.toggle('sf-btn-neutral', currentChartType !== type);
        }
    });
}

// Set chart type
function setChartType(type) {
    currentChartType = type;
    if (reportData && reportData.groupedData) {
        updateChart(reportData.groupedData, document.getElementById('groupBy').value);
    }
}

// Update data table
function updateTable(tableData) {
    const tbody = document.getElementById('tableBody');

    if (!tableData || tableData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 2rem; color: var(--sf-gray-600);">
                    No tickets found matching your filters
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = tableData.map(ticket => `
        <tr>
            <td><a href="/tickets/${ticket.case_id}" class="sf-table-link">${ticket.case_id}</a></td>
            <td>${escapeHtml(ticket.subject)}</td>
            <td><span class="sf-badge ${getStatusBadgeClass(ticket.status)}">${ticket.status}</span></td>
            <td><span class="sf-badge ${getPriorityBadgeClass(ticket.priority)}">${ticket.priority}</span></td>
            <td>${escapeHtml(ticket.category)}</td>
            <td>${ticket.assigned_to || '-'}</td>
            <td>${formatDate(ticket.created_at)}</td>
        </tr>
    `).join('');
}

// Get status badge class
function getStatusBadgeClass(status) {
    if (!status) return '';
    const s = status.toLowerCase();
    if (s.includes('new')) return 'sf-badge-new';
    if (s.includes('progress')) return 'sf-badge-progress';
    if (s.includes('resolved') || s.includes('closed')) return 'sf-badge-resolved';
    return '';
}

// Get priority badge class
function getPriorityBadgeClass(priority) {
    if (!priority) return '';
    const p = priority.toLowerCase();
    if (p.includes('high') || p.includes('critical')) return 'sf-badge-high';
    if (p.includes('medium')) return 'sf-badge-medium';
    if (p.includes('low')) return 'sf-badge-low';
    return '';
}

// Format date
function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Reset filters
function resetFilters() {
    // Check all checkboxes
    document.querySelectorAll('.sf-filter-content input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
    });

    // Reset date to last 30 days
    setDateRange(30);

    // Reset group by
    document.getElementById('groupBy').value = 'status';
}

// Save report
function saveReport() {
    const filters = getSelectedFilters();
    localStorage.setItem('savedReport', JSON.stringify(filters));
    alert('Report configuration saved!');
}

// Export report
function exportReport() {
    if (!reportData || !reportData.tableData || reportData.tableData.length === 0) {
        alert('No data to export');
        return;
    }

    // Create CSV
    const headers = ['Case ID', 'Subject', 'Status', 'Priority', 'Category', 'Assigned To', 'Created'];
    const rows = reportData.tableData.map(t => [
        t.case_id,
        `"${(t.subject || '').replace(/"/g, '""')}"`,
        t.status,
        t.priority,
        t.category,
        t.assigned_to || '',
        t.created_at
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');

    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `case_report_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
