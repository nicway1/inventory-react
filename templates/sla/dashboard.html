{% extends "base.html" %}

{% block title %}SLA Dashboard{% endblock %}

{% block content %}
<style>
/* Case Manager Filter Styles */
.filter-card {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.filter-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    align-items: center;
    gap: 6px;
}
.filter-select {
    width: 100%;
    padding: 8px 12px;
    font-size: 0.875rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: white;
    color: #334155;
    cursor: pointer;
    transition: all 0.2s;
}
.filter-select:hover {
    border-color: #94a3b8;
}
.filter-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
.filter-select-problem {
    background: #fef2f2;
    border-color: #fecaca;
}
.filter-select-problem:hover {
    border-color: #f87171;
}
.filter-select-problem:focus {
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

/* Status Filter Buttons */
.filter-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #64748b;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.2s;
}
.filter-btn:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
}
.filter-btn.active {
    background: #1e293b;
    color: white;
    border-color: #1e293b;
}
.filter-btn-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}
.filter-btn-count {
    font-weight: 700;
}

/* Table Improvements */
.case-table {
    width: 100%;
}
.case-table thead {
    background: linear-gradient(to right, #f8fafc, #f1f5f9);
}
.case-table th {
    padding: 12px 16px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-align: left;
    border-bottom: 2px solid #e2e8f0;
}
.case-table td {
    padding: 16px;
    border-bottom: 1px solid #f1f5f9;
}
.case-table tbody tr {
    transition: background 0.15s;
}
.case-table tbody tr:hover {
    background: #f8fafc;
}

/* Ticket ID styling */
.ticket-link {
    font-weight: 600;
    color: #2563eb;
    text-decoration: none;
    transition: color 0.15s;
}
.ticket-link:hover {
    color: #1d4ed8;
    text-decoration: underline;
}

/* Status badges */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 9999px;
}
.status-badge-breached {
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    color: #dc2626;
}
.status-badge-at-risk {
    background: linear-gradient(135deg, #fffbeb, #fef3c7);
    color: #d97706;
}
.status-badge-on-track {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    color: #16a34a;
}
</style>
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold">SLA Dashboard</h1>
            <p class="text-sm text-gray-600 mt-1">
                Monitor SLA compliance across your tickets
                {% if not user.is_super_admin and not user.is_developer %}
                <span class="text-xs text-gray-400">(Filtered by your queue access)</span>
                {% endif %}
            </p>
        </div>
        <div class="flex gap-3 items-center">
            {% if user.is_super_admin or user.is_developer %}
            <button onclick="showRefreshTrackingModal()" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-emerald-600 hover:bg-emerald-700">
                <i class="fas fa-sync-alt mr-2"></i>
                Refresh Tracking
            </button>
            <a href="{{ url_for('tickets.tracking_refresh_history') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-history mr-2"></i>
                History
            </a>
            {% endif %}
            <a href="{{ url_for('sla.manage_sla') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-cog mr-2"></i>
                Settings
            </a>
            <a href="{{ url_for('dashboard.index') }}" class="text-gray-600 hover:text-gray-800">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-check-circle text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">On Track</p>
                    <p class="text-2xl font-bold text-green-600">{{ on_track }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">At Risk</p>
                    <p class="text-2xl font-bold text-yellow-600">{{ at_risk }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-red-100 text-red-600">
                    <i class="fas fa-times-circle text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Breached</p>
                    <p class="text-2xl font-bold text-red-600">{{ breached }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-clock text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Total w/ SLA</p>
                    <p class="text-2xl font-bold text-blue-600">{{ total_with_sla }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full {% if compliance_rate >= 80 %}bg-green-100 text-green-600{% elif compliance_rate >= 60 %}bg-yellow-100 text-yellow-600{% else %}bg-red-100 text-red-600{% endif %}">
                    <i class="fas fa-percentage text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Compliance</p>
                    <p class="text-2xl font-bold {% if compliance_rate >= 80 %}text-green-600{% elif compliance_rate >= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">{{ compliance_rate }}%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Status Distribution Chart -->
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-4">SLA Status Distribution</h3>
            <div class="relative" style="height: 200px;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <!-- Queue Breakdown Chart -->
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-4">By Queue</h3>
            <div class="relative" style="height: 200px;">
                <canvas id="queueChart"></canvas>
            </div>
        </div>

        <!-- Category Breakdown Chart -->
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-4">By Category</h3>
            <div class="relative" style="height: 200px;">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- User Breakdown Chart -->
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-4">By User (Top 10)</h3>
            <div class="relative" style="height: 200px;">
                <canvas id="userChart"></canvas>
            </div>
        </div>
    </div>

    <!-- User Gallery -->
    {% if user_stats %}
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">
                <i class="fas fa-users mr-2"></i>
                Users Overview ({{ user_stats|length }})
            </h3>
            <button onclick="clearUserSelection()" id="clearUserBtn" class="text-sm text-gray-500 hover:text-gray-700 px-2 hidden">
                <i class="fas fa-times"></i> Clear Selection
            </button>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-3">
                {% for u in user_stats %}
                <div class="user-card cursor-pointer border rounded-lg p-3 hover:shadow-md transition-shadow {% if u.breached > 0 %}border-red-200 bg-red-50{% elif u.at_risk > 0 %}border-yellow-200 bg-yellow-50{% else %}border-green-200 bg-green-50{% endif %}"
                     data-user-id="{{ u.id }}"
                     onclick="selectUser('{{ u.id }}', '{{ u.name|e }}')">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold {% if u.breached > 0 %}bg-red-500{% elif u.at_risk > 0 %}bg-yellow-500{% else %}bg-green-500{% endif %}">
                            {{ u.name[0]|upper }}
                        </div>
                        <div class="ml-2 flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-900 truncate" title="{{ u.name }}">{{ u.name }}</div>
                            <div class="text-xs text-gray-500">{{ u.total }} ticket{% if u.total != 1 %}s{% endif %}</div>
                        </div>
                    </div>
                    <div class="flex gap-1 text-xs">
                        {% if u.breached > 0 %}
                        <span class="px-1.5 py-0.5 rounded bg-red-100 text-red-700">{{ u.breached }} breached</span>
                        {% endif %}
                        {% if u.at_risk > 0 %}
                        <span class="px-1.5 py-0.5 rounded bg-yellow-100 text-yellow-700">{{ u.at_risk }} at risk</span>
                        {% endif %}
                        {% if u.on_track > 0 and u.breached == 0 and u.at_risk == 0 %}
                        <span class="px-1.5 py-0.5 rounded bg-green-100 text-green-700">{{ u.on_track }} on track</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Likely to Breach Section -->
    {% if likely_to_breach %}
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-4 border-b border-gray-200 bg-orange-50">
            <h3 class="text-lg font-semibold text-orange-800">
                <i class="fas fa-fire-alt mr-2"></i>
                Likely to Breach Soon ({{ likely_to_breach|length }} tickets within 24 hours)
            </h3>
            <p class="text-sm text-orange-600 mt-1">These tickets need immediate attention to avoid SLA breach</p>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-orange-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticket</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Queue</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Case Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requester</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time Remaining</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in likely_to_breach %}
                    <tr class="hover:bg-orange-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <a href="{{ url_for('tickets.view_ticket', ticket_id=item.ticket.id) }}" class="text-blue-600 hover:text-blue-800 font-medium">
                                {{ item.ticket.display_id if item.ticket.display_id else '#' ~ item.ticket.id }}
                            </a>
                            <div class="text-xs text-gray-500">{{ item.ticket.subject[:40] }}{% if item.ticket.subject|length > 40 %}...{% endif %}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ item.ticket.queue.name if item.ticket.queue else 'No Queue' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ item.ticket.category.value if item.ticket.category else 'No Category' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% set status_colors = {
                                'NEW': 'bg-blue-100 text-blue-800',
                                'OPEN': 'bg-blue-100 text-blue-800',
                                'IN_PROGRESS': 'bg-indigo-100 text-indigo-800',
                                'PENDING': 'bg-yellow-100 text-yellow-800',
                                'WAITING_FOR_CUSTOMER': 'bg-orange-100 text-orange-800',
                                'ON_HOLD': 'bg-gray-100 text-gray-800',
                                'ESCALATED': 'bg-red-100 text-red-800'
                            } %}
                            {% set status_name = item.ticket.status.name if item.ticket.status else 'Unknown' %}
                            {% set status_color = status_colors.get(status_name, 'bg-gray-100 text-gray-800') %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium {{ status_color }}">
                                {{ item.ticket.status.value if item.ticket.status else 'Unknown' }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ item.ticket.requester.username if item.ticket.requester else 'Unknown' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 animate-pulse">
                                <i class="fas fa-clock mr-1"></i>
                                {% if item.sla.hours_remaining <= 0 %}
                                    Less than 1 hour!
                                {% elif item.sla.hours_remaining == 1 %}
                                    1 hour left
                                {% else %}
                                    {{ item.sla.hours_remaining }} hours left
                                {% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ item.sla.due_date.strftime('%Y-%m-%d %H:%M') if item.sla.due_date else '-' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Case Manager Section -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- Header with Search -->
        <div class="bg-gradient-to-r from-slate-800 to-slate-700 px-6 py-4">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-briefcase"></i>
                        Case Manager
                    </h3>
                    <p class="text-slate-300 text-sm mt-1">Manage and track all tickets</p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Search Box -->
                    <div class="relative">
                        <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="Search tickets..."
                               class="w-64 pl-10 pr-4 py-2 rounded-lg border-0 bg-slate-600 text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-400 focus:bg-slate-500 transition-all">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    </div>
                    <!-- Reset Button -->
                    <button onclick="resetFilters()" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-all flex items-center gap-2">
                        <i class="fas fa-redo-alt"></i>
                        Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter Panel -->
        <div class="bg-slate-50 border-b border-slate-200 px-6 py-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                <!-- User Filter -->
                <div class="filter-card">
                    <label class="filter-label"><i class="fas fa-user"></i> User</label>
                    <select id="userFilter" onchange="applyFilters()" class="filter-select">
                        <option value="all">All Users</option>
                        {% for u in user_stats %}
                        <option value="{{ u.id }}">{{ u.name }} ({{ u.total }})</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Queue Filter -->
                <div class="filter-card">
                    <label class="filter-label"><i class="fas fa-layer-group"></i> Queue</label>
                    <select id="queueFilter" onchange="applyFilters()" class="filter-select">
                        <option value="all">All Queues</option>
                        {% for queue_name in queue_stats.keys() %}
                        <option value="{{ queue_name }}">{{ queue_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Category Filter -->
                <div class="filter-card">
                    <label class="filter-label"><i class="fas fa-tag"></i> Category</label>
                    <select id="categoryFilter" onchange="applyFilters()" class="filter-select">
                        <option value="all">All Categories</option>
                        {% for cat_name in category_stats.keys() %}
                        <option value="{{ cat_name }}">{{ cat_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Carrier Filter -->
                <div class="filter-card">
                    <label class="filter-label"><i class="fas fa-truck"></i> Carrier</label>
                    <select id="carrierFilter" onchange="applyFilters()" class="filter-select">
                        <option value="all">All Carriers</option>
                        <option value="singpost">SingPost</option>
                        <option value="dhl">DHL</option>
                        <option value="fedex">FedEx</option>
                        <option value="ups">UPS</option>
                        <option value="bluedart">BlueDart</option>
                        <option value="dtdc">DTDC</option>
                        <option value="other">Other</option>
                        <option value="none">No Carrier</option>
                    </select>
                </div>
                <!-- Tracking Status Filter -->
                <div class="filter-card">
                    <label class="filter-label"><i class="fas fa-shipping-fast"></i> Tracking</label>
                    <select id="trackingStatusFilter" onchange="applyFilters()" class="filter-select">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in_transit">In Transit</option>
                        <option value="out_for_delivery">Out for Delivery</option>
                        <option value="delivered">Delivered</option>
                        <option value="no_tracking">No Tracking #</option>
                    </select>
                </div>
                <!-- Problem Filter -->
                <div class="filter-card">
                    <label class="filter-label text-red-600"><i class="fas fa-exclamation-triangle"></i> Problems</label>
                    <select id="problemFilter" onchange="applyFilters()" class="filter-select filter-select-problem">
                        <option value="all">No Filter</option>
                        <option value="delivered_not_closed">Delivered but Open</option>
                        <option value="no_tracking">Missing Tracking #</option>
                        <option value="stale">Stale (7+ days)</option>
                        <option value="open_30_days">Open 30+ Days</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Status Tabs -->
        <div class="px-6 py-3 bg-white border-b border-slate-200 flex items-center justify-between">
            <div class="flex gap-2">
                <button onclick="filterByStatus('all')" class="filter-btn active" data-status="all">
                    <span class="filter-btn-dot bg-slate-400"></span>
                    All <span class="filter-btn-count" id="count-all">{{ ticket_sla_data|length }}</span>
                </button>
                <button onclick="filterByStatus('breached')" class="filter-btn" data-status="breached">
                    <span class="filter-btn-dot bg-red-500"></span>
                    Breached <span class="filter-btn-count text-red-600" id="count-breached">{{ breached }}</span>
                </button>
                <button onclick="filterByStatus('at_risk')" class="filter-btn" data-status="at_risk">
                    <span class="filter-btn-dot bg-yellow-500"></span>
                    At Risk <span class="filter-btn-count text-yellow-600" id="count-at_risk">{{ at_risk }}</span>
                </button>
                <button onclick="filterByStatus('on_track')" class="filter-btn" data-status="on_track">
                    <span class="filter-btn-dot bg-green-500"></span>
                    On Track <span class="filter-btn-count text-green-600" id="count-on_track">{{ on_track }}</span>
                </button>
            </div>
            <div class="flex items-center gap-3">
                <span id="problemCount" class="text-sm font-medium px-3 py-1 rounded-full bg-red-100 text-red-700 hidden">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    <span id="problemCountText">0 issues</span>
                </span>
                <span class="text-sm text-slate-500" id="visibleCount"></span>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticket</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Queue</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Case Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requester</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SLA Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in ticket_sla_data %}
                    <tr class="ticket-row hover:bg-gray-50" data-sla-status="{{ item.sla.status }}" data-queue="{{ item.ticket.queue.name if item.ticket.queue else 'No Queue' }}" data-category="{{ item.ticket.category.value if item.ticket.category else 'No Category' }}" data-user-id="{{ item.ticket.requester_id or '' }}" data-carrier="{{ (item.ticket.shipping_carrier or '')|lower }}" data-tracking="{{ item.ticket.shipping_tracking or '' }}" data-tracking-status="{{ (item.ticket.shipping_status or '')|lower }}" data-created="{{ item.ticket.created_at.isoformat() if item.ticket.created_at else '' }}" data-updated="{{ item.ticket.updated_at.isoformat() if item.ticket.updated_at else item.ticket.created_at.isoformat() if item.ticket.created_at else '' }}" data-ticket-status="{{ item.ticket.status.name if item.ticket.status else '' }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <a href="{{ url_for('tickets.view_ticket', ticket_id=item.ticket.id) }}" class="text-blue-600 hover:text-blue-800 font-medium">
                                {{ item.ticket.display_id if item.ticket.display_id else '#' ~ item.ticket.id }}
                            </a>
                            <div class="text-xs text-gray-500">{{ item.ticket.subject[:40] }}{% if item.ticket.subject|length > 40 %}...{% endif %}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ item.ticket.queue.name if item.ticket.queue else 'No Queue' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ item.ticket.category.value if item.ticket.category else 'No Category' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% set status_colors = {
                                'NEW': 'bg-blue-100 text-blue-800',
                                'OPEN': 'bg-blue-100 text-blue-800',
                                'IN_PROGRESS': 'bg-indigo-100 text-indigo-800',
                                'PENDING': 'bg-yellow-100 text-yellow-800',
                                'WAITING_FOR_CUSTOMER': 'bg-orange-100 text-orange-800',
                                'ON_HOLD': 'bg-gray-100 text-gray-800',
                                'ESCALATED': 'bg-red-100 text-red-800'
                            } %}
                            {% set status_name = item.ticket.status.name if item.ticket.status else 'Unknown' %}
                            {% set status_color = status_colors.get(status_name, 'bg-gray-100 text-gray-800') %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium {{ status_color }}">
                                {{ item.ticket.status.value if item.ticket.status else 'Unknown' }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ item.ticket.requester.username if item.ticket.requester else 'Unknown' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ item.ticket.created_at.strftime('%Y-%m-%d %H:%M') if item.ticket.created_at else '-' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ item.sla.due_date.strftime('%Y-%m-%d %H:%M') if item.sla.due_date else '-' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if item.sla.status == 'breached' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                <i class="fas fa-times-circle mr-1"></i>
                                {{ item.sla.days_remaining|abs }} day{% if item.sla.days_remaining|abs != 1 %}s{% endif %} overdue
                            </span>
                            {% elif item.sla.status == 'at_risk' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                {% if item.sla.hours_remaining <= 24 %}
                                    {{ item.sla.hours_remaining }}h left
                                {% else %}
                                    {{ item.sla.days_remaining }} day{% if item.sla.days_remaining != 1 %}s{% endif %} left
                                {% endif %}
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-check-circle mr-1"></i>
                                {{ item.sla.days_remaining }} day{% if item.sla.days_remaining != 1 %}s{% endif %} left
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl text-gray-400 mb-2"></i>
                            <p>No tickets with SLA configured</p>
                            <p class="text-sm mt-2">Configure SLA rules in <a href="{{ url_for('sla.manage_sla') }}" class="text-blue-600 hover:underline">Settings</a></p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart data from server
const chartData = {{ chart_data | tojson | safe }};

// Status Distribution Donut Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: chartData.status.labels,
        datasets: [{
            data: chartData.status.data,
            backgroundColor: chartData.status.colors,
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    usePointStyle: true
                }
            }
        },
        cutout: '60%'
    }
});

// Queue Breakdown Stacked Bar Chart
const queueCtx = document.getElementById('queueChart').getContext('2d');
new Chart(queueCtx, {
    type: 'bar',
    data: {
        labels: chartData.queues.labels,
        datasets: [
            {
                label: 'On Track',
                data: chartData.queues.on_track,
                backgroundColor: '#10B981'
            },
            {
                label: 'At Risk',
                data: chartData.queues.at_risk,
                backgroundColor: '#F59E0B'
            },
            {
                label: 'Breached',
                data: chartData.queues.breached,
                backgroundColor: '#EF4444'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                stacked: true,
                ticks: {
                    maxRotation: 45,
                    minRotation: 45
                }
            },
            y: {
                stacked: true,
                beginAtZero: true
            }
        }
    }
});

// Category Breakdown Stacked Bar Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'bar',
    data: {
        labels: chartData.categories.labels,
        datasets: [
            {
                label: 'On Track',
                data: chartData.categories.on_track,
                backgroundColor: '#10B981'
            },
            {
                label: 'At Risk',
                data: chartData.categories.at_risk,
                backgroundColor: '#F59E0B'
            },
            {
                label: 'Breached',
                data: chartData.categories.breached,
                backgroundColor: '#EF4444'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                stacked: true,
                ticks: {
                    maxRotation: 45,
                    minRotation: 45
                }
            },
            y: {
                stacked: true,
                beginAtZero: true
            }
        }
    }
});

// User Breakdown Stacked Bar Chart
const userCtx = document.getElementById('userChart').getContext('2d');
new Chart(userCtx, {
    type: 'bar',
    data: {
        labels: chartData.users.labels,
        datasets: [
            {
                label: 'On Track',
                data: chartData.users.on_track,
                backgroundColor: '#10B981'
            },
            {
                label: 'At Risk',
                data: chartData.users.at_risk,
                backgroundColor: '#F59E0B'
            },
            {
                label: 'Breached',
                data: chartData.users.breached,
                backgroundColor: '#EF4444'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',  // Horizontal bars for better user name visibility
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                stacked: true,
                beginAtZero: true
            },
            y: {
                stacked: true
            }
        }
    }
});

// Current filter state
let currentStatusFilter = 'all';

// Apply all filters (user, queue, category, carrier, tracking, problem, status, search)
function applyFilters() {
    const userFilter = document.getElementById('userFilter').value;
    const queueFilter = document.getElementById('queueFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const carrierFilter = document.getElementById('carrierFilter').value;
    const trackingStatusFilter = document.getElementById('trackingStatusFilter').value;
    const problemFilter = document.getElementById('problemFilter').value;
    const searchInput = document.getElementById('searchInput');
    const searchText = searchInput ? searchInput.value.toLowerCase().trim() : '';

    let counts = { all: 0, breached: 0, at_risk: 0, on_track: 0 };
    let problemCount = 0;
    let visibleCount = 0;

    document.querySelectorAll('.ticket-row').forEach(row => {
        const matchUser = userFilter === 'all' || row.dataset.userId === userFilter;
        const matchQueue = queueFilter === 'all' || row.dataset.queue === queueFilter;
        const matchCategory = categoryFilter === 'all' || row.dataset.category === categoryFilter;
        const matchStatus = currentStatusFilter === 'all' || row.dataset.slaStatus === currentStatusFilter;

        // Search filter
        let matchSearch = true;
        if (searchText) {
            const ticketId = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
            const subject = row.querySelector('td:first-child .text-xs')?.textContent.toLowerCase() || '';
            const requester = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
            matchSearch = ticketId.includes(searchText) || subject.includes(searchText) || requester.includes(searchText);
        }

        // Carrier filter
        const carrier = row.dataset.carrier || '';
        let matchCarrier = true;
        if (carrierFilter !== 'all') {
            if (carrierFilter === 'none') {
                matchCarrier = !carrier || carrier === '';
            } else if (carrierFilter === 'other') {
                matchCarrier = carrier && !['singpost', 'dhl', 'fedex', 'ups', 'bluedart', 'dtdc'].includes(carrier);
            } else {
                matchCarrier = carrier === carrierFilter;
            }
        }

        // Tracking status filter
        const tracking = row.dataset.tracking || '';
        const trackingStatus = row.dataset.trackingStatus || '';
        let matchTrackingStatus = true;
        if (trackingStatusFilter !== 'all') {
            if (trackingStatusFilter === 'no_tracking') {
                matchTrackingStatus = !tracking || tracking.trim() === '';
            } else if (trackingStatusFilter === 'in_transit') {
                matchTrackingStatus = trackingStatus.includes('transit') || trackingStatus.includes('shipped');
            } else if (trackingStatusFilter === 'out_for_delivery') {
                matchTrackingStatus = trackingStatus.includes('out for delivery');
            } else if (trackingStatusFilter === 'delivered') {
                matchTrackingStatus = trackingStatus.includes('delivered') || trackingStatus.includes('received');
            } else if (trackingStatusFilter === 'pending') {
                matchTrackingStatus = trackingStatus === 'pending' || trackingStatus === '';
            }
        }

        // Problem filter
        let matchProblem = true;
        if (problemFilter !== 'all') {
            const ticketStatus = row.dataset.ticketStatus || '';
            const isResolved = ticketStatus === 'RESOLVED' || ticketStatus === 'RESOLVED_DELIVERED';
            const isDelivered = trackingStatus.includes('delivered') || trackingStatus.includes('received');
            const hasTracking = tracking && tracking.trim() !== '';

            const updatedAt = row.dataset.updated || row.dataset.created;
            const createdAt = row.dataset.created;
            const now = new Date();
            const daysSinceUpdate = updatedAt ? Math.floor((now - new Date(updatedAt)) / (1000 * 60 * 60 * 24)) : 999;
            const daysSinceCreated = createdAt ? Math.floor((now - new Date(createdAt)) / (1000 * 60 * 60 * 24)) : 0;

            if (problemFilter === 'delivered_not_closed') {
                matchProblem = isDelivered && !isResolved;
            } else if (problemFilter === 'no_tracking') {
                matchProblem = !hasTracking && !isResolved;
            } else if (problemFilter === 'stale') {
                matchProblem = daysSinceUpdate >= 7 && !isResolved && !isDelivered;
            } else if (problemFilter === 'open_30_days') {
                matchProblem = daysSinceCreated >= 30 && !isResolved;
            }
        }

        // Count tickets matching base filters (regardless of status filter)
        if (matchUser && matchQueue && matchCategory && matchCarrier && matchTrackingStatus && matchProblem && matchSearch) {
            counts.all++;
            counts[row.dataset.slaStatus]++;
            if (problemFilter !== 'all') problemCount++;
        }

        // Show/hide based on all filters
        if (matchUser && matchQueue && matchCategory && matchCarrier && matchTrackingStatus && matchProblem && matchStatus && matchSearch) {
            row.classList.remove('hidden');
            visibleCount++;
        } else {
            row.classList.add('hidden');
        }
    });

    // Update visible count
    const visibleCountEl = document.getElementById('visibleCount');
    if (visibleCountEl) {
        visibleCountEl.textContent = `Showing ${visibleCount} tickets`;
    }

    // Update counts in buttons
    document.getElementById('count-all').textContent = counts.all;
    document.getElementById('count-breached').textContent = counts.breached;
    document.getElementById('count-at_risk').textContent = counts.at_risk;
    document.getElementById('count-on_track').textContent = counts.on_track;

    // Update problem count badge
    const problemCountEl = document.getElementById('problemCount');
    if (problemFilter !== 'all' && problemCount > 0) {
        problemCountEl.textContent = problemCount + ' issue' + (problemCount !== 1 ? 's' : '');
        problemCountEl.classList.remove('hidden');
    } else {
        problemCountEl.classList.add('hidden');
    }
}

// Filter by status (and apply other filters)
function filterByStatus(status) {
    currentStatusFilter = status;

    // Update button styles
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.status === status) {
            btn.classList.add('active');
        }
    });

    applyFilters();
}

// Reset all filters
function resetFilters() {
    document.getElementById('userFilter').value = 'all';
    document.getElementById('queueFilter').value = 'all';
    document.getElementById('categoryFilter').value = 'all';
    document.getElementById('carrierFilter').value = 'all';
    document.getElementById('trackingStatusFilter').value = 'all';
    document.getElementById('problemFilter').value = 'all';
    const searchInput = document.getElementById('searchInput');
    if (searchInput) searchInput.value = '';
    currentStatusFilter = 'all';

    // Reset button styles
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.status === 'all') {
            btn.classList.add('active');
        }
    });

    // Hide problem count badge
    document.getElementById('problemCount').classList.add('hidden');

    // Clear user card selection
    clearUserCardSelection();

    applyFilters();
}

// Select a user from the gallery
function selectUser(userId, userName) {
    // Update dropdown
    document.getElementById('userFilter').value = userId;

    // Update card styling
    document.querySelectorAll('.user-card').forEach(card => {
        card.classList.remove('ring-2', 'ring-blue-500', 'shadow-lg');
        if (card.dataset.userId === userId) {
            card.classList.add('ring-2', 'ring-blue-500', 'shadow-lg');
        }
    });

    // Show clear button
    document.getElementById('clearUserBtn').classList.remove('hidden');

    // Apply filters
    applyFilters();

    // Scroll to table
    document.querySelector('.ticket-row')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Clear user selection from gallery
function clearUserSelection() {
    document.getElementById('userFilter').value = 'all';
    clearUserCardSelection();
    applyFilters();
}

// Helper to clear user card styling
function clearUserCardSelection() {
    document.querySelectorAll('.user-card').forEach(card => {
        card.classList.remove('ring-2', 'ring-blue-500', 'shadow-lg');
    });
    document.getElementById('clearUserBtn')?.classList.add('hidden');
}

// Sync user dropdown with gallery cards
document.getElementById('userFilter').addEventListener('change', function() {
    const userId = this.value;
    if (userId === 'all') {
        clearUserCardSelection();
    } else {
        document.querySelectorAll('.user-card').forEach(card => {
            card.classList.remove('ring-2', 'ring-blue-500', 'shadow-lg');
            if (card.dataset.userId === userId) {
                card.classList.add('ring-2', 'ring-blue-500', 'shadow-lg');
            }
        });
        document.getElementById('clearUserBtn').classList.remove('hidden');
    }
});

// ============= Refresh Tracking Modal Functions =============
function updateTicketCount() {
    const carrier = document.getElementById('refreshCarrierFilter')?.value || 'all';
    const category = document.getElementById('refreshCategoryFilter')?.value || 'all';

    document.getElementById('ticketsToRefreshCount').textContent = '...';

    fetch(`/tickets/admin/refresh-tracking-status?carrier=${carrier}&category=${category}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('ticketsToRefreshCount').textContent = data.tickets_with_tracking;
            }
        })
        .catch(err => {
            document.getElementById('ticketsToRefreshCount').textContent = '?';
        });
}

function showRefreshTrackingModal() {
    document.getElementById('refreshTrackingModal').classList.remove('hidden');
    document.getElementById('trackingInitialState').classList.remove('hidden');
    document.getElementById('trackingProgressState').classList.add('hidden');
    document.getElementById('trackingCompleteState').classList.add('hidden');
    document.getElementById('trackingCancelBtn').classList.remove('hidden');
    document.getElementById('trackingStartBtn').classList.remove('hidden');
    document.getElementById('trackingCloseBtn').classList.add('hidden');

    // Reset filters to 'all'
    const carrierFilter = document.getElementById('refreshCarrierFilter');
    const categoryFilter = document.getElementById('refreshCategoryFilter');
    if (carrierFilter) carrierFilter.value = 'all';
    if (categoryFilter) categoryFilter.value = 'all';

    // Add event listeners for filter changes (only once)
    if (!window.trackingFiltersInitialized) {
        if (carrierFilter) carrierFilter.addEventListener('change', updateTicketCount);
        if (categoryFilter) categoryFilter.addEventListener('change', updateTicketCount);
        window.trackingFiltersInitialized = true;
    }

    // Fetch initial count
    updateTicketCount();
}

function hideRefreshTrackingModal() {
    document.getElementById('refreshTrackingModal').classList.add('hidden');
}

function startRefreshTracking() {
    document.getElementById('trackingInitialState').classList.add('hidden');
    document.getElementById('trackingProgressState').classList.remove('hidden');
    document.getElementById('trackingCancelBtn').classList.add('hidden');
    document.getElementById('trackingStartBtn').classList.add('hidden');

    const progressBar = document.getElementById('trackingProgressBar');
    const statusText = document.getElementById('trackingStatusText');

    // Animated progress
    let progress = 5;
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 2;
            progressBar.style.width = Math.min(progress, 90) + '%';
        }
        const dots = '.'.repeat((Math.floor(Date.now() / 500) % 3) + 1);
        statusText.textContent = 'Processing' + dots + ' (this may take a few minutes)';
    }, 800);

    window.trackingProgressInterval = progressInterval;

    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    // Get filter values
    const carrierFilter = document.getElementById('refreshCarrierFilter')?.value || 'all';
    const categoryFilter = document.getElementById('refreshCategoryFilter')?.value || 'all';

    // Use AbortController with 15 minute timeout for bulk operations
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15 * 60 * 1000); // 15 minutes

    fetch('/tickets/admin/refresh-all-tracking', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken || '',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            carrier: carrierFilter,
            category: categoryFilter
        }),
        signal: controller.signal
    })
    .then(r => {
        clearTimeout(timeoutId);
        return r.json();
    })
    .then(data => {
        clearInterval(window.trackingProgressInterval);
        progressBar.style.width = '100%';

        if (data.success) {
            const summary = data.summary;
            window.trackingReportLogId = data.log_id;

            setTimeout(() => {
                document.getElementById('trackingProgressState').classList.add('hidden');
                document.getElementById('trackingCompleteState').classList.remove('hidden');
                document.getElementById('trackingCloseBtn').classList.remove('hidden');

                document.getElementById('finalUpdatedCount').textContent = summary.tickets_updated;
                document.getElementById('finalAutoClosedCount').textContent = summary.tickets_auto_closed;
                document.getElementById('finalFailedCount').textContent = summary.tickets_failed;
                document.getElementById('trackingCompleteSummary').textContent =
                    `Processed ${summary.total_tickets} tickets, updated ${summary.total_packages_updated} packages.`;

                if (data.log_id) {
                    document.getElementById('viewReportBtn').onclick = function() {
                        window.open('/tickets/admin/tracking-refresh-report/' + data.log_id, '_blank');
                    };
                }
            }, 500);
        } else {
            statusText.textContent = 'Error: ' + data.error;
            statusText.classList.add('text-red-600');
            document.getElementById('trackingCloseBtn').classList.remove('hidden');
        }
    })
    .catch(err => {
        clearInterval(window.trackingProgressInterval);
        clearTimeout(timeoutId);
        if (err.name === 'AbortError') {
            statusText.textContent = 'Request timed out. Check the History page for partial results.';
        } else {
            statusText.textContent = 'Network error: ' + err.message;
        }
        statusText.classList.add('text-red-600');
        document.getElementById('trackingCloseBtn').classList.remove('hidden');
    });
}
</script>

<!-- Refresh Tracking Modal -->
{% if user.is_super_admin or user.is_developer %}
<div id="refreshTrackingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold flex items-center">
                <i class="fas fa-sync-alt text-emerald-600 mr-2"></i>
                Refresh All Tracking
            </h3>
            <button onclick="hideRefreshTrackingModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <div class="p-6">
            <!-- Initial State -->
            <div id="trackingInitialState">
                <p class="text-gray-600 mb-4">
                    Refresh tracking information for open tickets. Tickets showing "Delivered" will be auto-closed.
                </p>

                <!-- Filters -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-truck mr-1"></i> Carrier
                        </label>
                        <select id="refreshCarrierFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="all">All Carriers</option>
                            <option value="singpost">SingPost</option>
                            <option value="dhl">DHL</option>
                            <option value="ups">UPS</option>
                            <option value="fedex">FedEx</option>
                            <option value="hfd">HFD</option>
                            <option value="bluedart">BlueDart</option>
                            <option value="dtdc">DTDC</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-folder mr-1"></i> Category
                        </label>
                        <select id="refreshCategoryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="all">All Categories</option>
                            <option value="ASSET_CHECKOUT_CLAW">Asset Checkout (claw)</option>
                            <option value="ASSET_RETURN_CLAW">Asset Return (claw)</option>
                            <option value="ASSET_EXCHANGE">Asset Exchange</option>
                            <option value="ASSET_REPAIR">Asset Repair</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-gray-900" id="ticketsToRefreshCount">-</div>
                        <div class="text-sm text-gray-500">Tickets to Refresh</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-2xl text-emerald-600"><i class="fas fa-check-circle"></i></div>
                        <div class="text-sm text-gray-500">Auto-close Delivered</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-2xl text-amber-500"><i class="fas fa-clock"></i></div>
                        <div class="text-sm text-gray-500">May Take Time</div>
                    </div>
                </div>
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-amber-800 text-sm">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Note:</strong> Only SingPost tracking is refreshed in bulk. Other carriers show as "failed".
                </div>
            </div>

            <!-- Progress State -->
            <div id="trackingProgressState" class="hidden">
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600" id="ticketsUpdatedCount">0</div>
                        <div class="text-sm text-gray-500">Updated</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-emerald-600" id="ticketsAutoClosedCount">0</div>
                        <div class="text-sm text-gray-500">Auto-Closed</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-red-600" id="ticketsFailedCount">0</div>
                        <div class="text-sm text-gray-500">Failed</div>
                    </div>
                </div>
                <div class="bg-gray-200 rounded-full h-2 mb-3">
                    <div id="trackingProgressBar" class="bg-emerald-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <p id="trackingStatusText" class="text-center text-gray-600 text-sm">Processing...</p>
            </div>

            <!-- Complete State -->
            <div id="trackingCompleteState" class="hidden">
                <div class="text-center mb-4">
                    <div class="text-5xl text-emerald-600 mb-2"><i class="fas fa-check-circle"></i></div>
                    <h4 class="text-lg font-semibold">Tracking Refresh Complete!</h4>
                    <p id="trackingCompleteSummary" class="text-gray-600 text-sm"></p>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600" id="finalUpdatedCount">0</div>
                        <div class="text-sm text-gray-500">Updated</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-emerald-600" id="finalAutoClosedCount">0</div>
                        <div class="text-sm text-gray-500">Auto-Closed</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-red-600" id="finalFailedCount">0</div>
                        <div class="text-sm text-gray-500">Failed</div>
                    </div>
                </div>
                <button id="viewReportBtn" class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 mb-2">
                    <i class="fas fa-external-link-alt mr-2"></i>View Full Report
                </button>
            </div>
        </div>
        <div class="p-4 border-t border-gray-200 flex justify-end gap-3">
            <button id="trackingCancelBtn" onclick="hideRefreshTrackingModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                Cancel
            </button>
            <button id="trackingStartBtn" onclick="startRefreshTracking()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                <i class="fas fa-play mr-2"></i>Start Refresh
            </button>
            <button id="trackingCloseBtn" onclick="hideRefreshTrackingModal(); location.reload();" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                <i class="fas fa-check mr-2"></i>Done
            </button>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
