{% extends "base.html" %}

{% block title %}Device Specs - Inventory{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                <i class="fas fa-laptop-medical text-cyan-500"></i>
                MacBook Specs Collector
            </h2>
            <p class="text-gray-500 dark:text-gray-400 mt-1">Collect device specifications remotely from MacBooks</p>
        </div>
        <a href="{{ url_for('dashboard.index') }}" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-700 dark:text-gray-300">
            <i class="fas fa-arrow-left mr-1"></i> Back to Dashboard
        </a>
    </div>

    <!-- Stats Row -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700 text-center">
            <div class="text-3xl font-bold text-cyan-500">{{ specs|length }}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Total Submissions</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700 text-center">
            <div class="text-3xl font-bold text-yellow-500">{{ unprocessed_count }}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Pending Review</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700 text-center">
            <div class="text-3xl font-bold text-green-500">{{ specs|length - unprocessed_count }}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Processed</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700 text-center">
            <div class="text-3xl font-bold text-purple-500">
                {% if specs %}{{ specs[0].submitted_at|localtime('%H:%M') if specs[0].submitted_at else '--' }}{% else %}--{% endif %}
            </div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Last Submission</div>
        </div>
    </div>

    <!-- Command Box -->
    <div class="bg-gray-900 rounded-xl p-4 mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
        <div>
            <div class="text-gray-400 text-sm mb-1">Run this command on any MacBook (works in Recovery Mode too):</div>
            <code id="curlCommand" class="text-green-400 font-mono text-sm md:text-base">curl -sL https://inventory.truelog.com.sg/specs | bash</code>
        </div>
        <button onclick="copyCommand()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition flex items-center gap-2">
            <i class="fas fa-copy"></i> Copy
        </button>
    </div>

    <!-- Specs Grid -->
    {% if specs %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for spec in specs %}
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 {% if spec.processed %}border-l-green-500{% else %}border-l-yellow-500{% endif %} border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-lg transition">
            <!-- Card Header -->
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 flex justify-between items-center border-b border-gray-200 dark:border-gray-600">
                <div>
                    <div class="font-bold text-gray-800 dark:text-white">{{ spec.serial_number or 'Unknown Serial' }}</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">{{ get_mac_model_name(spec.model_id) if spec.model_id else (spec.model_name or 'Unknown Model') }}</div>
                </div>
                <span class="px-3 py-1 rounded-full text-xs font-semibold {% if spec.processed %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200{% else %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200{% endif %}">
                    {% if spec.processed %}
                    <i class="fas fa-check mr-1"></i>Done
                    {% else %}
                    <i class="fas fa-clock mr-1"></i>New
                    {% endif %}
                </span>
            </div>

            <!-- Card Body -->
            <div class="p-4 space-y-2">
                <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                    <span class="text-gray-500 dark:text-gray-400 text-sm"><i class="fas fa-microchip mr-2 w-4"></i>CPU</span>
                    <span class="text-gray-800 dark:text-white text-sm font-medium text-right max-w-[60%]">
                        <div class="truncate">{{ spec.cpu or 'Unknown' }}</div>
                        {% if spec.cpu_cores %}<div class="text-xs text-gray-400">{{ spec.cpu_cores }} cores</div>{% endif %}
                    </span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                    <span class="text-gray-500 dark:text-gray-400 text-sm"><i class="fas fa-memory mr-2 w-4"></i>RAM</span>
                    <span class="text-gray-800 dark:text-white text-sm font-medium">{{ spec.ram_gb or '?' }} GB</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                    <span class="text-gray-500 dark:text-gray-400 text-sm"><i class="fas fa-hdd mr-2 w-4"></i>Storage</span>
                    <span class="text-gray-800 dark:text-white text-sm font-medium">{{ spec.storage_gb or '?' }} GB {{ spec.storage_type or '' }}</span>
                </div>
                <div class="flex justify-between py-2">
                    <span class="text-gray-500 dark:text-gray-400 text-sm"><i class="fas fa-clock mr-2 w-4"></i>Submitted</span>
                    <span class="text-gray-800 dark:text-white text-sm font-medium">{{ spec.submitted_at|localtime('%b %d, %H:%M') if spec.submitted_at else 'Unknown' }}</span>
                </div>

                <!-- Actions -->
                <div class="flex flex-wrap gap-2 mt-4 pt-3 border-t border-gray-100 dark:border-gray-700">
                    <button onclick="viewSpec({{ spec.id }})" class="flex-1 px-3 py-2 bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/30 dark:hover:bg-blue-900/50 text-blue-600 dark:text-blue-400 rounded-lg transition text-sm">
                        <i class="fas fa-eye mr-1"></i> View
                    </button>
                    {% if not spec.processed %}
                    <button onclick="createAsset({{ spec.id }})" class="flex-1 px-3 py-2 bg-green-50 hover:bg-green-100 dark:bg-green-900/30 dark:hover:bg-green-900/50 text-green-600 dark:text-green-400 rounded-lg transition text-sm">
                        <i class="fas fa-plus mr-1"></i> Add
                    </button>
                    <button onclick="findTickets({{ spec.id }})" class="flex-1 px-3 py-2 bg-purple-50 hover:bg-purple-100 dark:bg-purple-900/30 dark:hover:bg-purple-900/50 text-purple-600 dark:text-purple-400 rounded-lg transition text-sm">
                        <i class="fas fa-ticket-alt mr-1"></i> Tickets
                    </button>
                    {% endif %}
                    <button onclick="deleteSpec({{ spec.id }})" class="px-3 py-2 bg-red-50 hover:bg-red-100 dark:bg-red-900/30 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 rounded-lg transition text-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-16">
        <i class="fas fa-laptop text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
        <h4 class="text-xl text-gray-500 dark:text-gray-400 mb-2">No Device Specs Yet</h4>
        <p class="text-gray-400 dark:text-gray-500">Run the command above on a MacBook to collect its specifications</p>
    </div>
    {% endif %}
</div>

<!-- View Spec Modal -->
<div id="specModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-cyan-500 to-cyan-600 px-6 py-4 flex justify-between items-center">
            <h5 class="text-white font-semibold text-lg"><i class="fas fa-laptop-medical mr-2"></i>Device Specifications</h5>
            <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[70vh]" id="specModalBody">
            <!-- Content loaded dynamically -->
        </div>
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
            <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition text-gray-700 dark:text-gray-300">Close</button>
        </div>
    </div>
</div>

<!-- Find Tickets Modal -->
<div id="ticketsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4 flex justify-between items-center">
            <h5 class="text-white font-semibold text-lg"><i class="fas fa-ticket-alt mr-2"></i>Related Tickets</h5>
            <button onclick="closeTicketsModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[70vh]" id="ticketsModalBody">
            <!-- Content loaded dynamically -->
        </div>
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <span id="ticketsModalInfo" class="text-sm text-gray-500 dark:text-gray-400"></span>
            <button onclick="closeTicketsModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition text-gray-700 dark:text-gray-300">Close</button>
        </div>
    </div>
</div>

<script>
function copyCommand() {
    const command = document.getElementById('curlCommand').textContent;
    navigator.clipboard.writeText(command).then(() => {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.classList.remove('bg-gray-700');
        btn.classList.add('bg-green-600');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('bg-green-600');
            btn.classList.add('bg-gray-700');
        }, 2000);
    });
}

function closeModal() {
    document.getElementById('specModal').classList.add('hidden');
    document.getElementById('specModal').classList.remove('flex');
}

function viewSpec(specId) {
    fetch(`/api/specs/${specId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const spec = data.spec;
                document.getElementById('specModalBody').innerHTML = `
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4">
                            <h6 class="text-cyan-600 dark:text-cyan-400 font-semibold mb-3"><i class="fas fa-fingerprint mr-2"></i>Device Identification</h6>
                            <div class="space-y-2 text-sm">
                                <div><span class="text-gray-500 dark:text-gray-400">Serial:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.serial_number || 'N/A'}</span></div>
                                <div><span class="text-gray-500 dark:text-gray-400">UUID:</span> <span class="text-gray-600 dark:text-gray-300 text-xs break-all">${spec.hardware_uuid || 'N/A'}</span></div>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4">
                            <h6 class="text-cyan-600 dark:text-cyan-400 font-semibold mb-3"><i class="fas fa-laptop mr-2"></i>Model</h6>
                            <div class="space-y-2 text-sm">
                                <div><span class="text-gray-500 dark:text-gray-400">Model:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.model_name_translated || spec.model_name || 'N/A'}</span></div>
                                <div><span class="text-gray-500 dark:text-gray-400">Model Number:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.model_number || spec.model_id || 'N/A'}</span></div>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4">
                            <h6 class="text-cyan-600 dark:text-cyan-400 font-semibold mb-3"><i class="fas fa-microchip mr-2"></i>Processor</h6>
                            <div class="space-y-2 text-sm">
                                <div><span class="text-gray-500 dark:text-gray-400">CPU:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.cpu || 'N/A'}</span></div>
                                <div><span class="text-gray-500 dark:text-gray-400">Cores:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.cpu_cores || 'N/A'}</span></div>
                                <div><span class="text-gray-500 dark:text-gray-400">GPU:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.gpu || 'N/A'}</span></div>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4">
                            <h6 class="text-cyan-600 dark:text-cyan-400 font-semibold mb-3"><i class="fas fa-memory mr-2"></i>Memory & Storage</h6>
                            <div class="space-y-2 text-sm">
                                <div><span class="text-gray-500 dark:text-gray-400">RAM:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.ram_gb || 'N/A'} GB</span></div>
                                <div><span class="text-gray-500 dark:text-gray-400">Storage:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.storage_gb || 'N/A'} GB ${spec.storage_type || ''}</span></div>
                                <div><span class="text-gray-500 dark:text-gray-400">Free:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.free_space || 'N/A'}</span></div>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4">
                            <h6 class="text-cyan-600 dark:text-cyan-400 font-semibold mb-3"><i class="fab fa-apple mr-2"></i>macOS</h6>
                            <div class="space-y-2 text-sm">
                                <div><span class="text-gray-500 dark:text-gray-400">Version:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.os_name || 'macOS'} ${spec.os_version || ''}</span></div>
                                <div><span class="text-gray-500 dark:text-gray-400">Build:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.os_build || 'N/A'}</span></div>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4">
                            <h6 class="text-cyan-600 dark:text-cyan-400 font-semibold mb-3"><i class="fas fa-wifi mr-2"></i>Network</h6>
                            <div class="space-y-2 text-sm">
                                <div><span class="text-gray-500 dark:text-gray-400">WiFi MAC:</span> <span class="text-gray-800 dark:text-white font-medium">${spec.wifi_mac || 'N/A'}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400 text-sm">
                        <i class="fas fa-clock mr-1"></i> Submitted: ${spec.submitted_at || 'Unknown'}
                        <span class="mx-2">|</span>
                        <i class="fas fa-globe mr-1"></i> IP: ${spec.ip_address || 'Unknown'}
                    </div>
                `;
                document.getElementById('specModal').classList.remove('hidden');
                document.getElementById('specModal').classList.add('flex');
            } else {
                alert('Error loading spec: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading spec details');
        });
}

function createAsset(specId, ticketId = null) {
    let url = `/inventory/assets/add?from_spec=${specId}`;
    if (ticketId) {
        url += `&ticket_id=${ticketId}`;
    }
    window.location.href = url;
}

function deleteSpec(specId) {
    if (!confirm('Are you sure you want to delete this spec submission?')) {
        return;
    }

    fetch(`/api/specs/${specId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error deleting spec: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting spec');
    });
}

// Store current spec ID for ticket linking
let currentSpecId = null;

function findTickets(specId) {
    currentSpecId = specId;
    document.getElementById('ticketsModalBody').innerHTML = `
        <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
            <span class="ml-3 text-gray-500">Searching for related tickets...</span>
        </div>
    `;
    document.getElementById('ticketsModalInfo').textContent = '';
    document.getElementById('ticketsModal').classList.remove('hidden');
    document.getElementById('ticketsModal').classList.add('flex');

    fetch(`/api/specs/${specId}/find-tickets`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.tickets.length === 0) {
                    document.getElementById('ticketsModalBody').innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-search text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
                            <h4 class="text-lg text-gray-500 dark:text-gray-400 mb-2">No Related Tickets Found</h4>
                            <p class="text-gray-400 dark:text-gray-500 text-sm mb-4">No tickets match the serial number or model of this device.</p>
                            <button onclick="createAsset(${specId})" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition">
                                <i class="fas fa-plus mr-1"></i> Add Asset Without Ticket
                            </button>
                        </div>
                    `;
                } else {
                    let ticketsHtml = `<div class="space-y-3">`;
                    data.tickets.forEach(ticket => {
                        const statusColors = {
                            'Open': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                            'In Progress': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                            'Closed': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300',
                            'Resolved': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
                        };
                        const statusClass = statusColors[ticket.status] || 'bg-gray-100 text-gray-800';
                        ticketsHtml += `
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <span class="font-semibold text-gray-800 dark:text-white">${ticket.display_id}</span>
                                        <span class="ml-2 px-2 py-0.5 text-xs rounded-full ${statusClass}">${ticket.status}</span>
                                    </div>
                                    <span class="text-xs text-gray-400">${ticket.created_at}</span>
                                </div>
                                <p class="text-gray-600 dark:text-gray-300 text-sm mb-3 line-clamp-2">${ticket.title}</p>
                                <div class="flex gap-2">
                                    <a href="/tickets/${ticket.id}" target="_blank" class="px-3 py-1.5 bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/30 dark:hover:bg-blue-900/50 text-blue-600 dark:text-blue-400 rounded text-sm">
                                        <i class="fas fa-external-link-alt mr-1"></i> View
                                    </a>
                                    <button onclick="createAsset(${specId}, ${ticket.id})" class="px-3 py-1.5 bg-green-50 hover:bg-green-100 dark:bg-green-900/30 dark:hover:bg-green-900/50 text-green-600 dark:text-green-400 rounded text-sm">
                                        <i class="fas fa-plus mr-1"></i> Add to Ticket
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    ticketsHtml += `</div>`;
                    document.getElementById('ticketsModalBody').innerHTML = ticketsHtml;
                }
                document.getElementById('ticketsModalInfo').textContent =
                    `Found ${data.count} ticket(s) matching: ${data.search_terms.join(', ')}`;
            } else {
                document.getElementById('ticketsModalBody').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                        <p>Error: ${data.error}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('ticketsModalBody').innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                    <p>Error loading tickets</p>
                </div>
            `;
        });
}

function closeTicketsModal() {
    document.getElementById('ticketsModal').classList.add('hidden');
    document.getElementById('ticketsModal').classList.remove('flex');
    currentSpecId = null;
}
</script>
{% endblock %}
