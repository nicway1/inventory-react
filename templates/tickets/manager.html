{% extends "base.html" %}

{% block title %}Ticket Manager{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
    /* Salesforce-style design tokens */
    :root {
        --sf-blue: #0176d3;
        --sf-blue-dark: #014486;
        --sf-blue-light: #1b96ff;
        --sf-gray-50: #fafaf9;
        --sf-gray-100: #f3f3f3;
        --sf-gray-200: #e5e5e5;
        --sf-gray-300: #c9c9c9;
        --sf-gray-400: #939393;
        --sf-gray-500: #706e6b;
        --sf-gray-600: #514f4d;
        --sf-gray-700: #3e3e3c;
        --sf-gray-800: #1a1a1a;
        --sf-success: #2e844a;
        --sf-warning: #fe9339;
        --sf-error: #ea001e;
        --sf-purple: #8b5cf6;
        --sf-indigo: #5867e8;
    }

    .sf-page {
        background: var(--sf-gray-100);
        min-height: 100vh;
    }

    /* Header */
    .sf-header {
        background: white;
        border-bottom: 1px solid var(--sf-gray-200);
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .sf-breadcrumb {
        font-size: 0.75rem;
        color: var(--sf-gray-500);
        margin-bottom: 0.25rem;
    }

    .sf-breadcrumb a {
        color: var(--sf-blue);
        text-decoration: none;
    }

    .sf-breadcrumb a:hover {
        text-decoration: underline;
    }

    .sf-page-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--sf-gray-800);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sf-page-subtitle {
        font-size: 0.875rem;
        color: var(--sf-gray-500);
        margin-top: 0.25rem;
    }

    .sf-header-actions {
        display: flex;
        gap: 0.75rem;
    }

    /* Buttons */
    .sf-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
        font-weight: 600;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.15s ease;
        border: 1px solid transparent;
        text-decoration: none;
    }

    .sf-btn-neutral {
        background: white;
        border-color: var(--sf-gray-300);
        color: var(--sf-gray-700);
    }

    .sf-btn-neutral:hover {
        background: var(--sf-gray-100);
    }

    .sf-btn-brand {
        background: var(--sf-blue);
        color: white;
    }

    .sf-btn-brand:hover {
        background: var(--sf-blue-dark);
    }

    .sf-btn-success {
        background: var(--sf-success);
        color: white;
    }

    .sf-btn-success:hover {
        background: #236b3b;
    }

    .sf-btn-purple {
        background: var(--sf-purple);
        color: white;
    }

    .sf-btn-purple:hover {
        background: #7c3aed;
    }

    /* Content */
    .sf-content {
        padding: 1.5rem 2rem;
    }

    /* Summary Cards */
    .sf-summary-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 1200px) {
        .sf-summary-cards {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 640px) {
        .sf-summary-cards {
            grid-template-columns: 1fr;
        }
    }

    .sf-summary-card {
        background: white;
        border: 1px solid var(--sf-gray-200);
        border-radius: 0.5rem;
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .sf-summary-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .sf-summary-icon.blue { background: #e5f2ff; color: var(--sf-blue); }
    .sf-summary-icon.orange { background: #fff3e0; color: var(--sf-warning); }
    .sf-summary-icon.red { background: #ffe5e5; color: var(--sf-error); }
    .sf-summary-icon.green { background: #e5f5e9; color: var(--sf-success); }
    .sf-summary-icon.purple { background: #f3e8ff; color: var(--sf-purple); }

    .sf-summary-label {
        font-size: 0.75rem;
        color: var(--sf-gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
    }

    .sf-summary-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--sf-gray-800);
    }

    /* Cards */
    .sf-card {
        background: white;
        border: 1px solid var(--sf-gray-200);
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .sf-card-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .sf-card-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--sf-gray-800);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sf-card-body {
        padding: 1.5rem;
    }

    /* Bulk Actions Grid */
    .sf-actions-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
    }

    @media (max-width: 1200px) {
        .sf-actions-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 640px) {
        .sf-actions-grid {
            grid-template-columns: 1fr;
        }
    }

    .sf-action-group label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--sf-gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .sf-action-row {
        display: flex;
        gap: 0.5rem;
    }

    .sf-select {
        flex: 1;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.375rem;
        background: white;
        color: var(--sf-gray-700);
        min-width: 0;
    }

    .sf-select:focus {
        outline: none;
        border-color: var(--sf-blue);
        box-shadow: 0 0 0 3px rgba(1, 118, 211, 0.15);
    }

    .sf-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.375rem;
        background: white;
        color: var(--sf-gray-700);
    }

    .sf-input:focus {
        outline: none;
        border-color: var(--sf-blue);
        box-shadow: 0 0 0 3px rgba(1, 118, 211, 0.15);
    }

    /* Quick Action Buttons */
    .sf-quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    /* Filters Grid */
    .sf-filters-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }

    @media (max-width: 1200px) {
        .sf-filters-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 640px) {
        .sf-filters-grid {
            grid-template-columns: 1fr;
        }
    }

    .sf-filter-group label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--sf-gray-600);
        margin-bottom: 0.5rem;
    }

    /* Table */
    .sf-table-container {
        background: white;
        border: 1px solid var(--sf-gray-200);
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .sf-table-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .sf-table-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--sf-gray-700);
    }

    .sf-table {
        width: 100%;
        border-collapse: collapse;
    }

    .sf-table thead {
        background: var(--sf-gray-50);
    }

    .sf-table th {
        padding: 0.75rem 1rem;
        text-align: left;
        font-size: 0.6875rem;
        font-weight: 700;
        color: var(--sf-gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-table td {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: var(--sf-gray-700);
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-table tbody tr:hover {
        background: var(--sf-gray-50);
    }

    .sf-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Links */
    .sf-link {
        color: var(--sf-blue);
        text-decoration: none;
        font-weight: 500;
    }

    .sf-link:hover {
        text-decoration: underline;
    }

    /* Badges */
    .sf-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.625rem;
        font-size: 0.6875rem;
        font-weight: 600;
        border-radius: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .sf-badge-blue { background: #e5f2ff; color: #0176d3; }
    .sf-badge-yellow { background: #fff3cd; color: #856404; }
    .sf-badge-green { background: #d4edda; color: #155724; }
    .sf-badge-red { background: #f8d7da; color: #721c24; }
    .sf-badge-purple { background: #f3e8ff; color: #6d28d9; }
    .sf-badge-gray { background: #e5e5e5; color: #514f4d; }

    /* Checkbox styling */
    .sf-checkbox {
        width: 1rem;
        height: 1rem;
        border-radius: 0.25rem;
        border: 2px solid var(--sf-gray-300);
        cursor: pointer;
    }

    .sf-checkbox:checked {
        background: var(--sf-blue);
        border-color: var(--sf-blue);
    }

    /* Truncate */
    .sf-truncate {
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Selected row highlight */
    .sf-table tbody tr.selected {
        background: #e5f2ff;
    }

    /* Toast notifications */
    .sf-toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    }

    .sf-toast-success { background: var(--sf-success); }
    .sf-toast-error { background: var(--sf-error); }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="sf-page">
    <!-- Header -->
    <div class="sf-header">
        <div>
            <div class="sf-breadcrumb">
                <a href="{{ url_for('main.index') }}">Home</a>
                <span> / </span>
                <a href="{{ url_for('tickets.list_tickets_sf') }}">Tickets</a>
                <span> / </span>
                <span>Manager</span>
            </div>
            <h1 class="sf-page-title">
                <i class="fas fa-cog" style="color: var(--sf-purple);"></i>
                Ticket Manager
            </h1>
            <p class="sf-page-subtitle">Bulk assign queues, users, and update status for multiple tickets</p>
        </div>
        <div class="sf-header-actions">
            <a href="{{ url_for('tickets.list_tickets_sf') }}" class="sf-btn sf-btn-neutral">
                <i class="fas fa-arrow-left"></i> Back to Tickets
            </a>
        </div>
    </div>

    <div class="sf-content">
        <!-- Summary Cards -->
        <div class="sf-summary-cards">
            <div class="sf-summary-card">
                <div class="sf-summary-icon blue">
                    <i class="fas fa-ticket-alt"></i>
                </div>
                <div>
                    <div class="sf-summary-label">Total Tickets</div>
                    <div class="sf-summary-value">{{ tickets|length }}</div>
                </div>
            </div>

            <div class="sf-summary-card">
                <div class="sf-summary-icon orange">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div>
                    <div class="sf-summary-label">Total Queues</div>
                    <div class="sf-summary-value">{{ queues|length }}</div>
                </div>
            </div>

            <div class="sf-summary-card">
                <div class="sf-summary-icon red">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div>
                    <div class="sf-summary-label">No Queue</div>
                    <div class="sf-summary-value">{{ no_queue_count }}</div>
                </div>
            </div>

            <div class="sf-summary-card">
                <div class="sf-summary-icon purple">
                    <i class="fas fa-check-square"></i>
                </div>
                <div>
                    <div class="sf-summary-label">Selected</div>
                    <div class="sf-summary-value" id="selectedCount">0</div>
                </div>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div class="sf-card">
            <div class="sf-card-header">
                <h2 class="sf-card-title">
                    <i class="fas fa-bolt" style="color: var(--sf-warning);"></i>
                    Bulk Actions
                </h2>
            </div>
            <div class="sf-card-body">
                <div class="sf-actions-grid">
                    <div class="sf-action-group">
                        <label>Assign to Queue</label>
                        <div class="sf-action-row">
                            <select id="bulkQueueSelect" class="sf-select">
                                <option value="">-- Select Queue --</option>
                                <option value="">Unassign Queue</option>
                                {% for queue in queues %}
                                <option value="{{ queue.id }}">{{ queue.name }} ({{ queue_count_dict.get(queue.id, 0) }})</option>
                                {% endfor %}
                            </select>
                            <button onclick="bulkAssignQueue()" class="sf-btn sf-btn-brand">
                                <i class="fas fa-layer-group"></i>
                            </button>
                        </div>
                    </div>

                    <div class="sf-action-group">
                        <label>Assign to User</label>
                        <div class="sf-action-row">
                            <select id="bulkUserSelect" class="sf-select">
                                <option value="">-- Select User --</option>
                                <option value="">Unassign User</option>
                                {% for u in users %}
                                <option value="{{ u.id }}">{{ u.username }} ({{ u.user_type.value }})</option>
                                {% endfor %}
                            </select>
                            <button onclick="bulkAssignUser()" class="sf-btn sf-btn-success">
                                <i class="fas fa-user"></i>
                            </button>
                        </div>
                    </div>

                    <div class="sf-action-group">
                        <label>Update Status</label>
                        <div class="sf-action-row">
                            <select id="bulkStatusSelect" class="sf-select">
                                <option value="">-- Select Status --</option>
                                <option value="NEW">New</option>
                                <option value="OPEN">Open</option>
                                <option value="IN_PROGRESS">In Progress</option>
                                <option value="ON_HOLD">On Hold</option>
                                <option value="RESOLVED">Resolved</option>
                                <option value="RESOLVED_DELIVERED">Resolved (Delivered)</option>
                                {% for status in custom_statuses %}
                                <option value="{{ status.name }}">{{ status.name }}</option>
                                {% endfor %}
                            </select>
                            <button onclick="bulkUpdateStatus()" class="sf-btn sf-btn-purple">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                    </div>

                    <div class="sf-action-group">
                        <label>Quick Actions</label>
                        <div class="sf-quick-actions">
                            <button onclick="selectAll()" class="sf-btn sf-btn-neutral" style="justify-content: center;">
                                <i class="fas fa-check-double"></i> Select All
                            </button>
                            <button onclick="clearSelection()" class="sf-btn sf-btn-neutral" style="justify-content: center;">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="sf-card">
            <div class="sf-card-header">
                <h2 class="sf-card-title">
                    <i class="fas fa-filter" style="color: var(--sf-blue);"></i>
                    Filters
                </h2>
                <button onclick="clearFilters()" class="sf-btn sf-btn-neutral" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                    Clear All
                </button>
            </div>
            <div class="sf-card-body">
                <div class="sf-filters-grid">
                    <div class="sf-filter-group">
                        <label>Queue</label>
                        <select id="filterQueue" onchange="applyFilters()" class="sf-select" style="width: 100%;">
                            <option value="">All Queues</option>
                            <option value="null">No Queue</option>
                            {% for queue in queues %}
                            <option value="{{ queue.id }}">{{ queue.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="sf-filter-group">
                        <label>Status</label>
                        <select id="filterStatus" onchange="applyFilters()" class="sf-select" style="width: 100%;">
                            <option value="">All Status</option>
                            <option value="New">New</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Processing">Processing</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Resolved (All Package Delivered)">Resolved (Delivered)</option>
                            {% for status in custom_statuses %}
                            <option value="{{ status.name }}">{{ status.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="sf-filter-group">
                        <label>Assigned To</label>
                        <select id="filterUser" onchange="applyFilters()" class="sf-select" style="width: 100%;">
                            <option value="">All Users</option>
                            <option value="null">Unassigned</option>
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.username }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="sf-filter-group">
                        <label>Search</label>
                        <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="Search ID or subject..." class="sf-input">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tickets Table -->
        <div class="sf-table-container">
            <div class="sf-table-header">
                <span class="sf-table-title">
                    <i class="fas fa-list"></i>
                    Tickets (<span id="visibleCount">{{ tickets|length }}</span>)
                </span>
            </div>
            <div style="overflow-x: auto;">
                <table class="sf-table" id="ticketsTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" class="sf-checkbox">
                            </th>
                            <th>ID</th>
                            <th>Subject</th>
                            <th>Status</th>
                            <th>Queue</th>
                            <th>Owner</th>
                            <th>Assigned To</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in tickets %}
                        <tr class="ticket-row"
                            data-ticket-id="{{ ticket.id }}"
                            data-queue-id="{{ ticket.queue_id if ticket.queue_id else 'null' }}"
                            data-user-id="{{ ticket.assigned_to_id if ticket.assigned_to_id else 'null' }}"
                            data-status="{{ ticket.status.value if ticket.status else '' }}"
                            data-subject="{{ ticket.subject or '' }}">
                            <td>
                                <input type="checkbox" class="ticket-checkbox sf-checkbox" value="{{ ticket.id }}" onchange="updateSelectedCount()">
                            </td>
                            <td>
                                <a href="{{ url_for('tickets.view_ticket', ticket_id=ticket.id) }}" class="sf-link" target="_blank">
                                    {{ ticket.display_id if ticket.display_id else ticket.id }}
                                </a>
                            </td>
                            <td>
                                <div class="sf-truncate">{{ ticket.subject or 'Untitled' }}</div>
                            </td>
                            <td>
                                <span class="sf-badge
                                    {% if ticket.status.value == 'NEW' or ticket.status.value == 'OPEN' %}sf-badge-blue
                                    {% elif ticket.status.value == 'IN_PROGRESS' %}sf-badge-yellow
                                    {% elif ticket.status.value == 'ON_HOLD' %}sf-badge-red
                                    {% elif ticket.status.value == 'RESOLVED' or ticket.status.value == 'RESOLVED_DELIVERED' %}sf-badge-green
                                    {% else %}sf-badge-gray{% endif %}">
                                    {{ ticket.status.value if ticket.status else 'Unknown' }}
                                </span>
                            </td>
                            <td>
                                {% if ticket.queue %}
                                <span class="sf-badge sf-badge-purple">{{ ticket.queue.name }}</span>
                                {% else %}
                                <span class="sf-badge sf-badge-red">No Queue</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ ticket.owner.username if ticket.owner else '-' }}
                            </td>
                            <td>
                                {{ ticket.assigned_to.username if ticket.assigned_to else '-' }}
                            </td>
                            <td style="color: var(--sf-gray-500); font-size: 0.8125rem;">
                                {{ ticket.created_at.strftime('%Y-%m-%d %H:%M') if ticket.created_at else '-' }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedTickets = new Set();

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `sf-toast sf-toast-${type}`;
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.ticket-checkbox:checked');
        selectedTickets.clear();
        checkboxes.forEach(cb => selectedTickets.add(parseInt(cb.value)));
        document.getElementById('selectedCount').textContent = selectedTickets.size;

        // Update row highlighting
        document.querySelectorAll('.ticket-row').forEach(row => {
            const checkbox = row.querySelector('.ticket-checkbox');
            if (checkbox && checkbox.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });

        // Update select all checkbox state
        const visibleCheckboxes = document.querySelectorAll('.ticket-row:not([style*="display: none"]) .ticket-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (visibleCheckboxes.length > 0) {
            const allChecked = Array.from(visibleCheckboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = !allChecked && selectedTickets.size > 0;
        }
    }

    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const visibleCheckboxes = document.querySelectorAll('.ticket-row:not([style*="display: none"]) .ticket-checkbox');
        visibleCheckboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
        });
        updateSelectedCount();
    }

    function selectAll() {
        const visibleCheckboxes = document.querySelectorAll('.ticket-row:not([style*="display: none"]) .ticket-checkbox');
        visibleCheckboxes.forEach(cb => cb.checked = true);
        document.getElementById('selectAllCheckbox').checked = true;
        updateSelectedCount();
    }

    function clearSelection() {
        document.querySelectorAll('.ticket-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAllCheckbox').checked = false;
        updateSelectedCount();
    }

    function applyFilters() {
        const queueFilter = document.getElementById('filterQueue').value;
        const statusFilter = document.getElementById('filterStatus').value;
        const userFilter = document.getElementById('filterUser').value;
        const searchText = document.getElementById('searchInput').value.toLowerCase();

        let visibleCount = 0;
        const rows = document.querySelectorAll('.ticket-row');
        rows.forEach(row => {
            const queueId = row.getAttribute('data-queue-id');
            const userId = row.getAttribute('data-user-id');
            const status = row.getAttribute('data-status');
            const subject = row.getAttribute('data-subject').toLowerCase();
            const ticketId = row.querySelector('a').textContent.toLowerCase();

            let showRow = true;

            if (queueFilter && queueFilter !== queueId) showRow = false;
            if (userFilter && userFilter !== userId) showRow = false;
            if (statusFilter && statusFilter !== status) showRow = false;
            if (searchText && !ticketId.includes(searchText) && !subject.includes(searchText)) showRow = false;

            row.style.display = showRow ? '' : 'none';
            if (showRow) visibleCount++;
        });

        document.getElementById('visibleCount').textContent = visibleCount;
        updateSelectedCount();
    }

    function clearFilters() {
        document.getElementById('filterQueue').value = '';
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterUser').value = '';
        document.getElementById('searchInput').value = '';
        applyFilters();
    }

    async function bulkAssignQueue() {
        if (selectedTickets.size === 0) {
            showToast('Please select at least one ticket', 'error');
            return;
        }

        const queueId = document.getElementById('bulkQueueSelect').value;
        const queueName = document.getElementById('bulkQueueSelect').selectedOptions[0].text;

        if (!confirm(`${queueId ? 'Assign ' + selectedTickets.size + ' ticket(s) to: ' + queueName : 'Unassign ' + selectedTickets.size + ' ticket(s) from queue'}?`)) {
            return;
        }

        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken) headers['X-CSRFToken'] = csrfToken;

            const response = await fetch('{{ url_for("tickets.bulk_assign_queue") }}', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ ticket_ids: Array.from(selectedTickets), queue_id: queueId })
            });

            const data = await response.json();
            if (data.success) {
                showToast(data.message);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function bulkAssignUser() {
        if (selectedTickets.size === 0) {
            showToast('Please select at least one ticket', 'error');
            return;
        }

        const userId = document.getElementById('bulkUserSelect').value;
        const userName = document.getElementById('bulkUserSelect').selectedOptions[0].text;

        if (!confirm(`${userId ? 'Assign ' + selectedTickets.size + ' ticket(s) to: ' + userName : 'Unassign ' + selectedTickets.size + ' ticket(s) from user'}?`)) {
            return;
        }

        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken) headers['X-CSRFToken'] = csrfToken;

            const response = await fetch('{{ url_for("tickets.bulk_assign_user") }}', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ ticket_ids: Array.from(selectedTickets), user_id: userId })
            });

            const data = await response.json();
            if (data.success) {
                showToast(data.message);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function bulkUpdateStatus() {
        if (selectedTickets.size === 0) {
            showToast('Please select at least one ticket', 'error');
            return;
        }

        const status = document.getElementById('bulkStatusSelect').value;
        const statusName = document.getElementById('bulkStatusSelect').selectedOptions[0].text;

        if (!status) {
            showToast('Please select a status', 'error');
            return;
        }

        if (!confirm(`Update ${selectedTickets.size} ticket(s) to status: ${statusName}?`)) {
            return;
        }

        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken) headers['X-CSRFToken'] = csrfToken;

            const response = await fetch('{{ url_for("tickets.bulk_update_status") }}', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ ticket_ids: Array.from(selectedTickets), status: status })
            });

            const data = await response.json();
            if (data.success) {
                showToast(data.message);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }
</script>
{% endblock %}
