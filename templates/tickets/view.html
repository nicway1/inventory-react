{% extends "base.html" %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<!-- tab-system.js is already loaded in base.html -->

<!-- Add HTTP request interception for any internal references to port 5000 -->
<script>
    // Make sure all requests go to the current server port
    document.addEventListener('DOMContentLoaded', function() {
        // Force all XMLHttpRequests and fetch requests to use the current origin
        console.log('Current origin:', window.CURRENT_ORIGIN);
        
        // Special fix for hardcoded XHRs that might be coming from included JS files
        if (!window.XMLHttpRequestFixed) {
            const originalOpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function() {
                let args = Array.from(arguments);
                if (typeof args[1] === 'string' && args[1].includes('127.0.0.1:5000')) {
                    console.log('Intercepted hardcoded XHR URL:', args[1]);
                    args[1] = args[1].replace('http://127.0.0.1:5000', window.CURRENT_ORIGIN);
                    console.log('Redirected to:', args[1]);
                }
                return originalOpen.apply(this, args);
            };
            window.XMLHttpRequestFixed = true;
        }
    });
</script>

<!-- Comment textarea helper functions - must be defined before textarea uses them -->
<script>
// Auto-resize textarea for messenger-style comments
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
}

// Handle Enter key (Shift+Enter for new line, Enter to submit)
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        const form = document.getElementById('commentFormMessenger');
        if (form) form.submit();
    }
}

// Direct @mention check (called from oninput)
function checkMention(textarea) {
    const value = textarea.value;
    const cursorPos = textarea.selectionStart;
    const textBeforeCursor = value.substring(0, cursorPos);

    // Look for @mention pattern
    const mentionMatch = textBeforeCursor.match(/@([a-zA-Z0-9._@-]*)$/);

    if (mentionMatch) {
        console.log('[MENTION-INLINE] Detected @mention:', mentionMatch[1]);
        console.log('[MENTION-INLINE] triggerMentionSearch exists:', typeof window.triggerMentionSearch);
        // Trigger the search via global function if available
        if (typeof window.triggerMentionSearch === 'function') {
            console.log('[MENTION-INLINE] Calling triggerMentionSearch...');
            window.triggerMentionSearch(textarea, mentionMatch[1], cursorPos - mentionMatch[0].length);
        } else {
            console.error('[MENTION-INLINE] triggerMentionSearch NOT FOUND!');
        }
    } else {
        // Hide dropdown if no mention pattern
        const dropdown = document.getElementById('mentionDropdown');
        if (dropdown) dropdown.classList.add('hidden');
    }
}

// Global @mention state and functions (defined early to be available)
window.mentionState = {
    currentTextarea: null,
    currentMentionStart: -1,
    mentionUsers: [],
    selectedIndex: -1
};

window.triggerMentionSearch = async function(textarea, query, mentionStart) {
    console.log('[MENTION-GLOBAL] Triggered search for:', query);
    const dropdown = document.getElementById('mentionDropdown');
    const mentionList = document.getElementById('mentionList');

    if (!dropdown || !mentionList) {
        console.error('[MENTION-GLOBAL] Dropdown elements not found!');
        return;
    }

    window.mentionState.currentTextarea = textarea;
    window.mentionState.currentMentionStart = mentionStart;

    try {
        const url = `/tickets/api/mention-suggestions?q=${encodeURIComponent(query)}`;
        console.log('[MENTION-GLOBAL] Fetching:', url);
        const response = await fetch(url);
        const data = await response.json();
        console.log('[MENTION-GLOBAL] Got response:', data);

        if (data.suggestions && data.suggestions.length > 0) {
            window.mentionState.mentionUsers = data.suggestions;
            mentionList.innerHTML = '';

            data.suggestions.forEach((item, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; background: white;';
                div.onmouseenter = () => div.style.backgroundColor = '#f3f4f6';
                div.onmouseleave = () => div.style.backgroundColor = 'white';

                const avatarColor = item.type === 'group' ? '#10b981' : '#3b82f6';
                const avatarBg = item.type === 'group' ? '#d1fae5' : '#dbeafe';

                div.innerHTML = `
                    <span style="width: 36px; height: 36px; border-radius: 50%; background: ${avatarBg}; color: ${avatarColor}; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; flex-shrink: 0;">
                        ${item.type === 'group' ? 'üë•' : item.name.charAt(0).toUpperCase()}
                    </span>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; color: #1f2937; font-size: 14px;">@${item.name}</div>
                        <div style="font-size: 12px; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.type === 'group' ? 'Group' : (item.email || 'User')}</div>
                    </div>
                `;
                div.onclick = () => window.selectMention(item);
                mentionList.appendChild(div);
            });

            // Show and position dropdown with better styling
            dropdown.classList.remove('hidden');
            dropdown.style.cssText = 'position: absolute; bottom: 100%; left: 0; width: 280px; max-height: 250px; overflow-y: auto; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 8px; z-index: 9999;';
            console.log('[MENTION-GLOBAL] Dropdown shown with', data.suggestions.length, 'items');
        } else {
            dropdown.classList.add('hidden');
        }
    } catch (err) {
        console.error('[MENTION-GLOBAL] Error:', err);
        dropdown.classList.add('hidden');
    }
};

window.selectMention = function(item) {
    const textarea = window.mentionState.currentTextarea;
    const mentionStart = window.mentionState.currentMentionStart;

    if (!textarea) return;

    const value = textarea.value;
    const beforeMention = value.substring(0, mentionStart);
    const afterCursor = value.substring(textarea.selectionStart);

    const mentionText = `@${item.name}`;
    textarea.value = beforeMention + mentionText + ' ' + afterCursor;

    const newCursorPos = mentionStart + mentionText.length + 1;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();

    document.getElementById('mentionDropdown').classList.add('hidden');
};

// PDF preview functions (defined early to be available for iframe onload)
window.pdfLoaded = function() {
    const loader = document.getElementById('pdfLoader');
    const viewer = document.getElementById('pdfViewer');
    const error = document.getElementById('pdfError');
    if (loader) loader.style.display = 'none';
    if (viewer) viewer.style.display = 'block';
    if (error) error.classList.add('hidden');
};

window.pdfError = function() {
    const loader = document.getElementById('pdfLoader');
    const viewer = document.getElementById('pdfViewer');
    const error = document.getElementById('pdfError');
    if (loader) loader.style.display = 'none';
    if (viewer) viewer.style.display = 'none';
    if (error) error.classList.remove('hidden');
};
</script>

<!-- Initialize global variables -->
<script>
    // Initialize global loadingIndicator to fix the "Cannot access before initialization" error
    var loadingIndicator = null; // Will be set to DOM element later
    
    // Initialize when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
        loadingIndicator = document.getElementById('loadingIndicator');
        
        // Initialize tab system for this ticket
        setTimeout(() => {
            if (window.tabSystem) {
                const ticketId = {{ ticket.id }};
                const ticketSubject = {{ ticket.subject|tojson|safe }};
                const tabId = `ticket-${ticketId}`;
                
                // Add this ticket to tabs if not already present
                window.tabSystem.addTab(tabId, `Case ${ticketId}`, window.location.pathname, 'ticket');
                window.tabSystem.setActiveTab(tabId);
            }
        }, 100);
        // Move Add Item modal to body to avoid parent layout constraints
        const addItemModal = document.getElementById('addItemModal');
        if (addItemModal && addItemModal.parentElement !== document.body) {
            document.body.appendChild(addItemModal);
            addItemModal.classList.add('hidden');
            addItemModal.classList.remove('modal-visible');
            addItemModal.setAttribute('aria-hidden', 'true');
        }
    });
</script>

<!-- No tabs - all sections visible -->
<style>
    /* All content sections visible by default */
    #details, #comments, #documents {
        display: block;
        margin-bottom: 2rem;
    }

    /* Utility class to force Tailwind hidden modals back into view */
    .modal-visible {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        align-items: center;
        justify-content: center;
    }

    /* Messenger-style Comment Styles */
    .comment-content {
        text-align: left;
        word-wrap: break-word;
    }

    /* Loading animation */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .animate-spin {
        animation: spin 1s linear infinite;
    }

    /* Smooth transitions */
    .transition-all {
        transition: all 0.2s ease;
    }
</style>

<!-- Load 17TRACK script only for SingPost tickets -->
{% if ticket.shipping_tracking and (ticket.shipping_tracking.startswith('XZD') or ticket.shipping_tracking.startswith('XZB')) %}
<!-- SingPost Tracking Widget Script -->
<script type="text/javascript" src="//www.17track.net/externalcall.js"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        var attempts = 0;
        var maxAttempts = 10;
        
        function initializeTracker() {
            if (typeof YQV5 !== 'undefined') {
                var trackingContainer = document.getElementById('YQContainer');
                if (trackingContainer) {
                    YQV5.trackSingle({
                        YQ_ContainerId: "YQContainer",
                        YQ_Height: 560,
                        YQ_Fc: "0",
                        YQ_Lang: "en",
                        YQ_Num: {{ ticket.shipping_tracking|tojson|safe }}
                    });
                }
            } else if (attempts < maxAttempts) {
                attempts++;
                setTimeout(initializeTracker, 1000); // Try again in 1 second
            }
        }
        
        initializeTracker();
    });
</script>
{% endif %}

<style>
#YQContainer, #YQContainer-rma_return, #YQContainer-rma_replacement {
    width: 100%;
    height: 560px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 20px;
}

/* Ensure tracking widgets are always visible */
#YQContainer:not(.hidden),
#YQContainer-rma_return:not(.hidden),
#YQContainer-rma_replacement:not(.hidden) {
    display: block !important;
    visibility: visible !important;
    position: static !important;
}

.mention-suggestions {
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
}

.mention-suggestion {
    padding: 8px 12px;
    cursor: pointer;
}

.mention-suggestion.selected {
    background-color: #e5e7eb;
}

.mention {
    background-color: #dbeafe;
    color: #1d4ed8;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 500;
}

.tracking-iframe {
    width: 100%;
    height: 800px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 20px;
}

/* Loading Indicator */
.loading-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.loading-indicator svg {
    animation: spin 1s linear infinite;
    height: 2rem;
    width: 2rem;
    color: #2563eb;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Ensure elements are always visible when not hidden */
#YQContainer:not(.hidden),
#loadingIndicator:not(.hidden),
#customTrackingDisplay:not(.hidden) {
    display: block !important;
    visibility: visible !important;
    position: static !important;
}

/* Salesforce-style UI */
.sf-card {
    background-color: white;
    border-radius: 0.25rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    margin-bottom: 1rem;
}

.sf-card-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    background-color: #f0f4f8;
}

.sf-card-body {
    padding: 1rem;
}

.sf-card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1a202c;
}

.sf-field-row {
    display: flex;
    margin-bottom: 0.5rem;
}

.sf-field-label {
    width: 40%;
    color: #4a5568;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    padding-right: 1rem;
}

.sf-field-value {
    width: 60%;
    color: #111827;
    font-size: 0.875rem;
}

.sf-button {
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    background-color: #f3f4f7;
    border: 1px solid #d1d5db;
    border-radius: 0.25rem;
    color: #4b5563;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    transition: all 0.2s ease;
}

.sf-button:hover {
    background-color: #e5e7eb;
    transform: translateY(-1px);
}

.sf-tabs {
    display: flex;
    border-bottom: 1px solid #e5e7eb;
    background-color: #f0f4f8;
    overflow-x: auto;
}

.sf-tab {
    padding: 0.75rem 1rem;
    color: #6b7280;
    font-size: 0.875rem;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    transition: all 0.2s ease;
}

.sf-tab:hover {
    color: #3b82f6;
}

.sf-tab.active {
    color: #2563eb;
    border-bottom-color: #2563eb;
    font-weight: 500;
}

.sf-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    background-color: #f3f4f6;
    color: #4b5563;
    white-space: normal;
    word-break: break-word;
    max-width: 100%;
    line-height: 1.2;
}

.sf-badge-success {
    background-color: #10b981;
    color: white;
}

.sf-badge-warning {
    background-color: #f59e0b;
    color: white;
}

.sf-badge-info {
    background-color: #3b82f6;
    color: white;
}

.sf-action-buttons {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem 0;
    overflow-x: auto;
}

.sf-data-table {
    width: 100%;
    border-collapse: collapse;
}

.sf-data-table th {
    background-color: #f0f4f8;
    text-align: left;
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #4b5563;
    text-transform: uppercase;
    border-bottom: 1px solid #e5e7eb;
}

.sf-data-table td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.875rem;
    color: #111827;
}

.sf-toolbar {
    background-color: #e6eef8;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    gap: 0.5rem;
}

.primary-button {
    background-color: #3b82f6;
    color: white;
}

.primary-button:hover {
    background-color: #2563eb;
}

.pdf-viewer {
    margin-top: 1rem;
    background: white;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.pdf-viewer.hidden {
    display: none;
}

/* Dark Mode Styles */
body.dark-theme .sf-card {
    background-color: #1f2937;
    border: 1px solid #374151;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

body.dark-theme .sf-card-header {
    background-color: #111827;
    border-bottom: 1px solid #374151;
}

body.dark-theme .sf-card-title {
    color: #f9fafb;
}

body.dark-theme .sf-field-label {
    color: #9ca3af;
}

body.dark-theme .sf-field-value {
    color: #e5e7eb;
}

body.dark-theme .sf-data-table th {
    background-color: #111827;
    color: #9ca3af;
    border-bottom: 1px solid #374151;
}

body.dark-theme .sf-data-table td {
    color: #e5e7eb;
    border-bottom: 1px solid #374151;
}

body.dark-theme .sf-toolbar {
    background-color: #111827;
    border-bottom: 1px solid #374151;
}

body.dark-theme .sf-tab {
    color: #9ca3af;
}

body.dark-theme .sf-tab:hover {
    color: #60a5fa;
}

body.dark-theme .sf-tab.active {
    color: #3b82f6;
}

body.dark-theme .sf-badge {
    background-color: #374151;
    color: #e5e7eb;
}

body.dark-theme .sf-button {
    background-color: #374151;
    border: 1px solid #4b5563;
    color: #e5e7eb;
}

body.dark-theme .sf-button:hover {
    background-color: #4b5563;
}

/* Dark mode text colors for various elements */
body.dark-theme .text-gray-900 {
    color: #f9fafb !important;
}

body.dark-theme .text-gray-800 {
    color: #f3f4f6 !important;
}

body.dark-theme .text-gray-700 {
    color: #e5e7eb !important;
}

body.dark-theme .text-gray-600 {
    color: #d1d5db !important;
}

body.dark-theme .text-gray-500 {
    color: #9ca3af !important;
}

body.dark-theme .font-medium {
    color: #e5e7eb;
}

body.dark-theme .font-semibold {
    color: #f9fafb;
}

/* Dark mode for background elements */
body.dark-theme .bg-gray-50 {
    background-color: #111827 !important;
}

body.dark-theme .bg-gray-100 {
    background-color: #1f2937 !important;
}

body.dark-theme .bg-white {
    background-color: #1f2937 !important;
}

/* Dark mode for borders */
body.dark-theme .border-gray-200 {
    border-color: #374151 !important;
}

body.dark-theme .border-gray-300 {
    border-color: #4b5563 !important;
}

/* Dark mode for specific elements */
body.dark-theme .whitespace-pre-wrap {
    color: #e5e7eb;
}

body.dark-theme .mention-suggestions {
    background: #1f2937;
    border: 1px solid #374151;
}

body.dark-theme .mention-suggestion {
    color: #e5e7eb;
}

body.dark-theme .mention-suggestion.selected {
    background-color: #374151;
}

body.dark-theme .pdf-viewer {
    background: #1f2937;
}

/* Dark mode for tracking elements */
body.dark-theme .tracking-iframe {
    border: 1px solid #374151;
}

/* Dark mode for main wrapper */
body.dark-theme .bg-gray-100 {
    background-color: #111827 !important;
}

body.dark-theme .max-w-7xl {
    color: #e5e7eb;
}

/* Dark mode for main content wrapper */
body.dark-theme .bg-white.rounded-lg.shadow-sm {
    background-color: #1f2937 !important;
    color: #e5e7eb;
}

/* Dark mode for header titles */
body.dark-theme h1 {
    color: #f9fafb !important;
}

body.dark-theme h2 {
    color: #f9fafb !important;
}

body.dark-theme h3 {
    color: #f3f4f6 !important;
}

/* Dark mode for loading indicator */
body.dark-theme #loadingIndicator .bg-white {
    background-color: #1f2937 !important;
}

body.dark-theme #loadingIndicator .text-gray-700 {
    color: #e5e7eb !important;
}

/* Dark mode for form labels */
body.dark-theme label {
    color: #9ca3af !important;
}

body.dark-theme .block.text-sm.font-medium.text-gray-700 {
    color: #9ca3af !important;
}

/* Dark mode for inputs and form elements */
body.dark-theme input {
    background-color: #374151 !important;
    border-color: #4b5563 !important;
    color: #e5e7eb !important;
}

body.dark-theme textarea {
    background-color: #374151 !important;
    border-color: #4b5563 !important;
    color: #e5e7eb !important;
}

body.dark-theme select {
    background-color: #374151 !important;
    border-color: #4b5563 !important;
    color: #e5e7eb !important;
}

/* Dark mode for buttons */
body.dark-theme button {
    background-color: #374151 !important;
    border-color: #4b5563 !important;
    color: #e5e7eb !important;
}

body.dark-theme .bg-blue-600 {
    background-color: #3b82f6 !important;
}

body.dark-theme .bg-blue-700 {
    background-color: #2563eb !important;
}

/* Dark mode overrides for any stubborn elements */
body.dark-theme * {
    border-color: #374151;
}

body.dark-theme .text-gray-600 {
    color: #9ca3af !important;
}

body.dark-theme .text-gray-500 {
    color: #9ca3af !important;
}

/* Address formatting improvements */
.sf-field-value .bg-gray-50 {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
}

body.dark-theme .sf-field-value .bg-gray-50 {
    background-color: #374151 !important;
    border-color: #4b5563 !important;
    color: #e5e7eb !important;
}

body.dark-theme .sf-field-value .bg-gray-50 div {
    color: #e5e7eb !important;
}

/* Country badge styling */
.bg-blue-100 {
    background-color: #dbeafe;
}

.text-blue-800 {
    color: #1e40af;
}

body.dark-theme .bg-blue-100 {
    background-color: #1e3a8a !important;
    color: #93c5fd !important;
}

body.dark-theme .text-blue-800 {
    color: #93c5fd !important;
}

/* Specific fixes for ticket view elements */
body.dark-theme .space-y-2 {
    color: #e5e7eb;
}

body.dark-theme .gap-4 {
    color: #e5e7eb;
}

body.dark-theme .grid {
    color: #e5e7eb;
}



/* IMPROVED DARK MODE - BETTER TEXT VISIBILITY */
body.dark-theme {
    background-color: #1f2937 !important;
    color: #e5e7eb !important;
}

/* Main containers and backgrounds */
body.dark-theme .bg-white,
body.dark-theme .bg-gray-50,
body.dark-theme .bg-gray-100,
body.dark-theme .bg-gray-200 {
    background-color: #1f2937 !important;
}

/* Card specific styling */
body.dark-theme .sf-card,
body.dark-theme .sf-card-header,
body.dark-theme .sf-card-body {
    background-color: #1f2937 !important;
    border-color: #374151 !important;
}

/* Headers - bright and visible */
body.dark-theme h1,
body.dark-theme h2,
body.dark-theme h3,
body.dark-theme h4,
body.dark-theme h5,
body.dark-theme h6 {
    color: #ffffff !important;
}

/* Field labels - medium gray for readability */
body.dark-theme .sf-field-label,
body.dark-theme label {
    color: #9ca3af !important;
}

/* Field values - bright white for readability */
body.dark-theme .sf-field-value {
    color: #ffffff !important;
}

/* More specific targeting for field content */
body.dark-theme .sf-field-row .sf-field-label {
    color: #9ca3af !important;
}

body.dark-theme .sf-field-row .sf-field-value {
    color: #ffffff !important;
}

/* Target the specific content areas */
body.dark-theme .sf-card-body .sf-field-label {
    color: #9ca3af !important;
}

body.dark-theme .sf-card-body .sf-field-value {
    color: #ffffff !important;
}

/* Text content - ensure visibility */
body.dark-theme p,
body.dark-theme span:not(.sf-field-label),
body.dark-theme div:not(.sf-field-label) {
    color: #e5e7eb !important;
}

/* Form elements */
body.dark-theme input,
body.dark-theme textarea,
body.dark-theme select {
    background-color: #374151 !important;
    color: #e5e7eb !important;
    border-color: #4b5563 !important;
}

/* Buttons */
body.dark-theme button:not(.bg-blue-600):not(.bg-green-600):not(.bg-red-600):not(.bg-orange-600),
body.dark-theme .sf-button:not(.primary-button) {
    background-color: #374151 !important;
    color: #e5e7eb !important;
    border-color: #4b5563 !important;
}

/* Colored buttons - keep their colors */
body.dark-theme .bg-blue-600,
body.dark-theme .bg-blue-700,
body.dark-theme .primary-button {
    background-color: #3b82f6 !important;
    color: #ffffff !important;
}

body.dark-theme .bg-green-600 {
    background-color: #059669 !important;
    color: #ffffff !important;
}

body.dark-theme .bg-red-600 {
    background-color: #dc2626 !important;
    color: #ffffff !important;
}

body.dark-theme .bg-orange-600 {
    background-color: #ea580c !important;
    color: #ffffff !important;
}

/* Links - bright blue for visibility */
body.dark-theme a {
    color: #60a5fa !important;
}

/* Tables */
body.dark-theme table,
body.dark-theme tbody,
body.dark-theme thead,
body.dark-theme td,
body.dark-theme th {
    background-color: #1f2937 !important;
    color: #e5e7eb !important;
    border-color: #374151 !important;
}

/* Status badges and indicators */
body.dark-theme .sf-badge {
    background-color: #374151 !important;
    color: #e5e7eb !important;
}

/* Specific text color overrides for better visibility */
body.dark-theme .text-gray-900 {
    color: #ffffff !important;
}

body.dark-theme .text-gray-800 {
    color: #f3f4f6 !important;
}

body.dark-theme .text-gray-700 {
    color: #e5e7eb !important;
}

body.dark-theme .text-gray-600 {
    color: #d1d5db !important;
}

body.dark-theme .text-gray-500 {
    color: #9ca3af !important;
}

body.dark-theme .text-black {
    color: #ffffff !important;
}

/* Font weight preservation */
body.dark-theme .font-medium {
    color: #ffffff !important;
}

body.dark-theme .font-semibold {
    color: #ffffff !important;
}

body.dark-theme .font-bold {
    color: #ffffff !important;
}

/* ULTRA SPECIFIC DARK MODE FIXES - HIGHEST PRIORITY */
body.dark-theme div.sf-field-label,
body.dark-theme .sf-field-row div.sf-field-label,
body.dark-theme .sf-card-body div.sf-field-label {
    color: #9ca3af !important;
    background-color: transparent !important;
}

body.dark-theme div.sf-field-value,
body.dark-theme .sf-field-row div.sf-field-value,
body.dark-theme .sf-card-body div.sf-field-value {
    color: #ffffff !important;
    background-color: transparent !important;
}

/* Override any remaining gray text */
body.dark-theme .sf-card-body div,
body.dark-theme .sf-card-body span,
body.dark-theme .sf-card-body p {
    color: #ffffff !important;
}

/* Ensure labels remain distinguishable */
body.dark-theme .sf-card-body .sf-field-label {
    color: #9ca3af !important;
}

.animate-fade-in {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.pdf-inline-container {
    position: relative;
}

.pdf-loading-indicator {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.8);
    z-index: 10;
}

.pdf-inline-container iframe {
    z-index: 5;
}

/* Direct Modal Styles */
.direct-modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
}

.direct-modal-content {
    background-color: white;
    margin: 50px auto;
    padding: 20px;
    width: 80%;
    max-width: 500px;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.direct-form-group {
    margin-bottom: 15px;
}

.direct-form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.direct-form-control {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.direct-form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.direct-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.direct-btn-primary {
    background-color: #3b82f6;
    color: white;
}

.direct-btn-secondary {
    background-color: #f1f1f1;
    color: #333;
}

.direct-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.direct-modal-title {
    margin: 0;
    font-size: 18px;
}

.direct-close {
    font-size: 24px;
    cursor: pointer;
    background: none;
    border: none;
}
</style>

<div style="display: none; position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: yellow; padding: 10px; font-size: 14px;">
  ‚ö†Ô∏è Using direct form instead of modal
</div>

<!-- Select2 for searchable dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
/* Select2 styling improvements */
.select2-container .select2-selection--single {
    height: 42px !important;
    border: 1px solid #ddd !important;
    border-radius: 4px !important;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 40px !important;
    padding-left: 8px !important;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 40px !important;
}

.select2-dropdown {
    border: 1px solid #ddd !important;
    border-radius: 4px !important;
}

.select2-container--default .select2-search--dropdown .select2-search__field {
    border: 1px solid #ddd !important;
    border-radius: 4px !important;
}

.select2-container--default .select2-results__option {
    padding: 8px !important;
}

.select2-container--default .select2-results__option--highlighted {
    background-color: #3b82f6 !important;
}

/* Days open counter styling for different themes */
.dark #days-open-counter {
    background-color: #1e3a8a !important;
    color: #93c5fd !important;
}

.liquid-glass #days-open-counter {
    background: rgba(59, 130, 246, 0.3) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(59, 130, 246, 0.5) !important;
    color: #93c5fd !important;
}

/* Issue indicator animation */
@keyframes pulse-red {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

#issueIndicator {
    animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* Issue warning styling for dark theme */
.dark #issueWarning {
    background-color: #7f1d1d !important;
    border-color: #991b1b !important;
}

.dark #issueWarning h4 {
    color: #fecaca !important;
}

.dark #issueWarning p {
    color: #fca5a5 !important;
}
</style>

{% endblock head %}

{% block content %}
<div class="bg-gray-100 min-h-screen py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Notification container -->
            <div id="notification" class="fixed top-4 right-4 z-50 hidden"></div>
            
            <!-- Loading indicator -->
            <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="text-center mt-2 text-gray-700">Loading...</p>
                </div>
            </div>
            
            <!-- Main content wrapper with white background -->
            <div class="bg-white rounded-lg shadow-sm p-6">
        <!-- Case Header -->
        <div class="sf-card mb-6">
                <div class="sf-card-header">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                            </svg>
                            <h1 class="sf-card-title">{{ ticket.subject }}</h1>
                        </div>
                        <div class="flex items-center gap-2">
                            <a href="{{ url_for('tickets.list_tickets_sf') }}" class="sf-button">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                                </svg>
                                Back to Tickets
                            </a>
                        </div>
                    </div>
                </div>
                <div class="sf-card-body grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="space-y-2">
                        <div class="sf-field-row">
                            <div class="sf-field-label">Priority</div>
                            <div class="sf-field-value">
                                <span class="sf-badge {% if ticket.priority and ticket.priority.value == 'HIGH' %}sf-badge-warning{% endif %}">
                                    {{ ticket.priority.value if ticket.priority else 'None' }}
                                </span>
                            </div>
                        </div>
                        <div class="sf-field-row">
                            <div class="sf-field-label">Status</div>
                            <div class="sf-field-value">
                                {% if ticket.custom_status %}
                                    {% set custom_status_obj = None %}
                                    {% if custom_statuses %}
                                        {% for cs in custom_statuses %}
                                            {% if cs.name == ticket.custom_status %}
                                                {% set custom_status_obj = cs %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    <span class="sf-badge
                                        {% if custom_status_obj %}
                                            {% if custom_status_obj.color == 'blue' %}sf-badge-info
                                            {% elif custom_status_obj.color == 'green' %}sf-badge-success
                                            {% elif custom_status_obj.color == 'yellow' %}sf-badge-warning
                                            {% elif custom_status_obj.color == 'red' %}sf-badge-danger
                                            {% else %}sf-badge-secondary
                                            {% endif %}
                                        {% else %}sf-badge-secondary
                                        {% endif %}">
                                        {{ custom_status_obj.display_name if custom_status_obj else ticket.custom_status.replace('_', ' ') }}
                                    </span>
                                {% elif ticket.status %}
                                    <span class="sf-badge
                                        {% if ticket.status.name == 'RESOLVED' or ticket.status.name == 'RESOLVED_DELIVERED' %}sf-badge-success
                                        {% elif ticket.status.value == 'REVIEW' %}sf-badge-info
                                        {% elif ticket.status.name == 'IN_PROGRESS' %}sf-badge-info
                                        {% elif ticket.status.name == 'ON_HOLD' %}sf-badge-warning
                                        {% endif %}">
                                        {{ ticket.status.value }}
                                    </span>
                                {% else %}
                                    <span class="sf-badge sf-badge-secondary">
                                        No Status
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="sf-field-row">
                            <div class="sf-field-label">Case Number</div>
                            <div class="sf-field-value font-mono">{{ ticket.display_id }}</div>
                        </div>
                        {% if ticket.category and ticket.category.value == 'ASSET_INTAKE' %}
                        <div class="sf-field-row">
                            <div class="sf-field-label">Customer Name</div>
                            <div class="sf-field-value">{{ ticket.customer.name if ticket.customer else 'Not specified' }}</div>
                        </div>
                        {% endif %}
                        {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                        <div class="sf-field-row">
                            <div class="sf-field-label">Customer Name</div>
                            <div class="sf-field-value">{{ ticket.customer.name if ticket.customer else 'Not specified' }}</div>
                        </div>
                        <div class="sf-field-row">
                            <div class="sf-field-label">Company</div>
                            <div class="sf-field-value">
                                {% if ticket.customer and ticket.customer.company %}
                                    {{ ticket.customer.company.grouped_display_name }}
                                {% else %}
                                    No Company
                                {% endif %}
                            </div>
                        </div>
                        {% if ticket.damage_description %}
                        <div class="sf-field-row">
                            <div class="sf-field-label">Reported Issue</div>
                            <div class="sf-field-value">
                                <pre class="whitespace-pre-wrap font-sans text-red-600">{{ ticket.damage_description }}</pre>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% if ticket.category and ticket.category.name == 'INTERNAL_TRANSFER' %}
                        <!-- Offboarding Customer -->
                        {% if ticket.offboarding_customer %}
                        <div class="sf-field-row">
                            <div class="sf-field-label">üì§ Offboarding Customer</div>
                            <div class="sf-field-value">
                                <strong>{{ ticket.offboarding_customer.name }}</strong>
                                {% if ticket.offboarding_customer.company %}
                                    <br><small class="text-gray-600">{{ ticket.offboarding_customer.company.name }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% if ticket.offboarding_details %}
                        <div class="sf-field-row">
                            <div class="sf-field-label">Device Details</div>
                            <div class="sf-field-value">{{ ticket.offboarding_details }}</div>
                        </div>
                        {% endif %}
                        {% if ticket.offboarding_address %}
                        <div class="sf-field-row">
                            <div class="sf-field-label">Offboarding Address</div>
                            <div class="sf-field-value"><pre class="whitespace-pre-wrap font-sans">{{ ticket.offboarding_address }}</pre></div>
                        </div>
                        {% endif %}
                        {% endif %}

                        <!-- Onboarding Customer -->
                        {% if ticket.onboarding_customer %}
                        <div class="sf-field-row">
                            <div class="sf-field-label">üì• Onboarding Customer</div>
                            <div class="sf-field-value">
                                <strong>{{ ticket.onboarding_customer.name }}</strong>
                                {% if ticket.onboarding_customer.company %}
                                    <br><small class="text-gray-600">{{ ticket.onboarding_customer.company.name }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% if ticket.onboarding_address %}
                        <div class="sf-field-row">
                            <div class="sf-field-label">Onboarding Address</div>
                            <div class="sf-field-value"><pre class="whitespace-pre-wrap font-sans">{{ ticket.onboarding_address }}</pre></div>
                        </div>
                        {% endif %}
                        {% endif %}
                        {% endif %}
                    </div>
                    <div class="space-y-2">
                        <div class="sf-field-row">
                            <div class="sf-field-label">Created Date</div>
                            <div class="sf-field-value">{{ ticket.created_at | singapore_time | default('N/A') }}</div>
                        </div>
                        <div class="sf-field-row">
                            <div class="sf-field-label">Last Modified</div>
                            <div class="sf-field-value">{{ ticket.updated_at | singapore_time | default('N/A') }}</div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="sf-field-row">
                            <div class="sf-field-label">Case Owner</div>
                            <div class="sf-field-value">{{ owner.username if owner else 'Unassigned' }}</div>
                        </div>
                        <div class="sf-field-row">
                            <div class="sf-field-label">Category</div>
                            <div class="sf-field-value">{{ ticket.get_category_display_name() if ticket.get_category_display_name() != 'Custom' else 'Custom Category' }}</div>
                        </div>
                        <div class="sf-field-row">
                            <div class="sf-field-label">Queue</div>
                            <div class="sf-field-value">
                                <div class="flex items-center space-x-3">
                                    <span class="text-gray-900 font-medium">{{ ticket.queue.name if ticket.queue else 'No Queue' }}</span>
                                    {% if not ticket.queue %}
                                        <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">
                                            Unassigned
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Case Progression Bar -->
            {% if ticket and ticket.category and ticket.category.name not in ['ASSET_RETURN_CLAW', 'ASSET_INTAKE'] %}
            <div class="sf-card mb-6">
                <div class="sf-card-header">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="sf-card-title">Case Progress</div>
                            <!-- Issue Indicator (Hidden by default, shown when issues exist) -->
                            <span id="issueIndicator" style="display: none;"
                                  class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800 animate-pulse"
                                  title="Active issues reported on this case">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                <span id="issueCount">0</span> Issue(s)
                            </span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-medium text-gray-600">Days Open:</span>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                </svg>
                                <span id="days-open-counter" data-created-at="{{ ticket.created_at.isoformat() }}">
                                    0
                                </span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="sf-card-body">
                    <div class="relative">
                        <!-- Progress Bar Container -->
                        <div class="flex items-center justify-between mb-4">
                            <!-- Stage 1: Case Created -->
                            <div class="flex flex-col items-center flex-1">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mb-2 
                                    {% if ticket.created_at %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-center">Case Created</span>
                                <span class="text-xs text-gray-500 text-center">
                                    {% if ticket.created_at %}{{ ticket.created_at | singapore_time }}{% else %}Pending{% endif %}
                                </span>
                            </div>

                            <!-- Progress Line 1 -->
                            <div class="flex-1 h-1 mx-2
                                {% if ticket.item_packed %}bg-green-500{% else %}bg-gray-300{% endif %}">
                            </div>

                            <!-- Stage 2: Item Packed -->
                            <div class="flex flex-col items-center flex-1">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mb-2
                                    {% if ticket.item_packed %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001 1v-6a1 1 0 00-1-1h-2z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-center">Item Packed</span>
                                <span class="text-xs text-gray-500 text-center">
                                    {% if ticket.item_packed %}
                                        {% if ticket.item_packed_at %}{{ ticket.item_packed_at | singapore_time }}{% else %}Complete{% endif %}
                                    {% else %}
                                        <button id="markItemPackedBtn"
                                                class="text-xs text-blue-600 hover:text-blue-800 underline"
                                                onclick="markItemPacked({{ ticket.id }})">
                                            Mark Packed
                                        </button>
                                    {% endif %}
                                </span>
                            </div>

                            <!-- Progress Line 2 -->
                            <div class="flex-1 h-1 mx-2 
                                {% if ticket.shipping_tracking %}bg-green-500{% else %}bg-gray-300{% endif %}">
                            </div>

                            <!-- Stage 3: Tracking Created -->
                            <div class="flex flex-col items-center flex-1">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mb-2 
                                    {% if ticket.shipping_tracking %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm3 2h6v2H7V4zm8 4H5v1h10V8zm0 3H5v1h10v-1z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-center">Tracking Created</span>
                                <span class="text-xs text-gray-500 text-center">
                                    {% if ticket.shipping_tracking %}{{ ticket.shipping_tracking[:8] }}...{% else %}Pending{% endif %}
                                </span>
                            </div>

                            <!-- Progress Line 3 -->
                            <div class="flex-1 h-1 mx-2 
                                {% if ticket.shipping_status and ticket.shipping_status not in ['Pending', 'Information Received'] %}bg-green-500{% else %}bg-gray-300{% endif %}">
                            </div>

                            <!-- Stage 4: Customer Received -->
                            <div class="flex flex-col items-center flex-1">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mb-2 
                                    {% if ticket.shipping_status and 'delivered' in ticket.shipping_status.lower() %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-center">Customer Received</span>
                                <span class="text-xs text-gray-500 text-center">
                                    {% if ticket.shipping_status and 'delivered' in ticket.shipping_status.lower() %}Delivered{% else %}In Transit{% endif %}
                                </span>
                            </div>
                        </div>

                        <!-- Issue Warning (Hidden by default, shown when issues exist) -->
                        <div id="issueWarning" style="display: none;" class="mt-4 p-3 bg-red-50 rounded-lg border border-red-300">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-500 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                <div>
                                    <h4 class="text-sm font-semibold text-red-900">Active Issues Reported</h4>
                                    <p id="issueWarningText" class="text-xs text-red-700 mt-1"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Current Status Display -->
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-sm font-medium text-blue-900">Current Status</h4>
                                    <p class="text-sm text-blue-700">
                                        {% if ticket.shipping_status and 'delivered' in ticket.shipping_status.lower() %}
                                            Package has been delivered to customer. Case will be automatically closed.
                                        {% elif ticket.shipping_tracking %}
                                            {% if ticket.shipping_status and ticket.shipping_status != 'Pending' %}
                                                {{ ticket.shipping_status }}
                                            {% else %}
                                                Tracking number created, waiting for carrier pickup
                                            {% endif %}
                                        {% elif ticket.assets and ticket.assets|length > 0 %}
                                            Items have been packed and ready for shipment
                                        {% else %}
                                            Case created, waiting for items to be packed
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                        {% if ticket.shipping_status and 'delivered' in ticket.shipping_status.lower() %}
                                            bg-green-100 text-green-800
                                        {% elif ticket.shipping_tracking %}
                                            bg-blue-100 text-blue-800
                                        {% elif ticket.assets and ticket.assets|length > 0 %}
                                            bg-yellow-100 text-yellow-800
                                        {% else %}
                                            bg-gray-100 text-gray-800
                                        {% endif %}">
                                        {% if ticket.shipping_status and 'delivered' in ticket.shipping_status.lower() %}
                                            Completed
                                        {% elif ticket.shipping_tracking %}
                                            In Transit
                                        {% elif ticket.assets and ticket.assets|length > 0 %}
                                            Ready to Ship
                                        {% else %}
                                            Processing
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Auto-close notification for delivered packages -->
                        {% if ticket.shipping_status and 'delivered' in ticket.shipping_status.lower() and (not ticket.status or ticket.status.name != 'RESOLVED') and ticket.custom_status != 'RESOLVED' %}
                        <div class="mt-3 p-3 bg-green-50 rounded-lg border border-green-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <div>
                                    <h4 class="text-sm font-medium text-green-900">Ready for Closure</h4>
                                    <p class="text-sm text-green-700">Package has been delivered. This case can now be closed.</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Issue Reporting Section -->
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-semibold text-gray-800">Report an Issue</h4>
                                <button id="toggleIssueForm" onclick="toggleIssueReportForm()"
                                        class="text-xs bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                    </svg>
                                    Report Issue
                                </button>
                            </div>

                            <!-- Issue Report Form (Hidden by default) -->
                            <div id="issueReportForm" style="display: none;" class="mt-3">
                                <form onsubmit="submitIssueReport(event, {{ ticket.id }})">
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Issue Type</label>
                                            <select id="issueType" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" onchange="toggleCustomIssueType(this)">
                                                <option value="">-- Select Issue Type --</option>
                                                <option value="Wrong Accessories">Wrong Accessories Assigned</option>
                                                <option value="Wrong Address">Wrong Shipping Address</option>
                                                <option value="Missing Items">Missing Items</option>
                                                <option value="Damaged Items">Damaged Items</option>
                                                <option value="Tracking Issue">Tracking Issue</option>
                                                <option value="Other">Other (Custom)</option>
                                            </select>
                                        </div>

                                        <div id="customIssueTypeContainer" style="display: none;">
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Custom Issue Type</label>
                                            <input type="text" id="customIssueType" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Enter custom issue type...">
                                        </div>

                                        <div class="relative">
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Description</label>
                                            <textarea id="issueDescription" required rows="3"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                                    placeholder="Describe the issue... Use @username to notify someone"
                                                    oninput="checkIssueMention(this)"></textarea>
                                            <!-- @mention Dropdown -->
                                            <div id="issueMentionDropdown" class="hidden absolute bottom-full left-0 mb-2 bg-white rounded-lg shadow-lg border border-gray-200 max-h-48 overflow-y-auto w-64 z-50">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">
                                                <span class="text-blue-600 font-medium">@username</span> to mention and notify someone
                                            </p>
                                        </div>

                                        <div class="flex gap-2">
                                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                                Submit Issue
                                            </button>
                                            <button type="button" onclick="toggleIssueReportForm()"
                                                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md text-sm font-medium">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- Issues Display Section -->
                            <div id="issuesDisplay" class="mt-4">
                                <!-- Issues will be loaded here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Shipment Progress Action Bar (for Asset Checkout claw without tracking) -->
            {% if ticket.category and ticket.category.name == 'ASSET_CHECKOUT_CLAW' and not ticket.shipping_tracking %}
            <div class="sf-card mb-6">
                <div class="sf-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h2 class="sf-card-title flex items-center gap-2 text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                        Shipment Progress (No Tracking)
                    </h2>
                </div>
                <div class="sf-card-body p-6">
                    <div class="flex items-center justify-between mb-8">
                        <!-- Step 1: Item Packed -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center {% if ticket.item_packed %}bg-green-500{% else %}bg-gray-300{% endif %} text-white shadow-md">
                                {% if ticket.item_packed %}
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {% else %}
                                <span class="font-bold text-lg">1</span>
                                {% endif %}
                            </div>
                            <div class="mt-3 text-center">
                                <div class="font-semibold text-sm">Item Packed</div>
                                {% if ticket.item_packed_at %}
                                <div class="text-xs text-gray-500 mt-1">{{ ticket.item_packed_at | singapore_time }}</div>
                                {% else %}
                                <div class="text-xs text-gray-400 mt-1">Pending</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Progress Line 1 -->
                        <div class="flex-1 h-2 mx-3 rounded-full overflow-hidden bg-gray-300">
                            <div class="h-full {% if ticket.shipping_tracking_created_at %}bg-green-500{% endif %} transition-all duration-500"></div>
                        </div>

                        <!-- Step 2: Package Shipped -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center {% if ticket.shipping_tracking_created_at %}bg-green-500{% else %}bg-gray-300{% endif %} text-white shadow-md">
                                {% if ticket.shipping_tracking_created_at %}
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {% else %}
                                <span class="font-bold text-lg">2</span>
                                {% endif %}
                            </div>
                            <div class="mt-3 text-center">
                                <div class="font-semibold text-sm">Package Shipped</div>
                                {% if ticket.shipping_tracking_created_at %}
                                <div class="text-xs text-gray-500 mt-1">{{ ticket.shipping_tracking_created_at | singapore_time }}</div>
                                {% else %}
                                <div class="text-xs text-gray-400 mt-1">Pending</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Progress Line 2 -->
                        <div class="flex-1 h-2 mx-3 rounded-full overflow-hidden bg-gray-300">
                            <div class="h-full {% if ticket.status and ticket.status.name in ['RESOLVED', 'RESOLVED_DELIVERED'] %}bg-green-500{% endif %} transition-all duration-500"></div>
                        </div>

                        <!-- Step 3: Customer Received -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center {% if ticket.status and ticket.status.name in ['RESOLVED', 'RESOLVED_DELIVERED'] %}bg-green-500{% else %}bg-gray-300{% endif %} text-white shadow-md">
                                {% if ticket.status and ticket.status.name in ['RESOLVED', 'RESOLVED_DELIVERED'] %}
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {% else %}
                                <span class="font-bold text-lg">3</span>
                                {% endif %}
                            </div>
                            <div class="mt-3 text-center">
                                <div class="font-semibold text-sm">Customer Received</div>
                                {% if ticket.status and ticket.status.name in ['RESOLVED', 'RESOLVED_DELIVERED'] %}
                                <div class="text-xs text-gray-500 mt-1">Delivered</div>
                                {% else %}
                                <div class="text-xs text-gray-400 mt-1">Pending</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3 justify-center">
                        {% if not ticket.item_packed %}
                        <button onclick="updateShipmentProgress('item_packed', {{ ticket.id }})"
                                class="sf-button primary-button flex items-center gap-2 px-6 py-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Mark as Item Packed
                        </button>
                        {% elif not ticket.shipping_tracking_created_at %}
                        <button onclick="updateShipmentProgress('package_shipped', {{ ticket.id }})"
                                class="sf-button primary-button flex items-center gap-2 px-6 py-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
                            </svg>
                            Mark as Package Shipped
                        </button>
                        {% elif not ticket.status or ticket.status.name not in ['RESOLVED', 'RESOLVED_DELIVERED'] %}
                        <button onclick="updateShipmentProgress('customer_received', {{ ticket.id }})"
                                class="sf-button success-button flex items-center gap-2 px-6 py-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Mark as Customer Received
                        </button>
                        {% else %}
                        <div class="text-center">
                            <div class="inline-flex items-center px-6 py-3 rounded-lg bg-green-50 text-green-700 font-medium">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Shipment Completed
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Information Panel -->
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <div>
                                <h4 class="text-sm font-semibold text-blue-900 mb-1">Manual Progress Tracking</h4>
                                <p class="text-xs text-blue-700">This shipment has no tracking number. Use the buttons above to manually update the shipment progress as each stage is completed.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Asset Intake Check-in Progress -->
            {% if ticket.category and ticket.category.name == 'ASSET_INTAKE' and checkin_data %}
            <div class="sf-card mb-6" id="checkinCard">
                <div class="sf-card-header">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <h2 class="sf-card-title flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                                </svg>
                                Asset Check-in
                            </h2>
                        </div>
                        <div id="checkinProgress" class="text-sm">
                            <span class="font-medium" id="checkinCount">{{ checkin_data.progress.checked_in }}</span>
                            <span class="text-gray-500">of</span>
                            <span class="font-medium" id="checkinTotal">{{ checkin_data.progress.total }}</span>
                            <span class="text-gray-500">checked in</span>
                        </div>
                    </div>
                </div>
                <div class="sf-card-body">
                    <!-- Progress Stepper -->
                    <div class="flex items-center justify-center mb-6" id="progressStepper">
                        {% for step in checkin_data.steps %}
                        <div class="flex items-center">
                            <div class="flex flex-col items-center">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold
                                    {% if step.completed %}bg-green-500 text-white{% elif step.number == checkin_data.current_step %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-500{% endif %}"
                                    id="step{{ step.number }}Circle">
                                    {% if step.completed %}
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    {% else %}
                                    {{ step.number }}
                                    {% endif %}
                                </div>
                                <span class="text-xs mt-1 text-center {% if step.completed %}text-green-600 font-medium{% elif step.number == checkin_data.current_step %}text-blue-600 font-medium{% else %}text-gray-400{% endif %}"
                                    id="step{{ step.number }}Label">{{ step.label }}</span>
                            </div>
                            {% if not loop.last %}
                            <div class="w-16 h-1 mx-2 rounded {% if step.completed %}bg-green-500{% else %}bg-gray-200{% endif %}" id="step{{ step.number }}Line"></div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                        <div class="bg-green-500 h-2.5 rounded-full transition-all duration-300"
                            style="width: {{ checkin_data.progress.progress_percent }}%"
                            id="checkinProgressBar"></div>
                    </div>

                    <!-- Serial Number Scan Input -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Scan Serial Number to Check-in</label>
                        <div class="flex gap-2">
                            <input type="text" id="serialScanInput"
                                class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                placeholder="Scan or enter serial number..."
                                autocomplete="off"
                                autofocus>
                            <button onclick="checkInAsset()" class="sf-button primary-button">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Check In
                            </button>
                            <button onclick="previewSerialFix()" class="sf-button" style="background: #f59e0b; color: white;">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                                Fix O‚Üí0
                            </button>
                        </div>
                        <div id="checkinMessage" class="mt-2 hidden"></div>
                    </div>

                    <!-- Assets Table with Check-in Status -->
                    <div class="overflow-x-auto">
                        <table class="sf-data-table" id="checkinAssetsTable">
                            <thead>
                                <tr>
                                    <th>STATUS</th>
                                    <th>SERIAL NUMBER</th>
                                    <th>ASSET TAG</th>
                                    <th>MODEL</th>
                                    <th>CHECKED IN</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asset in checkin_data.assets %}
                                <tr id="checkinRow{{ asset.id }}" class="{% if asset.checked_in %}bg-green-50{% endif %}">
                                    <td>
                                        {% if asset.checked_in %}
                                        <span class="sf-badge sf-badge-success">
                                            <svg class="w-3 h-3 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                            Checked In
                                        </span>
                                        {% else %}
                                        <span class="sf-badge sf-badge-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td class="font-mono">{{ asset.serial_number }}</td>
                                    <td>{{ asset.asset_tag or '-' }}</td>
                                    <td>{{ asset.model or '-' }}</td>
                                    <td class="text-sm text-gray-500">
                                        {% if asset.checked_in_at %}
                                        {{ asset.checked_in_at }}
                                        {% if asset.checked_in_by %}
                                        <br><small>by {{ asset.checked_in_by }}</small>
                                        {% endif %}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-gray-500 py-4">No assets assigned to this ticket yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <script>
            // Asset Check-in Functions
            (function() {
                var ticketId = {{ ticket.id }};
                var serialInput = document.getElementById('serialScanInput');

                // Handle Enter key on serial input
                if (serialInput) {
                    serialInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            checkInAsset();
                        }
                    });
                }

                // Make functions globally available
                window.checkInAsset = function() {
                    var serialNumber = document.getElementById('serialScanInput').value.trim();
                    if (!serialNumber) {
                        showCheckinMessage('Please enter a serial number', 'error');
                        return;
                    }

                    fetch('/tickets/' + ticketId + '/checkin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({ serial_number: serialNumber })
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.success) {
                            showCheckinMessage(data.message, 'success');
                            document.getElementById('serialScanInput').value = '';

                            // Reload page to update UI
                            if (data.ticket_closed) {
                                showCheckinMessage('All assets checked in! Ticket has been resolved.', 'success');
                                setTimeout(function() { location.reload(); }, 1500);
                            } else {
                                setTimeout(function() { location.reload(); }, 1000);
                            }
                        } else {
                            showCheckinMessage(data.error, 'error');
                        }
                    })
                    .catch(function(error) {
                        showCheckinMessage('Error checking in asset: ' + error, 'error');
                    });
                };

                function showCheckinMessage(message, type) {
                    var msgDiv = document.getElementById('checkinMessage');
                    msgDiv.textContent = message;
                    msgDiv.className = 'mt-2 p-2 rounded text-sm ';
                    if (type === 'success') {
                        msgDiv.className += 'bg-green-100 text-green-800';
                    } else if (type === 'error') {
                        msgDiv.className += 'bg-red-100 text-red-800';
                    } else {
                        msgDiv.className += 'bg-blue-100 text-blue-800';
                    }
                    msgDiv.classList.remove('hidden');

                    // Auto-hide after 5 seconds
                    setTimeout(function() {
                        msgDiv.classList.add('hidden');
                    }, 5000);
                }

                // Serial Number O‚Üí0 Fix Functions
                window.previewSerialFix = function() {
                    fetch('/tickets/' + ticketId + '/fix-serial-preview')
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.success) {
                            if (data.count === 0) {
                                showCheckinMessage('No serial numbers need O‚Üí0 correction', 'info');
                                return;
                            }
                            showSerialFixModal(data.fixes);
                        } else {
                            showCheckinMessage(data.error, 'error');
                        }
                    })
                    .catch(function(error) {
                        showCheckinMessage('Error loading preview: ' + error, 'error');
                    });
                };

                function showSerialFixModal(fixes) {
                    // Create modal if it doesn't exist
                    var modal = document.getElementById('serialFixModal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'serialFixModal';
                        modal.className = 'fixed inset-0 z-50 overflow-y-auto hidden';
                        modal.innerHTML =
                            '<div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:p-0">' +
                                '<div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeSerialFixModal()"></div>' +
                                '<div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">' +
                                    '<div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">' +
                                        '<div class="flex items-center justify-between mb-4">' +
                                            '<h3 class="text-lg font-medium text-gray-900">Fix Serial Numbers (O‚Üí0)</h3>' +
                                            '<button onclick="closeSerialFixModal()" class="text-gray-400 hover:text-gray-600">' +
                                                '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>' +
                                                '</svg>' +
                                            '</button>' +
                                        '</div>' +
                                        '<p class="text-sm text-gray-500 mb-4">The following serial numbers contain letter "O" which may have been misread by OCR. Click "Apply Fixes" to replace them with "0" (zero).</p>' +
                                        '<div class="overflow-x-auto max-h-96 overflow-y-auto">' +
                                            '<table class="min-w-full divide-y divide-gray-200" id="serialFixTable">' +
                                                '<thead class="bg-gray-50 sticky top-0">' +
                                                    '<tr>' +
                                                        '<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Asset Tag</th>' +
                                                        '<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Original Serial</th>' +
                                                        '<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fixed Serial</th>' +
                                                    '</tr>' +
                                                '</thead>' +
                                                '<tbody class="bg-white divide-y divide-gray-200" id="serialFixTableBody"></tbody>' +
                                            '</table>' +
                                        '</div>' +
                                    '</div>' +
                                    '<div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">' +
                                        '<button type="button" onclick="applySerialFix()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">' +
                                            'Apply Fixes' +
                                        '</button>' +
                                        '<button type="button" onclick="closeSerialFixModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">' +
                                            'Cancel' +
                                        '</button>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';
                        document.body.appendChild(modal);
                    }

                    // Populate table
                    var tbody = document.getElementById('serialFixTableBody');
                    tbody.innerHTML = '';
                    window.serialFixData = fixes;

                    fixes.forEach(function(fix) {
                        var row = document.createElement('tr');
                        // Highlight the O‚Üí0 change
                        var originalHighlighted = fix.original.replace(/O/g, '<span class="bg-red-200 text-red-800 px-1 rounded font-bold">O</span>');
                        var fixedHighlighted = fix.fixed.replace(/0/g, '<span class="bg-green-200 text-green-800 px-1 rounded font-bold">0</span>');
                        row.innerHTML =
                            '<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">' + (fix.asset_tag || '-') + '</td>' +
                            '<td class="px-3 py-2 whitespace-nowrap text-sm font-mono">' + originalHighlighted + '</td>' +
                            '<td class="px-3 py-2 whitespace-nowrap text-sm font-mono">' + fixedHighlighted + '</td>';
                        tbody.appendChild(row);
                    });

                    modal.classList.remove('hidden');
                }

                window.closeSerialFixModal = function() {
                    var modal = document.getElementById('serialFixModal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                };

                window.applySerialFix = function() {
                    if (!window.serialFixData || window.serialFixData.length === 0) {
                        closeSerialFixModal();
                        return;
                    }

                    var assetIds = window.serialFixData.map(function(fix) { return fix.asset_id; });

                    fetch('/tickets/' + ticketId + '/fix-serial-apply', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({ asset_ids: assetIds })
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        closeSerialFixModal();
                        if (data.success) {
                            showCheckinMessage(data.message, 'success');
                            // Reload page to show updated serials
                            setTimeout(function() { location.reload(); }, 1500);
                        } else {
                            showCheckinMessage(data.error, 'error');
                        }
                    })
                    .catch(function(error) {
                        closeSerialFixModal();
                        showCheckinMessage('Error applying fixes: ' + error, 'error');
                    });
                };
            })();
            </script>
            {% endif %}

            <!-- Case Progression Bar for Asset Return (claw) -->
            {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
            {% set customer_received = (ticket.shipping_status and ('delivered' in ticket.shipping_status.lower() or 'received' in ticket.shipping_status.lower())) %}
            {% set return_shipped = (ticket.return_tracking and ticket.return_status and ticket.return_status not in ['Pending', 'Information Received', '']) %}
            {% set return_received_at_warehouse = (ticket.return_status and ('delivered' in ticket.return_status.lower() or 'received' in ticket.return_status.lower())) %}
            <div class="sf-card mb-6">
                <div class="sf-card-header">
                    <div class="sf-card-title">Case Progress</div>
                </div>
                <div class="sf-card-body">
                    <div class="relative">
                        <!-- Progress Bar Container -->
                        <div class="flex items-center justify-between mb-4">
                            <!-- Stage 1: Case Created -->
                            <div class="flex flex-col items-center flex-1">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mb-2
                                    {% if ticket.created_at %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-center">Case Created</span>
                                <span class="text-xs text-gray-500 text-center">
                                    {% if ticket.created_at %}{{ ticket.created_at | singapore_time }}{% else %}Pending{% endif %}
                                </span>
                            </div>

                            <!-- Progress Line 1 -->
                            <div class="flex-1 h-1 mx-2
                                {% if ticket.shipping_tracking %}bg-green-500{% else %}bg-gray-300{% endif %}">
                            </div>

                            <!-- Stage 2: Return Label Sent -->
                            <div class="flex flex-col items-center flex-1">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mb-2
                                    {% if ticket.shipping_tracking %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500 cursor-pointer hover:bg-gray-400{% endif %}"
                                    {% if not ticket.shipping_tracking %}onclick="showAddOutboundTrackingModal()" title="Click to add tracking"{% endif %}>
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-center">Return Label Sent</span>
                                {% if ticket.shipping_tracking %}
                                <span class="text-xs text-gray-500 text-center">{{ ticket.shipping_tracking[:8] }}...</span>
                                {% else %}
                                <button onclick="showAddOutboundTrackingModal()" class="text-xs text-blue-600 hover:text-blue-800 underline">Add Tracking</button>
                                {% endif %}
                            </div>

                            <!-- Progress Line 2 -->
                            <div class="flex-1 h-1 mx-2
                                {% if customer_received %}bg-green-500{% else %}bg-gray-300{% endif %}">
                            </div>

                            <!-- Stage 3: Customer Received Package -->
                            <div class="flex flex-col items-center flex-1">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mb-2
                                    {% if customer_received %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-center">Customer Received Package</span>
                                <span class="text-xs text-gray-500 text-center">
                                    {% if customer_received %}Complete{% else %}Pending{% endif %}
                                </span>
                            </div>

                            <!-- Progress Line 3 -->
                            <div class="flex-1 h-1 mx-2
                                {% if return_shipped %}bg-green-500{% else %}bg-gray-300{% endif %}">
                            </div>

                            <!-- Stage 4: Return Shipment Sent by Customer -->
                            <div class="flex flex-col items-center flex-1">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mb-2
                                    {% if return_shipped %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm3 2h6v2H7V4zm8 4H5v1h10V8zm0 3H5v1h10v-1z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-center">Return Shipment Sent</span>
                                <span class="text-xs text-gray-500 text-center">
                                    {% if return_shipped %}{{ ticket.return_tracking[:8] }}...{% else %}Pending{% endif %}
                                </span>
                            </div>

                            <!-- Progress Line 4 -->
                            <div class="flex-1 h-1 mx-2
                                {% if return_received_at_warehouse %}bg-green-500{% else %}bg-gray-300{% endif %}">
                            </div>

                            <!-- Stage 5: Return Received at Warehouse -->
                            <div class="flex flex-col items-center flex-1">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mb-2
                                    {% if return_received_at_warehouse %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-center">Return Received at Warehouse</span>
                                <span class="text-xs text-gray-500 text-center">
                                    {% if return_received_at_warehouse %}Complete{% else %}Pending{% endif %}
                                </span>
                            </div>
                        </div>

                        <!-- Current Status Display -->
                        <div class="mt-4 p-3 {% if ticket.status and ticket.status.name == 'RESOLVED' %}bg-green-50 border-green-200{% else %}bg-blue-50 border-blue-200{% endif %} rounded-lg border">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="text-sm font-medium {% if ticket.status and ticket.status.name == 'RESOLVED' %}text-green-900{% else %}text-blue-900{% endif %}">Current Status</h4>
                                    <p class="text-sm {% if ticket.status and ticket.status.name == 'RESOLVED' %}text-green-700{% else %}text-blue-700{% endif %}">
                                        {% if return_received_at_warehouse %}
                                            Return received at warehouse. Case completed!
                                        {% elif return_shipped %}
                                            Customer has shipped the item back - Return tracking: {{ ticket.return_tracking }} ({{ ticket.return_status }})
                                        {% elif ticket.return_tracking and not return_shipped %}
                                            Return tracking added ({{ ticket.return_tracking }}). Waiting for carrier to collect package.
                                        {% elif customer_received %}
                                            Customer received the return label package. Waiting for customer to ship item back.
                                        {% elif ticket.shipping_tracking %}
                                            Return label sent to customer, waiting for delivery confirmation.
                                        {% else %}
                                            Case created, return label needs to be generated and sent to customer.
                                        {% endif %}
                                    </p>
                                    {% if ticket.status and ticket.status.name == 'RESOLVED' %}
                                    <div class="mt-2 flex items-center">
                                        <svg class="w-5 h-5 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        <span class="text-sm font-semibold text-green-800">Case Status: RESOLVED</span>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="text-right ml-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                        {% if ticket.status and ticket.status.name == 'RESOLVED' %}
                                            bg-green-100 text-green-800
                                        {% elif return_received_at_warehouse %}
                                            bg-green-100 text-green-800
                                        {% elif return_shipped %}
                                            bg-blue-100 text-blue-800
                                        {% elif ticket.return_tracking and not return_shipped %}
                                            bg-orange-100 text-orange-800
                                        {% elif customer_received %}
                                            bg-yellow-100 text-yellow-800
                                        {% elif ticket.shipping_tracking %}
                                            bg-yellow-100 text-yellow-800
                                        {% else %}
                                            bg-gray-100 text-gray-800
                                        {% endif %}">
                                        {% if ticket.status and ticket.status.name == 'RESOLVED' %}
                                            Resolved
                                        {% elif return_received_at_warehouse %}
                                            Complete
                                        {% elif return_shipped %}
                                            Return In Transit
                                        {% elif ticket.return_tracking and not return_shipped %}
                                            Awaiting Pickup
                                        {% elif customer_received %}
                                            Awaiting Return Shipment
                                        {% elif ticket.shipping_tracking %}
                                            Label Sent
                                        {% else %}
                                            Processing
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Issue Reporting Section -->
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-semibold text-gray-800">Report an Issue</h4>
                                <button id="toggleIssueBtn" onclick="toggleIssueReportForm()"
                                        class="text-xs bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                    </svg>
                                    Report Issue
                                </button>
                            </div>

                            <!-- Issue Report Form (Hidden by default) -->
                            <div id="issueReportForm" style="display: none;" class="mt-3">
                                <form onsubmit="submitIssueReport(event, {{ ticket.id }})">
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Issue Type</label>
                                            <select id="issueType" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" onchange="toggleCustomIssueType(this)">
                                                <option value="">-- Select Issue Type --</option>
                                                <option value="Device Damage">Device Damage</option>
                                                <option value="Missing Items">Missing Items/Accessories</option>
                                                <option value="Wrong Device">Wrong Device Returned</option>
                                                <option value="Tracking Issue">Tracking Issue</option>
                                                <option value="Address Issue">Address Issue</option>
                                                <option value="Other">Other (Custom)</option>
                                            </select>
                                        </div>

                                        <div id="customIssueTypeContainer" style="display: none;">
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Custom Issue Type</label>
                                            <input type="text" id="customIssueType" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Enter custom issue type...">
                                        </div>

                                        <div class="relative">
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Description</label>
                                            <textarea id="issueDescription" required rows="3"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                                    placeholder="Describe the issue... Use @username to notify someone"
                                                    oninput="checkIssueMention(this)"></textarea>
                                            <!-- @mention Dropdown -->
                                            <div id="issueMentionDropdown" class="hidden absolute bottom-full left-0 mb-2 bg-white rounded-lg shadow-lg border border-gray-200 max-h-48 overflow-y-auto w-64 z-50">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">
                                                <span class="text-blue-600 font-medium">@username</span> to mention and notify someone
                                            </p>
                                        </div>

                                        <div class="flex gap-2">
                                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                                Submit Issue
                                            </button>
                                            <button type="button" onclick="toggleIssueReportForm()"
                                                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md text-sm font-medium">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- Issues Display Section -->
                            <div id="issuesDisplay" class="mt-4">
                                <p class="text-xs text-gray-500 italic">No issues reported</p>
                            </div>
                        </div>

                        <!-- Auto-close notification for received shipments -->
                        {% if return_received and replacement_received and (not ticket.status or ticket.status.name != 'RESOLVED') %}
                        <div class="mt-3 p-3 bg-green-50 rounded-lg border border-green-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <div>
                                    <h4 class="text-sm font-medium text-green-900">Both Shipments Received</h4>
                                    <p class="text-sm text-green-700">Return and replacement have both been received. This case will be auto-closed.</p>
                                </div>
                            </div>
                        </div>
                        {% elif (return_received or replacement_received) and (not ticket.status or ticket.status.name != 'RESOLVED') %}
                        <div class="mt-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                <div>
                                    <h4 class="text-sm font-medium text-yellow-900">Partially Complete</h4>
                                    <p class="text-sm text-yellow-700">
                                        {% if return_received %}Return received - waiting for replacement to be received by customer.{% endif %}
                                        {% if replacement_received %}Replacement received - waiting for return item.{% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Tracking Information -->
                        {% if ticket.shipping_tracking or ticket.return_tracking or ticket.replacement_tracking or ticket.replacement_status %}
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Outbound Tracking (Return Label) -->
                            {% if ticket.shipping_tracking %}
                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <h5 class="text-sm font-medium text-gray-900 mb-2">Return Label Sent</h5>
                                <div class="space-y-1">
                                    <p class="text-xs text-gray-600">Tracking Number:</p>
                                    {% set tracking_url = '' %}
                                    {% if ticket.shipping_carrier == 'hfd' %}
                                        {% set tracking_url = 'https://run.hfd.co.il/info/' ~ ticket.shipping_tracking %}
                                    {% elif ticket.shipping_carrier == 'dhl' %}
                                        {% set tracking_url = 'https://www.dhl.com/en/express/tracking.html?AWB=' ~ ticket.shipping_tracking %}
                                    {% elif ticket.shipping_carrier == 'ups' %}
                                        {% set tracking_url = 'https://www.ups.com/track?tracknum=' ~ ticket.shipping_tracking %}
                                    {% elif ticket.shipping_carrier == 'fedex' %}
                                        {% set tracking_url = 'https://www.fedex.com/fedextrack/?trknbr=' ~ ticket.shipping_tracking %}
                                    {% elif ticket.shipping_carrier == 'singpost' %}
                                        {% set tracking_url = 'https://www.singpost.com/track-items?trackingid=' ~ ticket.shipping_tracking %}
                                    {% elif ticket.shipping_tracking.startswith('http') %}
                                        {% set tracking_url = ticket.shipping_tracking %}
                                    {% endif %}
                                    {% if tracking_url %}
                                    <a href="{{ tracking_url }}" target="_blank" class="text-sm font-mono text-blue-600 hover:text-blue-800 underline">{{ ticket.shipping_tracking[:20] }}{% if ticket.shipping_tracking|length > 20 %}...{% endif %} ‚Üó</a>
                                    {% else %}
                                    <p class="text-sm font-mono text-blue-600">{{ ticket.shipping_tracking }}</p>
                                    {% endif %}
                                    <p class="text-xs text-gray-600">Status:</p>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                        {% if return_received %}
                                            bg-green-100 text-green-800
                                        {% elif ticket.shipping_status and ticket.shipping_status != 'Pending' %}
                                            bg-blue-100 text-blue-800
                                        {% else %}
                                            bg-gray-100 text-gray-800
                                        {% endif %}">
                                        {{ ticket.shipping_status or 'Pending' }}
                                    </span>
                                </div>
                                {% if not return_received %}
                                <form action="{{ url_for('tickets.mark_return_received', ticket_id=ticket.id) }}" method="POST" class="mt-2">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded">
                                        Mark Return Received
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Inbound Tracking (Return Item) -->
                            {% if ticket.return_tracking %}
                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <h5 class="text-sm font-medium text-gray-900 mb-2">Return Tracking</h5>
                                <div class="space-y-1">
                                    <p class="text-xs text-gray-600">Tracking Number:</p>
                                    <p class="text-sm font-mono text-blue-600">{{ ticket.return_tracking }}</p>
                                    <p class="text-xs text-gray-600">Status:</p>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                        {% if ticket.return_status and ('delivered' in ticket.return_status.lower() or 'received' in ticket.return_status.lower()) %}
                                            bg-green-100 text-green-800
                                        {% elif ticket.return_status and ticket.return_status != 'Pending' %}
                                            bg-blue-100 text-blue-800
                                        {% else %}
                                            bg-gray-100 text-gray-800
                                        {% endif %}">
                                        {{ ticket.return_status or 'Pending' }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}

                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Action Toolbar -->
            <div class="sf-toolbar mb-6 rounded-t-md">
                {% if current_user.is_super_admin or current_user.permissions.can_delete_tickets or (current_user.permissions.can_delete_own_tickets and current_user.id == ticket.requester_id) %}
                <button class="sf-button" onclick="confirmDeleteTicket('{{ ticket.id }}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                    </svg>
                    Delete
                </button>
                {% endif %}
                <a href="{{ url_for('tickets.export_single_ticket_csv', ticket_id=ticket.id) }}" class="sf-button">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export CSV
                </a>
                <button class="sf-button">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    Email
                </button>
                {% if current_user.is_super_admin or current_user.id == ticket.requester_id or current_user.id == ticket.assigned_to_id %}
                <button class="sf-button" onclick="toggleUpdateForm()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Edit / Change Status
                </button>
                {% endif %}
                {% if current_user.id == ticket.assigned_to_id %}
                <button class="sf-button primary-button" onclick="toggleAssignForm()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Change Case Owner
                </button>
                {% endif %}
                {% if current_user.id == ticket.assigned_to_id %}
                <button class="sf-button primary-button" onclick="openQueueChangeModal()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                    </svg>
                    Change Queue
                </button>
                {% endif %}
                {% if current_user.is_admin %}
                <button class="sf-button primary-button" onclick="showAssignItemToPackageModal()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Assign Item to Package
                </button>
                {% endif %}
                
                <!-- Add tracking buttons for Asset Return (claw) -->
                {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                <button class="sf-button" onclick="showAddOutboundTrackingModal()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Add Outbound Tracking
                </button>
                <button class="sf-button" onclick="showAddReturnTrackingModal()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3" />
                    </svg>
                    Add Return Tracking
                </button>
                {% endif %}
            </div>

            <!-- Update Form -->
            <div id="updateForm" class="hidden mb-6">
                <div class="sf-card">
                    <div class="sf-card-header">
                        <h2 class="sf-card-title">Edit Ticket</h2>
                    </div>
                    <div class="sf-card-body">
                        <form method="POST" action="{{ url_for('tickets.update_ticket', ticket_id=ticket.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <!-- Basic Information Section -->
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 gap-4">
                                    <div>
                                        <label for="subject" class="block text-sm font-medium text-gray-700">Subject</label>
                                        <input type="text" id="subject" name="subject" value="{{ ticket.subject }}" 
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                                        <textarea id="description" name="description" rows="4" 
                                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ ticket.description }}</textarea>
                                    </div>
                                    
                                    {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                                    <div>
                                        <label for="return_description" class="block text-sm font-medium text-gray-700">Return Description</label>
                                        <textarea id="return_description" name="return_description" rows="3"
                                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                                  placeholder="Describe what assets are being returned and why">{{ ticket.return_description or '' }}</textarea>
                                    </div>

                                    <div>
                                        <label for="damage_description" class="block text-sm font-medium text-gray-700">Reported Issue</label>
                                        <textarea id="damage_description" name="damage_description" rows="3"
                                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500"
                                                  placeholder="Describe any issues or problems with the device">{{ ticket.damage_description or '' }}</textarea>
                                        <p class="mt-1 text-sm text-gray-500">Document any known issues with the returning device</p>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="shipping_tracking" class="block text-sm font-medium text-gray-700">Outbound Tracking Number</label>
                                            <input type="text" id="shipping_tracking" name="shipping_tracking" 
                                                   value="{{ ticket.shipping_tracking or '' }}" 
                                                   placeholder="e.g., XZD0002556450"
                                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        </div>
                                        
                                        <div>
                                            <label for="return_tracking" class="block text-sm font-medium text-gray-700">Return Tracking Number</label>
                                            <input type="text" id="return_tracking" name="return_tracking" 
                                                   value="{{ ticket.return_tracking or '' }}" 
                                                   placeholder="e.g., XZD0002556451"
                                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div>
                                        <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                                        <textarea id="notes" name="notes" rows="3"
                                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ ticket.notes or '' }}</textarea>
                                    </div>

                                    <div>
                                        <label for="firstbaseorderid" class="block text-sm font-medium text-gray-700">Order ID (Customer Reference)</label>
                                        <input type="text" id="firstbaseorderid" name="firstbaseorderid"
                                               value="{{ ticket.firstbaseorderid or '' }}"
                                               placeholder="e.g., order-12345"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <p class="mt-1 text-xs text-gray-500">Clear this field to allow re-importing the order with updated data</p>
                                    </div>

                                    {% if ticket.shipping_address %}
                                    <div>
                                        <label for="shipping_address" class="block text-sm font-medium text-gray-700">{% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}Return Address{% else %}Shipping Address{% endif %}</label>
                                        <textarea id="shipping_address" name="shipping_address" rows="3" 
                                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ ticket.shipping_address or '' }}</textarea>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Status and Priority Section -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                                        <select id="status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <!-- System Statuses -->
                                            <option value="NEW" {% if ticket.status and ticket.status.name == 'NEW' %}selected{% endif %}>
                                                New
                                            </option>
                                            <option value="IN_PROGRESS" {% if ticket.status and ticket.status.name == 'IN_PROGRESS' %}selected{% endif %}>
                                                In Progress
                                            </option>
                                            <option value="ON_HOLD" {% if ticket.status and ticket.status.name == 'ON_HOLD' %}selected{% endif %}>
                                                On Hold
                                            </option>
                                            <option value="RESOLVED" {% if ticket.status and ticket.status.name == 'RESOLVED' %}selected{% endif %}>
                                                Resolved
                                            </option>
                                            <option value="RESOLVED_DELIVERED" {% if ticket.status and ticket.status.name == 'RESOLVED_DELIVERED' %}selected{% endif %}>
                                                Resolved (All Package Delivered)
                                            </option>

                                            <!-- Custom Statuses -->
                                            {% if custom_statuses %}
                                            <optgroup label="Custom Statuses">
                                                {% for custom_status in custom_statuses %}
                                                <option value="{{ custom_status.name }}" {% if ticket.custom_status == custom_status.name %}selected{% endif %}>
                                                    {{ custom_status.display_name }}
                                                </option>
                                                {% endfor %}
                                            </optgroup>
                                            {% endif %}
                                        </select>
                                    </div>
                                    <div>
                                        <label for="priority" class="block text-sm font-medium text-gray-700">Priority</label>
                                        <select id="priority" name="priority" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="LOW" {% if ticket.priority and ticket.priority.name == 'LOW' %}selected{% endif %}>
                                                Low
                                            </option>
                                            <option value="MEDIUM" {% if ticket.priority and ticket.priority.name == 'MEDIUM' %}selected{% endif %}>
                                                Medium
                                            </option>
                                            <option value="HIGH" {% if ticket.priority and ticket.priority.name == 'HIGH' %}selected{% endif %}>
                                                High
                                            </option>
                                            <option value="CRITICAL" {% if ticket.priority and ticket.priority.name == 'CRITICAL' %}selected{% endif %}>
                                                Critical
                                            </option>
                                        </select>
                                    </div>
                                    {% if session.get('user_type') == 'admin' %}
                                    <div class="md:col-span-2">
                                        <label for="assigned_to_id" class="block text-sm font-medium text-gray-700">Assigned To</label>
                                        <select id="assigned_to_id" name="assigned_to_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="">-- Unassigned --</option>
                                            {% for user_id, user in users_dict.items() %}
                                                <option value="{{ user.id }}" {% if ticket.assigned_to_id == user.id %}selected{% endif %}>
                                                    {{ user.username }} {% if user.company %}({{ user.company }}){% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6 space-x-3">
                                <button type="button" onclick="toggleUpdateForm()" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Cancel
                                </button>
                                <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Update Ticket
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Assign Form -->
            <div id="assignForm" class="hidden mb-6">
                <div class="sf-card">
                    <div class="sf-card-header">
                        <h2 class="sf-card-title">Change Case Owner</h2>
                    </div>
                    <div class="sf-card-body">
                        <form method="POST" action="{{ url_for('tickets.transfer_ticket', ticket_id=ticket.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-4">
                                <label for="transfer_to_id" class="block text-sm font-medium text-gray-700">Assign To</label>
                                <select id="transfer_to_id" name="transfer_to_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                                    <option value="">-- Select User --</option>
                                    {% for user_id, user in users_dict.items() %}
                                        <option value="{{ user.id }}">
                                            {{ user.username }} {% if user.company %}({{ user.company }}){% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="transfer_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                                <textarea id="transfer_notes" name="transfer_notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Add any notes about this assignment..."></textarea>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button type="button" onclick="toggleAssignForm()" class="mr-2 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Cancel
                                </button>
                                <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Change Owner
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- All sections displayed sequentially -->
            <h2 class="text-xl font-semibold mb-4 bg-blue-50 p-3 rounded border-l-4 border-blue-500 flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Case Details
            </h2>

            <!-- Content Sections -->
            <div id="page-content-wrapper">
                <!-- Details Section -->
                <div id="details" class="mb-8">
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <h2 class="sf-card-title flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Case Information
                        </h2>
                        </div>
                        <div class="sf-card-body">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Subject</div>
                                        <div class="sf-field-value">{{ ticket.subject }}</div>
                                    </div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Description</div>
                                        <div class="sf-field-value whitespace-pre-wrap">{{ ticket.description }}</div>
                                    </div>
                                    {% if ticket.return_description and ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Return Description</div>
                                        <div class="sf-field-value whitespace-pre-wrap">{{ ticket.return_description }}</div>
                                    </div>
                                    {% endif %}
                                    {% if ticket.damage_description and ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Reported Issue</div>
                                        <div class="sf-field-value whitespace-pre-wrap text-red-600">{{ ticket.damage_description }}</div>
                                    </div>
                                    {% endif %}
                                    {% if ticket.notes %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Notes</div>
                                        <div class="sf-field-value whitespace-pre-wrap">{{ ticket.notes }}</div>
                                    </div>
                                    {% endif %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Case Origin</div>
                                        <div class="sf-field-value">Web</div>
                                    </div>
                                    {% if ticket.firstbaseorderid %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Order ID</div>
                                        <div class="sf-field-value">{{ ticket.firstbaseorderid }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Date/Time Opened</div>
                                        <div class="sf-field-value">{{ ticket.created_at | singapore_time | default('N/A') }}</div>
                                    </div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Date/Time Closed</div>
                                        <div class="sf-field-value">-</div>
                                    </div>
                                    <!-- Service Type field hidden per user request -->
                                    <div class="sf-field-row" style="display: none;">
                                        <div class="sf-field-label">Service Type</div>
                                        <div class="sf-field-value">Hardware Support</div>
                                    </div>
                                    
                                    {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                                    <!-- Tracking Information Section -->
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Outbound Tracking</div>
                                        <div class="sf-field-value">
                                            {% if ticket.shipping_tracking %}
                                            <div>{{ ticket.shipping_tracking }} ({{ ticket.shipping_carrier }})</div>
                                            <div class="text-sm text-gray-500">Status: {{ ticket.shipping_status }}</div>
                                            {% else %}
                                            <span class="text-gray-500">Not added yet</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Return Tracking</div>
                                        <div class="sf-field-value">
                                            {% if ticket.return_tracking %}
                                            <div>{{ ticket.return_tracking }} ({{ ticket.shipping_carrier }})</div>
                                            <div class="text-sm text-gray-500">Status: {{ ticket.return_status }}</div>
                                            {% else %}
                                            <span class="text-gray-500">Not added yet</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Information Card for Asset Checkout and Return Categories -->
                    {% if ticket.category and (ticket.category.name == 'ASSET_CHECKOUT_MAIN' or 
                          ticket.category.name == 'ASSET_CHECKOUT_CLAW' or 
                          ticket.category.name == 'ASSET_CHECKOUT_SINGPOST' or 
                          ticket.category.name == 'ASSET_CHECKOUT_DHL' or 
                          ticket.category.name == 'ASSET_CHECKOUT_UPS' or 
                          ticket.category.name == 'ASSET_CHECKOUT_BLUEDART' or 
                          ticket.category.name == 'ASSET_CHECKOUT_DTDC' or 
                          ticket.category.name == 'ASSET_CHECKOUT_AUTO' or
                          ticket.category.name == 'ASSET_RETURN_CLAW') and ticket.customer %}
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <h2 class="sf-card-title flex items-center gap-2">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    Customer Information
                                </h2>
                                {% if current_user.is_super_admin or current_user.is_developer %}
                                <button type="button" onclick="showAssignCustomerModal()" class="sf-button text-sm" title="Change Customer">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    Change
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                                <!-- Customer Details -->
                                <div class="space-y-4 lg:col-span-2">
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Customer Name</div>
                                        <div class="sf-field-value font-medium">{{ ticket.customer.name }}</div>
                                    </div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Email</div>
                                        <div class="sf-field-value">
                                            {% if ticket.customer.email %}
                                            <a href="mailto:{{ ticket.customer.email }}" class="text-blue-600 hover:text-blue-800">
                                                {{ ticket.customer.email }}
                                            </a>
                                            {% else %}
                                            <span class="text-gray-500">Not provided</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Phone</div>
                                        <div class="sf-field-value">
                                            {% if ticket.customer.contact_number %}
                                            <a href="tel:{{ ticket.customer.contact_number }}" class="text-blue-600 hover:text-blue-800">
                                                {{ ticket.customer.contact_number }}
                                            </a>
                                            {% else %}
                                            <span class="text-gray-500">Not provided</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Country</div>
                                        <div class="sf-field-value">
                                            {% if ticket.customer.country %}
                                            <span class="inline-flex items-center">
                                                <i class="fas fa-globe text-gray-400 mr-2"></i>
                                                {{ ticket.customer.country }}
                                            </span>
                                            {% else %}
                                            <span class="text-gray-500">Not provided</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Company Details -->
                                <div class="space-y-4 lg:col-span-1">
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Company</div>
                                        <div class="sf-field-value">
                                            {% if ticket.customer.company %}
                                            {{ ticket.customer.company.grouped_display_name or ticket.customer.company.name }}
                                            {% else %}
                                            <span class="text-gray-500">No Company</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if ticket.customer.company and ticket.customer.company.parent_company %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Parent Company</div>
                                        <div class="sf-field-value">
                                            {{ ticket.customer.company.parent_company.effective_display_name or ticket.customer.company.parent_company.name }}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if ticket.customer.company and ticket.customer.company.website %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Website</div>
                                        <div class="sf-field-value">
                                            <a href="{{ ticket.customer.company.website }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                                {{ ticket.customer.company.website }}
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if ticket.customer.department %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Department</div>
                                        <div class="sf-field-value">{{ ticket.customer.department }}</div>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Address Details -->
                                <div class="space-y-4 lg:col-span-2">
                                    {% if ticket.customer.address or ticket.shipping_address %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">
                                            {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                                                Return Address
                                            {% elif ticket.shipping_address %}
                                                Shipping Address
                                            {% else %}
                                                Address
                                            {% endif %}
                                        </div>
                                        <div class="sf-field-value">
                                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-sm leading-relaxed">
                                                {% if ticket.shipping_address %}
                                                    {% set address_lines = ticket.shipping_address.split('\n') %}
                                                    {% for line in address_lines %}
                                                        {% if line.strip() %}
                                                            <div class="mb-1">{{ line.strip() }}</div>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% elif ticket.customer.address %}
                                                    {% set address_lines = ticket.customer.address.split('\n') %}
                                                    {% for line in address_lines %}
                                                        {% if line.strip() %}
                                                            <div class="mb-1">{{ line.strip() }}</div>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="text-gray-500">Not provided</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if ticket.customer.timezone %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Timezone</div>
                                        <div class="sf-field-value">{{ ticket.customer.timezone }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Unknown/Missing Customer Warning for SUPER_ADMIN/DEVELOPER -->
                    {% if ticket.category and (ticket.category.name == 'ASSET_CHECKOUT_MAIN' or
                          ticket.category.name == 'ASSET_CHECKOUT_CLAW' or
                          ticket.category.name == 'ASSET_CHECKOUT_SINGPOST' or
                          ticket.category.name == 'ASSET_CHECKOUT_DHL' or
                          ticket.category.name == 'ASSET_CHECKOUT_UPS' or
                          ticket.category.name == 'ASSET_CHECKOUT_BLUEDART' or
                          ticket.category.name == 'ASSET_CHECKOUT_DTDC' or
                          ticket.category.name == 'ASSET_CHECKOUT_AUTO' or
                          ticket.category.name == 'ASSET_RETURN_CLAW') and not ticket.customer %}
                    <div class="sf-card mb-6 border-2 border-amber-400 bg-amber-50">
                        <div class="sf-card-header bg-amber-100">
                            <div class="flex justify-between items-center">
                                <h2 class="sf-card-title flex items-center gap-2 text-amber-800">
                                    <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                    </svg>
                                    Unknown Customer
                                </h2>
                                {% if current_user.is_super_admin or current_user.is_developer %}
                                <div class="flex gap-2">
                                    <button type="button" onclick="cloneAndEditCustomer()" class="sf-button bg-green-600 hover:bg-green-700 text-white">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                        </svg>
                                        Create New Customer
                                    </button>
                                    <button type="button" onclick="showAssignCustomerModal()" class="sf-button primary-button">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                        </svg>
                                        Search Existing
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="text-amber-800">
                                <div class="flex items-center gap-3 mb-4">
                                    <svg class="w-8 h-8 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    <div>
                                        <p class="font-medium">This ticket has no customer assigned.</p>
                                        <p class="text-sm text-amber-700">Customer ID: {{ ticket.customer_id if ticket.customer_id else 'None' }}</p>
                                    </div>
                                </div>
                                {% if ticket.shipping_address %}
                                <div class="mt-4 p-4 bg-white rounded-lg border border-amber-300">
                                    <p class="text-sm font-medium text-gray-700 mb-2">Available Shipping Address (can be cloned):</p>
                                    <div class="text-sm text-gray-600 whitespace-pre-line">{{ ticket.shipping_address }}</div>
                                </div>
                                {% endif %}
                                {% if current_user.is_super_admin or current_user.is_developer %}
                                <p class="text-sm text-amber-700 mt-3">
                                    {% if ticket.shipping_address %}
                                    Click "Clone & Edit" to create a new customer from the shipping address, or "Assign Customer" to select/create manually.
                                    {% else %}
                                    Use the "Assign Customer" button to link a customer to this ticket.
                                    {% endif %}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Related Records Section -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <h2 class="sf-card-title flex items-center gap-2">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    Tech Asset
                                </h2>
                                <div class="flex gap-2">
                                    <button class="sf-button primary-button" onclick="showAssetModal()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                        </svg>
                                        Add Tech Asset
                                    </button>
                                    <button class="sf-button" onclick="showImportTechAssetModal()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                        </svg>
                                        Import Tech Asset
                                    </button>
                                    </div>
                                </div>
                                </div>
                        <div class="sf-card-body">
                                <div class="overflow-x-auto">
                                    <table class="sf-data-table">
                                        <thead>
                                            <tr>
                                            <th>ASSET TAG</th>
                                            <th>SERIAL NUMBER</th>
                                            <th>NAME</th>
                                            <th>STATUS</th>
                                            <th>ACTIONS</th>
                                            </tr>
                                        </thead>
                                    <tbody id="assetTableBody">
                                        {% if ticket.assets %}
                                            {% for asset in ticket.assets %}
                                            <tr>
                                                <td>{{ asset.asset_tag }}</td>
                                                <td>{{ asset.serial_num }}</td>
                                                <td>{{ asset.name }}</td>
                                                <td>
                                                    <span class="sf-badge {% if asset.status and asset.status.value == 'Active' %}sf-badge-success{% endif %}">
                                                        {{ asset.status.value if asset.status else 'Unknown' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="flex gap-2">
                                                        <button onclick="viewAsset('{{ asset.id }}')" class="text-blue-600 hover:text-blue-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                            </svg>
                                                        </button>
                                                        <button onclick="unlinkAsset('{{ asset.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-gray-500 py-4">No assets assigned to this case</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                        </div>
                    </div>

                    <!-- Multi-Package Tracking Section for Asset Checkout (claw) -->
                    {% if ticket.category and ticket.category.name == 'ASSET_CHECKOUT_CLAW' %}
                    {% set packages = ticket.get_all_packages() %}

                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <h2 class="sf-card-title flex items-center gap-2">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                        </svg>
                                        Package Tracking
                                    </h2>
                                    <span class="sf-badge sf-badge-info">{{ packages|length }}/5 Packages</span>
                                </div>
                                <div>
                                    {% if packages|length < 5 %}
                                    <button id="addPackageBtn" class="sf-button primary-button" onclick="showAddPackageModal()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                        </svg>
                                        Add Package
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="p-4">
                                {% if packages %}
                                <div class="space-y-6">
                                    {% for package in packages %}
                                    <div class="border border-gray-200 rounded-lg p-4" id="package-{{ package.package_number }}">
                                        <div class="flex justify-between items-start mb-3">
                                            <h3 class="font-medium text-gray-900">
                                                Package {{ package.package_number }} Tracking
                                            </h3>
                                            <div class="flex gap-2">
                                                <button class="sf-button sm" onclick="editPackage({{ package.package_number }})">
                                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                    </svg>
                                                    Edit
                                                </button>
                                                <button class="sf-button sm red" onclick="removePackage({{ package.package_number }})">
                                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                    </svg>
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <div class="text-sm text-gray-500">Tracking Number</div>
                                                <div class="font-medium">{{ package.tracking_number or 'Not assigned' }}</div>
                                            </div>
                                            <div>
                                                <div class="text-sm text-gray-500">Carrier</div>
                                                <div class="font-medium">{{ package.carrier|title if package.carrier else 'Not specified' }}</div>
                                            </div>
                                            <div>
                                                <div class="text-sm text-gray-500">Status</div>
                                                <div class="font-medium">
                                                    <span class="sf-badge {% if package.status == 'Delivered' %}sf-badge-success{% elif package.status == 'In Transit' %}sf-badge-info{% else %}sf-badge-warning{% endif %}">
                                                        {{ package.status }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Package Items Section -->
                                        <div class="mt-4 border-t pt-3">
                                            <div class="flex justify-between items-center mb-3">
                                                <h4 class="font-medium text-gray-700">Package Items</h4>
                                                <button class="sf-button sm primary-button" onclick="showAddItemModal({{ package.package_number }})">
                                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                                    </svg>
                                                    Add Item
                                                </button>
                                            </div>
                                            <div id="packageItems-{{ package.package_number }}" class="space-y-2">
                                                {% set package_items = packages_items_data.get(package.package_number, []) %}
                                                {% if package_items %}
                                                    {% for item in package_items %}
                                                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded" id="item-{{ item.id }}">
                                                        <div class="flex items-center gap-2">
                                                            <span class="sf-badge {% if item.item_type == 'Asset' %}sf-badge-info{% else %}sf-badge-success{% endif %}">
                                                                {{ item.item_type }}
                                                            </span>
                                                            <span class="font-medium">{{ item.item_name }}</span>
                                                            {% if item.item_type == 'Asset' %}
                                                                {% set details = item.item_details %}
                                                                {% if details.asset_tag %}
                                                                <span class="text-xs text-blue-600 bg-blue-100 px-2 py-0.5 rounded">Tag: {{ details.asset_tag }}</span>
                                                                {% endif %}
                                                                {% if details.serial_num %}
                                                                <span class="text-xs text-indigo-600 bg-indigo-100 px-2 py-0.5 rounded">SN: {{ details.serial_num }}</span>
                                                                {% endif %}
                                                            {% endif %}
                                                            {% if item.quantity > 1 %}
                                                            <span class="text-sm text-gray-500">({{ item.quantity }}x)</span>
                                                            {% endif %}
                                                            {% if item.notes %}
                                                            <span class="text-sm text-gray-500">- {{ item.notes }}</span>
                                                            {% endif %}
                                                        </div>
                                                        <button class="sf-button xs red" onclick="removePackageItem({{ item.id }}, {{ package.package_number }})">
                                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    {% endfor %}
                                                {% else %}
                                                <div class="text-sm text-gray-500 text-center py-2">No items added to this package</div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        {% if package.tracking_number %}
                                        <div class="mt-4 border-t pt-3">
                                            {% if not (package.status and 'delivered' in package.status.lower()) %}
                                            <button class="text-sm text-blue-600 flex items-center" onclick="refreshPackageTracking({{ package.package_number }})">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                                </svg>
                                                Refresh Package {{ package.package_number }} Tracking
                                            </button>
                                            {% else %}
                                            <div class="text-sm text-green-600 flex items-center">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                                Package {{ package.package_number }} Delivered - No refresh needed
                                            </div>
                                            {% endif %}
                                            <div id="trackingResults-{{ package.package_number }}" class="mt-6 hidden">
                                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-100">
                                                    <div class="flex items-center justify-between mb-6">
                                                        <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                                                            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                                            </svg>
                                                            Package Journey
                                                        </h4>
                                                        <div class="flex items-center text-sm text-blue-600 bg-blue-100 px-3 py-1 rounded-full">
                                                            <svg class="w-4 h-4 mr-1 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 1.414L10.586 9.5H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"/>
                                                            </svg>
                                                            Live Tracking
                                                        </div>
                                                    </div>

                                                    <!-- Professional Timeline -->
                                                    <div id="trackingEvents-{{ package.package_number }}" class="space-y-4">
                                                        {% if packages_tracking_data.get(package.package_number) %}
                                                            {% for event in packages_tracking_data[package.package_number] %}
                                                            <div class="relative flex items-start pb-3 {% if not loop.last %}border-l-2 border-blue-200 ml-4{% endif %}">
                                                                <!-- Timeline Icon -->
                                                                <div class="absolute -left-6 top-0 flex items-center justify-center w-8 h-8 rounded-full
                                                                    {% if loop.first %}bg-green-500 text-white shadow-md{% else %}bg-blue-500 text-white shadow-sm{% endif %}">
                                                                    {% if loop.first %}
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                                        </svg>
                                                                    {% elif 'Delivery' in event.status %}
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                                                        </svg>
                                                                    {% elif 'Transit' in event.status %}
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                                        </svg>
                                                                    {% elif 'Arrived' in event.status or 'Sorting' in event.status %}
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                                                        </svg>
                                                                    {% elif 'Received' in event.status %}
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                                                        </svg>
                                                                    {% else %}
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                                        </svg>
                                                                    {% endif %}
                                                                </div>

                                                                <!-- Event Content -->
                                                                <div class="flex-1 bg-white rounded-lg shadow-sm border border-gray-200 p-3 ml-6">
                                                                    <div class="flex items-start justify-between">
                                                                        <div class="flex-1">
                                                                            <h5 class="text-base font-semibold text-gray-900 mb-1">
                                                                                {{ event.status or 'Status unavailable' }}
                                                                            </h5>
                                                                            <div class="flex items-center text-gray-600 mb-2">
                                                                                <svg class="w-3 h-3 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                                                </svg>
                                                                                <span class="text-sm font-medium">{{ event.location or 'Location unavailable' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="text-right">
                                                                            <div class="text-sm font-medium text-gray-900">
                                                                                {% set date_part = event.date.split(' ')[0] if event.date and ' ' in event.date else (event.date.split('T')[0] if event.date and 'T' in event.date else event.date) %}
                                                                                {% if date_part and '-' in date_part and date_part|length == 10 %}
                                                                                    {% set year, month, day = date_part.split('-') %}
                                                                                    {% set month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                                                                                    {{ month_names[month|int - 1] }} {{ day|int }}, {{ year }}
                                                                                {% else %}
                                                                                    {{ date_part }}
                                                                                {% endif %}
                                                                            </div>
                                                                            <div class="text-xs text-gray-500">
                                                                                {{ event.date.split(' ')[1][:5] if event.date and ' ' in event.date else event.date.split('T')[1][:5] if event.date and 'T' in event.date else '' }}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    <!-- Status Badge -->
                                                                    <div class="mt-2">
                                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                                                            {% if loop.first %}bg-green-100 text-green-800{% elif 'Delivery' in event.status %}bg-orange-100 text-orange-800{% elif 'Transit' in event.status %}bg-blue-100 text-blue-800{% elif 'Arrived' in event.status or 'Sorting' in event.status %}bg-purple-100 text-purple-800{% elif 'Received' in event.status %}bg-indigo-100 text-indigo-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                                                            {% if loop.first %}
                                                                                ‚óè Latest Update
                                                                            {% elif 'Delivery' in event.status %}
                                                                                ‚óè Out for Delivery
                                                                            {% elif 'Transit' in event.status %}
                                                                                ‚óè In Transit
                                                                            {% elif 'Arrived' in event.status or 'Sorting' in event.status %}
                                                                                ‚óè Processing
                                                                            {% elif 'Received' in event.status %}
                                                                                ‚óè Received
                                                                            {% else %}
                                                                                ‚óè Event Logged
                                                                            {% endif %}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {% endfor %}
                                                        {% else %}
                                                            <div class="text-center py-8">
                                                                <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                                                </svg>
                                                                <p class="text-gray-500 text-lg font-medium">No tracking events yet</p>
                                                                <p class="text-gray-400 text-sm">Click refresh to load the latest tracking information</p>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="text-center text-gray-500 py-8">
                                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                    </svg>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">No packages added yet</h3>
                                    <p class="text-gray-500 mb-4">Start by adding Package 1 tracking information</p>
                                    <button class="sf-button primary-button" onclick="showAddPackageModal()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                        </svg>
                                        Add Package 1 Tracking
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Portal Tabs for Asset Checkout (claw) -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <h2 class="sf-card-title flex items-center gap-2">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                        </svg>
                                        Shipping Portal
                                    </h2>
                                </div>
                                <!-- Tab-specific action buttons -->
                                <div id="shippingTabActions" class="flex gap-2">
                                    <!-- SingPost actions (shown by default) -->
                                    <div id="singpostActions" class="flex gap-2">
                                        <button class="sf-button" onclick="refreshSingpostIframe()">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                            </svg>
                                            Refresh
                                        </button>
                                        <button class="sf-button" onclick="toggleShippingFullscreen('singpost')">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                                            </svg>
                                            Fullscreen
                                        </button>
                                        <a href="https://www.ezy2ship.net/my-shipment/history" target="_blank" class="sf-button primary-button">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                            </svg>
                                            Open in New Tab
                                        </a>
                                    </div>
                                    <!-- Retool actions (hidden by default) -->
                                    <div id="retoolActions" class="flex gap-2 hidden">
                                        <button class="sf-button" onclick="refreshRetoolIframe()">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                            </svg>
                                            Refresh
                                        </button>
                                        <button class="sf-button" onclick="toggleShippingFullscreen('retool')">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                                            </svg>
                                            Fullscreen
                                        </button>
                                        <a href="https://firstbase.retool.com/apps/59550038-9ae3-11ee-9805-13a1c97ab189/External%20Apps/3PL%20Orders" target="_blank" class="sf-button primary-button">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                            </svg>
                                            Open in New Tab
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Navigation -->
                        <div class="border-b border-gray-200">
                            <nav class="flex -mb-px" aria-label="Shipping Tabs">
                                <button id="tabSingpost" onclick="switchShippingTab('singpost')"
                                        class="shipping-tab active px-6 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600 bg-blue-50">
                                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    SingPost (Ezy2Ship)
                                </button>
                                <button id="tabRetool" onclick="switchShippingTab('retool')"
                                        class="shipping-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
                                    </svg>
                                    3PL Orders (Retool)
                                </button>
                            </nav>
                        </div>

                        <div class="sf-card-body p-0">
                            <!-- SingPost Tab Content -->
                            <div id="singpostTabContent" class="shipping-tab-content">
                                <div id="singpostContainer" class="relative" style="height: 700px;">
                                    <!-- Login notice banner -->
                                    <div id="singpostLoginNotice" class="absolute top-0 left-0 right-0 z-10 bg-amber-50 border-b border-amber-200 px-4 py-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                <span class="text-sm text-amber-800">Login sessions don't persist in iframe. Use popup for full access.</span>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="openEzy2ShipPopup()" class="px-3 py-1.5 text-sm font-medium text-white bg-orange-500 rounded hover:bg-orange-600">
                                                    Open Popup
                                                </button>
                                                <button onclick="document.getElementById('singpostLoginNotice').classList.add('hidden')" class="px-2 py-1 text-amber-600 hover:text-amber-800">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <iframe
                                        id="singpostIframe"
                                        src="https://www.ezy2ship.net/my-shipment/history"
                                        class="w-full h-full border-0"
                                        style="padding-top: 52px;"
                                        allow="clipboard-write"
                                    ></iframe>
                                    <div id="singpostLoading" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden">
                                        <div class="flex flex-col items-center">
                                            <svg class="animate-spin h-8 w-8 text-orange-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span class="text-gray-600">Loading Ezy2Ship...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <script>
                            function openEzy2ShipPopup() {
                                const width = 1200;
                                const height = 800;
                                const left = (screen.width - width) / 2;
                                const top = (screen.height - height) / 2;
                                window.open(
                                    'https://www.ezy2ship.net/my-shipment/history',
                                    'ezy2ship_popup',
                                    `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,toolbar=no,menubar=no,location=no,status=no`
                                );
                            }
                            </script>

                            <!-- Retool Tab Content -->
                            <div id="retoolTabContent" class="shipping-tab-content hidden">
                                <div id="retoolContainer" class="relative" style="height: 700px;">
                                    <iframe
                                        id="retoolIframe"
                                        data-src="https://firstbase.retool.com/apps/59550038-9ae3-11ee-9805-13a1c97ab189/External%20Apps/3PL%20Orders"
                                        class="w-full h-full border-0"
                                        allow="clipboard-write"
                                    ></iframe>
                                    <div id="retoolLoading" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden">
                                        <div class="flex flex-col items-center">
                                            <svg class="animate-spin h-8 w-8 text-blue-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span class="text-gray-600">Loading Retool...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                    // Track which tabs have been loaded
                    let shippingTabsLoaded = { singpost: true, retool: false };

                    // Switch between shipping tabs
                    function switchShippingTab(tabName) {
                        // Update tab buttons
                        document.querySelectorAll('.shipping-tab').forEach(tab => {
                            tab.classList.remove('active', 'border-blue-500', 'text-blue-600', 'bg-blue-50');
                            tab.classList.add('border-transparent', 'text-gray-500');
                        });

                        const activeTab = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
                        activeTab.classList.add('active', 'border-blue-500', 'text-blue-600', 'bg-blue-50');
                        activeTab.classList.remove('border-transparent', 'text-gray-500');

                        // Update tab content
                        document.querySelectorAll('.shipping-tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });
                        document.getElementById(tabName + 'TabContent').classList.remove('hidden');

                        // Update action buttons
                        document.getElementById('singpostActions').classList.toggle('hidden', tabName !== 'singpost');
                        document.getElementById('retoolActions').classList.toggle('hidden', tabName !== 'retool');

                        // Lazy load iframe if not loaded yet
                        if (!shippingTabsLoaded[tabName]) {
                            const iframe = document.getElementById(tabName + 'Iframe');
                            const dataSrc = iframe.getAttribute('data-src');
                            if (dataSrc) {
                                const loading = document.getElementById(tabName + 'Loading');
                                loading.classList.remove('hidden');
                                iframe.src = dataSrc;
                                iframe.onload = function() {
                                    loading.classList.add('hidden');
                                };
                                setTimeout(function() {
                                    loading.classList.add('hidden');
                                }, 5000);
                            }
                            shippingTabsLoaded[tabName] = true;
                        }
                    }

                    // Refresh SingPost iframe
                    function refreshSingpostIframe() {
                        const iframe = document.getElementById('singpostIframe');
                        const loading = document.getElementById('singpostLoading');

                        if (iframe) {
                            loading.classList.remove('hidden');
                            iframe.src = iframe.src;

                            iframe.onload = function() {
                                loading.classList.add('hidden');
                            };

                            setTimeout(function() {
                                loading.classList.add('hidden');
                            }, 5000);
                        }
                    }

                    // Refresh Retool iframe
                    function refreshRetoolIframe() {
                        const iframe = document.getElementById('retoolIframe');
                        const loading = document.getElementById('retoolLoading');

                        if (iframe) {
                            loading.classList.remove('hidden');
                            const src = iframe.src || iframe.getAttribute('data-src');
                            iframe.src = src;

                            iframe.onload = function() {
                                loading.classList.add('hidden');
                            };

                            setTimeout(function() {
                                loading.classList.add('hidden');
                            }, 5000);
                        }
                    }

                    // Toggle fullscreen for shipping iframes
                    function toggleShippingFullscreen(tabName) {
                        const container = document.getElementById(tabName + 'Container');

                        if (!document.fullscreenElement) {
                            if (container.requestFullscreen) {
                                container.requestFullscreen();
                            } else if (container.webkitRequestFullscreen) {
                                container.webkitRequestFullscreen();
                            } else if (container.msRequestFullscreen) {
                                container.msRequestFullscreen();
                            }
                        } else {
                            if (document.exitFullscreen) {
                                document.exitFullscreen();
                            } else if (document.webkitExitFullscreen) {
                                document.webkitExitFullscreen();
                            } else if (document.msExitFullscreen) {
                                document.msExitFullscreen();
                            }
                        }
                    }

                    // Handle fullscreen style changes
                    document.addEventListener('fullscreenchange', function() {
                        const singpostContainer = document.getElementById('singpostContainer');
                        const retoolContainer = document.getElementById('retoolContainer');
                        if (document.fullscreenElement) {
                            if (singpostContainer) singpostContainer.style.height = '100vh';
                            if (retoolContainer) retoolContainer.style.height = '100vh';
                        } else {
                            if (singpostContainer) singpostContainer.style.height = '700px';
                            if (retoolContainer) retoolContainer.style.height = '700px';
                        }
                    });

                    // Initialize - hide SingPost loading after iframe loads (x-frame-bypass)
                    document.addEventListener('DOMContentLoaded', function() {
                        const singpostIframe = document.getElementById('singpostIframe');
                        const singpostLoading = document.getElementById('singpostLoading');

                        if (singpostIframe && singpostLoading) {
                            // x-frame-bypass may not fire normal load events, use timeout
                            setTimeout(function() {
                                singpostLoading.classList.add('hidden');
                            }, 3000);

                            // Also try to detect load event
                            singpostIframe.addEventListener('load', function() {
                                singpostLoading.classList.add('hidden');
                            });
                        }
                    });
                    </script>

                    <script>
                    // Define ticket items early for package functionality
                    if (typeof ticketAssets === 'undefined') {
                        window.ticketAssets = [
                            {% for asset in ticket.assets %}
                            {
                                id: {{ asset.id }},
                                name: "{{ asset.name }}",
                                asset_tag: "{{ asset.asset_tag or '' }}"
                            }{% if not loop.last %},{% endif %}
                            {% endfor %}
                        ];
                    }
                    
                    if (typeof ticketAccessories === 'undefined') {
                        window.ticketAccessories = [
                            {% for accessory in ticket.accessories %}
                            {
                                id: {{ accessory.id }},
                                name: "{{ accessory.name }}",
                                category: "{{ accessory.category or '' }}"
                            }{% if not loop.last %},{% endif %}
                            {% endfor %}
                        ];
                    }
                    
                    // All modal functions will be defined at the bottom of the file to avoid conflicts
                    </script>
                    
                    <!-- Single Package Tracking Section for Other Asset Checkout Categories -->
                    {% elif (ticket.category and (ticket.category.name == 'ASSET_CHECKOUT_MAIN' or 
                          ticket.category.name == 'ASSET_CHECKOUT_SINGPOST' or 
                          ticket.category.name == 'ASSET_CHECKOUT_DHL' or 
                          ticket.category.name == 'ASSET_CHECKOUT_UPS' or 
                          ticket.category.name == 'ASSET_CHECKOUT_BLUEDART' or 
                          ticket.category.name == 'ASSET_CHECKOUT_DTDC' or 
                          ticket.category.name == 'ASSET_CHECKOUT_AUTO')) or 
                          (ticket.shipping_tracking and ticket.category and ticket.category.name not in ['ASSET_RETURN_CLAW']) or 
                          (not ticket.category and ticket.has_custom_section('shipping_tracking')) %}
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <h2 class="sf-card-title flex items-center gap-2">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                        </svg>
                                        Outbound Tracking
                                    </h2>
                                    {% if ticket.shipping_status %}
                                    <span class="sf-badge {% if ticket.shipping_status == 'Delivered' %}sf-badge-success{% elif ticket.shipping_status == 'In Transit' %}sf-badge-info{% else %}sf-badge-warning{% endif %}">
                                        {{ ticket.shipping_status }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div>
                                {% if ticket.shipping_status != 'Received' %}
                                <button class="sf-button" onclick="markOutboundAsReceived('{{ ticket.id }}')">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Mark as Received
                                </button>
                                {% endif %}
                                <button id="addOutboundTrackingBtn" class="sf-button primary-button" onclick="showAddOutboundTrackingModal()">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    {% if ticket.shipping_tracking %}
                                    Edit Tracking
                                    {% else %}
                                    Add Tracking
                                    {% endif %}
                                </button>
                                </div>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="p-4">
                                {% if ticket.shipping_tracking %}
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <div class="text-sm text-gray-500">Tracking Number</div>
                                        <div class="font-medium">{{ ticket.shipping_tracking }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Carrier</div>
                                        <div class="font-medium">{{ ticket.shipping_carrier|title }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Status</div>
                                        <div class="font-medium">{{ ticket.shipping_status }}</div>
                                    </div>
                                </div>
                                <div class="mt-4 border-t pt-3">
                                    {% if not (ticket.shipping_status and 'delivered' in ticket.shipping_status.lower()) %}
                                    <button id="refreshShippingTrackingBtn" class="text-sm text-blue-600 flex items-center" onclick="fetchShippingTracking()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Refresh Tracking Information
                                    </button>
                                    {% else %}
                                    <div class="text-sm text-green-600 flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Package Delivered - No refresh needed
                                    </div>
                                    {% endif %}
                                    <div id="trackingResults" class="mt-4">
                                        <input type="hidden" id="trackingNumber" value="{{ ticket.shipping_tracking }}">
                                        <h4 class="font-medium text-gray-700 mb-2">Tracking Events:</h4>
                                        <div id="trackingEvents" class="bg-gray-50 p-3 rounded text-sm">Loading tracking data...</div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-gray-500 py-4">
                                    No outbound tracking information available
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                    <!-- Outbound Tracking Card -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <h2 class="sf-card-title flex items-center gap-2">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                        </svg>
                                        Outbound Tracking
                                    </h2>
                                    {% if ticket.shipping_status %}
                                    <span class="sf-badge {% if ticket.shipping_status == 'Delivered' %}sf-badge-success{% elif ticket.shipping_status == 'In Transit' %}sf-badge-info{% else %}sf-badge-warning{% endif %}">
                                        {{ ticket.shipping_status }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div>
                                {% if ticket.shipping_status != 'Received' %}
                                <button class="sf-button" onclick="markOutboundAsReceived('{{ ticket.id }}')">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Mark as Received
                                </button>
                                {% endif %}
                                <button id="addOutboundTrackingBtn" class="sf-button primary-button" onclick="showAddOutboundTrackingModal()">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    {% if ticket.shipping_tracking %}
                                    Edit Tracking
                                    {% else %}
                                    Add Tracking
                                    {% endif %}
                                </button>
                                </div>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="p-4">
                                {% if ticket.shipping_tracking %}
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <div class="text-sm text-gray-500">Tracking Number</div>
                                        <div class="font-medium">{{ ticket.shipping_tracking }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Carrier</div>
                                        <div class="font-medium">{{ ticket.shipping_carrier|title }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Status</div>
                                        <div class="font-medium">{{ ticket.shipping_status }}</div>
                                    </div>
                                </div>
                                <div class="mt-4 border-t pt-3">
                                    {% if not (ticket.shipping_status and 'delivered' in ticket.shipping_status.lower()) %}
                                    <button id="refreshShippingTrackingBtn" class="text-sm text-blue-600 flex items-center" onclick="fetchShippingTracking()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Refresh Tracking Information
                                    </button>
                                    {% else %}
                                    <div class="text-sm text-green-600 flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Package Delivered - No refresh needed
                                    </div>
                                    {% endif %}
                                    <div id="trackingResults" class="mt-4">
                                        <input type="hidden" id="trackingNumber" value="{{ ticket.shipping_tracking }}">
                                        <h4 class="font-medium text-gray-700 mb-2">Tracking Events:</h4>
                                        <div id="trackingEvents" class="bg-gray-50 p-3 rounded text-sm">Loading tracking data...</div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-gray-500 py-4">
                                    No outbound tracking information available
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Return Tracking Card -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <h2 class="sf-card-title flex items-center gap-2">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3"/>
                                        </svg>
                                        Return Tracking
                                    </h2>
                                    {% if ticket.return_status %}
                                    <span class="sf-badge {% if ticket.return_status == 'Delivered' %}sf-badge-success{% elif ticket.return_status == 'In Transit' %}sf-badge-info{% else %}sf-badge-warning{% endif %}">
                                        {{ ticket.return_status }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div>
                                {% if ticket.return_status != 'Received' %}
                                <button class="sf-button" onclick="markReturnAsReceived('{{ ticket.id }}')">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Mark as Received
                                </button>
                                {% endif %}
                                <button id="addReturnTrackingBtn" class="sf-button primary-button" onclick="showAddReturnTrackingModal()">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    {% if ticket.return_tracking %}
                                    Edit Tracking
                                    {% else %}
                                    Add Tracking
                                    {% endif %}
                                </button>
                                </div>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="p-4">
                                {% if ticket.return_tracking %}
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <div class="text-sm text-gray-500">Tracking Number</div>
                                        <div class="font-medium">{{ ticket.return_tracking }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Carrier</div>
                                        <div class="font-medium">{{ ticket.return_carrier|title }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Status</div>
                                        <div class="font-medium">{{ ticket.return_status }}</div>
                                    </div>
                                </div>
                                <div class="mt-4 border-t pt-3">
                                    <button id="refreshReturnTrackingBtn" class="text-sm text-blue-600 flex items-center" onclick="fetchReturnTracking()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Refresh Tracking Information
                                    </button>
                                    <div id="returnTrackingResults" class="mt-4">
                                        <input type="hidden" id="returnTrackingNumber" value="{{ ticket.return_tracking }}">
                                        <h4 class="font-medium text-gray-700 mb-2">Tracking Events:</h4>
                                        <div id="returnTrackingEvents" class="bg-gray-50 p-3 rounded text-sm">
                                            <div class="text-center">
                                                <div role="status">
                                                    <svg aria-hidden="true" class="inline w-8 h-8 text-gray-200 animate-spin fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                                                        <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                                                    </svg>
                                                    <span class="sr-only">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-sm text-gray-600">Loading tracking data...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-gray-500 py-4">
                                    No return tracking information available
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- General Tracking Section for Custom Categories -->
                    {% if (ticket.category and ticket.category.name not in ['ASSET_CHECKOUT_MAIN', 'ASSET_CHECKOUT_CLAW', 'ASSET_CHECKOUT_SINGPOST', 'ASSET_CHECKOUT_DHL', 'ASSET_CHECKOUT_UPS', 'ASSET_CHECKOUT_BLUEDART', 'ASSET_CHECKOUT_DTDC', 'ASSET_CHECKOUT_AUTO', 'ASSET_RETURN_CLAW']) or (not ticket.category and ticket.has_custom_section('shipping_tracking')) %}
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <h2 class="sf-card-title">Shipping Tracking</h2>
                                    {% if ticket.shipping_status %}
                                    <span class="sf-badge {% if ticket.shipping_status == 'Delivered' %}sf-badge-success{% elif ticket.shipping_status == 'In Transit' %}sf-badge-info{% else %}sf-badge-warning{% endif %}">
                                        {{ ticket.shipping_status }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div>
                                <button id="addGeneralTrackingBtn" class="sf-button primary-button" onclick="showAddOutboundTrackingModal()">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    {% if ticket.shipping_tracking %}
                                    Edit Tracking
                                    {% else %}
                                    Add Tracking
                                    {% endif %}
                                </button>
                                </div>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="p-4">
                                {% if ticket.shipping_tracking %}
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <div class="text-sm text-gray-500">Tracking Number</div>
                                        <div class="font-medium">{{ ticket.shipping_tracking }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Carrier</div>
                                        <div class="font-medium">{{ ticket.shipping_carrier|title if ticket.shipping_carrier else 'Auto-Detect' }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Status</div>
                                        <div class="font-medium">{{ ticket.shipping_status if ticket.shipping_status else 'Pending' }}</div>
                                    </div>
                                </div>
                                <div class="mt-4 border-t pt-3">
                                    <button id="refreshGeneralTrackingBtn" class="text-sm text-blue-600 flex items-center" onclick="fetchShippingTracking()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Refresh Tracking Information
                                    </button>
                                    <div id="generalTrackingResults" class="mt-4">
                                        <input type="hidden" id="generalTrackingNumber" value="{{ ticket.shipping_tracking }}">
                                        <h4 class="font-medium text-gray-700 mb-2">Tracking Events:</h4>
                                        <div id="generalTrackingEvents" class="bg-gray-50 p-3 rounded text-sm">Loading tracking data...</div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-gray-500 py-4">
                                    No shipping tracking information available.
                                    <br>
                                    <span class="text-sm">Click "Add Tracking" above to add shipping information for this ticket.</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Accessories Card -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <h2 class="sf-card-title">Received Accessories</h2>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="overflow-x-auto">
                                <table class="sf-data-table">
                                    <thead>
                                        <tr>
                                            <th>NAME</th>
                                            <th>CATEGORY</th>
                                            <th>QUANTITY</th>
                                            <th>CONDITION</th>
                                            <th>ACTIONS</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accessoryTableBody">
                                        {% if ticket.accessories %}
                                            {% for accessory in ticket.accessories %}
                                            <tr>
                                                <td>{{ accessory.name }}</td>
                                                <td>{{ accessory.category }}</td>
                                                <td>{{ accessory.quantity }}</td>
                                                <td>
                                                    <span class="sf-badge {% if accessory.condition == 'Good' %}sf-badge-success{% elif accessory.condition == 'Fair' %}sf-badge-warning{% else %}sf-badge-danger{% endif %}">
                                                        {{ accessory.condition }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="flex gap-2">
                                                        <button onclick="editAccessory('{{ accessory.id }}')" class="text-blue-600 hover:text-blue-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                        </button>
                                                        <button onclick="removeAccessory('{{ accessory.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-gray-500 py-4">No accessories recorded for this return</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Method 3: Direct link to form action -->
                    <div id="directAccessorySectionCheckout" style="text-align: center; margin: 20px 0; padding: 20px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid #ddd;">
                        <h3 style="margin-bottom: 15px;">Add Accessories directly</h3>
                        
                        <!-- Tab navigation for "New Accessory" and "Select Existing" -->
                        <div style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                            <button id="newAccessoryTab" onclick="switchTab('new')" style="flex: 1; padding: 10px; background-color: #e5e7eb; color: #374151; border: none; border-radius: 4px 0 0 0; cursor: pointer;">
                                Add New
                            </button>
                            <button id="existingAccessoryTab" onclick="switchTab('existing')" style="flex: 1; padding: 10px; background-color: #3b82f6; color: white; border: none; border-radius: 0 4px 0 0; cursor: pointer;">
                                Select Existing
                            </button>
                        </div>
                        
                        <!-- New Accessory Form -->
                        <form id="simpleAccessoryForm" method="POST" action="{{ url_for('tickets.add_accessory', ticket_id=ticket.id) | replace('/add_accessory', '/add-accessory') }}" style="display: none;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Accessory Name</label>
                                <input type="text" name="accessory_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
                                <select name="accessory_category" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Select Category --</option>
                                    <option value="Keyboard">Keyboard</option>
                                    <option value="Mouse">Mouse</option>
                                    <option value="Cable">Cable</option>
                                    <option value="Adapter">Adapter</option>
                                    <option value="Power Brick">Power Brick</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Manufacturer</label>
                                <input type="text" name="manufacturer" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Model Number</label>
                                <input type="text" name="model_no" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Total Quantity</label>
                                <input type="number" name="total_quantity" min="1" value="1" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Country</label>
                                <select name="country" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select a country...</option>
                                    <option value="USA">USA</option>
                                    <option value="Japan">Japan</option>
                                    <option value="Philippines">Philippines</option>
                                    <option value="Australia">Australia</option>
                                    <option value="Israel">Israel</option>
                                    <option value="India">India</option>
                                    <option value="Singapore">Singapore</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Quantity for this Ticket</label>
                                <input type="number" name="accessory_quantity" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add New Accessory
                                </button>
                            </div>
                        </form>
                        
                        <!-- Existing Accessory Selection Form -->
                        <form id="existingAccessoryForm" onsubmit="submitExistingAccessoryForm(event)" style="display: block;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Existing Accessory</label>
                                <select id="existing_accessory_select" name="existing_accessory_id" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Loading Accessories --</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Quantity</label>
                                <input id="accessory_quantity_input" type="number" name="accessory_quantity" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add Selected Accessory
                                </button>
                            </div>
                        </form>
                        
                        <!-- JavaScript for tab switching and loading accessories -->
                        <script>
                            // Store the CSRF token for JavaScript use
                            const csrfToken = '{{ csrf_token() }}';
                            console.log("CSRF token initialized:", csrfToken ? "OK" : "MISSING");
                            
                            // Function to switch between tabs
                            function switchTab(tab) {
                                console.log(`Switching to tab: ${tab}`);
                                if (tab === 'new') {
                                    document.getElementById('simpleAccessoryForm').style.display = 'block';
                                    document.getElementById('existingAccessoryForm').style.display = 'none';
                                    document.getElementById('newAccessoryTab').style.backgroundColor = '#3b82f6';
                                    document.getElementById('newAccessoryTab').style.color = 'white';
                                    document.getElementById('existingAccessoryTab').style.backgroundColor = '#e5e7eb';
                                    document.getElementById('existingAccessoryTab').style.color = '#374151';
                                } else {
                                    document.getElementById('simpleAccessoryForm').style.display = 'none';
                                    document.getElementById('existingAccessoryForm').style.display = 'block';
                                    document.getElementById('newAccessoryTab').style.backgroundColor = '#e5e7eb';
                                    document.getElementById('newAccessoryTab').style.color = '#374151';
                                    document.getElementById('existingAccessoryTab').style.backgroundColor = '#3b82f6';
                                    document.getElementById('existingAccessoryTab').style.color = 'white';
                                    
                                    // Load accessories regardless of whether they've been loaded before
                                    // This ensures accessories are always loaded when this tab is selected
                                    console.log('Loading accessories for existing tab');
                                    loadAccessories();
                                }
                            }
                            
                            // Function to load available accessories
                            function loadAccessories() {
                                console.log("LOADING ACCESSORIES: Starting fetch request...");
                                
                                // Use the correct API endpoint
                                const absoluteUrl = `${window.CURRENT_ORIGIN}/tickets/api/accessories`;
                                
                                console.log("Using URL:", absoluteUrl);
                                console.log("CSRF Token:", csrfToken);
                                
                                // Show loading state in dropdown
                                const select = document.getElementById('existing_accessory_select');
                                if (select) {
                                    select.innerHTML = '<option value="">-- Loading Accessories... --</option>';
                                    select.disabled = true;
                                }
                                
                                try {
                                    fetch(absoluteUrl, {
                                        method: 'GET',
                                        credentials: 'include',  // Include cookies for authentication
                                        headers: {
                                            'X-Requested-With': 'XMLHttpRequest',
                                            'Accept': 'application/json',
                                            'X-CSRFToken': csrfToken
                                        }
                                    })
                                    .then(response => {
                                        console.log("FETCH RESPONSE:", response.status, response.statusText);
                                        console.log("Response headers:", response.headers);
                                        
                                        if (!response.ok) {
                                            // Log the response text for debugging
                                            return response.text().then(text => {
                                                console.error("Response text:", text);
                                                throw new Error(`HTTP error! Status: ${response.status}, Response: ${text.substring(0, 200)}`);
                                            });
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        console.log("FETCH SUCCESS, data:", data);
                                        const select = document.getElementById('existing_accessory_select');
                                        if (!select) {
                                            console.error("Select element not found!");
                                            return;
                                        }
                                        
                                        // Enable the select
                                        select.disabled = false;
                                        
                                        // Clear existing options
                                        select.innerHTML = '<option value="">-- Select an Accessory --</option>';
                                        
                                        // Add accessories to dropdown
                                        if (data.success && data.accessories && data.accessories.length > 0) {
                                            // Sort accessories by name for better usability
                                            data.accessories.sort((a, b) => a.name.localeCompare(b.name));
                                            
                                            data.accessories.forEach(acc => {
                                                const option = document.createElement('option');
                                                option.value = acc.id;
                                                const displayName = `${acc.name} (${acc.category}) - Qty: ${acc.available_quantity}`;
                                                option.text = displayName;
                                                select.appendChild(option);
                                            });
                                            console.log(`Loaded ${data.accessories.length} accessories successfully`);

                                            // Initialize Select2 for searchable dropdown
                                            $(select).select2({
                                                placeholder: '-- Select an Accessory --',
                                                allowClear: true,
                                                width: '100%'
                                            });
                                        } else {
                                            // No accessories found - let's also try to call debug endpoint
                                            const option = document.createElement('option');
                                            option.value = "";
                                            option.text = "No accessories available";
                                            select.appendChild(option);
                                            console.log('No accessories found - calling debug endpoint for more info');
                                            
                                            // Call debug endpoint to get more information
                                            fetch(`${window.CURRENT_ORIGIN}/tickets/api/accessories/debug`, {
                                                method: 'GET',
                                                credentials: 'include',
                                                headers: {
                                                    'X-Requested-With': 'XMLHttpRequest',
                                                    'Accept': 'application/json',
                                                    'X-CSRFToken': csrfToken
                                                }
                                            })
                                            .then(debugResponse => debugResponse.json())
                                            .then(debugData => {
                                                console.log("DEBUG INFO:", debugData);
                                            })
                                            .catch(debugError => {
                                                console.error("Debug endpoint error:", debugError);
                                            });
                                        }
                                        
                                        window.accessoriesLoaded = true;
                                    })
                                    .catch(error => {
                                        console.error('Error loading accessories:', error);
                                        
                                        // Update the dropdown to show the error
                                        const select = document.getElementById('existing_accessory_select');
                                        if (select) {
                                            select.disabled = false;
                                            select.innerHTML = '<option value="">-- Error Loading Accessories --</option>';
                                        }
                                    });
                                } catch (error) {
                                    console.error('Critical error in fetch:', error);
                                    const select = document.getElementById('existing_accessory_select');
                                    if (select) {
                                        select.disabled = false;
                                        select.innerHTML = '<option value="">-- Error Loading Accessories --</option>';
                                    }
                                }
                            }
                            
                            // Function to handle existing accessory form submission
                            window.submitExistingAccessoryForm = function(event) {
                                event.preventDefault();
                                console.log("Form submission detected for existing accessory");
                                
                                // Get form data
                                const form = event.target;
                                const accessoryId = document.getElementById('existing_accessory_select').value;
                                // Get quantity from input
                                const quantity = parseInt(document.getElementById('accessory_quantity_input').value);
                                const condition = document.querySelector('#existingAccessoryForm select[name="accessory_condition"]').value;
                                const notes = document.querySelector('#existingAccessoryForm textarea[name="accessory_notes"]').value;
                                
                                // Validation
                                if (!accessoryId || accessoryId === "") {
                                    alert("Please select an accessory");
                                    return;
                                }
                                
                                if (isNaN(quantity) || quantity < 1) {
                                    alert("Quantity must be at least 1");
                                    return;
                                }
                                
                                console.log(`Submitting: Accessory ID=${accessoryId}, Quantity=${quantity}, Condition=${condition}`);
                                
                                // Create the data to send - matching what the server expects
                                const formData = {
                                    existing_accessory_id: accessoryId,
                                    accessory_quantity: quantity,
                                    accessory_condition: condition,
                                    accessory_notes: notes
                                };
                                
                                // Show loading indicator
                                const submitButton = form.querySelector('button[type="submit"]');
                                const originalText = submitButton.textContent;
                                submitButton.disabled = true;
                                submitButton.textContent = "Processing...";
                                
                                // Send the data via AJAX
                                fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add-accessory`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': csrfToken,
                                        'X-Requested-With': 'XMLHttpRequest'
                                    },
                                    body: JSON.stringify(formData)
                                })
                                .then(response => {
                                    console.log("Response status:", response.status);
                                    // Check if response is ok before trying to parse JSON
                                    if (response.ok) {
                                        return response.json();
                                    } else {
                                        // For error responses, just get the text
                                        return response.text().then(text => {
                                            // Try to parse JSON error response if possible
                                            try {
                                                return JSON.parse(text);
                                            } catch (e) {
                                                // If not JSON, return simple error object
                                                throw new Error(`HTTP error! Status: ${response.status}, Message: ${text || "Unknown error"}`);
                                            }
                                        });
                                    }
                                })
                                .then(data => {
                                    console.log("Form submission response:", data);
                                    if (data.success) {
                                        // Show success message
                                        alert(`Successfully added ${quantity} ${data.accessory ? data.accessory.name : 'accessory'} to the ticket`);
                                        
                                        // Clear the form
                                        form.reset();
                                        
                                        // Reload the page to show the updated accessories list
                                        window.location.reload();
                                    } else {
                                        alert("Error: " + (data.message || "Unknown error occurred"));
                                    }
                                })
                                .catch(error => {
                                    console.error("Error submitting form:", error);
                                    alert(`Error: ${error.message || "Unknown error occurred"}`);
                                })
                                .finally(() => {
                                    // Re-enable the button
                                    submitButton.disabled = false;
                                    submitButton.textContent = originalText;
                                });
                            };
                            
                            // Call loadAccessories right away on page load
                            console.log("Calling loadAccessories() immediately");
                            loadAccessories();
                            
                            // Also set up DOMContentLoaded event just in case
                            document.addEventListener('DOMContentLoaded', function() {
                                console.log("DOMContentLoaded: Calling loadAccessories() again");
                                loadAccessories();
                            });
                        </script>
                    </div>
                    
                    {% endif %}

                    <!-- Accessories Section for Asset Checkout Categories -->
                    {% if ticket.category and (ticket.category.name == 'ASSET_CHECKOUT_MAIN' or 
                          ticket.category.name == 'ASSET_CHECKOUT_CLAW' or 
                          ticket.category.name == 'ASSET_CHECKOUT_SINGPOST' or 
                          ticket.category.name == 'ASSET_CHECKOUT_DHL' or 
                          ticket.category.name == 'ASSET_CHECKOUT_UPS' or 
                          ticket.category.name == 'ASSET_CHECKOUT_BLUEDART' or 
                          ticket.category.name == 'ASSET_CHECKOUT_DTDC' or 
                          ticket.category.name == 'ASSET_CHECKOUT_AUTO') %}
                    <!-- Accessories Card for Asset Checkout -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <h2 class="sf-card-title flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                            </svg>
                            Checkout Accessories
                        </h2>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="overflow-x-auto">
                                <table class="sf-data-table">
                                    <thead>
                                        <tr>
                                            <th>NAME</th>
                                            <th>CATEGORY</th>
                                            <th>QUANTITY</th>
                                            <th>CONDITION</th>
                                            <th>ACTIONS</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accessoryTableBodyCheckout">
                                        {% if ticket.accessories %}
                                            {% for accessory in ticket.accessories %}
                                            <tr>
                                                <td>{{ accessory.name }}</td>
                                                <td>{{ accessory.category }}</td>
                                                <td>{{ accessory.quantity }}</td>
                                                <td>
                                                    <span class="sf-badge {% if accessory.condition == 'Good' %}sf-badge-success{% elif accessory.condition == 'Fair' %}sf-badge-warning{% else %}sf-badge-danger{% endif %}">
                                                        {{ accessory.condition }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="flex gap-2">
                                                        <button onclick="editAccessory('{{ accessory.id }}')" class="text-blue-600 hover:text-blue-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                        </button>
                                                        <button onclick="removeAccessory('{{ accessory.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-gray-500 py-4">No accessories recorded for this checkout</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Method 3: Direct link to form action for Asset Checkout -->
                    <div id="directAccessorySectionCheckout" style="text-align: center; margin: 20px 0; padding: 20px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid #ddd;">
                        <h3 style="margin-bottom: 15px;">Add Accessories directly</h3>
                        
                        {% if ticket.category and ticket.category.name in ['ASSET_CHECKOUT_CLAW', 'ASSET_CHECKOUT_MAIN', 'ASSET_CHECKOUT_SINGPOST', 'ASSET_CHECKOUT_DHL', 'ASSET_CHECKOUT_UPS', 'ASSET_CHECKOUT_BLUEDART', 'ASSET_CHECKOUT_DTDC', 'ASSET_CHECKOUT_AUTO'] %}
                        <div style="background-color: #fef3c7; border: 1px solid #f59e0b; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                            <p style="margin: 0; color: #92400e; font-weight: 500;">
                                ‚ö†Ô∏è Asset Checkout: Adding accessories will <strong>deduct</strong> them from inventory.
                            </p>
                        </div>
                        {% else %}
                        <div style="background-color: #d1fae5; border: 1px solid #10b981; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                            <p style="margin: 0; color: #047857; font-weight: 500;">
                                ‚úÖ Asset Return: Adding accessories will <strong>add</strong> them to inventory.
                            </p>
                        </div>
                        {% endif %}
                        
                        <!-- Tab navigation for "New Accessory" and "Select Existing" -->
                        <div style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                            <button id="newAccessoryTabCheckout" onclick="switchTabCheckout('new')" style="flex: 1; padding: 10px; background-color: #e5e7eb; color: #374151; border: none; border-radius: 4px 0 0 0; cursor: pointer;">
                                Add New
                            </button>
                            <button id="existingAccessoryTabCheckout" onclick="switchTabCheckout('existing')" style="flex: 1; padding: 10px; background-color: #3b82f6; color: white; border: none; border-radius: 0 4px 0 0; cursor: pointer;">
                                Select Existing
                            </button>
                            
                            <script>
                            // Define the checkout tab switching function
                            function switchTabCheckout(tab) {
                                console.log(`Switching to checkout tab: ${tab}`);
                                if (tab === 'new') {
                                    const newForm = document.getElementById('simpleAccessoryFormCheckout') || document.getElementById('simpleAccessoryForm');
                                    const existingForm = document.getElementById('existingAccessoryFormCheckout') || document.getElementById('existingAccessoryForm');
                                    const newTab = document.getElementById('newAccessoryTabCheckout') || document.getElementById('newAccessoryTab');
                                    const existingTab = document.getElementById('existingAccessoryTabCheckout') || document.getElementById('existingAccessoryTab');
                                    
                                    if (newForm) newForm.style.display = 'block';
                                    if (existingForm) existingForm.style.display = 'none';
                                    if (newTab) {
                                        newTab.style.backgroundColor = '#3b82f6';
                                        newTab.style.color = 'white';
                                    }
                                    if (existingTab) {
                                        existingTab.style.backgroundColor = '#e5e7eb';
                                        existingTab.style.color = '#374151';
                                    }
                                } else {
                                    const newForm = document.getElementById('simpleAccessoryFormCheckout') || document.getElementById('simpleAccessoryForm');
                                    const existingForm = document.getElementById('existingAccessoryFormCheckout') || document.getElementById('existingAccessoryForm');
                                    const newTab = document.getElementById('newAccessoryTabCheckout') || document.getElementById('newAccessoryTab');
                                    const existingTab = document.getElementById('existingAccessoryTabCheckout') || document.getElementById('existingAccessoryTab');
                                    
                                    if (newForm) newForm.style.display = 'none';
                                    if (existingForm) existingForm.style.display = 'block';
                                    if (newTab) {
                                        newTab.style.backgroundColor = '#e5e7eb';
                                        newTab.style.color = '#374151';
                                    }
                                    if (existingTab) {
                                        existingTab.style.backgroundColor = '#3b82f6';
                                        existingTab.style.color = 'white';
                                    }
                                }
                            }
                            </script>
                        </div>
                        
                        <!-- New Accessory Form -->
                        <form id="simpleAccessoryForm" method="POST" action="{{ url_for('tickets.add_accessory', ticket_id=ticket.id) | replace('/add_accessory', '/add-accessory') }}" style="display: none;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Accessory Name</label>
                                <input type="text" name="accessory_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
                                <select name="accessory_category" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Select Category --</option>
                                    <option value="Keyboard">Keyboard</option>
                                    <option value="Mouse">Mouse</option>
                                    <option value="Cable">Cable</option>
                                    <option value="Adapter">Adapter</option>
                                    <option value="Power Brick">Power Brick</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Manufacturer</label>
                                <input type="text" name="manufacturer" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Model Number</label>
                                <input type="text" name="model_no" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Total Quantity</label>
                                <input type="number" name="total_quantity" min="1" value="1" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Country</label>
                                <select name="country" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select a country...</option>
                                    <option value="USA">USA</option>
                                    <option value="Japan">Japan</option>
                                    <option value="Philippines">Philippines</option>
                                    <option value="Australia">Australia</option>
                                    <option value="Israel">Israel</option>
                                    <option value="India">India</option>
                                    <option value="Singapore">Singapore</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add New Accessory
                                </button>
                            </div>
                        </form>
                        
                        <!-- Existing Accessory Selection Form -->
                        <form id="existingAccessoryForm" onsubmit="submitExistingAccessoryForm(event)" style="display: block;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Existing Accessory</label>
                                <select id="existing_accessory_select" name="existing_accessory_id" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Loading Accessories --</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Quantity</label>
                                <input id="accessory_quantity_input" type="number" name="accessory_quantity" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add Selected Accessory
                                </button>
                            </div>
                        </form>
                        
                        <!-- JavaScript for tab switching and loading accessories -->
                        <script>
                            // Store the CSRF token for JavaScript use
                            const csrfToken = '{{ csrf_token() }}';
                            console.log("CSRF token initialized:", csrfToken ? "OK" : "MISSING");
                            
                            // Function to switch between tabs
                            function switchTab(tab) {
                                console.log(`Switching to tab: ${tab}`);
                                if (tab === 'new') {
                                    document.getElementById('simpleAccessoryForm').style.display = 'block';
                                    document.getElementById('existingAccessoryForm').style.display = 'none';
                                    document.getElementById('newAccessoryTab').style.backgroundColor = '#3b82f6';
                                    document.getElementById('newAccessoryTab').style.color = 'white';
                                    document.getElementById('existingAccessoryTab').style.backgroundColor = '#e5e7eb';
                                    document.getElementById('existingAccessoryTab').style.color = '#374151';
                                } else {
                                    document.getElementById('simpleAccessoryForm').style.display = 'none';
                                    document.getElementById('existingAccessoryForm').style.display = 'block';
                                    document.getElementById('newAccessoryTab').style.backgroundColor = '#e5e7eb';
                                    document.getElementById('newAccessoryTab').style.color = '#374151';
                                    document.getElementById('existingAccessoryTab').style.backgroundColor = '#3b82f6';
                                    document.getElementById('existingAccessoryTab').style.color = 'white';
                                    
                                    // Load accessories regardless of whether they've been loaded before
                                    // This ensures accessories are always loaded when this tab is selected
                                    console.log('Loading accessories for existing tab');
                                    loadAccessories();
                                }
                            }
                            
                            // Function to load available accessories
                            function loadAccessories() {
                                console.log("LOADING ACCESSORIES: Starting fetch request...");
                                
                                // Use the correct API endpoint
                                const absoluteUrl = `${window.CURRENT_ORIGIN}/tickets/api/accessories`;
                                
                                console.log("Using URL:", absoluteUrl);
                                console.log("CSRF Token:", csrfToken);
                                
                                // Show loading state in dropdown
                                const select = document.getElementById('existing_accessory_select');
                                if (select) {
                                    select.innerHTML = '<option value="">-- Loading Accessories... --</option>';
                                    select.disabled = true;
                                }
                                
                                try {
                                    fetch(absoluteUrl, {
                                        method: 'GET',
                                        credentials: 'include',  // Include cookies for authentication
                                        headers: {
                                            'X-Requested-With': 'XMLHttpRequest',
                                            'Accept': 'application/json',
                                            'X-CSRFToken': csrfToken
                                        }
                                    })
                                    .then(response => {
                                        console.log("FETCH RESPONSE:", response.status, response.statusText);
                                        console.log("Response headers:", response.headers);
                                        
                                        if (!response.ok) {
                                            // Log the response text for debugging
                                            return response.text().then(text => {
                                                console.error("Response text:", text);
                                                throw new Error(`HTTP error! Status: ${response.status}, Response: ${text.substring(0, 200)}`);
                                            });
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        console.log("FETCH SUCCESS, data:", data);
                                        const select = document.getElementById('existing_accessory_select');
                                        if (!select) {
                                            console.error("Select element not found!");
                                            return;
                                        }
                                        
                                        // Enable the select
                                        select.disabled = false;
                                        
                                        // Clear existing options
                                        select.innerHTML = '<option value="">-- Select an Accessory --</option>';
                                        
                                        // Add accessories to dropdown
                                        if (data.success && data.accessories && data.accessories.length > 0) {
                                            // Sort accessories by name for better usability
                                            data.accessories.sort((a, b) => a.name.localeCompare(b.name));
                                            
                                            data.accessories.forEach(acc => {
                                                const option = document.createElement('option');
                                                option.value = acc.id;
                                                const displayName = `${acc.name} (${acc.category}) - Qty: ${acc.available_quantity}`;
                                                option.text = displayName;
                                                select.appendChild(option);
                                            });
                                            console.log(`Loaded ${data.accessories.length} accessories successfully`);

                                            // Initialize Select2 for searchable dropdown
                                            $(select).select2({
                                                placeholder: '-- Select an Accessory --',
                                                allowClear: true,
                                                width: '100%'
                                            });
                                        } else {
                                            // No accessories found - let's also try to call debug endpoint
                                            const option = document.createElement('option');
                                            option.value = "";
                                            option.text = "No accessories available";
                                            select.appendChild(option);
                                            console.log('No accessories found - calling debug endpoint for more info');
                                            
                                            // Call debug endpoint to get more information
                                            fetch(`${window.CURRENT_ORIGIN}/tickets/api/accessories/debug`, {
                                                method: 'GET',
                                                credentials: 'include',
                                                headers: {
                                                    'X-Requested-With': 'XMLHttpRequest',
                                                    'Accept': 'application/json',
                                                    'X-CSRFToken': csrfToken
                                                }
                                            })
                                            .then(debugResponse => debugResponse.json())
                                            .then(debugData => {
                                                console.log("DEBUG INFO:", debugData);
                                            })
                                            .catch(debugError => {
                                                console.error("Debug endpoint error:", debugError);
                                            });
                                        }
                                        
                                        window.accessoriesLoaded = true;
                                    })
                                    .catch(error => {
                                        console.error('Error loading accessories:', error);
                                        
                                        // Update the dropdown to show the error
                                        const select = document.getElementById('existing_accessory_select');
                                        if (select) {
                                            select.disabled = false;
                                            select.innerHTML = '<option value="">-- Error Loading Accessories --</option>';
                                        }
                                    });
                                } catch (error) {
                                    console.error('Critical error in fetch:', error);
                                    const select = document.getElementById('existing_accessory_select');
                                    if (select) {
                                        select.disabled = false;
                                        select.innerHTML = '<option value="">-- Error Loading Accessories --</option>';
                                    }
                                }
                            }
                            
                            // Function to handle existing accessory form submission
                            window.submitExistingAccessoryForm = function(event) {
                                event.preventDefault();
                                console.log("Form submission detected for existing accessory");
                                
                                // Get form data
                                const form = event.target;
                                const accessoryId = document.getElementById('existing_accessory_select').value;
                                // Get quantity from input
                                const quantity = parseInt(document.getElementById('accessory_quantity_input').value);
                                const condition = document.querySelector('#existingAccessoryForm select[name="accessory_condition"]').value;
                                const notes = document.querySelector('#existingAccessoryForm textarea[name="accessory_notes"]').value;
                                
                                // Validation
                                if (!accessoryId || accessoryId === "") {
                                    alert("Please select an accessory");
                                    return;
                                }
                                
                                if (isNaN(quantity) || quantity < 1) {
                                    alert("Quantity must be at least 1");
                                    return;
                                }
                                
                                console.log(`Submitting: Accessory ID=${accessoryId}, Quantity=${quantity}, Condition=${condition}`);
                                
                                // Create the data to send - matching what the server expects
                                const formData = {
                                    existing_accessory_id: accessoryId,
                                    accessory_quantity: quantity,
                                    accessory_condition: condition,
                                    accessory_notes: notes
                                };
                                
                                // Show loading indicator
                                const submitButton = form.querySelector('button[type="submit"]');
                                const originalText = submitButton.textContent;
                                submitButton.disabled = true;
                                submitButton.textContent = "Processing...";
                                
                                // Send the data via AJAX
                                fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add-accessory`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': csrfToken,
                                        'X-Requested-With': 'XMLHttpRequest'
                                    },
                                    body: JSON.stringify(formData)
                                })
                                .then(response => {
                                    console.log("Response status:", response.status);
                                    // Check if response is ok before trying to parse JSON
                                    if (response.ok) {
                                        return response.json();
                                    } else {
                                        // For error responses, just get the text
                                        return response.text().then(text => {
                                            // Try to parse JSON error response if possible
                                            try {
                                                return JSON.parse(text);
                                            } catch (e) {
                                                // If not JSON, return simple error object
                                                throw new Error(`HTTP error! Status: ${response.status}, Message: ${text || "Unknown error"}`);
                                            }
                                        });
                                    }
                                })
                                .then(data => {
                                    console.log("Form submission response:", data);
                                    if (data.success) {
                                        // Show success message
                                        alert(`Successfully added ${quantity} ${data.accessory ? data.accessory.name : 'accessory'} to the ticket`);
                                        
                                        // Clear the form
                                        form.reset();
                                        
                                        // Reload the page to show the updated accessories list
                                        window.location.reload();
                                    } else {
                                        alert("Error: " + (data.message || "Unknown error occurred"));
                                    }
                                })
                                .catch(error => {
                                    console.error("Error submitting form:", error);
                                    alert(`Error: ${error.message || "Unknown error occurred"}`);
                                })
                                .finally(() => {
                                    // Re-enable the button
                                    submitButton.disabled = false;
                                    submitButton.textContent = originalText;
                                });
                            };
                            
                            // Call loadAccessories right away on page load
                            console.log("Calling loadAccessories() immediately");
                            loadAccessories();
                            
                            // Also set up DOMContentLoaded event just in case
                            document.addEventListener('DOMContentLoaded', function() {
                                console.log("DOMContentLoaded: Calling loadAccessories() again");
                                loadAccessories();
                            });
                        </script>
                    </div>
                    {% endif %}

                    <!-- Accessories Section for Asset Intake -->
                    {% if ticket.category and ticket.category.name == 'ASSET_INTAKE' %}
                    <!-- Accessories Card for Asset Intake -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <h2 class="sf-card-title">Received Accessories</h2>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="overflow-x-auto">
                                <table class="sf-data-table">
                                    <thead>
                                        <tr>
                                            <th>NAME</th>
                                            <th>CATEGORY</th>
                                            <th>QUANTITY</th>
                                            <th>CONDITION</th>
                                            <th>ACTIONS</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accessoryTableBody">
                                        {% if ticket.accessories %}
                                            {% for accessory in ticket.accessories %}
                                            <tr>
                                                <td>{{ accessory.name }}</td>
                                                <td>{{ accessory.category }}</td>
                                                <td>{{ accessory.quantity }}</td>
                                                <td>
                                                    <span class="sf-badge {% if accessory.condition == 'Good' %}sf-badge-success{% elif accessory.condition == 'Fair' %}sf-badge-warning{% else %}sf-badge-danger{% endif %}">
                                                        {{ accessory.condition }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="flex gap-2">
                                                        <button onclick="editAccessory('{{ accessory.id }}')" class="text-blue-600 hover:text-blue-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                        </button>
                                                        <button onclick="removeAccessory('{{ accessory.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-gray-500 py-4">No accessories recorded for this intake</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add Accessories directly for Asset Intake -->
                    <div id="directAccessorySectionIntake" style="text-align: center; margin: 20px 0; padding: 20px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid #ddd;">
                        <h3 style="margin-bottom: 15px;">Add Accessories directly</h3>
                        
                        <div style="background-color: #d1fae5; border: 1px solid #10b981; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                            <p style="margin: 0; color: #047857; font-weight: 500;">
                                üì¶ Asset Intake: Adding accessories will <strong>add</strong> them to inventory.
                            </p>
                        </div>
                        
                        <!-- Tab navigation for "New Accessory" and "Select Existing" -->
                        <div style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                            <button id="newAccessoryTab" onclick="switchTab('new')" style="flex: 1; padding: 10px; background-color: #e5e7eb; color: #374151; border: none; border-radius: 4px 0 0 0; cursor: pointer;">
                                Add New
                            </button>
                            <button id="existingAccessoryTab" onclick="switchTab('existing')" style="flex: 1; padding: 10px; background-color: #3b82f6; color: white; border: none; border-radius: 0 4px 0 0; cursor: pointer;">
                                Select Existing
                            </button>
                        </div>
                        
                        <!-- New Accessory Form -->
                        <form id="simpleAccessoryForm" onsubmit="submitNewAccessoryForm(event)" style="display: none;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Accessory Name</label>
                                <input type="text" name="accessory_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
                                <select name="accessory_category" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Select Category --</option>
                                    <option value="Keyboard">Keyboard</option>
                                    <option value="Mouse">Mouse</option>
                                    <option value="Cable">Cable</option>
                                    <option value="Adapter">Adapter</option>
                                    <option value="Power Brick">Power Brick</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Manufacturer</label>
                                <input type="text" name="manufacturer" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Model Number</label>
                                <input type="text" name="model_no" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Total Quantity</label>
                                <input type="number" name="total_quantity" min="1" value="1" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Country</label>
                                <select name="country" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select a country...</option>
                                    <option value="USA">USA</option>
                                    <option value="Japan">Japan</option>
                                    <option value="Philippines">Philippines</option>
                                    <option value="Australia">Australia</option>
                                    <option value="India">India</option>
                                    <option value="Singapore">Singapore</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add New Accessory
                                </button>
                            </div>
                        </form>
                        
                        <!-- Existing Accessory Selection Form -->
                        <form id="existingAccessoryForm" onsubmit="submitExistingAccessoryForm(event)" style="display: block;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Existing Accessory</label>
                                <select id="existing_accessory_select" name="existing_accessory_id" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Loading Accessories --</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Quantity</label>
                                <input id="accessory_quantity_input" type="number" name="accessory_quantity" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add Selected Accessory
                                </button>
                            </div>
                        </form>

                        <script>
                            // Get CSRF token from meta tag (for Asset Intake)
                            const csrfTokenIntake = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                            console.log("CSRF token for Asset Intake initialized:", csrfTokenIntake ? "OK" : "MISSING");
                            
                            // Function to switch between tabs for Asset Intake
                            function switchTab(tab) {
                                const newAccessoryTab = document.getElementById('newAccessoryTab');
                                const existingAccessoryTab = document.getElementById('existingAccessoryTab');
                                const newAccessoryForm = document.getElementById('simpleAccessoryForm');
                                const existingAccessoryForm = document.getElementById('existingAccessoryForm');

                                if (tab === 'new') {
                                    // Switch to "Add New" tab
                                    newAccessoryTab.style.backgroundColor = '#3b82f6';
                                    newAccessoryTab.style.color = 'white';
                                    existingAccessoryTab.style.backgroundColor = '#e5e7eb';
                                    existingAccessoryTab.style.color = '#374151';
                                    
                                    newAccessoryForm.style.display = 'block';
                                    existingAccessoryForm.style.display = 'none';
                                } else if (tab === 'existing') {
                                    // Switch to "Select Existing" tab
                                    existingAccessoryTab.style.backgroundColor = '#3b82f6';
                                    existingAccessoryTab.style.color = 'white';
                                    newAccessoryTab.style.backgroundColor = '#e5e7eb';
                                    newAccessoryTab.style.color = '#374151';
                                    
                                    existingAccessoryForm.style.display = 'block';
                                    newAccessoryForm.style.display = 'none';
                                }
                            }

                            // Function to load accessories for Asset Intake
                            function loadAccessories() {
                                fetch('/tickets/api/accessories')
                                    .then(response => response.json())
                                    .then(data => {
                                        const select = document.getElementById('existing_accessory_select');
                                        select.innerHTML = '<option value="">-- Select Accessory --</option>';
                                        
                                        if (data.success && data.accessories) {
                                            data.accessories.forEach(accessory => {
                                                const option = document.createElement('option');
                                                option.value = accessory.id;
                                                option.textContent = `${accessory.name} (${accessory.available_quantity} available)`;
                                                option.dataset.availableQuantity = accessory.available_quantity;
                                                select.appendChild(option);
                                            });
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error loading accessories:', error);
                                        document.getElementById('existing_accessory_select').innerHTML = '<option value="">Error loading accessories</option>';
                                    });
                            }

                            // Function to submit existing accessory form for Asset Intake
                            function submitExistingAccessoryForm(event) {
                                event.preventDefault();
                                
                                const form = event.target;
                                const accessoryId = document.getElementById('existing_accessory_select').value;
                                const quantity = parseInt(document.getElementById('accessory_quantity_input').value);
                                const condition = document.querySelector('#existingAccessoryForm select[name="accessory_condition"]').value;
                                const notes = document.querySelector('#existingAccessoryForm textarea[name="accessory_notes"]').value;
                                
                                if (!accessoryId || accessoryId === "") {
                                    alert("Please select an accessory");
                                    return;
                                }
                                
                                if (isNaN(quantity) || quantity < 1) {
                                    alert("Quantity must be at least 1");
                                    return;
                                }
                                
                                const formData = {
                                    existing_accessory_id: accessoryId,
                                    accessory_quantity: quantity,
                                    accessory_condition: condition,
                                    accessory_notes: notes
                                };
                                
                                                                 fetch(`/tickets/{{ ticket.id }}/add-accessory`, {
                                     method: 'POST',
                                     headers: {
                                         'Content-Type': 'application/json',
                                         'X-CSRFToken': csrfTokenIntake,
                                         'X-Requested-With': 'XMLHttpRequest'
                                     },
                                     body: JSON.stringify(formData)
                                 })
                                                                 .then(response => {
                                     console.log("Response status:", response.status);
                                     if (response.ok) {
                                         return response.json();
                                     } else {
                                         return response.text().then(text => {
                                             try {
                                                 return JSON.parse(text);
                                             } catch (e) {
                                                 throw new Error(`HTTP error! Status: ${response.status}, Message: ${text || "Unknown error"}`);
                                             }
                                         });
                                     }
                                 })
                                 .then(data => {
                                     console.log("Form submission response:", data);
                                     if (data.success) {
                                         alert(`Successfully added accessory to the ticket`);
                                         window.location.reload();
                                     } else {
                                         alert('Error: ' + (data.message || 'Unknown error'));
                                     }
                                 })
                                 .catch(error => {
                                     console.error('Error:', error);
                                     alert(`Error: ${error.message || "Unknown error occurred"}`);
                                 });
                            }

                            // Function to submit new accessory form for Asset Intake
                            function submitNewAccessoryForm(event) {
                                event.preventDefault();
                                
                                const form = event.target;
                                const totalQuantity = parseInt(form.total_quantity.value);
                                const formData = {
                                    accessory_name: form.accessory_name.value,
                                    accessory_category: form.accessory_category.value,
                                    manufacturer: form.manufacturer.value,
                                    model_no: form.model_no.value,
                                    total_quantity: totalQuantity,
                                    country: form.country.value,
                                    accessory_quantity: totalQuantity, // Use total_quantity as accessory_quantity
                                    accessory_condition: form.accessory_condition.value,
                                    accessory_notes: form.accessory_notes.value
                                };
                                
                                console.log("Submitting new accessory:", formData);
                                
                                fetch(`/tickets/{{ ticket.id }}/add-accessory`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': csrfTokenIntake,
                                        'X-Requested-With': 'XMLHttpRequest'
                                    },
                                    body: JSON.stringify(formData)
                                })
                                .then(response => {
                                    console.log("Response status:", response.status);
                                    if (response.ok) {
                                        return response.json();
                                    } else {
                                        return response.text().then(text => {
                                            try {
                                                return JSON.parse(text);
                                            } catch (e) {
                                                throw new Error(`HTTP error! Status: ${response.status}, Message: ${text || "Unknown error"}`);
                                            }
                                        });
                                    }
                                })
                                .then(data => {
                                    console.log("New accessory response:", data);
                                    if (data.success) {
                                        alert(`Successfully created and added ${data.accessory.name} to the ticket`);
                                        window.location.reload();
                                    } else {
                                        alert('Error: ' + (data.message || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    alert(`Error: ${error.message || "Unknown error occurred"}`);
                                });
                            }

                            // Load accessories when page loads for Asset Intake
                            document.addEventListener('DOMContentLoaded', function() {
                                loadAccessories();
                            });
                        </script>
                    </div>

                    <!-- Out of Stock Accessories Section for Asset Intake -->
                    {% if out_of_stock_accessories %}
                    <div class="sf-card mb-6" style="border: 2px solid #ef4444;">
                        <div class="sf-card-header" style="background-color: #fef2f2;">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    <h2 class="sf-card-title text-red-700">Out of Stock Accessories</h2>
                                </div>
                                <span class="bg-red-600 text-white text-sm font-medium px-3 py-1 rounded-full">{{ out_of_stock_accessories | length }}</span>
                            </div>
                            <p class="mt-1 text-sm text-red-600">These accessories need restocking. Click to add more inventory.</p>
                        </div>
                        <div class="sf-card-body">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {% for accessory in out_of_stock_accessories %}
                                <div class="border border-red-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-white">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h3 class="font-medium text-gray-900">{{ accessory.name }}</h3>
                                            <p class="text-sm text-gray-500">{{ accessory.category or 'No Category' }}</p>
                                            {% if accessory.manufacturer %}
                                            <p class="text-xs text-gray-400 mt-1">{{ accessory.manufacturer }}</p>
                                            {% endif %}
                                            {% if accessory.model_no %}
                                            <p class="text-xs text-gray-400">Model: {{ accessory.model_no }}</p>
                                            {% endif %}
                                            {% if accessory.country %}
                                            <p class="text-xs text-gray-400">Location: {{ accessory.country }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="ml-3 text-right">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                {{ accessory.available_quantity }} / {{ accessory.total_quantity }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="mt-3 pt-3 border-t border-gray-100">
                                        <a href="{{ url_for('inventory.edit_accessory', id=accessory.id) }}"
                                           class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            Add Stock
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}

                    {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                    </div>
                    {% endif %}
                </div>

                <!-- Service Records Section -->
                <div id="service-records" class="mb-8">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-600 to-purple-700 px-6 py-4">
                            <h3 class="text-lg font-semibold text-white flex items-center">
                                <i class="fas fa-tools mr-2"></i>Service Records
                            </h3>
                            <p class="text-purple-200 text-sm mt-1">Record services performed on assets in this ticket</p>
                        </div>
                        <div class="p-4">
                            <!-- Add Service Record Form -->
                            <form id="addServiceRecordForm" class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Service Type *</label>
                                        <select id="serviceType" name="service_type" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                            <option value="">Select service type...</option>
                                            <option value="OS Reinstall">OS Reinstall</option>
                                            <option value="Hardware Repair">Hardware Repair</option>
                                            <option value="Screen Replacement">Screen Replacement</option>
                                            <option value="Battery Replacement">Battery Replacement</option>
                                            <option value="Keyboard Replacement">Keyboard Replacement</option>
                                            <option value="Data Backup">Data Backup</option>
                                            <option value="Data Wipe">Data Wipe</option>
                                            <option value="Software Installation">Software Installation</option>
                                            <option value="Firmware Update">Firmware Update</option>
                                            <option value="Diagnostic Test">Diagnostic Test</option>
                                            <option value="Cleaning">Cleaning</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Asset (Optional)</label>
                                        <select id="serviceAssetId" name="asset_id"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                            <option value="">No specific asset</option>
                                            {% if ticket.assets %}
                                                {% for asset in ticket.assets %}
                                                <option value="{{ asset.id }}">{{ asset.asset_tag }} - {{ asset.serial_num or 'No Serial' }}</option>
                                                {% endfor %}
                                            {% endif %}
                                            {% if ticket.asset and ticket.asset not in ticket.assets %}
                                            <option value="{{ ticket.asset.id }}">{{ ticket.asset.asset_tag }} - {{ ticket.asset.serial_num or 'No Serial' }}</option>
                                            {% endif %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                        <select id="serviceStatus" name="status"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                            <option value="Requested" selected>Requested</option>
                                            <option value="In Progress">In Progress</option>
                                            <option value="Completed">Completed</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Description / Notes</label>
                                    <textarea id="serviceDescription" name="description" rows="2"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                        placeholder="Describe what service is needed or was performed..."></textarea>
                                </div>
                                <div class="mt-4 flex justify-end">
                                    <button type="submit"
                                        class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                                        <i class="fas fa-plus mr-2"></i>Add Service Request
                                    </button>
                                </div>
                            </form>

                            <!-- Service Records List -->
                            <div id="serviceRecordsList">
                                <div class="text-center py-8 text-gray-500" id="noServiceRecords">
                                    <i class="fas fa-clipboard-list text-4xl mb-2 text-gray-300"></i>
                                    <p>No service records yet</p>
                                    <p class="text-sm">Add a service record to track work done on assets</p>
                                </div>
                                <div class="overflow-x-auto hidden" id="serviceRecordsTable">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service Type</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested By</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="serviceRecordsBody">
                                            <!-- Records will be loaded dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    // Service Records functionality
                    document.addEventListener('DOMContentLoaded', function() {
                        loadServiceRecords();

                        document.getElementById('addServiceRecordForm').addEventListener('submit', function(e) {
                            e.preventDefault();
                            addServiceRecord();
                        });
                    });

                    function loadServiceRecords() {
                        fetch('/tickets/{{ ticket.id }}/service-records')
                            .then(response => response.json())
                            .then(data => {
                                if (data.success && data.service_records.length > 0) {
                                    document.getElementById('noServiceRecords').classList.add('hidden');
                                    document.getElementById('serviceRecordsTable').classList.remove('hidden');
                                    renderServiceRecords(data.service_records);
                                } else {
                                    document.getElementById('noServiceRecords').classList.remove('hidden');
                                    document.getElementById('serviceRecordsTable').classList.add('hidden');
                                }
                            })
                            .catch(error => {
                                console.error('Error loading service records:', error);
                            });
                    }

                    // Store records globally for modal access
                    let serviceRecordsData = [];

                    function getStatusBadgeClass(status) {
                        switch(status) {
                            case 'Requested': return 'bg-yellow-100 text-yellow-800';
                            case 'In Progress': return 'bg-blue-100 text-blue-800';
                            case 'Completed': return 'bg-green-100 text-green-800';
                            default: return 'bg-gray-100 text-gray-800';
                        }
                    }

                    function renderServiceRecords(records) {
                        serviceRecordsData = records;
                        const tbody = document.getElementById('serviceRecordsBody');
                        tbody.innerHTML = '';

                        records.forEach((record, index) => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-purple-50 cursor-pointer transition-colors';
                            row.onclick = function(e) {
                                // Don't open modal if clicking the delete button or select
                                if (e.target.closest('button') || e.target.closest('select')) return;
                                showServiceRecordModal(index);
                            };
                            const statusClass = getStatusBadgeClass(record.status);
                            row.innerHTML = `
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                        ${escapeHtml(record.service_type)}
                                    </span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                        ${escapeHtml(record.status || 'Requested')}
                                    </span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                    ${record.asset_tag ? escapeHtml(record.asset_tag) : '<span class="text-gray-400">N/A</span>'}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                    ${escapeHtml(record.requested_by_name || record.performed_by_name || 'Unknown')}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                    ${record.created_at ? formatDate(record.created_at) : 'N/A'}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <button onclick="event.stopPropagation(); deleteServiceRecord(${record.id})"
                                        class="inline-flex items-center px-2 py-1 text-xs font-medium text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash mr-1"></i> Delete
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }

                    function showServiceRecordModal(index) {
                        const record = serviceRecordsData[index];
                        if (!record) return;

                        document.getElementById('modalServiceType').textContent = record.service_type;
                        document.getElementById('modalServiceAsset').textContent = record.asset_tag || 'N/A';
                        document.getElementById('modalServiceRequestedBy').textContent = record.requested_by_name || record.performed_by_name || 'Unknown';
                        document.getElementById('modalServiceDate').textContent = record.created_at ? formatDate(record.created_at) : 'N/A';
                        document.getElementById('modalServiceDescription').textContent = record.description || 'No description provided';
                        document.getElementById('modalServiceRecordId').value = record.id;
                        document.getElementById('modalServiceStatus').value = record.status || 'Requested';

                        // Show/hide completed info
                        const completedInfo = document.getElementById('modalCompletedInfo');
                        if (record.status === 'Completed' && record.completed_by_name) {
                            document.getElementById('modalServiceCompletedBy').textContent = record.completed_by_name;
                            document.getElementById('modalServiceCompletedAt').textContent = record.completed_at ? formatDate(record.completed_at) : 'N/A';
                            completedInfo.classList.remove('hidden');
                        } else {
                            completedInfo.classList.add('hidden');
                        }

                        document.getElementById('serviceRecordModal').classList.remove('hidden');
                    }

                    function closeServiceRecordModal() {
                        document.getElementById('serviceRecordModal').classList.add('hidden');
                    }

                    function deleteFromModal() {
                        const recordId = document.getElementById('modalServiceRecordId').value;
                        closeServiceRecordModal();
                        deleteServiceRecord(recordId);
                    }

                    function updateServiceRecordStatus() {
                        const recordId = document.getElementById('modalServiceRecordId').value;
                        const newStatus = document.getElementById('modalServiceStatus').value;

                        fetch(`/tickets/{{ ticket.id }}/service-records/${recordId}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token() }}'
                            },
                            body: JSON.stringify({ status: newStatus })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                closeServiceRecordModal();
                                loadServiceRecords();
                            } else {
                                alert('Error: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            console.error('Error updating status:', error);
                            alert('Error updating status');
                        });
                    }

                    function addServiceRecord() {
                        const serviceType = document.getElementById('serviceType').value;
                        const assetId = document.getElementById('serviceAssetId').value;
                        const description = document.getElementById('serviceDescription').value;
                        const status = document.getElementById('serviceStatus').value;

                        if (!serviceType) {
                            alert('Please select a service type');
                            return;
                        }

                        fetch('/tickets/{{ ticket.id }}/service-records', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token() }}'
                            },
                            body: JSON.stringify({
                                service_type: serviceType,
                                asset_id: assetId || null,
                                description: description,
                                status: status
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Reset form
                                document.getElementById('serviceType').value = '';
                                document.getElementById('serviceAssetId').value = '';
                                document.getElementById('serviceDescription').value = '';
                                document.getElementById('serviceStatus').value = 'Requested';
                                // Reload records
                                loadServiceRecords();
                            } else {
                                alert('Error: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            console.error('Error adding service record:', error);
                            alert('Error adding service record');
                        });
                    }

                    function deleteServiceRecord(recordId) {
                        if (!confirm('Are you sure you want to delete this service record?')) {
                            return;
                        }

                        fetch(`/tickets/{{ ticket.id }}/service-records/${recordId}`, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token() }}'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                loadServiceRecords();
                            } else {
                                alert('Error: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting service record:', error);
                            alert('Error deleting service record');
                        });
                    }

                    function escapeHtml(text) {
                        if (!text) return '';
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    }

                    function formatDate(dateString) {
                        const date = new Date(dateString);
                        return date.toLocaleString('en-SG', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                </script>

                <!-- Service Record Detail Modal -->
                <div id="serviceRecordModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <!-- Background overlay -->
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeServiceRecordModal()"></div>

                        <!-- Modal panel -->
                        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                            <input type="hidden" id="modalServiceRecordId" value="">
                            <div class="bg-gradient-to-r from-purple-600 to-purple-700 px-6 py-4">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-white flex items-center">
                                        <i class="fas fa-tools mr-2"></i>Service Record Details
                                    </h3>
                                    <button onclick="closeServiceRecordModal()" class="text-white hover:text-gray-200">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-white px-6 py-4">
                                <div class="space-y-4">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 w-32 text-sm font-medium text-gray-500">Service Type:</div>
                                        <div class="flex-1">
                                            <span id="modalServiceType" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-purple-100 text-purple-800"></span>
                                        </div>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 w-32 text-sm font-medium text-gray-500">Status:</div>
                                        <div class="flex-1">
                                            <select id="modalServiceStatus" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                                <option value="Requested">Requested</option>
                                                <option value="In Progress">In Progress</option>
                                                <option value="Completed">Completed</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 w-32 text-sm font-medium text-gray-500">Asset:</div>
                                        <div id="modalServiceAsset" class="flex-1 text-sm text-gray-900"></div>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 w-32 text-sm font-medium text-gray-500">Requested By:</div>
                                        <div id="modalServiceRequestedBy" class="flex-1 text-sm text-gray-900"></div>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 w-32 text-sm font-medium text-gray-500">Requested On:</div>
                                        <div id="modalServiceDate" class="flex-1 text-sm text-gray-900"></div>
                                    </div>
                                    <div id="modalCompletedInfo" class="hidden">
                                        <div class="flex items-start">
                                            <div class="flex-shrink-0 w-32 text-sm font-medium text-gray-500">Completed By:</div>
                                            <div id="modalServiceCompletedBy" class="flex-1 text-sm text-gray-900"></div>
                                        </div>
                                        <div class="flex items-start mt-2">
                                            <div class="flex-shrink-0 w-32 text-sm font-medium text-gray-500">Completed On:</div>
                                            <div id="modalServiceCompletedAt" class="flex-1 text-sm text-gray-900"></div>
                                        </div>
                                    </div>
                                    <div class="border-t pt-4">
                                        <div class="text-sm font-medium text-gray-500 mb-2">Description:</div>
                                        <div id="modalServiceDescription" class="text-sm text-gray-900 bg-gray-50 rounded-lg p-3 whitespace-pre-wrap"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-6 py-3 flex justify-between">
                                <button onclick="deleteFromModal()" class="inline-flex items-center px-3 py-2 text-sm font-medium text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash mr-1"></i> Delete
                                </button>
                                <div class="flex gap-2">
                                    <button onclick="updateServiceRecordStatus()" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700">
                                        <i class="fas fa-save mr-1"></i> Update Status
                                    </button>
                                    <button onclick="closeServiceRecordModal()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-300">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comments - Messenger Style -->
                <div id="comments" class="mb-8">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                            <h3 class="text-lg font-semibold text-white flex items-center">
                                <i class="fas fa-comments mr-2"></i>Comments ({{ comments|length }})
                            </h3>
                        </div>

                        <!-- Comments List - Messenger Style -->
                        <div class="p-4 max-h-[600px] overflow-y-auto bg-gray-50" id="commentsContainer">
                            {% if comments %}
                                {% for comment in comments|sort(attribute='created_at') %}
                                <div class="mb-4 {% if comment.user.id == current_user.id %}flex justify-end{% else %}flex justify-start{% endif %}">
                                    <div class="{% if comment.user.id == current_user.id %}max-w-[75%]{% else %}max-w-[75%]{% endif %}">
                                        <!-- User Avatar and Name -->
                                        <div class="flex items-center mb-1 {% if comment.user.id == current_user.id %}flex-row-reverse{% endif %}">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-semibold text-sm {% if comment.user.id == current_user.id %}bg-blue-500 ml-2{% else %}bg-gray-500 mr-2{% endif %}">
                                                {{ comment.user.username[0].upper() if comment.user else 'U' }}
                                            </div>
                                            <span class="text-xs font-medium text-gray-700">
                                                {{ comment.user.username if comment.user else 'Unknown' }}
                                            </span>
                                        </div>

                                        <!-- Message Bubble -->
                                        <div class="{% if comment.user.id == current_user.id %}bg-blue-500 text-white rounded-l-2xl rounded-tr-2xl{% else %}bg-white border border-gray-200 text-gray-800 rounded-r-2xl rounded-tl-2xl{% endif %} px-4 py-3 shadow-sm">
                                            <div class="text-sm whitespace-pre-wrap break-words comment-content">{{ comment.content }}</div>
                                        </div>

                                        <!-- Timestamp -->
                                        <div class="mt-1 text-xs text-gray-500 {% if comment.user.id == current_user.id %}text-right{% endif %}">
                                            {{ comment.created_at | singapore_time | default('N/A') }}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-12">
                                    <i class="fas fa-comment-slash text-gray-300 text-5xl mb-3"></i>
                                    <p class="text-gray-500">No comments yet. Start the conversation!</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Comment Input - Fixed at Bottom -->
                        <div class="border-t border-gray-200 bg-white p-4">
                            <form method="POST" action="{{ url_for('tickets.add_comment', ticket_id=ticket.id) }}" id="commentFormMessenger">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                                <div class="flex items-end space-x-2">
                                    <!-- Textarea with @mention -->
                                    <div class="flex-1 relative">
                                        <textarea name="message"
                                                  id="commentTextarea"
                                                  required
                                                  rows="1"
                                                  class="w-full border border-gray-300 rounded-2xl px-4 py-2.5 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                                  placeholder="Write a comment... Use @ to mention users"
                                                  onkeydown="handleKeyPress(event)"
                                                  oninput="autoResize(this); checkMention(this)"></textarea>

                                        <!-- @mention Dropdown -->
                                        <div id="mentionDropdown" class="hidden absolute bg-white rounded-lg shadow-lg border border-gray-200 max-h-48 overflow-y-auto w-64 z-50">
                                            <div id="mentionList">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>

                                        <!-- Send Button -->
                                        <button type="submit"
                                                class="absolute right-2 bottom-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-8 h-8 flex items-center justify-center transition-colors">
                                            <i class="fas fa-paper-plane text-sm"></i>
                                        </button>
                                    </div>
                                </div>

                                <p class="mt-2 text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>Use <strong>@username</strong> to mention someone
                                </p>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Documents Section -->
                <h2 class="text-xl font-semibold mb-4 bg-blue-50 p-3 rounded border-l-4 border-blue-500 flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Documents
            </h2>
                <div id="documents" class="mb-8">
                    <div class="sf-card mb-6">
                        <div class="sf-card-header flex justify-between items-center">
                            <h2 class="sf-card-title flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                            </svg>
                            Attachments & Documents
                        </h2>
                        {% if ticket.attachments %}
                        {% set has_pdf = ticket.attachments|selectattr('file_type', 'equalto', 'pdf')|list|length > 0 %}
                        {% if has_pdf %}
                        <div class="flex items-center gap-2">
                            <a href="{{ url_for('tickets.extract_assets_page', ticket_id=ticket.id) }}" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-purple-700 bg-purple-100 rounded-md hover:bg-purple-200 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Extract from PDF
                            </a>
                            <a href="{{ url_for('tickets.remediate_assets_page', ticket_id=ticket.id) }}" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-amber-700 bg-amber-100 rounded-md hover:bg-amber-200 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Remediate Assets
                            </a>
                        </div>
                        {% endif %}
                        {% endif %}
                        </div>
                        <div class="sf-card-body">
                            <!-- Document Upload Form -->
                            <form method="POST" action="{{ url_for('tickets.upload_attachment', ticket_id=ticket.id) }}" enctype="multipart/form-data" class="mb-6">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="mb-3">
                                    <label for="attachments" class="block text-sm font-medium text-gray-700 mb-1">Upload Documents</label>
                                    <div class="flex flex-wrap items-center gap-3">
                                        <input type="file" id="documentUpload" name="attachments" multiple class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                                        <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            Upload Files
                                        </button>
                                    </div>
                                    <p class="mt-1 text-sm text-gray-500">
                                        Upload PDF, images, or documents related to this ticket
                                    </p>
                                </div>
                            </form>
                            
                            <!-- Documents List -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {% if ticket.attachments %}
                                    {% for attachment in ticket.attachments %}
                                    <div class="bg-gray-50 border border-gray-200 rounded-md overflow-hidden">
                                        {% if attachment.file_type in ['pdf'] %}
                                        <!-- PDF Section with Inline Viewer -->
                                        <div class="p-4 flex items-center justify-between border-b border-gray-200">
                                            <div class="flex items-center gap-2">
                                                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                                </svg>
                                                <div class="truncate">
                                                    <span class="text-sm font-medium text-gray-900">{{ attachment.filename }}</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <button
                                                    data-pdf-url="{{ url_for('tickets.get_attachment', ticket_id=ticket.id, attachment_id=attachment.id) }}"
                                                    onclick="previewPdf(this.getAttribute('data-pdf-url'))"
                                                    class="text-blue-600 hover:text-blue-800 p-1"
                                                    title="Open in modal">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                                    </svg>
                                                </button>
                                                <a href="{{ url_for('tickets.get_attachment', ticket_id=ticket.id, attachment_id=attachment.id) }}?download=true" class="text-gray-600 hover:text-gray-800 p-1" title="Download">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                    </svg>
                                                </a>
                                                <button onclick="deleteAttachment('{{ attachment.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800 p-1" title="Delete">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- Inline PDF Viewer -->
                                        <div class="p-2 bg-white">
                                            <iframe 
                                                src="{{ url_for('tickets.get_attachment', ticket_id=ticket.id, attachment_id=attachment.id) }}" 
                                                width="100%" 
                                                height="400" 
                                                style="border: 1px solid #e5e7eb; border-radius: 4px;"
                                                title="PDF Viewer for {{ attachment.filename }}">
                                                <p>Your browser does not support PDF viewing. <a href="{{ url_for('tickets.get_attachment', ticket_id=ticket.id, attachment_id=attachment.id) }}?download=true">Download the PDF</a> instead.</p>
                                            </iframe>
                                        </div>
                                        {% else %}
                                        <!-- Non-PDF Files -->
                                        <div class="p-4 flex items-center justify-between border-b border-gray-200">
                                            <div class="flex items-center gap-2">
                                                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                                </svg>
                                                <div class="truncate">
                                                    <span class="text-sm font-medium text-gray-900">{{ attachment.filename }}</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <a href="{{ url_for('tickets.get_attachment', ticket_id=ticket.id, attachment_id=attachment.id) }}" download class="text-gray-600 hover:text-gray-800 p-1">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                    </svg>
                                                </a>
                                                <button onclick="deleteAttachment('{{ attachment.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800 p-1">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        {% endif %}
                                        <div class="text-xs text-gray-500 p-2">
                                            <div>Uploaded {{ attachment.created_at | singapore_time | default('Unknown date') }}</div>
                                            <div>{{ attachment.file_size | filesizeformat if attachment.file_size else 'Unknown size' }}</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-span-full text-center text-gray-500 py-6">
                                        No documents attached to this ticket
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PDF Preview Modal -->
            <div id="pdfPreviewModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-lg w-full max-w-6xl max-h-screen overflow-hidden flex flex-col m-4">
                    <div class="p-4 bg-gray-100 flex justify-between items-center border-b border-gray-200">
                        <h3 id="previewTitle" class="text-lg font-medium text-gray-900">PDF Preview</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="openInNewTab()" class="text-gray-600 hover:text-gray-800 p-1" title="Open in new tab">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                            </button>
                            <a id="pdfDownloadBtn" href="#" download class="text-gray-600 hover:text-gray-800 p-1" title="Download PDF">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                            </a>
                            <button onclick="closePdfPreview()" class="text-gray-600 hover:text-gray-800 p-1" title="Close">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto bg-gray-100">
                        <!-- Loading indicator -->
                        <div id="pdfLoader" class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="text-gray-600">Loading PDF...</p>
                            </div>
                        </div>
                        <!-- PDF iframe -->
                        <iframe id="pdfViewer" 
                                src="" 
                                width="100%" 
                                height="800" 
                                style="border: none; display: none;"
                                onload="pdfLoaded()"
                                onerror="pdfError()">
                        </iframe>
                        <!-- Error message -->
                        <div id="pdfError" class="hidden flex items-center justify-center h-full">
                            <div class="text-center">
                                <svg class="h-12 w-12 text-red-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.876c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L3.268 16.5C2.498 18.333 3.46 20 5 20z"/>
                                </svg>
                                <p class="text-red-600 mb-2">Failed to load PDF</p>
                                <button onclick="retryPdfLoad()" class="text-blue-600 hover:text-blue-800 underline">Try again</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Asset Modal -->
            <div id="assetModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
                        <h3 class="text-lg font-medium text-gray-900">Add Tech Asset</h3>
                        <button type="button" class="text-gray-400 hover:text-gray-500" onclick="hideAssetModal()">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Modal Tabs -->
                    <div class="px-6 pt-4 border-b border-gray-200">
                        <div class="flex space-x-1">
                            <button id="selectExistingTab" onclick="switchAssetModalTab('select')" 
                                    class="asset-modal-tab px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-blue-600 text-blue-600 bg-white">
                                Select Existing Asset
                            </button>
                            <button id="createNewTab" onclick="switchAssetModalTab('create')" 
                                    class="asset-modal-tab px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Create New Asset
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Select Existing Asset Tab Content -->
                        <div id="selectExistingContent" class="asset-modal-content">
                            <div class="mb-6">
                                <h4 class="text-lg font-medium text-gray-900 mb-4">Select existing tech assets to assign to this ticket</h4>
                                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="text-sm text-blue-700 font-medium">Multiple Selection Available</span>
                                    </div>
                                    <p class="text-sm text-blue-600 mt-1">You can select multiple assets at once. Use Ctrl/Cmd+click in the table to select multiple items.</p>
                                </div>
                                
                                <!-- Selection Methods -->
                                <div class="mb-4 space-y-4">
                                    <!-- Quick Dropdown Selection -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Quick Select from Dropdown</label>
                                        <select id="assetDropdownSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                                                multiple size="6"
                                                onchange="selectAssetsFromDropdown()">
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple assets</p>
                                    </div>
                                    
                                    <!-- OR Divider -->
                                    <div class="flex items-center">
                                        <div class="flex-1 border-t border-gray-300"></div>
                                        <div class="px-4 text-sm text-gray-500 bg-white">OR</div>
                                        <div class="flex-1 border-t border-gray-300"></div>
                                    </div>
                                    
                                    <!-- Search and Filter -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Search and Filter from Table</label>
                                        <div class="flex gap-4">
                                            <div class="flex-1">
                                                <input type="text" id="assetSearchInput" placeholder="Search by asset tag, serial number, or name..." 
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                                       onkeyup="filterExistingAssets()">
                                            </div>
                                            <div class="w-48">
                                                <select id="assetStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                                        onchange="filterExistingAssets()">
                                                    <option value="">All Statuses</option>
                                                    <option value="Active">Active</option>
                                                    <option value="Deployed">Deployed</option>
                                                    <option value="Ready to Deploy">Ready to Deploy</option>
                                                    <option value="Pending">Pending</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Asset List -->
                                <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <div class="flex items-center space-x-2">
                                                        <input type="checkbox" id="selectAllAssets" 
                                                               onchange="toggleSelectAllAssets()" 
                                                               class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                                                        <span>Select All</span>
                                                    </div>
                                                </th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Tag</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial Number</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="existingAssetsTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Assets will be loaded here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="mt-4 flex justify-end gap-3">
                                    <button type="button" onclick="hideAssetModal()" 
                                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        Cancel
                                    </button>
                                    
                                    <!-- Package Selection for Asset Assignment - Removed for direct assignment -->
                                    
                                    <button type="button" id="assignSelectedAssetBtn" onclick="assignSelectedAssets()" disabled
                                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <span id="assignButtonText">Assign Selected Assets</span>
                                        <span id="assignButtonCount" class="ml-1 px-1.5 py-0.5 text-xs font-medium bg-blue-500 rounded-full hidden"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Create New Asset Tab Content -->
                        <div id="createNewContent" class="asset-modal-content hidden">
                        <form id="assetForm" class="space-y-6" method="POST" action="{{ url_for('inventory.add_asset') }}" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="intake_ticket_id" value="{{ ticket.id }}">
                            
                            <!-- Basic Information -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="asset_tag" class="block text-sm font-medium text-gray-700">Asset Tag *</label>
                                    <input type="text" id="asset_tag" name="asset_tag" required maxlength="50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="serial_num" class="block text-sm font-medium text-gray-700">Serial Number *</label>
                                    <input type="text" id="serial_num" name="serial_num" required maxlength="50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="product" class="block text-sm font-medium text-gray-700">Product</label>
                                    <input type="text" id="product" name="product" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="model" class="block text-sm font-medium text-gray-700">Model *</label>
                                    <input type="text" id="model" name="model" required list="asset-modal-model-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" onchange="handleModelChange(this)">
                                    <datalist id="asset-modal-model-list">
                                        {% for model_name in asset_modal_models %}
                                        <option value="{{ model_name }}" 
                                               data-product="{{ model_product_map[model_name] if model_product_map and model_name in model_product_map else '' }}"
                                               data-asset-type="{{ model_type_map[model_name] if model_type_map and model_name in model_type_map else '' }}">
                                        </option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div>
                                    <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                                    <select id="status" name="status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <option value="">Select a status...</option>
                                        {% for status_enum in asset_modal_statuses %}
                                        <option value="{{ status_enum.name }}">{{ status_enum.value }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label for="asset_type" class="block text-sm font-medium text-gray-700">Asset Type *</label>
                                    <input type="text" id="asset_type" name="asset_type" required list="asset-modal-type-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <datalist id="asset-modal-type-list">
                                         {% for type in asset_modal_asset_types %}
                                        <option value="{{ type }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div>
                                    <label for="receiving_date" class="block text-sm font-medium text-gray-700">Receiving Date</label>
                                    <input type="date" id="receiving_date" name="receiving_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="po" class="block text-sm font-medium text-gray-700">PO Number</label>
                                    <input type="text" id="po" name="po" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="customer" class="block text-sm font-medium text-gray-700">Customer</label>
                                     <input type="text" id="customer" name="customer" list="asset-modal-customer-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <datalist id="asset-modal-customer-list">
                                         {% for cust in asset_modal_customers %}
                                        <option value="{{ cust }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div>
                                    <label for="country" class="block text-sm font-medium text-gray-700">Country</label>
                                     <input type="text" id="country" name="country" list="asset-modal-country-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <datalist id="asset-modal-country-list">
                                         {% for c in asset_modal_countries %}
                                        <option value="{{ c }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div>
                                    <label for="erased" class="flex items-center space-x-2">
                                        <input type="checkbox" id="erased" name="erased" value="true" class="rounded border-gray-300 text-blue-600 shadow-sm">
                                        <span class="text-sm text-gray-700">Data Erased</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Hardware Information -->
                            <div class="border-t pt-4">
                                <button type="button" onclick="toggleSection('hardwareSection')" class="flex justify-between items-center w-full text-left">
                                    <h3 class="text-lg font-medium text-gray-900">Hardware Specifications</h3>
                                    <svg id="hardwareSectionIcon" class="h-5 w-5 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="hardwareSection" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                                     <div>
                                        <label for="hardware_type" class="block text-sm font-medium text-gray-700">Hardware Type</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="hardware_type" name="hardware_type" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                            <button type="button" onclick="generateHardwareType()" class="mt-1 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Generate</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="cpu_type" class="block text-sm font-medium text-gray-700">CPU Type</label>
                                        <input type="text" id="cpu_type" name="cpu_type" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="cpu_cores" class="block text-sm font-medium text-gray-700">CPU Cores</label>
                                        <input type="text" id="cpu_cores" name="cpu_cores" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="memory" class="block text-sm font-medium text-gray-700">Memory (GB)</label>
                                        <input type="text" id="memory" name="memory" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="harddrive" class="block text-sm font-medium text-gray-700">Hard Drive (GB)</label>
                                        <input type="text" id="harddrive" name="harddrive" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="gpu_cores" class="block text-sm font-medium text-gray-700">GPU Cores</label>
                                        <input type="text" id="gpu_cores" name="gpu_cores" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="keyboard" class="block text-sm font-medium text-gray-700">Keyboard</label>
                                        <input type="text" id="keyboard" name="keyboard" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="charger" class="block text-sm font-medium text-gray-700">Charger</label>
                                        <input type="text" id="charger" name="charger" list="asset-modal-charger-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <datalist id="asset-modal-charger-list">
                                            {% for chgr in asset_modal_chargers %}
                                            <option value="{{ chgr }}"></option>
                                            {% endfor %}
                                        </datalist>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Information -->
                            <div class="border-t pt-4">
                                <button type="button" onclick="toggleSection('notesSection')" class="flex justify-between items-center w-full text-left">
                                    <h3 class="text-lg font-medium text-gray-900">Additional Information</h3>
                                    <svg id="notesSectionIcon" class="h-5 w-5 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="notesSection" class="mt-4 grid grid-cols-1 gap-6 hidden">
                                     <div>
                                        <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                                        <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                                    </div>
                                    <div>
                                        <label for="tech_notes" class="block text-sm font-medium text-gray-700">Technical Notes</label>
                                        <textarea id="tech_notes" name="tech_notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                                    </div>
                                    <div>
                                        <label for="condition" class="block text-sm font-medium text-gray-700">Condition</label>
                                        <input type="text" id="condition" name="condition" list="asset-modal-condition-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <datalist id="asset-modal-condition-list">
                                            {% for cond in asset_modal_conditions %}
                                            <option value="{{ cond }}"></option>
                                            {% endfor %}
                                        </datalist>
                                    </div>
                                    <div>
                                        <label for="diag" class="block text-sm font-medium text-gray-700">Diagnostics</label>
                                        <input type="text" id="diag" name="diag" list="asset-modal-diag-list" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <datalist id="asset-modal-diag-list">
                                            {% for d in asset_modal_diags %}
                                            <option value="{{ d }}"></option>
                                            {% endfor %}
                                        </datalist>
                                    </div>
                                </div>
                            </div>

                            <div id="formFeedback" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                                <p class="text-sm font-medium mb-1">Error submitting form:</p>
                                <p class="text-sm"></p>
                                <ul class="text-sm list-disc ml-5 mt-1" id="errorDetails"></ul>
                            </div>
                        </form>
                        
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" class="px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" onclick="hideAssetModal()">
                                Cancel
                            </button>
                            <button type="button" id="assetSubmitBtn" onclick="submitAssetForm()" class="px-4 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center justify-center">
                                Add Asset
                            </button>
                        </div>
                        </div> <!-- Close createNewContent div -->
                    </div>
                </div>
            </div>

            <!-- Add Shipment Modal -->
            <div id="addShipmentModal" class="fixed inset-0 overflow-y-auto hidden z-50">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                        Add Tracking Information
                                    </h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500">
                                            Please enter the tracking number and select the carrier for this shipment.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="addShipmentForm" class="mt-4 space-y-4">
                                <div>
                                    <label for="tracking_number" class="block text-sm font-medium text-gray-700">Tracking Number</label>
                                    <input type="text" id="tracking_number" name="tracking_number" required 
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="carrier" class="block text-sm font-medium text-gray-700">Carrier</label>
                                    <select id="carrier" name="carrier" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="auto">Auto-Detect</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="submit" form="addShipmentForm" 
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                Add Shipment
                            </button>
                            <button type="button" onclick="hideAddShipmentModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Return Tracking Modal -->
            <div id="addReturnTrackingModal" class="fixed inset-0 overflow-y-auto hidden z-50">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                        {% if ticket.return_tracking %}
                                        Edit Return Tracking Information
                                        {% else %}
                                        Add Return Tracking Information
                                        {% endif %}
                                    </h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500">
                                            Please enter the return tracking number and select the carrier for this return shipment.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="addReturnTrackingForm" class="mt-4 space-y-4">
                                <div>
                                    <label for="return_tracking_number" class="block text-sm font-medium text-gray-700">Return Tracking Number</label>
                                    <input type="text" id="return_tracking_number" name="tracking_number" required 
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="Enter return tracking number">
                                </div>
                                <div>
                                    <label for="return_carrier" class="block text-sm font-medium text-gray-700">Carrier</label>
                                    <select id="return_carrier" name="return_carrier" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                        <option value="auto">Auto-Detect</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="submitReturnTrackingBtn" 
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                                {% if ticket.return_tracking %}
                                Update Return Tracking
                                {% else %}
                                Add Return Tracking
                                {% endif %}
                            </button>
                            <button type="button" onclick="hideAddReturnTrackingModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Package Modal for Asset Checkout (claw) -->
            <div id="addPackageModal" class="fixed inset-0 overflow-y-auto hidden z-50">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-purple-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="packageModalTitle">
                                        Add Package Tracking
                                    </h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500" id="packageModalDescription">
                                            Please enter the tracking number and select the carrier for this package.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="addPackageForm" class="mt-4 space-y-4">
                                <input type="hidden" id="package_number" name="package_number" value="">
                                <div>
                                    <label for="package_tracking_number" class="block text-sm font-medium text-gray-700">Tracking Number</label>
                                    <input type="text" id="package_tracking_number" name="tracking_number" required 
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label for="package_carrier" class="block text-sm font-medium text-gray-700">Carrier</label>
                                    <select id="package_carrier" name="carrier" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                                        <option value="auto">Auto-Detect</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="submitPackageBtn" 
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-purple-600 text-base font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:ml-3 sm:w-auto sm:text-sm">
                                Add Package
                            </button>
                            <button type="button" onclick="hideAddPackageModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assign Item to Package Modal -->
            <div id="assignItemToPackageModal" class="fixed inset-0 overflow-y-auto hidden z-50">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900">
                                        Assign Item to Package
                                    </h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500">
                                            Select an item from this case and assign it to a package.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="assignItemForm" class="mt-4 space-y-4">
                                <div>
                                    <label for="assign_item_type" class="block text-sm font-medium text-gray-700">Item Type</label>
                                    <select id="assign_item_type" name="item_type" required onchange="loadAssignItemOptions()"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                        <option value="">-- Select Item Type --</option>
                                        <option value="asset">Asset</option>
                                        <option value="accessory">Accessory</option>
                                    </select>
                                </div>
                                
                                <div id="assign_item_selection" style="display: none;">
                                    <label for="assign_item_id" class="block text-sm font-medium text-gray-700">Select Item</label>
                                    <select id="assign_item_id" name="item_id" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                        <option value="">-- Select Item --</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="assign_package_number" class="block text-sm font-medium text-gray-700">Package Number</label>
                                    <input type="number" id="assign_package_number" name="package_number" min="1" value="1" required
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                </div>
                                
                                <div>
                                    <label for="assign_quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                                    <input type="number" id="assign_quantity" name="quantity" min="1" value="1" required
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                </div>
                                
                                <div>
                                    <label for="assign_notes" class="block text-sm font-medium text-gray-700">Notes (Optional)</label>
                                    <textarea id="assign_notes" name="notes" rows="2"
                                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                                              placeholder="Additional notes about this assignment..."></textarea>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="submitAssignItemBtn" 
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                                Assign Item
                            </button>
                            <button type="button" onclick="hideAssignItemToPackageModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Outbound Tracking Modal -->
            <div id="addOutboundTrackingModal" class="fixed inset-0 overflow-y-auto hidden z-40">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                        {% if ticket.shipping_tracking %}
                                        Edit Outbound Tracking Information
                                        {% else %}
                                        Add Outbound Tracking Information
                                        {% endif %}
                                    </h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500">
                                            Please enter the outbound tracking number and select the carrier for this shipment.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="addOutboundTrackingForm" class="mt-4 space-y-4">
                                <div>
                                    <label for="outbound_tracking_number" class="block text-sm font-medium text-gray-700">Outbound Tracking Number</label>
                                    <input type="text" id="outbound_tracking_number" name="outbound_tracking_number" required 
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="outbound_carrier" class="block text-sm font-medium text-gray-700">Carrier</label>
                                    <select id="outbound_carrier" name="outbound_carrier" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="auto">Auto-Detect</option>
                                        <option value="hfd">HFD (Israel)</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="fedex">FedEx</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                        <option value="other">Other / Custom URL</option>
                                    </select>
                                </div>
                                <div id="customTrackingUrlDiv" style="display: none;">
                                    <label for="custom_tracking_url" class="block text-sm font-medium text-gray-700">Custom Tracking URL (optional)</label>
                                    <input type="url" id="custom_tracking_url" name="custom_tracking_url" placeholder="https://..."
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Enter full URL if your carrier is not listed</p>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="submitOutboundTrackingBtn" 
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                {% if ticket.shipping_tracking %}
                                Update Outbound Tracking
                                {% else %}
                                Add Outbound Tracking
                                {% endif %}
                            </button>
                            <button type="button" onclick="hideAddOutboundTrackingModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Item to Package Modal -->
            <div id="addItemModal" class="fixed inset-0 overflow-y-auto hidden" style="z-index: 9999;">
                <div class="flex items-center justify-center min-h-screen px-4 py-6 text-center sm:flex sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <div class="inline-block align-middle bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="itemModalTitle">
                                        Add Item to Package
                                    </h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500" id="itemModalDescription">
                                            Select an asset or accessory to add to this package.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="addItemForm" class="mt-4 space-y-4">
                                <input type="hidden" id="item_package_number" name="package_number" value="">
                                
                                <div>
                                    <label for="item_type" class="block text-sm font-medium text-gray-700">Item Type</label>
                                    <select id="item_type" name="item_type" required onchange="loadItemOptions()"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                        <option value="">-- Select Item Type --</option>
                                        <option value="asset">Asset</option>
                                        <option value="accessory">Accessory</option>
                                    </select>
                                </div>
                                
                                <div id="item_selection" style="display: none;">
                                    <label for="item_id" class="block text-sm font-medium text-gray-700">Select Item</label>
                                    <select id="item_id" name="item_id" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                        <option value="">-- Select Item --</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="item_quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                                    <input type="number" id="item_quantity" name="quantity" min="1" value="1" required
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                </div>
                                
                                <div>
                                    <label for="item_notes" class="block text-sm font-medium text-gray-700">Notes (Optional)</label>
                                    <textarea id="item_notes" name="notes" rows="2"
                                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                                              placeholder="Additional notes about this item..."></textarea>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="submitItemBtn" 
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                                Add Item
                            </button>
                            <button type="button" onclick="hideAddItemModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Replace the Add Accessory Modal with a simpler implementation -->
            <div id="simpleAccessoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10000;">
                <div style="background-color: white; width: 90%; max-width: 500px; margin: 50px auto; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                        <h3 style="font-size: 18px; font-weight: bold; margin: 0;">Add Accessory</h3>
                        <button onclick="closeSimpleModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                    </div>
                    
                    <form id="simpleAccessoryForm" method="POST" action="{{ url_for('tickets.add_accessory', ticket_id=ticket.id) | replace('/add_accessory', '/add-accessory') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Accessory Name</label>
                            <input type="text" id="simple_accessory_name" name="accessory_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
                            <select id="simple_accessory_category" name="accessory_category" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">-- Select Category --</option>
                                <option value="Keyboard">Keyboard</option>
                                <option value="Mouse">Mouse</option>
                                <option value="Cable">Cable</option>
                                <option value="Adapter">Adapter</option>
                                <option value="Power Brick">Power Brick</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Quantity</label>
                            <input type="number" id="simple_accessory_quantity" name="accessory_quantity" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                            <select id="simple_accessory_condition" name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                                <option value="Poor">Poor</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                            <textarea id="simple_accessory_notes" name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button type="button" onclick="closeSimpleModal()" style="padding: 8px 15px; background-color: #f1f1f1; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                            <button type="submit" style="padding: 8px 15px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Add Accessory</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Accessory Modal -->
            <div id="editAccessoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); width: 500px; max-width: 90vw; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold;">Edit Accessory</h3>
                    <input type="hidden" id="edit_accessory_id">
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Accessory Name</label>
                        <input type="text" id="edit_accessory_name" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Category</label>
                        <select id="edit_accessory_category" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="Keyboard">Keyboard</option>
                            <option value="Mouse">Mouse</option>
                            <option value="Monitor">Monitor</option>
                            <option value="Docking Station">Docking Station</option>
                            <option value="Cable">Cable</option>
                            <option value="Power Adapter">Power Adapter</option>
                            <option value="Headset">Headset</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Quantity</label>
                        <input type="number" id="edit_accessory_quantity" min="1" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Condition</label>
                        <select id="edit_accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="Good">Good</option>
                            <option value="Fair">Fair</option>
                            <option value="Poor">Poor</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Notes</label>
                        <textarea id="edit_accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="button" onclick="hideEditAccessoryModal()" style="margin-right: 10px; padding: 8px 16px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">
                            Cancel
                        </button>
                        <button type="button" id="updateAccessoryBtn" style="padding: 8px 16px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Update Accessory
                        </button>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>
</div>

<!-- Add the JavaScript for the asset functionality -->
<script>
// Store ticket ID for use in JavaScript
const ticketId = "{{ ticket.id }}"; // This will be rendered as the actual ticket ID

// Tech Asset Modal functions
window.showAssetModal = function() {
    console.log('showAssetModal called');
    const modal = document.getElementById('assetModal');
    if (modal) {
        console.log('Found assetModal, removing hidden class');
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden'); // Prevent scrolling
        
        // Load existing assets when modal opens (since "Select Existing Asset" tab is default)
        if (!existingAssetsLoaded) {
            loadExistingAssets();
        }
    } else {
        console.error('assetModal element not found!');
    }
};

// Confirm delete ticket function
function confirmDeleteTicket(ticketId) {
    if (confirm('Are you sure you want to permanently delete this ticket? This action cannot be undone.')) {
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Submit delete request
        fetch(`${window.CURRENT_ORIGIN}/tickets/${ticketId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Ticket deleted successfully', 'success');
                // Redirect to tickets list
                window.location.href = '/tickets';
            } else {
                showNotification(data.error || 'Failed to delete ticket', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An unexpected error occurred', 'error');
        });
    }
}

window.hideAssetModal = function() {
    console.log('hideAssetModal called');
    const modal = document.getElementById('assetModal');
    if (modal) {
        console.log('Found assetModal, adding hidden class');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden'); // Restore scrolling
        
        // Reset form
        const form = document.getElementById('assetForm');
        if (form) form.reset();
        
        // Reset feedback message
        const formFeedback = document.getElementById('formFeedback');
        if (formFeedback) formFeedback.classList.add('hidden');
        
        // Reset selected asset
        selectedAssetId = null;
        updateAssignButton();
        
        // Reset dropdown selection
        const dropdown = document.getElementById('assetDropdownSelect');
        if (dropdown) dropdown.value = '';
        
        // Clear table highlights
        clearTableHighlight();
    } else {
        console.error('assetModal element not found!');
    }
};

// Asset modal tab switching
window.switchAssetModalTab = function(tab) {
    const selectTab = document.getElementById('selectExistingTab');
    const createTab = document.getElementById('createNewTab');
    const selectContent = document.getElementById('selectExistingContent');
    const createContent = document.getElementById('createNewContent');
    
    if (tab === 'select') {
        // Switch to select existing tab
        selectTab.classList.add('border-blue-600', 'text-blue-600', 'bg-white');
        selectTab.classList.remove('border-transparent', 'text-gray-500');
        createTab.classList.add('border-transparent', 'text-gray-500');
        createTab.classList.remove('border-blue-600', 'text-blue-600', 'bg-white');
        
        selectContent.classList.remove('hidden');
        createContent.classList.add('hidden');
        
        // Load existing assets if not already loaded
        if (!existingAssetsLoaded) {
            loadExistingAssets();
        }
    } else {
        // Switch to create new tab
        createTab.classList.add('border-blue-600', 'text-blue-600', 'bg-white');
        createTab.classList.remove('border-transparent', 'text-gray-500');
        selectTab.classList.add('border-transparent', 'text-gray-500');
        selectTab.classList.remove('border-blue-600', 'text-blue-600', 'bg-white');
        
        createContent.classList.remove('hidden');
        selectContent.classList.add('hidden');
    }
};

// Asset selection variables
let existingAssetsData = [];
let existingAssetsLoaded = false;
let selectedAssetIds = [];

// Load existing assets from server
window.loadExistingAssets = function() {
    console.log('Loading existing assets...');
    fetch('/inventory/api/assets')
        .then(response => {
            console.log('Asset API response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Asset API response data:', data);
            existingAssetsData = data.assets || [];
            existingAssetsLoaded = true;
            console.log(`Loaded ${existingAssetsData.length} assets`);
            populateAssetDropdown();
            renderExistingAssets();
        })
        .catch(error => {
            console.error('Error loading assets:', error);
            alert(`Failed to load existing assets: ${error.message}`);
        });
};

// Populate the asset dropdown
window.populateAssetDropdown = function() {
    console.log('Populating asset dropdown with', existingAssetsData.length, 'assets');
    const dropdown = document.getElementById('assetDropdownSelect');
    if (!dropdown) {
        console.error('Asset dropdown element not found!');
        return;
    }
    
    // Clear existing options
    dropdown.innerHTML = '';
    
    if (existingAssetsData.length === 0) {
        console.warn('No assets available to populate dropdown');
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No assets available';
        option.disabled = true;
        dropdown.appendChild(option);
        return;
    }
    
    // Sort assets by asset_tag for easier browsing
    const sortedAssets = [...existingAssetsData].sort((a, b) => {
        const tagA = a.asset_tag || '';
        const tagB = b.asset_tag || '';
        return tagA.localeCompare(tagB);
    });
    
    // Populate dropdown with assets
    sortedAssets.forEach(asset => {
        const option = document.createElement('option');
        option.value = asset.id;
        
        // Create descriptive text for the option
        let optionText = '';
        if (asset.asset_tag) optionText += asset.asset_tag;
        if (asset.serial_num) optionText += ` | ${asset.serial_num}`;
        if (asset.name) optionText += ` | ${asset.name}`;
        if (asset.status) optionText += ` | ${asset.status}`;
        
        option.textContent = optionText || `Asset ${asset.id}`;
        option.setAttribute('data-status', asset.status || '');
        
        dropdown.appendChild(option);
    });
    
    console.log(`Populated dropdown with ${sortedAssets.length} assets`);
};

// Handle dropdown selection
window.selectAssetsFromDropdown = function() {
    const dropdown = document.getElementById('assetDropdownSelect');
    const selectedOptions = Array.from(dropdown.selectedOptions);
    const selectedAssetIds = selectedOptions.map(option => parseInt(option.value)).filter(id => !isNaN(id));
    
    // Update global selected assets array
    window.selectedAssetIds = selectedAssetIds;
    
    // Clear the table selection first
    const checkboxes = document.querySelectorAll('input[name="selectedAssets"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    
    // Highlight selected assets in the table
    selectedAssetIds.forEach(assetId => {
        highlightAssetInTable(assetId);
    });
    
    updateAssignButton();
};

// Highlight selected asset in the table
window.highlightAssetInTable = function(assetId) {
    // Find and highlight the selected asset row
    const rows = document.querySelectorAll('#existingAssetsTableBody tr');
    rows.forEach(row => {
        const checkbox = row.querySelector('input[name="selectedAssets"]');
        if (checkbox && parseInt(checkbox.value) === assetId) {
            row.classList.add('bg-blue-50', 'border-blue-200');
            checkbox.checked = true;
        }
    });
};

// Clear table highlights
window.clearTableHighlight = function() {
    const rows = document.querySelectorAll('#existingAssetsTableBody tr');
    rows.forEach(row => {
        row.classList.remove('bg-blue-50', 'border-blue-200');
    });
};

// Render assets in the table
window.renderExistingAssets = function() {
    const tbody = document.getElementById('existingAssetsTableBody');
    if (!tbody) return;
    
    let filteredAssets = filterAssets();
    
    if (filteredAssets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No assets found</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredAssets.map(asset => `
        <tr class="hover:bg-gray-50 cursor-pointer" onclick="toggleAssetSelection(${asset.id})">
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="checkbox" name="selectedAssets" value="${asset.id}" 
                       onchange="handleAssetSelectionChange(${asset.id})" 
                       class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${asset.asset_tag || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.serial_num || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${asset.name || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(asset.status)}">
                    ${asset.status || 'Unknown'}
                </span>
            </td>
        </tr>
    `).join('');
};

// Filter assets based on search and status
window.filterAssets = function() {
    const searchTerm = (document.getElementById('assetSearchInput')?.value || '').toLowerCase();
    const statusFilter = document.getElementById('assetStatusFilter')?.value || '';
    
    return existingAssetsData.filter(asset => {
        const matchesSearch = !searchTerm || 
            (asset.asset_tag && asset.asset_tag.toLowerCase().includes(searchTerm)) ||
            (asset.serial_num && asset.serial_num.toLowerCase().includes(searchTerm)) ||
            (asset.name && asset.name.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || asset.status === statusFilter;
        
        return matchesSearch && matchesStatus;
    });
};

// Handle asset selection change (for individual checkboxes)
window.handleAssetSelectionChange = function(assetId) {
    const checkbox = document.querySelector(`input[name="selectedAssets"][value="${assetId}"]`);
    if (checkbox) {
        if (checkbox.checked) {
            // Add to selected assets if not already present
            if (!selectedAssetIds.includes(assetId)) {
                selectedAssetIds.push(assetId);
            }
            // Highlight the row
            const row = checkbox.closest('tr');
            if (row) {
                row.classList.add('bg-blue-50', 'border-blue-200');
            }
        } else {
            // Remove from selected assets
            selectedAssetIds = selectedAssetIds.filter(id => id !== assetId);
            // Remove highlight
            const row = checkbox.closest('tr');
            if (row) {
                row.classList.remove('bg-blue-50', 'border-blue-200');
            }
        }
    }
    updateAssignButton();
};

// Toggle asset selection (for row clicks)
window.toggleAssetSelection = function(assetId) {
    const checkbox = document.querySelector(`input[name="selectedAssets"][value="${assetId}"]`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        handleAssetSelectionChange(assetId);
    }
};

// Toggle select all assets
window.toggleSelectAllAssets = function() {
    const selectAllCheckbox = document.getElementById('selectAllAssets');
    const assetCheckboxes = document.querySelectorAll('input[name="selectedAssets"]');
    
    if (selectAllCheckbox.checked) {
        // Select all visible assets
        selectedAssetIds = [];
        assetCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
            const assetId = parseInt(checkbox.value);
            if (!selectedAssetIds.includes(assetId)) {
                selectedAssetIds.push(assetId);
            }
            // Highlight the row
            const row = checkbox.closest('tr');
            if (row) {
                row.classList.add('bg-blue-50', 'border-blue-200');
            }
        });
    } else {
        // Deselect all assets
        selectedAssetIds = [];
        assetCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
            // Remove highlight
            const row = checkbox.closest('tr');
            if (row) {
                row.classList.remove('bg-blue-50', 'border-blue-200');
            }
        });
    }
    
    updateAssignButton();
};

// Update assign button state
window.updateAssignButton = function() {
    const button = document.getElementById('assignSelectedAssetBtn');
    const buttonText = document.getElementById('assignButtonText');
    const buttonCount = document.getElementById('assignButtonCount');
    const packageDiv = document.getElementById('packageSelectionDiv');
    
    const selectedCount = selectedAssetIds.length;
    
    if (button) {
        button.disabled = selectedCount === 0;
    }
    
    // Update button text and count
    if (buttonText && buttonCount) {
        if (selectedCount === 0) {
            buttonText.textContent = 'Assign Selected Assets';
            buttonCount.classList.add('hidden');
        } else if (selectedCount === 1) {
            buttonText.textContent = 'Assign Selected Asset';
            buttonCount.textContent = '1';
            buttonCount.classList.remove('hidden');
        } else {
            buttonText.textContent = 'Assign Selected Assets';
            buttonCount.textContent = selectedCount.toString();
            buttonCount.classList.remove('hidden');
        }
    }
    
    // Show/hide package selection for Asset Checkout (claw) tickets
    if (packageDiv && selectedCount > 0) {
        const isClawTicket = '{{ ticket.category.name if ticket.category else "" }}' === 'ASSET_CHECKOUT_CLAW';
        const hasPackages = {{ (ticket.get_all_packages()|length > 0)|lower }};
        
        if (isClawTicket && hasPackages) {
            packageDiv.classList.remove('hidden');
        } else {
            packageDiv.classList.add('hidden');
        }
    } else if (packageDiv) {
        packageDiv.classList.add('hidden');
    }
};

// Assign selected assets to ticket
window.assignSelectedAssets = function() {
    if (selectedAssetIds.length === 0) {
        alert('Please select at least one asset first.');
        return;
    }
    
    // Direct assignment without package requirement for Asset Checkout (claw) tickets
    const packageNumber = null; // No package assignment needed
    
    console.log('Assigning assets', selectedAssetIds, 'to ticket', ticketId, 'package', packageNumber);
    
    // Disable the button and show progress
    const button = document.getElementById('assignSelectedAssetBtn');
    const originalButtonText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Assigning...';
    
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Assign assets one by one
    let successCount = 0;
    let errorCount = 0;
    let errors = [];
    
    const assignPromises = selectedAssetIds.map(assetId => {
        const requestBody = {
            asset_id: assetId
        };
        
        // Direct assignment without package for Asset Checkout (claw) tickets
        
        return fetch(`/tickets/${ticketId}/assign-asset`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                successCount++;
            } else {
                errorCount++;
                errors.push(`Asset ${assetId}: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            errorCount++;
            errors.push(`Asset ${assetId}: ${error.message}`);
        });
    });
    
    // Wait for all assignments to complete
    Promise.all(assignPromises).then(() => {
        // Restore button
        button.disabled = false;
        button.innerHTML = originalButtonText;
        
        // Show results
        let message = '';
        if (successCount > 0) {
            message += `Successfully assigned ${successCount} asset(s) to the ticket!`;
        }
        
        if (errorCount > 0) {
            if (successCount > 0) message += '\n\n';
            message += `Failed to assign ${errorCount} asset(s):\n${errors.join('\n')}`;
        }
        
        alert(message);
        
        if (successCount > 0) {
            hideAssetModal();
            // Refresh the page to show the assigned assets
            location.reload();
        }
    });
};

// Filter existing assets (called on search/filter change)
window.filterExistingAssets = function() {
    // Clear dropdown selection when filtering
    const dropdown = document.getElementById('assetDropdownSelect');
    if (dropdown) {
        // Clear all selections in multiselect dropdown
        Array.from(dropdown.selectedOptions).forEach(option => {
            option.selected = false;
        });
    }
    
    // Clear selection state
    selectedAssetIds = [];
    updateAssignButton();
    
    renderExistingAssets();
};

// Get status badge CSS class
window.getStatusBadgeClass = function(status) {
    switch(status) {
        case 'Active': return 'bg-green-100 text-green-800';
        case 'Deployed': return 'bg-blue-100 text-blue-800';
        case 'Ready to Deploy': return 'bg-yellow-100 text-yellow-800';
        case 'Pending': return 'bg-gray-100 text-gray-800';
        default: return 'bg-gray-100 text-gray-800';
    }
};

function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(sectionId + 'Icon');
    
    if (section && icon) {
        if (section.classList.contains('hidden')) {
            section.classList.remove('hidden');
            icon.classList.remove('rotate-180');
            icon.classList.add('rotate-0');
        } else {
            section.classList.add('hidden');
            icon.classList.remove('rotate-0');
            icon.classList.add('rotate-180');
        }
    }
}

// Toggle Update Form Function
function toggleUpdateForm() {
    const updateForm = document.getElementById('updateForm');
    if (updateForm) {
        if (updateForm.classList.contains('hidden')) {
            updateForm.classList.remove('hidden');
        } else {
            updateForm.classList.add('hidden');
        }
    } else {
        console.error('updateForm element not found!');
    }
}

// Toggle Assign Form Function
function toggleAssignForm() {
    const assignForm = document.getElementById('assignForm');
    if (assignForm) {
        if (assignForm.classList.contains('hidden')) {
            assignForm.classList.remove('hidden');
        } else {
            assignForm.classList.add('hidden');
        }
    } else {
        console.error('assignForm element not found!');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("Initializing simple tab system");
    
    // Get all tab links
    const tabLinks = document.querySelectorAll('.sf-tab');
    
    // Add click handler to each tab link
    tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent hash navigation
            
            // Get the target tab ID
            const tabId = this.getAttribute('data-target');
            // Skip tab debugging
            
            // Hide all tabs
            document.querySelectorAll('.sf-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all links
            tabLinks.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show the selected tab
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
                console.log("Tab displayed:", tabId);
            }
            
            // Add active class to clicked link
            this.classList.add('active');
            
            // Update URL hash
            history.replaceState(null, null, '#' + tabId);
        });
    });
    
    // Initialize based on hash or default to 'details'
    let tabId = window.location.hash.substring(1) || 'details';
    const defaultTab = document.querySelector(`.sf-tab[data-target="${tabId}"]`) || 
                        document.querySelector('.sf-tab[data-target="details"]');
    
    // Simulate click on default tab
    if (defaultTab) {
        console.log("Initializing default tab:", defaultTab.getAttribute('data-target'));
        defaultTab.click();
    }
});

function generateHardwareType() {
    const product = document.getElementById('product').value;
    const assetType = document.getElementById('asset_type').value;
    const cpuType = document.getElementById('cpu_type').value;
    const cpuCores = document.getElementById('cpu_cores').value;
    const gpuCores = document.getElementById('gpu_cores').value;
    const memory = document.getElementById('memory').value;
    const harddrive = document.getElementById('harddrive').value;

    let hardwareType = '';

    // Build the hardware type string
    if (product) hardwareType += product + ' ';
    if (assetType) hardwareType += assetType + ' ';
    if (cpuType) hardwareType += cpuType + ' ';
    if (cpuCores) hardwareType += cpuCores + '-Core ';
    if (gpuCores) hardwareType += gpuCores + '-Core GPU ';
    if (memory) hardwareType += memory + 'GB RAM ';
    if (harddrive) hardwareType += harddrive + 'GB HDD';

    // Set the generated hardware type
    document.getElementById('hardware_type').value = hardwareType.trim();
}

function submitAssetForm() {
    const form = document.getElementById('assetForm');
    const formData = new FormData(form);
    const submitBtn = document.getElementById('assetSubmitBtn');
    const formFeedback = document.getElementById('formFeedback');
    
    // Clear previous error messages
    formFeedback.classList.add('hidden');
    formFeedback.querySelector('p').textContent = '';
    
    // Debug: Log complete form data 
    console.log("Form data to be submitted:");
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: '${value}'`);
    }
    
    // Additional debugging - check if form fields exist and their values
    console.log("=== FORM FIELD DEBUGGING ===");
    const fieldsToCheck = ['asset_tag', 'serial_num', 'product', 'model', 'asset_type', 'status', 'condition', 'notes', 'tech_notes', 'receiving_date', 'po', 'customer', 'country', 'hardware_type', 'cpu_type', 'cpu_cores', 'memory', 'harddrive', 'gpu_cores', 'keyboard', 'charger', 'diag'];
    
    fieldsToCheck.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (field) {
            console.log(`${fieldName}: exists, value='${field.value}', type='${field.type}', visible=${!field.closest('.hidden')}`);
        } else {
            console.log(`${fieldName}: FIELD NOT FOUND`);
        }
    });
    console.log("=== END FORM FIELD DEBUGGING ===");
    
    // Validate required fields client-side (optional but good practice)
    const requiredFields = form.querySelectorAll('[required]');
    let missingFields = [];
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('border-red-500');
            missingFields.push(field.name);
        } else {
            field.classList.remove('border-red-500');
        }
    });
    
    if (missingFields.length > 0) {
        console.log("Missing required fields (client-side validation):", missingFields);
        formFeedback.classList.remove('hidden');
        formFeedback.querySelector('p').textContent = `Please fill out these required fields: ${missingFields.join(', ')}`;
        return; // Stop submission
    }
    
    // Disable button and show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Saving...
    `;
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Make sure the ticket ID is included in the form data
    formData.append('intake_ticket_id', '{{ ticket.id }}');
    
    // Prepare JSON payload with debugging - send ALL form fields using direct DOM access
    const jsonPayload = {
        asset_tag: document.getElementById('asset_tag')?.value || '',
        serial_number: document.getElementById('serial_num')?.value || '',
        name: document.getElementById('product')?.value || '',
        model: document.getElementById('model')?.value || '',
        category: document.getElementById('asset_type')?.value || '',
        condition: document.getElementById('condition')?.value || 'Good',
        status: document.getElementById('status')?.value || 'IN_STOCK',
        notes: document.getElementById('notes')?.value || '',
        tech_notes: document.getElementById('tech_notes')?.value || '',
        type: document.getElementById('asset_type')?.value || '',
        asset_type: document.getElementById('asset_type')?.value || '',
        receiving_date: document.getElementById('receiving_date')?.value || '',
        po: document.getElementById('po')?.value || '',
        customer: document.getElementById('customer')?.value || '',
        country: document.getElementById('country')?.value || '',
        erased: document.getElementById('erased')?.checked ? 'COMPLETED' : '',
        hardware_type: document.getElementById('hardware_type')?.value || '',
        cpu_type: document.getElementById('cpu_type')?.value || '',
        cpu_cores: document.getElementById('cpu_cores')?.value || '',
        memory: document.getElementById('memory')?.value || '',
        harddrive: document.getElementById('harddrive')?.value || '',
        gpu_cores: document.getElementById('gpu_cores')?.value || '',
        keyboard: document.getElementById('keyboard')?.value || '',
        charger: document.getElementById('charger')?.value || '',
        diag: document.getElementById('diag')?.value || '',
        ticket_id: '{{ ticket.id }}'
    };
    
    console.log(`[FRONTEND DEBUG ${new Date().toISOString()}] Sending payload:`, jsonPayload);
    
    // Get the URL
    const targetUrl = '{{ url_for("assets.add_asset") }}';
    console.log("[FRONTEND DEBUG] Target URL:", targetUrl);
    
    // Submit the form using fetch API
    fetch(targetUrl, {
        method: 'POST',
        body: JSON.stringify(jsonPayload),
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        console.log("Server response status:", response.status);
        // Always try to parse response as JSON for more detailed error info
        return response.json().then(data => {
            // Add status to data object for error handling
            return { ...data, status: response.status };
        }).catch(err => {
            // If JSON parsing fails, return text with status
            return response.text().then(text => {
                return { error: `Failed to parse response: ${text}`, status: response.status };
            });
        });
    })
    .then(data => {
        console.log("Full server response:", data);
        console.log("[FRONTEND DEBUG] Response status:", data.status);
        console.log("[FRONTEND DEBUG] Response success:", data.success);
        console.log("[FRONTEND DEBUG] Response error:", data.error);
        
        if (data.success) {
            console.log("Asset added successfully:", data.asset);
            
            // Add the new asset to the table
            const tableBody = document.querySelector('#assetTableBody');
            if (!tableBody) {
                console.error("Asset table body not found");
                return;
            }
            
            // If this is the first asset, clear the "No assets" message
            if (tableBody.querySelector('tr td[colspan="5"]')) {
                tableBody.innerHTML = '';
            }
            
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-asset-id', data.asset.id);
            
            // Build asset name with model if available
            let assetName = data.asset.name || '-';
            if (data.asset.model && data.asset.name !== data.asset.model) {
                assetName = `${data.asset.name || ''} ${data.asset.model || ''}`.trim() || '-';
            } else if (data.asset.model && !data.asset.name) {
                assetName = data.asset.model;
            }
            
            newRow.innerHTML = `
                <td>${data.asset.asset_tag || '-'}</td>
                <td>${data.asset.serial_number || data.asset.serial_num || '-'}</td>
                <td>${assetName}</td>
                <td>
                    <span class="sf-badge sf-badge-success">
                        ${data.asset.status || 'Active'}
                    </span>
                </td>
                <td>
                    <div class="flex gap-2">
                        <button onclick="viewAsset('${data.asset.id}')" class="text-blue-600 hover:text-blue-800" title="View Asset">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                        <button onclick="unlinkAsset('${data.asset.id}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800" title="Remove Asset">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(newRow);
            
            // Close the modal and reset the form
            hideAssetModal();
            form.reset();
            
            // Show success notification
            showNotification('Asset added successfully!', 'success');
        } else {
            console.error("Server reported error:", data);
            
            // Check if this is a duplicate asset error
            if (data.error && (data.error.includes('UNIQUE constraint failed') || 
                              data.error.includes('Asset tag already exists') || 
                              data.error.includes('Serial number already exists'))) {
                formFeedback.classList.remove('hidden');
                formFeedback.querySelector('p').textContent = data.error; // Show the actual error message
            } else {
                // Show general error message
                console.log("[FRONTEND DEBUG] Error case - showing error message:", data.error);
                formFeedback.classList.remove('hidden');
                formFeedback.querySelector('p').textContent = `[FRONTEND] ${data.error || 'Failed to add asset. Please try again.'}`;
                
                // Display detailed error information if available
                const errorDetails = document.getElementById('errorDetails');
                if (errorDetails) {
                    errorDetails.innerHTML = ''; // Clear existing error details
                    
                    if (data.missing_fields && Array.isArray(data.missing_fields)) {
                        data.missing_fields.forEach(field => {
                            const li = document.createElement('li');
                            li.textContent = field;
                            errorDetails.appendChild(li);
                        });
                    }
                }
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        formFeedback.classList.remove('hidden');
        formFeedback.querySelector('p').textContent = error.message || 'An unexpected error occurred. Please try again.';
    })
    .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Add Asset';
    });
}

function viewAsset(assetId) {
    window.location.href = `/assets/${assetId}`;
}

function unlinkAsset(assetId, ticketId) {
    if (confirm('Are you sure you want to unlink this asset from the ticket?')) {
        fetch(`${window.CURRENT_ORIGIN}/assets/${assetId}/unlink/${ticketId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message and reload page
                showNotification('Asset unlinked successfully', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                showNotification(data.error || 'Failed to unlink asset', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An unexpected error occurred', 'error');
        });
    }
}

function showNotification(message, type = 'success') {
    // Use notification div instead of alert
    const notification = document.getElementById('notification');
    if (notification) {
        // Create notification content
        notification.innerHTML = `
            <div class="bg-${type === 'success' ? 'green' : 'red'}-100 border-l-4 border-${type === 'success' ? 'green' : 'red'}-500 text-${type === 'success' ? 'green' : 'red'}-700 p-4 rounded shadow-md">
                <p>${message}</p>
            </div>
        `;
        
        // Show notification
        notification.classList.remove('hidden');
        
        // Hide notification after 3 seconds
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 3000);
    } else {
        // Fallback to alert if notification div is not found
        alert(message);
    }
}

function handleModelChange(input) {
    const productInput = document.getElementById('product');
    const assetTypeInput = document.getElementById('asset_type');
    const modelList = document.getElementById('asset-modal-model-list');
    const options = modelList.options;
    
    console.log("Model changed to: " + input.value);
    
    // Find if the current input value matches any existing model
    let matchingOption = null;
    for (let i = 0; i < options.length; i++) {
        if (options[i].value === input.value) {
            matchingOption = options[i];
            break;
        }
    }
    
    if (matchingOption) {
        // If it's an existing model, set the product and asset type
        const product = matchingOption.getAttribute('data-product');
        const assetType = matchingOption.getAttribute('data-asset-type');
        
        console.log("Found matching model with product: " + product + ", asset type: " + assetType);
        
        if (product) {
            productInput.value = product;
        }
        
        if (assetType) {
            assetTypeInput.value = assetType;
        }
    }
}

// PDF preview functionality
window.previewPdf = function(url) {
    // Show the modal and reset state
    document.getElementById('pdfPreviewModal').classList.remove('hidden');
    document.getElementById('pdfLoader').style.display = 'flex';
    document.getElementById('pdfViewer').style.display = 'none';
    document.getElementById('pdfError').classList.add('hidden');
    
    // Store the URL for retry functionality
    window.currentPdfUrl = url;
    
    // Set the iframe source to start loading
    const iframe = document.getElementById('pdfViewer');
    iframe.src = url;
    
    // Update download button
    document.getElementById('pdfDownloadBtn').href = url + '?download=true';
    
    // Set a timeout to show error if PDF doesn't load
    setTimeout(() => {
        if (document.getElementById('pdfLoader').style.display !== 'none') {
            pdfError();
        }
    }, 15000); // 15 second timeout
};

window.closePdfPreview = function() {
    document.getElementById('pdfPreviewModal').classList.add('hidden');
    // Clear the iframe source when closing to stop PDF rendering
    document.getElementById('pdfViewer').src = '';
    window.currentPdfUrl = null;
};

window.pdfLoaded = function() {
    // Hide loader and show PDF
    document.getElementById('pdfLoader').style.display = 'none';
    document.getElementById('pdfViewer').style.display = 'block';
    document.getElementById('pdfError').classList.add('hidden');
};

window.pdfError = function() {
    // Hide loader and PDF, show error
    document.getElementById('pdfLoader').style.display = 'none';
    document.getElementById('pdfViewer').style.display = 'none';
    document.getElementById('pdfError').classList.remove('hidden');
};

window.retryPdfLoad = function() {
    if (window.currentPdfUrl) {
        // Reset and try again
        document.getElementById('pdfLoader').style.display = 'flex';
        document.getElementById('pdfError').classList.add('hidden');
        document.getElementById('pdfViewer').src = window.currentPdfUrl;
    }
};

window.openInNewTab = function() {
    if (window.currentPdfUrl) {
        window.open(window.currentPdfUrl, '_blank');
    }
};

function deleteAttachment(attachmentId, ticketId) {
    if (confirm('Are you sure you want to delete this document?')) {
        fetch(`${window.CURRENT_ORIGIN}/tickets/${ticketId}/attachment/${attachmentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add a parameter to prevent infinite refreshes
                const separator = window.location.href.includes('?') ? '&' : '?';
                window.location.href = window.location.href + separator + 'refreshed=true';
            } else {
                alert('Error deleting document: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting document');
        });
    }
}

// Tracking Modal Functions
function showAddOutboundTrackingModal() {
    // First, hide any other modals that might be open
    hideAddItemModal();
    hideAddReturnTrackingModal();
    
    const modal = document.getElementById('addOutboundTrackingModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function hideAddOutboundTrackingModal() {
    const modal = document.getElementById('addOutboundTrackingModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function showAddReturnTrackingModal() {
    const modal = document.getElementById('addReturnTrackingModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function hideAddReturnTrackingModal() {
    const modal = document.getElementById('addReturnTrackingModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Initialize tracking form submissions
document.addEventListener('DOMContentLoaded', function() {
    // Initialize global variables that might be used elsewhere
    window.showLoading = function() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.classList.remove('hidden');
        }
    };
    
    window.hideLoading = function() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.classList.add('hidden');
        }
    };
    
    // Outbound carrier dropdown - show/hide custom URL field
    const outboundCarrierSelect = document.getElementById('outbound_carrier');
    if (outboundCarrierSelect) {
        outboundCarrierSelect.addEventListener('change', function() {
            const customUrlDiv = document.getElementById('customTrackingUrlDiv');
            if (customUrlDiv) {
                customUrlDiv.style.display = this.value === 'other' ? 'block' : 'none';
            }
        });
    }

    // Outbound tracking form submission
    const outboundTrackingBtn = document.getElementById('submitOutboundTrackingBtn');
    if (outboundTrackingBtn) {
        outboundTrackingBtn.addEventListener('click', function() {
            const trackingNumber = document.getElementById('outbound_tracking_number').value;
            const carrier = document.getElementById('outbound_carrier').value;
            const customUrlField = document.getElementById('custom_tracking_url');
            const customUrl = customUrlField ? customUrlField.value : '';

            if (!trackingNumber) {
                alert('Please enter a tracking number');
                return;
            }

            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            // Submit form data with direct origin URL
            fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add_outbound_tracking`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    tracking_number: trackingNumber,
                    carrier: carrier,
                    custom_tracking_url: customUrl
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideAddOutboundTrackingModal();
                    showNotification('Outbound tracking added successfully', 'success');
                    // Reload page to show new tracking info
                    window.location.reload();
                } else {
                    showNotification(data.error || 'Failed to add tracking information', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An unexpected error occurred', 'error');
            });
        });
    }
    
    // Return tracking form submission
    const returnTrackingBtn = document.getElementById('submitReturnTrackingBtn');
    if (returnTrackingBtn) {
        returnTrackingBtn.addEventListener('click', function() {
            const trackingNumber = document.getElementById('return_tracking_number').value;
            const carrier = document.getElementById('return_carrier').value;
            
            if (!trackingNumber) {
                alert('Please enter a tracking number');
                return;
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Show a loading indication
            returnTrackingBtn.textContent = "{{ 'true' if ticket.return_tracking else 'false' }}" === "true" ? 'Updating...' : 'Saving...';
            returnTrackingBtn.disabled = true;
            
            // Submit form data with direct origin URL
            fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add_return_tracking`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    tracking_number: trackingNumber,
                    carrier: carrier
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Reset button state based on whether we're adding or updating
                const hasExistingTracking = "{{ 'true' if ticket.return_tracking else 'false' }}" === "true";
                returnTrackingBtn.textContent = hasExistingTracking ? 'Update Return Tracking' : 'Add Return Tracking';
                returnTrackingBtn.disabled = false;
                
                if (data.success) {
                    hideAddReturnTrackingModal();
                    const actionText = hasExistingTracking ? 'updated' : 'added';
                    showNotification(`Return tracking ${actionText} successfully`, 'success');
                    // Reload page to show new tracking info
                    window.location.reload();
                } else {
                    showNotification(data.message || 'Failed to add tracking information', 'error');
                }
            })
            .catch(error => {
                // Reset button state based on whether we're adding or updating
                const hasExistingTracking = "{{ 'true' if ticket.return_tracking else 'false' }}" === "true";
                returnTrackingBtn.textContent = hasExistingTracking ? 'Update Return Tracking' : 'Add Return Tracking';
                returnTrackingBtn.disabled = false;
                
                console.error('Error:', error);
                showNotification('An unexpected error occurred', 'error');
            });
        });
    }
    
    // Accessory form submission
    const submitAccessoryBtn = document.getElementById('submitAccessoryBtn');
    console.log('Submit accessory button element:', submitAccessoryBtn);
    if (submitAccessoryBtn) {
        submitAccessoryBtn.addEventListener('click', function() {
            console.log('Submit accessory button clicked');
            const name = document.getElementById('accessory_name').value;
            const category = document.getElementById('accessory_category').value;
            const quantity = document.getElementById('accessory_quantity').value;
            const condition = document.getElementById('accessory_condition').value;
            const notes = document.getElementById('accessory_notes').value;
            
            console.log('Form values:', { name, category, quantity, condition, notes });
            
            if (!name) {
                alert('Please enter an accessory name');
                return;
            }
            
            if (!category) {
                alert('Please select a category');
                return;
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            console.log('CSRF token found:', !!csrfToken);
            
            // Submit form data with dynamic base URL
            console.log('Submitting form data to endpoint:', `${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add-accessory`);
            fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add-accessory`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    name: name,
                    category: category,
                    quantity: quantity,
                    condition: condition,
                    notes: notes
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    hideAddAccessoryModal();
                    showNotification('Accessory added successfully', 'success');
                    // Reload page to show new accessory
                    window.location.reload();
                } else {
                    showNotification(data.error || 'Failed to add accessory', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An unexpected error occurred', 'error');
            });
        });
    } else {
        // Silently ignore if button is not found
    }
    
    // Update accessory form submission
    const updateAccessoryBtn = document.getElementById('updateAccessoryBtn');
    if (updateAccessoryBtn) {
        updateAccessoryBtn.addEventListener('click', function() {
            const accessoryId = document.getElementById('edit_accessory_id').value;
            const name = document.getElementById('edit_accessory_name').value;
            const category = document.getElementById('edit_accessory_category').value;
            // Get quantity from input
            const quantity = document.getElementById('edit_accessory_quantity').value;
            const condition = document.getElementById('edit_accessory_condition').value;
            const notes = document.getElementById('edit_accessory_notes').value;
            
            if (!name) {
                alert('Please enter an accessory name');
                return;
            }
            
            if (!category) {
                alert('Please select a category');
                return;
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Submit form data with dynamic base URL
            fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/accessory/${accessoryId}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    name: name,
                    category: category,
                    quantity: quantity,
                    condition: condition,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideEditAccessoryModal();
                    showNotification('Accessory updated successfully', 'success');
                    // Reload page to show updated accessory
                    window.location.reload();
                } else {
                    showNotification(data.error || 'Failed to update accessory', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An unexpected error occurred', 'error');
            });
        });
    }
});

// Mark tracking as received functions
function markOutboundAsReceived(ticketId) {
    if (confirm('Are you sure you want to mark this package as received?')) {
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Submit status update with direct origin URL
        fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/update-shipping-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                status: 'Received'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Package marked as received', 'success');
                // Reload page to show updated status
                window.location.reload();
            } else {
                showNotification(data.error || 'Failed to update status', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An unexpected error occurred', 'error');
        });
    }
}

function markReturnAsReceived(ticketId) {
    if (confirm('Are you sure you want to mark this return package as received?')) {
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Submit status update with direct origin URL
        fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/update-return-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                status: 'Received'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Return package marked as received', 'success');
                // Reload page to show updated status
                window.location.reload();
            } else {
                showNotification(data.error || 'Failed to update status', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An unexpected error occurred', 'error');
        });
    }
}

// Accessory Modal Functions
function showAddAccessoryModal() {
    const modal = document.getElementById('addAccessoryModal');
    if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
}

function hideAddAccessoryModal() {
    const modal = document.getElementById('addAccessoryModal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
}

function showEditAccessoryModal() {
    const modal = document.getElementById('editAccessoryModal');
    if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
}

function hideEditAccessoryModal() {
    console.log('Hiding edit accessory modal...');
    const modal = document.getElementById('editAccessoryModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        console.log('Modal hidden successfully');
    } else {
        console.error('Modal not found when trying to hide');
    }
}

// New function for dynamic modal update
function updateAccessoryDynamic(accessoryId) {
    console.log('Updating accessory via dynamic modal:', accessoryId);
    
    // Get values from dynamic modal
    const name = document.getElementById('dynamic_edit_accessory_name').value;
    const category = document.getElementById('dynamic_edit_accessory_category').value;
    const quantity = parseInt(document.getElementById('dynamic_edit_accessory_quantity').value);
    const condition = document.getElementById('dynamic_edit_accessory_condition').value;
    const notes = document.getElementById('dynamic_edit_accessory_notes').value;
    
    // Get CSRF token
    const updateCsrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Submit update request
    fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/accessory/${accessoryId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': updateCsrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            name: name,
            category: category,
            quantity: quantity,
            condition: condition,
            notes: notes,
            csrf_token: updateCsrfToken
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            document.getElementById('dynamicEditModal').remove();
            document.body.style.overflow = '';
            
            // Show success and reload
            alert('Accessory updated successfully!');
            window.location.reload();
        } else {
            alert('Error updating accessory: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error updating accessory:', error);
        alert('Error updating accessory. Please try again.');
    });
}

let isEditingAccessory = false;

function editAccessory(accessoryId) {
    console.log('=== EDIT ACCESSORY DEBUG START ===');
    console.log('Accessory ID:', accessoryId);
    console.log('isEditingAccessory:', isEditingAccessory);
    
    if (isEditingAccessory) {
        console.log('Already editing an accessory, ignoring request');
        return;
    }
    
    console.log('Setting isEditingAccessory to true');
    isEditingAccessory = true;
    
    // First, let's check if the modal exists
    const modal = document.getElementById('editAccessoryModal');
    console.log('Modal element found:', modal !== null);
    if (!modal) {
        console.error('CRITICAL: editAccessoryModal element not found in DOM!');
        alert('Error: Edit modal not found. Please refresh the page.');
        isEditingAccessory = false;
        return;
    }
    
    // Get accessory data with dynamic base URL
    const fetchUrl = `${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/accessory/${accessoryId}`;
    console.log('Fetching from URL:', fetchUrl);
    
    fetch(fetchUrl, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Fetch response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Accessory data received:', data);
        if (data.success) {
            const accessory = data.accessory;
            console.log('Accessory details:', accessory);
            
            // Check if form fields exist before populating
            const fields = {
                'edit_accessory_id': accessory.id,
                'edit_accessory_name': accessory.name,
                'edit_accessory_category': accessory.category,
                'edit_accessory_quantity': accessory.quantity,
                'edit_accessory_condition': accessory.condition,
                'edit_accessory_notes': accessory.notes || ''
            };
            
            console.log('Populating form fields...');
            for (const [fieldId, value] of Object.entries(fields)) {
                const field = document.getElementById(fieldId);
                console.log(`Field ${fieldId}:`, field !== null, 'Value:', value);
                if (field) {
                    field.value = value;
                } else {
                    console.error(`Field ${fieldId} not found!`);
                }
            }
            
            // Show modal - Use dynamic creation to bypass CSS conflicts
            console.log('Attempting to show modal...');
            
            // Remove existing modal if it exists
            const existingModal = document.getElementById('dynamicEditModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal dynamically
            const dynamicModal = document.createElement('div');
            dynamicModal.id = 'dynamicEditModal';
            dynamicModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 999999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); width: 500px; max-width: 90vw; max-height: 90vh; overflow-y: auto;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold;">Edit Accessory</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Accessory Name</label>
                            <input type="text" id="dynamic_edit_accessory_name" value="${accessory.name}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Category</label>
                            <select id="dynamic_edit_accessory_category" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="Keyboard" ${accessory.category === 'Keyboard' ? 'selected' : ''}>Keyboard</option>
                                <option value="Mouse" ${accessory.category === 'Mouse' ? 'selected' : ''}>Mouse</option>
                                <option value="Monitor" ${accessory.category === 'Monitor' ? 'selected' : ''}>Monitor</option>
                                <option value="Docking Station" ${accessory.category === 'Docking Station' ? 'selected' : ''}>Docking Station</option>
                                <option value="Cable" ${accessory.category === 'Cable' ? 'selected' : ''}>Cable</option>
                                <option value="Power Adapter" ${accessory.category === 'Power Adapter' ? 'selected' : ''}>Power Adapter</option>
                                <option value="Headset" ${accessory.category === 'Headset' ? 'selected' : ''}>Headset</option>
                                <option value="Other" ${accessory.category === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Quantity</label>
                            <input type="number" id="dynamic_edit_accessory_quantity" value="${accessory.quantity}" min="1" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Condition</label>
                            <select id="dynamic_edit_accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="Good" ${accessory.condition === 'Good' ? 'selected' : ''}>Good</option>
                                <option value="Fair" ${accessory.condition === 'Fair' ? 'selected' : ''}>Fair</option>
                                <option value="Poor" ${accessory.condition === 'Poor' ? 'selected' : ''}>Poor</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Notes</label>
                            <textarea id="dynamic_edit_accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;">${accessory.notes || ''}</textarea>
                        </div>
                        
                        <div style="text-align: right;">
                            <button onclick="document.getElementById('dynamicEditModal').remove(); document.body.style.overflow = '';" style="margin-right: 10px; padding: 8px 16px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="updateAccessoryDynamic(${accessoryId})" style="padding: 8px 16px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Update Accessory
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add to body
            document.body.appendChild(dynamicModal);
            document.body.style.overflow = 'hidden';
            
            console.log('Dynamic modal created and should be visible');
        } else {
            console.error('API returned error:', data.message);
            showNotification(data.message || 'Failed to get accessory data', 'error');
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        showNotification('An unexpected error occurred: ' + error.message, 'error');
    })
    .finally(() => {
        console.log('Setting isEditingAccessory back to false');
        isEditingAccessory = false;
        console.log('=== EDIT ACCESSORY DEBUG END ===');
    });
}

function removeAccessory(accessoryId, ticketId) {
    if (confirm('Are you sure you want to remove this accessory?')) {
        // Get CSRF token
        const removeCsrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Submit remove request with dynamic base URL
        fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/accessory/${accessoryId}/remove`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': removeCsrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                csrf_token: removeCsrfToken
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Accessory removed successfully', 'success');
                // Reload page to update UI
                window.location.reload();
            } else {
                showNotification(data.message || 'Failed to remove accessory', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An unexpected error occurred', 'error');
        });
    }
}

// Add event listener for update accessory button
document.addEventListener('DOMContentLoaded', function() {
    const updateBtn = document.getElementById('updateAccessoryBtn');
    if (updateBtn) {
        updateBtn.addEventListener('click', function() {
            const accessoryId = document.getElementById('edit_accessory_id').value;
            const name = document.getElementById('edit_accessory_name').value;
            const category = document.getElementById('edit_accessory_category').value;
            const quantity = document.getElementById('edit_accessory_quantity').value;
            const condition = document.getElementById('edit_accessory_condition').value;
            const notes = document.getElementById('edit_accessory_notes').value;
            
            // Validate required fields
            if (!name || !category || !quantity) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Get CSRF token
            const updateCsrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Submit update request
            fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/accessory/${accessoryId}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': updateCsrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    name: name,
                    category: category,
                    quantity: parseInt(quantity),
                    condition: condition,
                    notes: notes,
                    csrf_token: updateCsrfToken
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Accessory updated successfully', 'success');
                    hideEditAccessoryModal();
                    // Reload page to update UI
                    window.location.reload();
                } else {
                    showNotification(data.message || 'Failed to update accessory', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An unexpected error occurred', 'error');
            });
        });
    }
});
</script>

<script>
// Helper function to safely parse and format dates
function formatTrackingDate(dateString) {
    if (!dateString) return 'Unknown Date';
    
    try {
        // Try to parse the date string
        var dateObj = new Date(dateString);
        
        // Check if we got a valid date
        if (!isNaN(dateObj.getTime())) {
            // Format as readable date and time immediately
            var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                             'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            var year = dateObj.getFullYear();
            var month = monthNames[dateObj.getMonth()];
            var day = dateObj.getDate();
            var hours = dateObj.getHours();
            var minutes = dateObj.getMinutes();
            
            // Add leading zeros to time
            hours = (hours < 10 ? '0' : '') + hours;
            minutes = (minutes < 10 ? '0' : '') + minutes;
            
            return month + ' ' + day + ', ' + year + ' ' + hours + ':' + minutes;
        } else {
            console.log('Failed to parse date:', dateString);
            // Return the original string if parsing failed
            return dateString;
        }
    } catch (e) {
        console.error('Error parsing date:', e);
        return dateString;
    }
}

// Function to fetch shipping tracking information from cache (no force refresh)
function fetchShippingTrackingFromCache() {
    var trackingResults = document.getElementById('trackingResults');
    var trackingEvents = document.getElementById('trackingEvents');
    
    // First, determine the correct URL to use
    // Get the current location without any query parameters
    var baseUrl = window.location.protocol + '//' + window.location.host;
    var apiUrl = baseUrl + '/tickets/{{ ticket.id }}/track_auto';
    console.log('Fetching cached tracking info from:', apiUrl);
    
    // Call the tracking API with cached data
    fetch(apiUrl)
        .then(function(response) {
            if (!response.ok) {
                throw new Error('HTTP error! Status: ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            if (data.success && data.tracking_info && data.tracking_info.length > 0) {
                // Sort events by date (newest first)
                var sortedEvents = data.tracking_info.slice().sort(function(a, b) {
                    var dateA = new Date(a.date);
                    var dateB = new Date(b.date);
                    return dateB - dateA; // Newest first
                });
                
                // Format tracking events
                var eventsHtml = '';
                sortedEvents.forEach(function(event, index) {
                    var date = formatTrackingDate(event.date);
                    var status = event.status || 'Status unavailable';
                    var location = event.location || 'Location unavailable';
                    
                    // Highlight latest event with green border
                    var borderClass = index === 0 ? 'border-green-400 bg-green-50' : 'border-gray-200';
                    var statusClass = index === 0 ? 'font-bold text-green-800' : 'font-medium';
                    
                    eventsHtml += '<div class="mb-2 pb-2 border ' + borderClass + ' rounded p-2">' +
                        '<div class="' + statusClass + '">' + status + '</div>' +
                        '<div class="text-gray-600 text-xs flex justify-between">' +
                        '<span>' + location + '</span>' +
                        '<span>' + date + '</span>' +
                        '</div>' +
                        '</div>';
                });
                trackingEvents.innerHTML = eventsHtml;
            } else {
                trackingEvents.innerHTML = 
                    '<div class="text-gray-500 p-2">' +
                    'No tracking information available at this time. Click "Refresh Tracking Information" to check for updates.' +
                    '</div>';
            }
        })
        .catch(function(error) {
            console.error('Error fetching tracking data:', error);
            trackingEvents.innerHTML = 
                '<div class="text-red-500 p-2">' +
                'Error fetching tracking data: ' + error.message +
                '</div>';
        });
}

// Function to fetch shipping tracking information from firecrawl with force refresh
function fetchShippingTracking() {
    var trackingBtn = document.getElementById('refreshShippingTrackingBtn');
    var trackingResults = document.getElementById('trackingResults');
    var trackingEvents = document.getElementById('trackingEvents');
    
    // Show loading state
    trackingBtn.disabled = true;
    trackingBtn.innerHTML = 
        '<svg class="w-4 h-4 mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
        '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>' +
        '<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>' +
        '</svg>' +
        'Loading tracking data...';
    
    // First, determine the correct URL to use
    // Get the current location without any query parameters
    var baseUrl = window.location.protocol + '//' + window.location.host;
    
    // Determine the correct endpoint based on ticket category
    var category = '{{ ticket.category.name if ticket.category else "" }}';
    var apiUrl;
    
    if (category === 'ASSET_CHECKOUT_CLAW') {
        apiUrl = baseUrl + '/tickets/category/checkout_claw/{{ ticket.id }}/track?force_refresh=true';
    } else if (category === 'ASSET_RETURN_CLAW') {
        apiUrl = baseUrl + '/tickets/{{ ticket.id }}/track_auto?force_refresh=true';
    } else {
        // Default for other asset checkout categories
        apiUrl = baseUrl + '/tickets/category/checkout_main/{{ ticket.id }}/track?force_refresh=true';
    }
    
    console.log('Fetching tracking info with force refresh from:', apiUrl);
    
    // Call the tracking API
    fetch(apiUrl)
        .then(function(response) {
            if (!response.ok) {
                throw new Error('HTTP error! Status: ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            // Display tracking data
            trackingResults.classList.remove('hidden');
            
            // Update current status in the UI if possible (ADDED STATUS UPDATE)
            try {
                var statusElement = document.querySelector('.sf-badge');
                if (statusElement && data.shipping_status) {
                    statusElement.textContent = data.shipping_status;
                    console.log('Updated outbound status to:', data.shipping_status);
                }
                
                // Also try to update the status in the grid display
                var gridStatusElement = document.querySelector('[class*="grid"] [class*="Status"] .font-medium, [class*="grid"] [class*="status"] .font-medium');
                if (gridStatusElement && data.shipping_status) {
                    gridStatusElement.textContent = data.shipping_status;
                    console.log('Updated grid status to:', data.shipping_status);
                }
            } catch(statusUpdateError) {
                console.warn('Could not update status display:', statusUpdateError);
            }
            
            if (data.success && data.tracking_info && data.tracking_info.length > 0) {
                // Format tracking events
                var eventsHtml = '';
                data.tracking_info.forEach(function(event) {
                    var date = formatTrackingDate(event.date);
                    var status = event.status || 'Status unavailable';
                    var location = event.location || 'Location unavailable';
                    eventsHtml += '<div class="mb-2 pb-2 border-b border-gray-200">' +
                        '<div class="font-medium">' + status + '</div>' +
                        '<div class="text-gray-600 text-xs flex justify-between">' +
                        '<span>' + location + '</span>' +
                        '<span>' + date + '</span>' +
                        '</div>' +
                        '</div>';
                });
                trackingEvents.innerHTML = eventsHtml;
            } else {
                var debugInfo = data.debug_info ? '<div class="text-xs mt-1">Debug: ' + JSON.stringify(data.debug_info) + '</div>' : '';
                trackingEvents.innerHTML = 
                    '<div class="text-gray-500 p-2">' +
                    'No tracking information available at this time. ' + 
                    debugInfo +
                    '</div>';
            }
        })
        .catch(function(error) {
            console.error('Error fetching tracking data:', error);
            trackingResults.classList.remove('hidden');
            trackingEvents.innerHTML = 
                '<div class="text-red-500 p-2">' +
                'Error fetching tracking data: ' + error.message +
                '</div>';
        })
        .finally(function() {
            // Reset button
            trackingBtn.disabled = false;
            trackingBtn.innerHTML = 
                '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                '</svg>' +
                'Refresh Tracking Information';
        });
}

    // Function to fetch return tracking information from cache (no force refresh)
function fetchReturnTrackingFromCache() {
    var trackingResults = document.getElementById('returnTrackingResults');
    var trackingEvents = document.getElementById('returnTrackingEvents');
    
    // First, determine the correct URL to use
    // Get the current location without any query parameters
    var baseUrl = window.location.protocol + '//' + window.location.host;
    var apiUrl = baseUrl + '/tickets/{{ ticket.id }}/track_return';
    console.log('Fetching cached return tracking info from:', apiUrl);
    
    // Call the tracking API with cached data
    fetch(apiUrl)
        .then(function(response) {
            if (!response.ok) {
                throw new Error('HTTP error! Status: ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            // Log data for debugging but don't display it in UI
            console.log('Return tracking data (cached):', data);
            
            if (data.success && data.tracking_info && data.tracking_info.length > 0) {
                // Sort events by date (newest first)
                var sortedEvents = data.tracking_info.slice().sort(function(a, b) {
                    var dateA = new Date(a.date);
                    var dateB = new Date(b.date);
                    return dateB - dateA; // Newest first
                });
                
                // Format tracking events
                var eventsHtml = '';
                sortedEvents.forEach(function(event, index) {
                    var date = formatTrackingDate(event.date);
                    var status = event.status || 'Status unavailable';
                    var location = event.location || 'Location unavailable';
                    
                    // Highlight latest event with green border
                    var borderClass = index === 0 ? 'border-green-400 bg-green-50' : 'border-gray-200';
                    var statusClass = index === 0 ? 'font-bold text-green-800' : 'font-medium';
                    
                    eventsHtml += '<div class="mb-2 pb-2 border ' + borderClass + ' rounded p-2">' +
                        '<div class="' + statusClass + '">' + status + '</div>' +
                        '<div class="text-gray-600 text-xs flex justify-between">' +
                        '<span>' + location + '</span>' +
                        '<span>' + date + '</span>' +
                        '</div>' +
                        '</div>';
                });
                
                // Show formatted tracking events
                trackingEvents.innerHTML = 
                    '<div class="mb-4">' +
                    '<h5 class="font-bold text-gray-800 mb-2">Tracking Events:</h5>' +
                    eventsHtml +
                    '</div>';
            } else {
                trackingEvents.innerHTML = 
                    '<div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-2 rounded mb-3">' +
                    'No return tracking information available at this time. Click "Refresh Tracking Information" to check for updates.' +
                    '</div>';
            }
        })
        .catch(function(error) {
            console.error('Error fetching return tracking data:', error);
            trackingEvents.innerHTML = 
                '<div class="bg-red-100 border border-red-400 text-red-700 p-2 rounded mb-3">' +
                'Error fetching tracking data: ' + error.message +
                '</div>';
        });
}

// Function to fetch return tracking information with force refresh
function fetchReturnTracking() {
    console.log('fetchReturnTracking called - starting refresh process');
    var trackingBtn = document.getElementById('refreshReturnTrackingBtn');
    var trackingResults = document.getElementById('returnTrackingResults');
    var trackingEvents = document.getElementById('returnTrackingEvents');
    
    // Immediately update UI to show loading is in progress
    if (trackingEvents) {
        trackingEvents.innerHTML = 
            '<div class="text-center p-4">' +
            '<svg aria-hidden="true" class="inline w-8 h-8 text-gray-200 animate-spin fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">' +
            '<path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>' +
            '<path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>' +
            '</svg>' +
            '<p class="mt-2">Loading tracking data...</p>' +
            '</div>';
    }
    
    // Show loading state on button if it exists
    if (trackingBtn) {
        trackingBtn.disabled = true;
        trackingBtn.innerHTML = 
            '<svg class="w-4 h-4 mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>' +
            '<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>' +
            '</svg>' +
            'Loading tracking data...';
    }
    
    // First, determine the correct URL to use
    var baseUrl = window.location.protocol + '//' + window.location.host;
    var apiUrl = baseUrl + '/tickets/{{ ticket.id }}/track_return?force_refresh=true&t=' + new Date().getTime();
    console.log('Fetching return tracking info with force refresh from:', apiUrl);
    
    // Set a timeout in case the request takes too long
    var timeoutId = setTimeout(function() {
        console.log('Request timeout - showing fallback data');
        if (trackingEvents) {
            trackingEvents.innerHTML = 
                '<div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-2 rounded mb-3">' +
                'Request timed out. The server may be busy. Please try again.' +
                '<button onclick="fetchReturnTracking()" class="ml-2 text-blue-600 underline">Retry</button>' +
                '</div>';
        }
        if (trackingBtn) {
            trackingBtn.disabled = false;
            trackingBtn.innerHTML = 
                '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                '</svg>' +
                'Refresh Tracking Information';
        }
    }, 15000); // 15 second timeout
    
    // Call the tracking API with a fresh AJAX request
    var xhr = new XMLHttpRequest();
    xhr.open('GET', apiUrl, true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            clearTimeout(timeoutId); // Clear the timeout since we got a response
            
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    console.log('XHR data received:', data);
                    
                    if (trackingResults) {
                        trackingResults.classList.remove('hidden');
                    }
                    
                    // Update current status in the UI if possible
                    try {
                        var statusElement = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-3.gap-4 div:nth-child(3) .font-medium');
                        if (statusElement) {
                            var latestStatus = data.status || 
                                              (data.ticket_data && data.ticket_data.return_status) || 
                                              (data.tracking_info && data.tracking_info.length > 0 ? data.tracking_info[0].status : null) || 
                                              'Pending';
                            
                            statusElement.textContent = latestStatus;
                            
                            // Update carrier if available
                            if (data.ticket_data) {
                                var carrierElement = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-3.gap-4 div:nth-child(2) .font-medium');
                                if (carrierElement && data.ticket_data.return_carrier) {
                                    var carrier = data.ticket_data.return_carrier.charAt(0).toUpperCase() + data.ticket_data.return_carrier.slice(1);
                                    carrierElement.textContent = carrier;
                                }
                            }
                        }
                    } catch(e) {
                        console.error('Error updating status display:', e);
                    }
                    
                    // Update tracking events display
                    if (trackingEvents) {
                        if (data.success && data.tracking_info && data.tracking_info.length > 0) {
                            // Sort events by date (newest first)
                            var sortedEvents = data.tracking_info.slice().sort(function(a, b) {
                                var dateA = new Date(a.date);
                                var dateB = new Date(b.date);
                                return dateB - dateA; // Newest first
                            });
                            
                            // Format tracking events
                            var eventsHtml = '';
                            sortedEvents.forEach(function(event, index) {
                                var date = formatTrackingDate(event.date);
                                var status = event.status || 'Status unavailable';
                                var location = event.location || 'Location unavailable';
                                
                                // Highlight latest event with green border
                                var borderClass = index === 0 ? 'border-green-400 bg-green-50' : 'border-gray-200';
                                var statusClass = index === 0 ? 'font-bold text-green-800' : 'font-medium';
                                
                                eventsHtml += '<div class="mb-2 pb-2 border ' + borderClass + ' rounded p-2">' +
                                    '<div class="' + statusClass + '">' + status + '</div>' +
                                    '<div class="text-gray-600 text-xs flex justify-between">' +
                                    '<span>' + location + '</span>' +
                                    '<span>' + date + '</span>' +
                                    '</div>' +
                                    '</div>';
                            });
                            
                            trackingEvents.innerHTML = 
                                '<div class="mb-4">' +
                                '<h5 class="font-bold text-gray-800 mb-2">Tracking Events:</h5>' +
                                eventsHtml +
                                '</div>';
                        } else {
                            trackingEvents.innerHTML = 
                                '<div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-2 rounded mb-3">' +
                                'No return tracking information available at this time.' +
                                '</div>';
                        }
                    }
                } catch (parseError) {
                    console.error('Error parsing JSON response:', parseError);
                    if (trackingEvents) {
                        trackingEvents.innerHTML = 
                            '<div class="bg-red-100 border border-red-400 text-red-700 p-2 rounded mb-3">' +
                            'Error processing tracking data. Please try again.' +
                            '</div>';
                    }
                }
            } else {
                console.error('XHR Error:', xhr.status, xhr.statusText);
                if (trackingEvents) {
                    trackingEvents.innerHTML = 
                        '<div class="bg-red-100 border border-red-400 text-red-700 p-2 rounded mb-3">' +
                        'Error fetching tracking data: ' + xhr.status + ' ' + xhr.statusText +
                        '</div>';
                }
            }
            
            // Reset button state
            if (trackingBtn) {
                trackingBtn.disabled = false;
                trackingBtn.innerHTML = 
                    '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                    '</svg>' +
                    'Refresh Tracking Information';
            }
        }
    };
    
    xhr.onerror = function() {
        clearTimeout(timeoutId);
        console.error('XHR Network Error');
        if (trackingEvents) {
            trackingEvents.innerHTML = 
                '<div class="bg-red-100 border border-red-400 text-red-700 p-2 rounded mb-3">' +
                'Network error fetching tracking data. Please check your connection and try again.' +
                '</div>';
        }
        if (trackingBtn) {
            trackingBtn.disabled = false;
            trackingBtn.innerHTML = 
                '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                '</svg>' +
                'Refresh Tracking Information';
        }
    };
    
    xhr.send();
}
</script>

<!-- Simple tab system - Added at the end of the page -->
<script>
// Simple modal functions
function openSimpleModal() {
    document.getElementById('simpleAccessoryModal').style.display = 'block';
    console.log('Simple modal opened');
}

function closeSimpleModal() {
    document.getElementById('simpleAccessoryModal').style.display = 'none';
    console.log('Simple modal closed');
}

// Wait for the DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Auto-load shipping tracking data on page load if tracking number exists
    if (document.getElementById('trackingResults')) {
        // Check if we have a tracking number based on ticket data
        var hasShippingTracking = "{{ 'true' if ticket.shipping_tracking else 'false' }}" === "true";
        if (hasShippingTracking) {
            console.log('Loading shipping tracking data automatically');
            // Load tracking data automatically with a small delay to ensure page is fully loaded
            setTimeout(function() {
                // Call the tracking function but without force refresh to use cached data
                fetchShippingTrackingFromCache();
            }, 300);
        }
    }
    
    // Auto-load return tracking data on page load if tracking number exists
    if (document.getElementById('returnTrackingResults')) {
        // Check if we have a return tracking number based on ticket data
        var hasReturnTracking = "{{ 'true' if ticket.return_tracking else 'false' }}" === "true";
        if (hasReturnTracking) {
            console.log('Loading return tracking data automatically from cache');
            // Load tracking data automatically with a small delay to ensure page is fully loaded
            setTimeout(function() {
                // Call the tracking function WITHOUT force refresh to use cached data first
                fetchReturnTrackingFromCache();
            }, 500);
        }
    }
    
    // Debug modal existence
    console.log('Checking modal existence...');
    const simpleModal = document.getElementById('simpleAccessoryModal');
    console.log('Simple modal exists:', !!simpleModal);
    if (simpleModal) {
        console.log('Modal element found with ID simpleAccessoryModal');
    } else {
        console.error('Modal element NOT found with ID simpleAccessoryModal');
        // Try to find all elements that might be the modal
        const allDivs = document.querySelectorAll('div');
        console.log('Total divs:', allDivs.length);
        const possibleModals = Array.from(allDivs).filter(div => 
            div.id && div.id.toLowerCase().includes('modal'));
        console.log('Possible modal divs:', possibleModals.map(m => m.id));
    }
    
    // Fix accessory modal issue once and for all
    const addAccessoryModal = document.getElementById('addAccessoryModal');
    
    // Find the Add Accessory button more reliably
    let addAccessoryBtn = null;
    const buttons = document.querySelectorAll('button.sf-button.primary-button');
    buttons.forEach(button => {
        if (button.textContent.trim().includes('Add Accessory')) {
            addAccessoryBtn = button;
        }
    });
    
    if (addAccessoryBtn) {
        console.log('Found Add Accessory button, adding direct event listener');
        // Remove existing onclick handler and add new event listener
        addAccessoryBtn.removeAttribute('onclick');
        addAccessoryBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Add Accessory button clicked via event listener');
            
            if (addAccessoryModal) {
                console.log('Showing accessory modal');
                addAccessoryModal.style.display = 'block';
                addAccessoryModal.style.zIndex = '9999';
                addAccessoryModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            } else {
                console.error('Modal element not found!');
            }
            return false;
        });
    } else {
        console.warn('Add Accessory button not found');
    }
    
    // Initialize global variables that might be used elsewhere
    window.showLoading = function() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.classList.remove('hidden');
        }
    };
    
    window.hideLoading = function() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.classList.add('hidden');
        }
    };
    
    // Tab system removed - all sections now display sequentially

    // ========================================
    // @MENTION FUNCTIONALITY (LEGACY - DISABLED)
    // The new @mention system uses initializeMentionAutocomplete()
    // which is initialized in the DOMContentLoaded handler below
    // ========================================
    console.log('‚úÖ @Mention: Using new initializeMentionAutocomplete system');

    // Legacy @mention variables (kept for compatibility but not used)
    var currentMentionStart = -1;
    var selectedIndex = -1;
    var textarea = null;
    var suggestions = null;

    function handleInput(e) {
        var pos = textarea.selectionStart;
        var text = textarea.value;
    
        // Find @ symbol before cursor
        var i = pos;
        while (i > 0 && text[i-1] !== ' ' && text[i-1] !== '\n') i--;
        var word = text.slice(i, pos);
    
        if (word.startsWith('@')) {
            currentMentionStart = i;
            var search = word.slice(1).toLowerCase();
            showSuggestions(search);
        } else {
            hideSuggestions();
        }
    }

    function handleKeydown(e) {
        if (!suggestions.classList.contains('hidden')) {
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectNext();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectPrevious();
                    break;
                case 'Enter':
                case 'Tab':
                    if (selectedIndex >= 0) {
                        e.preventDefault();
                        insertMention();
                    }
                    break;
                case 'Escape':
                    hideSuggestions();
                    break;
            }
        }
    }

    function showSuggestions(search) {
        var matches = [];
        
        // Only proceed if userData is an object
        if (typeof userData === 'object' && userData !== null) {
            // Convert object to array if needed
            var users = Array.isArray(userData) ? userData : Object.values(userData);
            
            matches = users.filter(function(user) {
                return user && user.username && 
                       user.username.toLowerCase().includes(search);
            });
        }
    
        if (matches.length > 0) {
            suggestions.innerHTML = matches.map(function(user, index) {
                return '<div class="mention-suggestion" data-username="' + 
                       user.username + '" data-index="' + index + '">' +
                       user.username + '</div>';
            }).join('');
            
            suggestions.querySelectorAll('.mention-suggestion').forEach(function(el) {
                el.addEventListener('click', function() {
                    selectedIndex = parseInt(el.dataset.index);
                    insertMention();
                });
                el.addEventListener('mouseover', function() {
                    selectedIndex = parseInt(el.dataset.index);
                    updateSelection();
                });
            });
        
            selectedIndex = 0;
            updateSelection();
        
            // Position suggestions below cursor
            var coords = getCaretCoordinates(textarea, textarea.selectionStart);
            suggestions.style.top = (coords.top + 20) + 'px';
            suggestions.style.left = coords.left + 'px';
            suggestions.classList.remove('hidden');
        } else {
            hideSuggestions();
        }
    }

    function hideSuggestions() {
        suggestions.classList.add('hidden');
        currentMentionStart = -1;
        selectedIndex = -1;
    }

    function selectNext() {
        var items = suggestions.querySelectorAll('.mention-suggestion');
        selectedIndex = (selectedIndex + 1) % items.length;
        updateSelection();
    }

    function selectPrevious() {
        var items = suggestions.querySelectorAll('.mention-suggestion');
        selectedIndex = (selectedIndex - 1 + items.length) % items.length;
        updateSelection();
    }

    function updateSelection() {
        suggestions.querySelectorAll('.mention-suggestion').forEach(function(el, i) {
            el.classList.toggle('selected', i === selectedIndex);
        });
    }

    function insertMention() {
        var selected = suggestions.querySelector('.mention-suggestion.selected');
        if (selected && currentMentionStart >= 0) {
            var username = selected.dataset.username;
            var text = textarea.value;
            var before = text.slice(0, currentMentionStart);
            var after = text.slice(textarea.selectionStart);
            textarea.value = before + '@' + username + ' ' + after;
            var cursorPos = currentMentionStart + username.length + 2;
            textarea.setSelectionRange(cursorPos, cursorPos);
            textarea.focus();
        }
        hideSuggestions();
    }

    // Helper function to get caret coordinates
    function getCaretCoordinates(element, position) {
        var div = document.createElement('div');
        var styles = getComputedStyle(element);
        var properties = [
            'direction', 'boxSizing', 'width', 'height', 'overflowX', 'overflowY',
            'borderTopWidth', 'borderRightWidth', 'borderBottomWidth', 'borderLeftWidth',
            'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft',
            'fontStyle', 'fontVariant', 'fontWeight', 'fontStretch', 'fontSize',
            'fontSizeAdjust', 'lineHeight', 'fontFamily', 'textAlign', 'textTransform',
            'textIndent', 'textDecoration', 'letterSpacing', 'wordSpacing'
        ];

        properties.forEach(function(prop) {
            div.style[prop] = styles[prop];
        });

        div.style.position = 'absolute';
        div.style.visibility = 'hidden';
        div.style.whiteSpace = 'pre-wrap';
        div.style.wordWrap = 'break-word';

        div.textContent = element.value.substring(0, position);

        var span = document.createElement('span');
        span.textContent = element.value.substring(position) || '.';
        div.appendChild(span);

        document.body.appendChild(div);

        var coordinates = {
            top: span.offsetTop + parseInt(styles.borderTopWidth),
            left: span.offsetLeft + parseInt(styles.borderLeftWidth)
        };

        document.body.removeChild(div);

        return coordinates;
    }
    
    console.log('‚úÖ @Mention system fully loaded');

});
</script>
<!-- Simple script to fix accessories loading -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded, fixing accessories dropdowns...");
    
    // Find all accessory select dropdowns
    const selects = document.querySelectorAll('select[id*="existing_accessory_select"]');
    console.log("Found", selects.length, "accessory dropdowns");
    
    selects.forEach((select, index) => {
        console.log(`Loading accessories for dropdown ${index + 1}...`);
        
        // Load accessories for this dropdown
        fetch('/tickets/api/accessories', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Accessories loaded for dropdown ${index + 1}:`, data);
            select.innerHTML = '<option value="">-- Select an Accessory --</option>';
            
            if (data.success && data.accessories && data.accessories.length > 0) {
                // Sort accessories by name
                data.accessories.sort((a, b) => a.name.localeCompare(b.name));
                
                data.accessories.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.id;
                    option.text = `${acc.name} (${acc.category}) - Qty: ${acc.available_quantity}`;
                    select.appendChild(option);
                });
                console.log(`Successfully loaded ${data.accessories.length} accessories for dropdown ${index + 1}`);

                // Initialize Select2 for searchable dropdown
                $(select).select2({
                    placeholder: '-- Select an Accessory --',
                    allowClear: true,
                    width: '100%'
                });
            } else {
                const option = document.createElement('option');
                option.value = "";
                option.text = "No accessories available";
                select.appendChild(option);
            }
        })
        .catch(error => {
            console.error(`Error loading accessories for dropdown ${index + 1}:`, error);
            select.innerHTML = '<option value="">-- Error Loading --</option>';
        });
    });
});
</script>

        </div> <!-- Close white background wrapper -->
    </div> <!-- Close container -->
</div> <!-- Close bg-gray-100 -->



<!-- Add simple modal functions -->
<script>
function openSimpleModal() {
    document.getElementById('simpleAccessoryModal').style.display = 'block';
    console.log('Simple modal opened');
}

function closeSimpleModal() {
    document.getElementById('simpleAccessoryModal').style.display = 'none';
    console.log('Simple modal closed');
}
</script>

<!-- Add missing tracking functions for Asset Checkout (Claw) -->
<script>
// Function to refresh outbound tracking for Asset Checkout categories
function refreshOutboundTracking() {
    const trackingInfo = document.getElementById('trackingInfo');
    const trackingLoading = document.getElementById('trackingLoading');
    const trackingError = document.getElementById('trackingError');
    
    if (!trackingInfo || !trackingLoading || !trackingError) {
        console.error('Required outbound tracking elements not found');
        return;
    }
    
    // Show loading state for outbound tracking
    trackingInfo.classList.add('hidden');
    trackingError.classList.add('hidden');
    trackingLoading.classList.remove('hidden');
    
    console.log('Refreshing outbound tracking for ticket {{ ticket.id }}');
    
    // Determine the correct tracking endpoint based on category
    let trackingEndpoint;
    const category = '{{ ticket.category.name if ticket.category else "" }}';
    
    if (category === 'ASSET_CHECKOUT_CLAW') {
        trackingEndpoint = `/tickets/category/checkout_claw/{{ ticket.id }}/track`;
    } else {
        trackingEndpoint = `/tickets/category/checkout_main/{{ ticket.id }}/track`;
    }
    
    // Fetch outbound tracking
    fetch(trackingEndpoint)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.tracking_info && data.tracking_info.length > 0) {
                const trackingHtml = data.tracking_info.map((entry, index) => `
                    <div class="p-4 relative hover:bg-gray-50 transition-colors duration-150">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 rounded-full ${index === 0 ? 'bg-blue-100' : 'bg-gray-100'} flex items-center justify-center">
                                    <svg class="w-5 h-5 ${index === 0 ? 'text-blue-600' : 'text-gray-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="${index === 0 ? 'text-blue-900 font-medium' : 'text-gray-900'} text-sm">
                                            ${entry.status}
                                        </p>
                                        <p class="mt-1 text-sm ${index === 0 ? 'text-blue-700' : 'text-gray-500'}">
                                            ${entry.location || 'Singapore'}
                                        </p>
                                    </div>
                                    <time class="text-sm ${index === 0 ? 'text-blue-700' : 'text-gray-500'} whitespace-nowrap ml-4">
                                        ${entry.date}
                                    </time>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                trackingInfo.innerHTML = `<h4 class="font-medium text-gray-700 mb-2">Tracking Events:</h4>${trackingHtml}`;
                trackingInfo.classList.remove('hidden');
            } else {
                trackingInfo.innerHTML = `
                    <div class="p-4">
                        <p class="text-sm text-gray-500">Pending - Tracking information will be available once the package starts moving.</p>
                    </div>
                `;
                trackingInfo.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error fetching outbound tracking:', error);
            
            // Show a user-friendly error message
            trackingInfo.innerHTML = `
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-7.938 4h15.876c1.398 0 2.69-.806 3.316-2.065a4.017 4.017 0 000-4.87C21.69 10.806 20.398 10 19 10H5c-1.398 0-2.69.806-3.316 2.065a4.017 4.017 0 000 4.87C2.31 17.194 3.602 18 5 18z" />
                        </svg>
                        <div>
                            <h3 class="text-sm font-medium text-yellow-800">Tracking Temporarily Unavailable</h3>
                            <p class="text-sm text-yellow-700 mt-1">
                                Unable to fetch live tracking data. This can happen when the tracking service is updating or experiencing high traffic.
                            </p>
                            <p class="text-sm text-yellow-700 mt-1">
                                <strong>Status:</strong> Pending - Your package is being processed
                            </p>
                            <button onclick="refreshOutboundTracking()" class="mt-2 text-sm text-yellow-800 underline hover:text-yellow-900">
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
            trackingInfo.classList.remove('hidden');
        })
        .finally(() => {
            trackingLoading.classList.add('hidden');
        });
}





// Auto-load tracking on page load for Asset Checkout categories
document.addEventListener('DOMContentLoaded', function() {
    const category = '{{ ticket.category.name if ticket.category else "" }}';
    const hasTracking = {{ (ticket.shipping_tracking or "")|tojson|safe }};
    
    // DISABLED: Auto-refresh was causing continuous tracking refresh loops
    // Users should manually click refresh button instead
    /*
    if ((category === 'ASSET_CHECKOUT_CLAW' || category === 'ASSET_CHECKOUT_MAIN') && hasTracking) {
        setTimeout(refreshOutboundTracking, 1000); // Delay to ensure elements are loaded
    }
    */

});
</script>

<script>
// Call loadAccessories right away on page load
console.log("Calling loadAccessories() immediately");
loadAccessories();

// Also set up DOMContentLoaded event just in case
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOMContentLoaded: Calling loadAccessories() again");
    loadAccessories();
});

// Store the quantities of accessories to track updates
const accessoryQuantities = {};

// Function to update the accessory table with new data
function updateAccessoryTable(accessory) {
    const tableBody = document.getElementById('accessoryTableBody');
    
    // Check if there's a "No accessories" row that needs to be removed
    const noAccessoriesRow = tableBody.querySelector('tr td[colspan="5"]');
    if (noAccessoriesRow) {
        tableBody.innerHTML = '';
    }
    
    // Check if the accessory already exists in the table
    const existingRow = Array.from(tableBody.querySelectorAll('tr')).find(row => {
        const accessoryIdCell = row.querySelector('td[data-accessory-id]');
        return accessoryIdCell && accessoryIdCell.dataset.accessoryId === accessory.id.toString();
    });
    
    if (existingRow) {
        // Update existing row
        const quantityCell = existingRow.querySelector('td:nth-child(3)');
        const currentQuantity = parseInt(quantityCell.textContent);
        quantityCell.textContent = currentQuantity + accessory.quantity;
    } else {
        // Create new row
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td data-accessory-id="${accessory.id}">${accessory.name}</td>
            <td>${accessory.category}</td>
            <td>${accessory.quantity}</td>
            <td>
                <span class="sf-badge ${accessory.condition === 'Good' ? 'sf-badge-success' : accessory.condition === 'Fair' ? 'sf-badge-warning' : 'sf-badge-danger'}">
                    ${accessory.condition}
                </span>
            </td>
            <td>
                <div class="flex gap-2">
                    <button onclick="editAccessory('${accessory.id}')" class="text-blue-600 hover:text-blue-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                    <button onclick="removeAccessory('${accessory.id}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </td>
        `;
        tableBody.appendChild(newRow);
    }
}
</script>

<!-- Import Tech Asset Modal -->
<div id="importTechAssetModal" class="fixed inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Import Tech Assets from CSV
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                Upload a CSV file to import multiple tech assets and link them to this ticket.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <form id="importForm" action="/inventory/import" method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="import_type" value="tech_assets">
                        <input type="hidden" name="ticket_id" value="{{ ticket.id }}">
                        
                        <div class="space-y-4">
                            <div>
                                <label for="csvFile" class="block text-sm font-medium text-gray-700">CSV File</label>
                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                    <div class="space-y-1 text-center">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <div class="flex text-sm text-gray-600">
                                            <label for="csvFile" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                                <span>Upload a file</span>
                                                <input id="csvFile" name="file" type="file" accept=".csv" required class="sr-only">
                                            </label>
                                            <p class="pl-1">or drag and drop</p>
                                        </div>
                                        <p class="text-xs text-gray-500">CSV files only</p>
                                    </div>
                                </div>
                                <div id="fileName" class="mt-2 text-sm text-gray-600 hidden"></div>
                            </div>
                            
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">
                                            <strong>CSV Format Requirements:</strong><br>
                                            Required columns: Asset Tag, Serial Number, Product, Model, Asset Type<br>
                                            Optional columns: Hardware Type, CPU Type, Memory, Hard Drive, Status, Customer, Country, etc.
                                        </p>
                                        <div class="mt-2">
                                            <a href="/inventory/download-template/tech_assets" class="text-sm text-blue-600 hover:text-blue-500">
                                                Download CSV template ‚Üí
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitImportForm()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Import Assets
                </button>
                <button type="button" onclick="closeImportTechAssetModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Queue Change Modal -->
<div id="queueChangeModal" class="direct-modal" style="display: none;">
    <div class="direct-modal-content max-w-md">
        <div class="direct-modal-header border-b border-gray-200 pb-4 mb-6">
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                    </svg>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Change Queue</h2>
                    <p class="text-sm text-gray-600">Move this ticket to a different queue</p>
                </div>
            </div>
            <button type="button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg p-2 transition-colors" onclick="closeQueueChangeModal()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form method="POST" action="{{ url_for('tickets.change_ticket_queue', ticket_id=ticket.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <label for="queue_id" class="block text-sm font-medium text-gray-700">
                        Current Queue
                    </label>
                </div>
                <div class="px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600">
                    {{ ticket.queue.name if ticket.queue else 'No Queue Assigned' }}
                </div>
            </div>
            
            <div class="mb-6">
                <label for="queue_id" class="block text-sm font-medium text-gray-700 mb-3">
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Select New Queue
                    </span>
                </label>
                <select name="queue_id" id="queue_id" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" required>
                    <option value="">Choose a queue...</option>
                    {% for queue in queues %}
                        {% if current_user.is_super_admin or current_user.user_type.value in ['DEVELOPER', 'SUPER_ADMIN'] or accessible_queue_ids|length == 0 or queue.id in accessible_queue_ids %}
                        <option value="{{ queue.id }}" {% if ticket.queue_id == queue.id %}selected{% endif %}>
                            {{ queue.name }}
                        </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeQueueChangeModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors shadow-sm">
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                        </svg>
                        Change Queue
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Assign Customer Modal -->
{% if current_user.is_super_admin or current_user.is_developer %}
<div id="assignCustomerModal" class="direct-modal" style="display: none;">
    <div class="direct-modal-content max-w-2xl">
        <div class="direct-modal-header border-b border-gray-200 pb-4 mb-4">
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0 w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Assign Customer</h2>
                    <p class="text-sm text-gray-600">Select existing or create new customer</p>
                </div>
            </div>
            <button type="button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg p-2 transition-colors" onclick="closeAssignCustomerModal()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Current Customer Info (if exists) -->
        {% if ticket.customer %}
        <div id="currentCustomerData" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"
             data-name="{{ ticket.customer.name }}"
             data-email="{{ ticket.customer.email or '' }}"
             data-phone="{{ ticket.customer.contact_number or '' }}"
             data-country="{{ ticket.customer.country.value if ticket.customer.country else '' }}"
             data-address="{{ ticket.customer.address or '' }}"
             data-company-id="{{ ticket.customer.company_id or '' }}">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium text-blue-800 mb-1">Current Customer:</p>
                    <p class="font-semibold text-blue-900">{{ ticket.customer.name }}</p>
                    {% if ticket.customer.email %}<p class="text-sm text-blue-700">{{ ticket.customer.email }}</p>{% endif %}
                    {% if ticket.customer.contact_number %}<p class="text-sm text-blue-700">{{ ticket.customer.contact_number }}</p>{% endif %}
                    {% if ticket.customer.country %}<p class="text-sm text-blue-700">{{ ticket.customer.country }}</p>{% endif %}
                </div>
                <button type="button" onclick="cloneCurrentCustomer()" class="px-3 py-1.5 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    Clone & Edit
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-4">
            <button type="button" id="tabSelectExisting" class="px-4 py-2 text-sm font-medium text-amber-600 border-b-2 border-amber-600" onclick="switchCustomerTab('existing')">
                Select Existing
            </button>
            <button type="button" id="tabCreateNew" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" onclick="switchCustomerTab('create')">
                Create New
            </button>
        </div>

        <!-- Tab Content: Select Existing -->
        <div id="tabContentExisting">
            <div class="mb-4">
                <label for="customerSearch" class="block text-sm font-medium text-gray-700 mb-2">
                    Search Customer
                </label>
                <input type="text" id="customerSearch"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                       placeholder="Type to search by name, email, or company..."
                       oninput="filterCustomerList(this.value)">
            </div>

            <div class="mb-6">
                <label for="customer_id_select" class="block text-sm font-medium text-gray-700 mb-2">
                    Select Customer
                </label>
                <select id="customer_id_select"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 shadow-sm"
                        size="8">
                    <option value="">-- Select a customer --</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}"
                            data-name="{{ customer.name|lower }}"
                            data-email="{{ (customer.email or '')|lower }}"
                            data-company="{{ (customer.company.name if customer.company else '')|lower }}">
                        {{ customer.name }} {% if customer.company %}({{ customer.company.name }}){% endif %} {% if customer.email %}- {{ customer.email }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeAssignCustomerModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="button" onclick="submitAssignCustomer()" class="px-4 py-2 text-sm font-medium text-white bg-amber-600 border border-transparent rounded-lg hover:bg-amber-700">
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Assign Customer
                    </span>
                </button>
            </div>
        </div>

        <!-- Tab Content: Create New -->
        <div id="tabContentCreate" style="display: none;">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name <span class="text-red-500">*</span></label>
                    <input type="text" id="newCustomerName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="Full Name" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="newCustomerEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="email@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company <span class="text-red-500">*</span></label>
                    <select id="newCustomerCompany" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required>
                        <option value="">Select Company</option>
                        {% for company in all_companies %}
                        <option value="{{ company.id }}">{{ company.grouped_display_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone <span class="text-red-500">*</span></label>
                    <input type="text" id="newCustomerPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="+1234567890" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Country <span class="text-red-500">*</span></label>
                    <select id="newCustomerCountry" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required>
                        <option value="">Select Country</option>
                        <option value="SINGAPORE">Singapore</option>
                        <option value="USA">USA</option>
                        <option value="UNITED_KINGDOM">United Kingdom</option>
                        <option value="AUSTRALIA">Australia</option>
                        <option value="INDIA">India</option>
                        <option value="GERMANY">Germany</option>
                        <option value="FRANCE">France</option>
                        <option value="CANADA">Canada</option>
                        <option value="JAPAN">Japan</option>
                        <option value="CHINA">China</option>
                        <option value="SOUTH_KOREA">South Korea</option>
                        <option value="BRAZIL">Brazil</option>
                        <option value="MEXICO">Mexico</option>
                        <option value="NETHERLANDS">Netherlands</option>
                        <option value="SPAIN">Spain</option>
                        <option value="ITALY">Italy</option>
                        <option value="SWEDEN">Sweden</option>
                        <option value="SWITZERLAND">Switzerland</option>
                        <option value="IRELAND">Ireland</option>
                        <option value="ISRAEL">Israel</option>
                        <option value="UAE">UAE</option>
                        <option value="NEW_ZEALAND">New Zealand</option>
                        <option value="PHILIPPINES">Philippines</option>
                        <option value="MALAYSIA">Malaysia</option>
                        <option value="INDONESIA">Indonesia</option>
                        <option value="THAILAND">Thailand</option>
                        <option value="VIETNAM">Vietnam</option>
                        <option value="TAIWAN">Taiwan</option>
                        <option value="HONG_KONG">Hong Kong</option>
                    </select>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Address <span class="text-red-500">*</span></label>
                <textarea id="newCustomerAddress" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="Full address..." required></textarea>
            </div>

            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeAssignCustomerModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="button" onclick="createAndAssignCustomer()" class="px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-lg hover:bg-green-700">
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Create & Assign
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// Assign Customer Modal Functions
function showAssignCustomerModal() {
    document.getElementById('assignCustomerModal').style.display = 'flex';
    switchCustomerTab('existing'); // Reset to first tab
}

// Clone current customer data into Create New form
function cloneCurrentCustomer() {
    // Get current customer data from data attributes
    const customerData = document.getElementById('currentCustomerData');
    if (!customerData) return;

    const currentName = customerData.dataset.name || '';
    const currentEmail = customerData.dataset.email || '';
    const currentPhone = customerData.dataset.phone || '';
    const currentCountry = customerData.dataset.country || '';
    const currentAddress = customerData.dataset.address || '';
    const currentCompanyId = customerData.dataset.companyId || '';

    // Switch to Create New tab
    switchCustomerTab('create');

    // Pre-fill the form with current customer data
    document.getElementById('newCustomerName').value = currentName;
    document.getElementById('newCustomerEmail').value = currentEmail;
    document.getElementById('newCustomerPhone').value = currentPhone;
    document.getElementById('newCustomerAddress').value = currentAddress;

    // Set company dropdown
    if (currentCompanyId) {
        document.getElementById('newCustomerCompany').value = currentCompanyId;
    }

    // Try to match country in dropdown
    const countrySelect = document.getElementById('newCustomerCountry');
    const countryUpper = currentCountry.toUpperCase().replace(/\s+/g, '_');
    for (let option of countrySelect.options) {
        if (option.value === countryUpper || option.value === currentCountry) {
            countrySelect.value = option.value;
            break;
        }
    }

    // Focus on name field so user can edit
    setTimeout(() => {
        document.getElementById('newCustomerName').focus();
        document.getElementById('newCustomerName').select();
    }, 100);
}

function closeAssignCustomerModal() {
    document.getElementById('assignCustomerModal').style.display = 'none';
    document.getElementById('customerSearch').value = '';
    document.getElementById('customer_id_select').value = '';
    // Reset create form
    document.getElementById('newCustomerName').value = '';
    document.getElementById('newCustomerEmail').value = '';
    document.getElementById('newCustomerCompany').value = '';
    document.getElementById('newCustomerPhone').value = '';
    document.getElementById('newCustomerCountry').value = '';
    document.getElementById('newCustomerAddress').value = '';
    // Reset filter
    filterCustomerList('');
}

function switchCustomerTab(tab) {
    const tabExisting = document.getElementById('tabSelectExisting');
    const tabCreate = document.getElementById('tabCreateNew');
    const contentExisting = document.getElementById('tabContentExisting');
    const contentCreate = document.getElementById('tabContentCreate');

    if (tab === 'existing') {
        tabExisting.className = 'px-4 py-2 text-sm font-medium text-amber-600 border-b-2 border-amber-600';
        tabCreate.className = 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700';
        contentExisting.style.display = 'block';
        contentCreate.style.display = 'none';
    } else {
        tabExisting.className = 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700';
        tabCreate.className = 'px-4 py-2 text-sm font-medium text-amber-600 border-b-2 border-amber-600';
        contentExisting.style.display = 'none';
        contentCreate.style.display = 'block';
    }
}

// Create new customer - try to pre-fill from available ticket data
function cloneAndEditCustomer() {
    // Get available data from ticket
    const shippingAddress = {{ ticket.shipping_address | tojson | safe if ticket.shipping_address else '""' }};
    const description = {{ ticket.description | tojson | safe if ticket.description else '""' }};
    const subject = {{ ticket.subject | tojson | safe if ticket.subject else '""' }};

    // Open modal and switch to Create New tab
    document.getElementById('assignCustomerModal').style.display = 'flex';
    switchCustomerTab('create');

    // Pre-fill address field if available
    if (shippingAddress) {
        document.getElementById('newCustomerAddress').value = shippingAddress;
    } else if (description) {
        // Try to find address-like content in description
        document.getElementById('newCustomerAddress').value = description;
    }

    // Try to parse name from shipping address or subject
    let extractedName = '';
    if (shippingAddress) {
        const lines = shippingAddress.split('\n');
        if (lines.length > 0) {
            const firstLine = lines[0].trim();
            if (firstLine && !firstLine.match(/^\d/) && !firstLine.toLowerCase().includes('street') && !firstLine.toLowerCase().includes('road')) {
                extractedName = firstLine;
            }
        }
    }

    // If no name from address, try subject
    if (!extractedName && subject) {
        // Subject might contain customer name
        extractedName = subject.replace(/^(Order|Checkout|Return|Request)[\s\-:]+/i, '').trim();
    }

    if (extractedName) {
        document.getElementById('newCustomerName').value = extractedName;
    }

    // Focus on name field so user can edit
    setTimeout(() => {
        document.getElementById('newCustomerName').focus();
        document.getElementById('newCustomerName').select();
    }, 100);
}

function filterCustomerList(searchTerm) {
    const select = document.getElementById('customer_id_select');
    const options = select.querySelectorAll('option');
    const term = searchTerm.toLowerCase().trim();

    options.forEach(option => {
        if (option.value === '') {
            option.style.display = '';
            return;
        }
        const name = option.dataset.name || '';
        const email = option.dataset.email || '';
        const company = option.dataset.company || '';

        if (term === '' || name.includes(term) || email.includes(term) || company.includes(term)) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    });
}

function submitAssignCustomer() {
    const customerId = document.getElementById('customer_id_select').value;
    if (!customerId) {
        alert('Please select a customer');
        return;
    }

    fetch('{{ url_for("tickets.update_ticket_customer", ticket_id=ticket.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ customer_id: parseInt(customerId) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Customer assigned successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error assigning customer: ' + error.message);
    });
}

function createAndAssignCustomer() {
    const name = document.getElementById('newCustomerName').value.trim();
    const email = document.getElementById('newCustomerEmail').value.trim();
    const companyId = document.getElementById('newCustomerCompany').value;
    const phone = document.getElementById('newCustomerPhone').value.trim();
    const country = document.getElementById('newCustomerCountry').value;
    const address = document.getElementById('newCustomerAddress').value.trim();

    // Validate required fields
    if (!name) {
        alert('Please enter customer name');
        return;
    }
    if (!companyId) {
        alert('Please select a company');
        return;
    }
    if (!phone) {
        alert('Please enter phone number');
        return;
    }
    if (!country) {
        alert('Please select a country');
        return;
    }
    if (!address) {
        alert('Please enter address');
        return;
    }

    // First create the customer
    fetch('{{ url_for("inventory.create_customer") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            name: name,
            email: email,
            company_id: parseInt(companyId),
            contact_number: phone,
            country: country,
            address: address
        })
    })
    .then(response => response.json().then(data => ({ status: response.status, data })))
    .then(({ status, data }) => {
        if (data.success && data.customer) {
            // Customer created, now assign to ticket
            return fetch('{{ url_for("tickets.update_ticket_customer", ticket_id=ticket.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ customer_id: data.customer.id })
            }).then(r => r.json());
        } else if (status === 409 && data.existing_customer) {
            // Customer with same name exists - ask user if they want to use it
            const existingName = data.existing_customer.name;
            const existingCompany = data.existing_customer.company || 'No company';
            if (confirm(`A customer named "${existingName}" (${existingCompany}) already exists.\n\nDo you want to assign the existing customer to this ticket instead?`)) {
                // Use existing customer
                return fetch('{{ url_for("tickets.update_ticket_customer", ticket_id=ticket.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ customer_id: data.existing_customer.id })
                }).then(r => r.json());
            } else {
                throw new Error('Customer creation cancelled');
            }
        } else {
            throw new Error(data.error || 'Failed to create customer');
        }
    })
    .then(data => {
        if (data && data.success) {
            alert('Customer assigned successfully!');
            location.reload();
        } else if (data) {
            alert('Error assigning customer: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (error.message !== 'Customer creation cancelled') {
            alert('Error: ' + error.message);
        }
    });
}

// Show Import Tech Asset Modal
function showImportTechAssetModal() {
    document.getElementById('importTechAssetModal').classList.remove('hidden');
}

// Close Import Tech Asset Modal
function closeImportTechAssetModal() {
    document.getElementById('importTechAssetModal').classList.add('hidden');
    // Reset form
    document.getElementById('importForm').reset();
    document.getElementById('fileName').classList.add('hidden');
}

// Handle file selection
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('csvFile');
    const fileNameDiv = document.getElementById('fileName');
    
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileNameDiv.textContent = `Selected file: ${file.name}`;
                fileNameDiv.classList.remove('hidden');
            } else {
                fileNameDiv.classList.add('hidden');
            }
        });
    }
});

// Submit import form
function submitImportForm() {
    const form = document.getElementById('importForm');
    const fileInput = document.getElementById('csvFile');
    
    if (!fileInput.files.length) {
        alert('Please select a CSV file to import.');
        return;
    }
    
    // Show loading state
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Importing...';
    
    // Submit the form
    form.submit();
}

// Case Progression Bar Functions for Asset Checkout (claw) and Asset Return (claw)
function refreshProgressionBar() {
    const category = '{{ ticket.category.name if ticket.category else "" }}';
    
    // Only refresh if this is an Asset Checkout (claw) or Asset Return (claw) ticket
    if (category !== 'ASSET_CHECKOUT_CLAW' && category !== 'ASSET_RETURN_CLAW') {
        return;
    }
    
    console.log(`Refreshing progression bar for ${category} ticket`);
    
    // Check if tracking exists and refresh tracking status
    const trackingNumber = {{ (ticket.shipping_tracking if ticket.shipping_tracking else "")|tojson|safe }};
    const returnTrackingNumber = {{ (ticket.return_tracking if ticket.return_tracking else "")|tojson|safe }};
    
    if (category === 'ASSET_CHECKOUT_CLAW' && trackingNumber) {
        // Refresh tracking to get latest status for Asset Checkout
        fetch(`/tickets/category/checkout_claw/{{ ticket.id }}/track?force_refresh=true`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Tracking data refreshed:', data);
                
                // Check if package is delivered and ticket should be closed
                if (data.shipping_status && data.shipping_status.toLowerCase().includes('delivered')) {
                    showDeliveryNotification();
                    // Optionally auto-refresh the page to show updated status
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                }
            }
        })
        .catch(error => {
            console.error('Error refreshing tracking:', error);
        });
    } else if (category === 'ASSET_RETURN_CLAW' && (trackingNumber || returnTrackingNumber)) {
        // Refresh tracking for Asset Return (check both outbound and return tracking)
        if (trackingNumber) {
            // Refresh outbound tracking (return label)
            fetch(`/tickets/{{ ticket.id }}/track_singpost`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Outbound tracking data refreshed:', data);
                    
                    // Check if item is delivered (customer received return label)
                    if (data.shipping_status && data.shipping_status.toLowerCase().includes('delivered')) {
                        // For returns, we don't auto-close on outbound delivery
                        // Instead, we wait for the return item to be received
                        console.log('Return label delivered to customer');
                    }
                }
            })
            .catch(error => {
                console.error('Error refreshing outbound tracking:', error);
            });
        }
        
        if (returnTrackingNumber) {
            // Refresh return tracking (item being returned)
            fetch(`/tickets/{{ ticket.id }}/track_return`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Return tracking data refreshed:', data);
                    
                    // Check if return item is delivered (we received the item back)
                    if (data.return_status && data.return_status.toLowerCase().includes('delivered')) {
                        showReturnReceivedNotification();
                        // Optionally auto-refresh the page to show updated status
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    }
                }
            })
            .catch(error => {
                console.error('Error refreshing return tracking:', error);
            });
        }
    }
}

function showDeliveryNotification() {
    // Create and show a notification that the package has been delivered
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded shadow-lg';
    notification.innerHTML = `
        <div class="flex items-center">
            <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <div>
                <strong>Package Delivered!</strong><br>
                <span class="text-sm">This case has been automatically closed.</span>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove notification after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function showReturnReceivedNotification() {
    // Create and show a notification that the return item has been received
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded shadow-lg';
    notification.innerHTML = `
        <div class="flex items-center">
            <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <div>
                <strong>Return Item Received!</strong><br>
                <span class="text-sm">The return item has been received and the case can be closed.</span>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove notification after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Auto-refresh progression bar every 5 minutes for active tickets
document.addEventListener('DOMContentLoaded', function() {
    const category = '{{ ticket.category.name if ticket.category else "" }}';
    const ticketStatus = '{{ ticket.status.name if ticket.status else "" }}';
    
    if ((category === 'ASSET_CHECKOUT_CLAW' || category === 'ASSET_RETURN_CLAW') && ticketStatus !== 'RESOLVED' && ticketStatus !== 'RESOLVED_DELIVERED') {
        // DISABLED: Auto-refresh was causing continuous tracking refresh loops
        // Users should manually click refresh button instead
        /*
        // Refresh progression bar every 5 minutes for active Asset Checkout (claw) and Asset Return (claw) tickets
        setInterval(refreshProgressionBar, 300000); // 5 minutes
        
        // Initial refresh after 10 seconds
        setTimeout(refreshProgressionBar, 10000);
        */
     }
});

// Package Management Functions for Asset Checkout (claw)
window.showAddPackageModal = function showAddPackageModal() {
    // Determine the next available package number
    const packageNumber = getNextAvailablePackageNumber();
    
    if (packageNumber === null) {
        alert('Maximum of 5 packages allowed per ticket.');
        return;
    }
    
    // Update modal title and description
    document.getElementById('packageModalTitle').textContent = `Add Package ${packageNumber} Tracking`;
    document.getElementById('packageModalDescription').textContent = `Please enter the tracking number and select the carrier for Package ${packageNumber}.`;
    document.getElementById('package_number').value = packageNumber;
    document.getElementById('submitPackageBtn').textContent = `Add Package ${packageNumber}`;
    
    // Clear form
    document.getElementById('package_tracking_number').value = '';
    document.getElementById('package_carrier').value = 'auto';
    
    // Show modal
    document.getElementById('addPackageModal').classList.remove('hidden');
}

window.hideAddPackageModal = function hideAddPackageModal() {
    document.getElementById('addPackageModal').classList.add('hidden');
}

// Assign Item to Package Functions
function showAssignItemToPackageModal() {
    // Clear form
    document.getElementById('assign_item_type').value = '';
    document.getElementById('assign_item_id').innerHTML = '<option value="">-- Select Item --</option>';
    document.getElementById('assign_item_selection').style.display = 'none';
    document.getElementById('assign_package_number').value = '1';
    document.getElementById('assign_quantity').value = '1';
    document.getElementById('assign_notes').value = '';
    
    // Show modal
    document.getElementById('assignItemToPackageModal').classList.remove('hidden');
}

function hideAssignItemToPackageModal() {
    document.getElementById('assignItemToPackageModal').classList.add('hidden');
}

function loadAssignItemOptions() {
    const itemType = document.getElementById('assign_item_type').value;
    const itemSelect = document.getElementById('assign_item_id');
    const itemSelection = document.getElementById('assign_item_selection');
    
    // Clear previous options and show loading
    itemSelect.innerHTML = '<option value="">-- Loading Items... --</option>';
    itemSelect.disabled = true;
    
    if (!itemType) {
        itemSelection.style.display = 'none';
        return;
    }
    
    // Show the item selection dropdown
    itemSelection.style.display = 'block';
    
    console.log('DEBUG: Loading items for type:', itemType);
    
    // Fetch items via AJAX to ensure proper data handling
    const ticketId = {{ ticket.id }};
    fetch(`/tickets/${ticketId}/api/items?type=${itemType}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('DEBUG: Received items data:', data);
        
        // Re-enable the select and clear loading message
        itemSelect.disabled = false;
        itemSelect.innerHTML = '<option value="">-- Select Item --</option>';
        
        if (data.success && data.items && data.items.length > 0) {
            data.items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.display_name;
                itemSelect.appendChild(option);
                console.log('DEBUG: Added item option:', item.id, '-', item.display_name);
            });
            console.log(`DEBUG: Successfully loaded ${data.items.length} ${itemType}s`);
        } else {
                         itemSelect.innerHTML = `<option value="">No ${itemType}s in this case</option>`;
            console.log(`DEBUG: No ${itemType}s found in this ticket`);
        }
    })
    .catch(error => {
        console.error('ERROR: Failed to load items:', error);
        itemSelect.disabled = false;
        itemSelect.innerHTML = '<option value="">-- Error Loading Items --</option>';
        alert(`Failed to load ${itemType}s. Please try again.`);
    });
}

function editPackage(packageNumber) {
    // Get current package data from the UI
    const packageDiv = document.getElementById(`package-${packageNumber}`);
    if (!packageDiv) return;
    
    // Find the tracking number and carrier elements correctly
    const trackingElements = packageDiv.querySelectorAll('.font-medium');
    let trackingNumber = '';
    let carrier = '';
    
    // The tracking number is the first .font-medium element after "Tracking Number" text
    const labels = packageDiv.querySelectorAll('.text-sm.text-gray-500');
    labels.forEach((label, index) => {
        if (label.textContent === 'Tracking Number') {
            const nextElement = label.nextElementSibling;
            if (nextElement && nextElement.classList.contains('font-medium')) {
                trackingNumber = nextElement.textContent.trim();
            }
        } else if (label.textContent === 'Carrier') {
            const nextElement = label.nextElementSibling;
            if (nextElement && nextElement.classList.contains('font-medium')) {
                carrier = nextElement.textContent.trim().toLowerCase();
            }
        }
    });
    
    // Update modal for editing
    document.getElementById('packageModalTitle').textContent = `Edit Package ${packageNumber} Tracking`;
    document.getElementById('packageModalDescription').textContent = `Update the tracking information for Package ${packageNumber}.`;
    document.getElementById('package_number').value = packageNumber;
    document.getElementById('submitPackageBtn').textContent = `Update Package ${packageNumber}`;
    
    // Populate form with current data
    document.getElementById('package_tracking_number').value = trackingNumber !== 'Not assigned' ? trackingNumber : '';
    document.getElementById('package_carrier').value = carrier !== 'not specified' ? carrier : 'auto';
    
    // Show modal
    document.getElementById('addPackageModal').classList.remove('hidden');
}

function removePackage(packageNumber) {
    if (confirm(`Are you sure you want to remove Package ${packageNumber}?`)) {
        // Send AJAX request to remove package
        fetch(`/tickets/{{ ticket.id }}/remove_package`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            },
            body: JSON.stringify({
                package_number: packageNumber
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page to show updated packages
                window.location.reload();
            } else {
                alert('Error removing package: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error removing package:', error);
            alert('Error removing package. Please try again.');
        });
    }
}

function getNextAvailablePackageNumber() {
    // Check which packages are already present in the UI
    for (let i = 1; i <= 5; i++) {
        if (!document.getElementById(`package-${i}`)) {
            return i;
        }
    }
    return null; // All 5 packages are used
}

function refreshPackageTracking(packageNumber) {
    const trackingResults = document.getElementById(`trackingResults-${packageNumber}`);
    const trackingEvents = document.getElementById(`trackingEvents-${packageNumber}`);
    
    if (!trackingResults || !trackingEvents) {
        console.error(`Tracking elements not found for package ${packageNumber}`);
        return;
    }
    
    // Show loading state
    trackingResults.classList.remove('hidden');
    trackingEvents.innerHTML = '<div class="text-center py-8"><div class="flex items-center justify-center space-x-2 mb-4"><div class="animate-spin inline-block w-6 h-6 border-[3px] border-current border-t-transparent text-blue-600 rounded-full"></div><span class="text-gray-600 font-medium">Loading tracking data...</span></div><p class="text-gray-400 text-sm">Fetching the latest shipment updates</p></div>';
    
    // Fetch tracking data for this specific package
    fetch(`/tickets/{{ ticket.id }}/track_package/${packageNumber}?force_refresh=true`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
                    console.log(`[Package ${packageNumber} Debug] API Response:`, data);
            console.log(`[Package ${packageNumber} Debug] Response is_real_data:`, data.is_real_data);
            console.log(`[Package ${packageNumber} Debug] Response tracking_info:`, data.tracking_info);
        
        if (data.success && data.tracking_info && data.tracking_info.length > 0) {
            console.log(`[Package ${packageNumber} Debug] Found ${data.tracking_info.length} tracking events`);
            
            // Sort events by date (newest first)
            const sortedEvents = data.tracking_info.slice().sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA; // Newest first
            });
            console.log(`[Package ${packageNumber} Debug] Sorted events by date:`, sortedEvents);
            
            // Format tracking events as professional timeline
            let eventsHtml = '';
            sortedEvents.forEach((event, index) => {
                console.log(`[Package ${packageNumber} Debug] Event ${index}:`, event);
                const date = formatTrackingDate(event.date) || event.date;
                const status = event.status || 'Status unavailable';
                const location = event.location || 'Location unavailable';
                
                // Split date and time - formatTrackingDate now returns: "Jul 8, 2025 15:30"
                let dateOnly = '';
                let timeOnly = '';
                
                // Split on last space to separate date and time
                const lastSpaceIndex = date.lastIndexOf(' ');
                if (lastSpaceIndex > 0) {
                    dateOnly = date.substring(0, lastSpaceIndex);
                    timeOnly = date.substring(lastSpaceIndex + 1);
                } else {
                    dateOnly = date;
                    timeOnly = '';
                }
                
                // Determine icon and colors based on status
                let iconSvg = '';
                let bgColor = 'bg-blue-500';
                let badgeColor = 'bg-gray-100 text-gray-800';
                let badgeText = '‚óè Event Logged';
                
                if (index === 0) {
                    bgColor = 'bg-green-500';
                    badgeColor = 'bg-green-100 text-green-800';
                    badgeText = '‚óè Latest Update';
                    iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>';
                } else if (status.includes('Delivery')) {
                    badgeColor = 'bg-orange-100 text-orange-800';
                    badgeText = '‚óè Out for Delivery';
                    iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>';
                } else if (status.includes('Transit')) {
                    badgeColor = 'bg-blue-100 text-blue-800';
                    badgeText = '‚óè In Transit';
                    iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>';
                } else if (status.includes('Arrived') || status.includes('Sorting')) {
                    badgeColor = 'bg-purple-100 text-purple-800';
                    badgeText = '‚óè Processing';
                    iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>';
                } else if (status.includes('Received')) {
                    badgeColor = 'bg-indigo-100 text-indigo-800';
                    badgeText = '‚óè Received';
                    iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>';
                } else {
                    iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>';
                }
                
                const isLast = index === sortedEvents.length - 1;
                
                eventsHtml += '<div class="relative flex items-start pb-3 ' + (!isLast ? 'border-l-2 border-blue-200 ml-4' : '') + '">' +
                    '<!-- Timeline Icon -->' +
                    '<div class="absolute -left-6 top-0 flex items-center justify-center w-8 h-8 rounded-full ' + bgColor + ' text-white shadow-md">' +
                    '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    iconSvg +
                    '</svg>' +
                    '</div>' +
                    '<!-- Event Content -->' +
                    '<div class="flex-1 bg-white rounded-lg shadow-sm border border-gray-200 p-3 ml-6">' +
                    '<div class="flex items-start justify-between">' +
                    '<div class="flex-1">' +
                    '<h5 class="text-base font-semibold text-gray-900 mb-1">' +
                    status +
                    '</h5>' +
                    '<div class="flex items-center text-gray-600 mb-2">' +
                    '<svg class="w-3 h-3 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>' +
                    '</svg>' +
                    '<span class="text-sm font-medium">' + location + '</span>' +
                    '</div>' +
                    '</div>' +
                    '<div class="text-right">' +
                    '<div class="text-sm font-medium text-gray-900">' +
                    dateOnly +
                    '</div>' +
                    (timeOnly ? '<div class="text-xs text-gray-500">' + timeOnly + '</div>' : '') +
                    '</div>' +
                    '</div>' +
                    '<!-- Status Badge -->' +
                    '<div class="mt-2">' +
                    '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ' + badgeColor + '">' +
                    badgeText +
                    '</span>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
            });
            console.log(`[Package ${packageNumber} Debug] Generated Professional Timeline HTML:`, eventsHtml);
            trackingEvents.innerHTML = eventsHtml;
        } else {
            console.log(`[Package ${packageNumber} Debug] No tracking data found or API failed:`, data);
            trackingEvents.innerHTML = '<div class="text-center py-8"><svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg><p class="text-gray-500 text-lg font-medium">No tracking events available</p><p class="text-gray-400 text-sm">Tracking information will appear here once available</p></div>';
        }
    })
    .catch(error => {
        console.error(`[Package ${packageNumber} Debug] Error fetching package tracking:`, error);
        trackingEvents.innerHTML = '<div class="text-center py-8"><svg class="w-12 h-12 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.864-.833-2.634 0L4.168 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg><p class="text-red-500 text-lg font-medium">Unable to load tracking data</p><p class="text-gray-400 text-sm">Error: ' + error.message + '</p></div>';
    });
}

// Package Item Management Functions
function showAddItemModal(packageNumber) {
    console.log('DEBUG: showAddItemModal called with packageNumber:', packageNumber);

    // Update modal content
    document.getElementById('itemModalTitle').textContent = `Add Item to Package ${packageNumber}`;
    document.getElementById('itemModalDescription').textContent = `Select an asset or accessory to add to Package ${packageNumber}.`;
    document.getElementById('item_package_number').value = packageNumber;

    // Clear form
    document.getElementById('item_type').value = '';
    document.getElementById('item_id').innerHTML = '<option value="">-- Select Item --</option>';
    document.getElementById('item_selection').style.display = 'none';
    document.getElementById('item_quantity').value = '1';
    document.getElementById('item_notes').value = '';

    // Show modal
    const modal = document.getElementById('addItemModal');
    if (!modal) {
        console.error('ERROR: Add Item modal element not found in DOM.');
        return;
    }

    console.log('DEBUG: Modal element found:', modal);
    console.log('DEBUG: Modal classes before:', modal.className);

    // Clear any inline display overrides left over from previous attempts
    modal.style.removeProperty('display');
    modal.style.removeProperty('visibility');
    modal.style.removeProperty('opacity');

    modal.classList.remove('hidden');
    modal.classList.add('modal-visible');
    modal.removeAttribute('aria-hidden');

    document.body.classList.add('overflow-hidden');
    document.body.style.overflow = 'hidden';

    console.log('DEBUG: Modal classes after:', modal.className);
    console.log('DEBUG: Modal computed after:', window.getComputedStyle(modal).display, window.getComputedStyle(modal).visibility, window.getComputedStyle(modal).opacity);
    
    requestAnimationFrame(() => {
        const rect = modal.getBoundingClientRect();
        console.log('DEBUG: Modal rect after RAF:', rect);
        const content = modal.querySelector('.inline-block');
        if (content) {
            console.log('DEBUG: Modal content rect after RAF:', content.getBoundingClientRect());
        }
    });
    console.log('DEBUG: Modal should now be visible');
}

function hideAddItemModal() {
    const modal = document.getElementById('addItemModal');
    if (modal) {
        modal.classList.remove('modal-visible');
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');

        modal.style.removeProperty('display');
        modal.style.removeProperty('visibility');
        modal.style.removeProperty('opacity');

        document.body.classList.remove('overflow-hidden');
        // Restore body scrolling
        document.body.style.overflow = '';
    }
}

function loadItemOptions() {
    const itemType = document.getElementById('item_type').value;
    const itemSelect = document.getElementById('item_id');
    const itemSelection = document.getElementById('item_selection');

    // Clear previous options and show loading
    itemSelect.innerHTML = '<option value="">-- Loading Items... --</option>';
    itemSelect.disabled = true;

    if (!itemType) {
        itemSelection.style.display = 'none';
        return;
    }

    // Show the item selection dropdown
    itemSelection.style.display = 'block';

    console.log('DEBUG: Loading items for type:', itemType);

    // Fetch items via AJAX to get ALL available items from inventory
    const ticketId = {{ ticket.id }};
    fetch(`/tickets/${ticketId}/api/items?type=${itemType}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('DEBUG: Received items data:', data);

        // Re-enable the select and clear loading message
        itemSelect.disabled = false;
        itemSelect.innerHTML = '<option value="">-- Select Item --</option>';

        if (data.success && data.items && data.items.length > 0) {
            data.items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.display_name;
                itemSelect.appendChild(option);
                console.log('DEBUG: Added item option:', item.id, '-', item.display_name);
            });
            console.log(`DEBUG: Successfully loaded ${data.items.length} ${itemType}s`);
        } else {
            itemSelect.innerHTML = `<option value="">No ${itemType}s in this case</option>`;
            console.log(`DEBUG: No ${itemType}s found in this ticket`);
        }
    })
    .catch(error => {
        console.error('ERROR: Failed to load items:', error);
        itemSelect.disabled = false;
        itemSelect.innerHTML = '<option value="">-- Error Loading Items --</option>';
        alert(`Failed to load ${itemType}s. Please try again.`);
    });
}

function removePackageItem(itemId, packageNumber) {
    if (confirm('Are you sure you want to remove this item from the package?')) {
        fetch(`/tickets/{{ ticket.id }}/package_item/${itemId}/remove`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the item from the UI
                const itemElement = document.getElementById(`item-${itemId}`);
                if (itemElement) {
                    itemElement.remove();
                }
                
                // Check if this was the last item and show empty state
                const packageItems = document.getElementById(`packageItems-${packageNumber}`);
                if (packageItems.children.length === 0) {
                    packageItems.innerHTML = '<div class="text-sm text-gray-500 text-center py-2">No items added to this package</div>';
                }
                
                // Show success message
                showNotification(data.message, 'success');
            } else {
                alert('Error removing item: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error removing item:', error);
            alert('Error removing item. Please try again.');
        });
    }
}

function showNotification(message, type) {
    // Simple notification - you could enhance this with a proper notification system
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Store ticket assets and accessories for JavaScript use
const ticketAssets = [
    {% for asset in ticket.assets %}
    {
        id: {{ asset.id }},
        name: "{{ asset.name }}",
        asset_tag: "{{ asset.asset_tag or '' }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

const ticketAccessories = [
    {% for accessory in ticket.accessories %}
    {
        id: {{ accessory.id }},
        name: "{{ accessory.name }}",
        category: "{{ accessory.category or '' }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Handle package form submission
document.addEventListener('DOMContentLoaded', function() {
    const submitPackageBtn = document.getElementById('submitPackageBtn');
    if (submitPackageBtn) {
        submitPackageBtn.addEventListener('click', function() {
            const form = document.getElementById('addPackageForm');
            const formData = new FormData(form);
            
            // Convert FormData to JSON
            const data = {
                package_number: parseInt(formData.get('package_number')),
                tracking_number: formData.get('tracking_number'),
                carrier: formData.get('carrier')
            };
            
            // Send AJAX request
            fetch(`/tickets/{{ ticket.id }}/add_package`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide modal and reload page to show new package
                    hideAddPackageModal();
                    window.location.reload();
                } else {
                    alert('Error adding package: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error adding package:', error);
                alert('Error adding package. Please try again.');
            });
        });
    }
    
    // Handle item form submission
    const submitItemBtn = document.getElementById('submitItemBtn');
    if (submitItemBtn) {
        submitItemBtn.addEventListener('click', function() {
            const form = document.getElementById('addItemForm');
            const formData = new FormData(form);
            
            // Validate required fields
            const itemType = formData.get('item_type');
            const itemId = formData.get('item_id');
            const packageNumber = formData.get('package_number');
            
            if (!itemType || !itemId) {
                alert('Please select both item type and specific item.');
                return;
            }
            
            // Convert FormData to JSON
            const data = {
                item_type: itemType,
                item_id: parseInt(itemId),
                quantity: parseInt(formData.get('quantity') || 1),
                notes: formData.get('notes') || ''
            };
            
            // Send AJAX request
            fetch(`/tickets/{{ ticket.id }}/package/${packageNumber}/add_item`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide modal and reload page to show new item
                    hideAddItemModal();
                    window.location.reload();
                } else {
                    alert('Error adding item: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error adding item:', error);
                alert('Error adding item. Please try again.');
            });
        });
    }
    
    // Handle assign item to package form submission
    const submitAssignItemBtn = document.getElementById('submitAssignItemBtn');
    if (submitAssignItemBtn) {
        submitAssignItemBtn.addEventListener('click', function() {
            const form = document.getElementById('assignItemForm');
            const formData = new FormData(form);
            
            // Validate required fields
            const itemType = formData.get('item_type');
            const itemId = formData.get('item_id');
            const packageNumber = formData.get('package_number');
            
            if (!itemType || !itemId || !packageNumber) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Convert FormData to JSON
            const data = {
                item_type: itemType,
                item_id: parseInt(itemId),
                quantity: parseInt(formData.get('quantity') || 1),
                notes: formData.get('notes') || ''
            };
            
            // Send AJAX request
            fetch(`/tickets/{{ ticket.id }}/package/${packageNumber}/add_item`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide modal and reload page to show new item assignment
                    hideAssignItemToPackageModal();
                    showNotification('Item successfully assigned to package!', 'success');
                    // Reload after a short delay to show the notification
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    alert('Error assigning item to package: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error assigning item to package:', error);
                alert('Error assigning item to package. Please try again.');
            });
        });
    }
    
    // Load saved tracking data for packages on page load
    {% if packages_tracking_data %}
    const packagesTrackingData = {{ packages_tracking_data|tojson|safe }};
    
    // Display saved tracking data for each package
    Object.keys(packagesTrackingData).forEach(packageNumber => {
        const trackingEvents = document.getElementById(`trackingEvents-${packageNumber}`);
        const trackingResults = document.getElementById(`trackingResults-${packageNumber}`);
        
        if (trackingEvents && trackingResults) {
            const events = packagesTrackingData[packageNumber];
            
            if (events && events.length > 0) {
                // Show the tracking results section
                trackingResults.classList.remove('hidden');
                
                // Format and display the tracking events as professional timeline
                let eventsHtml = '';
                events.forEach((event, index) => {
                    const date = formatTrackingDate(event.date) || event.date;
                    const status = event.status || 'Status unavailable';
                    const location = event.location || 'Location unavailable';
                    
                    // Split date and time - formatTrackingDate now returns: "Jul 8, 2025 15:30"
                    let dateOnly = '';
                    let timeOnly = '';
                    
                    // Split on last space to separate date and time
                    const lastSpaceIndex = date.lastIndexOf(' ');
                    if (lastSpaceIndex > 0) {
                        dateOnly = date.substring(0, lastSpaceIndex);
                        timeOnly = date.substring(lastSpaceIndex + 1);
                    } else {
                        dateOnly = date;
                        timeOnly = '';
                    }
                    
                    // Determine icon and colors based on status
                    let iconSvg = '';
                    let bgColor = 'bg-blue-500';
                    let badgeColor = 'bg-gray-100 text-gray-800';
                    let badgeText = '‚óè Event Logged';
                    
                    if (index === 0) {
                        bgColor = 'bg-green-500';
                        badgeColor = 'bg-green-100 text-green-800';
                        badgeText = '‚óè Latest Update';
                        iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>';
                    } else if (status.includes('Delivery')) {
                        badgeColor = 'bg-orange-100 text-orange-800';
                        badgeText = '‚óè Out for Delivery';
                        iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>';
                    } else if (status.includes('Transit')) {
                        badgeColor = 'bg-blue-100 text-blue-800';
                        badgeText = '‚óè In Transit';
                        iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>';
                    } else if (status.includes('Arrived') || status.includes('Sorting')) {
                        badgeColor = 'bg-purple-100 text-purple-800';
                        badgeText = '‚óè Processing';
                        iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>';
                    } else if (status.includes('Received')) {
                        badgeColor = 'bg-indigo-100 text-indigo-800';
                        badgeText = '‚óè Received';
                        iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>';
                    } else {
                        iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>';
                    }
                    
                    const isLast = index === events.length - 1;
                    
                    eventsHtml += '<div class="relative flex items-start pb-3 ' + (!isLast ? 'border-l-2 border-blue-200 ml-4' : '') + '">' +
                        '<!-- Timeline Icon -->' +
                        '<div class="absolute -left-6 top-0 flex items-center justify-center w-8 h-8 rounded-full ' + bgColor + ' text-white shadow-md">' +
                        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        iconSvg +
                        '</svg>' +
                        '</div>' +
                        '<!-- Event Content -->' +
                        '<div class="flex-1 bg-white rounded-lg shadow-sm border border-gray-200 p-3 ml-6">' +
                        '<div class="flex items-start justify-between">' +
                        '<div class="flex-1">' +
                        '<h5 class="text-base font-semibold text-gray-900 mb-1">' +
                        status +
                        '</h5>' +
                        '<div class="flex items-center text-gray-600 mb-2">' +
                        '<svg class="w-3 h-3 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>' +
                        '</svg>' +
                        '<span class="text-sm font-medium">' + location + '</span>' +
                        '</div>' +
                        '</div>' +
                        '<div class="text-right">' +
                        '<div class="text-sm font-medium text-gray-900">' +
                        dateOnly +
                        '</div>' +
                        (timeOnly ? '<div class="text-xs text-gray-500">' + timeOnly + '</div>' : '') +
                        '</div>' +
                        '</div>' +
                        '<!-- Status Badge -->' +
                        '<div class="mt-2">' +
                        '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ' + badgeColor + '">' +
                        badgeText +
                        '</span>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
                });
                trackingEvents.innerHTML = eventsHtml;
            } else {
                trackingEvents.innerHTML = '<div class="text-center py-8"><svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg><p class="text-gray-500 text-lg font-medium">No tracking events yet</p><p class="text-gray-400 text-sm">Click refresh to load tracking data</p></div>';
            }
        }
    });
    {% endif %}
});

// Queue Change Modal Functions
function openQueueChangeModal() {
    document.getElementById('queueChangeModal').style.display = 'block';
}

function closeQueueChangeModal() {
    document.getElementById('queueChangeModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('queueChangeModal');
    if (event.target === modal) {
        closeQueueChangeModal();
    }
}

// Global @mention trigger function (called from inline oninput handler)
window.mentionState = {
    currentTextarea: null,
    currentMentionStart: -1,
    mentionUsers: [],
    selectedIndex: -1
};

window.triggerMentionSearch = async function(textarea, query, mentionStart) {
    console.log('[MENTION-GLOBAL] Triggered search for:', query);
    const dropdown = document.getElementById('mentionDropdown');
    const mentionList = document.getElementById('mentionList');

    if (!dropdown || !mentionList) {
        console.error('[MENTION-GLOBAL] Dropdown elements not found!');
        return;
    }

    window.mentionState.currentTextarea = textarea;
    window.mentionState.currentMentionStart = mentionStart;

    try {
        const url = `/tickets/api/mention-suggestions?q=${encodeURIComponent(query)}`;
        console.log('[MENTION-GLOBAL] Fetching:', url);
        const response = await fetch(url);
        const data = await response.json();
        console.log('[MENTION-GLOBAL] Got response:', data);

        if (data.suggestions && data.suggestions.length > 0) {
            window.mentionState.mentionUsers = data.suggestions;
            mentionList.innerHTML = '';

            data.suggestions.forEach((item, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; background: white;';
                div.onmouseenter = () => div.style.backgroundColor = '#f3f4f6';
                div.onmouseleave = () => div.style.backgroundColor = 'white';

                const avatarColor = item.type === 'group' ? '#10b981' : '#3b82f6';
                const avatarBg = item.type === 'group' ? '#d1fae5' : '#dbeafe';

                div.innerHTML = `
                    <span style="width: 36px; height: 36px; border-radius: 50%; background: ${avatarBg}; color: ${avatarColor}; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; flex-shrink: 0;">
                        ${item.type === 'group' ? 'üë•' : item.name.charAt(0).toUpperCase()}
                    </span>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; color: #1f2937; font-size: 14px;">@${item.name}</div>
                        <div style="font-size: 12px; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.type === 'group' ? 'Group' : (item.email || 'User')}</div>
                    </div>
                `;
                div.onclick = () => window.selectMention(item);
                mentionList.appendChild(div);
            });

            // Show and position dropdown with better styling
            dropdown.classList.remove('hidden');
            dropdown.style.cssText = 'position: absolute; bottom: 100%; left: 0; width: 280px; max-height: 250px; overflow-y: auto; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 8px; z-index: 9999;';
            console.log('[MENTION-GLOBAL] Dropdown shown with', data.suggestions.length, 'items');
        } else {
            dropdown.classList.add('hidden');
        }
    } catch (err) {
        console.error('[MENTION-GLOBAL] Error:', err);
        dropdown.classList.add('hidden');
    }
};

window.selectMention = function(item) {
    const textarea = window.mentionState.currentTextarea;
    const mentionStart = window.mentionState.currentMentionStart;

    if (!textarea) return;

    const value = textarea.value;
    const beforeMention = value.substring(0, mentionStart);
    const afterCursor = value.substring(textarea.selectionStart);

    const mentionText = `@${item.name}`;
    textarea.value = beforeMention + mentionText + ' ' + afterCursor;

    const newCursorPos = mentionStart + mentionText.length + 1;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();

    document.getElementById('mentionDropdown').classList.add('hidden');
};

// @mention Autocomplete Functionality
function initializeMentionAutocomplete(textarea) {
    console.log('[MENTION] Initializing autocomplete for textarea:', textarea.id);
    const dropdown = document.getElementById('mentionDropdown');
    const mentionList = document.getElementById('mentionList');
    let currentMentionStart = -1;
    let currentMentionQuery = '';
    let selectedIndex = -1;
    let mentionUsers = [];

    console.log('[MENTION] Dropdown element:', dropdown);
    console.log('[MENTION] MentionList element:', mentionList);

    if (!dropdown || !mentionList) {
        console.error('[MENTION] Dropdown elements not found!', {dropdown: !!dropdown, mentionList: !!mentionList});
        return;
    }

    console.log('[MENTION] Successfully initialized, adding input listener');

    // Handle input events
    console.log('[MENTION] Adding input event listener to textarea:', textarea.id);
    textarea.addEventListener('input', function(e) {
        console.log('[MENTION] Input event fired, value:', this.value);
        const value = this.value;
        const cursorPos = this.selectionStart;
        const textBeforeCursor = value.substring(0, cursorPos);
        console.log('[MENTION] Text before cursor:', textBeforeCursor);

        // Look for @mention pattern
        const mentionMatch = textBeforeCursor.match(/@([a-zA-Z0-9._@-]*)$/);
        console.log('[MENTION] Mention match result:', mentionMatch);

        if (mentionMatch) {
            console.log('[MENTION] Detected @ mention:', mentionMatch);
            currentMentionStart = cursorPos - mentionMatch[0].length;
            currentMentionQuery = mentionMatch[1];

            if (currentMentionQuery.length >= 0) {
                console.log('[MENTION] Searching for query:', currentMentionQuery);
                searchMentions(currentMentionQuery);
            }
        } else {
            hideMentionDropdown();
        }
    });
    console.log('[MENTION] Input event listener added successfully');

    // Handle keyboard navigation
    textarea.addEventListener('keydown', function(e) {
        if (!dropdown.classList.contains('hidden')) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, mentionUsers.length - 1);
                updateSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection();
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                if (selectedIndex >= 0 && selectedIndex < mentionUsers.length) {
                    e.preventDefault();
                    selectMention(mentionUsers[selectedIndex]);
                }
            } else if (e.key === 'Escape') {
                hideMentionDropdown();
            }
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!textarea.contains(e.target) && !dropdown.contains(e.target)) {
            hideMentionDropdown();
        }
    });

    // Search users and groups function
    async function searchMentions(query) {
        try {
            console.log('[MENTION] Fetching suggestions for query:', query);
            const url = `/tickets/api/mention-suggestions?q=${encodeURIComponent(query)}`;
            console.log('[MENTION] Fetching from URL:', url);

            const response = await fetch(url);
            console.log('[MENTION] Response status:', response.status);

            const data = await response.json();
            console.log('[MENTION] Response data:', data);

            if (data.suggestions && data.suggestions.length > 0) {
                console.log('[MENTION] Found', data.suggestions.length, 'suggestions');
                mentionUsers = data.suggestions;
                showMentionDropdown(data.suggestions);
            } else {
                console.log('[MENTION] No suggestions found');
                hideMentionDropdown();
            }
        } catch (error) {
            console.error('[MENTION] Error searching mentions:', error);
            hideMentionDropdown();
        }
    }

    // Show mention dropdown
    function showMentionDropdown(suggestions) {
        console.log('[MENTION] showMentionDropdown called with', suggestions.length, 'suggestions');
        console.log('[MENTION] mentionList element:', mentionList);
        console.log('[MENTION] dropdown element:', dropdown);

        mentionList.innerHTML = '';
        selectedIndex = -1;

        suggestions.forEach((item, index) => {
            console.log('[MENTION] Creating element for:', item.name, 'type:', item.type);
            const element = document.createElement('div');
            element.className = 'px-4 py-2 cursor-pointer hover:bg-gray-100 flex items-center space-x-3';

            if (item.type === 'user') {
                element.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold text-xs">
                        ${item.avatar}
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">${item.name}</div>
                        ${item.email !== item.name ? `<div class="text-sm text-gray-500">${item.email}</div>` : ''}
                    </div>
                    <div class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">User</div>
                `;
            } else if (item.type === 'group') {
                element.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-teal-600 rounded-full flex items-center justify-center text-white font-semibold text-xs">
                        <i class="fas fa-users text-xs"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">@${item.name}</div>
                        <div class="text-sm text-gray-500">${item.description}</div>
                    </div>
                    <div class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Group</div>
                `;
            }

            element.addEventListener('click', () => selectMention(item));
            mentionList.appendChild(element);
        });

        console.log('[MENTION] Added', mentionList.children.length, 'items to mentionList');
        console.log('[MENTION] Dropdown classes before:', dropdown.className);
        dropdown.classList.remove('hidden');
        console.log('[MENTION] Dropdown classes after:', dropdown.className);

        // Position dropdown
        positionDropdown();
        console.log('[MENTION] Dropdown positioned');
    }

    // Hide mention dropdown
    function hideMentionDropdown() {
        dropdown.classList.add('hidden');
        selectedIndex = -1;
        mentionUsers = [];
    }

    // Update selection highlighting
    function updateSelection() {
        const items = mentionList.querySelectorAll('div');
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-blue-100');
                item.classList.remove('hover:bg-gray-100');
            } else {
                item.classList.remove('bg-blue-100');
                item.classList.add('hover:bg-gray-100');
            }
        });
    }

    // Select a user
    function selectMention(item) {
        const value = textarea.value;
        const beforeMention = value.substring(0, currentMentionStart);
        const afterCursor = value.substring(textarea.selectionStart);

        // Insert the mention (both users and groups need @)
        const mentionText = `@${item.name}`;
        const newValue = beforeMention + `${mentionText} ` + afterCursor;
        textarea.value = newValue;

        // Set cursor position after the mention
        const newCursorPos = currentMentionStart + mentionText.length + 1;
        textarea.setSelectionRange(newCursorPos, newCursorPos);

        // Trigger input event to update character counter
        textarea.dispatchEvent(new Event('input'));

        hideMentionDropdown();
        textarea.focus();
    }

    // Position dropdown relative to textarea
    function positionDropdown() {
        console.log('[MENTION] Positioning dropdown');

        // Position dropdown above the textarea (since it's at bottom of screen)
        dropdown.style.bottom = '100%';
        dropdown.style.left = '0';
        dropdown.style.marginBottom = '4px';
        dropdown.style.top = 'auto';

        console.log('[MENTION] Dropdown positioned above textarea');
    }
}

// Enhanced Comment System JavaScript
document.addEventListener('DOMContentLoaded', function() {
    console.log('[COMMENT-SYSTEM] DOMContentLoaded fired');

    // Character counter for comment textarea
    const messageTextarea = document.getElementById('message');
    const commentTextarea = document.getElementById('commentTextarea');
    const charCounter = document.getElementById('charCounter');
    const submitButton = document.getElementById('submitComment');
    const cancelButton = document.getElementById('cancelComment');
    const commentForm = document.getElementById('commentForm');

    console.log('[COMMENT-SYSTEM] Elements found:', {
        messageTextarea: !!messageTextarea,
        commentTextarea: !!commentTextarea,
        mentionDropdown: !!document.getElementById('mentionDropdown'),
        mentionList: !!document.getElementById('mentionList')
    });

    // Initialize @mention for commentTextarea (messenger style)
    if (commentTextarea) {
        console.log('[COMMENT-SYSTEM] Initializing @mention for commentTextarea');
        try {
            initializeMentionAutocomplete(commentTextarea);
            console.log('[COMMENT-SYSTEM] @mention initialized successfully');
        } catch (e) {
            console.error('[COMMENT-SYSTEM] Error initializing @mention:', e);
        }
    } else {
        console.warn('[COMMENT-SYSTEM] commentTextarea not found');
    }

    if (messageTextarea && charCounter) {
        messageTextarea.addEventListener('input', function() {
            const length = this.value.length;
            const maxLength = 1000;
            charCounter.textContent = `${length} / ${maxLength}`;

            // Change color based on length
            if (length > maxLength * 0.9) {
                charCounter.classList.add('text-red-500');
                charCounter.classList.remove('text-gray-400', 'text-yellow-500');
            } else if (length > maxLength * 0.7) {
                charCounter.classList.add('text-yellow-500');
                charCounter.classList.remove('text-gray-400', 'text-red-500');
            } else {
                charCounter.classList.add('text-gray-400');
                charCounter.classList.remove('text-red-500', 'text-yellow-500');
            }

            // Show/hide cancel button
            if (length > 0) {
                cancelButton.style.display = 'inline-block';
            } else {
                cancelButton.style.display = 'none';
            }

            // Disable submit if over limit
            submitButton.disabled = length > maxLength || length === 0;
        });

        // Auto-resize textarea
        messageTextarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // @mention autocomplete functionality for messageTextarea
        initializeMentionAutocomplete(messageTextarea);
        
        // Focus effects
        messageTextarea.addEventListener('focus', function() {
            this.parentElement.classList.add('ring-2', 'ring-blue-500');
        });
        
        messageTextarea.addEventListener('blur', function() {
            this.parentElement.classList.remove('ring-2', 'ring-blue-500');
        });
    }
    
    // Cancel button functionality
    if (cancelButton) {
        cancelButton.addEventListener('click', function() {
            messageTextarea.value = '';
            messageTextarea.style.height = 'auto';
            charCounter.textContent = '0 / 1000';
            charCounter.classList.add('text-gray-400');
            charCounter.classList.remove('text-red-500', 'text-yellow-500');
            this.style.display = 'none';
            submitButton.disabled = true;
        });
    }
    
    // Form submission with loading state
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Posting...
                </span>
            `;
        });
    }
    
    // Toggle comments section
    const toggleButton = document.getElementById('toggleComments');
    const commentsContent = document.getElementById('commentsContent');
    
    if (toggleButton && commentsContent) {
        toggleButton.addEventListener('click', function() {
            const isHidden = commentsContent.style.display === 'none';
            commentsContent.style.display = isHidden ? 'block' : 'none';
            
            // Rotate arrow
            const arrow = this.querySelector('svg');
            if (isHidden) {
                arrow.style.transform = 'rotate(0deg)';
            } else {
                arrow.style.transform = 'rotate(-90deg)';
            }
        });
    }
    
    // Smooth scroll to comments when linked
    if (window.location.hash === '#comments') {
        document.getElementById('comments').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Initialize @mention autocomplete if not already done
    if (messageTextarea && !messageTextarea.hasAttribute('data-mention-initialized')) {
        initializeMentionAutocomplete(messageTextarea);
        messageTextarea.setAttribute('data-mention-initialized', 'true');
    }
});

// Comment action handlers
function replyToComment(commentId) {
    const messageTextarea = document.getElementById('message');
    if (messageTextarea) {
        // Scroll to the comment form
        messageTextarea.scrollIntoView({ behavior: 'smooth' });
        messageTextarea.focus();
        
        // Add a mention or reference to the comment being replied to
        const currentValue = messageTextarea.value;
        if (currentValue.trim() === '') {
            messageTextarea.value = `@admin `;
        }
        
        // Trigger input event to update character counter
        messageTextarea.dispatchEvent(new Event('input'));
    }
}

function editComment(commentId) {
    // Find the comment element
    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
    if (!commentElement) {
        console.error('Comment element not found');
        return;
    }
    
    // Get the comment text
    const commentTextElement = commentElement.querySelector('.comment-text div');
    if (!commentTextElement) {
        console.error('Comment text element not found');
        return;
    }
    
    const originalText = commentTextElement.textContent.trim();
    
    // Replace comment text with an editable textarea
    const editForm = document.createElement('div');
    editForm.className = 'edit-comment-form';
    editForm.innerHTML = `
        <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                  rows="3" 
                  style="text-align: left !important;">${originalText}</textarea>
        <div class="flex gap-2 mt-2">
            <button onclick="saveCommentEdit(${commentId})" 
                    class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                Save
            </button>
            <button onclick="cancelCommentEdit(${commentId})" 
                    class="px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400">
                Cancel
            </button>
        </div>
    `;
    
    // Store original content for cancel functionality
    editForm.setAttribute('data-original-text', originalText);
    
    // Replace the comment text with edit form
    commentTextElement.style.display = 'none';
    commentTextElement.parentNode.insertBefore(editForm, commentTextElement.nextSibling);
    
    // Focus on the textarea
    const textarea = editForm.querySelector('textarea');
    textarea.focus();
    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
}

function saveCommentEdit(commentId) {
    const editForm = document.querySelector('.edit-comment-form');
    const textarea = editForm.querySelector('textarea');
    const newText = textarea.value.trim();
    
    if (newText === '') {
        alert('Comment cannot be empty');
        return;
    }
    
    // Show loading state
    const saveButton = editForm.querySelector('button');
    saveButton.disabled = true;
    saveButton.textContent = 'Saving...';
    
    // Make AJAX request to update comment
    fetch(`/tickets/comments/${commentId}/edit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({ content: newText })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the comment text
            const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
            const commentTextElement = commentElement.querySelector('.comment-text div');
            commentTextElement.textContent = newText;
            
            // Remove edit form and show original text
            commentTextElement.style.display = 'block';
            editForm.remove();
            
            // Show success message
            showNotification('Comment updated successfully', 'success');
        } else {
            alert('Error updating comment: ' + data.error);
            saveButton.disabled = false;
            saveButton.textContent = 'Save';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating comment');
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
    });
}

function cancelCommentEdit(commentId) {
    const editForm = document.querySelector('.edit-comment-form');
    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
    const commentTextElement = commentElement.querySelector('.comment-text div');
    
    // Show original text and remove edit form
    commentTextElement.style.display = 'block';
    editForm.remove();
}

function deleteComment(commentId) {
    if (confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
        // Make AJAX request to delete comment
        fetch(`/tickets/comments/${commentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the comment element from DOM
                const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
                if (commentElement) {
                    commentElement.style.transition = 'opacity 0.3s ease';
                    commentElement.style.opacity = '0';
                    setTimeout(() => {
                        commentElement.remove();
                        
                        // Update comment count
                        const commentCount = document.querySelector('.comment-count');
                        if (commentCount) {
                            const currentCount = parseInt(commentCount.textContent);
                            commentCount.textContent = Math.max(0, currentCount - 1);
                        }
                        
                        showNotification('Comment deleted successfully', 'success');
                    }, 300);
                }
            } else {
                alert('Error deleting comment: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting comment');
        });
    }
}

// Helper function to show notifications
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.transition = 'opacity 0.3s ease';
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Make functions globally available
window.showAddItemModal = showAddItemModal;
window.hideAddItemModal = hideAddItemModal;
window.loadItemOptions = loadItemOptions;
window.showAssignItemToPackageModal = showAssignItemToPackageModal;
window.hideAssignItemToPackageModal = hideAssignItemToPackageModal;
window.loadAssignItemOptions = loadAssignItemOptions;
window.openQueueChangeModal = openQueueChangeModal;
window.closeQueueChangeModal = closeQueueChangeModal;
window.replyToComment = replyToComment;
window.editComment = editComment;
window.deleteComment = deleteComment;

// Item Packed functionality
function markItemPacked(ticketId) {
    if (!confirm('Mark items as packed? This will update the case progress.')) {
        return;
    }

    const btn = document.getElementById('markItemPackedBtn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = 'Processing...';
    }

    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch(`/tickets/${ticketId}/mark_item_packed`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Items marked as packed successfully', 'success');
            // Reload the page to update the case progress
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.error || 'Failed to mark items as packed', 'error');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = 'Mark Packed';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while marking items as packed', 'error');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = 'Mark Packed';
        }
    });
}

window.markItemPacked = markItemPacked;

// Calculate and update days open counter
function updateDaysOpenCounter() {
    const counterElement = document.getElementById('days-open-counter');
    if (counterElement) {
        const createdAtStr = counterElement.getAttribute('data-created-at');
        if (createdAtStr) {
            const createdAt = new Date(createdAtStr);
            const now = new Date();
            const diffTime = Math.abs(now - createdAt);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            counterElement.textContent = diffDays;
        }
    }
}

// Update counter on page load
document.addEventListener('DOMContentLoaded', function() {
    updateDaysOpenCounter();
    // Update counter every hour (optional - keeps it current if page is left open)
    setInterval(updateDaysOpenCounter, 3600000);
    // Load issues on page load
    loadTicketIssues({{ ticket.id }});
    // Load custom issue types to populate dropdown
    loadCustomIssueTypes();
});

// ============================================================================
// ISSUE REPORTING FUNCTIONS
// ============================================================================

// Load custom issue types and add to dropdown
async function loadCustomIssueTypes() {
    try {
        const response = await fetch('/tickets/issue-types');
        const data = await response.json();

        if (data.success && data.custom_types && data.custom_types.length > 0) {
            const selectElements = document.querySelectorAll('#issueType');
            selectElements.forEach(select => {
                // Find the "Other" option
                const otherOption = select.querySelector('option[value="Other"]');
                if (otherOption) {
                    // Add custom types before "Other"
                    data.custom_types.forEach(customType => {
                        // Check if option already exists
                        const existing = select.querySelector(`option[value="${customType.name}"]`);
                        if (!existing) {
                            const option = document.createElement('option');
                            option.value = customType.name;
                            option.textContent = customType.name;
                            select.insertBefore(option, otherOption);
                        }
                    });
                }
            });
        }
    } catch (error) {
        console.error('Error loading custom issue types:', error);
    }
}

// Toggle issue report form
function toggleIssueReportForm() {
    const form = document.getElementById('issueReportForm');
    if (form.style.display === 'none') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
        // Reset form
        document.getElementById('issueType').value = '';
        document.getElementById('issueDescription').value = '';
        // Reset custom issue type
        const customContainer = document.getElementById('customIssueTypeContainer');
        const customInput = document.getElementById('customIssueType');
        if (customContainer) customContainer.style.display = 'none';
        if (customInput) customInput.value = '';
        // Hide mention dropdown
        hideIssueMentionDropdown();
    }
}

// Toggle custom issue type input visibility
function toggleCustomIssueType(selectElement) {
    const customContainer = document.getElementById('customIssueTypeContainer');
    const customInput = document.getElementById('customIssueType');

    if (selectElement.value === 'Other') {
        customContainer.style.display = 'block';
        customInput.required = true;
    } else {
        customContainer.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
    }
}

// Submit issue report - now uses @mentions in description instead of separate notified users field
async function submitIssueReport(event, ticketId) {
    event.preventDefault();

    let issueType = document.getElementById('issueType').value;
    const description = document.getElementById('issueDescription').value;

    // Use custom issue type if "Other" is selected
    if (issueType === 'Other') {
        const customIssueType = document.getElementById('customIssueType').value.trim();
        if (!customIssueType) {
            alert('Please enter a custom issue type');
            return;
        }
        issueType = customIssueType;
    }

    if (!issueType || !description) {
        alert('Please fill in all required fields');
        return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/tickets/${ticketId}/issues`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'include',
            body: JSON.stringify({
                issue_type: issueType,
                description: description
            })
        });

        const data = await response.json();

        if (data.success) {
            showToast('Issue reported successfully', 'success');
            toggleIssueReportForm();
            loadTicketIssues(ticketId);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error submitting issue:', error);
        showToast('Failed to submit issue', 'error');
    }
}

// @mention system for issue description
let issueMentionStartPos = -1;
let issueCurrentMentionText = '';
const issueAvailableUsers = [
    {% for user_id, user_info in users_dict_mention.items() %}
    { id: {{ user_id }}, username: {{ user_info.username|tojson|safe }}, email: {{ (user_info.email or "")|tojson|safe }} },
    {% endfor %}
];

function checkIssueMention(textarea) {
    const cursorPos = textarea.selectionStart;
    const text = textarea.value;

    // Find last @ before cursor
    let atPos = -1;
    for (let i = cursorPos - 1; i >= 0; i--) {
        if (text[i] === '@') {
            atPos = i;
            break;
        }
        if (text[i] === ' ' || text[i] === '\n') {
            break;
        }
    }

    if (atPos !== -1) {
        issueMentionStartPos = atPos;
        issueCurrentMentionText = text.substring(atPos + 1, cursorPos).toLowerCase();
        showIssueMentionDropdown(issueCurrentMentionText);
    } else {
        hideIssueMentionDropdown();
    }
}

function showIssueMentionDropdown(searchText) {
    const dropdown = document.getElementById('issueMentionDropdown');
    const filtered = issueAvailableUsers.filter(user =>
        user.username.toLowerCase().includes(searchText)
    );

    if (filtered.length === 0) {
        hideIssueMentionDropdown();
        return;
    }

    dropdown.innerHTML = '';
    filtered.slice(0, 10).forEach((user) => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'w-full text-left px-4 py-2 hover:bg-blue-50 flex items-center';
        item.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold text-sm mr-3">
                ${user.username[0].toUpperCase()}
            </div>
            <div>
                <div class="font-medium text-sm">${user.username}</div>
                <div class="text-xs text-gray-500">${user.email}</div>
            </div>
        `;
        item.onclick = function() {
            selectIssueMention(user.username);
        };
        dropdown.appendChild(item);
    });

    dropdown.classList.remove('hidden');
}

function hideIssueMentionDropdown() {
    document.getElementById('issueMentionDropdown').classList.add('hidden');
    issueMentionStartPos = -1;
}

function selectIssueMention(username) {
    const textarea = document.getElementById('issueDescription');
    const text = textarea.value;
    const beforeMention = text.substring(0, issueMentionStartPos);
    const afterMention = text.substring(textarea.selectionStart);

    textarea.value = beforeMention + '@' + username + ' ' + afterMention;
    const newPos = beforeMention.length + username.length + 2;
    textarea.setSelectionRange(newPos, newPos);
    textarea.focus();

    hideIssueMentionDropdown();
}

// Close mention dropdown when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('#issueDescription') && !event.target.closest('#issueMentionDropdown')) {
        hideIssueMentionDropdown();
    }
});

// Load and display ticket issues
async function loadTicketIssues(ticketId) {
    try {
        const response = await fetch(`/tickets/${ticketId}/issues`);
        const data = await response.json();

        if (data.success) {
            displayIssues(data.issues, ticketId);
        }
    } catch (error) {
        console.error('Error loading issues:', error);
    }
}

// Display issues in the UI with Chatter
function displayIssues(issues, ticketId) {
    const container = document.getElementById('issuesDisplay');

    // Count unresolved issues
    const unresolvedIssues = issues.filter(issue => !issue.is_resolved);

    // Update the issue indicator and warning box
    updateIssueIndicator(unresolvedIssues.length, unresolvedIssues);

    if (issues.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500 italic">No issues reported</p>';
        return;
    }

    const currentUserId = {{ session.get('user_id') }};
    const currentUsername = {{ session.get("username", "")|tojson|safe }};

    container.innerHTML = issues.map(issue => `
        <div class="border border-gray-300 rounded-lg mb-3 ${issue.is_resolved ? 'bg-green-50' : 'bg-red-50'}">
            <!-- Issue Header & Details -->
            <div class="p-3">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${issue.is_resolved ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                                ${issue.issue_type}
                            </span>
                        </div>
                        <div class="bg-gray-50 rounded p-2 mb-2 space-y-1">
                            <div class="flex items-start">
                                <span class="text-xs font-semibold text-gray-700 w-24">Reported by:</span>
                                <span class="text-xs text-gray-600">${issue.reported_by_name}</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-xs font-semibold text-gray-700 w-24">Date Reported:</span>
                                <span class="text-xs text-gray-600 font-medium">${formatDate(issue.reported_at)}</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-700 mb-2"><strong>Description:</strong> ${formatMentions(issue.description)}</p>

                        ${issue.is_resolved ? `
                            <div class="mt-2 pt-2 border-t border-green-300">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-1">
                                        <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        <span class="text-xs font-semibold text-green-800">Issue Resolved</span>
                                    </div>
                                    <button onclick="reopenIssue(${ticketId}, ${issue.id})"
                                            class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded font-medium">
                                        Reopen Issue
                                    </button>
                                </div>
                                <div class="bg-white bg-opacity-50 rounded p-2 space-y-1">
                                    <div class="flex items-start">
                                        <span class="text-xs font-semibold text-gray-700 w-24">Resolved by:</span>
                                        <span class="text-xs text-gray-600">${issue.resolved_by_name || 'N/A'}</span>
                                    </div>
                                    <div class="flex items-start">
                                        <span class="text-xs font-semibold text-gray-700 w-24">Date Resolved:</span>
                                        <span class="text-xs text-gray-600 font-medium">${formatDate(issue.resolved_at)}</span>
                                    </div>
                                    ${issue.resolution_notes ? `
                                    <div class="flex items-start">
                                        <span class="text-xs font-semibold text-gray-700 w-24">Resolution:</span>
                                        <span class="text-xs text-gray-600">${issue.resolution_notes}</span>
                                    </div>` : ''}
                                </div>
                            </div>
                        ` : `
                            <button onclick="resolveIssue(${ticketId}, ${issue.id})"
                                    class="mt-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs font-medium">
                                Mark as Resolved
                            </button>
                        `}
                    </div>
                </div>
            </div>

            <!-- Chatter Section -->
            <div class="border-t border-gray-300">
                <button onclick="toggleChatter(${issue.id})"
                        class="w-full px-3 py-2 flex items-center justify-between bg-gray-100 hover:bg-gray-200 transition-colors">
                    <span class="text-xs font-semibold text-gray-700 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        Discussion
                        <span id="chatterCount-${issue.id}" class="bg-blue-500 text-white text-xs px-1.5 py-0.5 rounded-full hidden">0</span>
                    </span>
                    <svg id="chatterChevron-${issue.id}" class="w-4 h-4 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>

                <div id="chatter-${issue.id}" class="hidden">
                    <!-- Comments Container -->
                    <div id="chatterComments-${issue.id}" class="max-h-48 overflow-y-auto p-3 bg-gray-50 space-y-2">
                        <p class="text-xs text-gray-500 text-center py-2">Loading comments...</p>
                    </div>

                    <!-- Comment Input -->
                    <div class="p-3 bg-white border-t border-gray-200">
                        <div class="flex gap-2">
                            <div class="flex-1 relative">
                                <input type="text"
                                       id="chatterInput-${issue.id}"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Write a comment... @mention to notify"
                                       oninput="checkChatterMention(this, ${issue.id})"
                                       onkeypress="handleChatterKeyPress(event, ${ticketId}, ${issue.id})">
                                <div id="chatterMentionDropdown-${issue.id}"
                                     class="hidden absolute bottom-full left-0 mb-2 bg-white rounded-lg shadow-lg border border-gray-200 max-h-36 overflow-y-auto w-56 z-50">
                                </div>
                            </div>
                            <button onclick="submitChatterComment(${ticketId}, ${issue.id})"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-full text-sm font-medium transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                </svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Use <span class="text-blue-500">@username</span> to mention and notify</p>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    // Load comment counts for all issues
    issues.forEach(issue => loadIssueComments(ticketId, issue.id, false));
}

// Format @mentions in text to styled spans
function formatMentions(text) {
    if (!text) return '';
    return text.replace(/@([a-zA-Z0-9._@-]+)/g, '<span class="bg-blue-100 text-blue-700 px-1 rounded font-medium">@$1</span>');
}

// Toggle chatter section visibility
function toggleChatter(issueId) {
    const chatter = document.getElementById(`chatter-${issueId}`);
    const chevron = document.getElementById(`chatterChevron-${issueId}`);

    if (chatter.classList.contains('hidden')) {
        chatter.classList.remove('hidden');
        chevron.classList.add('rotate-180');
        loadIssueComments({{ ticket.id }}, issueId, true);
    } else {
        chatter.classList.add('hidden');
        chevron.classList.remove('rotate-180');
    }
}

// Load comments for an issue
async function loadIssueComments(ticketId, issueId, showComments = true) {
    try {
        const response = await fetch(`/tickets/${ticketId}/issues/${issueId}/comments`);
        const data = await response.json();

        if (data.success) {
            const countBadge = document.getElementById(`chatterCount-${issueId}`);
            if (data.comments.length > 0) {
                countBadge.textContent = data.comments.length;
                countBadge.classList.remove('hidden');
            } else {
                countBadge.classList.add('hidden');
            }

            if (showComments) {
                displayIssueComments(issueId, data.comments);
            }
        }
    } catch (error) {
        console.error('Error loading issue comments:', error);
    }
}

// Display comments in messenger style
function displayIssueComments(issueId, comments) {
    const container = document.getElementById(`chatterComments-${issueId}`);
    const currentUserId = {{ session.get('user_id') }};

    if (comments.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500 text-center py-2">No comments yet. Start the discussion!</p>';
        return;
    }

    container.innerHTML = comments.map(comment => {
        const isCurrentUser = comment.user_id === currentUserId;
        return `
            <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
                <div class="max-w-[80%]">
                    <div class="flex items-center mb-0.5 ${isCurrentUser ? 'flex-row-reverse' : ''}">
                        <div class="w-5 h-5 rounded-full flex items-center justify-center text-white text-xs font-semibold ${isCurrentUser ? 'bg-blue-500 ml-1' : 'bg-gray-500 mr-1'}">
                            ${(comment.username || 'U')[0].toUpperCase()}
                        </div>
                        <span class="text-xs text-gray-500">${comment.username || 'Unknown'}</span>
                    </div>
                    <div class="${isCurrentUser ? 'bg-blue-500 text-white rounded-l-xl rounded-tr-xl' : 'bg-white border border-gray-200 text-gray-800 rounded-r-xl rounded-tl-xl'} px-3 py-2 shadow-sm">
                        <p class="text-xs whitespace-pre-wrap break-words">${formatMentions(comment.content)}</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-0.5 ${isCurrentUser ? 'text-right' : ''}">${formatCommentTime(comment.created_at)}</p>
                </div>
            </div>
        `;
    }).join('');

    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

// Format comment timestamp
function formatCommentTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

// Chatter @mention variables
let chatterMentionStartPos = {};
let chatterCurrentMentionText = {};

// Check for @mention in chatter input
function checkChatterMention(input, issueId) {
    const cursorPos = input.selectionStart;
    const text = input.value;

    let atPos = -1;
    for (let i = cursorPos - 1; i >= 0; i--) {
        if (text[i] === '@') {
            atPos = i;
            break;
        }
        if (text[i] === ' ' || text[i] === '\n') {
            break;
        }
    }

    if (atPos !== -1) {
        chatterMentionStartPos[issueId] = atPos;
        chatterCurrentMentionText[issueId] = text.substring(atPos + 1, cursorPos).toLowerCase();
        showChatterMentionDropdown(issueId, chatterCurrentMentionText[issueId]);
    } else {
        hideChatterMentionDropdown(issueId);
    }
}

function showChatterMentionDropdown(issueId, searchText) {
    const dropdown = document.getElementById(`chatterMentionDropdown-${issueId}`);
    const filtered = issueAvailableUsers.filter(user =>
        user.username.toLowerCase().includes(searchText)
    );

    if (filtered.length === 0) {
        hideChatterMentionDropdown(issueId);
        return;
    }

    dropdown.innerHTML = '';
    filtered.slice(0, 8).forEach((user) => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'w-full text-left px-3 py-1.5 hover:bg-blue-50 flex items-center text-sm';
        item.innerHTML = `
            <div class="w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold text-xs mr-2">
                ${user.username[0].toUpperCase()}
            </div>
            <span class="font-medium">${user.username}</span>
        `;
        item.onclick = function() {
            selectChatterMention(issueId, user.username);
        };
        dropdown.appendChild(item);
    });

    dropdown.classList.remove('hidden');
}

function hideChatterMentionDropdown(issueId) {
    const dropdown = document.getElementById(`chatterMentionDropdown-${issueId}`);
    if (dropdown) dropdown.classList.add('hidden');
    chatterMentionStartPos[issueId] = -1;
}

function selectChatterMention(issueId, username) {
    const input = document.getElementById(`chatterInput-${issueId}`);
    const text = input.value;
    const beforeMention = text.substring(0, chatterMentionStartPos[issueId]);
    const afterMention = text.substring(input.selectionStart);

    input.value = beforeMention + '@' + username + ' ' + afterMention;
    const newPos = beforeMention.length + username.length + 2;
    input.setSelectionRange(newPos, newPos);
    input.focus();

    hideChatterMentionDropdown(issueId);
}

// Handle Enter key in chatter input
function handleChatterKeyPress(event, ticketId, issueId) {
    if (event.key === 'Enter') {
        event.preventDefault();
        submitChatterComment(ticketId, issueId);
    }
}

// Submit a chatter comment
async function submitChatterComment(ticketId, issueId) {
    const input = document.getElementById(`chatterInput-${issueId}`);
    const content = input.value.trim();

    if (!content) return;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/tickets/${ticketId}/issues/${issueId}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ content: content })
        });

        const data = await response.json();

        if (data.success) {
            input.value = '';
            loadIssueComments(ticketId, issueId, true);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error posting comment:', error);
        showToast('Failed to post comment', 'error');
    }
}

// Resolve an issue
async function resolveIssue(ticketId, issueId) {
    const notes = prompt('Resolution notes (optional):');
    if (notes === null) return; // User cancelled

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/tickets/${ticketId}/issues/${issueId}/resolve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                resolution_notes: notes
            })
        });

        const data = await response.json();

        if (data.success) {
            showToast('Issue resolved successfully', 'success');
            loadTicketIssues(ticketId);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error resolving issue:', error);
        showToast('Failed to resolve issue', 'error');
    }
}

// Reopen a resolved issue
async function reopenIssue(ticketId, issueId) {
    if (!confirm('Are you sure you want to reopen this issue?')) return;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/tickets/${ticketId}/issues/${issueId}/reopen`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        const data = await response.json();

        if (data.success) {
            showToast('Issue reopened successfully', 'success');
            loadTicketIssues(ticketId);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error reopening issue:', error);
        showToast('Failed to reopen issue', 'error');
    }
}

// Helper function to format date with relative time
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffSecs = Math.floor(diffMs / 1000);
    const diffMins = Math.floor(diffSecs / 60);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);

    // Show relative time for recent dates
    if (diffSecs < 60) {
        return 'just now';
    } else if (diffMins < 60) {
        return `${diffMins}m ago`;
    } else if (diffHours < 24) {
        return `${diffHours}h ago`;
    } else if (diffDays < 7) {
        return `${diffDays}d ago`;
    } else {
        // For older dates, show absolute date
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        };
        return date.toLocaleString('en-US', options);
    }
}

// Helper function to show toast notifications
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white z-50 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.transition = 'opacity 0.3s ease';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Update issue indicator in Case Progress header and warning box
function updateIssueIndicator(unresolvedCount, unresolvedIssues = []) {
    // Update header indicator
    const indicator = document.getElementById('issueIndicator');
    const countSpan = document.getElementById('issueCount');

    if (indicator && countSpan) {
        if (unresolvedCount > 0) {
            indicator.style.display = 'inline-flex';
            countSpan.textContent = unresolvedCount;
        } else {
            indicator.style.display = 'none';
        }
    }

    // Update issue warning box
    const warningBox = document.getElementById('issueWarning');
    const warningText = document.getElementById('issueWarningText');

    if (warningBox && warningText) {
        if (unresolvedCount > 0) {
            warningBox.style.display = 'block';

            // Create a summary of issues
            const issueTypes = unresolvedIssues.map(issue => issue.issue_type).join(', ');
            warningText.textContent = `${unresolvedCount} unresolved issue(s) require attention: ${issueTypes}. Please scroll down to view and resolve.`;
        } else {
            warningBox.style.display = 'none';
        }
    }
}

// Messenger-style comment functions
// Auto-resize textarea
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
}

// Handle Enter key (Shift+Enter for new line, Enter to submit)
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        document.getElementById('commentFormMessenger').submit();
    }
}

// Check for @mention (simplified version - you can extend with user list if needed)
function checkMention(textarea) {
    // This is a placeholder - you can implement full mention support if needed
    // For now, this just handles the textarea resizing
}

// Scroll to bottom of comments on load
window.addEventListener('load', function() {
    const container = document.getElementById('commentsContainer');
    if (container) {
        container.scrollTop = container.scrollHeight;
    }
});

// Update shipment progress for Asset Checkout (claw) without tracking
function updateShipmentProgress(progressType, ticketId) {
    if (!confirm(`Are you sure you want to mark this shipment as ${progressType.replace('_', ' ')}?`)) {
        return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch(`/tickets/${ticketId}/update-shipment-progress`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            progress_type: progressType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alert(data.message || 'Progress updated successfully');
            // Reload the page to show updated progress
            window.location.reload();
        } else {
            alert(data.error || 'Failed to update progress');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating progress');
    });
}

</script>
{% endblock %}
