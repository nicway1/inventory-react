{% extends "base.html" %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">

<!-- Add HTTP request interception for any internal references to port 5000 -->
<script>
    // Make sure all requests go to the current server port
    document.addEventListener('DOMContentLoaded', function() {
        // Force all XMLHttpRequests and fetch requests to use the current origin
        console.log('Current origin:', window.CURRENT_ORIGIN);
        
        // Special fix for hardcoded XHRs that might be coming from included JS files
        if (!window.XMLHttpRequestFixed) {
            const originalOpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function() {
                let args = Array.from(arguments);
                if (typeof args[1] === 'string' && args[1].includes('127.0.0.1:5000')) {
                    console.log('Intercepted hardcoded XHR URL:', args[1]);
                    args[1] = args[1].replace('http://127.0.0.1:5000', window.CURRENT_ORIGIN);
                    console.log('Redirected to:', args[1]);
                }
                return originalOpen.apply(this, args);
            };
            window.XMLHttpRequestFixed = true;
        }
    });
</script>

<!-- Initialize global variables -->
<script>
    // Initialize global loadingIndicator to fix the "Cannot access before initialization" error
    var loadingIndicator = null; // Will be set to DOM element later
    
    // Initialize when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
        loadingIndicator = document.getElementById('loadingIndicator');
    });
</script>

<!-- No tabs - all sections visible -->
<style>
    /* All content sections visible by default */
    #details, #comments, #documents {
        display: block;
        margin-bottom: 2rem;
    }
</style>

<!-- Load 17TRACK script only for SingPost tickets -->
{% if ticket.shipping_tracking and (ticket.shipping_tracking.startswith('XZD') or ticket.shipping_tracking.startswith('XZB')) %}
<!-- SingPost Tracking Widget Script -->
<script type="text/javascript" src="//www.17track.net/externalcall.js"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        var attempts = 0;
        var maxAttempts = 10;
        
        function initializeTracker() {
            if (typeof YQV5 !== 'undefined') {
                var trackingContainer = document.getElementById('YQContainer');
                if (trackingContainer) {
                    YQV5.trackSingle({
                        YQ_ContainerId: "YQContainer",
                        YQ_Height: 560,
                        YQ_Fc: "0",
                        YQ_Lang: "en",
                        YQ_Num: "{{ ticket.shipping_tracking }}"
                    });
                }
            } else if (attempts < maxAttempts) {
                attempts++;
                setTimeout(initializeTracker, 1000); // Try again in 1 second
            }
        }
        
        initializeTracker();
    });
</script>
{% endif %}

<style>
#YQContainer, #YQContainer-rma_return, #YQContainer-rma_replacement {
    width: 100%;
    height: 560px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 20px;
}

/* Ensure tracking widgets are always visible */
#YQContainer:not(.hidden),
#YQContainer-rma_return:not(.hidden),
#YQContainer-rma_replacement:not(.hidden) {
    display: block !important;
    visibility: visible !important;
    position: static !important;
}

.mention-suggestions {
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
}

.mention-suggestion {
    padding: 8px 12px;
    cursor: pointer;
}

.mention-suggestion.selected {
    background-color: #e5e7eb;
}

.mention {
    background-color: #dbeafe;
    color: #1d4ed8;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 500;
}

.tracking-iframe {
    width: 100%;
    height: 800px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 20px;
}

/* Loading Indicator */
.loading-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.loading-indicator svg {
    animation: spin 1s linear infinite;
    height: 2rem;
    width: 2rem;
    color: #2563eb;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Ensure elements are always visible when not hidden */
#YQContainer:not(.hidden),
#loadingIndicator:not(.hidden),
#customTrackingDisplay:not(.hidden) {
    display: block !important;
    visibility: visible !important;
    position: static !important;
}

/* Salesforce-style UI */
.sf-card {
    background-color: white;
    border-radius: 0.25rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    margin-bottom: 1rem;
}

.sf-card-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    background-color: #f0f4f8;
}

.sf-card-body {
    padding: 1rem;
}

.sf-card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1a202c;
}

.sf-field-row {
    display: flex;
    margin-bottom: 0.5rem;
}

.sf-field-label {
    width: 40%;
    color: #4a5568;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    padding-right: 1rem;
}

.sf-field-value {
    width: 60%;
    color: #111827;
    font-size: 0.875rem;
}

.sf-button {
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    background-color: #f3f4f7;
    border: 1px solid #d1d5db;
    border-radius: 0.25rem;
    color: #4b5563;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    transition: all 0.2s ease;
}

.sf-button:hover {
    background-color: #e5e7eb;
    transform: translateY(-1px);
}

.sf-tabs {
    display: flex;
    border-bottom: 1px solid #e5e7eb;
    background-color: #f0f4f8;
    overflow-x: auto;
}

.sf-tab {
    padding: 0.75rem 1rem;
    color: #6b7280;
    font-size: 0.875rem;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    transition: all 0.2s ease;
}

.sf-tab:hover {
    color: #3b82f6;
}

.sf-tab.active {
    color: #2563eb;
    border-bottom-color: #2563eb;
    font-weight: 500;
}

.sf-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    background-color: #f3f4f6;
    color: #4b5563;
}

.sf-badge-success {
    background-color: #10b981;
    color: white;
}

.sf-badge-warning {
    background-color: #f59e0b;
    color: white;
}

.sf-badge-info {
    background-color: #3b82f6;
    color: white;
}

.sf-action-buttons {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem 0;
    overflow-x: auto;
}

.sf-data-table {
    width: 100%;
    border-collapse: collapse;
}

.sf-data-table th {
    background-color: #f0f4f8;
    text-align: left;
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #4b5563;
    text-transform: uppercase;
    border-bottom: 1px solid #e5e7eb;
}

.sf-data-table td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.875rem;
    color: #111827;
}

.sf-toolbar {
    background-color: #e6eef8;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    gap: 0.5rem;
}

.primary-button {
    background-color: #3b82f6;
    color: white;
}

.primary-button:hover {
    background-color: #2563eb;
}

.pdf-viewer {
    margin-top: 1rem;
    background: white;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.pdf-viewer.hidden {
    display: none;
}

.animate-fade-in {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.pdf-inline-container {
    position: relative;
}

.pdf-loading-indicator {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.8);
    z-index: 10;
}

.pdf-inline-container iframe {
    z-index: 5;
}

/* Direct Modal Styles */
.direct-modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
}

.direct-modal-content {
    background-color: white;
    margin: 50px auto;
    padding: 20px;
    width: 80%;
    max-width: 500px;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.direct-form-group {
    margin-bottom: 15px;
}

.direct-form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.direct-form-control {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.direct-form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.direct-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.direct-btn-primary {
    background-color: #3b82f6;
    color: white;
}

.direct-btn-secondary {
    background-color: #f1f1f1;
    color: #333;
}

.direct-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.direct-modal-title {
    margin: 0;
    font-size: 18px;
}

.direct-close {
    font-size: 24px;
    cursor: pointer;
    background: none;
    border: none;
}
</style>

<div style="display: none; position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: yellow; padding: 10px; font-size: 14px;">
  ⚠️ Using direct form instead of modal
</div>
{% endblock head %}

{% block content %}
<div class="bg-gray-100 min-h-screen py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Notification container -->
        <div id="notification" class="fixed top-4 right-4 z-50 hidden"></div>
        
        <!-- Loading indicator -->
        <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-4 rounded-lg shadow-lg">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto"></div>
                <p class="text-center mt-2 text-gray-700">Loading...</p>
            </div>
        </div>
        
        <!-- Main content wrapper with white background -->
        <div class="bg-white rounded-lg shadow-sm p-6">
        <!-- Case Header -->
        <div class="sf-card mb-6">
                <div class="sf-card-header">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                            </svg>
                            <h1 class="sf-card-title">{{ ticket.subject }}</h1>
                        </div>
                        <div class="flex items-center gap-2">
                            <a href="{{ url_for('tickets.list_tickets') }}" class="sf-button">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                                </svg>
                                Back to Tickets
                            </a>
                        </div>
                    </div>
                </div>
                <div class="sf-card-body grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="space-y-2">
                        <div class="sf-field-row">
                            <div class="sf-field-label">Priority</div>
                            <div class="sf-field-value">
                                <span class="sf-badge {% if ticket.priority and ticket.priority.value == 'HIGH' %}sf-badge-warning{% endif %}">
                                    {{ ticket.priority.value if ticket.priority else 'None' }}
                                </span>
                            </div>
                        </div>
                        <div class="sf-field-row">
                            <div class="sf-field-label">Status</div>
                            <div class="sf-field-value">
                                <span class="sf-badge {% if ticket.status and ticket.status.value == 'REVIEW' %}sf-badge-info{% endif %}">
                                    {{ ticket.status.value if ticket.status else 'None' }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="sf-field-row">
                            <div class="sf-field-label">Case Number</div>
                            <div class="sf-field-value font-mono">{{ ticket.display_id }}</div>
                        </div>
                        {% if ticket.category and ticket.category.value == 'ASSET_INTAKE' %}
                        <div class="sf-field-row">
                            <div class="sf-field-label">Customer Name</div>
                            <div class="sf-field-value">{{ ticket.customer.name if ticket.customer else 'Not specified' }}</div>
                        </div>
                        {% endif %}
                        {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' and ticket.customer %}
                        <div class="sf-field-row">
                            <div class="sf-field-label">Customer Name</div>
                            <div class="sf-field-value">{{ ticket.customer.name }}</div>
                        </div>
                        <div class="sf-field-row">
                            <div class="sf-field-label">Company</div>
                            <div class="sf-field-value">
                                {% if ticket.customer.company %}
                                    {{ ticket.customer.company.name }}
                                {% else %}
                                    No Company
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="space-y-2">
                        <div class="sf-field-row">
                            <div class="sf-field-label">Created Date</div>
                            <div class="sf-field-value">{{ ticket.created_at.strftime('%Y-%m-%d') if ticket.created_at else 'N/A' }}</div>
                        </div>
                        <div class="sf-field-row">
                            <div class="sf-field-label">Last Modified</div>
                            <div class="sf-field-value">{{ ticket.updated_at.strftime('%Y-%m-%d') if ticket.updated_at else 'N/A' }}</div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="sf-field-row">
                            <div class="sf-field-label">Case Owner</div>
                            <div class="sf-field-value">{{ owner.username if owner else 'Unassigned' }}</div>
                        </div>
                        <div class="sf-field-row">
                            <div class="sf-field-label">Category</div>
                            <div class="sf-field-value">{{ ticket.get_category_display_name() if ticket.get_category_display_name() != 'Custom' else 'Custom Category' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Toolbar -->
            <div class="sf-toolbar mb-6 rounded-t-md">
                {% if current_user.is_super_admin or current_user.permissions.can_delete_tickets or (current_user.permissions.can_delete_own_tickets and current_user.id == ticket.requester_id) %}
                <button class="sf-button" onclick="confirmDeleteTicket('{{ ticket.id }}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                    </svg>
                    Delete
                </button>
                {% endif %}
                <button class="sf-button">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    Email
                </button>
                {% if current_user.is_super_admin or current_user.id == ticket.requester_id %}
                <button class="sf-button" onclick="toggleUpdateForm()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Edit / Change Status
                </button>
                {% endif %}
                {% if current_user.is_admin %}
                <button class="sf-button primary-button" onclick="toggleAssignForm()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Change Case Owner
                </button>
                {% endif %}
                
                <!-- Add tracking buttons for Asset Return (claw) -->
                {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                <button class="sf-button" onclick="showAddOutboundTrackingModal()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Add Outbound Tracking
                </button>
                <button class="sf-button" onclick="showAddReturnTrackingModal()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3" />
                    </svg>
                    Add Return Tracking
                </button>
                {% endif %}
            </div>

            <!-- Update Form -->
            <div id="updateForm" class="hidden mb-6">
                <div class="sf-card">
                    <div class="sf-card-header">
                        <h2 class="sf-card-title">Edit Ticket</h2>
                    </div>
                    <div class="sf-card-body">
                        <form method="POST" action="{{ url_for('tickets.update_ticket', ticket_id=ticket.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <!-- Basic Information Section -->
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 gap-4">
                                    <div>
                                        <label for="subject" class="block text-sm font-medium text-gray-700">Subject</label>
                                        <input type="text" id="subject" name="subject" value="{{ ticket.subject }}" 
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                                        <textarea id="description" name="description" rows="4" 
                                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ ticket.description }}</textarea>
                                    </div>
                                    
                                    {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                                    <div>
                                        <label for="return_description" class="block text-sm font-medium text-gray-700">Return Description</label>
                                        <textarea id="return_description" name="return_description" rows="3" 
                                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" 
                                                  placeholder="Describe what assets are being returned and why">{{ ticket.return_description or '' }}</textarea>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="shipping_tracking" class="block text-sm font-medium text-gray-700">Outbound Tracking Number</label>
                                            <input type="text" id="shipping_tracking" name="shipping_tracking" 
                                                   value="{{ ticket.shipping_tracking or '' }}" 
                                                   placeholder="e.g., XZD0002556450"
                                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        </div>
                                        
                                        <div>
                                            <label for="return_tracking" class="block text-sm font-medium text-gray-700">Return Tracking Number</label>
                                            <input type="text" id="return_tracking" name="return_tracking" 
                                                   value="{{ ticket.return_tracking or '' }}" 
                                                   placeholder="e.g., XZD0002556451"
                                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div>
                                        <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                                        <textarea id="notes" name="notes" rows="3" 
                                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ ticket.notes or '' }}</textarea>
                                    </div>
                                    
                                    {% if ticket.shipping_address %}
                                    <div>
                                        <label for="shipping_address" class="block text-sm font-medium text-gray-700">{% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}Return Address{% else %}Shipping Address{% endif %}</label>
                                        <textarea id="shipping_address" name="shipping_address" rows="3" 
                                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ ticket.shipping_address or '' }}</textarea>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Status and Priority Section -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                                        <select id="status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="NEW" {% if ticket.status and ticket.status.name == 'NEW' %}selected{% endif %}>
                                                New
                                            </option>
                                            <option value="IN_PROGRESS" {% if ticket.status and ticket.status.name == 'IN_PROGRESS' %}selected{% endif %}>
                                                In Progress
                                            </option>
                                            <option value="ON_HOLD" {% if ticket.status and ticket.status.name == 'ON_HOLD' %}selected{% endif %}>
                                                On Hold
                                            </option>
                                            <option value="RESOLVED" {% if ticket.status and ticket.status.name == 'RESOLVED' %}selected{% endif %}>
                                                Resolved
                                            </option>
                                            <option value="RESOLVED_DELIVERED" {% if ticket.status and ticket.status.name == 'RESOLVED_DELIVERED' %}selected{% endif %}>
                                                Resolved (All Package Delivered)
                                            </option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="priority" class="block text-sm font-medium text-gray-700">Priority</label>
                                        <select id="priority" name="priority" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="LOW" {% if ticket.priority and ticket.priority.name == 'LOW' %}selected{% endif %}>
                                                Low
                                            </option>
                                            <option value="MEDIUM" {% if ticket.priority and ticket.priority.name == 'MEDIUM' %}selected{% endif %}>
                                                Medium
                                            </option>
                                            <option value="HIGH" {% if ticket.priority and ticket.priority.name == 'HIGH' %}selected{% endif %}>
                                                High
                                            </option>
                                            <option value="CRITICAL" {% if ticket.priority and ticket.priority.name == 'CRITICAL' %}selected{% endif %}>
                                                Critical
                                            </option>
                                        </select>
                                    </div>
                                    {% if session.get('user_type') == 'admin' %}
                                    <div class="md:col-span-2">
                                        <label for="assigned_to_id" class="block text-sm font-medium text-gray-700">Assigned To</label>
                                        <select id="assigned_to_id" name="assigned_to_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="">-- Unassigned --</option>
                                            {% for user_id, user in users.items() %}
                                                <option value="{{ user.id }}" {% if ticket.assigned_to_id == user.id %}selected{% endif %}>
                                                    {{ user.username }} {% if user.company %}({{ user.company }}){% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6 space-x-3">
                                <button type="button" onclick="toggleUpdateForm()" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Cancel
                                </button>
                                <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Update Ticket
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Assign Form -->
            <div id="assignForm" class="hidden mb-6">
                <div class="sf-card">
                    <div class="sf-card-header">
                        <h2 class="sf-card-title">Change Case Owner</h2>
                    </div>
                    <div class="sf-card-body">
                        <form method="POST" action="{{ url_for('tickets.transfer_ticket', ticket_id=ticket.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-4">
                                <label for="transfer_to_id" class="block text-sm font-medium text-gray-700">Assign To</label>
                                <select id="transfer_to_id" name="transfer_to_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                                    <option value="">-- Select User --</option>
                                    {% for user_id, user in users.items() %}
                                        <option value="{{ user.id }}">
                                            {{ user.username }} {% if user.company %}({{ user.company }}){% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="transfer_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                                <textarea id="transfer_notes" name="transfer_notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Add any notes about this assignment..."></textarea>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button type="button" onclick="toggleAssignForm()" class="mr-2 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Cancel
                                </button>
                                <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Change Owner
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- All sections displayed sequentially -->
            <h2 class="text-xl font-semibold mb-4 bg-blue-50 p-3 rounded border-l-4 border-blue-500">Case Details</h2>

            <!-- Content Sections -->
            <div id="page-content-wrapper">
                <!-- Details Section -->
                <div id="details" class="mb-8">
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <h2 class="sf-card-title">Case Information</h2>
                        </div>
                        <div class="sf-card-body">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Subject</div>
                                        <div class="sf-field-value">{{ ticket.subject }}</div>
                                    </div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Description</div>
                                        <div class="sf-field-value whitespace-pre-wrap">{{ ticket.description }}</div>
                                    </div>
                                    {% if ticket.return_description and ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Return Description</div>
                                        <div class="sf-field-value whitespace-pre-wrap">{{ ticket.return_description }}</div>
                                    </div>
                                    {% endif %}
                                    {% if ticket.notes %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Notes</div>
                                        <div class="sf-field-value whitespace-pre-wrap">{{ ticket.notes }}</div>
                                    </div>
                                    {% endif %}
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Case Origin</div>
                                        <div class="sf-field-value">Web</div>
                                    </div>
                                </div>
                                <div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Date/Time Opened</div>
                                        <div class="sf-field-value">{{ ticket.created_at.strftime('%Y-%m-%d %H:%M') if ticket.created_at else 'N/A' }}</div>
                                    </div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Date/Time Closed</div>
                                        <div class="sf-field-value">-</div>
                                    </div>
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Service Type</div>
                                        <div class="sf-field-value">Hardware Support</div>
                                    </div>
                                    
                                    {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                                    <!-- Tracking Information Section -->
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Outbound Tracking</div>
                                        <div class="sf-field-value">
                                            {% if ticket.shipping_tracking %}
                                            <div>{{ ticket.shipping_tracking }} ({{ ticket.shipping_carrier }})</div>
                                            <div class="text-sm text-gray-500">Status: {{ ticket.shipping_status }}</div>
                                            {% else %}
                                            <span class="text-gray-500">Not added yet</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="sf-field-row">
                                        <div class="sf-field-label">Return Tracking</div>
                                        <div class="sf-field-value">
                                            {% if ticket.return_tracking %}
                                            <div>{{ ticket.return_tracking }} ({{ ticket.shipping_carrier }})</div>
                                            <div class="text-sm text-gray-500">Status: {{ ticket.return_status }}</div>
                                            {% else %}
                                            <span class="text-gray-500">Not added yet</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Related Records Section -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <h2 class="sf-card-title">Tech Asset</h2>
                                <div class="flex gap-2">
                                    <button class="sf-button primary-button" onclick="showAssetModal()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                        </svg>
                                        Add Tech Asset
                                    </button>
                                    <button class="sf-button" onclick="showImportTechAssetModal()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                        </svg>
                                        Import Tech Asset
                                    </button>
                                    </div>
                                </div>
                                </div>
                        <div class="sf-card-body">
                                <div class="overflow-x-auto">
                                    <table class="sf-data-table">
                                        <thead>
                                            <tr>
                                            <th>ASSET TAG</th>
                                            <th>SERIAL NUMBER</th>
                                            <th>NAME</th>
                                            <th>STATUS</th>
                                            <th>ACTIONS</th>
                                            </tr>
                                        </thead>
                                    <tbody id="assetTableBody">
                                        {% if ticket.assets %}
                                            {% for asset in ticket.assets %}
                                            <tr>
                                                <td>{{ asset.asset_tag }}</td>
                                                <td>{{ asset.serial_num }}</td>
                                                <td>{{ asset.name }}</td>
                                                <td>
                                                    <span class="sf-badge {% if asset.status and asset.status.value == 'Active' %}sf-badge-success{% endif %}">
                                                        {{ asset.status.value if asset.status else 'Unknown' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="flex gap-2">
                                                        <button onclick="viewAsset('{{ asset.id }}')" class="text-blue-600 hover:text-blue-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                            </svg>
                                                        </button>
                                                        <button onclick="unlinkAsset('{{ asset.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-gray-500 py-4">No assets assigned to this case</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                        </div>
                    </div>

                    <!-- Outbound Tracking Section for Asset Checkout Categories and Custom Categories with Tracking -->
                    {% if (ticket.category and (ticket.category.name == 'ASSET_CHECKOUT_MAIN' or 
                          ticket.category.name == 'ASSET_CHECKOUT_CLAW' or 
                          ticket.category.name == 'ASSET_CHECKOUT_SINGPOST' or 
                          ticket.category.name == 'ASSET_CHECKOUT_DHL' or 
                          ticket.category.name == 'ASSET_CHECKOUT_UPS' or 
                          ticket.category.name == 'ASSET_CHECKOUT_BLUEDART' or 
                          ticket.category.name == 'ASSET_CHECKOUT_DTDC' or 
                          ticket.category.name == 'ASSET_CHECKOUT_AUTO')) or 
                          (ticket.shipping_tracking and ticket.category and ticket.category.name not in ['ASSET_RETURN_CLAW']) or 
                          (not ticket.category and ticket.has_custom_section('shipping_tracking')) %}
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <h2 class="sf-card-title">Outbound Tracking</h2>
                                    {% if ticket.shipping_status %}
                                    <span class="sf-badge {% if ticket.shipping_status == 'Delivered' %}sf-badge-success{% elif ticket.shipping_status == 'In Transit' %}sf-badge-info{% else %}sf-badge-warning{% endif %}">
                                        {{ ticket.shipping_status }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div>
                                {% if ticket.shipping_status != 'Received' %}
                                <button class="sf-button" onclick="markOutboundAsReceived('{{ ticket.id }}')">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Mark as Received
                                </button>
                                {% endif %}
                                <button id="addOutboundTrackingBtn" class="sf-button primary-button" onclick="showAddOutboundTrackingModal()">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    {% if ticket.shipping_tracking %}
                                    Edit Tracking
                                    {% else %}
                                    Add Tracking
                                    {% endif %}
                                </button>
                                </div>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="p-4">
                                {% if ticket.shipping_tracking %}
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <div class="text-sm text-gray-500">Tracking Number</div>
                                        <div class="font-medium">{{ ticket.shipping_tracking }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Carrier</div>
                                        <div class="font-medium">{{ ticket.shipping_carrier|title }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Status</div>
                                        <div class="font-medium">{{ ticket.shipping_status }}</div>
                                    </div>
                                </div>
                                <div class="mt-4 border-t pt-3">
                                    <button id="refreshShippingTrackingBtn" class="text-sm text-blue-600 flex items-center" onclick="fetchShippingTracking()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Refresh Tracking Information
                                    </button>
                                    <div id="trackingResults" class="mt-4">
                                        <input type="hidden" id="trackingNumber" value="{{ ticket.shipping_tracking }}">
                                        <h4 class="font-medium text-gray-700 mb-2">Tracking Events:</h4>
                                        <div id="trackingEvents" class="bg-gray-50 p-3 rounded text-sm">Loading tracking data...</div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-gray-500 py-4">
                                    No outbound tracking information available
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                    <!-- Outbound Tracking Card -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <h2 class="sf-card-title">Outbound Tracking</h2>
                                    {% if ticket.shipping_status %}
                                    <span class="sf-badge {% if ticket.shipping_status == 'Delivered' %}sf-badge-success{% elif ticket.shipping_status == 'In Transit' %}sf-badge-info{% else %}sf-badge-warning{% endif %}">
                                        {{ ticket.shipping_status }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div>
                                {% if ticket.shipping_status != 'Received' %}
                                <button class="sf-button" onclick="markOutboundAsReceived('{{ ticket.id }}')">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Mark as Received
                                </button>
                                {% endif %}
                                <button id="addOutboundTrackingBtn" class="sf-button primary-button" onclick="showAddOutboundTrackingModal()">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    {% if ticket.shipping_tracking %}
                                    Edit Tracking
                                    {% else %}
                                    Add Tracking
                                    {% endif %}
                                </button>
                                </div>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="p-4">
                                {% if ticket.shipping_tracking %}
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <div class="text-sm text-gray-500">Tracking Number</div>
                                        <div class="font-medium">{{ ticket.shipping_tracking }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Carrier</div>
                                        <div class="font-medium">{{ ticket.shipping_carrier|title }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Status</div>
                                        <div class="font-medium">{{ ticket.shipping_status }}</div>
                                    </div>
                                </div>
                                <div class="mt-4 border-t pt-3">
                                    <button id="refreshShippingTrackingBtn" class="text-sm text-blue-600 flex items-center" onclick="fetchShippingTracking()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Refresh Tracking Information
                                    </button>
                                    <div id="trackingResults" class="mt-4">
                                        <input type="hidden" id="trackingNumber" value="{{ ticket.shipping_tracking }}">
                                        <h4 class="font-medium text-gray-700 mb-2">Tracking Events:</h4>
                                        <div id="trackingEvents" class="bg-gray-50 p-3 rounded text-sm">Loading tracking data...</div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-gray-500 py-4">
                                    No outbound tracking information available
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Return Tracking Card -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <h2 class="sf-card-title">Return Tracking</h2>
                                    {% if ticket.return_status %}
                                    <span class="sf-badge {% if ticket.return_status == 'Delivered' %}sf-badge-success{% elif ticket.return_status == 'In Transit' %}sf-badge-info{% else %}sf-badge-warning{% endif %}">
                                        {{ ticket.return_status }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div>
                                {% if ticket.return_status != 'Received' %}
                                <button class="sf-button" onclick="markReturnAsReceived('{{ ticket.id }}')">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Mark as Received
                                </button>
                                {% endif %}
                                <button id="addReturnTrackingBtn" class="sf-button primary-button" onclick="showAddReturnTrackingModal()">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    {% if ticket.return_tracking %}
                                    Edit Tracking
                                    {% else %}
                                    Add Tracking
                                    {% endif %}
                                </button>
                                </div>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="p-4">
                                {% if ticket.return_tracking %}
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <div class="text-sm text-gray-500">Tracking Number</div>
                                        <div class="font-medium">{{ ticket.return_tracking }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Carrier</div>
                                        <div class="font-medium">{{ ticket.return_carrier|title }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Status</div>
                                        <div class="font-medium">{{ ticket.return_status }}</div>
                                    </div>
                                </div>
                                <div class="mt-4 border-t pt-3">
                                    <button id="refreshReturnTrackingBtn" class="text-sm text-blue-600 flex items-center" onclick="fetchReturnTracking()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Refresh Tracking Information
                                    </button>
                                    <div id="returnTrackingResults" class="mt-4">
                                        <input type="hidden" id="returnTrackingNumber" value="{{ ticket.return_tracking }}">
                                        <h4 class="font-medium text-gray-700 mb-2">Tracking Events:</h4>
                                        <div id="returnTrackingEvents" class="bg-gray-50 p-3 rounded text-sm">
                                            <div class="text-center">
                                                <div role="status">
                                                    <svg aria-hidden="true" class="inline w-8 h-8 text-gray-200 animate-spin fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                                                        <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                                                    </svg>
                                                    <span class="sr-only">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-sm text-gray-600">Loading tracking data...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-gray-500 py-4">
                                    No return tracking information available
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- General Tracking Section for Custom Categories -->
                    {% if (ticket.category and ticket.category.name not in ['ASSET_CHECKOUT_MAIN', 'ASSET_CHECKOUT_CLAW', 'ASSET_CHECKOUT_SINGPOST', 'ASSET_CHECKOUT_DHL', 'ASSET_CHECKOUT_UPS', 'ASSET_CHECKOUT_BLUEDART', 'ASSET_CHECKOUT_DTDC', 'ASSET_CHECKOUT_AUTO', 'ASSET_RETURN_CLAW']) or (not ticket.category and ticket.has_custom_section('shipping_tracking')) %}
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <h2 class="sf-card-title">Shipping Tracking</h2>
                                    {% if ticket.shipping_status %}
                                    <span class="sf-badge {% if ticket.shipping_status == 'Delivered' %}sf-badge-success{% elif ticket.shipping_status == 'In Transit' %}sf-badge-info{% else %}sf-badge-warning{% endif %}">
                                        {{ ticket.shipping_status }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div>
                                <button id="addGeneralTrackingBtn" class="sf-button primary-button" onclick="showAddOutboundTrackingModal()">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    {% if ticket.shipping_tracking %}
                                    Edit Tracking
                                    {% else %}
                                    Add Tracking
                                    {% endif %}
                                </button>
                                </div>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="p-4">
                                {% if ticket.shipping_tracking %}
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <div class="text-sm text-gray-500">Tracking Number</div>
                                        <div class="font-medium">{{ ticket.shipping_tracking }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Carrier</div>
                                        <div class="font-medium">{{ ticket.shipping_carrier|title if ticket.shipping_carrier else 'Auto-Detect' }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Status</div>
                                        <div class="font-medium">{{ ticket.shipping_status if ticket.shipping_status else 'Pending' }}</div>
                                    </div>
                                </div>
                                <div class="mt-4 border-t pt-3">
                                    <button id="refreshGeneralTrackingBtn" class="text-sm text-blue-600 flex items-center" onclick="fetchShippingTracking()">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Refresh Tracking Information
                                    </button>
                                    <div id="generalTrackingResults" class="mt-4">
                                        <input type="hidden" id="generalTrackingNumber" value="{{ ticket.shipping_tracking }}">
                                        <h4 class="font-medium text-gray-700 mb-2">Tracking Events:</h4>
                                        <div id="generalTrackingEvents" class="bg-gray-50 p-3 rounded text-sm">Loading tracking data...</div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-gray-500 py-4">
                                    No shipping tracking information available.
                                    <br>
                                    <span class="text-sm">Click "Add Tracking" above to add shipping information for this ticket.</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Accessories Card -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <h2 class="sf-card-title">Received Accessories</h2>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="overflow-x-auto">
                                <table class="sf-data-table">
                                    <thead>
                                        <tr>
                                            <th>NAME</th>
                                            <th>CATEGORY</th>
                                            <th>QUANTITY</th>
                                            <th>CONDITION</th>
                                            <th>ACTIONS</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accessoryTableBody">
                                        {% if ticket.accessories %}
                                            {% for accessory in ticket.accessories %}
                                            <tr>
                                                <td>{{ accessory.name }}</td>
                                                <td>{{ accessory.category }}</td>
                                                <td>{{ accessory.quantity }}</td>
                                                <td>
                                                    <span class="sf-badge {% if accessory.condition == 'Good' %}sf-badge-success{% elif accessory.condition == 'Fair' %}sf-badge-warning{% else %}sf-badge-danger{% endif %}">
                                                        {{ accessory.condition }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="flex gap-2">
                                                        <button onclick="editAccessory('{{ accessory.id }}')" class="text-blue-600 hover:text-blue-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                        </button>
                                                        <button onclick="removeAccessory('{{ accessory.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-gray-500 py-4">No accessories recorded for this return</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Method 3: Direct link to form action -->
                    <div id="directAccessorySectionCheckout" style="text-align: center; margin: 20px 0; padding: 20px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid #ddd;">
                        <h3 style="margin-bottom: 15px;">Add Accessories directly</h3>
                        
                        <!-- Tab navigation for "New Accessory" and "Select Existing" -->
                        <div style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                            <button id="newAccessoryTab" onclick="switchTab('new')" style="flex: 1; padding: 10px; background-color: #e5e7eb; color: #374151; border: none; border-radius: 4px 0 0 0; cursor: pointer;">
                                Add New
                            </button>
                            <button id="existingAccessoryTab" onclick="switchTab('existing')" style="flex: 1; padding: 10px; background-color: #3b82f6; color: white; border: none; border-radius: 0 4px 0 0; cursor: pointer;">
                                Select Existing
                            </button>
                        </div>
                        
                        <!-- New Accessory Form -->
                        <form id="simpleAccessoryForm" method="POST" action="{{ url_for('tickets.add_accessory', ticket_id=ticket.id) | replace('/add_accessory', '/add-accessory') }}" style="display: none;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Accessory Name</label>
                                <input type="text" name="accessory_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
                                <select name="accessory_category" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Select Category --</option>
                                    <option value="Keyboard">Keyboard</option>
                                    <option value="Mouse">Mouse</option>
                                    <option value="Cable">Cable</option>
                                    <option value="Adapter">Adapter</option>
                                    <option value="Power Brick">Power Brick</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Manufacturer</label>
                                <input type="text" name="manufacturer" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Model Number</label>
                                <input type="text" name="model_no" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Total Quantity</label>
                                <input type="number" name="total_quantity" min="1" value="1" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Country</label>
                                <select name="country" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select a country...</option>
                                    <option value="USA">USA</option>
                                    <option value="Japan">Japan</option>
                                    <option value="Philippines">Philippines</option>
                                    <option value="Australia">Australia</option>
                                    <option value="Israel">Israel</option>
                                    <option value="India">India</option>
                                    <option value="Singapore">Singapore</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Quantity for this Ticket</label>
                                <input type="number" name="accessory_quantity" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add New Accessory
                                </button>
                            </div>
                        </form>
                        
                        <!-- Existing Accessory Selection Form -->
                        <form id="existingAccessoryForm" onsubmit="submitExistingAccessoryForm(event)" style="display: block;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Existing Accessory</label>
                                <select id="existing_accessory_select" name="existing_accessory_id" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Loading Accessories --</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Quantity</label>
                                <input id="accessory_quantity_input" type="number" name="accessory_quantity" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add Selected Accessory
                                </button>
                            </div>
                        </form>
                        
                        <!-- JavaScript for tab switching and loading accessories -->
                        <script>
                            // Store the CSRF token for JavaScript use
                            const csrfToken = '{{ csrf_token() }}';
                            console.log("CSRF token initialized:", csrfToken ? "OK" : "MISSING");
                            
                            // Function to switch between tabs
                            function switchTab(tab) {
                                console.log(`Switching to tab: ${tab}`);
                                if (tab === 'new') {
                                    document.getElementById('simpleAccessoryForm').style.display = 'block';
                                    document.getElementById('existingAccessoryForm').style.display = 'none';
                                    document.getElementById('newAccessoryTab').style.backgroundColor = '#3b82f6';
                                    document.getElementById('newAccessoryTab').style.color = 'white';
                                    document.getElementById('existingAccessoryTab').style.backgroundColor = '#e5e7eb';
                                    document.getElementById('existingAccessoryTab').style.color = '#374151';
                                } else {
                                    document.getElementById('simpleAccessoryForm').style.display = 'none';
                                    document.getElementById('existingAccessoryForm').style.display = 'block';
                                    document.getElementById('newAccessoryTab').style.backgroundColor = '#e5e7eb';
                                    document.getElementById('newAccessoryTab').style.color = '#374151';
                                    document.getElementById('existingAccessoryTab').style.backgroundColor = '#3b82f6';
                                    document.getElementById('existingAccessoryTab').style.color = 'white';
                                    
                                    // Load accessories regardless of whether they've been loaded before
                                    // This ensures accessories are always loaded when this tab is selected
                                    console.log('Loading accessories for existing tab');
                                    loadAccessories();
                                }
                            }
                            
                            // Function to load available accessories
                            function loadAccessories() {
                                console.log("LOADING ACCESSORIES: Starting fetch request...");
                                
                                // Use the correct API endpoint
                                const absoluteUrl = `${window.CURRENT_ORIGIN}/tickets/api/accessories`;
                                
                                console.log("Using URL:", absoluteUrl);
                                console.log("CSRF Token:", csrfToken);
                                
                                // Show loading state in dropdown
                                const select = document.getElementById('existing_accessory_select');
                                if (select) {
                                    select.innerHTML = '<option value="">-- Loading Accessories... --</option>';
                                    select.disabled = true;
                                }
                                
                                try {
                                    fetch(absoluteUrl, {
                                        method: 'GET',
                                        credentials: 'include',  // Include cookies for authentication
                                        headers: {
                                            'X-Requested-With': 'XMLHttpRequest',
                                            'Accept': 'application/json',
                                            'X-CSRFToken': csrfToken
                                        }
                                    })
                                    .then(response => {
                                        console.log("FETCH RESPONSE:", response.status, response.statusText);
                                        console.log("Response headers:", response.headers);
                                        
                                        if (!response.ok) {
                                            // Log the response text for debugging
                                            return response.text().then(text => {
                                                console.error("Response text:", text);
                                                throw new Error(`HTTP error! Status: ${response.status}, Response: ${text.substring(0, 200)}`);
                                            });
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        console.log("FETCH SUCCESS, data:", data);
                                        const select = document.getElementById('existing_accessory_select');
                                        if (!select) {
                                            console.error("Select element not found!");
                                            return;
                                        }
                                        
                                        // Enable the select
                                        select.disabled = false;
                                        
                                        // Clear existing options
                                        select.innerHTML = '<option value="">-- Select an Accessory --</option>';
                                        
                                        // Add accessories to dropdown
                                        if (data.success && data.accessories && data.accessories.length > 0) {
                                            // Sort accessories by name for better usability
                                            data.accessories.sort((a, b) => a.name.localeCompare(b.name));
                                            
                                            data.accessories.forEach(acc => {
                                                const option = document.createElement('option');
                                                option.value = acc.id;
                                                const displayName = `${acc.name} (${acc.category}) - Qty: ${acc.available_quantity}`;
                                                option.text = displayName;
                                                select.appendChild(option);
                                            });
                                            console.log(`Loaded ${data.accessories.length} accessories successfully`);
                                        } else {
                                            // No accessories found - let's also try to call debug endpoint
                                            const option = document.createElement('option');
                                            option.value = "";
                                            option.text = "No accessories available";
                                            select.appendChild(option);
                                            console.log('No accessories found - calling debug endpoint for more info');
                                            
                                            // Call debug endpoint to get more information
                                            fetch(`${window.CURRENT_ORIGIN}/tickets/api/accessories/debug`, {
                                                method: 'GET',
                                                credentials: 'include',
                                                headers: {
                                                    'X-Requested-With': 'XMLHttpRequest',
                                                    'Accept': 'application/json',
                                                    'X-CSRFToken': csrfToken
                                                }
                                            })
                                            .then(debugResponse => debugResponse.json())
                                            .then(debugData => {
                                                console.log("DEBUG INFO:", debugData);
                                            })
                                            .catch(debugError => {
                                                console.error("Debug endpoint error:", debugError);
                                            });
                                        }
                                        
                                        window.accessoriesLoaded = true;
                                    })
                                    .catch(error => {
                                        console.error('Error loading accessories:', error);
                                        
                                        // Update the dropdown to show the error
                                        const select = document.getElementById('existing_accessory_select');
                                        if (select) {
                                            select.disabled = false;
                                            select.innerHTML = '<option value="">-- Error Loading Accessories --</option>';
                                        }
                                    });
                                } catch (error) {
                                    console.error('Critical error in fetch:', error);
                                    const select = document.getElementById('existing_accessory_select');
                                    if (select) {
                                        select.disabled = false;
                                        select.innerHTML = '<option value="">-- Error Loading Accessories --</option>';
                                    }
                                }
                            }
                            
                            // Function to handle existing accessory form submission
                            window.submitExistingAccessoryForm = function(event) {
                                event.preventDefault();
                                console.log("Form submission detected for existing accessory");
                                
                                // Get form data
                                const form = event.target;
                                const accessoryId = document.getElementById('existing_accessory_select').value;
                                // Get quantity from input
                                const quantity = parseInt(document.getElementById('accessory_quantity_input').value);
                                const condition = document.querySelector('#existingAccessoryForm select[name="accessory_condition"]').value;
                                const notes = document.querySelector('#existingAccessoryForm textarea[name="accessory_notes"]').value;
                                
                                // Validation
                                if (!accessoryId || accessoryId === "") {
                                    alert("Please select an accessory");
                                    return;
                                }
                                
                                if (isNaN(quantity) || quantity < 1) {
                                    alert("Quantity must be at least 1");
                                    return;
                                }
                                
                                console.log(`Submitting: Accessory ID=${accessoryId}, Quantity=${quantity}, Condition=${condition}`);
                                
                                // Create the data to send - matching what the server expects
                                const formData = {
                                    existing_accessory_id: accessoryId,
                                    accessory_quantity: quantity,
                                    accessory_condition: condition,
                                    accessory_notes: notes
                                };
                                
                                // Show loading indicator
                                const submitButton = form.querySelector('button[type="submit"]');
                                const originalText = submitButton.textContent;
                                submitButton.disabled = true;
                                submitButton.textContent = "Processing...";
                                
                                // Send the data via AJAX
                                fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add-accessory`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': csrfToken,
                                        'X-Requested-With': 'XMLHttpRequest'
                                    },
                                    body: JSON.stringify(formData)
                                })
                                .then(response => {
                                    console.log("Response status:", response.status);
                                    // Check if response is ok before trying to parse JSON
                                    if (response.ok) {
                                        return response.json();
                                    } else {
                                        // For error responses, just get the text
                                        return response.text().then(text => {
                                            // Try to parse JSON error response if possible
                                            try {
                                                return JSON.parse(text);
                                            } catch (e) {
                                                // If not JSON, return simple error object
                                                throw new Error(`HTTP error! Status: ${response.status}, Message: ${text || "Unknown error"}`);
                                            }
                                        });
                                    }
                                })
                                .then(data => {
                                    console.log("Form submission response:", data);
                                    if (data.success) {
                                        // Show success message
                                        alert(`Successfully added ${quantity} ${data.accessory ? data.accessory.name : 'accessory'} to the ticket`);
                                        
                                        // Clear the form
                                        form.reset();
                                        
                                        // Reload the page to show the updated accessories list
                                        window.location.reload();
                                    } else {
                                        alert("Error: " + (data.message || "Unknown error occurred"));
                                    }
                                })
                                .catch(error => {
                                    console.error("Error submitting form:", error);
                                    alert(`Error: ${error.message || "Unknown error occurred"}`);
                                })
                                .finally(() => {
                                    // Re-enable the button
                                    submitButton.disabled = false;
                                    submitButton.textContent = originalText;
                                });
                            };
                            
                            // Call loadAccessories right away on page load
                            console.log("Calling loadAccessories() immediately");
                            loadAccessories();
                            
                            // Also set up DOMContentLoaded event just in case
                            document.addEventListener('DOMContentLoaded', function() {
                                console.log("DOMContentLoaded: Calling loadAccessories() again");
                                loadAccessories();
                            });
                        </script>
                    </div>
                    
                    {% endif %}

                    <!-- Accessories Section for Asset Checkout Categories -->
                    {% if ticket.category and (ticket.category.name == 'ASSET_CHECKOUT_MAIN' or 
                          ticket.category.name == 'ASSET_CHECKOUT_CLAW' or 
                          ticket.category.name == 'ASSET_CHECKOUT_SINGPOST' or 
                          ticket.category.name == 'ASSET_CHECKOUT_DHL' or 
                          ticket.category.name == 'ASSET_CHECKOUT_UPS' or 
                          ticket.category.name == 'ASSET_CHECKOUT_BLUEDART' or 
                          ticket.category.name == 'ASSET_CHECKOUT_DTDC' or 
                          ticket.category.name == 'ASSET_CHECKOUT_AUTO') %}
                    <!-- Accessories Card for Asset Checkout -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <h2 class="sf-card-title">Checkout Accessories</h2>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="overflow-x-auto">
                                <table class="sf-data-table">
                                    <thead>
                                        <tr>
                                            <th>NAME</th>
                                            <th>CATEGORY</th>
                                            <th>QUANTITY</th>
                                            <th>CONDITION</th>
                                            <th>ACTIONS</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accessoryTableBodyCheckout">
                                        {% if ticket.accessories %}
                                            {% for accessory in ticket.accessories %}
                                            <tr>
                                                <td>{{ accessory.name }}</td>
                                                <td>{{ accessory.category }}</td>
                                                <td>{{ accessory.quantity }}</td>
                                                <td>
                                                    <span class="sf-badge {% if accessory.condition == 'Good' %}sf-badge-success{% elif accessory.condition == 'Fair' %}sf-badge-warning{% else %}sf-badge-danger{% endif %}">
                                                        {{ accessory.condition }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="flex gap-2">
                                                        <button onclick="editAccessory('{{ accessory.id }}')" class="text-blue-600 hover:text-blue-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                        </button>
                                                        <button onclick="removeAccessory('{{ accessory.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-gray-500 py-4">No accessories recorded for this checkout</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Method 3: Direct link to form action for Asset Checkout -->
                    <div id="directAccessorySectionCheckout" style="text-align: center; margin: 20px 0; padding: 20px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid #ddd;">
                        <h3 style="margin-bottom: 15px;">Add Accessories directly</h3>
                        
                        {% if ticket.category and ticket.category.name in ['ASSET_CHECKOUT_CLAW', 'ASSET_CHECKOUT_MAIN', 'ASSET_CHECKOUT_SINGPOST', 'ASSET_CHECKOUT_DHL', 'ASSET_CHECKOUT_UPS', 'ASSET_CHECKOUT_BLUEDART', 'ASSET_CHECKOUT_DTDC', 'ASSET_CHECKOUT_AUTO'] %}
                        <div style="background-color: #fef3c7; border: 1px solid #f59e0b; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                            <p style="margin: 0; color: #92400e; font-weight: 500;">
                                ⚠️ Asset Checkout: Adding accessories will <strong>deduct</strong> them from inventory.
                            </p>
                        </div>
                        {% else %}
                        <div style="background-color: #d1fae5; border: 1px solid #10b981; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                            <p style="margin: 0; color: #047857; font-weight: 500;">
                                ✅ Asset Return: Adding accessories will <strong>add</strong> them to inventory.
                            </p>
                        </div>
                        {% endif %}
                        
                        <!-- Tab navigation for "New Accessory" and "Select Existing" -->
                        <div style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                            <button id="newAccessoryTabCheckout" onclick="switchTabCheckout('new')" style="flex: 1; padding: 10px; background-color: #e5e7eb; color: #374151; border: none; border-radius: 4px 0 0 0; cursor: pointer;">
                                Add New
                            </button>
                            <button id="existingAccessoryTabCheckout" onclick="switchTabCheckout('existing')" style="flex: 1; padding: 10px; background-color: #3b82f6; color: white; border: none; border-radius: 0 4px 0 0; cursor: pointer;">
                                Select Existing
                            </button>
                            
                            <script>
                            // Define the checkout tab switching function
                            function switchTabCheckout(tab) {
                                console.log(`Switching to checkout tab: ${tab}`);
                                if (tab === 'new') {
                                    const newForm = document.getElementById('simpleAccessoryFormCheckout') || document.getElementById('simpleAccessoryForm');
                                    const existingForm = document.getElementById('existingAccessoryFormCheckout') || document.getElementById('existingAccessoryForm');
                                    const newTab = document.getElementById('newAccessoryTabCheckout') || document.getElementById('newAccessoryTab');
                                    const existingTab = document.getElementById('existingAccessoryTabCheckout') || document.getElementById('existingAccessoryTab');
                                    
                                    if (newForm) newForm.style.display = 'block';
                                    if (existingForm) existingForm.style.display = 'none';
                                    if (newTab) {
                                        newTab.style.backgroundColor = '#3b82f6';
                                        newTab.style.color = 'white';
                                    }
                                    if (existingTab) {
                                        existingTab.style.backgroundColor = '#e5e7eb';
                                        existingTab.style.color = '#374151';
                                    }
                                } else {
                                    const newForm = document.getElementById('simpleAccessoryFormCheckout') || document.getElementById('simpleAccessoryForm');
                                    const existingForm = document.getElementById('existingAccessoryFormCheckout') || document.getElementById('existingAccessoryForm');
                                    const newTab = document.getElementById('newAccessoryTabCheckout') || document.getElementById('newAccessoryTab');
                                    const existingTab = document.getElementById('existingAccessoryTabCheckout') || document.getElementById('existingAccessoryTab');
                                    
                                    if (newForm) newForm.style.display = 'none';
                                    if (existingForm) existingForm.style.display = 'block';
                                    if (newTab) {
                                        newTab.style.backgroundColor = '#e5e7eb';
                                        newTab.style.color = '#374151';
                                    }
                                    if (existingTab) {
                                        existingTab.style.backgroundColor = '#3b82f6';
                                        existingTab.style.color = 'white';
                                    }
                                }
                            }
                            </script>
                        </div>
                        
                        <!-- New Accessory Form -->
                        <form id="simpleAccessoryForm" method="POST" action="{{ url_for('tickets.add_accessory', ticket_id=ticket.id) | replace('/add_accessory', '/add-accessory') }}" style="display: none;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Accessory Name</label>
                                <input type="text" name="accessory_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
                                <select name="accessory_category" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Select Category --</option>
                                    <option value="Keyboard">Keyboard</option>
                                    <option value="Mouse">Mouse</option>
                                    <option value="Cable">Cable</option>
                                    <option value="Adapter">Adapter</option>
                                    <option value="Power Brick">Power Brick</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Manufacturer</label>
                                <input type="text" name="manufacturer" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Model Number</label>
                                <input type="text" name="model_no" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Total Quantity</label>
                                <input type="number" name="total_quantity" min="1" value="1" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Country</label>
                                <select name="country" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select a country...</option>
                                    <option value="USA">USA</option>
                                    <option value="Japan">Japan</option>
                                    <option value="Philippines">Philippines</option>
                                    <option value="Australia">Australia</option>
                                    <option value="Israel">Israel</option>
                                    <option value="India">India</option>
                                    <option value="Singapore">Singapore</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add New Accessory
                                </button>
                            </div>
                        </form>
                        
                        <!-- Existing Accessory Selection Form -->
                        <form id="existingAccessoryForm" onsubmit="submitExistingAccessoryForm(event)" style="display: block;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Existing Accessory</label>
                                <select id="existing_accessory_select" name="existing_accessory_id" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Loading Accessories --</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Quantity</label>
                                <input id="accessory_quantity_input" type="number" name="accessory_quantity" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add Selected Accessory
                                </button>
                            </div>
                        </form>
                        
                        <!-- JavaScript for tab switching and loading accessories -->
                        <script>
                            // Store the CSRF token for JavaScript use
                            // Using csrfToken = '{{ csrf_token() }}';
                            console.log("CSRF token initialized:", csrfToken ? "OK" : "MISSING");
                            
                            // Function to switch between tabs
                            function switchTab(tab) {
                                console.log(`Switching to tab: ${tab}`);
                                if (tab === 'new') {
                                    document.getElementById('simpleAccessoryForm').style.display = 'block';
                                    document.getElementById('existingAccessoryForm').style.display = 'none';
                                    document.getElementById('newAccessoryTab').style.backgroundColor = '#3b82f6';
                                    document.getElementById('newAccessoryTab').style.color = 'white';
                                    document.getElementById('existingAccessoryTab').style.backgroundColor = '#e5e7eb';
                                    document.getElementById('existingAccessoryTab').style.color = '#374151';
                                } else {
                                    document.getElementById('simpleAccessoryForm').style.display = 'none';
                                    document.getElementById('existingAccessoryForm').style.display = 'block';
                                    document.getElementById('newAccessoryTab').style.backgroundColor = '#e5e7eb';
                                    document.getElementById('newAccessoryTab').style.color = '#374151';
                                    document.getElementById('existingAccessoryTab').style.backgroundColor = '#3b82f6';
                                    document.getElementById('existingAccessoryTab').style.color = 'white';
                                    
                                    // Load accessories regardless of whether they've been loaded before
                                    // This ensures accessories are always loaded when this tab is selected
                                    console.log('Loading accessories for existing tab');
                                    loadAccessories();
                                }
                            }
                            
                            // Function to load available accessories
                            function loadAccessories() {
                                console.log("LOADING ACCESSORIES: Starting fetch request...");
                                
                                // Use the correct API endpoint
                                const absoluteUrl = `${window.CURRENT_ORIGIN}/tickets/api/accessories`;
                                
                                console.log("Using URL:", absoluteUrl);
                                console.log("CSRF Token:", csrfToken);
                                
                                // Show loading state in dropdown
                                const select = document.getElementById('existing_accessory_select');
                                if (select) {
                                    select.innerHTML = '<option value="">-- Loading Accessories... --</option>';
                                    select.disabled = true;
                                }
                                
                                try {
                                    fetch(absoluteUrl, {
                                        method: 'GET',
                                        credentials: 'include',  // Include cookies for authentication
                                        headers: {
                                            'X-Requested-With': 'XMLHttpRequest',
                                            'Accept': 'application/json',
                                            'X-CSRFToken': csrfToken
                                        }
                                    })
                                    .then(response => {
                                        console.log("FETCH RESPONSE:", response.status, response.statusText);
                                        console.log("Response headers:", response.headers);
                                        
                                        if (!response.ok) {
                                            // Log the response text for debugging
                                            return response.text().then(text => {
                                                console.error("Response text:", text);
                                                throw new Error(`HTTP error! Status: ${response.status}, Response: ${text.substring(0, 200)}`);
                                            });
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        console.log("FETCH SUCCESS, data:", data);
                                        const select = document.getElementById('existing_accessory_select');
                                        if (!select) {
                                            console.error("Select element not found!");
                                            return;
                                        }
                                        
                                        // Enable the select
                                        select.disabled = false;
                                        
                                        // Clear existing options
                                        select.innerHTML = '<option value="">-- Select an Accessory --</option>';
                                        
                                        // Add accessories to dropdown
                                        if (data.success && data.accessories && data.accessories.length > 0) {
                                            // Sort accessories by name for better usability
                                            data.accessories.sort((a, b) => a.name.localeCompare(b.name));
                                            
                                            data.accessories.forEach(acc => {
                                                const option = document.createElement('option');
                                                option.value = acc.id;
                                                const displayName = `${acc.name} (${acc.category}) - Qty: ${acc.available_quantity}`;
                                                option.text = displayName;
                                                select.appendChild(option);
                                            });
                                            console.log(`Loaded ${data.accessories.length} accessories successfully`);
                                        } else {
                                            // No accessories found - let's also try to call debug endpoint
                                            const option = document.createElement('option');
                                            option.value = "";
                                            option.text = "No accessories available";
                                            select.appendChild(option);
                                            console.log('No accessories found - calling debug endpoint for more info');
                                            
                                            // Call debug endpoint to get more information
                                            fetch(`${window.CURRENT_ORIGIN}/tickets/api/accessories/debug`, {
                                                method: 'GET',
                                                credentials: 'include',
                                                headers: {
                                                    'X-Requested-With': 'XMLHttpRequest',
                                                    'Accept': 'application/json',
                                                    'X-CSRFToken': csrfToken
                                                }
                                            })
                                            .then(debugResponse => debugResponse.json())
                                            .then(debugData => {
                                                console.log("DEBUG INFO:", debugData);
                                            })
                                            .catch(debugError => {
                                                console.error("Debug endpoint error:", debugError);
                                            });
                                        }
                                        
                                        window.accessoriesLoaded = true;
                                    })
                                    .catch(error => {
                                        console.error('Error loading accessories:', error);
                                        
                                        // Update the dropdown to show the error
                                        const select = document.getElementById('existing_accessory_select');
                                        if (select) {
                                            select.disabled = false;
                                            select.innerHTML = '<option value="">-- Error Loading Accessories --</option>';
                                        }
                                    });
                                } catch (error) {
                                    console.error('Critical error in fetch:', error);
                                    const select = document.getElementById('existing_accessory_select');
                                    if (select) {
                                        select.disabled = false;
                                        select.innerHTML = '<option value="">-- Error Loading Accessories --</option>';
                                    }
                                }
                            }
                            
                            // Function to handle existing accessory form submission
                            window.submitExistingAccessoryForm = function(event) {
                                event.preventDefault();
                                console.log("Form submission detected for existing accessory");
                                
                                // Get form data
                                const form = event.target;
                                const accessoryId = document.getElementById('existing_accessory_select').value;
                                // Get quantity from input
                                const quantity = parseInt(document.getElementById('accessory_quantity_input').value);
                                const condition = document.querySelector('#existingAccessoryForm select[name="accessory_condition"]').value;
                                const notes = document.querySelector('#existingAccessoryForm textarea[name="accessory_notes"]').value;
                                
                                // Validation
                                if (!accessoryId || accessoryId === "") {
                                    alert("Please select an accessory");
                                    return;
                                }
                                
                                if (isNaN(quantity) || quantity < 1) {
                                    alert("Quantity must be at least 1");
                                    return;
                                }
                                
                                console.log(`Submitting: Accessory ID=${accessoryId}, Quantity=${quantity}, Condition=${condition}`);
                                
                                // Create the data to send - matching what the server expects
                                const formData = {
                                    existing_accessory_id: accessoryId,
                                    accessory_quantity: quantity,
                                    accessory_condition: condition,
                                    accessory_notes: notes
                                };
                                
                                // Show loading indicator
                                const submitButton = form.querySelector('button[type="submit"]');
                                const originalText = submitButton.textContent;
                                submitButton.disabled = true;
                                submitButton.textContent = "Processing...";
                                
                                // Send the data via AJAX
                                fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add-accessory`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': csrfToken,
                                        'X-Requested-With': 'XMLHttpRequest'
                                    },
                                    body: JSON.stringify(formData)
                                })
                                .then(response => {
                                    console.log("Response status:", response.status);
                                    // Check if response is ok before trying to parse JSON
                                    if (response.ok) {
                                        return response.json();
                                    } else {
                                        // For error responses, just get the text
                                        return response.text().then(text => {
                                            // Try to parse JSON error response if possible
                                            try {
                                                return JSON.parse(text);
                                            } catch (e) {
                                                // If not JSON, return simple error object
                                                throw new Error(`HTTP error! Status: ${response.status}, Message: ${text || "Unknown error"}`);
                                            }
                                        });
                                    }
                                })
                                .then(data => {
                                    console.log("Form submission response:", data);
                                    if (data.success) {
                                        // Show success message
                                        alert(`Successfully added ${quantity} ${data.accessory ? data.accessory.name : 'accessory'} to the ticket`);
                                        
                                        // Clear the form
                                        form.reset();
                                        
                                        // Reload the page to show the updated accessories list
                                        window.location.reload();
                                    } else {
                                        alert("Error: " + (data.message || "Unknown error occurred"));
                                    }
                                })
                                .catch(error => {
                                    console.error("Error submitting form:", error);
                                    alert(`Error: ${error.message || "Unknown error occurred"}`);
                                })
                                .finally(() => {
                                    // Re-enable the button
                                    submitButton.disabled = false;
                                    submitButton.textContent = originalText;
                                });
                            };
                            
                            // Call loadAccessories right away on page load
                            console.log("Calling loadAccessories() immediately");
                            loadAccessories();
                            
                            // Also set up DOMContentLoaded event just in case
                            document.addEventListener('DOMContentLoaded', function() {
                                console.log("DOMContentLoaded: Calling loadAccessories() again");
                                loadAccessories();
                            });
                        </script>
                    </div>
                    {% endif %}

                    <!-- Accessories Section for Asset Intake -->
                    {% if ticket.category and ticket.category.name == 'ASSET_INTAKE' %}
                    <!-- Accessories Card for Asset Intake -->
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <div class="flex justify-between items-center">
                                <h2 class="sf-card-title">Received Accessories</h2>
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <div class="overflow-x-auto">
                                <table class="sf-data-table">
                                    <thead>
                                        <tr>
                                            <th>NAME</th>
                                            <th>CATEGORY</th>
                                            <th>QUANTITY</th>
                                            <th>CONDITION</th>
                                            <th>ACTIONS</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accessoryTableBody">
                                        {% if ticket.accessories %}
                                            {% for accessory in ticket.accessories %}
                                            <tr>
                                                <td>{{ accessory.name }}</td>
                                                <td>{{ accessory.category }}</td>
                                                <td>{{ accessory.quantity }}</td>
                                                <td>
                                                    <span class="sf-badge {% if accessory.condition == 'Good' %}sf-badge-success{% elif accessory.condition == 'Fair' %}sf-badge-warning{% else %}sf-badge-danger{% endif %}">
                                                        {{ accessory.condition }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="flex gap-2">
                                                        <button onclick="editAccessory('{{ accessory.id }}')" class="text-blue-600 hover:text-blue-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                        </button>
                                                        <button onclick="removeAccessory('{{ accessory.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-gray-500 py-4">No accessories recorded for this intake</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add Accessories directly for Asset Intake -->
                    <div id="directAccessorySectionIntake" style="text-align: center; margin: 20px 0; padding: 20px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid #ddd;">
                        <h3 style="margin-bottom: 15px;">Add Accessories directly</h3>
                        
                        <div style="background-color: #d1fae5; border: 1px solid #10b981; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                            <p style="margin: 0; color: #047857; font-weight: 500;">
                                📦 Asset Intake: Adding accessories will <strong>add</strong> them to inventory.
                            </p>
                        </div>
                        
                        <!-- Tab navigation for "New Accessory" and "Select Existing" -->
                        <div style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                            <button id="newAccessoryTab" onclick="switchTab('new')" style="flex: 1; padding: 10px; background-color: #e5e7eb; color: #374151; border: none; border-radius: 4px 0 0 0; cursor: pointer;">
                                Add New
                            </button>
                            <button id="existingAccessoryTab" onclick="switchTab('existing')" style="flex: 1; padding: 10px; background-color: #3b82f6; color: white; border: none; border-radius: 0 4px 0 0; cursor: pointer;">
                                Select Existing
                            </button>
                        </div>
                        
                        <!-- New Accessory Form -->
                        <form id="simpleAccessoryForm" onsubmit="submitNewAccessoryForm(event)" style="display: none;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Accessory Name</label>
                                <input type="text" name="accessory_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
                                <select name="accessory_category" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Select Category --</option>
                                    <option value="Keyboard">Keyboard</option>
                                    <option value="Mouse">Mouse</option>
                                    <option value="Cable">Cable</option>
                                    <option value="Adapter">Adapter</option>
                                    <option value="Power Brick">Power Brick</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Manufacturer</label>
                                <input type="text" name="manufacturer" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Model Number</label>
                                <input type="text" name="model_no" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Total Quantity</label>
                                <input type="number" name="total_quantity" min="1" value="1" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Country</label>
                                <select name="country" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select a country...</option>
                                    <option value="USA">USA</option>
                                    <option value="Japan">Japan</option>
                                    <option value="Philippines">Philippines</option>
                                    <option value="Australia">Australia</option>
                                    <option value="India">India</option>
                                    <option value="Singapore">Singapore</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add New Accessory
                                </button>
                            </div>
                        </form>
                        
                        <!-- Existing Accessory Selection Form -->
                        <form id="existingAccessoryForm" onsubmit="submitExistingAccessoryForm(event)" style="display: block;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Existing Accessory</label>
                                <select id="existing_accessory_select" name="existing_accessory_id" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- Loading Accessories --</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Quantity</label>
                                <input id="accessory_quantity_input" type="number" name="accessory_quantity" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                                <select name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                                <textarea name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button type="submit" style="padding: 8px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add Selected Accessory
                                </button>
                            </div>
                        </form>

                        <script>
                            // Get CSRF token from meta tag (for Asset Intake)
                            const csrfTokenIntake = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                            console.log("CSRF token for Asset Intake initialized:", csrfTokenIntake ? "OK" : "MISSING");
                            
                            // Function to switch between tabs for Asset Intake
                            function switchTab(tab) {
                                const newAccessoryTab = document.getElementById('newAccessoryTab');
                                const existingAccessoryTab = document.getElementById('existingAccessoryTab');
                                const newAccessoryForm = document.getElementById('simpleAccessoryForm');
                                const existingAccessoryForm = document.getElementById('existingAccessoryForm');

                                if (tab === 'new') {
                                    // Switch to "Add New" tab
                                    newAccessoryTab.style.backgroundColor = '#3b82f6';
                                    newAccessoryTab.style.color = 'white';
                                    existingAccessoryTab.style.backgroundColor = '#e5e7eb';
                                    existingAccessoryTab.style.color = '#374151';
                                    
                                    newAccessoryForm.style.display = 'block';
                                    existingAccessoryForm.style.display = 'none';
                                } else if (tab === 'existing') {
                                    // Switch to "Select Existing" tab
                                    existingAccessoryTab.style.backgroundColor = '#3b82f6';
                                    existingAccessoryTab.style.color = 'white';
                                    newAccessoryTab.style.backgroundColor = '#e5e7eb';
                                    newAccessoryTab.style.color = '#374151';
                                    
                                    existingAccessoryForm.style.display = 'block';
                                    newAccessoryForm.style.display = 'none';
                                }
                            }

                            // Function to load accessories for Asset Intake
                            function loadAccessories() {
                                fetch('/tickets/api/accessories')
                                    .then(response => response.json())
                                    .then(data => {
                                        const select = document.getElementById('existing_accessory_select');
                                        select.innerHTML = '<option value="">-- Select Accessory --</option>';
                                        
                                        if (data.success && data.accessories) {
                                            data.accessories.forEach(accessory => {
                                                const option = document.createElement('option');
                                                option.value = accessory.id;
                                                option.textContent = `${accessory.name} (${accessory.available_quantity} available)`;
                                                option.dataset.availableQuantity = accessory.available_quantity;
                                                select.appendChild(option);
                                            });
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error loading accessories:', error);
                                        document.getElementById('existing_accessory_select').innerHTML = '<option value="">Error loading accessories</option>';
                                    });
                            }

                            // Function to submit existing accessory form for Asset Intake
                            function submitExistingAccessoryForm(event) {
                                event.preventDefault();
                                
                                const form = event.target;
                                const accessoryId = document.getElementById('existing_accessory_select').value;
                                const quantity = parseInt(document.getElementById('accessory_quantity_input').value);
                                const condition = document.querySelector('#existingAccessoryForm select[name="accessory_condition"]').value;
                                const notes = document.querySelector('#existingAccessoryForm textarea[name="accessory_notes"]').value;
                                
                                if (!accessoryId || accessoryId === "") {
                                    alert("Please select an accessory");
                                    return;
                                }
                                
                                if (isNaN(quantity) || quantity < 1) {
                                    alert("Quantity must be at least 1");
                                    return;
                                }
                                
                                const formData = {
                                    existing_accessory_id: accessoryId,
                                    accessory_quantity: quantity,
                                    accessory_condition: condition,
                                    accessory_notes: notes
                                };
                                
                                                                 fetch(`/tickets/{{ ticket.id }}/add-accessory`, {
                                     method: 'POST',
                                     headers: {
                                         'Content-Type': 'application/json',
                                         'X-CSRFToken': csrfTokenIntake,
                                         'X-Requested-With': 'XMLHttpRequest'
                                     },
                                     body: JSON.stringify(formData)
                                 })
                                                                 .then(response => {
                                     console.log("Response status:", response.status);
                                     if (response.ok) {
                                         return response.json();
                                     } else {
                                         return response.text().then(text => {
                                             try {
                                                 return JSON.parse(text);
                                             } catch (e) {
                                                 throw new Error(`HTTP error! Status: ${response.status}, Message: ${text || "Unknown error"}`);
                                             }
                                         });
                                     }
                                 })
                                 .then(data => {
                                     console.log("Form submission response:", data);
                                     if (data.success) {
                                         alert(`Successfully added accessory to the ticket`);
                                         window.location.reload();
                                     } else {
                                         alert('Error: ' + (data.message || 'Unknown error'));
                                     }
                                 })
                                 .catch(error => {
                                     console.error('Error:', error);
                                     alert(`Error: ${error.message || "Unknown error occurred"}`);
                                 });
                            }

                            // Function to submit new accessory form for Asset Intake
                            function submitNewAccessoryForm(event) {
                                event.preventDefault();
                                
                                const form = event.target;
                                const totalQuantity = parseInt(form.total_quantity.value);
                                const formData = {
                                    accessory_name: form.accessory_name.value,
                                    accessory_category: form.accessory_category.value,
                                    manufacturer: form.manufacturer.value,
                                    model_no: form.model_no.value,
                                    total_quantity: totalQuantity,
                                    country: form.country.value,
                                    accessory_quantity: totalQuantity, // Use total_quantity as accessory_quantity
                                    accessory_condition: form.accessory_condition.value,
                                    accessory_notes: form.accessory_notes.value
                                };
                                
                                console.log("Submitting new accessory:", formData);
                                
                                fetch(`/tickets/{{ ticket.id }}/add-accessory`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': csrfTokenIntake,
                                        'X-Requested-With': 'XMLHttpRequest'
                                    },
                                    body: JSON.stringify(formData)
                                })
                                .then(response => {
                                    console.log("Response status:", response.status);
                                    if (response.ok) {
                                        return response.json();
                                    } else {
                                        return response.text().then(text => {
                                            try {
                                                return JSON.parse(text);
                                            } catch (e) {
                                                throw new Error(`HTTP error! Status: ${response.status}, Message: ${text || "Unknown error"}`);
                                            }
                                        });
                                    }
                                })
                                .then(data => {
                                    console.log("New accessory response:", data);
                                    if (data.success) {
                                        alert(`Successfully created and added ${data.accessory.name} to the ticket`);
                                        window.location.reload();
                                    } else {
                                        alert('Error: ' + (data.message || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    alert(`Error: ${error.message || "Unknown error occurred"}`);
                                });
                            }

                            // Load accessories when page loads for Asset Intake
                            document.addEventListener('DOMContentLoaded', function() {
                                loadAccessories();
                            });
                        </script>
                    </div>
                    {% endif %}

                    {% if ticket.category and ticket.category.name == 'ASSET_RETURN_CLAW' %}
                    </div>
                    {% endif %}
                </div>

                <!-- Comments Section -->
                <h2 class="text-xl font-semibold mb-4 bg-blue-50 p-3 rounded border-l-4 border-blue-500">Comments</h2>
                <div id="comments" class="mb-8">
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <h2 class="sf-card-title">Case Comments</h2>
                            <div class="text-xs text-gray-500">
                                <!-- Comment count info -->
                                Comments count: {{ comments|length }}
                            </div>
                        </div>
                        <div class="sf-card-body">
                            <!-- Comments Form -->
                            <form method="POST" action="{{ url_for('tickets.add_comment', ticket_id=ticket.id) }}" class="mb-6">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="mb-3">
                                    <label for="message" class="block text-sm font-medium text-gray-700 mb-1">Add a Comment</label>
                                    <div class="relative">
                                        <textarea id="message" name="message" rows="4" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Type @ to mention users..."></textarea>
                                        <!-- Mention Suggestions Dropdown -->
                                        <div id="mentionSuggestions" class="mention-suggestions hidden"></div>
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        Add Comment
                                    </button>
                                </div>
                            </form>
                            
                            
                            <!-- Comments List -->
                            <div class="space-y-4">
                                {% if comments and comments|length > 0 %}
                                    {% for comment in comments %}
                                    <div class="border-b border-gray-200 pb-4 mb-4 last:border-0 last:mb-0 last:pb-0">
                                        <div class="flex justify-between mb-2">
                                            <div class="flex items-center gap-2">
                                                <span class="font-medium text-gray-900">{{ comment.user.username if comment.user else 'Anonymous' }}</span>
                                                <span class="text-sm text-gray-500">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                            </div>
                                        </div>
                                        <div class="text-gray-700 whitespace-pre-wrap">{{ comment.content|safe }}</div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center text-gray-500 py-6">
                                        No comments yet
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents Section -->
                <h2 class="text-xl font-semibold mb-4 bg-blue-50 p-3 rounded border-l-4 border-blue-500">Documents</h2>
                <div id="documents" class="mb-8">
                    <div class="sf-card mb-6">
                        <div class="sf-card-header">
                            <h2 class="sf-card-title">Attachments & Documents</h2>
                        </div>
                        <div class="sf-card-body">
                            <!-- Document Upload Form -->
                            <form method="POST" action="{{ url_for('tickets.upload_attachment', ticket_id=ticket.id) }}" enctype="multipart/form-data" class="mb-6">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="mb-3">
                                    <label for="attachments" class="block text-sm font-medium text-gray-700 mb-1">Upload Documents</label>
                                    <div class="flex flex-wrap items-center gap-3">
                                        <input type="file" id="documentUpload" name="attachments" multiple class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                                        <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            Upload Files
                                        </button>
                                    </div>
                                    <p class="mt-1 text-sm text-gray-500">
                                        Upload PDF, images, or documents related to this ticket
                                    </p>
                                </div>
                            </form>
                            
                            <!-- Documents List -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {% if ticket.attachments %}
                                    {% for attachment in ticket.attachments %}
                                    <div class="bg-gray-50 border border-gray-200 rounded-md overflow-hidden">
                                        {% if attachment.file_type in ['pdf'] %}
                                        <!-- PDF Section with Inline Viewer -->
                                        <div class="p-4 flex items-center justify-between border-b border-gray-200">
                                            <div class="flex items-center gap-2">
                                                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                                </svg>
                                                <div class="truncate">
                                                    <span class="text-sm font-medium text-gray-900">{{ attachment.filename }}</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <button
                                                    data-pdf-url="{{ url_for('tickets.get_attachment', ticket_id=ticket.id, attachment_id=attachment.id) }}"
                                                    onclick="previewPdf(this.getAttribute('data-pdf-url'))"
                                                    class="text-blue-600 hover:text-blue-800 p-1"
                                                    title="Open in modal">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                                    </svg>
                                                </button>
                                                <a href="{{ url_for('tickets.get_attachment', ticket_id=ticket.id, attachment_id=attachment.id) }}?download=true" class="text-gray-600 hover:text-gray-800 p-1" title="Download">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                    </svg>
                                                </a>
                                                <button onclick="deleteAttachment('{{ attachment.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800 p-1" title="Delete">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- Inline PDF Viewer -->
                                        <div class="p-2 bg-white">
                                            <iframe 
                                                src="{{ url_for('tickets.get_attachment', ticket_id=ticket.id, attachment_id=attachment.id) }}" 
                                                width="100%" 
                                                height="400" 
                                                style="border: 1px solid #e5e7eb; border-radius: 4px;"
                                                title="PDF Viewer for {{ attachment.filename }}">
                                                <p>Your browser does not support PDF viewing. <a href="{{ url_for('tickets.get_attachment', ticket_id=ticket.id, attachment_id=attachment.id) }}?download=true">Download the PDF</a> instead.</p>
                                            </iframe>
                                        </div>
                                        {% else %}
                                        <!-- Non-PDF Files -->
                                        <div class="p-4 flex items-center justify-between border-b border-gray-200">
                                            <div class="flex items-center gap-2">
                                                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                                </svg>
                                                <div class="truncate">
                                                    <span class="text-sm font-medium text-gray-900">{{ attachment.filename }}</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <a href="{{ url_for('tickets.get_attachment', ticket_id=ticket.id, attachment_id=attachment.id) }}" download class="text-gray-600 hover:text-gray-800 p-1">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                    </svg>
                                                </a>
                                                <button onclick="deleteAttachment('{{ attachment.id }}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800 p-1">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        {% endif %}
                                        <div class="text-xs text-gray-500 p-2">
                                            <div>Uploaded {{ attachment.created_at.strftime('%Y-%m-%d %H:%M') if attachment.created_at else 'Unknown date' }}</div>
                                            <div>{{ attachment.file_size | filesizeformat if attachment.file_size else 'Unknown size' }}</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-span-full text-center text-gray-500 py-6">
                                        No documents attached to this ticket
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PDF Preview Modal -->
            <div id="pdfPreviewModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-lg w-full max-w-6xl max-h-screen overflow-hidden flex flex-col m-4">
                    <div class="p-4 bg-gray-100 flex justify-between items-center border-b border-gray-200">
                        <h3 id="previewTitle" class="text-lg font-medium text-gray-900">PDF Preview</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="openInNewTab()" class="text-gray-600 hover:text-gray-800 p-1" title="Open in new tab">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                            </button>
                            <a id="pdfDownloadBtn" href="#" download class="text-gray-600 hover:text-gray-800 p-1" title="Download PDF">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                            </a>
                            <button onclick="closePdfPreview()" class="text-gray-600 hover:text-gray-800 p-1" title="Close">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto bg-gray-100">
                        <!-- Loading indicator -->
                        <div id="pdfLoader" class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="text-gray-600">Loading PDF...</p>
                            </div>
                        </div>
                        <!-- PDF iframe -->
                        <iframe id="pdfViewer" 
                                src="" 
                                width="100%" 
                                height="800" 
                                style="border: none; display: none;"
                                onload="pdfLoaded()"
                                onerror="pdfError()">
                        </iframe>
                        <!-- Error message -->
                        <div id="pdfError" class="hidden flex items-center justify-center h-full">
                            <div class="text-center">
                                <svg class="h-12 w-12 text-red-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.876c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L3.268 16.5C2.498 18.333 3.46 20 5 20z"/>
                                </svg>
                                <p class="text-red-600 mb-2">Failed to load PDF</p>
                                <button onclick="retryPdfLoad()" class="text-blue-600 hover:text-blue-800 underline">Try again</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Asset Modal -->
            <div id="assetModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
                        <h3 class="text-lg font-medium text-gray-900">Add Tech Asset</h3>
                        <button type="button" class="text-gray-400 hover:text-gray-500" onclick="hideAssetModal()">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Modal Tabs -->
                    <div class="px-6 pt-4 border-b border-gray-200">
                        <div class="flex space-x-1">
                            <button id="selectExistingTab" onclick="switchAssetModalTab('select')" 
                                    class="asset-modal-tab px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-blue-600 text-blue-600 bg-white">
                                Select Existing Asset
                            </button>
                            <button id="createNewTab" onclick="switchAssetModalTab('create')" 
                                    class="asset-modal-tab px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Create New Asset
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Select Existing Asset Tab Content -->
                        <div id="selectExistingContent" class="asset-modal-content">
                            <div class="mb-6">
                                <h4 class="text-lg font-medium text-gray-900 mb-4">Select an existing tech asset to assign to this ticket</h4>
                                
                                <!-- Selection Methods -->
                                <div class="mb-4 space-y-4">
                                    <!-- Quick Dropdown Selection -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Quick Select from Dropdown</label>
                                        <select id="assetDropdownSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                                onchange="selectAssetFromDropdown()">
                                            <option value="">Choose an asset...</option>
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                    </div>
                                    
                                    <!-- OR Divider -->
                                    <div class="flex items-center">
                                        <div class="flex-1 border-t border-gray-300"></div>
                                        <div class="px-4 text-sm text-gray-500 bg-white">OR</div>
                                        <div class="flex-1 border-t border-gray-300"></div>
                                    </div>
                                    
                                    <!-- Search and Filter -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Search and Filter from Table</label>
                                        <div class="flex gap-4">
                                            <div class="flex-1">
                                                <input type="text" id="assetSearchInput" placeholder="Search by asset tag, serial number, or name..." 
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                                       onkeyup="filterExistingAssets()">
                                            </div>
                                            <div class="w-48">
                                                <select id="assetStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                                        onchange="filterExistingAssets()">
                                                    <option value="">All Statuses</option>
                                                    <option value="Active">Active</option>
                                                    <option value="Deployed">Deployed</option>
                                                    <option value="Ready to Deploy">Ready to Deploy</option>
                                                    <option value="Pending">Pending</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Asset List -->
                                <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Select</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Tag</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial Number</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="existingAssetsTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Assets will be loaded here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="mt-4 flex justify-end gap-3">
                                    <button type="button" onclick="hideAssetModal()" 
                                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        Cancel
                                    </button>
                                    <button type="button" id="assignSelectedAssetBtn" onclick="assignSelectedAsset()" disabled
                                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                        Assign Selected Asset
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Create New Asset Tab Content -->
                        <div id="createNewContent" class="asset-modal-content hidden">
                        <form id="assetForm" class="space-y-6" method="POST" action="{{ url_for('inventory.add_asset') }}" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="intake_ticket_id" value="{{ ticket.id }}">
                            
                            <!-- Basic Information -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="asset_tag" class="block text-sm font-medium text-gray-700">Asset Tag *</label>
                                    <input type="text" id="asset_tag" name="asset_tag" required maxlength="50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="serial_num" class="block text-sm font-medium text-gray-700">Serial Number *</label>
                                    <input type="text" id="serial_num" name="serial_num" required maxlength="50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="product" class="block text-sm font-medium text-gray-700">Product</label>
                                    <input type="text" id="product" name="product" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="model" class="block text-sm font-medium text-gray-700">Model *</label>
                                    <input type="text" id="model" name="model" required list="asset-modal-model-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" onchange="handleModelChange(this)">
                                    <datalist id="asset-modal-model-list">
                                        {% for model_name in asset_modal_models %}
                                        <option value="{{ model_name }}" 
                                               data-product="{{ model_product_map[model_name] if model_product_map and model_name in model_product_map else '' }}"
                                               data-asset-type="{{ model_type_map[model_name] if model_type_map and model_name in model_type_map else '' }}">
                                        </option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div>
                                    <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                                    <select id="status" name="status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <option value="">Select a status...</option>
                                        {% for status_enum in asset_modal_statuses %}
                                        <option value="{{ status_enum.name }}">{{ status_enum.value }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label for="asset_type" class="block text-sm font-medium text-gray-700">Asset Type *</label>
                                    <input type="text" id="asset_type" name="asset_type" required list="asset-modal-type-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <datalist id="asset-modal-type-list">
                                         {% for type in asset_modal_asset_types %}
                                        <option value="{{ type }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div>
                                    <label for="receiving_date" class="block text-sm font-medium text-gray-700">Receiving Date</label>
                                    <input type="date" id="receiving_date" name="receiving_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="po" class="block text-sm font-medium text-gray-700">PO Number</label>
                                    <input type="text" id="po" name="po" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="customer" class="block text-sm font-medium text-gray-700">Customer</label>
                                     <input type="text" id="customer" name="customer" list="asset-modal-customer-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <datalist id="asset-modal-customer-list">
                                         {% for cust in asset_modal_customers %}
                                        <option value="{{ cust }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div>
                                    <label for="country" class="block text-sm font-medium text-gray-700">Country</label>
                                     <input type="text" id="country" name="country" list="asset-modal-country-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <datalist id="asset-modal-country-list">
                                         {% for c in asset_modal_countries %}
                                        <option value="{{ c }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div>
                                    <label for="erased" class="flex items-center space-x-2">
                                        <input type="checkbox" id="erased" name="erased" value="true" class="rounded border-gray-300 text-blue-600 shadow-sm">
                                        <span class="text-sm text-gray-700">Data Erased</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Hardware Information -->
                            <div class="border-t pt-4">
                                <button type="button" onclick="toggleSection('hardwareSection')" class="flex justify-between items-center w-full text-left">
                                    <h3 class="text-lg font-medium text-gray-900">Hardware Specifications</h3>
                                    <svg id="hardwareSectionIcon" class="h-5 w-5 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="hardwareSection" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                                     <div>
                                        <label for="hardware_type" class="block text-sm font-medium text-gray-700">Hardware Type</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="hardware_type" name="hardware_type" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                            <button type="button" onclick="generateHardwareType()" class="mt-1 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Generate</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="cpu_type" class="block text-sm font-medium text-gray-700">CPU Type</label>
                                        <input type="text" id="cpu_type" name="cpu_type" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="cpu_cores" class="block text-sm font-medium text-gray-700">CPU Cores</label>
                                        <input type="text" id="cpu_cores" name="cpu_cores" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="memory" class="block text-sm font-medium text-gray-700">Memory (GB)</label>
                                        <input type="text" id="memory" name="memory" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="harddrive" class="block text-sm font-medium text-gray-700">Hard Drive (GB)</label>
                                        <input type="text" id="harddrive" name="harddrive" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="gpu_cores" class="block text-sm font-medium text-gray-700">GPU Cores</label>
                                        <input type="text" id="gpu_cores" name="gpu_cores" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="keyboard" class="block text-sm font-medium text-gray-700">Keyboard</label>
                                        <input type="text" id="keyboard" name="keyboard" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="charger" class="block text-sm font-medium text-gray-700">Charger</label>
                                        <input type="text" id="charger" name="charger" list="asset-modal-charger-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <datalist id="asset-modal-charger-list">
                                            {% for chgr in asset_modal_chargers %}
                                            <option value="{{ chgr }}"></option>
                                            {% endfor %}
                                        </datalist>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Information -->
                            <div class="border-t pt-4">
                                <button type="button" onclick="toggleSection('notesSection')" class="flex justify-between items-center w-full text-left">
                                    <h3 class="text-lg font-medium text-gray-900">Additional Information</h3>
                                    <svg id="notesSectionIcon" class="h-5 w-5 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="notesSection" class="mt-4 grid grid-cols-1 gap-6 hidden">
                                     <div>
                                        <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                                        <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                                    </div>
                                    <div>
                                        <label for="tech_notes" class="block text-sm font-medium text-gray-700">Technical Notes</label>
                                        <textarea id="tech_notes" name="tech_notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                                    </div>
                                    <div>
                                        <label for="condition" class="block text-sm font-medium text-gray-700">Condition</label>
                                        <input type="text" id="condition" name="condition" list="asset-modal-condition-list" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <datalist id="asset-modal-condition-list">
                                            {% for cond in asset_modal_conditions %}
                                            <option value="{{ cond }}"></option>
                                            {% endfor %}
                                        </datalist>
                                    </div>
                                    <div>
                                        <label for="diag" class="block text-sm font-medium text-gray-700">Diagnostics</label>
                                        <input type="text" id="diag" name="diag" list="asset-modal-diag-list" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <datalist id="asset-modal-diag-list">
                                            {% for d in asset_modal_diags %}
                                            <option value="{{ d }}"></option>
                                            {% endfor %}
                                        </datalist>
                                    </div>
                                </div>
                            </div>

                            <div id="formFeedback" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                                <p class="text-sm font-medium mb-1">Error submitting form:</p>
                                <p class="text-sm"></p>
                                <ul class="text-sm list-disc ml-5 mt-1" id="errorDetails"></ul>
                            </div>
                        </form>
                        
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" class="px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" onclick="hideAssetModal()">
                                Cancel
                            </button>
                            <button type="button" id="assetSubmitBtn" onclick="submitAssetForm()" class="px-4 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center justify-center">
                                Add Asset
                            </button>
                        </div>
                        </div> <!-- Close createNewContent div -->
                    </div>
                </div>
            </div>

            <!-- Add Shipment Modal -->
            <div id="addShipmentModal" class="fixed inset-0 overflow-y-auto hidden z-50">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                        Add Tracking Information
                                    </h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500">
                                            Please enter the tracking number and select the carrier for this shipment.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="addShipmentForm" class="mt-4 space-y-4">
                                <div>
                                    <label for="tracking_number" class="block text-sm font-medium text-gray-700">Tracking Number</label>
                                    <input type="text" id="tracking_number" name="tracking_number" required 
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="carrier" class="block text-sm font-medium text-gray-700">Carrier</label>
                                    <select id="carrier" name="carrier" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="auto">Auto-Detect</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="submit" form="addShipmentForm" 
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                Add Shipment
                            </button>
                            <button type="button" onclick="hideAddShipmentModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Return Tracking Modal -->
            <div id="addReturnTrackingModal" class="fixed inset-0 overflow-y-auto hidden z-50">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                        {% if ticket.return_tracking %}
                                        Edit Return Tracking Information
                                        {% else %}
                                        Add Return Tracking Information
                                        {% endif %}
                                    </h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500">
                                            Please enter the return tracking number and select the carrier for this return shipment.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="addReturnTrackingForm" class="mt-4 space-y-4">
                                <div>
                                    <label for="return_tracking_number" class="block text-sm font-medium text-gray-700">Return Tracking Number</label>
                                    <input type="text" id="return_tracking_number" name="tracking_number" required 
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="Enter return tracking number">
                                </div>
                                <div>
                                    <label for="return_carrier" class="block text-sm font-medium text-gray-700">Carrier</label>
                                    <select id="return_carrier" name="return_carrier" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                        <option value="auto">Auto-Detect</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="submitReturnTrackingBtn" 
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                                {% if ticket.return_tracking %}
                                Update Return Tracking
                                {% else %}
                                Add Return Tracking
                                {% endif %}
                            </button>
                            <button type="button" onclick="hideAddReturnTrackingModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Outbound Tracking Modal -->
            <div id="addOutboundTrackingModal" class="fixed inset-0 overflow-y-auto hidden z-50">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                        {% if ticket.shipping_tracking %}
                                        Edit Outbound Tracking Information
                                        {% else %}
                                        Add Outbound Tracking Information
                                        {% endif %}
                                    </h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500">
                                            Please enter the outbound tracking number and select the carrier for this shipment.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="addOutboundTrackingForm" class="mt-4 space-y-4">
                                <div>
                                    <label for="outbound_tracking_number" class="block text-sm font-medium text-gray-700">Outbound Tracking Number</label>
                                    <input type="text" id="outbound_tracking_number" name="outbound_tracking_number" required 
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="outbound_carrier" class="block text-sm font-medium text-gray-700">Carrier</label>
                                    <select id="outbound_carrier" name="outbound_carrier" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="auto">Auto-Detect</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="submitOutboundTrackingBtn" 
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                {% if ticket.shipping_tracking %}
                                Update Outbound Tracking
                                {% else %}
                                Add Outbound Tracking
                                {% endif %}
                            </button>
                            <button type="button" onclick="hideAddOutboundTrackingModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Replace the Add Accessory Modal with a simpler implementation -->
            <div id="simpleAccessoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10000;">
                <div style="background-color: white; width: 90%; max-width: 500px; margin: 50px auto; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                        <h3 style="font-size: 18px; font-weight: bold; margin: 0;">Add Accessory</h3>
                        <button onclick="closeSimpleModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                    </div>
                    
                    <form id="simpleAccessoryForm" method="POST" action="{{ url_for('tickets.add_accessory', ticket_id=ticket.id) | replace('/add_accessory', '/add-accessory') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Accessory Name</label>
                            <input type="text" id="simple_accessory_name" name="accessory_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
                            <select id="simple_accessory_category" name="accessory_category" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">-- Select Category --</option>
                                <option value="Keyboard">Keyboard</option>
                                <option value="Mouse">Mouse</option>
                                <option value="Cable">Cable</option>
                                <option value="Adapter">Adapter</option>
                                <option value="Power Brick">Power Brick</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Quantity</label>
                            <input type="number" id="simple_accessory_quantity" name="accessory_quantity" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Condition</label>
                            <select id="simple_accessory_condition" name="accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                                <option value="Poor">Poor</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                            <textarea id="simple_accessory_notes" name="accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button type="button" onclick="closeSimpleModal()" style="padding: 8px 15px; background-color: #f1f1f1; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                            <button type="submit" style="padding: 8px 15px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Add Accessory</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Accessory Modal -->
            <div id="editAccessoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); width: 500px; max-width: 90vw; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold;">Edit Accessory</h3>
                    <input type="hidden" id="edit_accessory_id">
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Accessory Name</label>
                        <input type="text" id="edit_accessory_name" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Category</label>
                        <select id="edit_accessory_category" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="Keyboard">Keyboard</option>
                            <option value="Mouse">Mouse</option>
                            <option value="Monitor">Monitor</option>
                            <option value="Docking Station">Docking Station</option>
                            <option value="Cable">Cable</option>
                            <option value="Power Adapter">Power Adapter</option>
                            <option value="Headset">Headset</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Quantity</label>
                        <input type="number" id="edit_accessory_quantity" min="1" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Condition</label>
                        <select id="edit_accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="Good">Good</option>
                            <option value="Fair">Fair</option>
                            <option value="Poor">Poor</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Notes</label>
                        <textarea id="edit_accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="button" onclick="hideEditAccessoryModal()" style="margin-right: 10px; padding: 8px 16px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">
                            Cancel
                        </button>
                        <button type="button" id="updateAccessoryBtn" style="padding: 8px 16px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Update Accessory
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add the JavaScript for the asset functionality -->
<script>
// Store ticket ID for use in JavaScript
const ticketId = "{{ ticket.id }}"; // This will be rendered as the actual ticket ID

// Tech Asset Modal functions
window.showAssetModal = function() {
    console.log('showAssetModal called');
    const modal = document.getElementById('assetModal');
    if (modal) {
        console.log('Found assetModal, removing hidden class');
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden'); // Prevent scrolling
        
        // Load existing assets when modal opens (since "Select Existing Asset" tab is default)
        if (!existingAssetsLoaded) {
            loadExistingAssets();
        }
    } else {
        console.error('assetModal element not found!');
    }
};

// Confirm delete ticket function
function confirmDeleteTicket(ticketId) {
    if (confirm('Are you sure you want to permanently delete this ticket? This action cannot be undone.')) {
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Submit delete request
        fetch(`${window.CURRENT_ORIGIN}/tickets/${ticketId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Ticket deleted successfully', 'success');
                // Redirect to tickets list
                window.location.href = '/tickets';
            } else {
                showNotification(data.error || 'Failed to delete ticket', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An unexpected error occurred', 'error');
        });
    }
}

window.hideAssetModal = function() {
    console.log('hideAssetModal called');
    const modal = document.getElementById('assetModal');
    if (modal) {
        console.log('Found assetModal, adding hidden class');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden'); // Restore scrolling
        
        // Reset form
        const form = document.getElementById('assetForm');
        if (form) form.reset();
        
        // Reset feedback message
        const formFeedback = document.getElementById('formFeedback');
        if (formFeedback) formFeedback.classList.add('hidden');
        
        // Reset selected asset
        selectedAssetId = null;
        updateAssignButton();
        
        // Reset dropdown selection
        const dropdown = document.getElementById('assetDropdownSelect');
        if (dropdown) dropdown.value = '';
        
        // Clear table highlights
        clearTableHighlight();
    } else {
        console.error('assetModal element not found!');
    }
};

// Asset modal tab switching
window.switchAssetModalTab = function(tab) {
    const selectTab = document.getElementById('selectExistingTab');
    const createTab = document.getElementById('createNewTab');
    const selectContent = document.getElementById('selectExistingContent');
    const createContent = document.getElementById('createNewContent');
    
    if (tab === 'select') {
        // Switch to select existing tab
        selectTab.classList.add('border-blue-600', 'text-blue-600', 'bg-white');
        selectTab.classList.remove('border-transparent', 'text-gray-500');
        createTab.classList.add('border-transparent', 'text-gray-500');
        createTab.classList.remove('border-blue-600', 'text-blue-600', 'bg-white');
        
        selectContent.classList.remove('hidden');
        createContent.classList.add('hidden');
        
        // Load existing assets if not already loaded
        if (!existingAssetsLoaded) {
            loadExistingAssets();
        }
    } else {
        // Switch to create new tab
        createTab.classList.add('border-blue-600', 'text-blue-600', 'bg-white');
        createTab.classList.remove('border-transparent', 'text-gray-500');
        selectTab.classList.add('border-transparent', 'text-gray-500');
        selectTab.classList.remove('border-blue-600', 'text-blue-600', 'bg-white');
        
        createContent.classList.remove('hidden');
        selectContent.classList.add('hidden');
    }
};

// Asset selection variables
let existingAssetsData = [];
let existingAssetsLoaded = false;
let selectedAssetId = null;

// Load existing assets from server
window.loadExistingAssets = function() {
    console.log('Loading existing assets...');
    fetch('/inventory/api/assets')
        .then(response => {
            console.log('Asset API response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Asset API response data:', data);
            existingAssetsData = data.assets || [];
            existingAssetsLoaded = true;
            console.log(`Loaded ${existingAssetsData.length} assets`);
            populateAssetDropdown();
            renderExistingAssets();
        })
        .catch(error => {
            console.error('Error loading assets:', error);
            alert(`Failed to load existing assets: ${error.message}`);
        });
};

// Populate the asset dropdown
window.populateAssetDropdown = function() {
    console.log('Populating asset dropdown with', existingAssetsData.length, 'assets');
    const dropdown = document.getElementById('assetDropdownSelect');
    if (!dropdown) {
        console.error('Asset dropdown element not found!');
        return;
    }
    
    // Clear existing options except the first one
    dropdown.innerHTML = '<option value="">Choose an asset...</option>';
    
    if (existingAssetsData.length === 0) {
        console.warn('No assets available to populate dropdown');
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No assets available';
        option.disabled = true;
        dropdown.appendChild(option);
        return;
    }
    
    // Sort assets by asset_tag for easier browsing
    const sortedAssets = [...existingAssetsData].sort((a, b) => {
        const tagA = a.asset_tag || '';
        const tagB = b.asset_tag || '';
        return tagA.localeCompare(tagB);
    });
    
    // Populate dropdown with assets
    sortedAssets.forEach(asset => {
        const option = document.createElement('option');
        option.value = asset.id;
        
        // Create descriptive text for the option
        let optionText = '';
        if (asset.asset_tag) optionText += asset.asset_tag;
        if (asset.serial_num) optionText += ` | ${asset.serial_num}`;
        if (asset.name) optionText += ` | ${asset.name}`;
        if (asset.status) optionText += ` | ${asset.status}`;
        
        option.textContent = optionText || `Asset ${asset.id}`;
        option.setAttribute('data-status', asset.status || '');
        
        dropdown.appendChild(option);
    });
    
    console.log(`Populated dropdown with ${sortedAssets.length} assets`);
};

// Handle dropdown selection
window.selectAssetFromDropdown = function() {
    const dropdown = document.getElementById('assetDropdownSelect');
    const selectedAssetId = dropdown.value;
    
    if (selectedAssetId) {
        // Clear the table selection
        const radios = document.querySelectorAll('input[name="selectedAsset"]');
        radios.forEach(radio => radio.checked = false);
        
        // Clear search inputs
        const searchInput = document.getElementById('assetSearchInput');
        const statusFilter = document.getElementById('assetStatusFilter');
        if (searchInput) searchInput.value = '';
        if (statusFilter) statusFilter.value = '';
        
        // Set the selected asset
        handleAssetSelection(parseInt(selectedAssetId));
        
        // Highlight the selected asset in the table
        highlightAssetInTable(parseInt(selectedAssetId));
    } else {
        // Clear selection if "Choose an asset..." is selected
        selectedAssetId = null;
        updateAssignButton();
        clearTableHighlight();
    }
};

// Highlight selected asset in the table
window.highlightAssetInTable = function(assetId) {
    // Remove previous highlights
    clearTableHighlight();
    
    // Find and highlight the selected asset row
    const rows = document.querySelectorAll('#existingAssetsTableBody tr');
    rows.forEach(row => {
        const radio = row.querySelector('input[name="selectedAsset"]');
        if (radio && parseInt(radio.value) === assetId) {
            row.classList.add('bg-blue-50', 'border-blue-200');
            radio.checked = true;
        }
    });
};

// Clear table highlights
window.clearTableHighlight = function() {
    const rows = document.querySelectorAll('#existingAssetsTableBody tr');
    rows.forEach(row => {
        row.classList.remove('bg-blue-50', 'border-blue-200');
    });
};

// Render assets in the table
window.renderExistingAssets = function() {
    const tbody = document.getElementById('existingAssetsTableBody');
    if (!tbody) return;
    
    let filteredAssets = filterAssets();
    
    if (filteredAssets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No assets found</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredAssets.map(asset => `
        <tr class="hover:bg-gray-50 cursor-pointer" onclick="selectAsset(${asset.id})">
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="radio" name="selectedAsset" value="${asset.id}" 
                       onchange="handleAssetSelection(${asset.id})" 
                       class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${asset.asset_tag || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.serial_num || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${asset.name || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(asset.status)}">
                    ${asset.status || 'Unknown'}
                </span>
            </td>
        </tr>
    `).join('');
};

// Filter assets based on search and status
window.filterAssets = function() {
    const searchTerm = (document.getElementById('assetSearchInput')?.value || '').toLowerCase();
    const statusFilter = document.getElementById('assetStatusFilter')?.value || '';
    
    return existingAssetsData.filter(asset => {
        const matchesSearch = !searchTerm || 
            (asset.asset_tag && asset.asset_tag.toLowerCase().includes(searchTerm)) ||
            (asset.serial_num && asset.serial_num.toLowerCase().includes(searchTerm)) ||
            (asset.name && asset.name.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || asset.status === statusFilter;
        
        return matchesSearch && matchesStatus;
    });
};

// Handle asset selection
window.handleAssetSelection = function(assetId) {
    selectedAssetId = assetId;
    updateAssignButton();
};

window.selectAsset = function(assetId) {
    // Clear dropdown selection
    const dropdown = document.getElementById('assetDropdownSelect');
    if (dropdown) dropdown.value = '';
    
    // Check the radio button
    const radio = document.querySelector(`input[name="selectedAsset"][value="${assetId}"]`);
    if (radio) {
        radio.checked = true;
        handleAssetSelection(assetId);
    }
    
    // Clear any highlights and highlight this row
    clearTableHighlight();
    const row = radio?.closest('tr');
    if (row) {
        row.classList.add('bg-blue-50', 'border-blue-200');
    }
};

// Update assign button state
window.updateAssignButton = function() {
    const button = document.getElementById('assignSelectedAssetBtn');
    if (button) {
        button.disabled = !selectedAssetId;
    }
};

// Assign selected asset to ticket
window.assignSelectedAsset = function() {
    if (!selectedAssetId) {
        alert('Please select an asset first.');
        return;
    }
    
    console.log('Assigning asset', selectedAssetId, 'to ticket', ticketId);
    
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Send request to assign asset
    fetch(`/tickets/${ticketId}/assign-asset`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            asset_id: selectedAssetId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Asset assigned successfully!');
            hideAssetModal();
            // Refresh the page to show the assigned asset
            location.reload();
        } else {
            alert('Failed to assign asset: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error assigning asset:', error);
        alert('Failed to assign asset. Please try again.');
    });
};

// Filter existing assets (called on search/filter change)
window.filterExistingAssets = function() {
    // Clear dropdown selection when filtering
    const dropdown = document.getElementById('assetDropdownSelect');
    if (dropdown) dropdown.value = '';
    
    // Clear selection state
    selectedAssetId = null;
    updateAssignButton();
    
    renderExistingAssets();
};

// Get status badge CSS class
window.getStatusBadgeClass = function(status) {
    switch(status) {
        case 'Active': return 'bg-green-100 text-green-800';
        case 'Deployed': return 'bg-blue-100 text-blue-800';
        case 'Ready to Deploy': return 'bg-yellow-100 text-yellow-800';
        case 'Pending': return 'bg-gray-100 text-gray-800';
        default: return 'bg-gray-100 text-gray-800';
    }
};

function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(sectionId + 'Icon');
    
    if (section && icon) {
        if (section.classList.contains('hidden')) {
            section.classList.remove('hidden');
            icon.classList.remove('rotate-180');
            icon.classList.add('rotate-0');
        } else {
            section.classList.add('hidden');
            icon.classList.remove('rotate-0');
            icon.classList.add('rotate-180');
        }
    }
}

// Toggle Update Form Function
function toggleUpdateForm() {
    const updateForm = document.getElementById('updateForm');
    if (updateForm) {
        if (updateForm.classList.contains('hidden')) {
            updateForm.classList.remove('hidden');
        } else {
            updateForm.classList.add('hidden');
        }
    } else {
        console.error('updateForm element not found!');
    }
}

// Toggle Assign Form Function
function toggleAssignForm() {
    const assignForm = document.getElementById('assignForm');
    if (assignForm) {
        if (assignForm.classList.contains('hidden')) {
            assignForm.classList.remove('hidden');
        } else {
            assignForm.classList.add('hidden');
        }
    } else {
        console.error('assignForm element not found!');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("Initializing simple tab system");
    
    // Get all tab links
    const tabLinks = document.querySelectorAll('.sf-tab');
    
    // Add click handler to each tab link
    tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent hash navigation
            
            // Get the target tab ID
            const tabId = this.getAttribute('data-target');
            // Skip tab debugging
            
            // Hide all tabs
            document.querySelectorAll('.sf-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all links
            tabLinks.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show the selected tab
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
                console.log("Tab displayed:", tabId);
            }
            
            // Add active class to clicked link
            this.classList.add('active');
            
            // Update URL hash
            history.replaceState(null, null, '#' + tabId);
        });
    });
    
    // Initialize based on hash or default to 'details'
    let tabId = window.location.hash.substring(1) || 'details';
    const defaultTab = document.querySelector(`.sf-tab[data-target="${tabId}"]`) || 
                        document.querySelector('.sf-tab[data-target="details"]');
    
    // Simulate click on default tab
    if (defaultTab) {
        console.log("Initializing default tab:", defaultTab.getAttribute('data-target'));
        defaultTab.click();
    }
});

function generateHardwareType() {
    const product = document.getElementById('product').value;
    const assetType = document.getElementById('asset_type').value;
    const cpuType = document.getElementById('cpu_type').value;
    const cpuCores = document.getElementById('cpu_cores').value;
    const gpuCores = document.getElementById('gpu_cores').value;
    const memory = document.getElementById('memory').value;
    const harddrive = document.getElementById('harddrive').value;

    let hardwareType = '';

    // Build the hardware type string
    if (product) hardwareType += product + ' ';
    if (assetType) hardwareType += assetType + ' ';
    if (cpuType) hardwareType += cpuType + ' ';
    if (cpuCores) hardwareType += cpuCores + '-Core ';
    if (gpuCores) hardwareType += gpuCores + '-Core GPU ';
    if (memory) hardwareType += memory + 'GB RAM ';
    if (harddrive) hardwareType += harddrive + 'GB HDD';

    // Set the generated hardware type
    document.getElementById('hardware_type').value = hardwareType.trim();
}

function submitAssetForm() {
    const form = document.getElementById('assetForm');
    const formData = new FormData(form);
    const submitBtn = document.getElementById('assetSubmitBtn');
    const formFeedback = document.getElementById('formFeedback');
    
    // Clear previous error messages
    formFeedback.classList.add('hidden');
    formFeedback.querySelector('p').textContent = '';
    
    // Debug: Log complete form data 
    console.log("Form data to be submitted:");
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: '${value}'`);
    }
    
    // Validate required fields client-side (optional but good practice)
    const requiredFields = form.querySelectorAll('[required]');
    let missingFields = [];
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('border-red-500');
            missingFields.push(field.name);
        } else {
            field.classList.remove('border-red-500');
        }
    });
    
    if (missingFields.length > 0) {
        console.log("Missing required fields (client-side validation):", missingFields);
        formFeedback.classList.remove('hidden');
        formFeedback.querySelector('p').textContent = `Please fill out these required fields: ${missingFields.join(', ')}`;
        return; // Stop submission
    }
    
    // Disable button and show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Saving...
    `;
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Make sure the ticket ID is included in the form data
    formData.append('intake_ticket_id', '{{ ticket.id }}');
    
    // Prepare JSON payload with debugging
    const jsonPayload = {
        asset_tag: formData.get('asset_tag'),
        serial_number: formData.get('serial_num'),
        name: formData.get('product'),
        category: formData.get('asset_type'),
        condition: formData.get('condition') || 'Good',
        status: formData.get('status') || 'In Stock',
        notes: formData.get('notes') || '',
        type: formData.get('asset_type'),
        ticket_id: '{{ ticket.id }}'
    };
    
    console.log(`[FRONTEND DEBUG ${new Date().toISOString()}] Sending payload:`, jsonPayload);
    
    // Get the URL
    const targetUrl = '{{ url_for("assets.add_asset") }}';
    console.log("[FRONTEND DEBUG] Target URL:", targetUrl);
    
    // Submit the form using fetch API
    fetch(targetUrl, {
        method: 'POST',
        body: JSON.stringify(jsonPayload),
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        console.log("Server response status:", response.status);
        // Always try to parse response as JSON for more detailed error info
        return response.json().then(data => {
            // Add status to data object for error handling
            return { ...data, status: response.status };
        }).catch(err => {
            // If JSON parsing fails, return text with status
            return response.text().then(text => {
                return { error: `Failed to parse response: ${text}`, status: response.status };
            });
        });
    })
    .then(data => {
        console.log("Full server response:", data);
        console.log("[FRONTEND DEBUG] Response status:", data.status);
        console.log("[FRONTEND DEBUG] Response success:", data.success);
        console.log("[FRONTEND DEBUG] Response error:", data.error);
        
        if (data.success) {
            console.log("Asset added successfully:", data.asset);
            
            // Add the new asset to the table
            const tableBody = document.querySelector('#assetTableBody');
            if (!tableBody) {
                console.error("Asset table body not found");
                return;
            }
            
            // If this is the first asset, clear the "No assets" message
            if (tableBody.querySelector('tr td[colspan="5"]')) {
                tableBody.innerHTML = '';
            }
            
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-asset-id', data.asset.id);
            newRow.innerHTML = `
                <td>${data.asset.asset_tag || '-'}</td>
                <td>${data.asset.serial_number || data.asset.serial_num || '-'}</td>
                <td>${data.asset.name || data.asset.model || '-'}</td>
                <td>
                    <span class="sf-badge sf-badge-success">
                        ${data.asset.status || 'Active'}
                    </span>
                </td>
                <td>
                    <div class="flex gap-2">
                        <button onclick="viewAsset('${data.asset.id}')" class="text-blue-600 hover:text-blue-800">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                        <button onclick="unlinkAsset('${data.asset.id}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(newRow);
            
            // Close the modal and reset the form
            hideAssetModal();
            form.reset();
            
            // Show success notification
            showNotification('Asset added successfully!', 'success');
        } else {
            console.error("Server reported error:", data);
            
            // Check if this is a duplicate asset error
            if (data.error && (data.error.includes('UNIQUE constraint failed') || 
                              data.error.includes('Asset tag already exists') || 
                              data.error.includes('Serial number already exists'))) {
                formFeedback.classList.remove('hidden');
                formFeedback.querySelector('p').textContent = data.error; // Show the actual error message
            } else {
                // Show general error message
                console.log("[FRONTEND DEBUG] Error case - showing error message:", data.error);
                formFeedback.classList.remove('hidden');
                formFeedback.querySelector('p').textContent = `[FRONTEND] ${data.error || 'Failed to add asset. Please try again.'}`;
                
                // Display detailed error information if available
                const errorDetails = document.getElementById('errorDetails');
                if (errorDetails) {
                    errorDetails.innerHTML = ''; // Clear existing error details
                    
                    if (data.missing_fields && Array.isArray(data.missing_fields)) {
                        data.missing_fields.forEach(field => {
                            const li = document.createElement('li');
                            li.textContent = field;
                            errorDetails.appendChild(li);
                        });
                    }
                }
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        formFeedback.classList.remove('hidden');
        formFeedback.querySelector('p').textContent = error.message || 'An unexpected error occurred. Please try again.';
    })
    .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Add Asset';
    });
}

function viewAsset(assetId) {
    window.location.href = `/assets/${assetId}`;
}

function unlinkAsset(assetId, ticketId) {
    if (confirm('Are you sure you want to unlink this asset from the ticket?')) {
        fetch(`${window.CURRENT_ORIGIN}/assets/${assetId}/unlink/${ticketId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the row from the table
                const row = document.querySelector(`tr[data-asset-id="${assetId}"]`);
                if (row) row.remove();
                
                // Show success message
                showNotification('Asset unlinked successfully', 'success');
            } else {
                showNotification(data.error || 'Failed to unlink asset', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An unexpected error occurred', 'error');
        });
    }
}

function showNotification(message, type = 'success') {
    // Use notification div instead of alert
    const notification = document.getElementById('notification');
    if (notification) {
        // Create notification content
        notification.innerHTML = `
            <div class="bg-${type === 'success' ? 'green' : 'red'}-100 border-l-4 border-${type === 'success' ? 'green' : 'red'}-500 text-${type === 'success' ? 'green' : 'red'}-700 p-4 rounded shadow-md">
                <p>${message}</p>
            </div>
        `;
        
        // Show notification
        notification.classList.remove('hidden');
        
        // Hide notification after 3 seconds
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 3000);
    } else {
        // Fallback to alert if notification div is not found
        alert(message);
    }
}

function handleModelChange(input) {
    const productInput = document.getElementById('product');
    const assetTypeInput = document.getElementById('asset_type');
    const modelList = document.getElementById('asset-modal-model-list');
    const options = modelList.options;
    
    console.log("Model changed to: " + input.value);
    
    // Find if the current input value matches any existing model
    let matchingOption = null;
    for (let i = 0; i < options.length; i++) {
        if (options[i].value === input.value) {
            matchingOption = options[i];
            break;
        }
    }
    
    if (matchingOption) {
        // If it's an existing model, set the product and asset type
        const product = matchingOption.getAttribute('data-product');
        const assetType = matchingOption.getAttribute('data-asset-type');
        
        console.log("Found matching model with product: " + product + ", asset type: " + assetType);
        
        if (product) {
            productInput.value = product;
        }
        
        if (assetType) {
            assetTypeInput.value = assetType;
        }
    }
}

// PDF preview functionality
window.previewPdf = function(url) {
    // Show the modal and reset state
    document.getElementById('pdfPreviewModal').classList.remove('hidden');
    document.getElementById('pdfLoader').style.display = 'flex';
    document.getElementById('pdfViewer').style.display = 'none';
    document.getElementById('pdfError').classList.add('hidden');
    
    // Store the URL for retry functionality
    window.currentPdfUrl = url;
    
    // Set the iframe source to start loading
    const iframe = document.getElementById('pdfViewer');
    iframe.src = url;
    
    // Update download button
    document.getElementById('pdfDownloadBtn').href = url + '?download=true';
    
    // Set a timeout to show error if PDF doesn't load
    setTimeout(() => {
        if (document.getElementById('pdfLoader').style.display !== 'none') {
            pdfError();
        }
    }, 15000); // 15 second timeout
};

window.closePdfPreview = function() {
    document.getElementById('pdfPreviewModal').classList.add('hidden');
    // Clear the iframe source when closing to stop PDF rendering
    document.getElementById('pdfViewer').src = '';
    window.currentPdfUrl = null;
};

window.pdfLoaded = function() {
    // Hide loader and show PDF
    document.getElementById('pdfLoader').style.display = 'none';
    document.getElementById('pdfViewer').style.display = 'block';
    document.getElementById('pdfError').classList.add('hidden');
};

window.pdfError = function() {
    // Hide loader and PDF, show error
    document.getElementById('pdfLoader').style.display = 'none';
    document.getElementById('pdfViewer').style.display = 'none';
    document.getElementById('pdfError').classList.remove('hidden');
};

window.retryPdfLoad = function() {
    if (window.currentPdfUrl) {
        // Reset and try again
        document.getElementById('pdfLoader').style.display = 'flex';
        document.getElementById('pdfError').classList.add('hidden');
        document.getElementById('pdfViewer').src = window.currentPdfUrl;
    }
};

window.openInNewTab = function() {
    if (window.currentPdfUrl) {
        window.open(window.currentPdfUrl, '_blank');
    }
};

function deleteAttachment(attachmentId, ticketId) {
    if (confirm('Are you sure you want to delete this document?')) {
        fetch(`${window.CURRENT_ORIGIN}/tickets/${ticketId}/attachment/${attachmentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add a parameter to prevent infinite refreshes
                const separator = window.location.href.includes('?') ? '&' : '?';
                window.location.href = window.location.href + separator + 'refreshed=true';
            } else {
                alert('Error deleting document: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting document');
        });
    }
}

// Tracking Modal Functions
function showAddOutboundTrackingModal() {
    const modal = document.getElementById('addOutboundTrackingModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function hideAddOutboundTrackingModal() {
    const modal = document.getElementById('addOutboundTrackingModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function showAddReturnTrackingModal() {
    const modal = document.getElementById('addReturnTrackingModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function hideAddReturnTrackingModal() {
    const modal = document.getElementById('addReturnTrackingModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Initialize tracking form submissions
document.addEventListener('DOMContentLoaded', function() {
    // Initialize global variables that might be used elsewhere
    window.showLoading = function() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.classList.remove('hidden');
        }
    };
    
    window.hideLoading = function() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.classList.add('hidden');
        }
    };
    
    // Outbound tracking form submission
    const outboundTrackingBtn = document.getElementById('submitOutboundTrackingBtn');
    if (outboundTrackingBtn) {
        outboundTrackingBtn.addEventListener('click', function() {
            const trackingNumber = document.getElementById('outbound_tracking_number').value;
            const carrier = document.getElementById('outbound_carrier').value;
            
            if (!trackingNumber) {
                alert('Please enter a tracking number');
                return;
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Submit form data with direct origin URL
            fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add_outbound_tracking`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    tracking_number: trackingNumber,
                    carrier: carrier
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideAddOutboundTrackingModal();
                    showNotification('Outbound tracking added successfully', 'success');
                    // Reload page to show new tracking info
                    window.location.reload();
                } else {
                    showNotification(data.error || 'Failed to add tracking information', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An unexpected error occurred', 'error');
            });
        });
    }
    
    // Return tracking form submission
    const returnTrackingBtn = document.getElementById('submitReturnTrackingBtn');
    if (returnTrackingBtn) {
        returnTrackingBtn.addEventListener('click', function() {
            const trackingNumber = document.getElementById('return_tracking_number').value;
            const carrier = document.getElementById('return_carrier').value;
            
            if (!trackingNumber) {
                alert('Please enter a tracking number');
                return;
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Show a loading indication
            returnTrackingBtn.textContent = "{{ 'true' if ticket.return_tracking else 'false' }}" === "true" ? 'Updating...' : 'Saving...';
            returnTrackingBtn.disabled = true;
            
            // Submit form data with direct origin URL
            fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add_return_tracking`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    tracking_number: trackingNumber,
                    carrier: carrier
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Reset button state based on whether we're adding or updating
                const hasExistingTracking = "{{ 'true' if ticket.return_tracking else 'false' }}" === "true";
                returnTrackingBtn.textContent = hasExistingTracking ? 'Update Return Tracking' : 'Add Return Tracking';
                returnTrackingBtn.disabled = false;
                
                if (data.success) {
                    hideAddReturnTrackingModal();
                    const actionText = hasExistingTracking ? 'updated' : 'added';
                    showNotification(`Return tracking ${actionText} successfully`, 'success');
                    // Reload page to show new tracking info
                    window.location.reload();
                } else {
                    showNotification(data.message || 'Failed to add tracking information', 'error');
                }
            })
            .catch(error => {
                // Reset button state based on whether we're adding or updating
                const hasExistingTracking = "{{ 'true' if ticket.return_tracking else 'false' }}" === "true";
                returnTrackingBtn.textContent = hasExistingTracking ? 'Update Return Tracking' : 'Add Return Tracking';
                returnTrackingBtn.disabled = false;
                
                console.error('Error:', error);
                showNotification('An unexpected error occurred', 'error');
            });
        });
    }
    
    // Accessory form submission
    const submitAccessoryBtn = document.getElementById('submitAccessoryBtn');
    console.log('Submit accessory button element:', submitAccessoryBtn);
    if (submitAccessoryBtn) {
        submitAccessoryBtn.addEventListener('click', function() {
            console.log('Submit accessory button clicked');
            const name = document.getElementById('accessory_name').value;
            const category = document.getElementById('accessory_category').value;
            const quantity = document.getElementById('accessory_quantity').value;
            const condition = document.getElementById('accessory_condition').value;
            const notes = document.getElementById('accessory_notes').value;
            
            console.log('Form values:', { name, category, quantity, condition, notes });
            
            if (!name) {
                alert('Please enter an accessory name');
                return;
            }
            
            if (!category) {
                alert('Please select a category');
                return;
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            console.log('CSRF token found:', !!csrfToken);
            
            // Submit form data with dynamic base URL
            console.log('Submitting form data to endpoint:', `${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add-accessory`);
            fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/add-accessory`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    name: name,
                    category: category,
                    quantity: quantity,
                    condition: condition,
                    notes: notes
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    hideAddAccessoryModal();
                    showNotification('Accessory added successfully', 'success');
                    // Reload page to show new accessory
                    window.location.reload();
                } else {
                    showNotification(data.error || 'Failed to add accessory', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An unexpected error occurred', 'error');
            });
        });
    } else {
        // Silently ignore if button is not found
    }
    
    // Update accessory form submission
    const updateAccessoryBtn = document.getElementById('updateAccessoryBtn');
    if (updateAccessoryBtn) {
        updateAccessoryBtn.addEventListener('click', function() {
            const accessoryId = document.getElementById('edit_accessory_id').value;
            const name = document.getElementById('edit_accessory_name').value;
            const category = document.getElementById('edit_accessory_category').value;
            // Get quantity from input
            const quantity = document.getElementById('edit_accessory_quantity').value;
            const condition = document.getElementById('edit_accessory_condition').value;
            const notes = document.getElementById('edit_accessory_notes').value;
            
            if (!name) {
                alert('Please enter an accessory name');
                return;
            }
            
            if (!category) {
                alert('Please select a category');
                return;
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Submit form data with dynamic base URL
            fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/accessory/${accessoryId}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    name: name,
                    category: category,
                    quantity: quantity,
                    condition: condition,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideEditAccessoryModal();
                    showNotification('Accessory updated successfully', 'success');
                    // Reload page to show updated accessory
                    window.location.reload();
                } else {
                    showNotification(data.error || 'Failed to update accessory', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An unexpected error occurred', 'error');
            });
        });
    }
});

// Mark tracking as received functions
function markOutboundAsReceived(ticketId) {
    if (confirm('Are you sure you want to mark this package as received?')) {
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Submit status update with direct origin URL
        fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/update-shipping-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                status: 'Received'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Package marked as received', 'success');
                // Reload page to show updated status
                window.location.reload();
            } else {
                showNotification(data.error || 'Failed to update status', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An unexpected error occurred', 'error');
        });
    }
}

function markReturnAsReceived(ticketId) {
    if (confirm('Are you sure you want to mark this return package as received?')) {
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Submit status update with direct origin URL
        fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/update-return-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                status: 'Received'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Return package marked as received', 'success');
                // Reload page to show updated status
                window.location.reload();
            } else {
                showNotification(data.error || 'Failed to update status', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An unexpected error occurred', 'error');
        });
    }
}

// Accessory Modal Functions
function showAddAccessoryModal() {
    const modal = document.getElementById('addAccessoryModal');
    if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
}

function hideAddAccessoryModal() {
    const modal = document.getElementById('addAccessoryModal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
}

function showEditAccessoryModal() {
    const modal = document.getElementById('editAccessoryModal');
    if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
}

function hideEditAccessoryModal() {
    console.log('Hiding edit accessory modal...');
    const modal = document.getElementById('editAccessoryModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        console.log('Modal hidden successfully');
    } else {
        console.error('Modal not found when trying to hide');
    }
}

// New function for dynamic modal update
function updateAccessoryDynamic(accessoryId) {
    console.log('Updating accessory via dynamic modal:', accessoryId);
    
    // Get values from dynamic modal
    const name = document.getElementById('dynamic_edit_accessory_name').value;
    const category = document.getElementById('dynamic_edit_accessory_category').value;
    const quantity = parseInt(document.getElementById('dynamic_edit_accessory_quantity').value);
    const condition = document.getElementById('dynamic_edit_accessory_condition').value;
    const notes = document.getElementById('dynamic_edit_accessory_notes').value;
    
    // Get CSRF token
    const updateCsrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Submit update request
    fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/accessory/${accessoryId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': updateCsrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            name: name,
            category: category,
            quantity: quantity,
            condition: condition,
            notes: notes,
            csrf_token: updateCsrfToken
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            document.getElementById('dynamicEditModal').remove();
            document.body.style.overflow = '';
            
            // Show success and reload
            alert('Accessory updated successfully!');
            window.location.reload();
        } else {
            alert('Error updating accessory: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error updating accessory:', error);
        alert('Error updating accessory. Please try again.');
    });
}

let isEditingAccessory = false;

function editAccessory(accessoryId) {
    console.log('=== EDIT ACCESSORY DEBUG START ===');
    console.log('Accessory ID:', accessoryId);
    console.log('isEditingAccessory:', isEditingAccessory);
    
    if (isEditingAccessory) {
        console.log('Already editing an accessory, ignoring request');
        return;
    }
    
    console.log('Setting isEditingAccessory to true');
    isEditingAccessory = true;
    
    // First, let's check if the modal exists
    const modal = document.getElementById('editAccessoryModal');
    console.log('Modal element found:', modal !== null);
    if (!modal) {
        console.error('CRITICAL: editAccessoryModal element not found in DOM!');
        alert('Error: Edit modal not found. Please refresh the page.');
        isEditingAccessory = false;
        return;
    }
    
    // Get accessory data with dynamic base URL
    const fetchUrl = `${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/accessory/${accessoryId}`;
    console.log('Fetching from URL:', fetchUrl);
    
    fetch(fetchUrl, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Fetch response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Accessory data received:', data);
        if (data.success) {
            const accessory = data.accessory;
            console.log('Accessory details:', accessory);
            
            // Check if form fields exist before populating
            const fields = {
                'edit_accessory_id': accessory.id,
                'edit_accessory_name': accessory.name,
                'edit_accessory_category': accessory.category,
                'edit_accessory_quantity': accessory.quantity,
                'edit_accessory_condition': accessory.condition,
                'edit_accessory_notes': accessory.notes || ''
            };
            
            console.log('Populating form fields...');
            for (const [fieldId, value] of Object.entries(fields)) {
                const field = document.getElementById(fieldId);
                console.log(`Field ${fieldId}:`, field !== null, 'Value:', value);
                if (field) {
                    field.value = value;
                } else {
                    console.error(`Field ${fieldId} not found!`);
                }
            }
            
            // Show modal - Use dynamic creation to bypass CSS conflicts
            console.log('Attempting to show modal...');
            
            // Remove existing modal if it exists
            const existingModal = document.getElementById('dynamicEditModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal dynamically
            const dynamicModal = document.createElement('div');
            dynamicModal.id = 'dynamicEditModal';
            dynamicModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 999999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); width: 500px; max-width: 90vw; max-height: 90vh; overflow-y: auto;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold;">Edit Accessory</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Accessory Name</label>
                            <input type="text" id="dynamic_edit_accessory_name" value="${accessory.name}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Category</label>
                            <select id="dynamic_edit_accessory_category" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="Keyboard" ${accessory.category === 'Keyboard' ? 'selected' : ''}>Keyboard</option>
                                <option value="Mouse" ${accessory.category === 'Mouse' ? 'selected' : ''}>Mouse</option>
                                <option value="Monitor" ${accessory.category === 'Monitor' ? 'selected' : ''}>Monitor</option>
                                <option value="Docking Station" ${accessory.category === 'Docking Station' ? 'selected' : ''}>Docking Station</option>
                                <option value="Cable" ${accessory.category === 'Cable' ? 'selected' : ''}>Cable</option>
                                <option value="Power Adapter" ${accessory.category === 'Power Adapter' ? 'selected' : ''}>Power Adapter</option>
                                <option value="Headset" ${accessory.category === 'Headset' ? 'selected' : ''}>Headset</option>
                                <option value="Other" ${accessory.category === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Quantity</label>
                            <input type="number" id="dynamic_edit_accessory_quantity" value="${accessory.quantity}" min="1" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Condition</label>
                            <select id="dynamic_edit_accessory_condition" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="Good" ${accessory.condition === 'Good' ? 'selected' : ''}>Good</option>
                                <option value="Fair" ${accessory.condition === 'Fair' ? 'selected' : ''}>Fair</option>
                                <option value="Poor" ${accessory.condition === 'Poor' ? 'selected' : ''}>Poor</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Notes</label>
                            <textarea id="dynamic_edit_accessory_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;">${accessory.notes || ''}</textarea>
                        </div>
                        
                        <div style="text-align: right;">
                            <button onclick="document.getElementById('dynamicEditModal').remove(); document.body.style.overflow = '';" style="margin-right: 10px; padding: 8px 16px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="updateAccessoryDynamic(${accessoryId})" style="padding: 8px 16px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Update Accessory
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add to body
            document.body.appendChild(dynamicModal);
            document.body.style.overflow = 'hidden';
            
            console.log('Dynamic modal created and should be visible');
        } else {
            console.error('API returned error:', data.message);
            showNotification(data.message || 'Failed to get accessory data', 'error');
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        showNotification('An unexpected error occurred: ' + error.message, 'error');
    })
    .finally(() => {
        console.log('Setting isEditingAccessory back to false');
        isEditingAccessory = false;
        console.log('=== EDIT ACCESSORY DEBUG END ===');
    });
}

function removeAccessory(accessoryId, ticketId) {
    if (confirm('Are you sure you want to remove this accessory?')) {
        // Get CSRF token
        const removeCsrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Submit remove request with dynamic base URL
        fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/accessory/${accessoryId}/remove`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': removeCsrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                csrf_token: removeCsrfToken
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Accessory removed successfully', 'success');
                // Reload page to update UI
                window.location.reload();
            } else {
                showNotification(data.message || 'Failed to remove accessory', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An unexpected error occurred', 'error');
        });
    }
}

// Add event listener for update accessory button
document.addEventListener('DOMContentLoaded', function() {
    const updateBtn = document.getElementById('updateAccessoryBtn');
    if (updateBtn) {
        updateBtn.addEventListener('click', function() {
            const accessoryId = document.getElementById('edit_accessory_id').value;
            const name = document.getElementById('edit_accessory_name').value;
            const category = document.getElementById('edit_accessory_category').value;
            const quantity = document.getElementById('edit_accessory_quantity').value;
            const condition = document.getElementById('edit_accessory_condition').value;
            const notes = document.getElementById('edit_accessory_notes').value;
            
            // Validate required fields
            if (!name || !category || !quantity) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Get CSRF token
            const updateCsrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Submit update request
            fetch(`${window.CURRENT_ORIGIN}/tickets/{{ ticket.id }}/accessory/${accessoryId}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': updateCsrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    name: name,
                    category: category,
                    quantity: parseInt(quantity),
                    condition: condition,
                    notes: notes,
                    csrf_token: updateCsrfToken
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Accessory updated successfully', 'success');
                    hideEditAccessoryModal();
                    // Reload page to update UI
                    window.location.reload();
                } else {
                    showNotification(data.message || 'Failed to update accessory', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An unexpected error occurred', 'error');
            });
        });
    }
});
</script>

<script>
// Helper function to safely parse and format dates
function formatTrackingDate(dateString) {
    if (!dateString) return 'Unknown Date';
    
    try {
        // Try to parse the date string
        var dateObj = new Date(dateString);
        
        // Check if we got a valid date
        if (!isNaN(dateObj.getTime())) {
            return dateObj.toLocaleString();
        } else {
            console.log('Failed to parse date:', dateString);
            // Return the original string if parsing failed
            return dateString;
        }
    } catch (e) {
        console.error('Error parsing date:', e);
        return dateString;
    }
}

// Function to fetch shipping tracking information from cache (no force refresh)
function fetchShippingTrackingFromCache() {
    var trackingResults = document.getElementById('trackingResults');
    var trackingEvents = document.getElementById('trackingEvents');
    
    // First, determine the correct URL to use
    // Get the current location without any query parameters
    var baseUrl = window.location.protocol + '//' + window.location.host;
    var apiUrl = baseUrl + '/tickets/{{ ticket.id }}/track_claw';
    console.log('Fetching cached tracking info from:', apiUrl);
    
    // Call the tracking API with cached data
    fetch(apiUrl)
        .then(function(response) {
            if (!response.ok) {
                throw new Error('HTTP error! Status: ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            if (data.success && data.tracking_info && data.tracking_info.length > 0) {
                // Format tracking events
                var eventsHtml = '';
                data.tracking_info.forEach(function(event) {
                    var date = formatTrackingDate(event.date);
                    var status = event.status || 'Status unavailable';
                    var location = event.location || 'Location unavailable';
                    eventsHtml += '<div class="mb-2 pb-2 border-b border-gray-200">' +
                        '<div class="font-medium">' + status + '</div>' +
                        '<div class="text-gray-600 text-xs flex justify-between">' +
                        '<span>' + location + '</span>' +
                        '<span>' + date + '</span>' +
                        '</div>' +
                        '</div>';
                });
                trackingEvents.innerHTML = eventsHtml;
            } else {
                trackingEvents.innerHTML = 
                    '<div class="text-gray-500 p-2">' +
                    'No tracking information available at this time. Click "Refresh Tracking Information" to check for updates.' +
                    '</div>';
            }
        })
        .catch(function(error) {
            console.error('Error fetching tracking data:', error);
            trackingEvents.innerHTML = 
                '<div class="text-red-500 p-2">' +
                'Error fetching tracking data: ' + error.message +
                '</div>';
        });
}

// Function to fetch shipping tracking information from firecrawl with force refresh
function fetchShippingTracking() {
    var trackingBtn = document.getElementById('refreshShippingTrackingBtn');
    var trackingResults = document.getElementById('trackingResults');
    var trackingEvents = document.getElementById('trackingEvents');
    
    // Show loading state
    trackingBtn.disabled = true;
    trackingBtn.innerHTML = 
        '<svg class="w-4 h-4 mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
        '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>' +
        '<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>' +
        '</svg>' +
        'Loading tracking data...';
    
    // First, determine the correct URL to use
    // Get the current location without any query parameters
    var baseUrl = window.location.protocol + '//' + window.location.host;
    
    // Determine the correct endpoint based on ticket category
    var category = '{{ ticket.category.name if ticket.category else "" }}';
    var apiUrl;
    
    if (category === 'ASSET_CHECKOUT_CLAW') {
        apiUrl = baseUrl + '/tickets/category/checkout_claw/{{ ticket.id }}/track?force_refresh=true';
    } else if (category === 'ASSET_RETURN_CLAW') {
        apiUrl = baseUrl + '/tickets/{{ ticket.id }}/track_claw?force_refresh=true';
    } else {
        // Default for other asset checkout categories
        apiUrl = baseUrl + '/tickets/category/checkout_main/{{ ticket.id }}/track?force_refresh=true';
    }
    
    console.log('Fetching tracking info with force refresh from:', apiUrl);
    
    // Call the tracking API
    fetch(apiUrl)
        .then(function(response) {
            if (!response.ok) {
                throw new Error('HTTP error! Status: ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            // Display tracking data
            trackingResults.classList.remove('hidden');
            
            // Update current status in the UI if possible (ADDED STATUS UPDATE)
            try {
                var statusElement = document.querySelector('.sf-badge');
                if (statusElement && data.shipping_status) {
                    statusElement.textContent = data.shipping_status;
                    console.log('Updated outbound status to:', data.shipping_status);
                }
                
                // Also try to update the status in the grid display
                var gridStatusElement = document.querySelector('[class*="grid"] [class*="Status"] .font-medium, [class*="grid"] [class*="status"] .font-medium');
                if (gridStatusElement && data.shipping_status) {
                    gridStatusElement.textContent = data.shipping_status;
                    console.log('Updated grid status to:', data.shipping_status);
                }
            } catch(statusUpdateError) {
                console.warn('Could not update status display:', statusUpdateError);
            }
            
            if (data.success && data.tracking_info && data.tracking_info.length > 0) {
                // Format tracking events
                var eventsHtml = '';
                data.tracking_info.forEach(function(event) {
                    var date = formatTrackingDate(event.date);
                    var status = event.status || 'Status unavailable';
                    var location = event.location || 'Location unavailable';
                    eventsHtml += '<div class="mb-2 pb-2 border-b border-gray-200">' +
                        '<div class="font-medium">' + status + '</div>' +
                        '<div class="text-gray-600 text-xs flex justify-between">' +
                        '<span>' + location + '</span>' +
                        '<span>' + date + '</span>' +
                        '</div>' +
                        '</div>';
                });
                trackingEvents.innerHTML = eventsHtml;
            } else {
                var debugInfo = data.debug_info ? '<div class="text-xs mt-1">Debug: ' + JSON.stringify(data.debug_info) + '</div>' : '';
                trackingEvents.innerHTML = 
                    '<div class="text-gray-500 p-2">' +
                    'No tracking information available at this time. ' + 
                    debugInfo +
                    '</div>';
            }
        })
        .catch(function(error) {
            console.error('Error fetching tracking data:', error);
            trackingResults.classList.remove('hidden');
            trackingEvents.innerHTML = 
                '<div class="text-red-500 p-2">' +
                'Error fetching tracking data: ' + error.message +
                '</div>';
        })
        .finally(function() {
            // Reset button
            trackingBtn.disabled = false;
            trackingBtn.innerHTML = 
                '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                '</svg>' +
                'Refresh Tracking Information';
        });
}

    // Function to fetch return tracking information from cache (no force refresh)
function fetchReturnTrackingFromCache() {
    var trackingResults = document.getElementById('returnTrackingResults');
    var trackingEvents = document.getElementById('returnTrackingEvents');
    
    // First, determine the correct URL to use
    // Get the current location without any query parameters
    var baseUrl = window.location.protocol + '//' + window.location.host;
    var apiUrl = baseUrl + '/tickets/{{ ticket.id }}/track_return';
    console.log('Fetching cached return tracking info from:', apiUrl);
    
    // Call the tracking API with cached data
    fetch(apiUrl)
        .then(function(response) {
            if (!response.ok) {
                throw new Error('HTTP error! Status: ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            // Log data for debugging but don't display it in UI
            console.log('Return tracking data (cached):', data);
            
            if (data.success && data.tracking_info && data.tracking_info.length > 0) {
                // Format tracking events
                var eventsHtml = '';
                data.tracking_info.forEach(function(event) {
                    var date = formatTrackingDate(event.date);
                    var status = event.status || 'Status unavailable';
                    var location = event.location || 'Location unavailable';
                    eventsHtml += '<div class="mb-2 pb-2 border-b border-gray-200">' +
                        '<div class="font-medium">' + status + '</div>' +
                        '<div class="text-gray-600 text-xs flex justify-between">' +
                        '<span>' + location + '</span>' +
                        '<span>' + date + '</span>' +
                        '</div>' +
                        '</div>';
                });
                
                // Show formatted tracking events
                trackingEvents.innerHTML = 
                    '<div class="mb-4">' +
                    '<h5 class="font-bold text-gray-800 mb-2">Tracking Events:</h5>' +
                    eventsHtml +
                    '</div>';
            } else {
                trackingEvents.innerHTML = 
                    '<div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-2 rounded mb-3">' +
                    'No return tracking information available at this time. Click "Refresh Tracking Information" to check for updates.' +
                    '</div>';
            }
        })
        .catch(function(error) {
            console.error('Error fetching return tracking data:', error);
            trackingEvents.innerHTML = 
                '<div class="bg-red-100 border border-red-400 text-red-700 p-2 rounded mb-3">' +
                'Error fetching tracking data: ' + error.message +
                '</div>';
        });
}

// Function to fetch return tracking information with force refresh
function fetchReturnTracking() {
    console.log('fetchReturnTracking called - starting refresh process');
    var trackingBtn = document.getElementById('refreshReturnTrackingBtn');
    var trackingResults = document.getElementById('returnTrackingResults');
    var trackingEvents = document.getElementById('returnTrackingEvents');
    
    // Immediately update UI to show loading is in progress
    if (trackingEvents) {
        trackingEvents.innerHTML = 
            '<div class="text-center p-4">' +
            '<svg aria-hidden="true" class="inline w-8 h-8 text-gray-200 animate-spin fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">' +
            '<path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>' +
            '<path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>' +
            '</svg>' +
            '<p class="mt-2">Loading tracking data...</p>' +
            '</div>';
    }
    
    // Show loading state on button if it exists
    if (trackingBtn) {
        trackingBtn.disabled = true;
        trackingBtn.innerHTML = 
            '<svg class="w-4 h-4 mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>' +
            '<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>' +
            '</svg>' +
            'Loading tracking data...';
    }
    
    // First, determine the correct URL to use
    var baseUrl = window.location.protocol + '//' + window.location.host;
    var apiUrl = baseUrl + '/tickets/{{ ticket.id }}/track_return?force_refresh=true&t=' + new Date().getTime();
    console.log('Fetching return tracking info with force refresh from:', apiUrl);
    
    // Set a timeout in case the request takes too long
    var timeoutId = setTimeout(function() {
        console.log('Request timeout - showing fallback data');
        if (trackingEvents) {
            trackingEvents.innerHTML = 
                '<div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-2 rounded mb-3">' +
                'Request timed out. The server may be busy. Please try again.' +
                '<button onclick="fetchReturnTracking()" class="ml-2 text-blue-600 underline">Retry</button>' +
                '</div>';
        }
        if (trackingBtn) {
            trackingBtn.disabled = false;
            trackingBtn.innerHTML = 
                '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                '</svg>' +
                'Refresh Tracking Information';
        }
    }, 15000); // 15 second timeout
    
    // Call the tracking API with a fresh AJAX request
    var xhr = new XMLHttpRequest();
    xhr.open('GET', apiUrl, true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            clearTimeout(timeoutId); // Clear the timeout since we got a response
            
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    console.log('XHR data received:', data);
                    
                    if (trackingResults) {
                        trackingResults.classList.remove('hidden');
                    }
                    
                    // Update current status in the UI if possible
                    try {
                        var statusElement = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-3.gap-4 div:nth-child(3) .font-medium');
                        if (statusElement) {
                            var latestStatus = data.status || 
                                              (data.ticket_data && data.ticket_data.return_status) || 
                                              (data.tracking_info && data.tracking_info.length > 0 ? data.tracking_info[0].status : null) || 
                                              'Pending';
                            
                            statusElement.textContent = latestStatus;
                            
                            // Update carrier if available
                            if (data.ticket_data) {
                                var carrierElement = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-3.gap-4 div:nth-child(2) .font-medium');
                                if (carrierElement && data.ticket_data.return_carrier) {
                                    var carrier = data.ticket_data.return_carrier.charAt(0).toUpperCase() + data.ticket_data.return_carrier.slice(1);
                                    carrierElement.textContent = carrier;
                                }
                            }
                        }
                    } catch(e) {
                        console.error('Error updating status display:', e);
                    }
                    
                    // Update tracking events display
                    if (trackingEvents) {
                        if (data.success && data.tracking_info && data.tracking_info.length > 0) {
                            // Format tracking events
                            var eventsHtml = '';
                            data.tracking_info.forEach(function(event) {
                                var date = formatTrackingDate(event.date);
                                var status = event.status || 'Status unavailable';
                                var location = event.location || 'Location unavailable';
                                eventsHtml += '<div class="mb-2 pb-2 border-b border-gray-200">' +
                                    '<div class="font-medium">' + status + '</div>' +
                                    '<div class="text-gray-600 text-xs flex justify-between">' +
                                    '<span>' + location + '</span>' +
                                    '<span>' + date + '</span>' +
                                    '</div>' +
                                    '</div>';
                            });
                            
                            trackingEvents.innerHTML = 
                                '<div class="mb-4">' +
                                '<h5 class="font-bold text-gray-800 mb-2">Tracking Events:</h5>' +
                                eventsHtml +
                                '</div>';
                        } else {
                            trackingEvents.innerHTML = 
                                '<div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-2 rounded mb-3">' +
                                'No return tracking information available at this time.' +
                                '</div>';
                        }
                    }
                } catch (parseError) {
                    console.error('Error parsing JSON response:', parseError);
                    if (trackingEvents) {
                        trackingEvents.innerHTML = 
                            '<div class="bg-red-100 border border-red-400 text-red-700 p-2 rounded mb-3">' +
                            'Error processing tracking data. Please try again.' +
                            '</div>';
                    }
                }
            } else {
                console.error('XHR Error:', xhr.status, xhr.statusText);
                if (trackingEvents) {
                    trackingEvents.innerHTML = 
                        '<div class="bg-red-100 border border-red-400 text-red-700 p-2 rounded mb-3">' +
                        'Error fetching tracking data: ' + xhr.status + ' ' + xhr.statusText +
                        '</div>';
                }
            }
            
            // Reset button state
            if (trackingBtn) {
                trackingBtn.disabled = false;
                trackingBtn.innerHTML = 
                    '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                    '</svg>' +
                    'Refresh Tracking Information';
            }
        }
    };
    
    xhr.onerror = function() {
        clearTimeout(timeoutId);
        console.error('XHR Network Error');
        if (trackingEvents) {
            trackingEvents.innerHTML = 
                '<div class="bg-red-100 border border-red-400 text-red-700 p-2 rounded mb-3">' +
                'Network error fetching tracking data. Please check your connection and try again.' +
                '</div>';
        }
        if (trackingBtn) {
            trackingBtn.disabled = false;
            trackingBtn.innerHTML = 
                '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                '</svg>' +
                'Refresh Tracking Information';
        }
    };
    
    xhr.send();
}
</script>

<!-- Simple tab system - Added at the end of the page -->
<script>
// Simple modal functions
function openSimpleModal() {
    document.getElementById('simpleAccessoryModal').style.display = 'block';
    console.log('Simple modal opened');
}

function closeSimpleModal() {
    document.getElementById('simpleAccessoryModal').style.display = 'none';
    console.log('Simple modal closed');
}

// Wait for the DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Auto-load shipping tracking data on page load if tracking number exists
    if (document.getElementById('trackingResults')) {
        // Check if we have a tracking number based on ticket data
        var hasShippingTracking = "{{ 'true' if ticket.shipping_tracking else 'false' }}" === "true";
        if (hasShippingTracking) {
            console.log('Loading shipping tracking data automatically');
            // Load tracking data automatically with a small delay to ensure page is fully loaded
            setTimeout(function() {
                // Call the tracking function but without force refresh to use cached data
                fetchShippingTrackingFromCache();
            }, 300);
        }
    }
    
    // Auto-load return tracking data on page load if tracking number exists
    if (document.getElementById('returnTrackingResults')) {
        // Check if we have a return tracking number based on ticket data
        var hasReturnTracking = "{{ 'true' if ticket.return_tracking else 'false' }}" === "true";
        if (hasReturnTracking) {
            console.log('Loading return tracking data automatically from cache');
            // Load tracking data automatically with a small delay to ensure page is fully loaded
            setTimeout(function() {
                // Call the tracking function WITHOUT force refresh to use cached data first
                fetchReturnTrackingFromCache();
            }, 500);
        }
    }
    
    // Debug modal existence
    console.log('Checking modal existence...');
    const simpleModal = document.getElementById('simpleAccessoryModal');
    console.log('Simple modal exists:', !!simpleModal);
    if (simpleModal) {
        console.log('Modal element found with ID simpleAccessoryModal');
    } else {
        console.error('Modal element NOT found with ID simpleAccessoryModal');
        // Try to find all elements that might be the modal
        const allDivs = document.querySelectorAll('div');
        console.log('Total divs:', allDivs.length);
        const possibleModals = Array.from(allDivs).filter(div => 
            div.id && div.id.toLowerCase().includes('modal'));
        console.log('Possible modal divs:', possibleModals.map(m => m.id));
    }
    
    // Fix accessory modal issue once and for all
    const addAccessoryModal = document.getElementById('addAccessoryModal');
    
    // Find the Add Accessory button more reliably
    let addAccessoryBtn = null;
    const buttons = document.querySelectorAll('button.sf-button.primary-button');
    buttons.forEach(button => {
        if (button.textContent.trim().includes('Add Accessory')) {
            addAccessoryBtn = button;
        }
    });
    
    if (addAccessoryBtn) {
        console.log('Found Add Accessory button, adding direct event listener');
        // Remove existing onclick handler and add new event listener
        addAccessoryBtn.removeAttribute('onclick');
        addAccessoryBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Add Accessory button clicked via event listener');
            
            if (addAccessoryModal) {
                console.log('Showing accessory modal');
                addAccessoryModal.style.display = 'block';
                addAccessoryModal.style.zIndex = '9999';
                addAccessoryModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            } else {
                console.error('Modal element not found!');
            }
            return false;
        });
    } else {
        console.warn('Add Accessory button not found');
    }
    
    // Initialize global variables that might be used elsewhere
    window.showLoading = function() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.classList.remove('hidden');
        }
    };
    
    window.hideLoading = function() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.classList.add('hidden');
        }
    };
    
    // Tab system removed - all sections now display sequentially
    
    // ========================================
    // @MENTION FUNCTIONALITY
    // ========================================
    
    // Store user data for @mentions
    var userDataJson = '{{ users|tojson|safe }}';
    var userData;
    try {
        userData = JSON.parse(userDataJson.replace(/&quot;/g, '"'));
    } catch (e) {
        userData = [];
        console.error('Error parsing user data:', e);
    }
    
    var currentMentionStart = -1;
    var selectedIndex = -1;
    var textarea;
    var suggestions;

    // Initialize @mention functionality
    textarea = document.getElementById('message');
    suggestions = document.getElementById('mentionSuggestions');
    
    if (textarea && suggestions) {
        textarea.addEventListener('input', handleInput);
        textarea.addEventListener('keydown', handleKeydown);
        console.log('✅ @Mention functionality initialized');
    } else {
        console.warn('❌ @Mention elements not found:', {textarea: !!textarea, suggestions: !!suggestions});
    }

    function handleInput(e) {
        var pos = textarea.selectionStart;
        var text = textarea.value;
    
        // Find @ symbol before cursor
        var i = pos;
        while (i > 0 && text[i-1] !== ' ' && text[i-1] !== '\n') i--;
        var word = text.slice(i, pos);
    
        if (word.startsWith('@')) {
            currentMentionStart = i;
            var search = word.slice(1).toLowerCase();
            showSuggestions(search);
        } else {
            hideSuggestions();
        }
    }

    function handleKeydown(e) {
        if (!suggestions.classList.contains('hidden')) {
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectNext();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectPrevious();
                    break;
                case 'Enter':
                case 'Tab':
                    if (selectedIndex >= 0) {
                        e.preventDefault();
                        insertMention();
                    }
                    break;
                case 'Escape':
                    hideSuggestions();
                    break;
            }
        }
    }

    function showSuggestions(search) {
        var matches = [];
        
        // Only proceed if userData is an object
        if (typeof userData === 'object' && userData !== null) {
            // Convert object to array if needed
            var users = Array.isArray(userData) ? userData : Object.values(userData);
            
            matches = users.filter(function(user) {
                return user && user.username && 
                       user.username.toLowerCase().includes(search);
            });
        }
    
        if (matches.length > 0) {
            suggestions.innerHTML = matches.map(function(user, index) {
                return '<div class="mention-suggestion" data-username="' + 
                       user.username + '" data-index="' + index + '">' +
                       user.username + '</div>';
            }).join('');
            
            suggestions.querySelectorAll('.mention-suggestion').forEach(function(el) {
                el.addEventListener('click', function() {
                    selectedIndex = parseInt(el.dataset.index);
                    insertMention();
                });
                el.addEventListener('mouseover', function() {
                    selectedIndex = parseInt(el.dataset.index);
                    updateSelection();
                });
            });
        
            selectedIndex = 0;
            updateSelection();
        
            // Position suggestions below cursor
            var coords = getCaretCoordinates(textarea, textarea.selectionStart);
            suggestions.style.top = (coords.top + 20) + 'px';
            suggestions.style.left = coords.left + 'px';
            suggestions.classList.remove('hidden');
        } else {
            hideSuggestions();
        }
    }

    function hideSuggestions() {
        suggestions.classList.add('hidden');
        currentMentionStart = -1;
        selectedIndex = -1;
    }

    function selectNext() {
        var items = suggestions.querySelectorAll('.mention-suggestion');
        selectedIndex = (selectedIndex + 1) % items.length;
        updateSelection();
    }

    function selectPrevious() {
        var items = suggestions.querySelectorAll('.mention-suggestion');
        selectedIndex = (selectedIndex - 1 + items.length) % items.length;
        updateSelection();
    }

    function updateSelection() {
        suggestions.querySelectorAll('.mention-suggestion').forEach(function(el, i) {
            el.classList.toggle('selected', i === selectedIndex);
        });
    }

    function insertMention() {
        var selected = suggestions.querySelector('.mention-suggestion.selected');
        if (selected && currentMentionStart >= 0) {
            var username = selected.dataset.username;
            var text = textarea.value;
            var before = text.slice(0, currentMentionStart);
            var after = text.slice(textarea.selectionStart);
            textarea.value = before + '@' + username + ' ' + after;
            var cursorPos = currentMentionStart + username.length + 2;
            textarea.setSelectionRange(cursorPos, cursorPos);
            textarea.focus();
        }
        hideSuggestions();
    }

    // Helper function to get caret coordinates
    function getCaretCoordinates(element, position) {
        var div = document.createElement('div');
        var styles = getComputedStyle(element);
        var properties = [
            'direction', 'boxSizing', 'width', 'height', 'overflowX', 'overflowY',
            'borderTopWidth', 'borderRightWidth', 'borderBottomWidth', 'borderLeftWidth',
            'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft',
            'fontStyle', 'fontVariant', 'fontWeight', 'fontStretch', 'fontSize',
            'fontSizeAdjust', 'lineHeight', 'fontFamily', 'textAlign', 'textTransform',
            'textIndent', 'textDecoration', 'letterSpacing', 'wordSpacing'
        ];

        properties.forEach(function(prop) {
            div.style[prop] = styles[prop];
        });

        div.style.position = 'absolute';
        div.style.visibility = 'hidden';
        div.style.whiteSpace = 'pre-wrap';
        div.style.wordWrap = 'break-word';

        div.textContent = element.value.substring(0, position);

        var span = document.createElement('span');
        span.textContent = element.value.substring(position) || '.';
        div.appendChild(span);

        document.body.appendChild(div);

        var coordinates = {
            top: span.offsetTop + parseInt(styles.borderTopWidth),
            left: span.offsetLeft + parseInt(styles.borderLeftWidth)
        };

        document.body.removeChild(div);

        return coordinates;
    }
    
    console.log('✅ @Mention system fully loaded');

});
</script>
<!-- Simple script to fix accessories loading -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded, fixing accessories dropdowns...");
    
    // Find all accessory select dropdowns
    const selects = document.querySelectorAll('select[id*="existing_accessory_select"]');
    console.log("Found", selects.length, "accessory dropdowns");
    
    selects.forEach((select, index) => {
        console.log(`Loading accessories for dropdown ${index + 1}...`);
        
        // Load accessories for this dropdown
        fetch('/tickets/api/accessories', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Accessories loaded for dropdown ${index + 1}:`, data);
            select.innerHTML = '<option value="">-- Select an Accessory --</option>';
            
            if (data.success && data.accessories && data.accessories.length > 0) {
                // Sort accessories by name
                data.accessories.sort((a, b) => a.name.localeCompare(b.name));
                
                data.accessories.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.id;
                    option.text = `${acc.name} (${acc.category}) - Qty: ${acc.available_quantity}`;
                    select.appendChild(option);
                });
                console.log(`Successfully loaded ${data.accessories.length} accessories for dropdown ${index + 1}`);
            } else {
                const option = document.createElement('option');
                option.value = "";
                option.text = "No accessories available";
                select.appendChild(option);
            }
        })
        .catch(error => {
            console.error(`Error loading accessories for dropdown ${index + 1}:`, error);
            select.innerHTML = '<option value="">-- Error Loading --</option>';
        });
    });
});
</script>

        </div> <!-- Close white background wrapper -->
    </div> <!-- Close container -->
</div> <!-- Close bg-gray-100 -->
{% endblock %}

<!-- Debug button for accessory modal (will be removed after fixing) -->
<div style="position: fixed; bottom: 10px; right: 10px; z-index: 10001;">
    <button id="debugOpenModal" style="padding: 10px; background-color: #ff5722; color: white; font-weight: bold; border-radius: 4px;">
        Go to Accessory Form
    </button>
</div>

<script>
    // Direct debug function to open the modal
    document.addEventListener('DOMContentLoaded', function() {
        const debugBtn = document.getElementById('debugOpenModal');
        if (debugBtn) {
            debugBtn.addEventListener('click', function() {
                console.log('Debug button clicked - scrolling to form');
                const formSection = document.getElementById('directAccessorySectionCheckout');
                if (formSection) {
                    formSection.scrollIntoView({behavior: 'smooth'});
                    // Highlight the form section
                    formSection.style.boxShadow = '0 0 20px rgba(255, 87, 34, 0.8)';
                    setTimeout(() => {
                        formSection.style.boxShadow = 'none';
                    }, 2000);
                } else {
                    console.error('Form section not found');
                }
            });
        }
    });
</script>

<!-- Add simple modal functions -->
<script>
function openSimpleModal() {
    document.getElementById('simpleAccessoryModal').style.display = 'block';
    console.log('Simple modal opened');
}

function closeSimpleModal() {
    document.getElementById('simpleAccessoryModal').style.display = 'none';
    console.log('Simple modal closed');
}
</script>

<!-- Add missing tracking functions for Asset Checkout (Claw) -->
<script>
// Function to refresh outbound tracking for Asset Checkout categories
function refreshOutboundTracking() {
    const trackingInfo = document.getElementById('trackingInfo');
    const trackingLoading = document.getElementById('trackingLoading');
    const trackingError = document.getElementById('trackingError');
    
    if (!trackingInfo || !trackingLoading || !trackingError) {
        console.error('Required outbound tracking elements not found');
        return;
    }
    
    // Show loading state for outbound tracking
    trackingInfo.classList.add('hidden');
    trackingError.classList.add('hidden');
    trackingLoading.classList.remove('hidden');
    
    console.log('Refreshing outbound tracking for ticket {{ ticket.id }}');
    
    // Determine the correct tracking endpoint based on category
    let trackingEndpoint;
    const category = '{{ ticket.category.name if ticket.category else "" }}';
    
    if (category === 'ASSET_CHECKOUT_CLAW') {
        trackingEndpoint = `/tickets/category/checkout_claw/{{ ticket.id }}/track`;
    } else {
        trackingEndpoint = `/tickets/category/checkout_main/{{ ticket.id }}/track`;
    }
    
    // Fetch outbound tracking
    fetch(trackingEndpoint)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.tracking_info && data.tracking_info.length > 0) {
                const trackingHtml = data.tracking_info.map((entry, index) => `
                    <div class="p-4 relative hover:bg-gray-50 transition-colors duration-150">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 rounded-full ${index === 0 ? 'bg-blue-100' : 'bg-gray-100'} flex items-center justify-center">
                                    <svg class="w-5 h-5 ${index === 0 ? 'text-blue-600' : 'text-gray-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="${index === 0 ? 'text-blue-900 font-medium' : 'text-gray-900'} text-sm">
                                            ${entry.status}
                                        </p>
                                        <p class="mt-1 text-sm ${index === 0 ? 'text-blue-700' : 'text-gray-500'}">
                                            ${entry.location || 'Singapore'}
                                        </p>
                                    </div>
                                    <time class="text-sm ${index === 0 ? 'text-blue-700' : 'text-gray-500'} whitespace-nowrap ml-4">
                                        ${entry.date}
                                    </time>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                trackingInfo.innerHTML = `<h4 class="font-medium text-gray-700 mb-2">Tracking Events:</h4>${trackingHtml}`;
                trackingInfo.classList.remove('hidden');
            } else {
                trackingInfo.innerHTML = `
                    <div class="p-4">
                        <p class="text-sm text-gray-500">Pending - Tracking information will be available once the package starts moving.</p>
                    </div>
                `;
                trackingInfo.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error fetching outbound tracking:', error);
            
            // Show a user-friendly error message
            trackingInfo.innerHTML = `
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-7.938 4h15.876c1.398 0 2.69-.806 3.316-2.065a4.017 4.017 0 000-4.87C21.69 10.806 20.398 10 19 10H5c-1.398 0-2.69.806-3.316 2.065a4.017 4.017 0 000 4.87C2.31 17.194 3.602 18 5 18z" />
                        </svg>
                        <div>
                            <h3 class="text-sm font-medium text-yellow-800">Tracking Temporarily Unavailable</h3>
                            <p class="text-sm text-yellow-700 mt-1">
                                Unable to fetch live tracking data. This can happen when the tracking service is updating or experiencing high traffic.
                            </p>
                            <p class="text-sm text-yellow-700 mt-1">
                                <strong>Status:</strong> Pending - Your package is being processed
                            </p>
                            <button onclick="refreshOutboundTracking()" class="mt-2 text-sm text-yellow-800 underline hover:text-yellow-900">
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
            trackingInfo.classList.remove('hidden');
        })
        .finally(() => {
            trackingLoading.classList.add('hidden');
        });
}





// Auto-load tracking on page load for Asset Checkout categories
document.addEventListener('DOMContentLoaded', function() {
    const category = '{{ ticket.category.name if ticket.category else "" }}';
    const hasTracking = '{{ ticket.shipping_tracking or "" }}';
    
    if ((category === 'ASSET_CHECKOUT_CLAW' || category === 'ASSET_CHECKOUT_MAIN') && hasTracking) {
        setTimeout(refreshOutboundTracking, 1000); // Delay to ensure elements are loaded
    }
    

});
</script>

<script>
// Call loadAccessories right away on page load
console.log("Calling loadAccessories() immediately");
loadAccessories();

// Also set up DOMContentLoaded event just in case
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOMContentLoaded: Calling loadAccessories() again");
    loadAccessories();
});

// Store the quantities of accessories to track updates
const accessoryQuantities = {};

// Function to update the accessory table with new data
function updateAccessoryTable(accessory) {
    const tableBody = document.getElementById('accessoryTableBody');
    
    // Check if there's a "No accessories" row that needs to be removed
    const noAccessoriesRow = tableBody.querySelector('tr td[colspan="5"]');
    if (noAccessoriesRow) {
        tableBody.innerHTML = '';
    }
    
    // Check if the accessory already exists in the table
    const existingRow = Array.from(tableBody.querySelectorAll('tr')).find(row => {
        const accessoryIdCell = row.querySelector('td[data-accessory-id]');
        return accessoryIdCell && accessoryIdCell.dataset.accessoryId === accessory.id.toString();
    });
    
    if (existingRow) {
        // Update existing row
        const quantityCell = existingRow.querySelector('td:nth-child(3)');
        const currentQuantity = parseInt(quantityCell.textContent);
        quantityCell.textContent = currentQuantity + accessory.quantity;
    } else {
        // Create new row
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td data-accessory-id="${accessory.id}">${accessory.name}</td>
            <td>${accessory.category}</td>
            <td>${accessory.quantity}</td>
            <td>
                <span class="sf-badge ${accessory.condition === 'Good' ? 'sf-badge-success' : accessory.condition === 'Fair' ? 'sf-badge-warning' : 'sf-badge-danger'}">
                    ${accessory.condition}
                </span>
            </td>
            <td>
                <div class="flex gap-2">
                    <button onclick="editAccessory('${accessory.id}')" class="text-blue-600 hover:text-blue-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                    <button onclick="removeAccessory('${accessory.id}', '{{ ticket.id }}')" class="text-red-600 hover:text-red-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </td>
        `;
        tableBody.appendChild(newRow);
    }
}
</script>

<!-- Import Tech Asset Modal -->
<div id="importTechAssetModal" class="fixed inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Import Tech Assets from CSV
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                Upload a CSV file to import multiple tech assets and link them to this ticket.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <form id="importForm" action="/inventory/import" method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="import_type" value="tech_assets">
                        <input type="hidden" name="ticket_id" value="{{ ticket.id }}">
                        
                        <div class="space-y-4">
                            <div>
                                <label for="csvFile" class="block text-sm font-medium text-gray-700">CSV File</label>
                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                    <div class="space-y-1 text-center">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <div class="flex text-sm text-gray-600">
                                            <label for="csvFile" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                                <span>Upload a file</span>
                                                <input id="csvFile" name="file" type="file" accept=".csv" required class="sr-only">
                                            </label>
                                            <p class="pl-1">or drag and drop</p>
                                        </div>
                                        <p class="text-xs text-gray-500">CSV files only</p>
                                    </div>
                                </div>
                                <div id="fileName" class="mt-2 text-sm text-gray-600 hidden"></div>
                            </div>
                            
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">
                                            <strong>CSV Format Requirements:</strong><br>
                                            Required columns: Asset Tag, Serial Number, Product, Model, Asset Type<br>
                                            Optional columns: Hardware Type, CPU Type, Memory, Hard Drive, Status, Customer, Country, etc.
                                        </p>
                                        <div class="mt-2">
                                            <a href="/inventory/download-template/tech_assets" class="text-sm text-blue-600 hover:text-blue-500">
                                                Download CSV template →
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitImportForm()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Import Assets
                </button>
                <button type="button" onclick="closeImportTechAssetModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Show Import Tech Asset Modal
function showImportTechAssetModal() {
    document.getElementById('importTechAssetModal').classList.remove('hidden');
}

// Close Import Tech Asset Modal
function closeImportTechAssetModal() {
    document.getElementById('importTechAssetModal').classList.add('hidden');
    // Reset form
    document.getElementById('importForm').reset();
    document.getElementById('fileName').classList.add('hidden');
}

// Handle file selection
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('csvFile');
    const fileNameDiv = document.getElementById('fileName');
    
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileNameDiv.textContent = `Selected file: ${file.name}`;
                fileNameDiv.classList.remove('hidden');
            } else {
                fileNameDiv.classList.add('hidden');
            }
        });
    }
});

// Submit import form
function submitImportForm() {
    const form = document.getElementById('importForm');
    const fileInput = document.getElementById('csvFile');
    
    if (!fileInput.files.length) {
        alert('Please select a CSV file to import.');
        return;
    }
    
    // Show loading state
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Importing...';
    
    // Submit the form
    form.submit();
}
