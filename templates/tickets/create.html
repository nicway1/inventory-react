{% extends "base.html" %}

{% block content %}
<!-- Add Select2 CSS in the head -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="{{ url_for('static', filename='css/queue_manager.css') }}" rel="stylesheet" />

<style>
/* Custom styles for customer search results */
.select2-result-customer {
    padding: 6px 12px;
}

.select2-result-customer__title {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 2px;
}

.select2-result-customer__description {
    font-size: 0.875rem;
    color: #6b7280;
    line-height: 1.25;
}

.select2-container--default .select2-results__option--highlighted .select2-result-customer__title {
    color: white;
}

.select2-container--default .select2-results__option--highlighted .select2-result-customer__description {
    color: #e5e7eb;
}

/* Improve Select2 dropdown appearance */
.select2-container .select2-selection--single {
    height: 38px;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 36px;
    padding-left: 12px;
    color: #374151;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
    right: 10px;
}

.select2-dropdown {
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.select2-container--default .select2-search--dropdown .select2-search__field {
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    padding: 8px 12px;
}

.select2-container--default .select2-results__option {
    padding: 0;
}

.select2-container--default .select2-results__option--highlighted {
    background-color: #3b82f6;
}
</style>

<!-- Salesforce-Style Create Ticket Page -->
<div class="min-h-screen bg-gray-50">
    <!-- SF Header Bar -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('tickets.list_tickets_sf') }}"
                       class="flex items-center text-white/80 hover:text-white transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Back to Tickets
                    </a>
                </div>
                <h1 class="text-xl font-semibold text-white">New Ticket</h1>
                <div class="w-32"></div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Category Guide -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden sticky top-8">
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-5 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Category Guide
                        </h2>
                    </div>
                    <div class="p-4 max-h-[calc(100vh-200px)] overflow-y-auto">
                        <div class="space-y-3" id="categoryGuide">
                            {% set icon_svgs = {
                                'settings': 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z|M15 12a3 3 0 11-6 0 3 3 0 016 0z',
                                'box': 'M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4',
                                'return': 'M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6',
                                'upload': 'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12',
                                'transfer': 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4',
                                'document': 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
                                'money': 'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z',
                                'trash': 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16'
                            } %}

                            {% set has_quotations = namespace(value=false) %}
                            {% for display_name, info in category_guide.items() if not info.group %}
                                {% set has_quotations.value = true %}
                            {% endfor %}

                            {# Render non-grouped categories first #}
                            {% for display_name, info in category_guide.items() if not info.group %}
                            <div class="category-guide-item p-3 rounded-lg border border-gray-100 hover:border-blue-200 hover:bg-blue-50/50 cursor-pointer transition-all" data-category="{{ display_name }}">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 w-8 h-8 bg-{{ info.icon_color }}-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-4 h-4 text-{{ info.icon_color }}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            {% for path in icon_svgs[info.icon].split('|') %}
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="{{ path }}"/>
                                            {% endfor %}
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900">{{ display_name }}</p>
                                        <p class="text-xs text-gray-500 mt-0.5">{{ info.description }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                            {# Render Quotations group if any exist #}
                            {% set quotation_categories = [] %}
                            {% for display_name, info in category_guide.items() if info.group == 'Quotations' %}
                                {% set _ = quotation_categories.append((display_name, info)) %}
                            {% endfor %}

                            {% if quotation_categories %}
                            <div class="mt-4 pt-4 border-t border-gray-100">
                                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Quotations</p>
                                {% for display_name, info in quotation_categories %}
                                <div class="category-guide-item p-3 rounded-lg border border-gray-100 hover:border-blue-200 hover:bg-blue-50/50 cursor-pointer transition-all {% if not loop.first %}mt-2{% endif %}" data-category="{{ display_name }}">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 w-8 h-8 bg-{{ info.icon_color }}-100 rounded-lg flex items-center justify-center mr-3">
                                            <svg class="w-4 h-4 text-{{ info.icon_color }}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                {% for path in icon_svgs[info.icon].split('|') %}
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="{{ path }}"/>
                                                {% endfor %}
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900">{{ display_name }}</p>
                                            <p class="text-xs text-gray-500 mt-0.5">{{ info.description }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Form -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <!-- Form Header -->
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-lg font-semibold text-gray-800">Ticket Details</h2>
                                <p class="text-sm text-gray-500 mt-0.5">Fill in the required information below</p>
                            </div>
                            <span id="selectedCategoryBadge" class="hidden px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-700">
                                No category selected
                            </span>
                        </div>
                    </div>

                    <form id="ticketForm" method="POST" enctype="multipart/form-data" class="p-6">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- Category Selection - SF Style -->
                        <div class="mb-6">
                            <label for="category" class="block text-sm font-semibold text-gray-700 mb-2">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                    </svg>
                                    Category <span class="text-red-500 ml-0.5">*</span>
                                </span>
                            </label>
                            <select id="category"
                                    name="category"
                                    required
                                    onchange="onCategoryChange(); updateCategoryBadge();"
                                    class="block w-full px-4 py-3 rounded-lg border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 text-gray-700 text-base transition-all">
                                <option value="">-- Select a Category --</option>
                                {% for category in categories %}
                                <option value="{{ category.value }}" {% if form and form.category == category.value %}selected{% endif %}>{{ category.display_name|hide_claw }}</option>
                                {% endfor %}
                            </select>
                            <p class="mt-2 text-xs text-gray-500">
                                <svg class="w-3.5 h-3.5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Select a category from the dropdown or click on the guide cards on the left
                            </p>
                        </div>

                        <!-- Divider -->
                        <div class="border-t border-gray-100 my-6"></div>

                <!-- PIN Request Fields -->
                <div id="pinRequestFields" class="hidden space-y-6">
                    <!-- Country -->
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-700">Country</label>
                        <input type="text" 
                               id="country" 
                               name="country" 
                               value="{{ form.country if form else '' }}"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Serial Number Selection -->
                    <div>
                        <label for="serial_number" class="block text-sm font-medium text-gray-700">Asset Selection</label>
                        <select id="serial_number" 
                                name="serial_number"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select an asset...</option>
                            {% for asset in assets %}
                            <option value="{{ asset.serial_number }}" 
                                    data-model="{{ asset.model }}"
                                    data-customer="{{ asset.customer }}"
                                    data-asset-tag="{{ asset.asset_tag }}"
                                    {% if form and form.serial_number == asset.serial_number %}selected{% endif %}>
                                {{ asset.serial_number }} - {{ asset.model }} ({{ asset.asset_tag }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Auto-populated fields -->
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700">Model</label>
                        <input type="text" 
                               id="model" 
                               name="model" 
                               value="{{ form.model if form else '' }}"
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <div>
                        <label for="customer_company" class="block text-sm font-medium text-gray-700">Customer Company</label>
                        <input type="text" 
                               id="customer_company" 
                               name="customer_company" 
                               value="{{ form.customer_company if form else '' }}"
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <!-- Lock Type -->
                    <div>
                        <label for="lock_type" class="block text-sm font-medium text-gray-700">Lock Type</label>
                        <select id="lock_type" 
                                name="lock_type" 
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select lock type...</option>
                            <option value="ACTIVATION" {% if form and form.lock_type == 'ACTIVATION' %}selected{% endif %}>Activation Lock</option>
                            <option value="6_DIGIT" {% if form and form.lock_type == '6_DIGIT' %}selected{% endif %}>6 Digit Lock</option>
                            <option value="BIOS" {% if form and form.lock_type == 'BIOS' %}selected{% endif %}>BIOS Lock</option>
                            <option value="BITLOCKER" {% if form and form.lock_type == 'BITLOCKER' %}selected{% endif %}>Bitlocker</option>
                        </select>
                    </div>

                    <!-- Queue Selection -->
                    <div>
                        <label for="pin_queue_id" class="block text-sm font-medium text-gray-700">
                            Assign to Queue <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-1 flex gap-2">
                            <select id="pin_queue_id"
                                    name="queue_id"
                                    disabled
                                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">-- Select a Queue --</option>
                                {% for queue in queues %}
                                <option value="{{ queue.id }}">{{ queue.name }}</option>
                                {% endfor %}
                            </select>
                            {% if current_user.is_super_admin or current_user.is_developer %}
                            <button type="button" onclick="QueueManager.open()" class="manage-queues-btn" title="Manage Queues">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                        <p class="mt-1 text-sm text-gray-500">
                            Select which support queue this PIN request ticket should be assigned to.
                        </p>
                    </div>

                    <!-- Case Owner Selection -->
                    {% if users_for_assignment %}
                    <div>
                        <label for="pin_case_owner_id" class="block text-sm font-medium text-gray-700">Case Owner</label>
                        <select id="pin_case_owner_id" 
                                name="case_owner_id"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            {% for user_option in users_for_assignment %}
                            <option value="{{ user_option.id }}" 
                                    {% if user_option.id == user.id %}selected{% endif %}>
                                {{ user_option.username }}{% if user_option.company %} ({{ user_option.company }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">Default: Current user ({{ user.username }})</p>
                    </div>
                    {% endif %}

                    <!-- Notes -->
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ form.notes if form else '' }}</textarea>
                    </div>
                </div>

                <!-- Repair Fields -->
                <div id="repairFields" class="hidden space-y-6">
                    <!-- Country -->
                    <div>
                        <label for="repair_country" class="block text-sm font-medium text-gray-700">Country</label>
                        <input type="text" 
                               id="repair_country" 
                               name="country" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Serial Number Selection -->
                    <div>
                        <label for="repair_serial_number" class="block text-sm font-medium text-gray-700">Asset Selection</label>
                        <select id="repair_serial_number" 
                                name="serial_number"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select an asset...</option>
                            {% for asset in assets %}
                            <option value="{{ asset.serial_number }}" 
                                    data-model="{{ asset.model }}"
                                    data-customer="{{ asset.customer }}"
                                    data-asset-tag="{{ asset.asset_tag }}">
                                {{ asset.serial_number }} - {{ asset.model }} ({{ asset.asset_tag }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Auto-populated fields -->
                    <div>
                        <label for="repair_model" class="block text-sm font-medium text-gray-700">Model</label>
                        <input type="text" 
                               id="repair_model" 
                               name="model" 
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <div>
                        <label for="repair_customer" class="block text-sm font-medium text-gray-700">Customer Company</label>
                        <input type="text" 
                               id="repair_customer" 
                               name="customer_company" 
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <!-- Apple Diagnostics Code -->
                    <div>
                        <label for="apple_diagnostics" class="block text-sm font-medium text-gray-700">Apple Diagnostics Code (if applicable)</label>
                        <input type="text" 
                               id="apple_diagnostics" 
                               name="apple_diagnostics" 
                               placeholder="e.g., ADP000"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Damage Description -->
                    <div>
                        <label for="damage_description" class="block text-sm font-medium text-gray-700">Description of Damage</label>
                        <textarea id="damage_description" 
                                  name="damage_description" 
                                  rows="3"
                                  required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Image Upload -->
                    <div>
                        <label for="image" class="block text-sm font-medium text-gray-700">Upload Images</label>
                        <input type="file" 
                               id="image" 
                               name="image" 
                               accept="image/*"
                               multiple
                               class="mt-1 block w-full text-sm text-gray-500
                                      file:mr-4 file:py-2 file:px-4
                                      file:rounded-full file:border-0
                                      file:text-sm file:font-semibold
                                      file:bg-blue-50 file:text-blue-700
                                      hover:file:bg-blue-100">
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="repair_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="repair_notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Quote Options -->
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <button type="button" 
                                    onclick="requestQuote('repair')"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                Request Repair Quote
                            </button>
                            <button type="button" 
                                    onclick="requestQuote('disposal')"
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                                Request Disposal Quote
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Asset Checkout Fields -->
                <div id="assetCheckoutFields" class="hidden space-y-6">
                    <!-- Customer Selection -->
                    <div>
                        <label for="customer_id" class="block text-sm font-medium text-gray-700">Select Customer</label>
                        <div class="flex items-center space-x-2">
                            <select id="customer_id" 
                                    name="customer_id"
                                    required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select a customer...</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}" 
                                        data-address="{{ customer.address }}"
                                        data-company="{{ customer.company.name if customer.company else '' }}">
                                    {{ customer.name }} ({{ customer.company.name if customer.company else 'No Company' }})
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" 
                                    onclick="showCreateCustomerModal()"
                                    class="mt-1 flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Case Owner Selection -->
                    {% if users_for_assignment %}
                    <div>
                        <label for="case_owner_id" class="block text-sm font-medium text-gray-700">Case Owner</label>
                        <select id="case_owner_id" 
                                name="case_owner_id"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            {% for user_option in users_for_assignment %}
                            <option value="{{ user_option.id }}" 
                                    {% if user_option.id == user.id %}selected{% endif %}>
                                {{ user_option.username }}{% if user_option.company %} ({{ user_option.company }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">Default: Current user ({{ user.username }})</p>
                    </div>
                    {% endif %}

                    <!-- Hidden field for asset checkout serial number -->
                    <input type="hidden" id="asset_checkout_serial" name="asset_checkout_serial" value="">
                    <!-- Hidden subject field -->
                    <input type="hidden" id="subject" name="subject" value="">

                    <!-- Asset Selection - Only shown for checkout categories -->
                    <div id="assetSelectionContainer">
                        <label for="checkout_serial_number" class="block text-sm font-medium text-gray-700">Asset Selection</label>
                        <select id="checkout_serial_number" 
                                name="checkout_serial_number"
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select an asset...</option>
                            {% for asset in assets %}
                            <option value="{{ asset.serial_number }}" 
                                    data-model="{{ asset.model }}"
                                    data-asset-tag="{{ asset.asset_tag }}">
                                {{ asset.serial_number }} - {{ asset.model }} ({{ asset.asset_tag }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Shipping Address -->
                    <div>
                        <label for="shipping_address" class="block text-sm font-medium text-gray-700">Shipping Address</label>
                        <textarea id="shipping_address" 
                                  name="shipping_address" 
                                  rows="3"
                                  required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Package Tracking Section -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Package Tracking (Optional)</label>
                        <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Add tracking numbers for up to 5 packages. Each package can later have specific assets assigned to it.</p>
                            
                            <!-- Package 1 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="package_1_tracking" class="block text-xs font-medium text-gray-600">Package 1 Tracking Number</label>
                                    <input type="text" 
                                           id="package_1_tracking" 
                                           name="package_1_tracking" 
                                           placeholder="e.g., XZD0002556450"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="package_1_carrier" class="block text-xs font-medium text-gray-600">Package 1 Carrier</label>
                                    <select id="package_1_carrier" 
                                            name="package_1_carrier" 
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Select carrier...</option>
                                        <option value="auto">Auto</option>
                                        <option value="claw">Claw</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Package 2 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="package_2_tracking" class="block text-xs font-medium text-gray-600">Package 2 Tracking Number</label>
                                    <input type="text" 
                                           id="package_2_tracking" 
                                           name="package_2_tracking" 
                                           placeholder="e.g., XZD0002556451"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="package_2_carrier" class="block text-xs font-medium text-gray-600">Package 2 Carrier</label>
                                    <select id="package_2_carrier" 
                                            name="package_2_carrier" 
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Select carrier...</option>
                                        <option value="auto">Auto</option>
                                        <option value="claw">Claw</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Package 3 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="package_3_tracking" class="block text-xs font-medium text-gray-600">Package 3 Tracking Number</label>
                                    <input type="text" 
                                           id="package_3_tracking" 
                                           name="package_3_tracking" 
                                           placeholder="e.g., XZD0002556452"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="package_3_carrier" class="block text-xs font-medium text-gray-600">Package 3 Carrier</label>
                                    <select id="package_3_carrier" 
                                            name="package_3_carrier" 
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Select carrier...</option>
                                        <option value="auto">Auto</option>
                                        <option value="claw">Claw</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Package 4 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="package_4_tracking" class="block text-xs font-medium text-gray-600">Package 4 Tracking Number</label>
                                    <input type="text" 
                                           id="package_4_tracking" 
                                           name="package_4_tracking" 
                                           placeholder="e.g., XZD0002556453"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="package_4_carrier" class="block text-xs font-medium text-gray-600">Package 4 Carrier</label>
                                    <select id="package_4_carrier" 
                                            name="package_4_carrier" 
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Select carrier...</option>
                                        <option value="auto">Auto</option>
                                        <option value="claw">Claw</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Package 5 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="package_5_tracking" class="block text-xs font-medium text-gray-600">Package 5 Tracking Number</label>
                                    <input type="text" 
                                           id="package_5_tracking" 
                                           name="package_5_tracking" 
                                           placeholder="e.g., XZD0002556454"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="package_5_carrier" class="block text-xs font-medium text-gray-600">Package 5 Carrier</label>
                                    <select id="package_5_carrier" 
                                            name="package_5_carrier" 
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Select carrier...</option>
                                        <option value="auto">Auto</option>
                                        <option value="claw">Claw</option>
                                        <option value="singpost">SingPost</option>
                                        <option value="dhl">DHL</option>
                                        <option value="ups">UPS</option>
                                        <option value="bluedart">BlueDart</option>
                                        <option value="dtdc">DTDC</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="checkout_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="checkout_notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Queue Selection -->
                    <div>
                        <label for="checkout_queue_id" class="block text-sm font-medium text-gray-700">
                            Assign to Queue <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-1 flex gap-2">
                            <select id="checkout_queue_id"
                                    name="queue_id"
                                    disabled
                                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">-- Select a Queue --</option>
                                {% for queue in queues %}
                                <option value="{{ queue.id }}">{{ queue.name }}</option>
                                {% endfor %}
                            </select>
                            {% if current_user.is_super_admin or current_user.is_developer %}
                            <button type="button" onclick="QueueManager.open()" class="manage-queues-btn" title="Manage Queues">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                        <p class="mt-1 text-sm text-gray-500">
                            Select which support queue this asset checkout ticket should be assigned to.
                        </p>
                    </div>

                    <!-- Case Owner Selection for Asset Checkout -->
                    {% if users_for_assignment %}
                    <div>
                        <label for="checkout_case_owner_id" class="block text-sm font-medium text-gray-700">Case Owner</label>
                        <select id="checkout_case_owner_id" 
                                name="case_owner_id"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            {% for user_option in users_for_assignment %}
                            <option value="{{ user_option.id }}" 
                                    {% if user_option.id == user.id %}selected{% endif %}>
                                {{ user_option.username }}{% if user_option.company %} ({{ user_option.company }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">Select who will be responsible for this case. Default: {{ user.username }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- CSV Upload for Accessories -->
                    <div>
                        <label for="accessories_csv" class="block text-sm font-medium text-gray-700">
                            Import Accessories from CSV (Optional)
                        </label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md" id="csvDropZone">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <div class="flex text-sm text-gray-600">
                                    <label for="accessories_csv" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                        <span>Upload CSV file</span>
                                        <input id="accessories_csv" name="accessories_csv" type="file" accept=".csv" class="sr-only" onchange="handleCsvUpload(this)">
                                    </label>
                                    <p class="pl-1">or drag and drop</p>
                                </div>
                                <p class="text-xs text-gray-500">CSV files only</p>
                            </div>
                        </div>
                        <div id="csvFileName" class="mt-2 text-sm text-gray-600 hidden"></div>
                        <p class="mt-1 text-sm text-gray-500">
                            Upload a CSV file containing accessory information to automatically detect and assign accessories to this checkout.
                        </p>
                    </div>
                    
                    <!-- Accessory Selection (populated from CSV) -->
                    <div id="accessorySelectionContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            Select Accessories from CSV
                        </label>
                        <div id="accessoryPreview" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-md p-3">
                            <!-- Accessory items will be populated here -->
                        </div>
                        <div id="selectedAccessoriesSummary" class="mt-4 hidden">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Selected Accessories:</h4>
                            <div id="selectedAccessoriesList" class="space-y-1"></div>
                        </div>
                    </div>
                    
                    <!-- Hidden field to store selected accessories -->
                    <input type="hidden" id="selected_accessories" name="selected_accessories" value="">
                    
                    <!-- Debug: Test button to simulate accessory selection -->
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <h4 class="text-sm font-medium text-yellow-800 mb-2">Debug: Test Accessory Assignment</h4>
                        <div class="space-x-2">
                            <button type="button" onclick="testAccessoryAssignment()" 
                                    class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600">
                                Test: Add Sample Accessories
                            </button>
                            <button type="button" onclick="debugFormSubmission()" 
                                    class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                Debug: Test Form Data
                            </button>
                        </div>
                        <p class="text-xs text-yellow-700 mt-1">Use these buttons to test the CSV accessory functionality</p>
                    </div>
                    
                    <!-- DEBUG: Queue field added for Asset Checkout - v2.0 -->
                </div>

                <!-- Asset Intake Fields -->
                <div id="assetIntakeFields" class="hidden space-y-6">
                    <!-- Title -->
                    <div>
                        <label for="intake_title" class="block text-sm font-medium text-gray-700">Title</label>
                        <div class="flex gap-2">
                            <input type="text" 
                                   id="intake_title" 
                                   name="intake_title" 
                                   placeholder="e.g., New Laptop Batch - March 2024"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <button type="button" 
                                    onclick="generateTitle()"
                                    class="mt-1 px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                Auto
                            </button>
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="intake_description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="intake_description" 
                                  name="intake_description" 
                                  rows="4"
                                  placeholder="Describe the assets being received..."
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <!-- Notes -->
                    <div>
                        <label for="intake_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="intake_notes" 
                                  name="intake_notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                  placeholder="Any additional information about this intake..."></textarea>
                    </div>

                    <!-- Priority -->
                    <div>
                        <label for="intake_priority" class="block text-sm font-medium text-gray-700">Priority</label>
                        <select id="intake_priority"
                                name="intake_priority"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select priority...</option>
                            {% for priority in priorities %}
                            <option value="{{ priority.name }}" {% if form and form.priority == priority.name %}selected{% endif %}>{{ priority.value }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Case Owner Selection -->
                    {% if users_for_assignment %}
                    <div>
                        <label for="intake_case_owner_id" class="block text-sm font-medium text-gray-700">Case Owner</label>
                        <select id="intake_case_owner_id"
                                name="case_owner_id"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            {% for user_option in users_for_assignment %}
                            <option value="{{ user_option.id }}"
                                    {% if user_option.id == user.id %}selected{% endif %}>
                                {{ user_option.username }}{% if user_option.company %} ({{ user_option.company }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">Default: Current user ({{ user.username }})</p>
                    </div>
                    {% endif %}

                    <!-- Queue Selection -->
                    <div>
                        <label for="intake_queue_id" class="block text-sm font-medium text-gray-700">
                            Assign to Queue <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-1 flex gap-2">
                            <select id="intake_queue_id"
                                    name="queue_id"
                                    disabled
                                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">-- Select a Queue --</option>
                                {% for queue in queues %}
                                <option value="{{ queue.id }}">{{ queue.name }}</option>
                                {% endfor %}
                            </select>
                            {% if current_user.is_super_admin or current_user.is_developer %}
                            <button type="button" onclick="QueueManager.open()" class="manage-queues-btn" title="Manage Queues">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                        <p class="mt-1 text-sm text-gray-500">
                            Select which support queue this asset intake ticket should be assigned to.
                        </p>
                    </div>
                </div>

                <!-- Asset Return Fields -->
                <div id="assetReturnFields" class="hidden space-y-6">
                    <!-- ALL hidden fields needed for backend compatibility -->
                    <input type="hidden" id="asset_return_serial" name="asset_checkout_serial" value="ASSET_RETURN_NO_ASSET">
                    <input type="hidden" id="return_subject" name="subject" value="">
                    <input type="hidden" id="asset_return_form_flag" name="is_asset_return" value="1">
                    <input type="hidden" id="novalidate_flag" name="novalidate" value="1">
                    
                    <!-- Customer Selection -->
                    <div>
                        <label for="return_customer_id" class="block text-sm font-medium text-gray-700">Select Customer</label>
                        <div class="flex items-center space-x-2">
                            <select id="return_customer_id" 
                                    name="customer_id"
                                    required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select a customer...</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}" 
                                        data-address="{{ customer.address }}"
                                        data-company="{{ customer.company.name if customer.company else '' }}">
                                    {{ customer.name }} ({{ customer.company.name if customer.company else 'No Company' }})
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" 
                                    onclick="showCreateCustomerModal()"
                                    class="mt-1 flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Return Description -->
                    <div>
                        <label for="return_description" class="block text-sm font-medium text-gray-700">Return Description</label>
                        <textarea id="return_description"
                                  name="return_description"
                                  rows="3"
                                  required
                                  placeholder="Please describe what assets are being returned and why"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Reported Issue -->
                    <div>
                        <label for="return_damage_description" class="block text-sm font-medium text-gray-700">Reported Issue (Optional)</label>
                        <textarea id="return_damage_description"
                                  name="damage_description"
                                  rows="3"
                                  placeholder="Describe any issues or problems with the device (e.g., screen damage, battery issues, not turning on)"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                        <p class="mt-1 text-sm text-gray-500">Document any known issues with the returning device</p>
                    </div>

                    <!-- Shipping Address -->
                    <div>
                        <label for="return_shipping_address" class="block text-sm font-medium text-gray-700">Return Address</label>
                        <textarea id="return_shipping_address" 
                                  name="shipping_address" 
                                  rows="3"
                                  required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Outbound Tracking Number - Hidden -->
                    <input type="hidden" id="outbound_tracking" name="shipping_tracking" value="">

                    <!-- Inbound Tracking Number - Hidden -->
                    <input type="hidden" id="inbound_tracking" name="return_tracking" value="">
                    
                    <!-- Case Owner Selection -->
                    {% if users_for_assignment %}
                    <div>
                        <label for="return_case_owner_id" class="block text-sm font-medium text-gray-700">Case Owner</label>
                        <select id="return_case_owner_id" 
                                name="case_owner_id"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            {% for user_option in users_for_assignment %}
                            <option value="{{ user_option.id }}" 
                                    {% if user_option.id == user.id %}selected{% endif %}>
                                {{ user_option.username }}{% if user_option.company %} ({{ user_option.company }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">Default: Current user ({{ user.username }})</p>
                    </div>
                    {% endif %}

                    <!-- Queue Selection -->
                    <div>
                        <label for="queue_id" class="block text-sm font-medium text-gray-700">
                            Assign to Queue <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-1 flex gap-2">
                            <select id="queue_id"
                                    name="queue_id"
                                    disabled
                                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">-- Select a Queue --</option>
                                {% for queue in queues %}
                                <option value="{{ queue.id }}">{{ queue.name }}</option>
                                {% endfor %}
                            </select>
                            {% if current_user.is_super_admin or current_user.is_developer %}
                            <button type="button" onclick="QueueManager.open()" class="manage-queues-btn" title="Manage Queues">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                        <p class="mt-1 text-sm text-gray-500">
                            Select which support queue this return ticket should be assigned to.
                        </p>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="return_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="return_notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Special Submit Button for Asset Return -->
                    <div class="pt-4">
                        <button type="button" 
                                id="asset_return_submit"
                                onclick="submitAssetReturnForm()"
                                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Create Asset Return Ticket
                        </button>
                    </div>
                </div>

                <!-- Internal Transfer Fields -->
                <div id="internalTransferFields" class="hidden space-y-6">
                    <!-- Queue Selection -->
                    <div>
                        <label for="internal_transfer_queue_id" class="block text-sm font-medium text-gray-700">
                            Assign to Queue <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-1 flex gap-2">
                            <select id="internal_transfer_queue_id"
                                    name="queue_id"
                                    disabled
                                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">-- Select a Queue --</option>
                                {% for queue in queues %}
                                <option value="{{ queue.id }}">{{ queue.name }}</option>
                                {% endfor %}
                            </select>
                            {% if current_user.is_super_admin or current_user.is_developer %}
                            <button type="button" onclick="QueueManager.open()" class="manage-queues-btn" title="Manage Queues">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                        <p class="mt-1 text-sm text-gray-500">
                            Select which support queue this internal transfer ticket should be assigned to.
                        </p>
                    </div>

                    <!-- Offboarding Section -->
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-red-800 mb-4"> Offboarding Customer</h3>

                        <!-- Offboarding Customer Selection -->
                        <div class="mb-4">
                            <label for="offboarding_customer_id" class="block text-sm font-medium text-gray-700">Offboarding Customer <span class="text-red-500">*</span></label>
                            <div class="flex items-center space-x-2">
                                <select id="offboarding_customer_id"
                                        name="offboarding_customer_id"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">Search or select customer...</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}"
                                            data-company="{{ customer.company.name if customer.company else '' }}"
                                            data-address="{{ customer.address or '' }}">
                                        {{ customer.name }} ({{ customer.company.name if customer.company else 'No Company' }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button"
                                        onclick="showCreateCustomerModal('offboarding')"
                                        class="mt-1 flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Offboarding Details -->
                        <div class="mb-4">
                            <label for="offboarding_details" class="block text-sm font-medium text-gray-700">Offboarding Device Details <span class="text-red-500">*</span></label>
                            <textarea id="offboarding_details"
                                      name="offboarding_details"
                                      rows="3"
                                      placeholder="Enter device details being transferred (e.g., MacBook Pro 2023, Serial: ABC123, Asset Tag: 1234)"
                                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                        </div>

                        <!-- Offboarding Address (Auto-filled from customer) -->
                        <div>
                            <label for="offboarding_address" class="block text-sm font-medium text-gray-700">Offboarding Address <span class="text-red-500">*</span></label>
                            <textarea id="offboarding_address"
                                      name="offboarding_address"
                                      rows="3"
                                      placeholder="Address will auto-fill from selected customer or enter manually"
                                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                        </div>
                    </div>

                    <!-- Tracking Link -->
                    <div>
                        <label for="transfer_tracking" class="block text-sm font-medium text-gray-700">Tracking Link <span class="text-gray-400">(Optional)</span></label>
                        <input type="text"
                               id="transfer_tracking"
                               name="transfer_tracking"
                               placeholder="Enter tracking number or link"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Onboarding Section -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-800 mb-4"> Onboarding Customer</h3>

                        <!-- Onboarding Customer Selection -->
                        <div class="mb-4">
                            <label for="onboarding_customer_id" class="block text-sm font-medium text-gray-700">Onboarding Customer <span class="text-red-500">*</span></label>
                            <div class="flex items-center space-x-2">
                                <select id="onboarding_customer_id"
                                        name="onboarding_customer_id"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">Search or select customer...</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}"
                                            data-company="{{ customer.company.name if customer.company else '' }}"
                                            data-address="{{ customer.address or '' }}">
                                        {{ customer.name }} ({{ customer.company.name if customer.company else 'No Company' }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button"
                                        onclick="showCreateCustomerModal('onboarding')"
                                        class="mt-1 flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Onboarding Address (Auto-filled from customer) -->
                        <div>
                            <label for="onboarding_address" class="block text-sm font-medium text-gray-700">Onboarding Address <span class="text-red-500">*</span></label>
                            <textarea id="onboarding_address"
                                      name="onboarding_address"
                                      rows="3"
                                      placeholder="Address will auto-fill from selected customer or enter manually"
                                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                        </div>
                    </div>

                    <!-- Client Company (Auto-filled from customers) -->
                    <div>
                        <label for="transfer_client" class="block text-sm font-medium text-gray-700">Client Company</label>
                        <input type="text"
                               id="transfer_client"
                               name="transfer_client"
                               readonly
                               placeholder="Will auto-fill from customer's company"
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Hidden fields for backward compatibility -->
                    <input type="hidden" id="transfer_name" name="transfer_name" value="">
                    <input type="hidden" id="transfer_address" name="transfer_address" value="">

                    <!-- Notes -->
                    <div>
                        <label for="transfer_notes" class="block text-sm font-medium text-gray-700">Additional Notes <span class="text-gray-400">(Optional)</span></label>
                        <textarea id="transfer_notes"
                                  name="notes"
                                  rows="3"
                                  placeholder="Additional notes about the transfer"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Case Owner Selection -->
                    {% if users_for_assignment %}
                    <div>
                        <label for="transfer_case_owner_id" class="block text-sm font-medium text-gray-700">Case Owner</label>
                        <select id="transfer_case_owner_id"
                                name="case_owner_id"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            {% for user_option in users_for_assignment %}
                            <option value="{{ user_option.id }}"
                                    {% if user_option.id == user.id %}selected{% endif %}>
                                {{ user_option.username }}{% if user_option.company %} ({{ user_option.company }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">Default: Current user ({{ user.username }})</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Subject Field (for custom categories) -->
                <div id="generalSubjectField" class="hidden">
                    <label for="general_subject" class="block text-sm font-medium text-gray-700">Subject/Title</label>
                    <input type="text" 
                           id="general_subject" 
                           name="general_subject" 
                           placeholder="Enter ticket subject..."
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- Shipping Tracking Fields (for categories that support tracking) -->
                <div id="shippingTrackingFields" class="hidden space-y-4">
                    <div>
                        <label for="visible_outbound_tracking" class="block text-sm font-medium text-gray-700">Outbound Tracking Number</label>
                        <input type="text" 
                               id="visible_outbound_tracking" 
                               name="visible_outbound_tracking" 
                               placeholder="e.g., XZD0002556450"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-gray-500">Enter the tracking number for outbound shipments</p>
                    </div>
                    
                    <div>
                        <label for="visible_inbound_tracking" class="block text-sm font-medium text-gray-700">Inbound Tracking Number</label>
                        <input type="text" 
                               id="visible_inbound_tracking" 
                               name="visible_inbound_tracking" 
                               placeholder="e.g., ABC1234567890"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-gray-500">Enter the tracking number for inbound shipments (optional)</p>
                    </div>
                </div>

                <!-- Priority -->
                <div id="generalPriorityField">
                    <label for="priority" class="block text-sm font-medium text-gray-700">Priority</label>
                    <select id="priority" 
                            name="priority" 
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select priority...</option>
                        {% for priority in priorities %}
                        <option value="{{ priority.name }}" {% if form and form.priority == priority.name %}selected{% endif %}>{{ priority.value }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Description -->
                <div id="generalDescriptionField">
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="description" 
                              name="description" 
                              rows="5"
                              required
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ form.description if form else '' }}</textarea>
                </div>

                <!-- Submit Button - SF Style -->
                <div class="pt-6 border-t border-gray-100 mt-6">
                    <div class="flex items-center justify-end space-x-4">
                        <a href="{{ url_for('tickets.list_tickets_sf') }}"
                           class="px-6 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-200 transition-colors">
                            Cancel
                        </a>
                        <button type="submit"
                                id="mainSubmitButton"
                                class="px-8 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg shadow-sm hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Create Ticket
                        </button>
                    </div>
                </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Customer Modal -->
<div id="createCustomerModal" class="fixed inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Create New Customer
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                Please fill in the customer information. All fields marked with * are required.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="new_customer_name" class="block text-sm font-medium text-gray-700">Customer Name *</label>
                        <input type="text" id="new_customer_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="new_customer_contact" class="block text-sm font-medium text-gray-700">Contact Number *</label>
                        <input type="text" id="new_customer_contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="new_customer_email" class="block text-sm font-medium text-gray-700">Email (Optional)</label>
                        <input type="email" id="new_customer_email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="new_customer_address" class="block text-sm font-medium text-gray-700">Address *</label>
                        <textarea id="new_customer_address" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="new_customer_company" class="block text-sm font-medium text-gray-700">Company *</label>
                        <div class="flex items-center space-x-2">
                            <select id="new_customer_company" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select a company...</option>
                                {% for company in companies %}
                                <option value="{{ company }}">{{ company }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" id="new_company_name" placeholder="Or enter new company" class="mt-1 hidden w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <button type="button" id="toggleCompanyInput" class="mt-1 flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="new_customer_country" class="block text-sm font-medium text-gray-700">Country *</label>
                        <div class="flex items-center space-x-2">
                            <select id="new_customer_country" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select a country...</option>
                                {% for country in Country %}
                                <option value="{{ country.name }}">{{ country.value }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" id="new_country_name" placeholder="Enter new country" class="hidden mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <button type="button" id="toggleCountryInput" class="mt-1 flex-shrink-0 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded" title="Add new country">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="createCustomer()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Create
                </button>
                <button type="button" onclick="hideCreateCustomerModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Queue Manager Modal (iOS-style) -->
{% if current_user.is_super_admin or current_user.is_developer %}
{% include 'tickets/partials/queue_manager.html' %}
{% endif %}

<!-- Add jQuery and Select2 JS before the closing body tag -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{{ url_for('static', filename='js/queue_manager.js') }}"></script>

<script>
// Categories data with sections information
const categoriesData = {{ categories | tojson | safe }};

// Update the category badge when a category is selected
function updateCategoryBadge() {
    const categorySelect = document.getElementById('category');
    const badge = document.getElementById('selectedCategoryBadge');
    const selectedOption = categorySelect.options[categorySelect.selectedIndex];

    if (categorySelect.value) {
        badge.textContent = selectedOption.text;
        badge.classList.remove('hidden');

        // Update guide card highlights
        document.querySelectorAll('.category-guide-item').forEach(item => {
            item.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200');
            if (item.dataset.category === selectedOption.text) {
                item.classList.add('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200');
            }
        });
    } else {
        badge.classList.add('hidden');
        document.querySelectorAll('.category-guide-item').forEach(item => {
            item.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200');
        });
    }
}

// Category guide card click handlers
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Queue Manager (for Super Admin/Developer only)
    if (typeof QueueManager !== 'undefined') {
        QueueManager.init('{{ csrf_token() }}');
    }

    // Make category guide cards clickable
    document.querySelectorAll('.category-guide-item').forEach(item => {
        item.addEventListener('click', function() {
            const categoryName = this.dataset.category;
            const categorySelect = document.getElementById('category');

            console.log('Card clicked, looking for category:', categoryName);
            console.log('Available dropdown options:');
            for (let i = 0; i < categorySelect.options.length; i++) {
                console.log(`  [${i}] "${categorySelect.options[i].text}" (value: ${categorySelect.options[i].value})`);
            }

            // Find and select the matching option (try exact match first, then case-insensitive)
            let found = false;
            const categoryNameLower = categoryName.toLowerCase().trim();

            // First try exact match
            for (let i = 0; i < categorySelect.options.length; i++) {
                if (categorySelect.options[i].text === categoryName) {
                    console.log('Exact match found at index', i);
                    categorySelect.selectedIndex = i;
                    categorySelect.dispatchEvent(new Event('change'));
                    found = true;
                    break;
                }
            }

            // If no exact match, try case-insensitive match
            if (!found) {
                for (let i = 0; i < categorySelect.options.length; i++) {
                    if (categorySelect.options[i].text.toLowerCase().trim() === categoryNameLower) {
                        console.log('Case-insensitive match found at index', i);
                        categorySelect.selectedIndex = i;
                        categorySelect.dispatchEvent(new Event('change'));
                        found = true;
                        break;
                    }
                }
            }

            // If still no match, try partial match (contains)
            if (!found) {
                for (let i = 0; i < categorySelect.options.length; i++) {
                    const optionText = categorySelect.options[i].text.toLowerCase().trim();
                    if (optionText.includes(categoryNameLower) || categoryNameLower.includes(optionText)) {
                        console.log('Partial match found at index', i, ':', categorySelect.options[i].text);
                        categorySelect.selectedIndex = i;
                        categorySelect.dispatchEvent(new Event('change'));
                        found = true;
                        break;
                    }
                }
            }

            if (!found) {
                console.warn('No match found for category:', categoryName);
            }

            // Scroll to the form on mobile
            if (window.innerWidth < 1024) {
                document.getElementById('ticketForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });

    // Initialize badge if a category is already selected
    updateCategoryBadge();
});

// Customer creation modal functions
function showCreateCustomerModal() {
    document.getElementById('createCustomerModal').classList.remove('hidden');
}

// Toggle between company dropdown and text input
document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('toggleCompanyInput');
    const companySelect = document.getElementById('new_customer_company');
    const companyInput = document.getElementById('new_company_name');

    toggleButton.addEventListener('click', function() {
        if (companySelect.classList.contains('hidden')) {
            // Switch to dropdown
            companySelect.classList.remove('hidden');
            companyInput.classList.add('hidden');
            toggleButton.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>';
        } else {
            // Switch to text input
            companySelect.classList.add('hidden');
            companyInput.classList.remove('hidden');
            toggleButton.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>';
        }
    });

    // Toggle between country dropdown and text input
    const toggleCountryButton = document.getElementById('toggleCountryInput');
    const countrySelect = document.getElementById('new_customer_country');
    const countryInput = document.getElementById('new_country_name');

    toggleCountryButton.addEventListener('click', function() {
        if (countrySelect.classList.contains('hidden')) {
            // Switch to dropdown
            countrySelect.classList.remove('hidden');
            countryInput.classList.add('hidden');
            toggleCountryButton.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>';
            toggleCountryButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            toggleCountryButton.classList.add('bg-green-600', 'hover:bg-green-700');
            toggleCountryButton.title = 'Add new country';
        } else {
            // Switch to text input
            countrySelect.classList.add('hidden');
            countryInput.classList.remove('hidden');
            toggleCountryButton.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>';
            toggleCountryButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            toggleCountryButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            toggleCountryButton.title = 'Back to country list';
        }
    });
});

function hideCreateCustomerModal() {
    document.getElementById('createCustomerModal').classList.add('hidden');
}

function createCustomer() {
    // Get form values
    const name = document.getElementById('new_customer_name').value;
    const contact_number = document.getElementById('new_customer_contact').value;
    const email = document.getElementById('new_customer_email').value;
    const address = document.getElementById('new_customer_address').value;
    
    // Get company from either the dropdown or text input
    let company;
    const companySelect = document.getElementById('new_customer_company');
    const companyInput = document.getElementById('new_company_name');

    if (companySelect.classList.contains('hidden')) {
        // Use text input
        company = companyInput.value;
    } else {
        // Use dropdown
        company = companySelect.value;
    }

    // Get country from either the dropdown or text input
    let country;
    const countrySelect = document.getElementById('new_customer_country');
    const countryInput = document.getElementById('new_country_name');

    if (countrySelect.classList.contains('hidden')) {
        // Use text input
        country = countryInput.value;
    } else {
        // Use dropdown
        country = countrySelect.value;
    }
    
    // Store current category selection
    const currentCategory = document.getElementById('category').value;
    const isAssetReturnClaw = currentCategory === 'ASSET_RETURN_CLAW';
    
    // Validate required fields
    if (!name || !contact_number || !address || !company || !country) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    // Create form data
    const formData = new FormData();
    formData.append('name', name);
    formData.append('contact_number', contact_number);
    formData.append('email', email); // Email is optional for ASSET_RETURN_CLAW
    formData.append('address', address);
    formData.append('company', company);
    formData.append('country', country);
    formData.append('csrf_token', csrfToken);
    
    // Show loading state
    const createButton = document.querySelector('#createCustomerModal button[onclick="createCustomer()"]');
    const originalButtonText = createButton.innerHTML;
    createButton.disabled = true;
    createButton.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Creating...';
    
    // Send AJAX request
    fetch('/inventory/customer-users/add', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            // Get error details if available
            return response.text().then(text => {
                throw new Error(`Error ${response.status}: ${text || response.statusText}`);
            });
        }
        return response.text();
    })
    .then(data => {
        // Successfully created customer
        alert('Customer created successfully!');
        
        // Save category to session storage before reload
        if (currentCategory) {
            sessionStorage.setItem('selectedCategory', currentCategory);
        }
        
        window.location.reload();
    })
    .catch(error => {
        console.error('Error creating customer:', error);
        alert('Error creating customer: ' + error.message);
    })
    .finally(() => {
        // Reset button state
        createButton.disabled = false;
        createButton.innerHTML = originalButtonText;
    });
}

function onCategoryChange() {
    const category = document.getElementById('category').value;
    const pinFields = document.getElementById('pinRequestFields');
    const repairFields = document.getElementById('repairFields');
    const assetCheckoutFields = document.getElementById('assetCheckoutFields');
    const assetIntakeFields = document.getElementById('assetIntakeFields');
    const assetReturnFields = document.getElementById('assetReturnFields');
    const internalTransferFields = document.getElementById('internalTransferFields');
    const assetSelectionContainer = document.getElementById('assetSelectionContainer');
    const mainSubmitButton = document.getElementById('mainSubmitButton');
    
    // Get references to general fields that might be duplicated
    const generalPriorityField = document.getElementById('generalPriorityField');
    const generalDescriptionField = document.getElementById('generalDescriptionField');
    
    // Check if this is a custom category (not one of the hardcoded enum values)
    const knownCategories = ['PIN_REQUEST', 'ASSET_REPAIR', 'ASSET_CHECKOUT_CLAW', 'ASSET_INTAKE', 'ASSET_RETURN_CLAW', 'INTERNAL_TRANSFER'];
    const isCustomCategory = category && !knownCategories.includes(category);

    // Hide all fields first
    pinFields.classList.add('hidden');
    repairFields.classList.add('hidden');
    assetCheckoutFields.classList.add('hidden');
    assetIntakeFields.classList.add('hidden');
    assetReturnFields.classList.add('hidden');
    internalTransferFields.classList.add('hidden');
    
    // Show general fields by default
    if (generalPriorityField) generalPriorityField.classList.remove('hidden');
    if (generalDescriptionField) generalDescriptionField.classList.remove('hidden');
    
    // Hide the general subject field by default (only show for custom categories)
    const generalSubjectFieldDiv = document.getElementById('generalSubjectField');
    if (generalSubjectFieldDiv) generalSubjectFieldDiv.classList.add('hidden');
    
    // Hide shipping tracking fields by default (only show for appropriate categories)
    const shippingTrackingFieldsDiv = document.getElementById('shippingTrackingFields');
    if (shippingTrackingFieldsDiv) shippingTrackingFieldsDiv.classList.add('hidden');
    
    // Disable all notes fields first to prevent conflicts
    document.getElementById('notes').disabled = true;           // PIN Request notes
    document.getElementById('repair_notes').disabled = true;    // Repair notes
    document.getElementById('checkout_notes').disabled = true;  // Asset Checkout notes
    document.getElementById('intake_notes').disabled = true;    // Asset Intake notes
    document.getElementById('return_notes').disabled = true;    // Asset Return notes
    document.getElementById('transfer_notes').disabled = true;  // Internal Transfer notes

    // Reset required fields
    document.getElementById('serial_number').required = false;
    document.getElementById('lock_type').required = false;
    document.getElementById('repair_serial_number').required = false;
    document.getElementById('damage_description').required = false;
    document.getElementById('customer_id').required = false;
    document.getElementById('checkout_serial_number').required = false;
    document.getElementById('shipping_address').required = false;
    document.getElementById('return_customer_id').required = false;
    document.getElementById('return_description').required = false;
    document.getElementById('return_shipping_address').required = false;
    document.getElementById('outbound_tracking').required = false;
    document.getElementById('transfer_name').required = false;
    document.getElementById('transfer_address').required = false;
    const intakeTitle = document.getElementById('intake_title');
    const intakeDescription = document.getElementById('intake_description');
    const intakePriority = document.getElementById('intake_priority');
    if (intakeTitle) intakeTitle.required = false;
    if (intakeDescription) intakeDescription.required = false;
    if (intakePriority) intakePriority.required = false;
    
    // Reset general field required attributes to default
    const generalPrioritySelect = document.getElementById('priority');
    const generalDescriptionTextarea = document.getElementById('description');
    if (generalPrioritySelect) generalPrioritySelect.required = true; // Default required
    if (generalDescriptionTextarea) generalDescriptionTextarea.required = true; // Default required

    // Show/hide submit buttons based on category
    if (category === 'ASSET_RETURN_CLAW') {
        // Hide main submit button
        if (mainSubmitButton) {
            mainSubmitButton.classList.add('hidden');
        }
    } else {
        // Show main submit button for other categories
        if (mainSubmitButton) {
            mainSubmitButton.classList.remove('hidden');
        }
    }

    // Handle ASSET_RETURN_CLAW as a separate category first
    if (category === 'ASSET_RETURN_CLAW') {
        // Show ONLY the asset return fields
        assetReturnFields.classList.remove('hidden');
        document.getElementById('return_notes').disabled = false; // Enable Asset Return notes
        document.getElementById('queue_id').disabled = false; // Enable Asset Return queue
        console.log('Enabled Asset Return notes field');
        
        // Make required fields for asset return
        document.getElementById('return_customer_id').required = true;
        document.getElementById('return_description').required = true;
        document.getElementById('return_shipping_address').required = true;
        document.getElementById('outbound_tracking').required = false;
        
        // Set a dummy value in asset_checkout_serial for form validation
        document.getElementById('asset_checkout_serial').value = 'ASSET_RETURN_NO_ASSET';
        console.log('Set dummy value in asset_checkout_serial for Asset Return');
        
        return; // Exit early to avoid running the other logic
    }

    if (category === 'PIN_REQUEST') {
        pinFields.classList.remove('hidden');
        document.getElementById('notes').disabled = false;      // Enable PIN Request notes
        document.getElementById('pin_queue_id').disabled = false; // Enable PIN Request queue
        console.log('Enabled PIN Request notes field');
        document.getElementById('serial_number').required = true;
        document.getElementById('lock_type').required = true;
    } else if (category === 'ASSET_REPAIR') {
        repairFields.classList.remove('hidden');
        document.getElementById('repair_notes').disabled = false; // Enable Repair notes
        console.log('Enabled Repair notes field');
        document.getElementById('repair_serial_number').required = true;
        document.getElementById('damage_description').required = true;
    } else if (category === 'ASSET_CHECKOUT_CLAW') {
        assetCheckoutFields.classList.remove('hidden');
        document.getElementById('customer_id').required = true;
        document.getElementById('checkout_serial_number').required = true;
        document.getElementById('shipping_address').required = true;
        document.getElementById('checkout_notes').disabled = false; // Enable Asset Checkout notes
        document.getElementById('checkout_queue_id').disabled = false; // Enable Asset Checkout queue
        console.log('Enabled Asset Checkout notes field');
        
        // Show asset selection for checkout categories
        if (assetSelectionContainer) {
            assetSelectionContainer.classList.remove('hidden');
        }
        
        // Remove any tracking pattern for Asset Checkout (claw)
        $('#shipping_tracking').removeAttr('pattern');
        
        // Make sure hidden field is populated
        const serial = $('#checkout_serial_number').val();
        if (serial) {
            $('#asset_checkout_serial').val(serial);
            console.log('Asset Checkout (claw) initialization: Set asset_checkout_serial to:', serial);
        }
    } else if (category === 'ASSET_INTAKE') {
        assetIntakeFields.classList.remove('hidden');
        
        // Hide general Priority and Description fields for Asset Intake to prevent duplication
        if (generalPriorityField) {
            generalPriorityField.classList.add('hidden');
            // Remove required attribute from hidden general priority field
            const generalPrioritySelect = document.getElementById('priority');
            if (generalPrioritySelect) generalPrioritySelect.required = false;
        }
        if (generalDescriptionField) {
            generalDescriptionField.classList.add('hidden');
            // Remove required attribute from hidden general description field
            const generalDescriptionTextarea = document.getElementById('description');
            if (generalDescriptionTextarea) generalDescriptionTextarea.required = false;
        }
        
        // Set required attributes for Asset Intake fields
        if (intakeTitle) intakeTitle.required = true;
        if (intakeDescription) intakeDescription.required = true;
        const intakePriority = document.getElementById('intake_priority');
        if (intakePriority) intakePriority.required = true;
        
        document.getElementById('intake_notes').disabled = false; // Enable Asset Intake notes
        document.getElementById('intake_queue_id').disabled = false; // Enable Asset Intake queue
        console.log('Enabled Asset Intake notes field');
        console.log('Hidden general Priority and Description fields for Asset Intake');
        console.log('Set required attributes for Asset Intake fields');
    } else if (category === 'INTERNAL_TRANSFER') {
        internalTransferFields.classList.remove('hidden');
        document.getElementById('transfer_notes').disabled = false; // Enable Internal Transfer notes
        document.getElementById('internal_transfer_queue_id').disabled = false; // Enable Internal Transfer queue
        console.log('Enabled Internal Transfer notes field');

        // Set required fields for Internal Transfer
        document.getElementById('transfer_name').required = true;
        document.getElementById('transfer_address').required = true;

        // Hide general Priority and Description fields for Internal Transfer
        if (generalPriorityField) {
            generalPriorityField.classList.add('hidden');
            const generalPrioritySelect = document.getElementById('priority');
            if (generalPrioritySelect) generalPrioritySelect.required = false;
        }
        if (generalDescriptionField) {
            generalDescriptionField.classList.add('hidden');
            const generalDescriptionTextarea = document.getElementById('description');
            if (generalDescriptionTextarea) generalDescriptionTextarea.required = false;
        }

        console.log('Set required attributes for Internal Transfer fields');
    } else if (isCustomCategory) {
        // For custom categories, show general fields only (no asset requirement)
        if (generalPriorityField) generalPriorityField.classList.remove('hidden');
        if (generalDescriptionField) generalDescriptionField.classList.remove('hidden');
        
        // Show the visible subject field for custom categories
        const generalSubjectField = document.getElementById('generalSubjectField');
        if (generalSubjectField) generalSubjectField.classList.remove('hidden');
        
        // Check if this custom category has shipping tracking sections enabled
        const categoryData = categoriesData.find(cat => cat.value === category);
        const hasShippingTracking = categoryData && categoryData.sections && 
                                   (categoryData.sections.includes('shipping_tracking') || 
                                    categoryData.sections.includes('return_tracking'));
        
        // Only show shipping tracking fields if the category has those sections enabled
        const shippingTrackingFields = document.getElementById('shippingTrackingFields');
        if (shippingTrackingFields) {
            if (hasShippingTracking) {
                shippingTrackingFields.classList.remove('hidden');
                console.log('Showing shipping tracking fields for custom category with shipping sections');
            } else {
                shippingTrackingFields.classList.add('hidden');
                console.log('Hiding shipping tracking fields for custom category without shipping sections');
            }
        }
        
        // Custom categories don't require asset selection
        const generalPrioritySelect = document.getElementById('priority');
        const generalDescriptionTextarea = document.getElementById('description');
        const generalSubjectInput = document.getElementById('general_subject');
        
        if (generalPrioritySelect) generalPrioritySelect.required = true;
        if (generalDescriptionTextarea) generalDescriptionTextarea.required = true;
        if (generalSubjectInput) generalSubjectInput.required = true;
        
        console.log('Custom category selected - general fields shown, shipping tracking conditionally shown');
    }
}

function requestQuote(type) {
    const form = document.querySelector('form');
    const quoteTypeInput = document.createElement('input');
    quoteTypeInput.type = 'hidden';
    quoteTypeInput.name = 'quote_type';
    quoteTypeInput.value = type;
    form.appendChild(quoteTypeInput);
    form.submit();
}

function generateTitle() {
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    const title = `Asset Intake - ${dateStr}`;
    document.getElementById('intake_title').value = title;
}

function updateSubject() {
    const ticketType = document.getElementById('ticket_type').value;
    const subjectField = document.getElementById('subject');
    const intakeTitleField = document.getElementById('intake_title');
    
    if (ticketType === 'asset_intake') {
        // For Asset Intake, use the title field as subject
        if (intakeTitleField) {
            subjectField.value = intakeTitleField.value;
        }
    } else {
        // For other ticket types, generate subject based on selected asset
        const assetSelect = document.getElementById('asset_id');
        if (assetSelect && assetSelect.value) {
            const selectedOption = assetSelect.options[assetSelect.selectedIndex];
            const model = selectedOption.getAttribute('data-model');
            const serialNumber = selectedOption.getAttribute('data-serial');
            
            let prefix = '';
            switch(ticketType) {
                case 'pin_request':
                    prefix = 'PIN Request';
                    break;
                case 'repair_request':
                    prefix = 'Repair Request';
                    break;
                case 'asset_checkout':
                    prefix = 'Asset Checkout';
                    break;
            }
            
            subjectField.value = `${prefix} - ${model} - ${serialNumber}`;
        } else {
            subjectField.value = '';
        }
    }
}

// Initialize Select2 and form state
$(document).ready(function() {
    
    // Check for saved category selection from customer creation
    const savedCategory = sessionStorage.getItem('selectedCategory');
    if (savedCategory) {
        // Set the category dropdown to saved value
        $('#category').val(savedCategory);
        console.log('Restored saved category:', savedCategory);
        // Clear the saved value to avoid unintended restoration on future visits
        sessionStorage.removeItem('selectedCategory');
    }

    // Initialize Select2 for all asset selection dropdowns
    $('#serial_number, #repair_serial_number, #checkout_serial_number').select2({
        placeholder: 'Search by serial number, model, or asset tag...',
        allowClear: true,
        width: '100%'
    });

    // Initialize Select2 for Internal Transfer customer dropdowns (offboarding/onboarding)
    $('#offboarding_customer_id, #onboarding_customer_id').select2({
        placeholder: 'Search or select customer...',
        allowClear: true,
        width: '100%'
    });

    // Initialize Select2 for customer selection dropdowns with enhanced search
    $('#customer_id, #return_customer_id').select2({
        placeholder: 'Search by customer name, company, or email...',
        allowClear: true,
        width: '100%',
        minimumInputLength: 0,  // Show all options immediately
        ajax: {
            url: '/api/customers/search',
            dataType: 'json',
            delay: 300,
            data: function (params) {
                return {
                    q: params.term || '' // search term, empty for initial load
                };
            },
            processResults: function (data) {
                return {
                    results: data.map(function(item) {
                        return {
                            id: item.id,
                            text: item.text,
                            name: item.name,
                            email: item.email,
                            company: item.company,
                            address: item.address
                        };
                    })
                };
            },
            cache: true
        },
        templateResult: function(customer) {
            if (customer.loading) {
                return customer.text;
            }
            
            // Custom template to show customer info more clearly
            var $container = $(
                '<div class="select2-result-customer clearfix">' +
                    '<div class="select2-result-customer__meta">' +
                        '<div class="select2-result-customer__title"></div>' +
                        '<div class="select2-result-customer__description"></div>' +
                    '</div>' +
                '</div>'
            );
            
            $container.find('.select2-result-customer__title').text(customer.name || customer.text);
            
            var description = '';
            if (customer.company) {
                description += customer.company;
            }
            if (customer.email) {
                description += (description ? '  ' : '') + customer.email;
            }
            
            $container.find('.select2-result-customer__description').text(description);
            
            return $container;
        },
        templateSelection: function(customer) {
            return customer.name || customer.text;
        }
    });

    // Initialize form state and show the correct category fields
    onCategoryChange();
    
    // Run onCategoryChange initially to hide/show appropriate buttons
    const initialCategory = $('#category').val();
    if (initialCategory === 'ASSET_RETURN_CLAW') {
        // Make sure we handle asset return category correctly on page load
        $('#mainSubmitButton').addClass('hidden');
    }
    
    // Add category change event handler
    $('#category').on('change', function() {
        const category = $(this).val();
        console.log('Category changed to:', category);
        
        // Toggle fields based on category
        onCategoryChange();
    });
    
    // If there's form data, trigger the asset selection change event
    if ($('#category').val()) {
        const category = $('#category').val();
        if (category === 'PIN_REQUEST' && $('#serial_number').val()) {
            $('#serial_number').trigger('change');
        } else if (category === 'ASSET_REPAIR' && $('#repair_serial_number').val()) {
            $('#repair_serial_number').trigger('change');
        } else if ((category === 'ASSET_CHECKOUT_CLAW') && $('#checkout_serial_number').val()) {
            $('#checkout_serial_number').trigger('change');
            
            // Remove any tracking pattern for Asset Checkout (claw)
            $('#shipping_tracking').removeAttr('pattern');
            
            // Make sure hidden field is populated
            const serial = $('#checkout_serial_number').val();
            if (serial) {
                $('#asset_checkout_serial').val(serial);
                console.log('Asset Checkout (claw) initialization: Set asset_checkout_serial to:', serial);
            }
        }
    }

    // Handle asset selection changes
    $('#serial_number, #repair_serial_number, #checkout_serial_number').on('change', function() {
        const selectedOption = $(this).find(':selected');
        const selectedValue = selectedOption.val();
        console.log(`Asset selected (change event - ${this.id}). Value:`, selectedValue);

        if (selectedOption.val()) {
            const model = selectedOption.data('model');
            const customer = selectedOption.data('customer');
            const assetTag = selectedOption.data('asset-tag');
            
            // Update the appropriate fields based on which dropdown changed
            if (this.id === 'serial_number') {
                $('#model').val(model);
                $('#customer_company').val(customer);
                if (!$('#subject').val()) {
                    $('#subject').val(`PIN Request - ${model} - ${selectedOption.val()}`);
                }
            } else if (this.id === 'repair_serial_number') {
                $('#repair_model').val(model);
                $('#repair_customer').val(customer);
                if (!$('#subject').val()) {
                    $('#subject').val(`Repair Request - ${model} - ${selectedOption.val()}`);
                }
            } else if (this.id === 'checkout_serial_number') {
                // Update the hidden field with the selected serial number
                $('#asset_checkout_serial').val(selectedOption.val());
                console.log('Updated #asset_checkout_serial hidden field to:', $('#asset_checkout_serial').val());
                
                // Set the subject for the ticket
                const ticketSubject = `Asset Checkout - ${model} (${assetTag}) - ${selectedOption.val()}`;
                $('#subject').val(ticketSubject);
                console.log('Updated subject to:', ticketSubject);
            }
        } else {
            // Clear hidden field if no asset is selected
            if (this.id === 'checkout_serial_number') {
                $('#asset_checkout_serial').val('');
                console.log('Cleared #asset_checkout_serial hidden field.');
            }
        }
    });

    // Handle customer selection for asset checkout
    $('#customer_id').on('change', function() {
        const selectedOption = $(this).find(':selected');
        if (selectedOption.val()) {
            // Check if it's a Select2 selection with custom data
            const select2Data = $(this).select2('data')[0];
            if (select2Data && select2Data.address) {
                $('#shipping_address').val(select2Data.address);
            } else {
                // Fallback to data attributes for pre-loaded options
                const address = selectedOption.data('address');
                if (address) {
                    $('#shipping_address').val(address);
                }
            }
        }
    });

    // Handle customer selection for asset return
    $('#return_customer_id').on('change', function() {
        const selectedOption = $(this).find(':selected');
        if (selectedOption.val()) {
            console.log('Return customer selected, processing address data...');
            
            // Check if it's a Select2 selection with custom data
            const select2Data = $(this).select2('data')[0];
            let customerName = '';
            let address = '';
            
            if (select2Data) {
                customerName = select2Data.name || select2Data.text;
                address = select2Data.address;
                console.log('Select2 data found:', { customerName, address });
            } else {
                // Fallback to data attributes for pre-loaded options
                customerName = selectedOption.text();
                address = selectedOption.data('address');
                console.log('Using data attributes:', { customerName, address });
            }
            
            // Additional fallback: try getting address from the original option element
            if (!address && selectedOption.length > 0) {
                address = selectedOption.attr('data-address');
                console.log('Using attr fallback:', address);
            }
            
            if (address && address !== 'None' && address !== '') {
                $('#return_shipping_address').val(address);
                console.log('Return shipping address set to:', address);
            } else {
                console.warn('No valid address found for selected customer');
                // Clear the address field if no valid address
                $('#return_shipping_address').val('');
            }
            
            // Set the subject for asset return tickets
            $('#return_subject').val(`Asset Return (claw) - ${customerName}`);
        } else {
            // Clear address when no customer is selected
            $('#return_shipping_address').val('');
            $('#return_subject').val('');
        }
    });

    // Add form submit handler
    $('#ticketForm').on('submit', function(e) {
        const category = $('#category').val();
        console.log(`Form submit event triggered for category: ${category}`);
        
        // For ASSET_CHECKOUT_CLAW, handle with AJAX for popup functionality
        if (category === 'ASSET_CHECKOUT_CLAW') {
            console.log('Using AJAX submission for ASSET_CHECKOUT_CLAW');
            e.preventDefault();
            
            // Validate form first
            const serialNumber = $('#asset_checkout_serial').val();
            if (!serialNumber) {
                alert('Please select an asset');
                return false;
            }
            
            const customerId = $('#customer_id').val();
            if (!customerId) {
                alert('Please select a customer');
                return false;
            }
            
            const shippingAddress = $('#shipping_address').val();
            if (!shippingAddress) {
                alert('Please provide a shipping address');
                return false;
            }
            
            // Force update accessories data
            if (selectedAccessories.length > 0) {
                const jsonData = JSON.stringify(selectedAccessories);
                $('#selected_accessories').val(jsonData);
            }

            // Disable hidden queue fields to prevent them from being submitted
            $('#pin_queue_id').prop('disabled', true);
            $('#queue_id').prop('disabled', true);
            // Keep checkout_queue_id enabled as it's the one for this category

            // Submit via AJAX
            const formData = new FormData(this);

            // Re-enable the fields after FormData is created (for future submissions)
            $('#pin_queue_id').prop('disabled', false);
            $('#queue_id').prop('disabled', false);

            // Debug: Log queue_id value
            const queueIdValue = $('#checkout_queue_id').val();
            console.log('[QUEUE DEBUG] checkout_queue_id value:', queueIdValue);
            console.log('[QUEUE DEBUG] FormData queue_id:', formData.get('queue_id'));
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAssetCheckoutSuccessModal(data);
                } else {
                    alert('Error creating ticket: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while creating the ticket');
            });
            
            return false;
        }
        
        // For ASSET_RETURN_CLAW, validate outbound tracking number is provided
        else if (category === 'ASSET_RETURN_CLAW') {
            console.log('Validating ASSET_RETURN_CLAW category...');
            // Validate customer selection
            const customerId = $('#return_customer_id').val();
            if (!customerId) {
                console.log('Submit validation failed: Customer not selected. Preventing submission.');
                e.preventDefault();
                alert('Please select a customer');
                return false;
            }
            
            // Validate description
            const description = $('#return_description').val();
            if (!description) {
                console.log('Submit validation failed: Description not provided. Preventing submission.');
                e.preventDefault();
                alert('Please provide a return description');
                return false;
            }
            
            // Validate shipping address
            const shippingAddress = $('#return_shipping_address').val();
            if (!shippingAddress) {
                console.log('Submit validation failed: Shipping address not provided. Preventing submission.');
                e.preventDefault();
                alert('Please provide a shipping address');
                return false;
            }
            
            // Tracking validation is now optional
            // No check for outbound tracking - it's now optional
            
            // Set a default subject if not provided
            if (!$('#subject').val()) {
                const customer = $('#return_customer_id option:selected').text();
                $('#subject').val(`Asset Return (claw) - ${customer}`);
            }
            
            // Explicitly bypass any asset validation for return tickets by setting a dummy value
            $('#asset_checkout_serial').val('ASSET_RETURN_NO_ASSET');
            
            console.log('Submit validation passed for Asset Return. Submitting form...');
            return true; // Allow the form to submit
        }
        
        // Only validate asset selection for specific checkout categories
        else if (category === 'ASSET_CHECKOUT_CLAW') {
            console.log('Validating ASSET_CHECKOUT_CLAW category...');
            // Use the hidden field which is reliably updated by the change handler
            const serialNumber = $('#asset_checkout_serial').val();
            console.log('Submit validation: Checking #asset_checkout_serial. Value:', serialNumber);

            if (!serialNumber) {
                console.log('Submit validation failed: #asset_checkout_serial is empty. Preventing submission.');
                e.preventDefault();
                alert('Please select an asset');
                return false;
            }
            
            console.log('Submit validation passed for asset selection.');

            // Debug: Check selected accessories
            const selectedAccessories = $('#selected_accessories').val();
            console.log('FORM SUBMIT DEBUG: Selected accessories data:', selectedAccessories);
            console.log('FORM SUBMIT DEBUG: Hidden input element exists:', $('#selected_accessories').length > 0);
            console.log('FORM SUBMIT DEBUG: Hidden input name attribute:', $('#selected_accessories').attr('name'));
            
            if (selectedAccessories) {
                try {
                    const accessoriesData = JSON.parse(selectedAccessories);
                    console.log('FORM SUBMIT DEBUG: Parsed accessories data:', accessoriesData);
                    console.log('FORM SUBMIT DEBUG: Number of selected accessories:', accessoriesData.length);
                    
                    // Force the form to include this data by ensuring it's properly set
                    $('#selected_accessories').val(selectedAccessories);
                    console.log('FORM SUBMIT DEBUG: Re-confirmed hidden input value:', $('#selected_accessories').val());
                } catch (e) {
                    console.error('FORM SUBMIT DEBUG: Error parsing accessories data:', e);
                }
            } else {
                console.log('FORM SUBMIT DEBUG: No accessories selected - this is the issue!');
                console.log('FORM SUBMIT DEBUG: Check if CSV was uploaded and accessories were selected');
            }

            // Ensure no tracking format validation for any carrier
            $('#shipping_tracking').removeAttr('pattern');
            
            console.log('Form submitted with asset_checkout_serial:', $('#asset_checkout_serial').val());
        } else if (category === 'PIN_REQUEST') {
             console.log('Validating PIN_REQUEST category...');
            const serialNumber = $('#serial_number').val();
            if (!serialNumber) {
                 console.log('Submit validation failed: #serial_number is empty. Preventing submission.');
                e.preventDefault();
                alert('Please select an asset');
                return false;
            }
        } else if (category === 'ASSET_REPAIR') {
             console.log('Validating ASSET_REPAIR category...');
            const serialNumber = $('#repair_serial_number').val();
            if (!serialNumber) {
                 console.log('Submit validation failed: #repair_serial_number is empty. Preventing submission.');
                e.preventDefault();
                alert('Please select an asset');
                return false;
            }
        } else if (category === 'ASSET_INTAKE') {
            console.log('Validating ASSET_INTAKE category...');
            // Validate required fields for Asset Intake
            const title = $('#intake_title').val();
            if (!title) {
                console.log('Submit validation failed: Title not provided. Preventing submission.');
                e.preventDefault();
                alert('Please provide a title');
                return false;
            }
            
            const description = $('#intake_description').val();
            if (!description) {
                console.log('Submit validation failed: Description not provided. Preventing submission.');
                e.preventDefault();
                alert('Please provide a description');
                return false;
            }
            
            const priority = $('#intake_priority').val();
            if (!priority) {
                console.log('Submit validation failed: Priority not selected. Preventing submission.');
                e.preventDefault();
                alert('Please select a priority');
                return false;
            }

            const queueId = $('#intake_queue_id').val();
            if (!queueId) {
                console.log('Submit validation failed: Queue not selected. Preventing submission.');
                e.preventDefault();
                alert('Please select a queue');
                return false;
            }

            // Set subject based on title for Asset Intake
            if (!$('#subject').val()) {
                $('#subject').val(title);
            }

            console.log('Submit validation passed for Asset Intake. Submitting form...');
            return true;
        } else if (category === 'INTERNAL_TRANSFER') {
            console.log('Validating INTERNAL_TRANSFER category...');

            // Validate offboarding customer
            const offboardingCustomerId = $('#offboarding_customer_id').val();
            if (!offboardingCustomerId) {
                console.log('Submit validation failed: Offboarding customer not selected. Preventing submission.');
                e.preventDefault();
                alert('Please select an offboarding customer');
                return false;
            }

            // Validate offboarding details
            const offboardingDetails = $('#offboarding_details').val();
            if (!offboardingDetails) {
                console.log('Submit validation failed: Offboarding details not provided. Preventing submission.');
                e.preventDefault();
                alert('Please provide offboarding device details');
                return false;
            }

            // Validate offboarding address
            const offboardingAddress = $('#offboarding_address').val();
            if (!offboardingAddress) {
                console.log('Submit validation failed: Offboarding address not provided. Preventing submission.');
                e.preventDefault();
                alert('Please provide offboarding address');
                return false;
            }

            // Validate onboarding customer
            const onboardingCustomerId = $('#onboarding_customer_id').val();
            if (!onboardingCustomerId) {
                console.log('Submit validation failed: Onboarding customer not selected. Preventing submission.');
                e.preventDefault();
                alert('Please select an onboarding customer');
                return false;
            }

            // Validate onboarding address
            const onboardingAddress = $('#onboarding_address').val();
            if (!onboardingAddress) {
                console.log('Submit validation failed: Onboarding address not provided. Preventing submission.');
                e.preventDefault();
                alert('Please provide onboarding address');
                return false;
            }

            // Get customer names for subject
            const offboardingCustomerName = $('#offboarding_customer_id option:selected').text().split('(')[0].trim();
            const onboardingCustomerName = $('#onboarding_customer_id option:selected').text().split('(')[0].trim();

            // Auto-populate hidden fields for backward compatibility
            $('#transfer_name').val(onboardingCustomerName);
            $('#transfer_address').val(onboardingAddress);

            // Auto-populate subject field
            const subjectText = `Internal Transfer: ${offboardingCustomerName}  ${onboardingCustomerName}`;
            $('#subject').val(subjectText);

            // Auto-populate description
            if (!$('#description').val()) {
                let descText = ` Offboarding: ${offboardingCustomerName}\n`;
                descText += `Device Details: ${offboardingDetails}\n`;
                descText += `From Address: ${offboardingAddress}\n\n`;
                descText += ` Onboarding: ${onboardingCustomerName}\n`;
                descText += `To Address: ${onboardingAddress}`;

                const transferTracking = $('#transfer_tracking').val();
                if (transferTracking) {
                    descText += `\n\nTracking: ${transferTracking}`;
                }

                $('#description').val(descText);
            }

            console.log('Submit validation passed for Internal Transfer. Submitting form...');
            return true;
        }

        // Check if this is a custom category (not one of the hardcoded enum values)
        const knownCategories = ['PIN_REQUEST', 'ASSET_REPAIR', 'ASSET_CHECKOUT_CLAW', 'ASSET_INTAKE', 'ASSET_RETURN_CLAW', 'INTERNAL_TRANSFER'];
        const isCustomCategory = category && !knownCategories.includes(category);
        
        if (isCustomCategory) {
            console.log('Validating custom category:', category);
            
            // Sync the visible subject field with the hidden subject field for custom categories
            const generalSubjectValue = $('#general_subject').val();
            if (generalSubjectValue) {
                $('#subject').val(generalSubjectValue);
            }
            
            // Sync the visible tracking fields with the hidden tracking fields
            const visibleOutboundTracking = $('#visible_outbound_tracking').val();
            const visibleInboundTracking = $('#visible_inbound_tracking').val();
            if (visibleOutboundTracking) {
                $('#outbound_tracking').val(visibleOutboundTracking);
                $('#shipping_tracking').val(visibleOutboundTracking);
            }
            if (visibleInboundTracking) {
                $('#inbound_tracking').val(visibleInboundTracking);
            }
            
            // For custom categories, only validate general required fields
            const subject = $('#subject').val();
            if (!subject) {
                console.log('Submit validation failed: Subject not provided. Preventing submission.');
                e.preventDefault();
                alert('Please provide a subject');
                return false;
            }
            
            const description = $('#description').val();
            if (!description) {
                console.log('Submit validation failed: Description not provided. Preventing submission.');
                e.preventDefault();
                alert('Please provide a description');
                return false;
            }
            
            const priority = $('#priority').val();
            if (!priority) {
                console.log('Submit validation failed: Priority not selected. Preventing submission.');
                e.preventDefault();
                alert('Please select a priority');
                return false;
            }
            
            console.log('Submit validation passed for custom category. Submitting form...');
            return true;
        }
        
        console.log('Form validation completed. Allowing submission.');
        // ... rest of submit logic ...
        return true;
    });

    // Add event listener for intake title changes
    document.addEventListener('DOMContentLoaded', function() {
        const intakeTitleField = document.getElementById('intake_title');
        if (intakeTitleField) {
            intakeTitleField.addEventListener('input', function() {
                const subjectField = document.getElementById('subject');
                if (subjectField) {
                    subjectField.value = this.value;
                }
            });
        }
        
        // Add event listener for general subject field changes (for custom categories)
        const generalSubjectField = document.getElementById('general_subject');
        if (generalSubjectField) {
            generalSubjectField.addEventListener('input', function() {
                const hiddenSubjectField = document.getElementById('subject');
                if (hiddenSubjectField) {
                    hiddenSubjectField.value = this.value;
                }
            });
        }
        
        // Add event listeners for shipping tracking field changes
        const visibleOutboundTrackingField = document.getElementById('visible_outbound_tracking');
        if (visibleOutboundTrackingField) {
            visibleOutboundTrackingField.addEventListener('input', function() {
                const hiddenOutboundField = document.getElementById('outbound_tracking');
                const hiddenShippingField = document.getElementById('shipping_tracking');
                if (hiddenOutboundField) {
                    hiddenOutboundField.value = this.value;
                }
                if (hiddenShippingField) {
                    hiddenShippingField.value = this.value;
                }
            });
        }
        
        const visibleInboundTrackingField = document.getElementById('visible_inbound_tracking');
        if (visibleInboundTrackingField) {
            visibleInboundTrackingField.addEventListener('input', function() {
                const hiddenInboundField = document.getElementById('inbound_tracking');
                if (hiddenInboundField) {
                    hiddenInboundField.value = this.value;
                }
            });
        }
    });
});

// Tech Asset Functions
function addNewTechAsset() {
    // Implementation for adding new tech asset
    console.log('Add new tech asset clicked');
}

function importTechAsset() {
    // Implementation for importing tech asset
    console.log('Import tech asset clicked');
}

function addAsset() {
    const assetTag = document.getElementById('asset_tag').value;
    const serialNumber = document.getElementById('serial_number').value;
    const assetName = document.getElementById('asset_name').value;
    const status = document.getElementById('asset_status').value;

    if (!assetTag || !serialNumber || !assetName) {
        alert('Please fill in all required fields');
        return;
    }

    const existingAssets = document.getElementById('existingAssets');
    
    // Clear "No assets" message if it exists
    if (existingAssets.innerHTML.includes('No assets assigned')) {
        existingAssets.innerHTML = '';
    }

    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${assetTag}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${serialNumber}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assetName}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                ${status}
            </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            <button onclick="removeAsset(this)" class="text-red-600 hover:text-red-900">Remove</button>
        </td>
    `;
    existingAssets.appendChild(newRow);

    // Clear form
    document.getElementById('asset_tag').value = '';
    document.getElementById('serial_number').value = '';
    document.getElementById('asset_name').value = '';
    document.getElementById('asset_status').value = 'Active';
}

function removeAsset(button) {
    const row = button.closest('tr');
    row.remove();

    const existingAssets = document.getElementById('existingAssets');
    if (existingAssets.children.length === 0) {
        existingAssets.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                    No assets assigned to this case
                </td>
            </tr>
        `;
    }
}

// Function to submit the Asset Return form bypassing normal validation
function submitAssetReturnForm() {
    console.log('Custom Asset Return submit function called');
    
    // Validate required fields for asset return
    if (!$('#return_customer_id').val()) {
        alert('Please select a customer');
        return false;
    }
    
    if (!$('#return_description').val()) {
        alert('Please provide a return description');
        return false;
    }
    
    if (!$('#return_shipping_address').val()) {
        alert('Please provide a return address');
        return false;
    }
    
    // Set the subject for the ticket
    const customer = $('#return_customer_id option:selected').text();
    $('#return_subject').val(`Asset Return (claw) - ${customer}`);
    
    // Ensure the dummy value is set for the asset checkout serial
    $('#asset_return_serial').val('ASSET_RETURN_NO_ASSET');
    
    console.log('Asset Return validation passed. Creating form submission...');
    
    // Create a temporary form to submit data
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = window.location.href;
    form.style.display = 'none';
    
    // Add CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    // Add category
    const categoryInput = document.createElement('input');
    categoryInput.type = 'hidden';
    categoryInput.name = 'category';
    categoryInput.value = 'ASSET_RETURN_CLAW';
    form.appendChild(categoryInput);
    
    // Add priority
    const priorityInput = document.createElement('input');
    priorityInput.type = 'hidden';
    priorityInput.name = 'priority';
    priorityInput.value = $('#priority').val();
    form.appendChild(priorityInput);
    
    // Add customer ID
    const customerInput = document.createElement('input');
    customerInput.type = 'hidden';
    customerInput.name = 'customer_id';
    customerInput.value = $('#return_customer_id').val();
    form.appendChild(customerInput);
    
    // Add return description (as the main description)
    const descriptionInput = document.createElement('input');
    descriptionInput.type = 'hidden';
    descriptionInput.name = 'description';
    descriptionInput.value = $('#return_description').val();
    form.appendChild(descriptionInput);
    
    // ALSO add return description as separate field
    const returnDescriptionInput = document.createElement('input');
    returnDescriptionInput.type = 'hidden';
    returnDescriptionInput.name = 'return_description';
    returnDescriptionInput.value = $('#return_description').val();
    form.appendChild(returnDescriptionInput);
    
    // Add shipping address
    const addressInput = document.createElement('input');
    addressInput.type = 'hidden';
    addressInput.name = 'shipping_address';
    addressInput.value = $('#return_shipping_address').val();
    form.appendChild(addressInput);
    
    // Add outbound tracking
    const trackingInput = document.createElement('input');
    trackingInput.type = 'hidden';
    trackingInput.name = 'shipping_tracking';
    trackingInput.value = $('#outbound_tracking').val();
    form.appendChild(trackingInput);
    
    // Add inbound tracking if provided
    if ($('#inbound_tracking').val()) {
        const inboundInput = document.createElement('input');
        inboundInput.type = 'hidden';
        inboundInput.name = 'return_tracking';
        inboundInput.value = $('#inbound_tracking').val();
        form.appendChild(inboundInput);
    }
    
    // Add queue_id if selected
    if ($('#queue_id').val()) {
        const queueInput = document.createElement('input');
        queueInput.type = 'hidden';
        queueInput.name = 'queue_id';
        queueInput.value = $('#queue_id').val();
        form.appendChild(queueInput);
    }
    
    // Add notes if provided
    if ($('#return_notes').val()) {
        const notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'notes';
        notesInput.value = $('#return_notes').val();
        form.appendChild(notesInput);
    }

    // Add damage_description (Reported Issue) if provided
    if ($('#return_damage_description').val()) {
        const damageInput = document.createElement('input');
        damageInput.type = 'hidden';
        damageInput.name = 'damage_description';
        damageInput.value = $('#return_damage_description').val();
        form.appendChild(damageInput);
    }

    // Add subject
    const subjectInput = document.createElement('input');
    subjectInput.type = 'hidden';
    subjectInput.name = 'subject';
    subjectInput.value = `Asset Return (claw) - ${$('#return_customer_id option:selected').text()}`;
    form.appendChild(subjectInput);
    
    // Add dummy asset checkout serial
    const serialInput = document.createElement('input');
    serialInput.type = 'hidden';
    serialInput.name = 'asset_checkout_serial';
    serialInput.value = 'ASSET_RETURN_NO_ASSET';
    form.appendChild(serialInput);
    
    // Add the form to the document and submit it
    document.body.appendChild(form);
    console.log('Submitting custom form for Asset Return...');
    form.submit();
    
    return true;
}

// CSV Upload and Accessory Selection Functions
let csvAccessoryData = [];
let selectedAccessories = [];

function handleCsvUpload(input) {
    const file = input.files[0];
    const fileName = document.getElementById('csvFileName');
    
    if (file) {
        fileName.textContent = `Selected file: ${file.name}`;
        fileName.classList.remove('hidden');
        
        // Parse CSV file
        const reader = new FileReader();
        reader.onload = function(e) {
            const csv = e.target.result;
            parseCsvData(csv);
        };
        reader.readAsText(file);
    } else {
        fileName.classList.add('hidden');
        hideAccessorySelection();
    }
}

function parseCsvData(csvText) {
    const lines = csvText.split('\n');
    if (lines.length < 2) {
        alert('CSV file must contain at least a header row and one data row.');
        return;
    }
    
    // Parse header
    const header = lines[0].split(',').map(col => col.trim().replace(/"/g, ''));
    
    // Find relevant columns (flexible column mapping)
    const columnMapping = {};
    header.forEach((col, index) => {
        const colLower = col.toLowerCase();
        if (colLower.includes('product') || colLower.includes('name') || colLower.includes('title')) {
            columnMapping.product = index;
        } else if (colLower.includes('category') || colLower.includes('type')) {
            columnMapping.category = index;
        } else if (colLower.includes('quantity') || colLower.includes('qty')) {
            columnMapping.quantity = index;
        } else if (colLower.includes('brand') || colLower.includes('manufacturer')) {
            columnMapping.brand = index;
        } else if (colLower.includes('model') || colLower.includes('model_no')) {
            columnMapping.model = index;
        } else if (colLower.includes('serial') || colLower.includes('serial_number')) {
            columnMapping.serial = index;
        }
    });
    
    // Parse data rows
    csvAccessoryData = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const data = line.split(',').map(cell => cell.trim().replace(/"/g, ''));
        
        const accessoryItem = {
            id: i,
            product: data[columnMapping.product || 0] || '',
            category: data[columnMapping.category || 1] || '',
            quantity: parseInt(data[columnMapping.quantity || 2]) || 1,
            brand: data[columnMapping.brand || 3] || '',
            model: data[columnMapping.model || 4] || '',
            serial: data[columnMapping.serial || 5] || ''
        };
        
        // Only add items that look like accessories
        if (accessoryItem.product && isLikelyAccessory(accessoryItem)) {
            csvAccessoryData.push(accessoryItem);
        }
    }
    
    if (csvAccessoryData.length > 0) {
        displayAccessoryPreview();
        searchForMatchingAccessories();
    } else {
        alert('No accessory items found in the CSV file. Please ensure the CSV contains accessory-related products.');
    }
}

function isLikelyAccessory(item) {
    const accessoryKeywords = [
        'adapter', 'cable', 'charger', 'mouse', 'keyboard', 'headset', 
        'webcam', 'dock', 'hub', 'dongle', 'stand', 'pad', 'cover',
        'case', 'sleeve', 'bag', 'power supply', 'cord', 'usb', 'hdmi',
        'ethernet', 'wifi', 'bluetooth', 'speaker', 'microphone'
    ];
    
    const searchText = `${item.product} ${item.category} ${item.brand} ${item.model}`.toLowerCase();
    return accessoryKeywords.some(keyword => searchText.includes(keyword));
}

function displayAccessoryPreview() {
    const container = document.getElementById('accessorySelectionContainer');
    const preview = document.getElementById('accessoryPreview');
    
    container.classList.remove('hidden');
    
    let html = '';
    csvAccessoryData.forEach((item, index) => {
        html += `
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-md bg-gray-50" data-item-index="${index}">
                <div class="flex-1">
                    <div class="font-medium text-gray-900">${item.product}</div>
                    <div class="text-sm text-gray-500">
                        Category: ${item.category || 'N/A'} | 
                        Brand: ${item.brand || 'N/A'} | 
                        Qty: ${item.quantity}
                        ${item.serial ? ` | Serial: ${item.serial}` : ''}
                    </div>
                    <div id="matches_${index}" class="mt-2 hidden">
                        <div class="text-xs text-blue-600 font-medium">Inventory Matches:</div>
                        <div id="matchList_${index}" class="text-xs text-gray-600"></div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" 
                           id="accessory_${index}" 
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                           onchange="toggleAccessorySelection(${index})">
                    <label for="accessory_${index}" class="text-sm text-gray-700">Select</label>
                </div>
            </div>
        `;
    });
    
    preview.innerHTML = html;
}

function searchForMatchingAccessories() {
    // Search for matching accessories in the inventory
    csvAccessoryData.forEach((item, index) => {
        fetch('/tickets/api/accessories/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify({
                product_name: item.product,
                category: item.category,
                brand: item.brand,
                model: item.model
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.matches && data.matches.length > 0) {
                displayMatches(index, data.matches);
            }
        })
        .catch(error => {
            console.error('Error searching for accessories:', error);
        });
    });
}

function displayMatches(itemIndex, matches) {
    const matchesContainer = document.getElementById(`matches_${itemIndex}`);
    const matchList = document.getElementById(`matchList_${itemIndex}`);
    
    if (matches.length > 0) {
        matchesContainer.classList.remove('hidden');
        
        let html = '';
        matches.forEach(match => {
            const isAvailable = match.available_quantity > 0;
            const statusColor = isAvailable ? 'text-green-600' : 'text-red-600';
            const statusText = isAvailable ? `Available (${match.available_quantity})` : 'Out of Stock';
            
            html += `
                <div class="flex items-center justify-between p-2 bg-white border rounded mb-1">
                    <div class="flex-1">
                        <div class="font-medium">${match.name}</div>
                        <div class="text-xs text-gray-500">Category: ${match.category || 'N/A'} | Model: ${match.model_no || 'N/A'}</div>
                        <div class="text-xs ${statusColor}">${statusText}</div>
                    </div>
                    ${isAvailable ? `
                        <button onclick="selectInventoryAccessory(${itemIndex}, ${match.id}, '${match.name}')" 
                                class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                            Select
                        </button>
                    ` : ''}
                </div>
            `;
        });
        
        matchList.innerHTML = html;
    }
}

function selectInventoryAccessory(itemIndex, accessoryId, accessoryName) {
    // Check the corresponding checkbox
    const checkbox = document.getElementById(`accessory_${itemIndex}`);
    if (!checkbox.checked) {
        checkbox.checked = true;
        toggleAccessorySelection(itemIndex);
    }
    
    // Store the inventory accessory ID for later use
    csvAccessoryData[itemIndex].inventoryId = accessoryId;
    csvAccessoryData[itemIndex].inventoryName = accessoryName;
    
    // Update the display
    updateSelectedAccessoriesSummary();
}

function toggleAccessorySelection(index) {
    const checkbox = document.getElementById(`accessory_${index}`);
    const item = csvAccessoryData[index];
    
    if (checkbox.checked) {
        // Add to selected accessories
        selectedAccessories.push({
            csvIndex: index,
            product: item.product,
            category: item.category,
            quantity: item.quantity,
            inventoryId: item.inventoryId,
            inventoryName: item.inventoryName
        });
    } else {
        // Remove from selected accessories
        selectedAccessories = selectedAccessories.filter(acc => acc.csvIndex !== index);
    }
    
    updateSelectedAccessoriesSummary();
}

function updateSelectedAccessoriesSummary() {
    const summaryContainer = document.getElementById('selectedAccessoriesSummary');
    const summaryList = document.getElementById('selectedAccessoriesList');
    const hiddenInput = document.getElementById('selected_accessories');
    
    if (selectedAccessories.length > 0) {
        summaryContainer.classList.remove('hidden');
        
        let html = '';
        selectedAccessories.forEach(acc => {
            const displayName = acc.inventoryName || acc.product;
            const source = acc.inventoryId ? '(from inventory)' : '(from CSV)';
            
            html += `
                <div class="flex items-center justify-between bg-blue-50 p-2 rounded border">
                    <div class="flex-1">
                        <span class="font-medium">${displayName}</span>
                        <span class="text-sm text-gray-500 ml-2">${source}</span>
                        <span class="text-sm text-gray-500 ml-2">Qty: ${acc.quantity}</span>
                    </div>
                    <button onclick="removeSelectedAccessory(${acc.csvIndex})" 
                            class="text-red-500 hover:text-red-700 text-sm">
                        Remove
                    </button>
                </div>
            `;
        });
        
        summaryList.innerHTML = html;
        
        // Update hidden input with selected accessories data
        const jsonData = JSON.stringify(selectedAccessories);
        hiddenInput.value = jsonData;
        console.log('Updated hidden input with accessories data:', jsonData);
        console.log('Hidden input element:', hiddenInput);
        console.log('Hidden input value:', hiddenInput.value);
    } else {
        summaryContainer.classList.add('hidden');
        hiddenInput.value = '';
        console.log('Cleared hidden input - no accessories selected');
    }
}

function removeSelectedAccessory(csvIndex) {
    // Uncheck the checkbox
    const checkbox = document.getElementById(`accessory_${csvIndex}`);
    if (checkbox) {
        checkbox.checked = false;
    }
    
    // Remove from selected accessories
    selectedAccessories = selectedAccessories.filter(acc => acc.csvIndex !== csvIndex);
    
    updateSelectedAccessoriesSummary();
}

function hideAccessorySelection() {
    const container = document.getElementById('accessorySelectionContainer');
    container.classList.add('hidden');
    
    // Reset data
    csvAccessoryData = [];
    selectedAccessories = [];
    
    const hiddenInput = document.getElementById('selected_accessories');
    hiddenInput.value = '';
}

// Test function to simulate accessory selection
function testAccessoryAssignment() {
    console.log('TEST: Simulating accessory selection...');
    
    // Clear existing data
    selectedAccessories = [];
    csvAccessoryData = [];
    
    // Simulate CSV data
    csvAccessoryData = [
        {
            id: 1,
            product: 'Test Wireless Mouse',
            category: 'Mouse',
            quantity: 1,
            brand: 'Logitech',
            model: 'M705',
            serial: 'TEST001'
        },
        {
            id: 2,
            product: 'Test USB-C Cable',
            category: 'Cable',
            quantity: 2,
            brand: 'Anker',
            model: 'PowerLine',
            serial: 'TEST002'
        }
    ];
    
    // Simulate selecting accessories
    selectedAccessories = [
        {
            csvIndex: 0,
            product: 'Test Wireless Mouse',
            category: 'Mouse',
            quantity: 1,
            inventoryId: null,
            inventoryName: null
        },
        {
            csvIndex: 1,
            product: 'Test USB-C Cable',
            category: 'Cable',
            quantity: 2,
            inventoryId: null,
            inventoryName: null
        }
    ];
    
    console.log('TEST: Simulated selected accessories:', selectedAccessories);
    
    // Show the accessory selection container
    const container = document.getElementById('accessorySelectionContainer');
    if (container) {
        container.classList.remove('hidden');
    }
    
    // Update the summary
    updateSelectedAccessoriesSummary();
    
    console.log('TEST: Updated hidden input value:', document.getElementById('selected_accessories').value);
    alert('Test accessories added! Check the console for debug info and try submitting the form.');
}

// Debug function to test form submission
function debugFormSubmission() {
    console.log('DEBUG: Testing form data submission...');
    
    // Get form data
    const form = document.getElementById('ticketForm');
    if (!form) {
        alert('Form not found!');
        return;
    }
    
    const formData = new FormData(form);
    
    // Log all form data
    console.log('DEBUG: Current form data:');
    for (let [key, value] of formData.entries()) {
        if (key === 'selected_accessories') {
            console.log(`  ${key}: ${value.substring(0, 100)}...`);
        } else {
            console.log(`  ${key}: ${value}`);
        }
    }
    
    // Check if selected_accessories field exists and has data
    const selectedAccessoriesInput = document.getElementById('selected_accessories');
    if (selectedAccessoriesInput) {
        console.log('DEBUG: selected_accessories input found');
        console.log('DEBUG: selected_accessories value:', selectedAccessoriesInput.value);
        
        // Force update if we have selected accessories
        if (selectedAccessories.length > 0) {
            const jsonData = JSON.stringify(selectedAccessories);
            selectedAccessoriesInput.value = jsonData;
            console.log('DEBUG: Force updated selected_accessories to:', jsonData);
        }
    } else {
        console.log('DEBUG: selected_accessories input NOT FOUND');
    }
    
    // Send test request to debug endpoint
    const testFormData = new FormData();
    testFormData.append('category', 'ASSET_CHECKOUT_CLAW');
    testFormData.append('selected_accessories', selectedAccessoriesInput ? selectedAccessoriesInput.value : '');
    testFormData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
    
    fetch('/tickets/api/debug/form-data', {
        method: 'POST',
        body: testFormData
    })
    .then(response => response.json())
    .then(data => {
        console.log('DEBUG: Server response:', data);
        alert(`Debug test completed! Check console for details.\nSelected accessories present: ${data.selected_accessories_present}\nData length: ${data.selected_accessories_length}`);
    })
    .catch(error => {
        console.error('DEBUG: Error:', error);
        alert('Debug test failed. Check console for details.');
    });
}

// Handle drag and drop for CSV upload
document.addEventListener('DOMContentLoaded', function() {
    // Add form submission debugging
    const form = document.getElementById('ticketForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('FORM SUBMIT DEBUG: Form is being submitted');
            
            const selectedAccessoriesInput = document.getElementById('selected_accessories');
            if (selectedAccessoriesInput) {
                console.log('FORM SUBMIT DEBUG: selected_accessories field exists');
                console.log('FORM SUBMIT DEBUG: selected_accessories value:', selectedAccessoriesInput.value);
                console.log('FORM SUBMIT DEBUG: selected_accessories name:', selectedAccessoriesInput.name);
                
                // Force update the hidden field value before submission
                if (selectedAccessories.length > 0) {
                    const jsonData = JSON.stringify(selectedAccessories);
                    selectedAccessoriesInput.value = jsonData;
                    console.log('FORM SUBMIT DEBUG: Force updated selected_accessories to:', jsonData);
                }
            } else {
                console.log('FORM SUBMIT DEBUG: selected_accessories field NOT FOUND');
            }
            
            // Log all form data
            const formData = new FormData(form);
            console.log('FORM SUBMIT DEBUG: All form data:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
        });
    }
    
    // Handle CSV drag and drop
    const dropZone = document.getElementById('csvDropZone');
    const fileInput = document.getElementById('accessories_csv');
    
    if (dropZone && fileInput) {
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/csv') {
                fileInput.files = files;
                handleCsvUpload(fileInput);
            } else {
                alert('Please upload a CSV file');
            }
        });
    }
});

// Auto-fill address and company for Internal Transfer customers
$(document).ready(function() {
    // Store all onboarding customer options on page load
    const allOnboardingCustomers = $('#onboarding_customer_id option').clone();

    // Handle offboarding customer selection
    $('#offboarding_customer_id').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const address = selectedOption.data('address');
        const company = selectedOption.data('company');

        if (address) {
            $('#offboarding_address').val(address);
        }

        // Filter onboarding customers to same company
        filterOnboardingCustomers(company);

        // Update client company field
        updateClientCompany();
    });

    // Handle onboarding customer selection
    $('#onboarding_customer_id').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const address = selectedOption.data('address');
        const company = selectedOption.data('company');

        if (address) {
            $('#onboarding_address').val(address);
        }

        // Update client company field
        updateClientCompany();
    });

    // Function to filter onboarding customers by company
    function filterOnboardingCustomers(companyName) {
        const onboardingSelect = $('#onboarding_customer_id');

        // Clear current options except the first placeholder
        onboardingSelect.find('option:not(:first)').remove();

        // If no company selected, show all customers
        if (!companyName) {
            allOnboardingCustomers.each(function() {
                if ($(this).val() !== '') {
                    onboardingSelect.append($(this).clone());
                }
            });
            return;
        }

        // Filter and add only customers from the same company
        let matchingCustomers = 0;
        allOnboardingCustomers.each(function() {
            const optionCompany = $(this).data('company');
            if ($(this).val() === '') {
                // Keep the placeholder
                return;
            }
            if (optionCompany === companyName) {
                onboardingSelect.append($(this).clone());
                matchingCustomers++;
            }
        });

        // If no matching customers, show a message
        if (matchingCustomers === 0) {
            onboardingSelect.append('<option value="" disabled>No customers found in this company</option>');
        }

        // Refresh Select2 to show updated options
        onboardingSelect.trigger('change.select2');
    }

    // Function to update client company based on selected customers
    function updateClientCompany() {
        const offboardingCompany = $('#offboarding_customer_id option:selected').data('company');
        const onboardingCompany = $('#onboarding_customer_id option:selected').data('company');

        // If both customers have the same company, use that
        if (offboardingCompany && onboardingCompany && offboardingCompany === onboardingCompany) {
            $('#transfer_client').val(offboardingCompany);
        }
        // If only one company is available, use that
        else if (offboardingCompany) {
            $('#transfer_client').val(offboardingCompany);
        } else if (onboardingCompany) {
            $('#transfer_client').val(onboardingCompany);
        }
    }
});
</script>

<!-- Success Action Modal for Asset Checkout -->
<div id="assetCheckoutSuccessModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-green-600 to-emerald-700 text-white p-6 rounded-t-lg">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold"> Asset Checkout Ticket Created!</h3>
                    <p class="text-green-100 mt-1" id="assetCheckoutSuccessTicketId">Ticket #1234</p>
                </div>
            </div>
        </div>

        <!-- Modal Content -->
        <div class="p-6">
            <div class="text-center space-y-4">
                <div class="text-4xl"></div>
                <p class="text-gray-600" id="assetCheckoutSuccessMessage">Your asset checkout ticket has been created successfully!</p>
                
                <!-- Success Details -->
                <div class="bg-gray-50 rounded-lg p-4 text-left" id="assetCheckoutSuccessDetails">
                    <!-- Details will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Modal Actions -->
        <div class="bg-gray-50 px-6 py-4 rounded-b-lg">
            <div class="flex justify-between space-x-3">
                <button id="assetCheckoutCloseBtn" type="button" 
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                     Close
                </button>
                <button id="assetCheckoutViewTicketBtn" type="button" 
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                     View Ticket
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function showAssetCheckoutSuccessModal(data) {
    // Populate ticket information
    const ticketDisplayId = data.ticket_display_id || data.ticket_id || 'Unknown';
    document.getElementById('assetCheckoutSuccessTicketId').textContent = `Ticket #${ticketDisplayId}`;
    
    // Create success message
    let message = data.message || 'Your asset checkout ticket has been created successfully!';
    document.getElementById('assetCheckoutSuccessMessage').textContent = message;
    
    // Create success details
    let detailsHtml = '';
    if (data.assigned_accessories && data.assigned_accessories.length > 0) {
        detailsHtml += `<div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700"> Accessories:</span>
            <span class="text-sm text-gray-600">${data.assigned_accessories.length} items</span>
        </div>
        <div class="text-xs text-gray-500 mb-2">${data.assigned_accessories.join(', ')}</div>`;
    }
    
    if (!detailsHtml) {
        detailsHtml = '<div class="text-sm text-gray-500 text-center"> Ticket created successfully</div>';
    }
    
    document.getElementById('assetCheckoutSuccessDetails').innerHTML = detailsHtml;
    
    // Set up button handlers
    const viewTicketBtn = document.getElementById('assetCheckoutViewTicketBtn');
    const closeBtn = document.getElementById('assetCheckoutCloseBtn');
    
    // Store ticket ID for the view button
    viewTicketBtn.onclick = function() {
        if (data.ticket_id) {
            window.location.href = `/tickets/${data.ticket_id}`;
        } else {
            alert('Ticket ID not available');
        }
    };
    
    // Close modal handler
    closeBtn.onclick = function() {
        document.getElementById('assetCheckoutSuccessModal').classList.add('hidden');
        // Optionally clear the form and reset
        document.getElementById('ticketForm').reset();
        // Clear selected accessories
        selectedAccessories = [];
        csvAccessoryData = [];
        updateSelectedAccessoriesSummary();
        // Reset category to trigger field visibility changes
        document.getElementById('category').value = '';
        categoryChanged();
    };
    
    // Show the modal
    document.getElementById('assetCheckoutSuccessModal').classList.remove('hidden');
}
</script>
{% endblock %} 