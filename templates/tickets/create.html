{% extends "base.html" %}

{% block content %}
<!-- Add Select2 CSS in the head -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <div class="mb-6">
            <a href="{{ url_for('tickets.list_tickets') }}" 
               class="text-blue-600 hover:text-blue-800">
                ‚Üê Back to Tickets
            </a>
        </div>

        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h1 class="text-2xl font-bold">Create New Ticket</h1>
            </div>

            <form method="POST" enctype="multipart/form-data" class="px-6 py-4 space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- Category -->
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="category" 
                            name="category" 
                            required
                            onchange="toggleFormFields()"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select a category...</option>
                        <option value="PIN_REQUEST" {% if form and form.category == 'PIN_REQUEST' %}selected{% endif %}>PIN Request</option>
                        <option value="ASSET_REPAIR" {% if form and form.category == 'ASSET_REPAIR' %}selected{% endif %}>Asset Repair</option>
                        <option value="BULK_DELIVERY_QUOTATION" {% if form and form.category == 'BULK_DELIVERY_QUOTATION' %}selected{% endif %}>Bulk Delivery Quotation</option>
                        <option value="ASSET_CHECKOUT" {% if form and form.category == 'ASSET_CHECKOUT' %}selected{% endif %}>Asset Checkout</option>
                        <option value="ASSET_CHECKOUT_SINGPOST" {% if form and form.category == 'ASSET_CHECKOUT_SINGPOST' %}selected{% endif %}>Asset Checkout (SingPost)</option>
                    </select>
                </div>

                <!-- PIN Request Fields -->
                <div id="pinRequestFields" class="hidden space-y-6">
                    <!-- Country -->
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-700">Country</label>
                        <input type="text" 
                               id="country" 
                               name="country" 
                               value="{{ form.country if form else '' }}"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Serial Number Selection -->
                    <div>
                        <label for="serial_number" class="block text-sm font-medium text-gray-700">Asset Selection</label>
                        <select id="serial_number" 
                                name="serial_number"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select an asset...</option>
                            {% for asset in assets %}
                            <option value="{{ asset.serial_number }}" 
                                    data-model="{{ asset.model }}"
                                    data-customer="{{ asset.customer }}"
                                    data-asset-tag="{{ asset.asset_tag }}"
                                    {% if form and form.serial_number == asset.serial_number %}selected{% endif %}>
                                {{ asset.serial_number }} - {{ asset.model }} ({{ asset.asset_tag }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Auto-populated fields -->
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700">Model</label>
                        <input type="text" 
                               id="model" 
                               name="model" 
                               value="{{ form.model if form else '' }}"
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <div>
                        <label for="customer_company" class="block text-sm font-medium text-gray-700">Customer Company</label>
                        <input type="text" 
                               id="customer_company" 
                               name="customer_company" 
                               value="{{ form.customer_company if form else '' }}"
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <!-- Lock Type -->
                    <div>
                        <label for="lock_type" class="block text-sm font-medium text-gray-700">Lock Type</label>
                        <select id="lock_type" 
                                name="lock_type" 
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select lock type...</option>
                            <option value="ACTIVATION" {% if form and form.lock_type == 'ACTIVATION' %}selected{% endif %}>Activation Lock</option>
                            <option value="6_DIGIT" {% if form and form.lock_type == '6_DIGIT' %}selected{% endif %}>6 Digit Lock</option>
                            <option value="BIOS" {% if form and form.lock_type == 'BIOS' %}selected{% endif %}>BIOS Lock</option>
                            <option value="BITLOCKER" {% if form and form.lock_type == 'BITLOCKER' %}selected{% endif %}>Bitlocker</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ form.notes if form else '' }}</textarea>
                    </div>
                </div>

                <!-- Repair Fields -->
                <div id="repairFields" class="hidden space-y-6">
                    <!-- Country -->
                    <div>
                        <label for="repair_country" class="block text-sm font-medium text-gray-700">Country</label>
                        <input type="text" 
                               id="repair_country" 
                               name="country" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Serial Number Selection -->
                    <div>
                        <label for="repair_serial_number" class="block text-sm font-medium text-gray-700">Asset Selection</label>
                        <select id="repair_serial_number" 
                                name="serial_number"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select an asset...</option>
                            {% for asset in assets %}
                            <option value="{{ asset.serial_number }}" 
                                    data-model="{{ asset.model }}"
                                    data-customer="{{ asset.customer }}"
                                    data-asset-tag="{{ asset.asset_tag }}">
                                {{ asset.serial_number }} - {{ asset.model }} ({{ asset.asset_tag }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Auto-populated fields -->
                    <div>
                        <label for="repair_model" class="block text-sm font-medium text-gray-700">Model</label>
                        <input type="text" 
                               id="repair_model" 
                               name="model" 
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <div>
                        <label for="repair_customer" class="block text-sm font-medium text-gray-700">Customer Company</label>
                        <input type="text" 
                               id="repair_customer" 
                               name="customer_company" 
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <!-- Apple Diagnostics Code -->
                    <div>
                        <label for="apple_diagnostics" class="block text-sm font-medium text-gray-700">Apple Diagnostics Code (if applicable)</label>
                        <input type="text" 
                               id="apple_diagnostics" 
                               name="apple_diagnostics" 
                               placeholder="e.g., ADP000"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Damage Description -->
                    <div>
                        <label for="damage_description" class="block text-sm font-medium text-gray-700">Description of Damage</label>
                        <textarea id="damage_description" 
                                  name="damage_description" 
                                  rows="3"
                                  required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Image Upload -->
                    <div>
                        <label for="image" class="block text-sm font-medium text-gray-700">Upload Images</label>
                        <input type="file" 
                               id="image" 
                               name="image" 
                               accept="image/*"
                               multiple
                               class="mt-1 block w-full text-sm text-gray-500
                                      file:mr-4 file:py-2 file:px-4
                                      file:rounded-full file:border-0
                                      file:text-sm file:font-semibold
                                      file:bg-blue-50 file:text-blue-700
                                      hover:file:bg-blue-100">
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="repair_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="repair_notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Quote Options -->
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <button type="button" 
                                    onclick="requestQuote('repair')"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                Request Repair Quote
                            </button>
                            <button type="button" 
                                    onclick="requestQuote('disposal')"
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                                Request Disposal Quote
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Asset Checkout Fields -->
                <div id="assetCheckoutFields" class="hidden space-y-6">
                    <!-- Customer Selection -->
                    <div>
                        <label for="customer_id" class="block text-sm font-medium text-gray-700">Select Customer</label>
                        <select id="customer_id" 
                                name="customer_id"
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select a customer...</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}" 
                                    data-address="{{ customer.address }}"
                                    data-company="{{ customer.company.name if customer.company else '' }}">
                                {{ customer.name }} ({{ customer.company.name if customer.company else 'No Company' }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Hidden field for asset checkout serial number -->
                    <input type="hidden" id="asset_checkout_serial" name="asset_checkout_serial" value="">

                    <!-- Asset Selection -->
                    <div>
                        <label for="checkout_serial_number" class="block text-sm font-medium text-gray-700">Asset Selection</label>
                        <select id="checkout_serial_number" 
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select an asset...</option>
                            {% for asset in assets %}
                            <option value="{{ asset.serial_number }}" 
                                    data-model="{{ asset.model }}"
                                    data-asset-tag="{{ asset.asset_tag }}">
                                {{ asset.serial_number }} - {{ asset.model }} ({{ asset.asset_tag }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Shipping Address -->
                    <div>
                        <label for="shipping_address" class="block text-sm font-medium text-gray-700">Shipping Address</label>
                        <textarea id="shipping_address" 
                                  name="shipping_address" 
                                  rows="3"
                                  required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Tracking Number -->
                    <div>
                        <label for="shipping_tracking" class="block text-sm font-medium text-gray-700">
                            <span id="trackingLabel">Tracking Number</span>
                            <span id="singpostNote" class="text-sm text-gray-500 hidden">(Format: RR123456789SG)</span>
                        </label>
                        <input type="text" 
                               id="shipping_tracking" 
                               name="shipping_tracking" 
                               pattern="" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <p id="trackingHint" class="mt-1 text-sm text-gray-500 hidden">
                            Please enter a valid SingPost tracking number (e.g., RR123456789SG)
                        </p>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="checkout_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="checkout_notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                </div>

                <!-- Subject -->
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700">Subject</label>
                    <input type="text" 
                           id="subject" 
                           name="subject" 
                           value="{{ form.subject if form else '' }}"
                           required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- Priority -->
                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700">Priority</label>
                    <select id="priority" 
                            name="priority" 
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select priority...</option>
                        {% for priority in priorities %}
                        <option value="{{ priority.name }}" {% if form and form.priority == priority.name %}selected{% endif %}>{{ priority.value }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="description" 
                              name="description" 
                              rows="5"
                              required
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ form.description if form else '' }}</textarea>
                </div>

                <!-- Submit Button -->
                <div class="pt-4">
                    <button type="submit" 
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Create Ticket
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add jQuery and Select2 JS before the closing body tag -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
function toggleFormFields() {
    const category = document.getElementById('category').value;
    const pinRequestFields = document.getElementById('pinRequestFields');
    const repairFields = document.getElementById('repairFields');
    const assetCheckoutFields = document.getElementById('assetCheckoutFields');
    const trackingLabel = document.getElementById('trackingLabel');
    const singpostNote = document.getElementById('singpostNote');
    const trackingHint = document.getElementById('trackingHint');
    const trackingInput = document.getElementById('shipping_tracking');
    
    // Hide all category-specific fields first
    pinRequestFields.classList.add('hidden');
    repairFields.classList.add('hidden');
    assetCheckoutFields.classList.add('hidden');
    
    // Remove required attributes from all fields
    document.getElementById('serial_number').required = false;
    document.getElementById('lock_type').required = false;
    document.getElementById('repair_serial_number').required = false;
    document.getElementById('damage_description').required = false;
    document.getElementById('customer_id').required = false;
    document.getElementById('checkout_serial_number').required = false;
    document.getElementById('shipping_address').required = false;
    
    // Show and make required the appropriate fields
    if (category === 'PIN_REQUEST') {
        pinRequestFields.classList.remove('hidden');
        document.getElementById('serial_number').required = true;
        document.getElementById('lock_type').required = true;
    } else if (category === 'ASSET_REPAIR') {
        repairFields.classList.remove('hidden');
        document.getElementById('repair_serial_number').required = true;
        document.getElementById('damage_description').required = true;
    } else if (category === 'ASSET_CHECKOUT' || category === 'ASSET_CHECKOUT_SINGPOST') {
        assetCheckoutFields.classList.remove('hidden');
        document.getElementById('customer_id').required = true;
        document.getElementById('checkout_serial_number').required = true;
        document.getElementById('shipping_address').required = true;
        
        // Update tracking field based on category
        if (category === 'ASSET_CHECKOUT_SINGPOST') {
            trackingLabel.textContent = 'SingPost Tracking Number';
            singpostNote.classList.remove('hidden');
            trackingHint.classList.remove('hidden');
            trackingInput.pattern = '^[A-Z]{2}[0-9]{9}[A-Z]{2}$';
            trackingInput.required = true;
        } else {
            trackingLabel.textContent = 'Tracking Number';
            singpostNote.classList.add('hidden');
            trackingHint.classList.add('hidden');
            trackingInput.pattern = '';
            trackingInput.required = false;
        }
    }
}

function requestQuote(type) {
    const form = document.querySelector('form');
    const quoteTypeInput = document.createElement('input');
    quoteTypeInput.type = 'hidden';
    quoteTypeInput.name = 'quote_type';
    quoteTypeInput.value = type;
    form.appendChild(quoteTypeInput);
    form.submit();
}

// Initialize Select2 and form state
$(document).ready(function() {
    // Initialize Select2 for all asset selection dropdowns
    $('#serial_number, #repair_serial_number, #checkout_serial_number').select2({
        placeholder: 'Search by serial number, model, or asset tag...',
        allowClear: true,
        width: '100%'
    });

    // Initialize form state and show the correct category fields
    toggleFormFields();
    
    // If there's form data, trigger the asset selection change event
    if ($('#category').val()) {
        const category = $('#category').val();
        if (category === 'PIN_REQUEST' && $('#serial_number').val()) {
            $('#serial_number').trigger('change');
        } else if (category === 'ASSET_REPAIR' && $('#repair_serial_number').val()) {
            $('#repair_serial_number').trigger('change');
        } else if (category === 'ASSET_CHECKOUT' && $('#checkout_serial_number').val()) {
            $('#checkout_serial_number').trigger('change');
        }
    }

    // Handle asset selection changes
    $('#serial_number, #repair_serial_number, #checkout_serial_number').on('change', function() {
        const selectedOption = $(this).find(':selected');
        if (selectedOption.val()) {
            const model = selectedOption.data('model');
            const customer = selectedOption.data('customer');
            const assetTag = selectedOption.data('asset-tag');
            
            // Update the appropriate fields based on which dropdown changed
            if (this.id === 'serial_number') {
                $('#model').val(model);
                $('#customer_company').val(customer);
                if (!$('#subject').val()) {
                    $('#subject').val(`PIN Request - ${model} - ${selectedOption.val()}`);
                }
            } else if (this.id === 'repair_serial_number') {
                $('#repair_model').val(model);
                $('#repair_customer').val(customer);
                if (!$('#subject').val()) {
                    $('#subject').val(`Repair Request - ${model} - ${selectedOption.val()}`);
                }
            } else if (this.id === 'checkout_serial_number') {
                // Update the hidden field with the selected serial number
                $('#asset_checkout_serial').val(selectedOption.val());
                console.log('Updated asset_checkout_serial to:', selectedOption.val());
                
                if (!$('#subject').val()) {
                    $('#subject').val(`Asset Checkout - ${model} - ${selectedOption.val()}`);
                }
            }
        }
    });

    // Handle customer selection for asset checkout
    $('#customer_id').on('change', function() {
        const selectedOption = $(this).find(':selected');
        if (selectedOption.val()) {
            const address = selectedOption.data('address');
            if (address) {
                $('#shipping_address').val(address);
            }
        }
    });

    // Add form submission debugging
    $('form').on('submit', function(e) {
        const category = $('#category').val();
        if (category === 'ASSET_CHECKOUT') {
            const serialNumber = $('#checkout_serial_number').val();
            if (!serialNumber) {
                e.preventDefault();
                alert('Please select an asset');
                return false;
            }
            
            // Set the hidden field value again to ensure it's properly set
            $('#asset_checkout_serial').val(serialNumber);
            console.log('Form submitted with asset_checkout_serial:', $('#asset_checkout_serial').val());
        }
        
        console.log('Form submitted');
        console.log('Category:', $('#category').val());
        console.log('Customer ID:', $('#customer_id').val());
        console.log('Serial Number (checkout):', $('#checkout_serial_number').val());
        console.log('Hidden Serial Number:', $('#asset_checkout_serial').val());
        console.log('Shipping Address:', $('#shipping_address').val());
        console.log('Subject:', $('#subject').val());
        console.log('Priority:', $('#priority').val());
        return true;
    });
});
</script>
{% endblock %} 