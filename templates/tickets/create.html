{% extends "base.html" %}

{% block content %}
<!-- Add Select2 CSS in the head -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <div class="mb-6">
            <a href="{{ url_for('tickets.list_tickets') }}" 
               class="text-blue-600 hover:text-blue-800">
                ‚Üê Back to Tickets
            </a>
        </div>

        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h1 class="text-2xl font-bold">Create New Ticket</h1>
            </div>

            <form id="ticketForm" method="POST" enctype="multipart/form-data" class="px-6 py-4 space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- Category -->
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="category" 
                            name="category" 
                            required
                            onchange="toggleFormFields()"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select category...</option>
                        <option value="PIN_REQUEST" {% if form and form.category == 'PIN_REQUEST' %}selected{% endif %}>PIN Request</option>
                        <option value="ASSET_REPAIR" {% if form and form.category == 'ASSET_REPAIR' %}selected{% endif %}>Asset Repair</option>
                        <option value="BULK_DELIVERY_QUOTATION" {% if form and form.category == 'BULK_DELIVERY_QUOTATION' %}selected{% endif %}>Bulk Delivery Quotation</option>
                        <option value="REPAIR_QUOTE" {% if form and form.category == 'REPAIR_QUOTE' %}selected{% endif %}>Repair Quote</option>
                        <option value="ITAD_QUOTE" {% if form and form.category == 'ITAD_QUOTE' %}selected{% endif %}>ITAD Quote</option>
                        <option value="ASSET_CHECKOUT" {% if form and form.category == 'ASSET_CHECKOUT' %}selected{% endif %}>Asset Checkout (Standard)</option>
                        <option value="ASSET_CHECKOUT_SINGPOST" {% if form and form.category == 'ASSET_CHECKOUT_SINGPOST' %}selected{% endif %}>Asset Checkout (SingPost)</option>
                        <option value="ASSET_CHECKOUT_DHL" {% if form and form.category == 'ASSET_CHECKOUT_DHL' %}selected{% endif %}>Asset Checkout (DHL)</option>
                        <option value="ASSET_CHECKOUT_UPS" {% if form and form.category == 'ASSET_CHECKOUT_UPS' %}selected{% endif %}>Asset Checkout (UPS)</option>
                        <option value="ASSET_CHECKOUT_BLUEDART" {% if form and form.category == 'ASSET_CHECKOUT_BLUEDART' %}selected{% endif %}>Asset Checkout (BlueDart)</option>
                        <option value="ASSET_CHECKOUT_DTDC" {% if form and form.category == 'ASSET_CHECKOUT_DTDC' %}selected{% endif %}>Asset Checkout (DTDC)</option>
                        <option value="ASSET_CHECKOUT_AUTO" {% if form and form.category == 'ASSET_CHECKOUT_AUTO' %}selected{% endif %}>Asset Checkout (Auto)</option>
                        <option value="ASSET_CHECKOUT_CLAW" {% if form and form.category == 'ASSET_CHECKOUT_CLAW' %}selected{% endif %}>Asset Checkout (claw)</option>
                        <option value="ASSET_INTAKE" {% if form and form.category == 'ASSET_INTAKE' %}selected{% endif %}>Asset Intake</option>
                        <option value="ASSET_RETURN_CLAW" {% if form and form.category == 'ASSET_RETURN_CLAW' %}selected{% endif %}>Asset Return (claw)</option>
                    </select>
                </div>

                <!-- PIN Request Fields -->
                <div id="pinRequestFields" class="hidden space-y-6">
                    <!-- Country -->
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-700">Country</label>
                        <input type="text" 
                               id="country" 
                               name="country" 
                               value="{{ form.country if form else '' }}"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Serial Number Selection -->
                    <div>
                        <label for="serial_number" class="block text-sm font-medium text-gray-700">Asset Selection</label>
                        <select id="serial_number" 
                                name="serial_number"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select an asset...</option>
                            {% for asset in assets %}
                            <option value="{{ asset.serial_number }}" 
                                    data-model="{{ asset.model }}"
                                    data-customer="{{ asset.customer }}"
                                    data-asset-tag="{{ asset.asset_tag }}"
                                    {% if form and form.serial_number == asset.serial_number %}selected{% endif %}>
                                {{ asset.serial_number }} - {{ asset.model }} ({{ asset.asset_tag }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Auto-populated fields -->
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700">Model</label>
                        <input type="text" 
                               id="model" 
                               name="model" 
                               value="{{ form.model if form else '' }}"
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <div>
                        <label for="customer_company" class="block text-sm font-medium text-gray-700">Customer Company</label>
                        <input type="text" 
                               id="customer_company" 
                               name="customer_company" 
                               value="{{ form.customer_company if form else '' }}"
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <!-- Lock Type -->
                    <div>
                        <label for="lock_type" class="block text-sm font-medium text-gray-700">Lock Type</label>
                        <select id="lock_type" 
                                name="lock_type" 
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select lock type...</option>
                            <option value="ACTIVATION" {% if form and form.lock_type == 'ACTIVATION' %}selected{% endif %}>Activation Lock</option>
                            <option value="6_DIGIT" {% if form and form.lock_type == '6_DIGIT' %}selected{% endif %}>6 Digit Lock</option>
                            <option value="BIOS" {% if form and form.lock_type == 'BIOS' %}selected{% endif %}>BIOS Lock</option>
                            <option value="BITLOCKER" {% if form and form.lock_type == 'BITLOCKER' %}selected{% endif %}>Bitlocker</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ form.notes if form else '' }}</textarea>
                    </div>
                </div>

                <!-- Repair Fields -->
                <div id="repairFields" class="hidden space-y-6">
                    <!-- Country -->
                    <div>
                        <label for="repair_country" class="block text-sm font-medium text-gray-700">Country</label>
                        <input type="text" 
                               id="repair_country" 
                               name="country" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Serial Number Selection -->
                    <div>
                        <label for="repair_serial_number" class="block text-sm font-medium text-gray-700">Asset Selection</label>
                        <select id="repair_serial_number" 
                                name="serial_number"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select an asset...</option>
                            {% for asset in assets %}
                            <option value="{{ asset.serial_number }}" 
                                    data-model="{{ asset.model }}"
                                    data-customer="{{ asset.customer }}"
                                    data-asset-tag="{{ asset.asset_tag }}">
                                {{ asset.serial_number }} - {{ asset.model }} ({{ asset.asset_tag }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Auto-populated fields -->
                    <div>
                        <label for="repair_model" class="block text-sm font-medium text-gray-700">Model</label>
                        <input type="text" 
                               id="repair_model" 
                               name="model" 
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <div>
                        <label for="repair_customer" class="block text-sm font-medium text-gray-700">Customer Company</label>
                        <input type="text" 
                               id="repair_customer" 
                               name="customer_company" 
                               readonly
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                    </div>

                    <!-- Apple Diagnostics Code -->
                    <div>
                        <label for="apple_diagnostics" class="block text-sm font-medium text-gray-700">Apple Diagnostics Code (if applicable)</label>
                        <input type="text" 
                               id="apple_diagnostics" 
                               name="apple_diagnostics" 
                               placeholder="e.g., ADP000"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Damage Description -->
                    <div>
                        <label for="damage_description" class="block text-sm font-medium text-gray-700">Description of Damage</label>
                        <textarea id="damage_description" 
                                  name="damage_description" 
                                  rows="3"
                                  required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Image Upload -->
                    <div>
                        <label for="image" class="block text-sm font-medium text-gray-700">Upload Images</label>
                        <input type="file" 
                               id="image" 
                               name="image" 
                               accept="image/*"
                               multiple
                               class="mt-1 block w-full text-sm text-gray-500
                                      file:mr-4 file:py-2 file:px-4
                                      file:rounded-full file:border-0
                                      file:text-sm file:font-semibold
                                      file:bg-blue-50 file:text-blue-700
                                      hover:file:bg-blue-100">
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="repair_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="repair_notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Quote Options -->
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <button type="button" 
                                    onclick="requestQuote('repair')"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                Request Repair Quote
                            </button>
                            <button type="button" 
                                    onclick="requestQuote('disposal')"
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                                Request Disposal Quote
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Asset Checkout Fields -->
                <div id="assetCheckoutFields" class="hidden space-y-6">
                    <!-- Customer Selection -->
                    <div>
                        <label for="customer_id" class="block text-sm font-medium text-gray-700">Select Customer</label>
                        <div class="flex items-center space-x-2">
                            <select id="customer_id" 
                                    name="customer_id"
                                    required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select a customer...</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}" 
                                        data-address="{{ customer.address }}"
                                        data-company="{{ customer.company.name if customer.company else '' }}">
                                    {{ customer.name }} ({{ customer.company.name if customer.company else 'No Company' }})
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" 
                                    onclick="showCreateCustomerModal()"
                                    class="mt-1 flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Hidden field for asset checkout serial number -->
                    <input type="hidden" id="asset_checkout_serial" name="asset_checkout_serial" value="">
                    <!-- Hidden subject field -->
                    <input type="hidden" id="subject" name="subject" value="">

                    <!-- Asset Selection - Only shown for checkout categories -->
                    <div id="assetSelectionContainer">
                        <label for="checkout_serial_number" class="block text-sm font-medium text-gray-700">Asset Selection</label>
                        <select id="checkout_serial_number" 
                                name="checkout_serial_number"
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select an asset...</option>
                            {% for asset in assets %}
                            <option value="{{ asset.serial_number }}" 
                                    data-model="{{ asset.model }}"
                                    data-asset-tag="{{ asset.asset_tag }}">
                                {{ asset.serial_number }} - {{ asset.model }} ({{ asset.asset_tag }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Shipping Address -->
                    <div>
                        <label for="shipping_address" class="block text-sm font-medium text-gray-700">Shipping Address</label>
                        <textarea id="shipping_address" 
                                  name="shipping_address" 
                                  rows="3"
                                  required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Tracking Number - Removed as requested -->
                    <!-- Hidden field for shipping_tracking to ensure it's always empty at creation -->
                    <input type="hidden" id="shipping_tracking" name="shipping_tracking" value="">

                    <!-- Notes -->
                    <div>
                        <label for="checkout_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="checkout_notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                </div>

                <!-- Asset Intake Fields -->
                <div id="assetIntakeFields" class="hidden space-y-6">
                    <!-- Tech Asset Section -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-semibold">Tech Asset</h2>
                                <div class="space-x-2">
                                    <button type="button" 
                                            onclick="addNewTechAsset()"
                                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        Add New Tech Asset
                                    </button>
                                    <button type="button"
                                            onclick="importTechAsset()"
                                            class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        Import Tech Asset
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 space-y-6">
                            <!-- Asset Form -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="asset_tag" class="block text-sm font-medium text-gray-700">Asset Tag</label>
                                    <input type="text" 
                                           id="asset_tag" 
                                           name="asset_tag" 
                                           placeholder="Enter asset tag"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>

                                <div>
                                    <label for="serial_number" class="block text-sm font-medium text-gray-700">Serial Number</label>
                                    <input type="text" 
                                           id="serial_number" 
                                           name="serial_number" 
                                           placeholder="Enter serial number"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>

                                <div>
                                    <label for="asset_name" class="block text-sm font-medium text-gray-700">Name</label>
                                    <input type="text" 
                                           id="asset_name" 
                                           name="asset_name" 
                                           placeholder="Enter asset name"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>

                                <div>
                                    <label for="asset_status" class="block text-sm font-medium text-gray-700">Status</label>
                                    <select id="asset_status" 
                                            name="asset_status" 
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="Active" selected>Active</option>
                                        <option value="Inactive">Inactive</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Retired">Retired</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <button type="button"
                                        onclick="addAsset()"
                                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    Add Asset
                                </button>
                            </div>

                            <!-- Existing Assets Table -->
                            <div class="mt-6">
                                <h3 class="text-lg font-medium mb-4">Existing Assets</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Tag</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial Number</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="existingAssets" class="bg-white divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                                    No assets assigned to this case
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rest of the intake fields -->
                    <div>
                        <label for="intake_title" class="block text-sm font-medium text-gray-700">Title</label>
                        <div class="flex gap-2">
                            <input type="text" 
                                   id="intake_title" 
                                   name="title" 
                                   placeholder="e.g., New Laptop Batch - March 2024"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <button type="button" 
                                    onclick="generateTitle()"
                                    class="mt-1 px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                Auto
                            </button>
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="intake_description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="intake_description" 
                                  name="description" 
                                  rows="4"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- File Upload -->
                    <div>
                        <label for="intake_file" class="block text-sm font-medium text-gray-700">Upload Packing List</label>
                        <input type="file" 
                               id="intake_file" 
                               name="packing_list" 
                               accept=".xlsx,.xls,.csv,.pdf,.docx,.doc"
                               class="mt-1 block w-full text-sm text-gray-500
                                      file:mr-4 file:py-2 file:px-4
                                      file:rounded-full file:border-0
                                      file:text-sm file:font-semibold
                                      file:bg-blue-50 file:text-blue-700
                                      hover:file:bg-blue-100">
                    </div>
                    
                    <!-- Asset CSV Upload -->
                    <div>
                        <label for="asset_csv" class="block text-sm font-medium text-gray-700">Upload Asset List (CSV)</label>
                        <input type="file" 
                               id="asset_csv" 
                               name="asset_csv" 
                               accept=".csv"
                               class="mt-1 block w-full text-sm text-gray-500
                                      file:mr-4 file:py-2 file:px-4
                                      file:rounded-full file:border-0
                                      file:text-sm file:font-semibold
                                      file:bg-blue-50 file:text-blue-700
                                      hover:file:bg-blue-100">
                    </div>
                    
                    <!-- Notes -->
                    <div>
                        <label for="intake_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="intake_notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                  placeholder="Any additional information about this intake..."></textarea>
                    </div>
                </div>

                <!-- Asset Return Fields -->
                <div id="assetReturnFields" class="hidden space-y-6">
                    <!-- ALL hidden fields needed for backend compatibility -->
                    <input type="hidden" id="asset_return_serial" name="asset_checkout_serial" value="ASSET_RETURN_NO_ASSET">
                    <input type="hidden" id="return_subject" name="subject" value="">
                    <input type="hidden" id="asset_return_form_flag" name="is_asset_return" value="1">
                    <input type="hidden" id="novalidate_flag" name="novalidate" value="1">
                    
                    <!-- Customer Selection -->
                    <div>
                        <label for="return_customer_id" class="block text-sm font-medium text-gray-700">Select Customer</label>
                        <div class="flex items-center space-x-2">
                            <select id="return_customer_id" 
                                    name="customer_id"
                                    required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select a customer...</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}" 
                                        data-address="{{ customer.address }}"
                                        data-company="{{ customer.company.name if customer.company else '' }}">
                                    {{ customer.name }} ({{ customer.company.name if customer.company else 'No Company' }})
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" 
                                    onclick="showCreateCustomerModal()"
                                    class="mt-1 flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Return Description -->
                    <div>
                        <label for="return_description" class="block text-sm font-medium text-gray-700">Return Description</label>
                        <textarea id="return_description" 
                                  name="return_description" 
                                  rows="3"
                                  required
                                  placeholder="Please describe what assets are being returned and why"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Shipping Address -->
                    <div>
                        <label for="return_shipping_address" class="block text-sm font-medium text-gray-700">Return Address</label>
                        <textarea id="return_shipping_address" 
                                  name="shipping_address" 
                                  rows="3"
                                  required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Outbound Tracking Number - Hidden -->
                    <input type="hidden" id="outbound_tracking" name="shipping_tracking" value="">

                    <!-- Inbound Tracking Number - Hidden -->
                    <input type="hidden" id="inbound_tracking" name="return_tracking" value="">
                    
                    <!-- Queue Selection -->
                    <div>
                        <label for="queue_id" class="block text-sm font-medium text-gray-700">
                            Assign to Queue (Optional)
                        </label>
                        <select id="queue_id" 
                                name="queue_id" 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">-- Select Queue --</option>
                            {% for queue in queues %}
                            <option value="{{ queue.id }}">{{ queue.name }}</option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">
                            Select which support queue this return ticket should be assigned to.
                        </p>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="return_notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="return_notes" 
                                  name="notes" 
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Special Submit Button for Asset Return -->
                    <div class="pt-4">
                        <button type="button" 
                                id="asset_return_submit"
                                onclick="submitAssetReturnForm()"
                                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Create Asset Return Ticket
                        </button>
                    </div>
                </div>

                <!-- Priority -->
                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700">Priority</label>
                    <select id="priority" 
                            name="priority" 
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select priority...</option>
                        {% for priority in priorities %}
                        <option value="{{ priority.name }}" {% if form and form.priority == priority.name %}selected{% endif %}>{{ priority.value }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="description" 
                              name="description" 
                              rows="5"
                              required
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ form.description if form else '' }}</textarea>
                </div>

                <!-- Submit Button -->
                <div class="pt-4">
                    <button type="submit" 
                            id="mainSubmitButton"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Create Ticket
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Customer Modal -->
<div id="createCustomerModal" class="fixed inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Create New Customer
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                Please fill in the customer information. All fields marked with * are required.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="new_customer_name" class="block text-sm font-medium text-gray-700">Customer Name *</label>
                        <input type="text" id="new_customer_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="new_customer_contact" class="block text-sm font-medium text-gray-700">Contact Number *</label>
                        <input type="text" id="new_customer_contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="new_customer_email" class="block text-sm font-medium text-gray-700">Email (Optional)</label>
                        <input type="email" id="new_customer_email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="new_customer_address" class="block text-sm font-medium text-gray-700">Address *</label>
                        <textarea id="new_customer_address" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="new_customer_company" class="block text-sm font-medium text-gray-700">Company *</label>
                        <div class="flex items-center space-x-2">
                            <select id="new_customer_company" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select a company...</option>
                                {% for company in companies %}
                                <option value="{{ company }}">{{ company }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" id="new_company_name" placeholder="Or enter new company" class="mt-1 hidden w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <button type="button" id="toggleCompanyInput" class="mt-1 flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="new_customer_country" class="block text-sm font-medium text-gray-700">Country *</label>
                        <select id="new_customer_country" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            {% for country in Country %}
                            <option value="{{ country.name }}">{{ country.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="createCustomer()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Create
                </button>
                <button type="button" onclick="hideCreateCustomerModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add jQuery and Select2 JS before the closing body tag -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// Customer creation modal functions
function showCreateCustomerModal() {
    document.getElementById('createCustomerModal').classList.remove('hidden');
}

// Toggle between company dropdown and text input
document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('toggleCompanyInput');
    const companySelect = document.getElementById('new_customer_company');
    const companyInput = document.getElementById('new_company_name');
    
    toggleButton.addEventListener('click', function() {
        if (companySelect.classList.contains('hidden')) {
            // Switch to dropdown
            companySelect.classList.remove('hidden');
            companyInput.classList.add('hidden');
            toggleButton.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>';
        } else {
            // Switch to text input
            companySelect.classList.add('hidden');
            companyInput.classList.remove('hidden');
            toggleButton.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>';
        }
    });
});

function hideCreateCustomerModal() {
    document.getElementById('createCustomerModal').classList.add('hidden');
}

function createCustomer() {
    // Get form values
    const name = document.getElementById('new_customer_name').value;
    const contact_number = document.getElementById('new_customer_contact').value;
    const email = document.getElementById('new_customer_email').value;
    const address = document.getElementById('new_customer_address').value;
    
    // Get company from either the dropdown or text input
    let company;
    const companySelect = document.getElementById('new_customer_company');
    const companyInput = document.getElementById('new_company_name');
    
    if (companySelect.classList.contains('hidden')) {
        // Use text input
        company = companyInput.value;
    } else {
        // Use dropdown
        company = companySelect.value;
    }
    
    const country = document.getElementById('new_customer_country').value;
    
    // Store current category selection
    const currentCategory = document.getElementById('category').value;
    const isAssetReturnClaw = currentCategory === 'ASSET_RETURN_CLAW';
    
    // Validate required fields
    if (!name || !contact_number || !address || !company || !country) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    // Create form data
    const formData = new FormData();
    formData.append('name', name);
    formData.append('contact_number', contact_number);
    formData.append('email', email); // Email is optional for ASSET_RETURN_CLAW
    formData.append('address', address);
    formData.append('company', company);
    formData.append('country', country);
    formData.append('csrf_token', csrfToken);
    
    // Show loading state
    const createButton = document.querySelector('#createCustomerModal button[onclick="createCustomer()"]');
    const originalButtonText = createButton.innerHTML;
    createButton.disabled = true;
    createButton.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Creating...';
    
    // Send AJAX request
    fetch('/inventory/customer-users/add', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            // Get error details if available
            return response.text().then(text => {
                throw new Error(`Error ${response.status}: ${text || response.statusText}`);
            });
        }
        return response.text();
    })
    .then(data => {
        // Successfully created customer
        alert('Customer created successfully!');
        
        // Save category to session storage before reload
        if (currentCategory) {
            sessionStorage.setItem('selectedCategory', currentCategory);
        }
        
        window.location.reload();
    })
    .catch(error => {
        console.error('Error creating customer:', error);
        alert('Error creating customer: ' + error.message);
    })
    .finally(() => {
        // Reset button state
        createButton.disabled = false;
        createButton.innerHTML = originalButtonText;
    });
}

function toggleFormFields() {
    const category = document.getElementById('category').value;
    const pinRequestFields = document.getElementById('pinRequestFields');
    const repairFields = document.getElementById('repairFields');
    const assetCheckoutFields = document.getElementById('assetCheckoutFields');
    const assetIntakeFields = document.getElementById('assetIntakeFields');
    const assetReturnFields = document.getElementById('assetReturnFields');
    const trackingLabel = document.getElementById('trackingLabel');
    const singpostNote = document.getElementById('singpostNote');
    const trackingHint = document.getElementById('trackingHint');
    const trackingInput = document.getElementById('shipping_tracking');
    const intakeTitle = document.getElementById('intake_title');
    const intakeDescription = document.getElementById('intake_description');
    const assetSelectionContainer = document.getElementById('assetSelectionContainer');
    const mainSubmitButton = document.querySelector('button[type="submit"]');
    
    // Hide all category-specific fields first
    pinRequestFields.classList.add('hidden');
    repairFields.classList.add('hidden');
    assetCheckoutFields.classList.add('hidden');
    assetIntakeFields.classList.add('hidden');
    assetReturnFields.classList.add('hidden');
    
    // Show/hide submit buttons based on category
    if (category === 'ASSET_RETURN_CLAW') {
        // Hide main submit button
        if (mainSubmitButton) {
            mainSubmitButton.classList.add('hidden');
        }
    } else {
        // Show main submit button for other categories
        if (mainSubmitButton) {
            mainSubmitButton.classList.remove('hidden');
        }
    }
    
    // Remove required attributes from all fields
    document.getElementById('serial_number').required = false;
    document.getElementById('lock_type').required = false;
    document.getElementById('repair_serial_number').required = false;
    document.getElementById('damage_description').required = false;
    document.getElementById('customer_id').required = false;
    document.getElementById('checkout_serial_number').required = false;
    document.getElementById('shipping_address').required = false;
    document.getElementById('return_customer_id').required = false;
    document.getElementById('return_description').required = false;
    document.getElementById('return_shipping_address').required = false;
    document.getElementById('outbound_tracking').required = false;
    if (intakeTitle) intakeTitle.required = false;
    if (intakeDescription) intakeDescription.required = false;
    
    // Handle ASSET_RETURN_CLAW as a separate category first
    if (category === 'ASSET_RETURN_CLAW') {
        // Show ONLY the asset return fields
        assetReturnFields.classList.remove('hidden');
        
        // Make required fields for asset return
        document.getElementById('return_customer_id').required = true;
        document.getElementById('return_description').required = true;
        document.getElementById('return_shipping_address').required = true;
        document.getElementById('outbound_tracking').required = false;
        
        // Set a dummy value in asset_checkout_serial for form validation
        document.getElementById('asset_checkout_serial').value = 'ASSET_RETURN_NO_ASSET';
        console.log('Set dummy value in asset_checkout_serial for Asset Return');
        
        return; // Exit early to avoid running the asset checkout logic
    }
    
    // Show and make required the appropriate fields for other categories
    if (category === 'PIN_REQUEST') {
        pinRequestFields.classList.remove('hidden');
        document.getElementById('serial_number').required = true;
        document.getElementById('lock_type').required = true;
    } else if (category === 'ASSET_REPAIR') {
        repairFields.classList.remove('hidden');
        document.getElementById('repair_serial_number').required = true;
        document.getElementById('damage_description').required = true;
    } else if (category === 'ASSET_CHECKOUT' || category === 'ASSET_CHECKOUT_SINGPOST' || category === 'ASSET_CHECKOUT_DHL' || category === 'ASSET_CHECKOUT_UPS' || category === 'ASSET_CHECKOUT_BLUEDART' || category === 'ASSET_CHECKOUT_DTDC' || category === 'ASSET_CHECKOUT_AUTO' || category === 'ASSET_CHECKOUT_CLAW') {
        assetCheckoutFields.classList.remove('hidden');
        document.getElementById('customer_id').required = true;
        document.getElementById('checkout_serial_number').required = true;
        document.getElementById('shipping_address').required = true;
        
        // Show asset selection for checkout categories
        if (assetSelectionContainer) {
            assetSelectionContainer.classList.remove('hidden');
        }
        
        // For BlueDart, ensure the selected serial number is copied to the hidden field
        if (category === 'ASSET_CHECKOUT_BLUEDART' || category === 'ASSET_CHECKOUT_DTDC') {
            // Get the current value from checkout_serial_number
            const serialValue = document.getElementById('checkout_serial_number').value;
            if (serialValue) {
                // Set the hidden field
                document.getElementById('asset_checkout_serial').value = serialValue;
                console.log('BlueDart/DTDC: Set asset_checkout_serial to:', serialValue);
            }
        }
        
        // Update tracking field based on category
        if (category === 'ASSET_CHECKOUT_SINGPOST') {
            trackingLabel.textContent = 'SingPost Tracking Number';
            singpostNote.classList.remove('hidden');
            trackingHint.classList.remove('hidden');
            trackingInput.pattern = '^(XZD|XZB)[0-9]+$';
            trackingInput.required = true;
        } else if (category === 'ASSET_CHECKOUT_DHL') {
            trackingLabel.textContent = 'DHL Tracking Number';
            singpostNote.classList.add('hidden');
            trackingHint.classList.add('hidden');
            trackingInput.pattern = null;
            trackingInput.removeAttribute('pattern');
            trackingInput.required = true;
        } else if (category === 'ASSET_CHECKOUT_UPS') {
            trackingLabel.textContent = 'UPS Tracking Number';
            singpostNote.classList.add('hidden');
            trackingHint.classList.add('hidden');
            trackingInput.pattern = null;
            trackingInput.removeAttribute('pattern');
            trackingInput.required = true;
        } else if (category === 'ASSET_CHECKOUT_BLUEDART') {
            trackingLabel.textContent = 'BlueDart Tracking Number';
            singpostNote.classList.add('hidden');
            trackingHint.classList.add('hidden');
            trackingInput.pattern = null;
            trackingInput.removeAttribute('pattern');
            trackingInput.required = true;
        } else if (category === 'ASSET_CHECKOUT_DTDC') {
            trackingLabel.textContent = 'DTDC Tracking Number';
            singpostNote.classList.add('hidden');
            trackingHint.classList.add('hidden');
            trackingInput.pattern = null;
            trackingInput.removeAttribute('pattern');
            trackingInput.required = true;
        } else if (category === 'ASSET_CHECKOUT_AUTO' || category === 'ASSET_CHECKOUT_CLAW') {
            trackingLabel.textContent = 'Tracking Number (Any Carrier)';
            singpostNote.classList.add('hidden');
            trackingHint.classList.add('hidden');
            trackingInput.pattern = null;
            trackingInput.removeAttribute('pattern');
            trackingInput.required = false;
        } else {
            trackingLabel.textContent = 'Tracking Number';
            singpostNote.classList.add('hidden');
            trackingHint.classList.add('hidden');
            trackingInput.pattern = '';
            trackingInput.required = false;
        }
    } else if (category === 'ASSET_INTAKE') {
        assetIntakeFields.classList.remove('hidden');
        if (intakeTitle) intakeTitle.required = true;
        if (intakeDescription) intakeDescription.required = true;
    }
}

function requestQuote(type) {
    const form = document.querySelector('form');
    const quoteTypeInput = document.createElement('input');
    quoteTypeInput.type = 'hidden';
    quoteTypeInput.name = 'quote_type';
    quoteTypeInput.value = type;
    form.appendChild(quoteTypeInput);
    form.submit();
}

function generateTitle() {
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    const title = `Asset Intake - ${dateStr}`;
    document.getElementById('intake_title').value = title;
}

function updateSubject() {
    const ticketType = document.getElementById('ticket_type').value;
    const subjectField = document.getElementById('subject');
    const intakeTitleField = document.getElementById('intake_title');
    
    if (ticketType === 'asset_intake') {
        // For Asset Intake, use the title field as subject
        if (intakeTitleField) {
            subjectField.value = intakeTitleField.value;
        }
    } else {
        // For other ticket types, generate subject based on selected asset
        const assetSelect = document.getElementById('asset_id');
        if (assetSelect && assetSelect.value) {
            const selectedOption = assetSelect.options[assetSelect.selectedIndex];
            const model = selectedOption.getAttribute('data-model');
            const serialNumber = selectedOption.getAttribute('data-serial');
            
            let prefix = '';
            switch(ticketType) {
                case 'pin_request':
                    prefix = 'PIN Request';
                    break;
                case 'repair_request':
                    prefix = 'Repair Request';
                    break;
                case 'asset_checkout':
                    prefix = 'Asset Checkout';
                    break;
            }
            
            subjectField.value = `${prefix} - ${model} - ${serialNumber}`;
        } else {
            subjectField.value = '';
        }
    }
}

// Initialize Select2 and form state
$(document).ready(function() {
    
    // Check for saved category selection from customer creation
    const savedCategory = sessionStorage.getItem('selectedCategory');
    if (savedCategory) {
        // Set the category dropdown to saved value
        $('#category').val(savedCategory);
        console.log('Restored saved category:', savedCategory);
        // Clear the saved value to avoid unintended restoration on future visits
        sessionStorage.removeItem('selectedCategory');
    }

    // Initialize Select2 for all asset selection dropdowns
    $('#serial_number, #repair_serial_number, #checkout_serial_number').select2({
        placeholder: 'Search by serial number, model, or asset tag...',
        allowClear: true,
        width: '100%'
    });

    // Initialize form state and show the correct category fields
    toggleFormFields();
    
    // Run toggleFormFields initially to hide/show appropriate buttons
    const initialCategory = $('#category').val();
    if (initialCategory === 'ASSET_RETURN_CLAW') {
        // Make sure we handle asset return category correctly on page load
        $('#mainSubmitButton').addClass('hidden');
    }
    
    // Add category change event handler
    $('#category').on('change', function() {
        const category = $(this).val();
        console.log('Category changed to:', category);
        
        // If BlueDart is selected, ensure we handle it correctly
        if (category === 'ASSET_CHECKOUT_BLUEDART' || category === 'ASSET_CHECKOUT_DTDC') {
            // If a serial number is already selected, make sure hidden field is populated
            const serial = $('#checkout_serial_number').val();
            if (serial) {
                $('#asset_checkout_serial').val(serial);
                console.log('Category change to BlueDart/DTDC: Set asset_checkout_serial to:', serial);
            }
        }
        
        // Toggle fields based on category
        toggleFormFields();
    });
    
    // If there's form data, trigger the asset selection change event
    if ($('#category').val()) {
        const category = $('#category').val();
        if (category === 'PIN_REQUEST' && $('#serial_number').val()) {
            $('#serial_number').trigger('change');
        } else if (category === 'ASSET_REPAIR' && $('#repair_serial_number').val()) {
            $('#repair_serial_number').trigger('change');
        } else if ((category === 'ASSET_CHECKOUT' || category === 'ASSET_CHECKOUT_SINGPOST' || category === 'ASSET_CHECKOUT_DHL' || category === 'ASSET_CHECKOUT_UPS' || category === 'ASSET_CHECKOUT_BLUEDART' || category === 'ASSET_CHECKOUT_DTDC' || category === 'ASSET_CHECKOUT_AUTO' || category === 'ASSET_CHECKOUT_CLAW') && $('#checkout_serial_number').val()) {
            $('#checkout_serial_number').trigger('change');
            
            // Special handling for DHL tracking
            if (category === 'ASSET_CHECKOUT_DHL') {
                $('#shipping_tracking').removeAttr('pattern');
            }
            
            // Special handling for BlueDart tracking
            if (category === 'ASSET_CHECKOUT_BLUEDART' || category === 'ASSET_CHECKOUT_DTDC') {
                $('#shipping_tracking').removeAttr('pattern');
                // Make sure hidden field is populated
                const serial = $('#checkout_serial_number').val();
                if (serial) {
                    $('#asset_checkout_serial').val(serial);
                    console.log('BlueDart/DTDC initialization: Set asset_checkout_serial to:', serial);
                }
            }
            
            // Special handling for UPS tracking
            if (category === 'ASSET_CHECKOUT_UPS') {
                $('#shipping_tracking').removeAttr('pattern');
            }
        }
    }

    // Handle asset selection changes
    $('#serial_number, #repair_serial_number, #checkout_serial_number').on('change', function() {
        const selectedOption = $(this).find(':selected');
        const selectedValue = selectedOption.val();
        console.log(`Asset selected (change event - ${this.id}). Value:`, selectedValue);

        if (selectedOption.val()) {
            const model = selectedOption.data('model');
            const customer = selectedOption.data('customer');
            const assetTag = selectedOption.data('asset-tag');
            
            // Update the appropriate fields based on which dropdown changed
            if (this.id === 'serial_number') {
                $('#model').val(model);
                $('#customer_company').val(customer);
                if (!$('#subject').val()) {
                    $('#subject').val(`PIN Request - ${model} - ${selectedOption.val()}`);
                }
            } else if (this.id === 'repair_serial_number') {
                $('#repair_model').val(model);
                $('#repair_customer').val(customer);
                if (!$('#subject').val()) {
                    $('#subject').val(`Repair Request - ${model} - ${selectedOption.val()}`);
                }
            } else if (this.id === 'checkout_serial_number') {
                // Update the hidden field with the selected serial number
                $('#asset_checkout_serial').val(selectedOption.val());
                console.log('Updated #asset_checkout_serial hidden field to:', $('#asset_checkout_serial').val());
                
                // Set the subject for the ticket
                const ticketSubject = `Asset Checkout - ${model} (${assetTag}) - ${selectedOption.val()}`;
                $('#subject').val(ticketSubject);
                console.log('Updated subject to:', ticketSubject);
            }
        } else {
            // Clear hidden field if no asset is selected
            if (this.id === 'checkout_serial_number') {
                $('#asset_checkout_serial').val('');
                console.log('Cleared #asset_checkout_serial hidden field.');
            }
        }
    });

    // Handle customer selection for asset checkout
    $('#customer_id').on('change', function() {
        const selectedOption = $(this).find(':selected');
        if (selectedOption.val()) {
            const address = selectedOption.data('address');
            if (address) {
                $('#shipping_address').val(address);
            }
        }
    });

    // Handle customer selection for asset return
    $('#return_customer_id').on('change', function() {
        const selectedOption = $(this).find(':selected');
        if (selectedOption.val()) {
            const address = selectedOption.data('address');
            if (address) {
                $('#return_shipping_address').val(address);
            }
            
            // Set the subject for asset return tickets
            const customerName = selectedOption.text();
            $('#return_subject').val(`Asset Return (claw) - ${customerName}`);
        }
    });

    // Add form submit handler
    $('#ticketForm').on('submit', function(e) {
        const category = $('#category').val();
        console.log(`Form submit event triggered for category: ${category}`);
        
        // For ASSET_RETURN_CLAW, validate outbound tracking number is provided
        if (category === 'ASSET_RETURN_CLAW') {
            console.log('Validating ASSET_RETURN_CLAW category...');
            // Validate customer selection
            const customerId = $('#return_customer_id').val();
            if (!customerId) {
                console.log('Submit validation failed: Customer not selected. Preventing submission.');
                e.preventDefault();
                alert('Please select a customer');
                return false;
            }
            
            // Validate description
            const description = $('#return_description').val();
            if (!description) {
                console.log('Submit validation failed: Description not provided. Preventing submission.');
                e.preventDefault();
                alert('Please provide a return description');
                return false;
            }
            
            // Validate shipping address
            const shippingAddress = $('#return_shipping_address').val();
            if (!shippingAddress) {
                console.log('Submit validation failed: Shipping address not provided. Preventing submission.');
                e.preventDefault();
                alert('Please provide a shipping address');
                return false;
            }
            
            // Tracking validation is now optional
            // No check for outbound tracking - it's now optional
            
            // Set a default subject if not provided
            if (!$('#subject').val()) {
                const customer = $('#return_customer_id option:selected').text();
                $('#subject').val(`Asset Return (claw) - ${customer}`);
            }
            
            // Explicitly bypass any asset validation for return tickets by setting a dummy value
            $('#asset_checkout_serial').val('ASSET_RETURN_NO_ASSET');
            
            console.log('Submit validation passed for Asset Return. Submitting form...');
            return true; // Allow the form to submit
        }
        
        // Only validate asset selection for specific checkout categories
        else if (category === 'ASSET_CHECKOUT' || category === 'ASSET_CHECKOUT_SINGPOST' || category === 'ASSET_CHECKOUT_DHL' || category === 'ASSET_CHECKOUT_UPS' || category === 'ASSET_CHECKOUT_BLUEDART' || category === 'ASSET_CHECKOUT_DTDC' || category === 'ASSET_CHECKOUT_AUTO' || category === 'ASSET_CHECKOUT_CLAW') {
            console.log('Validating ASSET_CHECKOUT_* category...');
            // Use the hidden field which is reliably updated by the change handler
            const serialNumber = $('#asset_checkout_serial').val();
            console.log('Submit validation: Checking #asset_checkout_serial. Value:', serialNumber);

            if (!serialNumber) {
                console.log('Submit validation failed: #asset_checkout_serial is empty. Preventing submission.');
                e.preventDefault();
                alert('Please select an asset');
                return false;
            }
            
            console.log('Submit validation passed for asset selection.');

            // Ensure no tracking format validation for any carrier
            $('#shipping_tracking').removeAttr('pattern');
            
            console.log('Form submitted with asset_checkout_serial:', $('#asset_checkout_serial').val());
        } else if (category === 'PIN_REQUEST') {
             console.log('Validating PIN_REQUEST category...');
            const serialNumber = $('#serial_number').val();
            if (!serialNumber) {
                 console.log('Submit validation failed: #serial_number is empty. Preventing submission.');
                e.preventDefault();
                alert('Please select an asset');
                return false;
            }
        } else if (category === 'ASSET_REPAIR') {
             console.log('Validating ASSET_REPAIR category...');
            const serialNumber = $('#repair_serial_number').val();
            if (!serialNumber) {
                 console.log('Submit validation failed: #repair_serial_number is empty. Preventing submission.');
                e.preventDefault();
                alert('Please select an asset');
                return false;
            }
        }
        
        console.log('Form validation completed. Allowing submission.');
        // ... rest of submit logic ...
        return true;
    });

    // Add event listener for intake title changes
    document.addEventListener('DOMContentLoaded', function() {
        const intakeTitleField = document.getElementById('intake_title');
        if (intakeTitleField) {
            intakeTitleField.addEventListener('input', function() {
                const subjectField = document.getElementById('subject');
                if (subjectField) {
                    subjectField.value = this.value;
                }
            });
        }
    });
});

// Tech Asset Functions
function addNewTechAsset() {
    // Implementation for adding new tech asset
    console.log('Add new tech asset clicked');
}

function importTechAsset() {
    // Implementation for importing tech asset
    console.log('Import tech asset clicked');
}

function addAsset() {
    const assetTag = document.getElementById('asset_tag').value;
    const serialNumber = document.getElementById('serial_number').value;
    const assetName = document.getElementById('asset_name').value;
    const status = document.getElementById('asset_status').value;

    if (!assetTag || !serialNumber || !assetName) {
        alert('Please fill in all required fields');
        return;
    }

    const existingAssets = document.getElementById('existingAssets');
    
    // Clear "No assets" message if it exists
    if (existingAssets.innerHTML.includes('No assets assigned')) {
        existingAssets.innerHTML = '';
    }

    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${assetTag}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${serialNumber}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assetName}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                ${status}
            </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            <button onclick="removeAsset(this)" class="text-red-600 hover:text-red-900">Remove</button>
        </td>
    `;
    existingAssets.appendChild(newRow);

    // Clear form
    document.getElementById('asset_tag').value = '';
    document.getElementById('serial_number').value = '';
    document.getElementById('asset_name').value = '';
    document.getElementById('asset_status').value = 'Active';
}

function removeAsset(button) {
    const row = button.closest('tr');
    row.remove();

    const existingAssets = document.getElementById('existingAssets');
    if (existingAssets.children.length === 0) {
        existingAssets.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                    No assets assigned to this case
                </td>
            </tr>
        `;
    }
}

// Function to submit the Asset Return form bypassing normal validation
function submitAssetReturnForm() {
    console.log('Custom Asset Return submit function called');
    
    // Validate required fields for asset return
    if (!$('#return_customer_id').val()) {
        alert('Please select a customer');
        return false;
    }
    
    if (!$('#return_description').val()) {
        alert('Please provide a return description');
        return false;
    }
    
    if (!$('#return_shipping_address').val()) {
        alert('Please provide a return address');
        return false;
    }
    
    // Set the subject for the ticket
    const customer = $('#return_customer_id option:selected').text();
    $('#return_subject').val(`Asset Return (claw) - ${customer}`);
    
    // Ensure the dummy value is set for the asset checkout serial
    $('#asset_return_serial').val('ASSET_RETURN_NO_ASSET');
    
    console.log('Asset Return validation passed. Creating form submission...');
    
    // Create a temporary form to submit data
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = window.location.href;
    form.style.display = 'none';
    
    // Add CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    // Add category
    const categoryInput = document.createElement('input');
    categoryInput.type = 'hidden';
    categoryInput.name = 'category';
    categoryInput.value = 'ASSET_RETURN_CLAW';
    form.appendChild(categoryInput);
    
    // Add priority
    const priorityInput = document.createElement('input');
    priorityInput.type = 'hidden';
    priorityInput.name = 'priority';
    priorityInput.value = $('#priority').val();
    form.appendChild(priorityInput);
    
    // Add customer ID
    const customerInput = document.createElement('input');
    customerInput.type = 'hidden';
    customerInput.name = 'customer_id';
    customerInput.value = $('#return_customer_id').val();
    form.appendChild(customerInput);
    
    // Add return description (as the main description)
    const descriptionInput = document.createElement('input');
    descriptionInput.type = 'hidden';
    descriptionInput.name = 'description';
    descriptionInput.value = $('#return_description').val();
    form.appendChild(descriptionInput);
    
    // Add shipping address
    const addressInput = document.createElement('input');
    addressInput.type = 'hidden';
    addressInput.name = 'shipping_address';
    addressInput.value = $('#return_shipping_address').val();
    form.appendChild(addressInput);
    
    // Add outbound tracking
    const trackingInput = document.createElement('input');
    trackingInput.type = 'hidden';
    trackingInput.name = 'shipping_tracking';
    trackingInput.value = $('#outbound_tracking').val();
    form.appendChild(trackingInput);
    
    // Add inbound tracking if provided
    if ($('#inbound_tracking').val()) {
        const inboundInput = document.createElement('input');
        inboundInput.type = 'hidden';
        inboundInput.name = 'return_tracking';
        inboundInput.value = $('#inbound_tracking').val();
        form.appendChild(inboundInput);
    }
    
    // Add queue_id if selected
    if ($('#queue_id').val()) {
        const queueInput = document.createElement('input');
        queueInput.type = 'hidden';
        queueInput.name = 'queue_id';
        queueInput.value = $('#queue_id').val();
        form.appendChild(queueInput);
    }
    
    // Add notes if provided
    if ($('#return_notes').val()) {
        const notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'notes';
        notesInput.value = $('#return_notes').val();
        form.appendChild(notesInput);
    }
    
    // Add subject
    const subjectInput = document.createElement('input');
    subjectInput.type = 'hidden';
    subjectInput.name = 'subject';
    subjectInput.value = `Asset Return (claw) - ${$('#return_customer_id option:selected').text()}`;
    form.appendChild(subjectInput);
    
    // Add dummy asset checkout serial
    const serialInput = document.createElement('input');
    serialInput.type = 'hidden';
    serialInput.name = 'asset_checkout_serial';
    serialInput.value = 'ASSET_RETURN_NO_ASSET';
    form.appendChild(serialInput);
    
    // Add the form to the document and submit it
    document.body.appendChild(form);
    console.log('Submitting custom form for Asset Return...');
    form.submit();
    
    return true;
}
</script>
{% endblock %} 