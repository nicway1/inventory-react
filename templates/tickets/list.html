{% extends "base.html" %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<script src="{{ url_for('static', filename='js/tab-system.js') }}"></script>
<style>
    /* Enhanced Salesforce-style UI styling */
    body {
        background: #f4f6f9;
        font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    .sf-container {
        background: #f4f6f9;
        min-height: 100vh;
        padding: 1.5rem;
    }

    .sf-page-header {
        background: white;
        border-radius: 0.375rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
    }

    .sf-page-title {
        font-size: 1.875rem;
        font-weight: 600;
        color: #181818;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .sf-page-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .sf-card {
        background: white;
        border-radius: 0.375rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .sf-card-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        background: #fafbfc;
    }

    .sf-card-body {
        padding: 0;
    }

    .sf-button {
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        background: #f3f3f3;
        border: 1px solid #c9c9c9;
        border-radius: 0.25rem;
        color: #444444;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.15s ease;
        text-decoration: none;
        cursor: pointer;
        line-height: 1;
    }

    .sf-button:hover {
        background: #e8e8e8;
        border-color: #b5b5b5;
        text-decoration: none;
        color: #444444;
    }

    .sf-toolbar {
        background-color: #e6eef8;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        gap: 0.5rem;
    }

    .sf-tabs {
        display: flex;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        overflow-x: auto;
        margin: 0;
        padding: 0 1.5rem;
    }

    .sf-tab {
        padding: 1rem 1.5rem;
        color: #706e6b;
        font-size: 0.875rem;
        font-weight: 400;
        border-bottom: 3px solid transparent;
        white-space: nowrap;
        transition: all 0.15s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        position: relative;
        cursor: pointer;
    }

    .sf-tab:hover {
        color: #0176d3;
        text-decoration: none;
        background: #fafaf9;
    }

    .sf-tab.active {
        color: #0176d3;
        border-bottom-color: #0176d3;
        font-weight: 600;
        background: white;
    }

    .sf-tab.active::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: #0176d3;
    }

    .sf-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        background-color: #f3f4f6;
        color: #4b5563;
    }

    .sf-badge-success {
        background-color: #10b981;
        color: white;
    }

    .sf-badge-warning {
        background-color: #f59e0b;
        color: white;
    }

    .sf-badge-info {
        background-color: #3b82f6;
        color: white;
    }

    .sf-badge-danger {
        background-color: #ef4444;
        color: white;
    }

    .sf-data-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .sf-data-table th {
        background: #fafbfc;
        text-align: left;
        padding: 0.75rem 1rem;
        font-size: 0.75rem;
        font-weight: 700;
        color: #444444;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .sf-data-table th:hover {
        background: #f4f6f9;
    }

    .sf-data-table th:first-child {
        padding-left: 1.5rem;
    }

    .sf-data-table th:last-child {
        padding-right: 1.5rem;
    }

    .sf-data-table td {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.875rem;
        color: #181818;
        vertical-align: middle;
    }

    .sf-data-table td:first-child {
        padding-left: 1.5rem;
    }

    .sf-data-table td:last-child {
        padding-right: 1.5rem;
    }

    .sf-data-table tr:hover {
        background: #fafbfc;
    }

    .sf-data-table tbody tr {
        transition: background-color 0.15s ease;
    }

    .primary-button {
        background: #0176d3;
        color: white;
        border-color: #0176d3;
    }

    .primary-button:hover {
        background: #014486;
        border-color: #014486;
        color: white;
    }

    .danger-button {
        background: #ea001e;
        color: white;
        border-color: #ea001e;
    }

    .danger-button:hover {
        background: #ba0517;
        border-color: #ba0517;
        color: white;
    }

    .success-button {
        background: #4bca81;
        color: white;
        border-color: #4bca81;
    }

    .success-button:hover {
        background: #2e844a;
        border-color: #2e844a;
        color: white;
    }
    .secondary-button {
        background: #6b7280;
        color: white;
        border-color: #6b7280;
    }
    .secondary-button:hover {
        background: #4b5563;
        border-color: #4b5563;
        color: white;
    }

    .sf-search {
        display: flex;
        align-items: center;
        background: white;
        border: 1px solid #c9c9c9;
        border-radius: 0.25rem;
        padding: 0.5rem 0.75rem;
        min-width: 20rem;
        transition: border-color 0.15s ease;
    }

    .sf-search:focus-within {
        border-color: #0176d3;
        box-shadow: 0 0 0 2px rgba(1, 118, 211, 0.1);
    }

    .sf-search input {
        border: none;
        outline: none;
        width: 100%;
        font-size: 0.875rem;
        padding: 0.25rem;
        color: #181818;
    }

    .sf-search input::placeholder {
        color: #706e6b;
    }

    .sf-search-icon {
        color: #706e6b;
        width: 1.125rem;
        height: 1.125rem;
        margin-right: 0.5rem;
    }

    .sf-filter-section {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        padding: 1rem 1.5rem;
        background: white;
        border-bottom: 1px solid #e5e7eb;
    }

    .sf-filter-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #444444;
        margin-right: 0.5rem;
    }

    .sf-filter-select {
        font-size: 0.875rem;
        padding: 0.5rem 2rem 0.5rem 0.75rem;
        border: 1px solid #c9c9c9;
        border-radius: 0.25rem;
        background: white url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e") no-repeat right 0.5rem center/1.5em 1.5em;
        color: #181818;
        cursor: pointer;
        min-width: 8rem;
        transition: border-color 0.15s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    .sf-filter-select:focus {
        border-color: #0176d3;
        box-shadow: 0 0 0 2px rgba(1, 118, 211, 0.1);
        outline: none;
    }

    .sf-filter-select {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        background-color: white;
        color: #1f2937;
    }

    .sf-action-menu {
        position: relative;
    }

    .sf-action-button {
        background: none;
        border: none;
        cursor: pointer;
        color: #6b7280;
    }

    .sf-action-dropdown {
        position: absolute;
        right: 0;
        top: 100%;
        background-color: white;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        z-index: 10;
        display: none;
    }

    .sf-action-dropdown.show {
        display: block;
    }

    .sf-action-item {
        display: block;
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        color: #374151;
        white-space: nowrap;
    }

    .sf-action-item:hover {
        background-color: #f3f4f6;
    }

    .sf-page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .sf-page-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
    }

    .sf-page-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* Pagination */
    .sf-pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background-color: #f9fafb;
        border-top: 1px solid #e5e7eb;
    }

    .sf-pagination-info {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .sf-pagination-controls {
        display: flex;
        gap: 0.25rem;
    }

    .sf-pagination-button {
        padding: 0.25rem 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        background-color: white;
        font-size: 0.75rem;
        color: #374151;
    }

    .sf-pagination-button:hover:not(.disabled) {
        background-color: #f3f4f6;
    }

    .sf-pagination-button.active {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .sf-pagination-button.disabled {
        color: #d1d5db;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="sf-container">
    <div class="max-w-7xl mx-auto">
        <!-- Page Header -->
        <div class="sf-page-header">
            <h1 class="sf-page-title">
                <svg style="width: 2rem; height: 2rem; color: #0176d3;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Tickets
            </h1>
        </div>

        <!-- Queues Display -->
        <div class="bg-white rounded-lg shadow-sm mb-6 border border-gray-200" style="overflow: visible;">
            <div class="px-6 py-3 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                        </svg>
                        <h2 class="text-sm font-semibold text-gray-700">Queues ({{ queues|length }})</h2>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="showCreateQueueModal()" class="px-3 py-1.5 bg-blue-500 border border-blue-600 rounded text-xs font-medium text-white hover:bg-blue-600 transition-colors flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            <span>New Queue</span>
                        </button>
                        <button onclick="toggleQueueExpansion()" class="px-3 py-1.5 bg-white border border-gray-300 rounded text-xs font-medium text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-1.5" id="expandQueueBtn">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                            </svg>
                            <span id="expandBtnText">Expand</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-0" style="position: relative;">
                <!-- Scroll Left Button -->
                <button id="scrollLeftBtn" onclick="scrollQueues('left')" class="queue-scroll-btn queue-scroll-left" style="display: none;">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>

                <!-- Scroll Right Button -->
                <button id="scrollRightBtn" onclick="scrollQueues('right')" class="queue-scroll-btn queue-scroll-right">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7" />
                    </svg>
                </button>

                <!-- Queue Cards Container -->
                <div id="queueContainer" class="queue-scroll-container">
                    <div id="queueCardsWrapper" class="queue-cards-wrapper collapsed">
                        <!-- Queue Cards -->
                        {% for queue in queues %}
                        {% set color_index = loop.index0 % 8 %}
                        {% set total_count = queue_ticket_counts[queue.id].total if queue_ticket_counts and queue.id in queue_ticket_counts else 0 %}
                        {% set open_count = queue_ticket_counts[queue.id].open if queue_ticket_counts and queue.id in queue_ticket_counts else 0 %}
                        <div class="queue-card queue-color-{{ color_index }}" onclick="filterByQueue('{{ queue.name|e }}')" data-queue="{{ queue.name|e }}" style="position: relative;">
                            {% if user.is_super_admin or user.is_developer %}
                            <button onclick="event.stopPropagation(); deleteQueue({{ queue.id }}, '{{ queue.name|e }}')" class="queue-delete-btn" title="Delete Queue">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                            {% endif %}
                            <div class="queue-card-header">
                                <div class="queue-icon queue-icon-{{ color_index }}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                    </svg>
                                </div>
                                <div class="queue-name" title="{{ queue.name }}">{{ queue.name }}</div>
                            </div>
                            <div class="queue-stats">
                                <div class="stat-item">
                                    <div class="stat-value stat-value-{{ color_index }}">{{ total_count }}</div>
                                    <div class="stat-label">Total</div>
                                </div>
                                <div class="stat-divider"></div>
                                <div class="stat-item">
                                    <div class="stat-value stat-open">{{ open_count }}</div>
                                    <div class="stat-label">Open</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <style>
            .queue-scroll-container {
                padding: 1.25rem;
                overflow-x: auto;
                overflow-y: visible;
                scrollbar-width: thin;
                scrollbar-color: #cbd5e1 #f8fafc;
                scroll-behavior: smooth;
                position: relative;
            }

            .queue-scroll-container::-webkit-scrollbar {
                height: 6px;
            }

            .queue-scroll-container::-webkit-scrollbar-track {
                background: #f8fafc;
                border-radius: 3px;
            }

            .queue-scroll-container::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }

            .queue-scroll-container::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }

            .queue-cards-wrapper {
                display: flex;
                gap: 1rem;
                transition: all 0.3s ease;
            }

            .queue-cards-wrapper.collapsed {
                flex-wrap: nowrap;
            }

            .queue-cards-wrapper.expanded {
                flex-wrap: wrap;
            }

            /* Queue Card Base Styles */
            .queue-card {
                flex: 0 0 220px;
                min-width: 220px;
                padding: 0;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                overflow: hidden;
                border: 1px solid;
            }

            .queue-cards-wrapper.expanded .queue-card {
                flex: 0 0 calc(25% - 0.75rem);
                min-width: 200px;
            }

            .queue-card-header {
                padding: 1rem 1.25rem;
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .queue-icon {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            .queue-name {
                font-weight: 600;
                font-size: 0.875rem;
                color: #1e293b;
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .queue-stats {
                padding: 0.875rem 1.25rem 1.125rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: rgba(0, 0, 0, 0.02);
            }

            .stat-item {
                text-align: center;
                flex: 1;
            }

            .stat-value {
                font-size: 1.75rem;
                font-weight: 700;
                line-height: 1;
                margin-bottom: 0.25rem;
            }

            .stat-label {
                font-size: 0.7rem;
                font-weight: 500;
                color: #64748b;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .stat-divider {
                width: 1px;
                height: 2rem;
                background: #e2e8f0;
            }

            .stat-open {
                color: #10b981 !important;
            }

            /* Color Variants - Vibrant Gradient Design */
            .queue-color-0 {
                background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
                border-color: rgba(14, 165, 233, 0.3);
            }
            .queue-icon-0 {
                background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
            }
            .stat-value-0 { color: #0284c7; }

            .queue-color-1 {
                background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
                border-color: rgba(236, 72, 153, 0.3);
            }
            .queue-icon-1 {
                background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
            }
            .stat-value-1 { color: #db2777; }

            .queue-color-2 {
                background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
                border-color: rgba(16, 185, 129, 0.3);
            }
            .queue-icon-2 {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            }
            .stat-value-2 { color: #059669; }

            .queue-color-3 {
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                border-color: rgba(245, 158, 11, 0.3);
            }
            .queue-icon-3 {
                background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            }
            .stat-value-3 { color: #d97706; }

            .queue-color-4 {
                background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
                border-color: rgba(139, 92, 246, 0.3);
            }
            .queue-icon-4 {
                background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
            }
            .stat-value-4 { color: #7c3aed; }

            .queue-color-5 {
                background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
                border-color: rgba(244, 114, 182, 0.3);
            }
            .queue-icon-5 {
                background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(244, 114, 182, 0.3);
            }
            .stat-value-5 { color: #ec4899; }

            .queue-color-6 {
                background: linear-gradient(135deg, #ecfccb 0%, #d9f99d 100%);
                border-color: rgba(132, 204, 22, 0.3);
            }
            .queue-icon-6 {
                background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(132, 204, 22, 0.3);
            }
            .stat-value-6 { color: #65a30d; }

            .queue-color-7 {
                background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
                border-color: rgba(251, 146, 60, 0.3);
            }
            .queue-icon-7 {
                background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
            }
            .stat-value-7 { color: #f97316; }

            .queue-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                border-width: 2px;
            }

            .queue-card:active {
                transform: translateY(0);
            }

            .queue-scroll-btn {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                z-index: 10;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transition: all 0.2s ease;
            }

            .queue-scroll-btn:hover {
                background: #f8fafc;
                border-color: #cbd5e1;
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            }

            .queue-scroll-btn:active {
                transform: translateY(-50%) scale(0.9);
            }

            .queue-scroll-left {
                left: 0.5rem;
            }

            .queue-scroll-right {
                right: 0.5rem;
            }

            .queue-cards-wrapper.expanded ~ .queue-scroll-btn {
                display: none !important;
            }

            @media (max-width: 768px) {
                .queue-card {
                    flex: 0 0 200px;
                    min-width: 200px;
                }

                .queue-cards-wrapper.expanded .queue-card {
                    flex: 0 0 100%;
                }
            }
        </style>

        <!-- Tabs Navigation with Action Buttons -->
        <div class="sf-tabs mb-6 rounded-t-md" style="display: flex; justify-content: space-between; align-items: center;">
            <div class="flex">
                <a href="#all" class="sf-tab active" onclick="filterTickets('all'); return false;">All Tickets</a>
                <a href="#open" class="sf-tab" onclick="filterTickets('open'); return false;">Open</a>
                <a href="#my-tickets" class="sf-tab" onclick="filterTickets('my'); return false;">My Tickets</a>
                <a href="#recently-viewed" class="sf-tab" onclick="filterTickets('recent'); return false;">Recently Viewed</a>
            </div>
            <div class="sf-page-actions" style="margin-right: 1rem;">
                {% if user.is_super_admin or user.is_developer %}
                <a href="{{ url_for('tickets.ticket_manager') }}"
                   class="sf-button" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                    </svg>
                    Ticket Manager
                </a>
                {% endif %}
                <a href="{{ url_for('tickets.create_ticket') }}"
                   class="sf-button primary-button">
                    <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Ticket
                </a>
                <a href="{{ url_for('inventory.add_customer_user') }}"
                   class="sf-button success-button">
                    <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                    </svg>
                    Add Customer
                </a>
                <button onclick="showExportWizard()" class="sf-button secondary-button">
                    <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Ticket Export Wizard
                </button>
                {% if current_user.is_admin %}
                <a href="{{ url_for('admin.csv_import') }}" 
                   class="sf-button">
                    <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    CSV Import
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="sf-card mb-6">
            <div class="sf-card-header">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <!-- Single Search -->
                    <div id="singleSearchSection" class="flex flex-1 items-center gap-2">
                        <div class="sf-search max-w-md">
                            <svg class="sf-search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <input type="text" id="searchInput" placeholder="Search tickets, descriptions, notes..." oninput="searchTickets()">
                        </div>
                        <button class="sf-button" onclick="toggleBulkSearch()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                            </svg>
                            Bulk Search
                        </button>
                        <button class="sf-button" onclick="clearFilters()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            Clear
                        </button>
                    </div>

                    <!-- Bulk Search -->
                    <div id="bulkSearchSection" class="flex flex-1 items-center gap-2 hidden">
                        <div class="flex-1 max-w-lg">
                            <textarea id="bulkSearchInput"
                                      placeholder="Enter multiple search terms (one per line or comma-separated)&#10;Can search: Ticket IDs, Order IDs, descriptions, notes&#10;Example:&#10;T001&#10;T002, T003&#10;ORD-12345&#10;repair device&#10;customer complaint"
                                      class="w-full h-20 px-3 py-2 text-sm border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      oninput="bulkSearchTickets()"></textarea>
                            <div class="mt-1 text-xs text-gray-500">
                                <span id="bulkSearchCount">0</span> search terms entered
                                <span id="bulkSearchMatches" class="ml-2 text-blue-600 font-medium hidden"></span>
                            </div>
                        </div>
                        <button class="sf-button" onclick="toggleBulkSearch()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            Single Search
                        </button>
                        <button class="sf-button" onclick="clearBulkSearch()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            Clear
                        </button>
                    </div>
                    
                    <div class="sf-filter-section">
                        <span class="sf-filter-label">Status:</span>
                        <select class="sf-filter-select" id="statusFilter" onchange="filterTickets()">
                            <option value="">All</option>
                            <option value="New">New</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Resolved (All Package Delivered)">Resolved (All Package Delivered)</option>
                        </select>
                        
                        <span class="sf-filter-label">Priority:</span>
                        <select class="sf-filter-select" id="priorityFilter" onchange="filterTickets()">
                            <option value="">All</option>
                            <option value="Critical">Critical</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                        
                        <span class="sf-filter-label">Category:</span>
                        <select class="sf-filter-select" id="categoryFilter" onchange="filterTickets()">
                            <option value="">All</option>
                            <option value="PIN Request">PIN Request</option>
                            <option value="Asset Repair">Asset Repair</option>
                            <option value="Bulk Delivery Quotation">Bulk Delivery Quotation</option>
                            <option value="Repair Quote">Repair Quote</option>
                            <option value="ITAD Quote">ITAD Quote</option>
                            <option value="Asset Checkout (claw)">Asset Checkout (claw)</option>
                            <option value="Asset Return (claw)">Asset Return</option>
                            <option value="Asset Intake">Asset Intake</option>
                        </select>

                        <span class="sf-filter-label">Queue:</span>
                        <select class="sf-filter-select" id="queueFilter" onchange="filterTickets()">
                            <option value="">All</option>
                            {% for queue in queues %}
                            <option value="{{ queue.name }}">{{ queue.name }}</option>
                            {% endfor %}
                        </select>

                        <div class="flex items-center ml-auto">
                            <a href="{{ url_for('tickets.list_tickets') }}" class="sf-button">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Refresh
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sf-card-body p-0">
                <div class="overflow-x-auto">
                    <table class="sf-data-table" id="ticketsTable">
                        <thead>
                            <tr class="bg-gradient-to-r from-indigo-50 to-blue-50 border-b-2 border-indigo-200">
                                <th colspan="9" class="text-left px-6 py-3">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                        </svg>
                                        <span class="font-semibold text-indigo-900" id="currentQueueDisplay">Queue: <span id="currentQueueName">All Queues</span></span>
                                    </div>
                                </th>
                            </tr>
                            <tr>
                                <th onclick="sortTable(0)">Case Number</th>
                                <th onclick="sortTable(1)">Subject</th>
                                <th onclick="sortTable(2)">Status</th>
                                <th onclick="sortTable(3)">Priority</th>
                                <th onclick="sortTable(4)">Created</th>
                                <th onclick="sortTable(5)">Category</th>
                                <th onclick="sortTable(6)">Queue</th>
                                <th onclick="sortTable(7)">Case Owner</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in tickets %}
                            <tr data-ticket-id="{{ ticket.id }}" data-status="{{ ticket.status.value if ticket.status else '' }}" data-priority="{{ ticket.priority.value if ticket.priority else '' }}" data-category="{{ ticket.get_category_display_name() }}" data-requester-id="{{ ticket.requester_id if ticket.requester_id else '' }}" data-created="{{ ticket.created_at.isoformat() }}" data-description="{{ (ticket.description or '')|e }}" data-notes="{{ (ticket.notes or '')|e }}" data-return-description="{{ (ticket.return_description or '')|e }}">
                                <td class="font-mono">{{ ticket.display_id if ticket.display_id else ticket.id }}</td>
                                <td>
                                    {% if ticket.id %}
                                    <a href="{{ url_for('tickets.view_ticket', ticket_id=ticket.id) }}" onclick="openTicketInTab({{ ticket.id }}, '{{ (ticket.subject or 'Untitled')|e|replace("'", "\\'") }}'); return false;" class="text-blue-600 hover:text-blue-900 font-medium">
                                        {{ ticket.subject or 'Untitled' }}
                                    </a>
                                    {% else %}
                                    <span class="text-gray-500">{{ ticket.subject or 'Untitled' }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="sf-badge 
                                        {% if ticket.status.value == 'New' %}
                                            bg-blue-100 text-blue-800
                                        {% elif ticket.status.value == 'In Progress' %}
                                            bg-yellow-100 text-yellow-800
                                        {% elif ticket.status.value == 'Resolved' %}
                                            bg-green-100 text-green-800
                                        {% elif ticket.status.value == 'Resolved (All Package Delivered)' %}
                                            bg-emerald-100 text-emerald-800
                                        {% else %}
                                            bg-gray-100 text-gray-800
                                        {% endif %}">
                                        {{ ticket.status.value if ticket.status else 'Unknown' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="sf-badge 
                                        {% if ticket.priority.value == 'Critical' %}
                                            bg-red-100 text-red-800
                                        {% elif ticket.priority.value == 'High' %}
                                            bg-orange-100 text-orange-800
                                        {% elif ticket.priority.value == 'Medium' %}
                                            bg-yellow-100 text-yellow-800
                                        {% else %}
                                            bg-green-100 text-green-800
                                        {% endif %}">
                                        {{ ticket.priority.value if ticket.priority else 'Unknown' }}
                                    </span>
                                </td>
                                <td class="whitespace-nowrap">
                                    {{ ticket.created_at | singapore_time | default('N/A') }}
                                </td>
                                <td>
                                    <span class="sf-badge
                                        {% if ticket.category and ticket.category.value == 'PIN_REQUEST' %}
                                            bg-purple-100 text-purple-800
                                        {% elif ticket.category and ticket.category.value == 'ASSET_REPAIR' %}
                                            bg-red-100 text-red-800
                                        {% elif ticket.category and (ticket.category.value == 'ASSET_CHECKOUT' or
                                                ticket.category.value == 'ASSET_CHECKOUT_SINGPOST' or
                                                ticket.category.value == 'ASSET_CHECKOUT_DHL' or
                                                ticket.category.value == 'ASSET_CHECKOUT_UPS' or
                                                ticket.category.value == 'ASSET_CHECKOUT_BLUEDART' or
                                                ticket.category.value == 'ASSET_CHECKOUT_DTDC') %}
                                            bg-blue-100 text-blue-800
                                        {% elif ticket.category and ticket.category.value == 'ASSET_INTAKE' %}
                                            bg-green-100 text-green-800
                                        {% elif not ticket.category %}
                                            bg-indigo-100 text-indigo-800
                                        {% else %}
                                            bg-gray-100 text-gray-800
                                        {% endif %}">
                                        {{ ticket.get_category_display_name() }}
                                    </span>
                                </td>
                                <td>
                                    {% if ticket.queue %}
                                        <span class="sf-badge bg-indigo-100 text-indigo-800">
                                            {{ ticket.queue.name }}
                                        </span>
                                    {% else %}
                                        <span class="sf-badge bg-gray-100 text-gray-800">
                                            No Queue
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ticket.assigned_to %}
                                        <span class="sf-badge bg-blue-100 text-blue-800">
                                            {{ ticket.assigned_to.username }}
                                        </span>
                                    {% else %}
                                        <span class="sf-badge bg-gray-100 text-gray-800">
                                            Unassigned
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="whitespace-nowrap">
                                    <div class="sf-action-menu">
                                        <button class="sf-action-button" onclick="toggleActionMenu(this)">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                            </svg>
                                        </button>
                                        <div class="sf-action-dropdown">
                                            {% if ticket.id %}
                                            <a href="{{ url_for('tickets.view_ticket', ticket_id=ticket.id) }}" onclick="openTicketInTab({{ ticket.id }}, '{{ (ticket.subject or 'Untitled')|e|replace("'", "\\'") }}'); return false;" class="sf-action-item">Edit</a>
                                            {% else %}
                                            <span class="sf-action-item text-gray-400">Edit (No ID)</span>
                                            {% endif %}
                                            <a href="#" class="sf-action-item">Close</a>
                                            {% if current_user.is_super_admin or current_user.permissions.can_delete_tickets or (current_user.permissions.can_delete_own_tickets and current_user.id == ticket.requester_id) %}
                                            <form action="{{ url_for('tickets.delete_ticket', ticket_id=ticket.id) }}" 
                                                  method="POST" 
                                                  class="inline"
                                                  onsubmit="return confirm('Are you sure you want to delete this ticket? This action cannot be undone.');">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="sf-action-item text-red-600 w-full text-left">Delete</button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="hidden py-8 text-center">
                    <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No tickets found</h3>
                    <p class="mt-1 text-sm text-gray-500">Try adjusting your search or filter to find what you're looking for.</p>
                    <div class="mt-6">
                        <button class="sf-button primary-button" onclick="clearFilters()">
                            Clear filters
                        </button>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="sf-pagination">
                    <div class="sf-pagination-info">
                        Showing <span id="itemsShown">1-10</span> of <span id="totalItems">{{ tickets|length }}</span> tickets
                        <div class="inline-flex items-center ml-4">
                            <label for="itemsPerPageSelect" class="text-xs text-gray-600 mr-2">Display:</label>
                            <select id="itemsPerPageSelect" class="sf-filter-select text-xs" onchange="changeItemsPerPage()">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="text-xs text-gray-600 ml-2">per page</span>
                        </div>
                    </div>
                    <div class="sf-pagination-controls">
                        <button class="sf-pagination-button" id="prevPage" onclick="changePage(-1)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <span class="sf-pagination-button active" id="currentPage">1</span>
                        <button class="sf-pagination-button" id="nextPage" onclick="changePage(1)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Pagination variables
    let currentPage = 1;
    let itemsPerPage = 10;
    let filteredItems = [];
    
    // Current user ID for filtering
    const currentUserId = {% if user %}{{ user.id }}{% else %}null{% endif %};
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the table
        const table = document.getElementById('ticketsTable');
        filteredItems = Array.from(table.querySelectorAll('tbody tr'));
        updatePagination();
        showPage(1);
        

    });
    
    function filterTickets(tabFilter) {
        const table = document.getElementById('ticketsTable');
        const rows = table.querySelectorAll('tbody tr');
        const statusFilter = document.getElementById('statusFilter').value;
        const priorityFilter = document.getElementById('priorityFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        const queueFilter = document.getElementById('queueFilter').value;
        const searchText = document.getElementById('searchInput').value.toLowerCase();

        // Update queue display
        const queueNameDisplay = document.getElementById('currentQueueName');
        if (queueFilter) {
            queueNameDisplay.textContent = queueFilter;
        } else {
            queueNameDisplay.textContent = 'All Queues';
        }
        
        // Update active tab if specified
        if (tabFilter) {
            document.querySelectorAll('.sf-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Map filter values to correct href values
            let targetHref = '';
            if (tabFilter === 'all') targetHref = '#all';
            else if (tabFilter === 'open') targetHref = '#open';
            else if (tabFilter === 'my') targetHref = '#my-tickets';
            else if (tabFilter === 'recent') targetHref = '#recently-viewed';
            
            if (targetHref) {
                const targetTab = document.querySelector(`.sf-tab[href="${targetHref}"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
            }
        }
        
        filteredItems = [];
        
        rows.forEach(row => {
            const status = row.getAttribute('data-status');
            const priority = row.getAttribute('data-priority');
            const category = row.getAttribute('data-category');
            const queue = row.querySelector('td:nth-child(7)').textContent.trim(); // Queue is in column 7
            const subject = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const caseNumber = row.querySelector('td:nth-child(1)').textContent.toLowerCase();

            // Check if row matches all filters
            const matchesStatus = !statusFilter || status === statusFilter;
            const matchesPriority = !priorityFilter || priority === priorityFilter;
            const matchesCategory = !categoryFilter || category === categoryFilter;
            const matchesQueue = !queueFilter || queue === queueFilter;
            // Handle search logic - either single search or bulk search
            let matchesSearch = true;
            if (isBulkSearchMode && bulkSearchIds.length > 0) {
                // Bulk search mode: check if ticket ID matches any in the list
                const ticketId = caseNumber.toUpperCase();
                const description = row.getAttribute('data-description').toUpperCase();
                const notes = row.getAttribute('data-notes').toUpperCase();
                const returnDescription = row.getAttribute('data-return-description').toUpperCase();

                matchesSearch = bulkSearchIds.some(searchId => {
                    // Exact match or partial match in all searchable fields
                    return ticketId === searchId ||
                           ticketId.includes(searchId) ||
                           searchId.includes(ticketId) ||
                           // Also search in subject, description, notes, and return description
                           subject.toUpperCase().includes(searchId) ||
                           description.includes(searchId) ||
                           notes.includes(searchId) ||
                           returnDescription.includes(searchId);
                });
            } else if (searchText) {
                // Single search mode: enhanced logic to search in multiple fields
                const description = row.getAttribute('data-description').toLowerCase();
                const notes = row.getAttribute('data-notes').toLowerCase();
                const returnDescription = row.getAttribute('data-return-description').toLowerCase();

                matchesSearch = subject.includes(searchText) ||
                               caseNumber.includes(searchText) ||
                               description.includes(searchText) ||
                               notes.includes(searchText) ||
                               returnDescription.includes(searchText);
            }
            
            // Apply tab filter logic
            let matchesTab = true;
            if (tabFilter === 'open') {
                matchesTab = status !== 'RESOLVED' && status !== 'RESOLVED_DELIVERED';
            } else if (tabFilter === 'my') {
                // Show only tickets created by the current user
                const ticketRequesterId = row.getAttribute('data-requester-id');
                matchesTab = ticketRequesterId && currentUserId && parseInt(ticketRequesterId) === currentUserId;
            } else if (tabFilter === 'recent') {
                // Show tickets from the last 7 days
                const ticketCreated = new Date(row.getAttribute('data-created'));
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                matchesTab = ticketCreated >= sevenDaysAgo;
            }
            
            if (matchesStatus && matchesPriority && matchesCategory && matchesQueue && matchesSearch && matchesTab) {
                filteredItems.push(row);
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show empty state if no items match
        const emptyState = document.getElementById('emptyState');
        if (filteredItems.length === 0) {
            emptyState.classList.remove('hidden');
        } else {
            emptyState.classList.add('hidden');
        }

        // Update bulk search match indicator
        if (isBulkSearchMode && bulkSearchIds.length > 0) {
            const matchesElement = document.getElementById('bulkSearchMatches');
            matchesElement.textContent = `${filteredItems.length} matches found`;
            matchesElement.classList.remove('hidden');
        } else {
            const matchesElement = document.getElementById('bulkSearchMatches');
            matchesElement.classList.add('hidden');
        }

        // Reset to first page and update pagination
        currentPage = 1;
        updatePagination();
        showPage(1);
    }
    
    function clearFilters() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('priorityFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('searchInput').value = '';

        // Clear bulk search as well
        document.getElementById('bulkSearchInput').value = '';
        bulkSearchIds = [];
        updateBulkSearchCount();

        // Reset tab selection
        document.querySelectorAll('.sf-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector('.sf-tab[href="#all"]').classList.add('active');

        filterTickets();
    }
    
    function searchTickets() {
        filterTickets();
    }

    // Bulk search functionality
    let isBulkSearchMode = false;
    let bulkSearchIds = [];

    function toggleBulkSearch() {
        isBulkSearchMode = !isBulkSearchMode;
        const singleSection = document.getElementById('singleSearchSection');
        const bulkSection = document.getElementById('bulkSearchSection');

        if (isBulkSearchMode) {
            singleSection.classList.add('hidden');
            bulkSection.classList.remove('hidden');
            // Clear single search when switching to bulk
            document.getElementById('searchInput').value = '';
        } else {
            bulkSection.classList.add('hidden');
            singleSection.classList.remove('hidden');
            // Clear bulk search when switching to single
            document.getElementById('bulkSearchInput').value = '';
            bulkSearchIds = [];
            updateBulkSearchCount();
        }
        filterTickets();
    }

    function parseBulkSearchInput(input) {
        if (!input.trim()) return [];

        // Split by newlines and commas, then clean up
        const ids = input
            .split(/[\n,]+/)
            .map(id => id.trim())
            .filter(id => id.length > 0)
            .map(id => id.toUpperCase()); // Convert to uppercase for consistent matching

        return [...new Set(ids)]; // Remove duplicates
    }

    function updateBulkSearchCount() {
        const count = bulkSearchIds.length;
        document.getElementById('bulkSearchCount').textContent = count;
    }

    function bulkSearchTickets() {
        const input = document.getElementById('bulkSearchInput').value;
        bulkSearchIds = parseBulkSearchInput(input);
        updateBulkSearchCount();
        filterTickets();
    }

    function clearBulkSearch() {
        document.getElementById('bulkSearchInput').value = '';
        bulkSearchIds = [];
        updateBulkSearchCount();
        filterTickets();
    }
    
    function sortTable(n) {
        const table = document.getElementById('ticketsTable');
        const tbody = table.querySelector('tbody');
        let rows = Array.from(tbody.querySelectorAll('tr'));
        let sortDirection = 'asc';
        
        // Get current sort direction from the column
        const th = table.querySelector(`th:nth-child(${n+1})`);
        if (th.classList.contains('sort-asc')) {
            sortDirection = 'desc';
            th.classList.remove('sort-asc');
            th.classList.add('sort-desc');
        } else {
            // Reset all column classes
            table.querySelectorAll('th').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            th.classList.add('sort-asc');
        }
        
        // Sort rows
        rows.sort((a, b) => {
            let x = a.cells[n].textContent.trim();
            let y = b.cells[n].textContent.trim();
            
            // If it's a date column (created date), convert to date object
            if (n === 4) {
                x = new Date(x);
                y = new Date(y);
            }
            
            if (sortDirection === 'asc') {
                return x < y ? -1 : x > y ? 1 : 0;
            } else {
                return x > y ? -1 : x < y ? 1 : 0;
            }
        });
        
        // Append sorted rows
        rows.forEach(row => tbody.appendChild(row));
        
        // Update filtered items
        filterTickets();
    }
    
    function toggleActionMenu(button) {
        const dropdown = button.nextElementSibling;
        
        // Close all other open dropdowns
        document.querySelectorAll('.sf-action-dropdown.show').forEach(menu => {
            if (menu !== dropdown) {
                menu.classList.remove('show');
            }
        });
        
        // Toggle this dropdown
        dropdown.classList.toggle('show');
        
        // Add click outside listener
        setTimeout(() => {
            document.addEventListener('click', closeDropdowns);
        }, 0);
    }
    
    function closeDropdowns(e) {
        if (!e.target.closest('.sf-action-menu')) {
            document.querySelectorAll('.sf-action-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            document.removeEventListener('click', closeDropdowns);
        }
    }
    
    function showPage(page) {
        // Hide all rows first
        const table = document.getElementById('ticketsTable');
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            row.classList.add('hidden');
        });
        
        // Calculate which items to show
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredItems.length);
        
        // Show only the rows for this page
        for (let i = startIndex; i < endIndex; i++) {
            filteredItems[i].classList.remove('hidden');
        }
        
        // Update pagination text
        document.getElementById('itemsShown').textContent = 
            filteredItems.length > 0 ? `${startIndex + 1}-${endIndex}` : '0';
        document.getElementById('totalItems').textContent = filteredItems.length;
        document.getElementById('currentPage').textContent = page;
    }
    
    function changePage(direction) {
        const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
        const newPage = currentPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            showPage(currentPage);
            updatePagination();
        }
    }
    
    function updatePagination() {
        const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
        const prevButton = document.getElementById('prevPage');
        const nextButton = document.getElementById('nextPage');
        
        // Disable/enable previous button
        if (currentPage <= 1) {
            prevButton.classList.add('disabled');
        } else {
            prevButton.classList.remove('disabled');
        }
        
        // Disable/enable next button
        if (currentPage >= totalPages) {
            nextButton.classList.add('disabled');
        } else {
            nextButton.classList.remove('disabled');
        }
    }
    
    function changeItemsPerPage() {
        const select = document.getElementById('itemsPerPageSelect');
        itemsPerPage = parseInt(select.value);
        
        // Reset to first page
        currentPage = 1;
        
        // Update pagination and display
        updatePagination();
        showPage(1);
    }

    // Tab system integration
    function openTicketInTab(ticketId, ticketSubject) {
        // Validate input
        if (!ticketId) {
            console.error('No ticket ID provided');
            return false;
        }

        try {
            if (window.tabSystem) {
                window.tabSystem.openTicket(ticketId, ticketSubject || 'Untitled');
                // Navigate to the ticket
                window.location.href = `/tickets/${ticketId}`;
            } else {
                // Fallback if tab system isn't loaded
                window.location.href = `/tickets/${ticketId}`;
            }
        } catch (error) {
            console.error('Error opening ticket:', error);
            // Fallback navigation
            window.location.href = `/tickets/${ticketId}`;
        }
        return true;
    }

    // Initialize current page as home tab
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            if (window.tabSystem) {
                window.tabSystem.setActiveTab('home');
            }
        }, 200);
    });

    // Export Wizard Functions
    function showExportWizard() {
        document.getElementById('exportWizardModal').style.display = 'flex';

        // Populate ticket types and categories from existing tickets
        populateExportFilters();
    }

    function hideExportWizard() {
        document.getElementById('exportWizardModal').style.display = 'none';

        // Reset form
        document.getElementById('exportForm').reset();
        clearSelectedTickets();
    }

    function populateExportFilters() {
        const tickets = document.querySelectorAll('#ticketsTable tbody tr');
        const categories = new Set();
        const priorities = new Set();

        tickets.forEach(row => {
            if (row.style.display !== 'none') { // Only from visible tickets
                const category = row.getAttribute('data-category');
                const priority = row.getAttribute('data-priority');

                if (category) categories.add(category);
                if (priority) priorities.add(priority);
            }
        });

        // Update category filter options
        const categorySelect = document.getElementById('exportCategoryFilter');
        categorySelect.innerHTML = '<option value="all">All Categories</option>';
        categories.forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
        });

        // Update priority filter options
        const prioritySelect = document.getElementById('exportPriorityFilter');
        prioritySelect.innerHTML = '<option value="all">All Priorities</option>';
        priorities.forEach(pri => {
            prioritySelect.innerHTML += `<option value="${pri}">${pri}</option>`;
        });

        // Load companies dynamically
        loadCompaniesForExport();
    }

    function loadCompaniesForExport() {
        fetch('/api/v1/companies')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.companies) {
                    const companySelect = document.getElementById('exportCompanyFilter');
                    companySelect.innerHTML = '<option value="all">All Companies</option>';

                    // Organize companies by parent/child relationship
                    data.companies.forEach(company => {
                        let displayName = company.grouped_display_name;

                        // Add indentation for child companies
                        if (company.parent_company_id && !company.is_parent_company) {
                            displayName = '   ' + displayName;
                        } else if (company.is_parent_company) {
                            displayName = ' ' + displayName;
                        }

                        companySelect.innerHTML += `<option value="${company.id}">${displayName}</option>`;
                    });
                }
            })
            .catch(error => {
                console.error('Error loading companies:', error);
            });
    }

    function toggleExportMode() {
        const mode = document.getElementById('exportMode').value;
        const filterSection = document.getElementById('filterExportSection');
        const selectionSection = document.getElementById('selectionExportSection');

        if (mode === 'filtered') {
            filterSection.style.display = 'block';
            selectionSection.style.display = 'none';
        } else if (mode === 'selected') {
            filterSection.style.display = 'none';
            selectionSection.style.display = 'block';
            showTicketSelection();
        } else {
            filterSection.style.display = 'none';
            selectionSection.style.display = 'none';
        }

        // Auto-refresh preview if it's visible
        if (document.getElementById('exportPreviewSection').style.display !== 'none') {
            showPreview();
        }
    }

    function showTicketSelection() {
        const tickets = document.querySelectorAll('#ticketsTable tbody tr');
        const selectionContainer = document.getElementById('ticketSelectionList');

        selectionContainer.innerHTML = '';

        tickets.forEach(row => {
            if (row.style.display !== 'none') {
                const ticketId = row.getAttribute('data-ticket-id');
                const subject = row.querySelector('td:nth-child(2)').textContent.trim();
                const status = row.querySelector('td:nth-child(3)').textContent.trim();

                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'ticket-selection-item';
                checkboxItem.innerHTML = `
                    <label class="ticket-selection-label">
                        <input type="checkbox" name="selectedTickets" value="${ticketId}" onchange="refreshPreviewIfVisible()">
                        <span class="ticket-info">
                            <strong>#${ticketId}</strong> - ${subject}
                            <span class="ticket-status">${status}</span>
                        </span>
                    </label>
                `;
                selectionContainer.appendChild(checkboxItem);
            }
        });
    }

    function selectAllTickets() {
        const checkboxes = document.querySelectorAll('#ticketSelectionList input[name="selectedTickets"]');
        checkboxes.forEach(cb => cb.checked = true);
        refreshPreviewIfVisible();
    }

    function clearSelectedTickets() {
        const checkboxes = document.querySelectorAll('#ticketSelectionList input[name="selectedTickets"]');
        checkboxes.forEach(cb => cb.checked = false);
        refreshPreviewIfVisible();
    }

    function filterTicketList() {
        const searchInput = document.getElementById('ticketSearchInput');
        const searchTerm = searchInput.value.toLowerCase().trim();
        const ticketItems = document.querySelectorAll('.ticket-selection-item');

        ticketItems.forEach(item => {
            const label = item.querySelector('.ticket-selection-label');
            const ticketText = label.textContent.toLowerCase();

            // Show/hide based on search term
            if (searchTerm === '' || ticketText.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function refreshPreviewIfVisible() {
        // Only refresh preview if it's currently visible
        if (document.getElementById('exportPreviewSection').style.display !== 'none') {
            showPreview();
        }
    }

    function executeExport() {
        const form = document.getElementById('exportForm');
        const formData = new FormData(form);

        // Build export URL with parameters
        const params = new URLSearchParams();

        const mode = formData.get('exportMode');
        params.append('mode', mode);

        if (mode === 'filtered') {
            if (formData.get('dateFrom')) params.append('date_from', formData.get('dateFrom'));
            if (formData.get('dateTo')) params.append('date_to', formData.get('dateTo'));
            if (formData.get('categoryFilter') !== 'all') params.append('category', formData.get('categoryFilter'));
            if (formData.get('priorityFilter') !== 'all') params.append('priority', formData.get('priorityFilter'));
            if (formData.get('statusFilter') !== 'all') params.append('status', formData.get('statusFilter'));
            if (formData.get('countryFilter') !== 'all') params.append('country', formData.get('countryFilter'));
            if (formData.get('companyFilter') !== 'all') params.append('company', formData.get('companyFilter'));
        } else if (mode === 'selected') {
            const selectedTickets = Array.from(form.querySelectorAll('input[name="selectedTickets"]:checked'))
                                        .map(cb => cb.value);
            if (selectedTickets.length === 0) {
                alert('Please select at least one ticket to export.');
                return;
            }
            params.append('ticket_ids', selectedTickets.join(','));
        }

        // Open export in new window
        window.open(`{{ url_for('tickets.export_tickets_csv') }}?${params.toString()}`, '_blank');

        // Hide wizard
        hideExportWizard();
    }

    // Preview Functions
    function showPreview() {
        const form = document.getElementById('exportForm');
        const mode = form.exportMode.value;

        // Get tickets to preview based on mode
        let ticketsToPreview = [];

        console.log('Export mode:', mode);

        if (mode === 'all') {
            // All visible tickets
            const ticketRows = document.querySelectorAll('#ticketsTable tbody tr');
            console.log('Found ticket rows:', ticketRows.length);

            ticketRows.forEach(row => {
                // Include all rows unless explicitly hidden
                if (row.style.display !== 'none') {
                    ticketsToPreview.push(getTicketDataFromRow(row));
                }
            });

            console.log('Tickets after display check:', ticketsToPreview.length);

            // If no tickets were found with the display check, get all tickets
            if (ticketsToPreview.length === 0) {
                ticketRows.forEach(row => {
                    ticketsToPreview.push(getTicketDataFromRow(row));
                });
                console.log('Tickets after fallback:', ticketsToPreview.length);
            }
        } else if (mode === 'filtered') {
            // Apply filters to get matching tickets
            ticketsToPreview = getFilteredTickets(form);
        } else if (mode === 'selected') {
            // Get selected tickets
            const selectedCheckboxes = form.querySelectorAll('input[name="selectedTickets"]:checked');
            selectedCheckboxes.forEach(checkbox => {
                const ticketId = checkbox.value;
                const ticketRow = document.querySelector(`#ticketsTable tbody tr[data-ticket-id="${ticketId}"]`);
                if (ticketRow) {
                    ticketsToPreview.push(getTicketDataFromRow(ticketRow));
                }
            });
        }

        // Display preview
        displayPreview(ticketsToPreview);

        // Show preview section and update buttons
        document.getElementById('exportPreviewSection').style.display = 'block';
        document.getElementById('previewButton').style.display = 'none';
        document.getElementById('exportButton').style.display = 'inline-block';

        // Scroll to preview
        document.getElementById('exportPreviewSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function getTicketDataFromRow(row) {
        const cells = row.querySelectorAll('td');

        // Get the link text from the subject cell (which might be in an <a> tag)
        let subject = '';
        if (cells[1]) {
            const link = cells[1].querySelector('a');
            subject = link ? link.textContent.trim() : cells[1].textContent.trim();
        }

        const ticketData = {
            id: row.getAttribute('data-ticket-id'),
            displayId: cells[0] ? cells[0].textContent.trim() : 'Unknown',
            subject: subject || 'No Subject',
            status: row.getAttribute('data-status') || 'Unknown',
            priority: row.getAttribute('data-priority') || 'Unknown',
            category: row.getAttribute('data-category') || 'Uncategorized',
            created: row.getAttribute('data-created') || ''
        };

        return ticketData;
    }

    function getFilteredTickets(form) {
        const formData = new FormData(form);
        const dateFrom = formData.get('dateFrom');
        const dateTo = formData.get('dateTo');
        const categoryFilter = formData.get('categoryFilter');
        const priorityFilter = formData.get('priorityFilter');
        const statusFilter = formData.get('statusFilter');

        const ticketRows = document.querySelectorAll('#ticketsTable tbody tr');
        const filteredTickets = [];

        ticketRows.forEach(row => {
            if (row.style.display === 'none') return; // Skip hidden tickets

            let matchesFilter = true;

            // Date filter
            if (dateFrom || dateTo) {
                const ticketDate = new Date(row.getAttribute('data-created'));
                if (dateFrom && ticketDate < new Date(dateFrom)) matchesFilter = false;
                if (dateTo) {
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999); // End of day
                    if (ticketDate > toDate) matchesFilter = false;
                }
            }

            // Category filter
            if (categoryFilter && categoryFilter !== 'all') {
                const ticketCategory = row.getAttribute('data-category');
                if (ticketCategory !== categoryFilter) matchesFilter = false;
            }

            // Priority filter
            if (priorityFilter && priorityFilter !== 'all') {
                const ticketPriority = row.getAttribute('data-priority');
                if (ticketPriority !== priorityFilter) matchesFilter = false;
            }

            // Status filter
            if (statusFilter && statusFilter !== 'all') {
                const ticketStatus = row.getAttribute('data-status');
                if (ticketStatus !== statusFilter) matchesFilter = false;
            }

            if (matchesFilter) {
                filteredTickets.push(getTicketDataFromRow(row));
            }
        });

        return filteredTickets;
    }

    function displayPreview(tickets) {
        const previewCount = document.getElementById('previewCount');
        const previewTableBody = document.getElementById('previewTableBody');
        const previewEmptyState = document.getElementById('previewEmptyState');
        const previewTable = document.querySelector('.preview-table');

        // Update count
        previewCount.textContent = `${tickets.length} ticket${tickets.length !== 1 ? 's' : ''}`;

        if (tickets.length === 0) {
            // Show empty state
            previewTable.style.display = 'none';
            previewEmptyState.style.display = 'block';
            return;
        }

        // Show table and hide empty state
        previewTable.style.display = 'table';
        previewEmptyState.style.display = 'none';

        // Clear existing rows
        previewTableBody.innerHTML = '';

        // Add ticket rows
        tickets.forEach(ticket => {
            const row = document.createElement('tr');

            // Format date
            const createdDate = ticket.created ? new Date(ticket.created).toLocaleDateString() : 'Unknown';

            // Get status color
            const statusColor = getStatusBadgeColor(ticket.status);
            const priorityColor = getPriorityBadgeColor(ticket.priority);

            row.innerHTML = `
                <td class="ticket-id">#${ticket.displayId}</td>
                <td class="ticket-subject" title="${ticket.subject}">${ticket.subject}</td>
                <td><span class="status-badge" style="${statusColor}">${ticket.status}</span></td>
                <td><span class="priority-badge" style="${priorityColor}">${ticket.priority}</span></td>
                <td>${ticket.category || 'Uncategorized'}</td>
                <td>${createdDate}</td>
            `;

            previewTableBody.appendChild(row);
        });
    }

    function getStatusBadgeColor(status) {
        const colors = {
            'New': 'background: #fef3c7; color: #92400e; border: 1px solid #fbbf24;',
            'Open': 'background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6;',
            'In Progress': 'background: #e0e7ff; color: #3730a3; border: 1px solid #6366f1;',
            'Waiting': 'background: #fed7d7; color: #b91c1c; border: 1px solid #ef4444;',
            'Resolved': 'background: #d1fae5; color: #065f46; border: 1px solid #10b981;',
            'Closed': 'background: #f3f4f6; color: #374151; border: 1px solid #6b7280;'
        };
        return colors[status] || colors['Open'];
    }

    function getPriorityBadgeColor(priority) {
        const colors = {
            'Critical': 'background: #fee2e2; color: #b91c1c; border: 1px solid #ef4444;',
            'High': 'background: #fed7aa; color: #c2410c; border: 1px solid #f97316;',
            'Medium': 'background: #fef3c7; color: #92400e; border: 1px solid #eab308;',
            'Low': 'background: #d1fae5; color: #065f46; border: 1px solid #10b981;'
        };
        return colors[priority] || colors['Medium'];
    }

    function hidePreview() {
        document.getElementById('exportPreviewSection').style.display = 'none';
        document.getElementById('previewButton').style.display = 'inline-block';
        document.getElementById('exportButton').style.display = 'none';
    }

    // Update hideExportWizard to also hide preview
    function hideExportWizard() {
        document.getElementById('exportWizardModal').style.display = 'none';

        // Reset form
        document.getElementById('exportForm').reset();
        clearSelectedTickets();
        hidePreview();
    }

    // Filter by queue function (called from queue cards)
    function filterByQueue(queueName) {
        // Update the queue filter dropdown
        const queueFilter = document.getElementById('queueFilter');
        queueFilter.value = queueName;

        // Clear search and other filters for cleaner queue filtering
        // But keep the current tab filter active

        // Trigger the main filter function
        filterTickets();

        // Smooth scroll to the table
        const tableCard = document.querySelector('.sf-card');
        if (tableCard) {
            tableCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // Toggle queue expansion
    function toggleQueueExpansion() {
        const wrapper = document.getElementById('queueCardsWrapper');
        const btn = document.getElementById('expandQueueBtn');
        const btnText = document.getElementById('expandBtnText');
        const container = document.getElementById('queueContainer');

        if (wrapper.classList.contains('collapsed')) {
            // Expand
            wrapper.classList.remove('collapsed');
            wrapper.classList.add('expanded');
            btnText.textContent = 'Collapse';
            container.style.overflowX = 'visible';
        } else {
            // Collapse
            wrapper.classList.add('collapsed');
            wrapper.classList.remove('expanded');
            btnText.textContent = 'Expand All';
            container.style.overflowX = 'auto';
            updateScrollButtons();
        }
    }

    // Scroll queues left or right
    function scrollQueues(direction) {
        const container = document.getElementById('queueContainer');
        const scrollAmount = 300;

        if (direction === 'left') {
            container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        } else {
            container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }

        // Update button visibility after scroll
        setTimeout(updateScrollButtons, 300);
    }

    // Update scroll button visibility
    function updateScrollButtons() {
        const container = document.getElementById('queueContainer');
        const leftBtn = document.getElementById('scrollLeftBtn');
        const rightBtn = document.getElementById('scrollRightBtn');
        const wrapper = document.getElementById('queueCardsWrapper');

        // Don't show buttons if expanded
        if (wrapper.classList.contains('expanded')) {
            leftBtn.style.display = 'none';
            rightBtn.style.display = 'none';
            return;
        }

        const isAtStart = container.scrollLeft <= 0;
        const isAtEnd = container.scrollLeft + container.clientWidth >= container.scrollWidth - 1;

        leftBtn.style.display = isAtStart ? 'none' : 'flex';
        rightBtn.style.display = isAtEnd ? 'none' : 'flex';
    }

    // Initialize scroll buttons on page load
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('queueContainer');

        // Update buttons on scroll
        container.addEventListener('scroll', updateScrollButtons);

        // Update buttons on window resize
        window.addEventListener('resize', updateScrollButtons);

        // Initial update
        setTimeout(updateScrollButtons, 100);
    });
</script>

<!-- Export Wizard Modal -->
<div id="exportWizardModal" class="export-wizard-modal" style="display: none;">
    <div class="export-wizard-content">
        <div class="export-wizard-header">
            <h3>Ticket Export Wizard</h3>
            <button type="button" onclick="hideExportWizard()" class="close-button">&times;</button>
        </div>

        <form id="exportForm" class="export-wizard-body">
            <!-- Export Mode Selection -->
            <div class="export-section">
                <label class="export-label">Export Mode:</label>
                <select id="exportMode" name="exportMode" onchange="toggleExportMode()" class="export-select">
                    <option value="all">Export All Tickets</option>
                    <option value="filtered">Export by Filters</option>
                    <option value="selected">Export Selected Tickets</option>
                </select>
            </div>

            <!-- Filter Export Section -->
            <div id="filterExportSection" class="export-section" style="display: none;">
                <h4 class="export-subsection-title">Filter Options</h4>

                <div class="export-filter-grid">
                    <div class="export-filter-group">
                        <label class="export-label">Date Range:</label>
                        <div class="date-range-inputs">
                            <input type="date" name="dateFrom" class="export-input" placeholder="From" onchange="refreshPreviewIfVisible()">
                            <span class="date-separator">to</span>
                            <input type="date" name="dateTo" class="export-input" placeholder="To" onchange="refreshPreviewIfVisible()">
                        </div>
                    </div>

                    <div class="export-filter-group">
                        <label class="export-label">Category:</label>
                        <select id="exportCategoryFilter" name="categoryFilter" class="export-select" onchange="refreshPreviewIfVisible()">
                            <option value="all">All Categories</option>
                        </select>
                    </div>

                    <div class="export-filter-group">
                        <label class="export-label">Priority:</label>
                        <select id="exportPriorityFilter" name="priorityFilter" class="export-select" onchange="refreshPreviewIfVisible()">
                            <option value="all">All Priorities</option>
                        </select>
                    </div>

                    <div class="export-filter-group">
                        <label class="export-label">Status:</label>
                        <select id="exportStatusFilter" name="statusFilter" class="export-select" onchange="refreshPreviewIfVisible()">
                            <option value="all">All Statuses</option>
                            <option value="New">New</option>
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Waiting">Waiting</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>

                    <div class="export-filter-group">
                        <label class="export-label">Country:</label>
                        <select id="exportCountryFilter" name="countryFilter" class="export-select" onchange="refreshPreviewIfVisible()">
                            <option value="all">All Countries</option>
                            <option value="USA">USA</option>
                            <option value="JAPAN">Japan</option>
                            <option value="PHILIPPINES">Philippines</option>
                            <option value="AUSTRALIA">Australia</option>
                            <option value="ISRAEL">Israel</option>
                            <option value="INDIA">India</option>
                            <option value="TAIWAN">Taiwan</option>
                            <option value="CHINA">China</option>
                            <option value="HONG_KONG">Hong Kong</option>
                            <option value="MALAYSIA">Malaysia</option>
                            <option value="THAILAND">Thailand</option>
                            <option value="VIETNAM">Vietnam</option>
                            <option value="SOUTH_KOREA">South Korea</option>
                            <option value="INDONESIA">Indonesia</option>
                            <option value="CANADA">Canada</option>
                            <option value="SINGAPORE">Singapore</option>
                            <option value="IN">IN</option>
                            <option value="SG">SG</option>
                        </select>
                    </div>

                    <div class="export-filter-group">
                        <label class="export-label">Company:</label>
                        <select id="exportCompanyFilter" name="companyFilter" class="export-select" onchange="refreshPreviewIfVisible()">
                            <option value="all">All Companies</option>
                            <!-- Companies will be loaded dynamically -->
                        </select>
                    </div>
                </div>
            </div>

            <!-- Selection Export Section -->
            <div id="selectionExportSection" class="export-section" style="display: none;">
                <div class="selection-header">
                    <h4 class="export-subsection-title">Select Tickets to Export</h4>
                    <div class="selection-actions">
                        <button type="button" onclick="selectAllTickets()" class="selection-button">Select All</button>
                        <button type="button" onclick="clearSelectedTickets()" class="selection-button">Clear All</button>
                    </div>
                </div>

                <!-- Search Box -->
                <div class="ticket-search-container" style="margin-bottom: 16px;">
                    <input type="text"
                           id="ticketSearchInput"
                           class="ticket-search-input"
                           placeholder="Search by ticket number or title..."
                           onkeyup="filterTicketList()">
                    <i class="fas fa-search ticket-search-icon"></i>
                </div>

                <div id="ticketSelectionList" class="ticket-selection-container">
                    <!-- Ticket checkboxes will be populated here -->
                </div>
            </div>

            <!-- Preview Section -->
            <div id="exportPreviewSection" class="export-section" style="display: none;">
                <div class="preview-header">
                    <h4 class="export-subsection-title">Export Preview</h4>
                    <div class="preview-summary">
                        <span id="previewCount" class="preview-count">0 tickets</span> will be exported
                    </div>
                </div>

                <div id="previewTableContainer" class="preview-table-container">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Ticket ID</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Category</th>
                                <th>Created Date</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- Preview ticket rows will be populated here -->
                        </tbody>
                    </table>

                    <div id="previewEmptyState" class="preview-empty-state" style="display: none;">
                        <i class="fas fa-inbox" style="font-size: 48px; color: #d1d5db; margin-bottom: 16px;"></i>
                        <p class="text-gray-500">No tickets match your current selection criteria.</p>
                    </div>
                </div>
            </div>
        </form>

        <div class="export-wizard-footer">
            <button type="button" onclick="hideExportWizard()" class="wizard-button cancel-button">Cancel</button>
            <button type="button" onclick="showPreview()" id="previewButton" class="wizard-button preview-button">Preview Export</button>
            <button type="button" onclick="executeExport()" id="exportButton" class="wizard-button export-button" style="display: none;">Export to CSV</button>
        </div>
    </div>
</div>

<style>
/* Export Wizard Modal Styles */
.export-wizard-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.export-wizard-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.export-wizard-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f9fafb;
    border-radius: 8px 8px 0 0;
}

.export-wizard-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
}

.close-button {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6b7280;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
}

.close-button:hover {
    background: #f3f4f6;
    color: #374151;
}

.export-wizard-body {
    padding: 24px;
}

.export-section {
    margin-bottom: 24px;
}

.export-label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
}

.export-select, .export-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 14px;
    background: white;
}

.export-select:focus, .export-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.export-subsection-title {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 16px;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 8px;
}

.export-filter-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.export-filter-group {
    display: flex;
    flex-direction: column;
}

.date-range-inputs {
    display: flex;
    align-items: center;
    gap: 8px;
}

.date-separator {
    color: #6b7280;
    font-size: 14px;
}

.selection-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.selection-actions {
    display: flex;
    gap: 8px;
}

.selection-button {
    padding: 6px 12px;
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    color: #374151;
}

.selection-button:hover {
    background: #e5e7eb;
}

.ticket-search-container {
    position: relative;
    padding: 0 24px;
}

.ticket-search-input {
    width: 100%;
    padding: 10px 40px 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 14px;
    background: white;
}

.ticket-search-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.ticket-search-icon {
    position: absolute;
    right: 36px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    pointer-events: none;
}

.ticket-selection-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    padding: 12px;
    background: #f9fafb;
}

.ticket-selection-item {
    margin-bottom: 8px;
    padding: 8px;
    background: white;
    border-radius: 4px;
    border: 1px solid #e5e7eb;
}

.ticket-selection-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
}

.ticket-selection-label input[type="checkbox"] {
    margin-right: 12px;
}

.ticket-info {
    flex: 1;
}

.ticket-status {
    float: right;
    font-size: 12px;
    color: #6b7280;
    background: #f3f4f6;
    padding: 2px 8px;
    border-radius: 12px;
}

.export-wizard-footer {
    padding: 20px 24px;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    border-radius: 0 0 8px 8px;
}

.wizard-button {
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid;
    transition: all 0.2s;
}

.cancel-button {
    background: white;
    color: #374151;
    border-color: #d1d5db;
}

.cancel-button:hover {
    background: #f9fafb;
}

.export-button {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.export-button:hover {
    background: #2563eb;
    border-color: #2563eb;
}

.preview-button {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.preview-button:hover {
    background: #059669;
    border-color: #059669;
}

/* Preview Section Styles */
.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.preview-summary {
    display: flex;
    align-items: center;
    gap: 12px;
}

.preview-count {
    font-weight: 600;
    color: #059669;
    background: #ecfdf5;
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid #d1fae5;
}

.preview-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: white;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.preview-table thead {
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    position: sticky;
    top: 0;
}

.preview-table th {
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-right: 1px solid #e5e7eb;
}

.preview-table th:last-child {
    border-right: none;
}

.preview-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #f3f4f6;
    border-right: 1px solid #f3f4f6;
    color: #374151;
}

.preview-table td:last-child {
    border-right: none;
}

.preview-table tbody tr:hover {
    background: #f9fafb;
}

.preview-table .ticket-id {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    color: #3b82f6;
}

.preview-table .ticket-subject {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.preview-table .status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
}

.preview-table .priority-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
}

.preview-empty-state {
    text-align: center;
    padding: 48px 24px;
    color: #6b7280;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .export-filter-grid {
        grid-template-columns: 1fr;
    }

    .date-range-inputs {
        flex-direction: column;
        align-items: stretch;
    }

    .date-separator {
        text-align: center;
        margin: 4px 0;
    }

    .selection-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }

    .export-wizard-content {
        width: 95%;
        margin: 20px;
    }
}

/* Queue delete button */
.queue-delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(239, 68, 68, 0.9);
    border: none;
    border-radius: 4px;
    padding: 6px;
    color: white;
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s;
    z-index: 10;
}

.queue-card:hover .queue-delete-btn {
    opacity: 1;
}

.queue-delete-btn:hover {
    background: rgba(220, 38, 38, 1);
    transform: scale(1.1);
}
</style>

<!-- Create Queue Modal -->
<div id="createQueueModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Create New Queue</h3>
        </div>
        <form id="createQueueForm" onsubmit="createQueue(event)">
            <div class="px-6 py-4">
                <label for="queueName" class="block text-sm font-medium text-gray-700 mb-2">Queue Name</label>
                <input type="text" id="queueName" name="name" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Enter queue name">
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-2 rounded-b-lg">
                <button type="button" onclick="hideCreateQueueModal()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-500 rounded-md hover:bg-blue-600">
                    Create Queue
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Show create queue modal
function showCreateQueueModal() {
    document.getElementById('createQueueModal').style.display = 'flex';
    document.getElementById('queueName').focus();
}

// Hide create queue modal
function hideCreateQueueModal() {
    document.getElementById('createQueueModal').style.display = 'none';
    document.getElementById('createQueueForm').reset();
}

// Get CSRF token from meta tag or cookie
function getCsrfToken() {
    // Try to get from meta tag first
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }

    // Try to get from cookie
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrf_token='));
    if (cookieValue) {
        return cookieValue.split('=')[1];
    }

    return null;
}

// Create queue
async function createQueue(event) {
    event.preventDefault();

    const queueName = document.getElementById('queueName').value.trim();

    if (!queueName) {
        alert('Please enter a queue name');
        return;
    }

    try {
        console.log('Creating queue:', queueName);

        const csrfToken = getCsrfToken();
        const headers = {
            'Content-Type': 'application/json',
        };

        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        const response = await fetch('/tickets/queues/create', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ name: queueName })
        });

        console.log('Response status:', response.status);

        // Read response as text first
        const responseText = await response.text();
        console.log('Response text:', responseText);

        // Try to parse as JSON
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            console.error('Failed to parse JSON:', e);
            alert('Server error: ' + responseText);
            return;
        }

        console.log('Response data:', data);

        if (data.success) {
            alert('Queue created successfully!');
            hideCreateQueueModal();
            // Reload page to show new queue
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to create queue'));
        }
    } catch (error) {
        console.error('Error creating queue:', error);
        alert('Failed to create queue. Error: ' + error.message);
    }
}

// Delete queue
async function deleteQueue(queueId, queueName) {
    if (!confirm(`Are you sure you want to delete the queue "${queueName}"?\n\nThis action cannot be undone.`)) {
        return;
    }

    try {
        console.log('Deleting queue:', queueId, queueName);

        const csrfToken = getCsrfToken();
        const headers = {
            'Content-Type': 'application/json',
        };

        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        const response = await fetch(`/tickets/queues/${queueId}/delete`, {
            method: 'POST',
            headers: headers,
        });

        console.log('Response status:', response.status);

        // Read response as text first
        const responseText = await response.text();
        console.log('Response text:', responseText);

        // Try to parse as JSON
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            console.error('Failed to parse JSON:', e);
            alert('Server error: ' + responseText);
            return;
        }

        console.log('Response data:', data);

        if (data.success) {
            alert('Queue deleted successfully!');
            // Reload page to update queue list
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete queue'));
        }
    } catch (error) {
        console.error('Error deleting queue:', error);
        alert('Failed to delete queue. Error: ' + error.message);
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('createQueueModal');
    if (event.target === modal) {
        hideCreateQueueModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        hideCreateQueueModal();
    }
});
</script>

{% endblock %} 