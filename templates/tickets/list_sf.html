{% extends "base.html" %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="{{ url_for('static', filename='css/queue_manager.css') }}" rel="stylesheet" />
<style>
    /* Salesforce-style colors */
    :root {
        --sf-blue: #0176d3;
        --sf-blue-dark: #014486;
        --sf-blue-light: #1b96ff;
        --sf-gray-100: #f3f3f3;
        --sf-gray-200: #e5e5e5;
        --sf-gray-300: #c9c9c9;
        --sf-gray-600: #706e6b;
        --sf-gray-800: #3e3e3c;
        --sf-success: #2e844a;
        --sf-warning: #fe9339;
        --sf-error: #ea001e;
        --sf-purple: #9050e9;
        --sf-teal: #0b827c;
    }

    /* Main layout */
    .sf-page {
        background: var(--sf-gray-100);
        min-height: 100vh;
    }

    /* Header bar */
    .sf-header {
        background: white;
        border-bottom: 1px solid var(--sf-gray-200);
        padding: 0.75rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .sf-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .sf-breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--sf-gray-600);
    }

    .sf-breadcrumb a {
        color: var(--sf-blue);
        text-decoration: none;
    }

    .sf-breadcrumb a:hover {
        text-decoration: underline;
    }

    .sf-page-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--sf-gray-800);
    }

    .sf-header-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sf-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
        font-weight: 600;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.15s ease;
        border: 1px solid transparent;
        text-decoration: none;
    }

    .sf-btn-neutral {
        background: white;
        border-color: var(--sf-gray-300);
        color: var(--sf-gray-800);
    }

    .sf-btn-neutral:hover {
        background: var(--sf-gray-100);
    }

    .sf-btn-brand {
        background: var(--sf-blue);
        color: white;
    }

    .sf-btn-brand:hover {
        background: var(--sf-blue-dark);
        color: white;
    }

    .sf-btn-success {
        background: var(--sf-success);
        color: white;
    }

    .sf-btn-success:hover {
        background: #236839;
    }

    /* Main content area */
    .sf-content {
        display: flex;
        height: calc(100vh - 60px);
    }

    /* Filters sidebar */
    .sf-sidebar {
        width: 280px;
        background: white;
        border-right: 1px solid var(--sf-gray-200);
        overflow-y: auto;
        flex-shrink: 0;
        transition: width 0.2s ease;
    }

    .sf-sidebar.collapsed {
        width: 0;
        overflow: hidden;
    }

    .sf-sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--sf-gray-100);
    }

    .sf-sidebar-title {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--sf-gray-600);
    }

    .sf-filter-section {
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-filter-header {
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
    }

    .sf-filter-header:hover {
        background: var(--sf-gray-100);
    }

    .sf-filter-label {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--sf-gray-800);
    }

    .sf-filter-count {
        font-size: 0.75rem;
        color: var(--sf-gray-600);
        background: var(--sf-gray-200);
        padding: 0.125rem 0.5rem;
        border-radius: 1rem;
    }

    .sf-filter-content {
        padding: 0 1rem 1rem;
        max-height: 200px;
        overflow-y: auto;
    }

    .sf-filter-content.collapsed {
        display: none;
    }

    .sf-checkbox-item {
        display: flex;
        align-items: center;
        padding: 0.375rem 0;
        font-size: 0.8125rem;
        color: var(--sf-gray-800);
    }

    .sf-checkbox-item input {
        margin-right: 0.5rem;
        accent-color: var(--sf-blue);
    }

    .sf-checkbox-item .count {
        margin-left: auto;
        font-size: 0.75rem;
        color: var(--sf-gray-600);
    }

    /* Search input */
    .sf-search-section {
        padding: 1rem;
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-search-input {
        width: 100%;
        padding: 0.5rem;
        font-size: 0.8125rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
    }

    .sf-search-input:focus {
        outline: none;
        border-color: var(--sf-blue);
        box-shadow: 0 0 0 2px rgba(1, 118, 211, 0.2);
    }

    .sf-bulk-search-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.375rem 0.75rem;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--sf-gray-700);
        background: var(--sf-gray-100);
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.15s;
    }

    .sf-bulk-search-btn:hover {
        background: var(--sf-gray-200);
        border-color: var(--sf-gray-400);
    }

    .sf-bulk-search-btn svg {
        width: 14px;
        height: 14px;
    }

    .sf-clear-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.375rem;
        margin-top: 0.5rem;
        color: var(--sf-gray-500);
        background: transparent;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.15s;
    }

    .sf-clear-btn:hover {
        color: var(--sf-red);
        border-color: var(--sf-red);
    }

    .sf-clear-btn svg {
        width: 14px;
        height: 14px;
    }

    .sf-bulk-search-container {
        width: 100%;
    }

    .sf-bulk-search-textarea {
        width: 100%;
        height: 80px;
        padding: 0.5rem;
        font-size: 0.8125rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
        resize: vertical;
        font-family: inherit;
    }

    .sf-bulk-search-textarea:focus {
        outline: none;
        border-color: var(--sf-blue);
        box-shadow: 0 0 0 2px rgba(1, 118, 211, 0.2);
    }

    .sf-bulk-search-info {
        margin-top: 0.25rem;
        font-size: 0.6875rem;
        color: var(--sf-gray-500);
    }

    .sf-bulk-search-matches {
        margin-left: 0.5rem;
        font-weight: 600;
        color: var(--sf-blue);
    }

    /* Date filter */
    .sf-date-filter {
        padding: 1rem;
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-date-filter label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--sf-gray-600);
        margin-bottom: 0.25rem;
    }

    .sf-date-filter input {
        width: 100%;
        padding: 0.375rem 0.5rem;
        font-size: 0.8125rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
    }

    /* Main area */
    .sf-main {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background: var(--sf-gray-100);
    }

    /* Summary cards */
    .sf-summary-cards {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 1400px) {
        .sf-summary-cards {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 900px) {
        .sf-summary-cards {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .sf-summary-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.25rem;
        border: 1px solid var(--sf-gray-200);
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .sf-summary-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .sf-summary-card.highlight {
        border-left: 4px solid var(--sf-blue);
    }

    .sf-summary-card.active {
        border-color: var(--sf-blue);
        box-shadow: 0 0 0 2px rgba(1, 118, 211, 0.3);
    }

    .sf-summary-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--sf-gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .sf-summary-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--sf-gray-800);
    }

    .sf-summary-value.blue { color: var(--sf-blue); }
    .sf-summary-value.green { color: var(--sf-success); }
    .sf-summary-value.orange { color: var(--sf-warning); }
    .sf-summary-value.red { color: var(--sf-error); }
    .sf-summary-value.purple { color: var(--sf-purple); }
    .sf-summary-value.teal { color: var(--sf-teal); }

    .sf-summary-subtitle {
        font-size: 0.75rem;
        color: var(--sf-gray-600);
        margin-top: 0.25rem;
    }

    /* Charts section */
    .sf-charts-section {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 1200px) {
        .sf-charts-section {
            grid-template-columns: 1fr;
        }
    }

    .sf-chart-container {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid var(--sf-gray-200);
    }

    .sf-chart-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .sf-chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--sf-gray-800);
    }

    .sf-chart-body {
        padding: 1rem;
        height: 250px;
        position: relative;
    }

    /* Data table */
    .sf-table-container {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid var(--sf-gray-200);
        overflow: hidden;
    }

    .sf-table-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .sf-table-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--sf-gray-800);
    }

    .sf-table-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sf-table {
        width: 100%;
        border-collapse: collapse;
    }

    .sf-table th {
        background: var(--sf-gray-100);
        padding: 0.75rem 1rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--sf-gray-600);
        border-bottom: 1px solid var(--sf-gray-200);
        cursor: pointer;
        white-space: nowrap;
    }

    .sf-table th:hover {
        background: var(--sf-gray-200);
    }

    .sf-table th.sortable::after {
        content: ' \2195';
        opacity: 0.4;
    }

    .sf-table th.sorted-asc::after {
        content: ' \2191';
        opacity: 1;
    }

    .sf-table th.sorted-desc::after {
        content: ' \2193';
        opacity: 1;
    }

    .sf-table td {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: var(--sf-gray-800);
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-table tr:hover {
        background: var(--sf-gray-100);
    }

    .sf-table-link {
        color: var(--sf-blue);
        text-decoration: none;
        font-weight: 500;
    }

    .sf-table-link:hover {
        text-decoration: underline;
    }

    /* Status badges */
    .sf-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.625rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 0.25rem;
        white-space: nowrap;
    }

    .sf-badge-open { background: #e8f4ff; color: #0176d3; }
    .sf-badge-inprogress { background: #fff3cd; color: #856404; }
    .sf-badge-onhold { background: #f8d7da; color: #721c24; }
    .sf-badge-resolved { background: #d4edda; color: #155724; }
    .sf-badge-closed { background: #e2e3e5; color: #383d41; }

    /* Priority badges */
    .sf-priority-low { background: #d4edda; color: #155724; }
    .sf-priority-medium { background: #fff3cd; color: #856404; }
    .sf-priority-high { background: #f8d7da; color: #721c24; }
    .sf-priority-urgent { background: #ea001e; color: white; }

    /* Toggle sidebar button */
    .sf-toggle-sidebar {
        position: fixed;
        left: 290px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 48px;
        background: white;
        border: 1px solid var(--sf-gray-200);
        border-left: none;
        border-radius: 0 4px 4px 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        transition: left 0.2s ease;
    }

    .sf-toggle-sidebar.collapsed {
        left: 0;
    }

    .sf-toggle-sidebar:hover {
        background: var(--sf-gray-100);
    }

    /* Pagination */
    .sf-pagination {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--sf-gray-200);
    }

    .sf-pagination-info {
        font-size: 0.8125rem;
        color: var(--sf-gray-600);
    }

    .sf-pagination-controls {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .sf-pagination-btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
        background: white;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
        cursor: pointer;
    }

    .sf-pagination-btn:hover {
        background: var(--sf-gray-100);
    }

    .sf-pagination-btn.active {
        background: var(--sf-blue);
        color: white;
        border-color: var(--sf-blue);
    }

    .sf-pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Loading */
    .sf-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--sf-gray-600);
    }

    .sf-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--sf-gray-200);
        border-top-color: var(--sf-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* No data */
    .sf-no-data {
        text-align: center;
        padding: 3rem;
        color: var(--sf-gray-600);
    }

    .sf-no-data i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Chart toggle */
    .sf-chart-toggle {
        display: flex;
        gap: 0.25rem;
    }

    .sf-chart-toggle button {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        background: white;
        border: 1px solid var(--sf-gray-300);
        cursor: pointer;
    }

    .sf-chart-toggle button:first-child {
        border-radius: 0.25rem 0 0 0.25rem;
    }

    .sf-chart-toggle button:last-child {
        border-radius: 0 0.25rem 0.25rem 0;
    }

    .sf-chart-toggle button.active {
        background: var(--sf-blue);
        color: white;
        border-color: var(--sf-blue);
    }

    /* Queue Selector Bar */
    .sf-queue-bar {
        background: white;
        border: 1px solid var(--sf-gray-200);
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        overflow: hidden;
    }

    .sf-queue-bar-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: var(--sf-gray-700);
        font-size: 0.875rem;
        white-space: nowrap;
        padding-right: 1rem;
        border-right: 1px solid var(--sf-gray-200);
    }

    .sf-queue-bar-title i {
        color: var(--sf-blue);
    }

    .sf-queue-tabs {
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
        padding-bottom: 0.25rem;
        flex: 1;
        cursor: grab;
        user-select: none;
        -webkit-user-select: none;
    }

    .sf-queue-tabs:active {
        cursor: grabbing;
    }

    .sf-queue-tabs.dragging {
        cursor: grabbing;
        scroll-behavior: auto;
    }

    .sf-queue-tabs::-webkit-scrollbar {
        height: 4px;
    }

    .sf-queue-tabs::-webkit-scrollbar-track {
        background: var(--sf-gray-100);
        border-radius: 2px;
    }

    .sf-queue-tabs::-webkit-scrollbar-thumb {
        background: var(--sf-gray-300);
        border-radius: 2px;
    }

    /* Queue Manager Button */
    .sf-queue-manage-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: 1px solid var(--sf-gray-200);
        border-radius: 0.375rem;
        background: white;
        color: var(--sf-gray-600);
        cursor: pointer;
        transition: all 0.15s ease;
        flex-shrink: 0;
    }

    .sf-queue-manage-btn:hover {
        background: var(--sf-gray-100);
        color: var(--sf-blue);
        border-color: var(--sf-blue);
    }

    .sf-queue-manage-btn svg {
        width: 16px;
        height: 16px;
    }

    .sf-queue-tab {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--sf-gray-100);
        border: 1px solid var(--sf-gray-200);
        border-radius: 2rem;
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
        font-size: 0.8125rem;
        color: var(--sf-gray-700);
    }

    .sf-queue-tab:hover {
        background: var(--sf-gray-200);
        border-color: var(--sf-gray-300);
    }

    .sf-queue-tab.active {
        background: var(--sf-blue);
        border-color: var(--sf-blue);
        color: white;
    }

    .sf-queue-tab .queue-name {
        font-weight: 500;
    }

    .sf-queue-tab .queue-count {
        display: flex;
        align-items: center;
        gap: 0.125rem;
        font-size: 0.75rem;
        opacity: 0.9;
    }

    .sf-queue-tab .open-count {
        font-weight: 700;
    }

    .sf-queue-tab .total-count {
        opacity: 0.7;
    }

    .sf-queue-tab.active .queue-count {
        background: rgba(255,255,255,0.2);
        padding: 0.125rem 0.375rem;
        border-radius: 1rem;
    }

    /* Folder Tab Styles - just color override */
    .sf-queue-tab.sf-folder-tab {
        background: #f59e0b;
        border-color: #d97706;
        color: white;
    }

    .sf-queue-tab.sf-folder-tab:hover {
        background: #d97706;
        border-color: #b45309;
    }

    .sf-queue-tab.sf-folder-tab.active {
        background: #b45309;
        border-color: #92400e;
    }

    /* Back button for folder view */
    .sf-folder-back-btn {
        display: none;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 0.75rem;
        background: var(--sf-gray-600);
        border: 1px solid var(--sf-gray-600);
        border-radius: 2rem;
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
        font-size: 0.8125rem;
        color: white;
        font-weight: 500;
    }

    .sf-folder-back-btn:hover {
        background: var(--sf-gray-800);
        border-color: var(--sf-gray-800);
    }

    .sf-folder-back-btn i {
        font-size: 0.75rem;
    }

    /* Folder queues - hidden by default */
    .sf-queue-tab.folder-queue {
        display: none;
    }

    /* When folder is expanded - hide all except folder-queue tabs */
    .sf-queue-tabs.folder-expanded .sf-queue-tab:not(.folder-queue) {
        display: none;
    }

    .sf-queue-tabs.folder-expanded .sf-queue-tab.folder-queue {
        display: flex;
    }

    .sf-queue-tabs.folder-expanded .sf-folder-back-btn {
        display: flex;
    }

    /* Import Dropdown */
    .sf-dropdown {
        position: relative;
        display: inline-block;
    }

    .sf-dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid var(--sf-gray-200);
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 200px;
        z-index: 1000;
        margin-top: 0.25rem;
        padding: 0.5rem 0;
    }

    .sf-dropdown-menu.show {
        display: block;
    }

    .sf-dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.625rem 1rem;
        color: var(--sf-gray-700);
        text-decoration: none;
        font-size: 0.875rem;
        transition: background 0.15s ease;
    }

    .sf-dropdown-item:hover {
        background: var(--sf-gray-100);
        color: var(--sf-blue);
    }

    .sf-dropdown-item i {
        width: 1rem;
        text-align: center;
        color: var(--sf-gray-500);
    }

    .sf-dropdown-item:hover i {
        color: var(--sf-blue);
    }

    .sf-dropdown-divider {
        height: 1px;
        background: var(--sf-gray-200);
        margin: 0.5rem 0;
    }

    .sf-dropdown-divider-label {
        padding: 0.375rem 1rem;
        font-size: 0.6875rem;
        font-weight: 700;
        color: var(--sf-gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* ============================================
       Monday.com-style Board Module
       ============================================ */
    .monday-board {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid var(--sf-gray-200);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .monday-board-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .monday-board-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--sf-gray-800);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .monday-board-title i {
        color: var(--sf-blue);
    }

    .monday-board-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .monday-board-toggle {
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
        background: white;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
        cursor: pointer;
        color: var(--sf-gray-600);
        transition: all 0.15s ease;
    }

    .monday-board-toggle:hover {
        background: var(--sf-gray-100);
        color: var(--sf-blue);
    }

    .monday-board-toggle.active {
        background: var(--sf-blue);
        color: white;
        border-color: var(--sf-blue);
    }

    .monday-board-content {
        overflow-x: auto;
    }

    .monday-board-table {
        width: 100%;
        min-width: 1200px;
        border-collapse: collapse;
    }

    .monday-board-table th {
        background: var(--sf-gray-100);
        padding: 0.625rem 0.75rem;
        text-align: left;
        font-size: 0.6875rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--sf-gray-600);
        border-bottom: 1px solid var(--sf-gray-200);
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .monday-board-table th:first-child {
        background: var(--sf-gray-100);
        position: sticky;
        left: 0;
        z-index: 20;
        min-width: 250px;
    }

    /* Group Row */
    .monday-group-row {
        background: linear-gradient(90deg, var(--group-color, var(--sf-blue)) 4px, white 4px);
    }

    .monday-group-row td {
        padding: 0;
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .monday-group-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        cursor: pointer;
        user-select: none;
    }

    .monday-group-header:hover {
        background: var(--sf-gray-100);
    }

    .monday-group-chevron {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--sf-gray-500);
        transition: transform 0.2s ease;
    }

    .monday-group-chevron.collapsed {
        transform: rotate(-90deg);
    }

    .monday-group-name {
        font-weight: 600;
        font-size: 0.9375rem;
        color: var(--group-color, var(--sf-blue));
    }

    .monday-group-count {
        font-size: 0.75rem;
        color: var(--sf-gray-500);
        background: var(--sf-gray-100);
        padding: 0.125rem 0.5rem;
        border-radius: 1rem;
    }

    /* Item Row */
    .monday-item-row {
        background: linear-gradient(90deg, var(--group-color, var(--sf-blue)) 4px, white 4px);
        transition: background 0.15s ease;
    }

    .monday-item-row:hover {
        background: linear-gradient(90deg, var(--group-color, var(--sf-blue)) 4px, var(--sf-gray-100) 4px);
    }

    .monday-item-row td {
        padding: 0.5rem 0.75rem;
        font-size: 0.8125rem;
        color: var(--sf-gray-800);
        border-bottom: 1px solid var(--sf-gray-200);
        vertical-align: middle;
    }

    .monday-item-row td:first-child {
        background: inherit;
        position: sticky;
        left: 0;
        z-index: 5;
    }

    .monday-item-row.collapsed {
        display: none;
    }

    .monday-item-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-left: 2rem;
    }

    .monday-item-link {
        color: var(--sf-blue);
        text-decoration: none;
        font-weight: 500;
    }

    .monday-item-link:hover {
        text-decoration: underline;
    }

    .monday-item-subject {
        color: var(--sf-gray-700);
        font-size: 0.75rem;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Date Pill Styles */
    .monday-date-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.625rem;
        border-radius: 1rem;
        font-size: 0.6875rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .monday-date-pill.blue {
        background: #e0f0ff;
        color: #0066cc;
    }

    .monday-date-pill.green {
        background: #d4edda;
        color: #155724;
    }

    .monday-date-pill.orange {
        background: #fff3cd;
        color: #856404;
    }

    .monday-date-pill.red {
        background: #f8d7da;
        color: #721c24;
    }

    .monday-date-pill.purple {
        background: #e8daff;
        color: #6f42c1;
    }

    .monday-date-pill.gray {
        background: var(--sf-gray-200);
        color: var(--sf-gray-600);
    }

    /* Status Cell */
    .monday-status-cell {
        display: flex;
        justify-content: center;
    }

    .monday-status {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.6875rem;
        font-weight: 600;
        text-align: center;
        min-width: 80px;
        white-space: nowrap;
    }

    .monday-status.pending {
        background: #e5e5e5;
        color: #706e6b;
    }

    .monday-status.in-transit {
        background: #fff3cd;
        color: #856404;
    }

    .monday-status.delivered {
        background: #d4edda;
        color: #155724;
    }

    .monday-status.failed {
        background: #f8d7da;
        color: #721c24;
    }

    .monday-status.out-for-delivery {
        background: #e0f0ff;
        color: #0066cc;
    }

    /* Label Cell */
    .monday-label {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        background: var(--sf-gray-100);
        border: 1px solid var(--sf-gray-200);
        border-radius: 0.25rem;
        font-size: 0.6875rem;
        color: var(--sf-gray-700);
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .monday-label i {
        font-size: 0.625rem;
        color: var(--sf-gray-500);
    }

    /* Progress Bar */
    .monday-progress-bar {
        width: 100%;
        height: 8px;
        background: var(--sf-gray-200);
        border-radius: 4px;
        overflow: hidden;
    }

    .monday-progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .monday-progress-fill.green {
        background: linear-gradient(90deg, #2e844a, #45b86c);
    }

    .monday-progress-fill.blue {
        background: linear-gradient(90deg, #0176d3, #45a4ff);
    }

    /* Empty State */
    .monday-empty-cell {
        color: var(--sf-gray-400);
        font-style: italic;
        font-size: 0.75rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .monday-board-table {
            min-width: 800px;
        }
    }

    /* Board collapsed state */
    .monday-board.collapsed .monday-board-content {
        display: none;
    }

    /* Group colors */
    .monday-group-row[data-group-color="blue"], .monday-item-row[data-group-color="blue"] {
        --group-color: #0176d3;
    }
    .monday-group-row[data-group-color="green"], .monday-item-row[data-group-color="green"] {
        --group-color: #2e844a;
    }
    .monday-group-row[data-group-color="orange"], .monday-item-row[data-group-color="orange"] {
        --group-color: #fe9339;
    }
    .monday-group-row[data-group-color="purple"], .monday-item-row[data-group-color="purple"] {
        --group-color: #9050e9;
    }
    .monday-group-row[data-group-color="red"], .monday-item-row[data-group-color="red"] {
        --group-color: #ea001e;
    }
    .monday-group-row[data-group-color="teal"], .monday-item-row[data-group-color="teal"] {
        --group-color: #0b827c;
    }
    .monday-group-row[data-group-color="pink"], .monday-item-row[data-group-color="pink"] {
        --group-color: #e91e63;
    }
    .monday-group-row[data-group-color="indigo"], .monday-item-row[data-group-color="indigo"] {
        --group-color: #3f51b5;
    }

    /* Folder and Queue row styles */
    .monday-folder-row .monday-group-header {
        font-weight: 600;
    }

    .monday-queue-row {
        background: linear-gradient(90deg, var(--group-color, var(--sf-blue)) 4px, #fafafa 4px);
    }

    .monday-queue-row.collapsed,
    .monday-group-row.collapsed {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="sf-page">
    <!-- Header -->
    <div class="sf-header">
        <div class="sf-header-left">
            <div class="sf-breadcrumb">
                <a href="{{ url_for('main.index') }}">Home</a>
                <span>/</span>
                <span>Tickets</span>
            </div>
            <h1 class="sf-page-title">
                <i class="fas fa-ticket-alt" style="color: var(--sf-blue);"></i>
                Ticket Management
            </h1>
        </div>
        <div class="sf-header-actions">
            <a href="{{ url_for('tickets.list_tickets') }}" class="sf-btn sf-btn-neutral">
                <i class="fas fa-exchange-alt"></i> Classic View
            </a>
            {% if current_user.is_super_admin or current_user.is_developer %}
            <a href="{{ url_for('tickets.ticket_manager') }}" class="sf-btn sf-btn-neutral" style="background: #8b5cf6; border-color: #8b5cf6; color: white;">
                <i class="fas fa-cog"></i> Ticket Manager
            </a>
            {% endif %}
            {% if current_user.is_admin or current_user.is_supervisor or current_user.is_developer %}
            <!-- Import/Export Dropdown -->
            <div class="sf-dropdown">
                <button class="sf-btn sf-btn-neutral" onclick="toggleImportDropdown(event)">
                    <i class="fas fa-file-import"></i> Import/Export <i class="fas fa-chevron-down" style="font-size: 0.625rem; margin-left: 0.25rem;"></i>
                </button>
                <div class="sf-dropdown-menu" id="importDropdown">
                    <div class="sf-dropdown-divider-label">Import</div>
                    {% if current_user.is_admin %}
                    <a href="{{ url_for('admin.csv_import') }}" class="sf-dropdown-item">
                        <i class="fas fa-upload"></i> Import CSV
                    </a>
                    {% endif %}
                    <a href="{{ url_for('tickets.bulk_import_asset_return') }}" class="sf-dropdown-item">
                        <i class="fas fa-undo"></i> Bulk Import Returns
                    </a>
                    <a href="{{ url_for('tickets.bulk_import_1stbase') }}" class="sf-dropdown-item">
                        <i class="fas fa-building"></i> 1stbase Import
                    </a>
                    <a href="{{ url_for('tickets.import_from_retool') }}" class="sf-dropdown-item">
                        <i class="fas fa-tools"></i> Import from Retool
                    </a>
                    <div class="sf-dropdown-divider"></div>
                    <div class="sf-dropdown-divider-label">Export</div>
                    <a href="{{ url_for('tickets.list_tickets_sf') }}?showExportWizard=true" class="sf-dropdown-item">
                        <i class="fas fa-download"></i> Ticket Export Wizard
                    </a>
                </div>
            </div>
            {% endif %}
            <a href="{{ url_for('tickets.create_ticket') }}" class="sf-btn sf-btn-brand">
                <i class="fas fa-plus"></i> New Ticket
            </a>
        </div>
    </div>

    <!-- Toggle sidebar button -->
    <button class="sf-toggle-sidebar" onclick="toggleSidebar()">
        <i class="fas fa-chevron-left" id="sidebarToggleIcon"></i>
    </button>

    <!-- Main content -->
    <div class="sf-content">
        <!-- Sidebar Filters -->
        <div class="sf-sidebar" id="filterSidebar">
            <div class="sf-sidebar-header">
                <span class="sf-sidebar-title">Filters</span>
                <button class="sf-btn sf-btn-neutral" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="clearFilters()">
                    Clear All
                </button>
            </div>

            <!-- Search -->
            <div class="sf-search-section" id="singleSearchSection">
                <input type="text" class="sf-search-input" placeholder="Search tickets..." id="searchInput" onkeyup="applyFilters()">
                <button class="sf-bulk-search-btn" onclick="toggleBulkSearch()" title="Switch to Bulk Search">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                    Bulk Search
                </button>
            </div>

            <!-- Bulk Search Section -->
            <div class="sf-search-section hidden" id="bulkSearchSection">
                <div class="sf-bulk-search-container">
                    <textarea id="bulkSearchInput"
                              placeholder="Enter multiple search terms (one per line or comma-separated)&#10;Can search: Ticket IDs, subjects, descriptions&#10;Example:&#10;T001&#10;T002, T003&#10;customer name"
                              class="sf-bulk-search-textarea"
                              oninput="bulkSearchTickets()"></textarea>
                    <div class="sf-bulk-search-info">
                        <span id="bulkSearchCount">0</span> search terms entered
                        <span id="bulkSearchMatches" class="sf-bulk-search-matches hidden"></span>
                    </div>
                </div>
                <button class="sf-bulk-search-btn" onclick="toggleBulkSearch()" title="Switch to Single Search">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Single Search
                </button>
                <button class="sf-clear-btn" onclick="clearBulkSearch()" title="Clear">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Date Filter -->
            <div class="sf-date-filter">
                <label>Date From</label>
                <input type="date" id="dateFrom" onchange="applyFilters()">
                <label>Date To</label>
                <input type="date" id="dateTo" onchange="applyFilters()">
            </div>

            <!-- Status Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('statusFilter')">
                    <span class="sf-filter-label">Status</span>
                    <span class="sf-filter-count" id="statusFilterCount">0</span>
                </div>
                <div class="sf-filter-content" id="statusFilter">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Priority Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('priorityFilter')">
                    <span class="sf-filter-label">Priority</span>
                    <span class="sf-filter-count" id="priorityFilterCount">0</span>
                </div>
                <div class="sf-filter-content" id="priorityFilter">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Category Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('categoryFilter')">
                    <span class="sf-filter-label">Category</span>
                    <span class="sf-filter-count" id="categoryFilterCount">0</span>
                </div>
                <div class="sf-filter-content" id="categoryFilter">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Queue Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('queueFilter')">
                    <span class="sf-filter-label">Queue</span>
                    <span class="sf-filter-count" id="queueFilterCount">0</span>
                </div>
                <div class="sf-filter-content" id="queueFilter">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Main Area -->
        <div class="sf-main">
            <!-- All Tickets Section -->
            <div class="sf-section-header" style="font-size: 0.75rem; font-weight: 600; color: var(--sf-gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                All Tickets
            </div>
            <div class="sf-summary-cards">
                <div class="sf-summary-card highlight" onclick="filterByStatus('all')">
                    <div class="sf-summary-label">Total</div>
                    <div class="sf-summary-value blue" id="totalCount">0</div>
                    <div class="sf-summary-subtitle">All tickets</div>
                </div>
                <div class="sf-summary-card" onclick="filterByStatus('OPEN')">
                    <div class="sf-summary-label">Open</div>
                    <div class="sf-summary-value orange" id="openCount">0</div>
                    <div class="sf-summary-subtitle">Awaiting action</div>
                </div>
                <div class="sf-summary-card" onclick="filterByStatus('IN_PROGRESS')">
                    <div class="sf-summary-label">In Progress</div>
                    <div class="sf-summary-value purple" id="inProgressCount">0</div>
                    <div class="sf-summary-subtitle">Being worked on</div>
                </div>
                <div class="sf-summary-card" onclick="filterByStatus('RESOLVED')">
                    <div class="sf-summary-label">Resolved</div>
                    <div class="sf-summary-value green" id="resolvedCount">0</div>
                    <div class="sf-summary-subtitle">Completed</div>
                </div>
                <div class="sf-summary-card" onclick="filterByStatus('ON_HOLD')">
                    <div class="sf-summary-label">On Hold</div>
                    <div class="sf-summary-value red" id="onHoldCount">0</div>
                    <div class="sf-summary-subtitle">Waiting</div>
                </div>
            </div>

            <!-- My Tickets Section -->
            <div class="sf-section-header" style="font-size: 0.75rem; font-weight: 600; color: var(--sf-gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; margin-top: 1rem;">
                My Tickets
            </div>
            <div class="sf-summary-cards">
                <div class="sf-summary-card" style="border-left: 4px solid var(--sf-purple);" onclick="filterByAssignee()">
                    <div class="sf-summary-label">Total</div>
                    <div class="sf-summary-value purple" id="myTotalCount">0</div>
                    <div class="sf-summary-subtitle">Assigned to me</div>
                </div>
                <div class="sf-summary-card" onclick="filterByAssigneeAndStatus('OPEN')">
                    <div class="sf-summary-label">Open</div>
                    <div class="sf-summary-value orange" id="myOpenCount">0</div>
                    <div class="sf-summary-subtitle">Need attention</div>
                </div>
                <div class="sf-summary-card" onclick="filterByAssigneeAndStatus('IN_PROGRESS')">
                    <div class="sf-summary-label">In Progress</div>
                    <div class="sf-summary-value purple" id="myInProgressCount">0</div>
                    <div class="sf-summary-subtitle">Working on</div>
                </div>
                <div class="sf-summary-card" onclick="filterByAssigneeAndStatus('ON_HOLD')">
                    <div class="sf-summary-label">On Hold</div>
                    <div class="sf-summary-value red" id="myOnHoldCount">0</div>
                    <div class="sf-summary-subtitle">Waiting</div>
                </div>
                <div class="sf-summary-card" onclick="filterByAssigneeAndStatus('RESOLVED')">
                    <div class="sf-summary-label">Resolved</div>
                    <div class="sf-summary-value green" id="myResolvedCount">0</div>
                    <div class="sf-summary-subtitle">Completed</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="sf-charts-section">
                <!-- Status Distribution Chart -->
                <div class="sf-chart-container">
                    <div class="sf-chart-header">
                        <span class="sf-chart-title">Status Distribution</span>
                        <div class="sf-chart-toggle">
                            <button class="active" onclick="changeChartType('statusChart', 'doughnut', this)">Donut</button>
                            <button onclick="changeChartType('statusChart', 'bar', this)">Bar</button>
                        </div>
                    </div>
                    <div class="sf-chart-body">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- Weekly Trend Chart -->
                <div class="sf-chart-container">
                    <div class="sf-chart-header">
                        <span class="sf-chart-title">Tickets This Week</span>
                        <div class="sf-chart-toggle">
                            <button class="active" onclick="changeChartType('trendChart', 'line', this)">Line</button>
                            <button onclick="changeChartType('trendChart', 'bar', this)">Bar</button>
                        </div>
                    </div>
                    <div class="sf-chart-body">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Monday.com-style Board -->
            <div class="monday-board" id="mondayBoard">
                <div class="monday-board-header">
                    <span class="monday-board-title">
                        <i class="fas fa-th-large"></i>
                        Ticket Progress Overview
                    </span>
                    <div class="monday-board-actions">
                        <button class="monday-board-toggle active" onclick="toggleBoardGrouping('folder')" id="groupByFolderBtn">
                            <i class="fas fa-folder"></i> By Folder
                        </button>
                        <button class="monday-board-toggle" onclick="toggleBoardGrouping('queue')" id="groupByQueueBtn">
                            <i class="fas fa-layer-group"></i> By Queue
                        </button>
                        <button class="monday-board-toggle" onclick="toggleBoardGrouping('category')" id="groupByCategoryBtn">
                            <i class="fas fa-tags"></i> By Category
                        </button>
                        <button class="monday-board-toggle" onclick="toggleBoardCollapse()" id="collapseBoardBtn">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                </div>
                <div class="monday-board-content">
                    <table class="monday-board-table">
                        <thead>
                            <tr>
                                <th>Ticket / Service Job</th>
                                <th>Outbound Initiated</th>
                                <th>Outbound Label</th>
                                <th>Outbound Status</th>
                                <th>Inbound Initiated</th>
                                <th>Inbound Label</th>
                                <th>Inbound Status</th>
                                <th>Received Date</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody id="mondayBoardBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Queue Selector Bar -->
            <div class="sf-queue-bar">
                <div class="sf-queue-bar-title">
                    <i class="fas fa-layer-group"></i>
                    <span>Queues</span>
                </div>
                <div class="sf-queue-tabs" id="queueTabs">
                    <!-- Back button (hidden by default, shown when folder expanded) -->
                    <button class="sf-folder-back-btn" onclick="closeFolderView()">
                        <i class="fas fa-arrow-left"></i>
                        <span>Back</span>
                    </button>
                    <button class="sf-queue-tab active" data-queue="all" onclick="filterByQueue('all', this)">
                        <span class="queue-name">All Queues</span>
                        <span class="queue-count" id="allQueuesCount">0</span>
                    </button>
                    {% if folders_data and (folders_data.folders or folders_data.unfiled_queues) %}
                        {# Show folders and queues organized by folder #}
                        {% for folder in folders_data.folders %}
                        {% set folder_queue_names = folder.queues | map(attribute='name') | list | join('|||') %}
                        <button type="button" class="sf-queue-tab sf-folder-tab" data-folder-id="{{ folder.id }}" data-queue-names="{{ folder_queue_names }}" onclick="expandFolder(this)">
                            <span class="queue-name">{{ folder.name }}</span>
                            <span class="queue-count">
                                <span class="open-count">{{ folder.open_count }}</span>
                                <span class="total-count">/ {{ folder.total_count }}</span>
                            </span>
                        </button>
                        {# Hidden queue tabs that appear when folder is expanded #}
                        {% for queue in folder.queues %}
                        <button class="sf-queue-tab folder-queue" data-queue="{{ queue.name }}" data-folder-id="{{ folder.id }}" onclick="filterByQueue('{{ queue.name }}', this)">
                            <span class="queue-name">{{ queue.name }}</span>
                            <span class="queue-count">
                                <span class="open-count">{{ queue_ticket_counts.get(queue.id, {}).get('open', 0) }}</span>
                                <span class="total-count">/ {{ queue_ticket_counts.get(queue.id, {}).get('total', 0) }}</span>
                            </span>
                        </button>
                        {% endfor %}
                        {% endfor %}
                        {# Show unfiled queues as individual tabs #}
                        {% for queue in folders_data.unfiled_queues %}
                        <button class="sf-queue-tab" data-queue="{{ queue.name }}" onclick="filterByQueue('{{ queue.name }}', this)">
                            <span class="queue-name">{{ queue.name }}</span>
                            <span class="queue-count">
                                <span class="open-count">{{ queue_ticket_counts.get(queue.id, {}).get('open', 0) }}</span>
                                <span class="total-count">/ {{ queue_ticket_counts.get(queue.id, {}).get('total', 0) }}</span>
                            </span>
                        </button>
                        {% endfor %}
                    {% else %}
                        {# Show individual queues for other users #}
                        {% for queue in queues %}
                        <button class="sf-queue-tab" data-queue="{{ queue.name }}" onclick="filterByQueue('{{ queue.name }}', this)">
                            <span class="queue-name">{{ queue.name }}</span>
                            <span class="queue-count">
                                <span class="open-count">{{ queue_ticket_counts.get(queue.id, {}).get('open', 0) }}</span>
                                <span class="total-count">/ {{ queue_ticket_counts.get(queue.id, {}).get('total', 0) }}</span>
                            </span>
                        </button>
                        {% endfor %}
                    {% endif %}
                </div>
                {% if current_user.is_super_admin or current_user.is_developer %}
                <button type="button" onclick="QueueManager.open()" class="sf-queue-manage-btn" title="Manage Queues">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </button>
                {% endif %}
            </div>

            <!-- Tickets Table -->
            <div class="sf-table-container">
                <div class="sf-table-header">
                    <span class="sf-table-title">
                        <span id="filteredCountLabel">All Tickets</span>
                        (<span id="displayedCount">0</span>)
                    </span>
                    <div class="sf-table-actions">
                        <select id="pageSize" onchange="changePageSize()" class="sf-btn sf-btn-neutral" style="padding: 0.375rem 0.5rem;">
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                </div>

                <div id="tableLoading" class="sf-loading" style="display: none;">
                    <div class="sf-spinner"></div>
                </div>

                <div id="tableContent">
                    <table class="sf-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="id" onclick="sortTable('id')">ID</th>
                                <th class="sortable" data-sort="subject" onclick="sortTable('subject')">Subject</th>
                                <th class="sortable" data-sort="category" onclick="sortTable('category')">Category</th>
                                <th class="sortable" data-sort="priority" onclick="sortTable('priority')">Priority</th>
                                <th class="sortable" data-sort="status" onclick="sortTable('status')">Status</th>
                                <th class="sortable" data-sort="queue" onclick="sortTable('queue')">Queue</th>
                                <th class="sortable" data-sort="created" onclick="sortTable('created')">Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ticketTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <div id="noDataMessage" class="sf-no-data" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <p>No tickets found matching your criteria</p>
                </div>

                <!-- Pagination -->
                <div class="sf-pagination">
                    <div class="sf-pagination-info">
                        Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalFiltered">0</span> tickets
                    </div>
                    <div class="sf-pagination-controls" id="paginationControls">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Queue Manager Modal (iOS-style) -->
{% if current_user.is_super_admin or current_user.is_developer %}
{% include 'tickets/partials/queue_manager.html' %}
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/queue_manager.js') }}"></script>
<script>
    // Initialize Queue Manager after DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof QueueManager !== 'undefined') {
            QueueManager.init('{{ csrf_token() }}');
        }
    });

    // Drag-to-scroll for queue tabs - initialized after DOM ready
    function initQueueTabsDrag() {
        const queueTabs = document.getElementById('queueTabs');
        if (!queueTabs) return;

        let isDown = false;
        let startX;
        let scrollLeft;
        let hasMoved = false;

        queueTabs.addEventListener('mousedown', (e) => {
            isDown = true;
            hasMoved = false;
            queueTabs.classList.add('dragging');
            startX = e.pageX - queueTabs.offsetLeft;
            scrollLeft = queueTabs.scrollLeft;
        });

        queueTabs.addEventListener('mouseleave', () => {
            isDown = false;
            queueTabs.classList.remove('dragging');
        });

        queueTabs.addEventListener('mouseup', (e) => {
            const wasDown = isDown;
            isDown = false;
            queueTabs.classList.remove('dragging');

            // If we dragged, prevent the click on buttons
            if (wasDown && hasMoved) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        queueTabs.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            hasMoved = true;
            const x = e.pageX - queueTabs.offsetLeft;
            const walk = (x - startX) * 1.5;
            queueTabs.scrollLeft = scrollLeft - walk;
        });

        // Prevent click if we were dragging
        queueTabs.addEventListener('click', (e) => {
            if (hasMoved) {
                e.preventDefault();
                e.stopPropagation();
                hasMoved = false;
            }
        }, true);
    }

    // Initialize drag on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initQueueTabsDrag);
    } else {
        initQueueTabsDrag();
    }

    // Global state
    let allTickets = [];
    let filteredTickets = [];
    let currentPage = 1;
    let pageSize = 25;
    let sortColumn = 'created';
    let sortDirection = 'desc';
    let statusChart = null;
    let trendChart = null;

    // Bulk search state
    let isBulkSearchMode = false;
    let bulkSearchTerms = [];

    // Custom statuses from database
    const customStatuses = {{ custom_statuses | tojson | safe }};

    // Current user's username for personal stats
    const currentUsername = {{ current_user.username | tojson }};

    // Status and priority mappings
    const statusColors = {
        'OPEN': { bg: '#e8f4ff', color: '#0176d3' },
        'IN_PROGRESS': { bg: '#fff3cd', color: '#856404' },
        'ON_HOLD': { bg: '#f8d7da', color: '#721c24' },
        'RESOLVED': { bg: '#d4edda', color: '#155724' },
        'RESOLVED_DELIVERED': { bg: '#d4edda', color: '#155724' },
        'CLOSED': { bg: '#e2e3e5', color: '#383d41' }
    };

    // Tailwind color name to hex mapping for custom statuses
    const tailwindColorMap = {
        'blue': '#3b82f6',
        'green': '#22c55e',
        'yellow': '#eab308',
        'red': '#ef4444',
        'purple': '#a855f7',
        'gray': '#6b7280',
        'orange': '#f97316',
        'pink': '#ec4899',
        'indigo': '#6366f1',
        'teal': '#14b8a6',
        'cyan': '#06b6d4'
    };

    // Predefined chart colors for dynamic assignment
    const chartColorPalette = [
        '#3b82f6',  // blue
        '#22c55e',  // green
        '#f97316',  // orange
        '#a855f7',  // purple
        '#ef4444',  // red
        '#eab308',  // yellow
        '#14b8a6',  // teal
        '#ec4899',  // pink
        '#6366f1',  // indigo
        '#06b6d4',  // cyan
    ];

    // Cache for dynamically assigned colors
    const statusColorCache = {};
    let colorIndex = 0;

    // Get color for a status (checks both base statuses and custom statuses)
    function getStatusColor(statusName) {
        // First check base statuses
        if (statusColors[statusName]) {
            return statusColors[statusName].bg;
        }

        // Check cache first
        if (statusColorCache[statusName]) {
            return statusColorCache[statusName];
        }

        // Check custom statuses for a specific color (not gray)
        const customStatus = customStatuses.find(cs => cs.name === statusName);
        if (customStatus && customStatus.color && customStatus.color !== 'gray') {
            const color = tailwindColorMap[customStatus.color];
            if (color) {
                statusColorCache[statusName] = color;
                return color;
            }
        }

        // Assign a unique color from palette for unknown/gray statuses
        const color = chartColorPalette[colorIndex % chartColorPalette.length];
        colorIndex++;
        statusColorCache[statusName] = color;
        return color;
    }

    const priorityColors = {
        'LOW': { bg: '#d4edda', color: '#155724' },
        'MEDIUM': { bg: '#fff3cd', color: '#856404' },
        'HIGH': { bg: '#f8d7da', color: '#721c24' },
        'URGENT': { bg: '#ea001e', color: 'white' }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadTickets();
    });

    // Load tickets from server
    function loadTickets() {
        document.getElementById('tableLoading').style.display = 'flex';
        document.getElementById('tableContent').style.display = 'none';

        // Parse tickets from template
        allTickets = [
            {% for ticket in tickets %}
            {
                id: {{ ticket.id }},
                subject: {{ ticket.subject | tojson }},
                category: {{ (ticket.category.value if ticket.category else None) | tojson }},
                priority: {{ (ticket.priority.value if ticket.priority else 'MEDIUM') | tojson }},
                status: {{ (ticket.custom_status if ticket.custom_status else (ticket.status.value if ticket.status else 'NEW')) | tojson }},
                queue: {{ (ticket.queue.name if ticket.queue else 'Unassigned') | tojson }},
                queue_id: {{ (ticket.queue_id if ticket.queue_id else None) | tojson }},
                created_at: {{ (ticket.created_at.isoformat() if ticket.created_at else None) | tojson }},
                updated_at: {{ (ticket.updated_at.isoformat() if ticket.updated_at else None) | tojson }},
                customer_name: {{ (ticket.customer.name if ticket.customer else '') | tojson }},
                assignee: {{ (ticket.assigned_to.username if ticket.assigned_to else '') | tojson }},
                // Outbound (shipping) tracking fields
                shipping_tracking: {{ (ticket.shipping_tracking if ticket.shipping_tracking else None) | tojson }},
                shipping_carrier: {{ (ticket.shipping_carrier if ticket.shipping_carrier else None) | tojson }},
                shipping_status: {{ (ticket.shipping_status if ticket.shipping_status else None) | tojson }},
                shipping_tracking_created_at: {{ (ticket.shipping_tracking_created_at.isoformat() if ticket.shipping_tracking_created_at else None) | tojson }},
                // Inbound (return) tracking fields
                return_tracking: {{ (ticket.return_tracking if ticket.return_tracking else None) | tojson }},
                return_carrier: {{ (ticket.return_carrier if ticket.return_carrier else None) | tojson }},
                return_status: {{ (ticket.return_status if ticket.return_status else None) | tojson }},
                // Case progress fields
                item_packed: {{ (ticket.item_packed if ticket.item_packed else False) | tojson }},
                item_packed_at: {{ (ticket.item_packed_at.isoformat() if ticket.item_packed_at else None) | tojson }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        document.getElementById('tableLoading').style.display = 'none';
        document.getElementById('tableContent').style.display = 'block';

        // Update "All Queues" count
        document.getElementById('allQueuesCount').textContent = allTickets.length;

        buildFilters();
        applyFilters();
        updateCharts();
        populateMondayBoard();
    }

    // Build filter checkboxes
    function buildFilters() {
        // Build status filter - include both ticket statuses and custom statuses
        const ticketStatuses = [...new Set(allTickets.map(t => t.status))].filter(s => s);

        // Add custom statuses that aren't already in the list
        const customStatusNames = customStatuses.map(cs => cs.name);
        const allStatuses = [...new Set([...ticketStatuses, ...customStatusNames])];

        const statusHtml = allStatuses.map(status => {
            const count = allTickets.filter(t => t.status === status).length;
            // Check if it's a custom status for styling
            const customStatus = customStatuses.find(cs => cs.name === status);
            const displayName = status.replace(/_/g, ' ');
            return `
                <label class="sf-checkbox-item">
                    <input type="checkbox" value="${status}" onchange="applyFilters()">
                    ${displayName}
                    <span class="count">${count}</span>
                </label>
            `;
        }).join('');
        document.getElementById('statusFilter').innerHTML = statusHtml;

        // Build priority filter
        const priorities = [...new Set(allTickets.map(t => t.priority))].filter(p => p);
        const priorityHtml = priorities.map(priority => {
            const count = allTickets.filter(t => t.priority === priority).length;
            return `
                <label class="sf-checkbox-item">
                    <input type="checkbox" value="${priority}" onchange="applyFilters()">
                    ${priority}
                    <span class="count">${count}</span>
                </label>
            `;
        }).join('');
        document.getElementById('priorityFilter').innerHTML = priorityHtml;

        // Build category filter (hide PIN_REQUEST from filter)
        const categories = [...new Set(allTickets.map(t => t.category))].filter(c => c && c !== 'PIN_REQUEST');
        const categoryHtml = categories.map(category => {
            const count = allTickets.filter(t => t.category === category).length;
            return `
                <label class="sf-checkbox-item">
                    <input type="checkbox" value="${category}" onchange="applyFilters()">
                    ${category.replace('_', ' ')}
                    <span class="count">${count}</span>
                </label>
            `;
        }).join('');
        document.getElementById('categoryFilter').innerHTML = categoryHtml;

        // Build queue filter
        const queues = [...new Set(allTickets.map(t => t.queue))].filter(q => q);
        const queueHtml = queues.map(queue => {
            const count = allTickets.filter(t => t.queue === queue).length;
            return `
                <label class="sf-checkbox-item">
                    <input type="checkbox" value="${queue}" onchange="applyFilters()">
                    ${queue}
                    <span class="count">${count}</span>
                </label>
            `;
        }).join('');
        document.getElementById('queueFilter').innerHTML = queueHtml;
    }

    // Apply filters
    function applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        const selectedStatuses = getCheckedValues('statusFilter');
        const selectedPriorities = getCheckedValues('priorityFilter');
        const selectedCategories = getCheckedValues('categoryFilter');
        const selectedQueues = getCheckedValues('queueFilter');

        // Update filter counts
        document.getElementById('statusFilterCount').textContent = selectedStatuses.length || '0';
        document.getElementById('priorityFilterCount').textContent = selectedPriorities.length || '0';
        document.getElementById('categoryFilterCount').textContent = selectedCategories.length || '0';
        document.getElementById('queueFilterCount').textContent = selectedQueues.length || '0';

        filteredTickets = allTickets.filter(ticket => {
            // Search filter - handle both single and bulk search modes
            let matchesSearch = true;
            if (isBulkSearchMode && bulkSearchTerms.length > 0) {
                // Bulk search mode: check if any term matches
                const ticketId = ticket.id.toString().toUpperCase();
                const subject = (ticket.subject || '').toUpperCase();
                const description = (ticket.description || '').toUpperCase();
                const customerName = (ticket.customer_name || '').toUpperCase();
                const notes = (ticket.notes || '').toUpperCase();

                matchesSearch = bulkSearchTerms.some(term => {
                    return ticketId.includes(term) ||
                           subject.includes(term) ||
                           description.includes(term) ||
                           customerName.includes(term) ||
                           notes.includes(term);
                });
            } else if (search) {
                // Single search mode
                matchesSearch = (ticket.subject || '').toLowerCase().includes(search) ||
                    ticket.id.toString().includes(search) ||
                    (ticket.customer_name || '').toLowerCase().includes(search) ||
                    (ticket.description || '').toLowerCase().includes(search) ||
                    (ticket.notes || '').toLowerCase().includes(search);
            }
            if (!matchesSearch) return false;

            // Date filter
            if (dateFrom && ticket.created_at) {
                const ticketDate = new Date(ticket.created_at).toISOString().split('T')[0];
                if (ticketDate < dateFrom) return false;
            }
            if (dateTo && ticket.created_at) {
                const ticketDate = new Date(ticket.created_at).toISOString().split('T')[0];
                if (ticketDate > dateTo) return false;
            }

            // Status filter
            if (selectedStatuses.length > 0 && !selectedStatuses.includes(ticket.status)) {
                return false;
            }

            // Priority filter
            if (selectedPriorities.length > 0 && !selectedPriorities.includes(ticket.priority)) {
                return false;
            }

            // Category filter
            if (selectedCategories.length > 0 && !selectedCategories.includes(ticket.category)) {
                return false;
            }

            // Queue filter
            if (selectedQueues.length > 0 && !selectedQueues.includes(ticket.queue)) {
                return false;
            }

            return true;
        });

        currentPage = 1;
        updateSummaryCards();
        sortAndRender();
        populateMondayBoard();

        // Update bulk search match indicator
        const matchesElement = document.getElementById('bulkSearchMatches');
        if (isBulkSearchMode && bulkSearchTerms.length > 0) {
            matchesElement.textContent = `${filteredTickets.length} matches found`;
            matchesElement.classList.remove('hidden');
        } else {
            matchesElement.classList.add('hidden');
        }
    }

    // Bulk search functions
    function toggleBulkSearch() {
        isBulkSearchMode = !isBulkSearchMode;
        const singleSection = document.getElementById('singleSearchSection');
        const bulkSection = document.getElementById('bulkSearchSection');

        if (isBulkSearchMode) {
            singleSection.classList.add('hidden');
            bulkSection.classList.remove('hidden');
            // Clear single search when switching to bulk
            document.getElementById('searchInput').value = '';
        } else {
            bulkSection.classList.add('hidden');
            singleSection.classList.remove('hidden');
            // Clear bulk search when switching to single
            document.getElementById('bulkSearchInput').value = '';
            bulkSearchTerms = [];
            updateBulkSearchCount();
        }
        applyFilters();
    }

    function parseBulkSearchInput(input) {
        if (!input.trim()) return [];

        // Split by newlines and commas, then clean up
        const terms = input
            .split(/[\n,]+/)
            .map(term => term.trim())
            .filter(term => term.length > 0)
            .map(term => term.toUpperCase()); // Convert to uppercase for consistent matching

        return [...new Set(terms)]; // Remove duplicates
    }

    function updateBulkSearchCount() {
        const count = bulkSearchTerms.length;
        document.getElementById('bulkSearchCount').textContent = count;
    }

    function bulkSearchTickets() {
        const input = document.getElementById('bulkSearchInput').value;
        bulkSearchTerms = parseBulkSearchInput(input);
        updateBulkSearchCount();
        applyFilters();
    }

    function clearBulkSearch() {
        document.getElementById('bulkSearchInput').value = '';
        bulkSearchTerms = [];
        updateBulkSearchCount();
        applyFilters();
    }

    function getCheckedValues(containerId) {
        const container = document.getElementById(containerId);
        const checked = container.querySelectorAll('input:checked');
        return Array.from(checked).map(cb => cb.value);
    }

    // Update summary cards
    function updateSummaryCards() {
        document.getElementById('totalCount').textContent = filteredTickets.length;

        // Count tickets by status category
        // "Open" includes: New, OPEN, or any status containing "new" (case-insensitive)
        const openCount = filteredTickets.filter(t => {
            const s = (t.status || '').toLowerCase();
            return s === 'new' || s === 'open' || s.includes('new');
        }).length;

        // "In Progress" includes: In Progress, IN_PROGRESS, Processing, or statuses containing "progress" or "processing"
        const inProgressCount = filteredTickets.filter(t => {
            const s = (t.status || '').toLowerCase();
            return s === 'in progress' || s === 'in_progress' || s === 'processing' ||
                   s.includes('progress') || s.includes('processing');
        }).length;

        // "Resolved" includes: Resolved, RESOLVED, RESOLVED_DELIVERED, or statuses containing "resolved" or "delivered" or "complete"
        const resolvedCount = filteredTickets.filter(t => {
            const s = (t.status || '').toLowerCase();
            return s === 'resolved' || s.includes('resolved') || s.includes('delivered') || s.includes('complete');
        }).length;

        // "On Hold" includes: On Hold, ON_HOLD, or statuses containing "hold" or "duplicate" or "cancelled"
        const onHoldCount = filteredTickets.filter(t => {
            const s = (t.status || '').toLowerCase();
            return s === 'on hold' || s === 'on_hold' || s.includes('hold') ||
                   s.includes('duplicate') || s.includes('cancel');
        }).length;

        document.getElementById('openCount').textContent = openCount;
        document.getElementById('inProgressCount').textContent = inProgressCount;
        document.getElementById('resolvedCount').textContent = resolvedCount;
        document.getElementById('onHoldCount').textContent = onHoldCount;

        // Personal stats - tickets assigned to current user
        const myTickets = filteredTickets.filter(t => t.assignee === currentUsername);

        const myOpenCount = myTickets.filter(t => {
            const s = (t.status || '').toLowerCase();
            return s === 'new' || s === 'open' || s.includes('new');
        }).length;

        const myInProgressCount = myTickets.filter(t => {
            const s = (t.status || '').toLowerCase();
            return s === 'in progress' || s === 'in_progress' || s === 'processing' ||
                   s.includes('progress') || s.includes('processing');
        }).length;

        const myOnHoldCount = myTickets.filter(t => {
            const s = (t.status || '').toLowerCase();
            return s === 'on hold' || s === 'on_hold' || s.includes('hold') ||
                   s.includes('duplicate') || s.includes('cancel');
        }).length;

        const myResolvedCount = myTickets.filter(t => {
            const s = (t.status || '').toLowerCase();
            return s === 'resolved' || s.includes('resolved') || s.includes('delivered') || s.includes('complete');
        }).length;

        document.getElementById('myTotalCount').textContent = myTickets.length;
        document.getElementById('myOpenCount').textContent = myOpenCount;
        document.getElementById('myInProgressCount').textContent = myInProgressCount;
        document.getElementById('myOnHoldCount').textContent = myOnHoldCount;
        document.getElementById('myResolvedCount').textContent = myResolvedCount;
    }

    // Sort and render table
    function sortAndRender() {
        // Sort
        filteredTickets.sort((a, b) => {
            let aVal = a[sortColumn] || '';
            let bVal = b[sortColumn] || '';

            if (sortColumn === 'id') {
                aVal = parseInt(aVal);
                bVal = parseInt(bVal);
            } else if (sortColumn === 'created') {
                aVal = new Date(a.created_at || 0);
                bVal = new Date(b.created_at || 0);
            } else {
                aVal = String(aVal).toLowerCase();
                bVal = String(bVal).toLowerCase();
            }

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        renderTable();
        renderPagination();
        updateSortIndicators();
    }

    // Render table
    function renderTable() {
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageTickets = filteredTickets.slice(start, end);

        if (pageTickets.length === 0) {
            document.getElementById('ticketTableBody').innerHTML = '';
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('tableContent').querySelector('table').style.display = 'none';
        } else {
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('tableContent').querySelector('table').style.display = 'table';

            const html = pageTickets.map(ticket => {
                const statusStyle = statusColors[ticket.status] || { bg: '#e2e3e5', color: '#383d41' };
                const priorityStyle = priorityColors[ticket.priority] || { bg: '#fff3cd', color: '#856404' };
                const createdDate = ticket.created_at ? new Date(ticket.created_at).toLocaleDateString() : 'N/A';

                return `
                    <tr>
                        <td><a href="/tickets/${ticket.id}" class="sf-table-link">#${ticket.id}</a></td>
                        <td>
                            <a href="/tickets/${ticket.id}" class="sf-table-link">${escapeHtml(ticket.subject.substring(0, 50))}${ticket.subject.length > 50 ? '...' : ''}</a>
                            ${ticket.customer_name ? `<br><small style="color: var(--sf-gray-600);">${escapeHtml(ticket.customer_name)}</small>` : ''}
                        </td>
                        <td>${ticket.category ? ticket.category.replace('_', ' ') : 'N/A'}</td>
                        <td><span class="sf-badge" style="background: ${priorityStyle.bg}; color: ${priorityStyle.color};">${ticket.priority || 'N/A'}</span></td>
                        <td><span class="sf-badge" style="background: ${statusStyle.bg}; color: ${statusStyle.color};">${ticket.status ? ticket.status.replace('_', ' ') : 'N/A'}</span></td>
                        <td>${escapeHtml(ticket.queue || 'Unassigned')}</td>
                        <td>${createdDate}</td>
                        <td>
                            <a href="/tickets/${ticket.id}" class="sf-btn sf-btn-neutral" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('ticketTableBody').innerHTML = html;
        }

        document.getElementById('displayedCount').textContent = filteredTickets.length;
        document.getElementById('showingFrom').textContent = filteredTickets.length > 0 ? start + 1 : 0;
        document.getElementById('showingTo').textContent = Math.min(end, filteredTickets.length);
        document.getElementById('totalFiltered').textContent = filteredTickets.length;
    }

    // Render pagination
    function renderPagination() {
        const totalPages = Math.ceil(filteredTickets.length / pageSize);
        let html = '';

        html += `<button class="sf-pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>`;

        for (let i = 1; i <= Math.min(totalPages, 5); i++) {
            html += `<button class="sf-pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        }

        if (totalPages > 5) {
            html += `<span style="padding: 0 0.5rem;">...</span>`;
            html += `<button class="sf-pagination-btn ${totalPages === currentPage ? 'active' : ''}" onclick="goToPage(${totalPages})">${totalPages}</button>`;
        }

        html += `<button class="sf-pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>`;

        document.getElementById('paginationControls').innerHTML = html;
    }

    // Sort table
    function sortTable(column) {
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }
        sortAndRender();
    }

    function updateSortIndicators() {
        document.querySelectorAll('.sf-table th').forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
        });
        const currentTh = document.querySelector(`.sf-table th[data-sort="${sortColumn}"]`);
        if (currentTh) {
            currentTh.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
    }

    // Page navigation
    function goToPage(page) {
        const totalPages = Math.ceil(filteredTickets.length / pageSize);
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderTable();
        renderPagination();
    }

    function changePageSize() {
        pageSize = parseInt(document.getElementById('pageSize').value);
        currentPage = 1;
        sortAndRender();
    }

    // Filter by status from summary cards
    function filterByStatus(statusCategory) {
        // Clear all status checkboxes first
        document.querySelectorAll('#statusFilter input').forEach(cb => cb.checked = false);

        if (statusCategory !== 'all') {
            // Check checkboxes that match the category pattern
            document.querySelectorAll('#statusFilter input').forEach(cb => {
                const s = cb.value.toLowerCase();
                let shouldCheck = false;

                if (statusCategory === 'OPEN') {
                    shouldCheck = s === 'new' || s === 'open' || s.includes('new');
                } else if (statusCategory === 'IN_PROGRESS') {
                    shouldCheck = s === 'in progress' || s === 'in_progress' || s === 'processing' ||
                                  s.includes('progress') || s.includes('processing');
                } else if (statusCategory === 'RESOLVED') {
                    shouldCheck = s === 'resolved' || s.includes('resolved') || s.includes('delivered') || s.includes('complete');
                } else if (statusCategory === 'ON_HOLD') {
                    shouldCheck = s === 'on hold' || s === 'on_hold' || s.includes('hold') ||
                                  s.includes('duplicate') || s.includes('cancel');
                }

                if (shouldCheck) cb.checked = true;
            });
        }

        applyFilters();

        // Update card highlights
        document.querySelectorAll('.sf-summary-card').forEach(card => card.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    // Filter by assignee (my tickets)
    function filterByAssignee() {
        // Clear all status checkboxes
        document.querySelectorAll('#statusFilter input').forEach(cb => cb.checked = false);

        // Check assignee checkbox for current user
        document.querySelectorAll('#assigneeFilter input').forEach(cb => {
            cb.checked = (cb.value === currentUsername);
        });

        applyFilters();

        // Update card highlights
        document.querySelectorAll('.sf-summary-card').forEach(card => card.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    // Filter by assignee and status combined
    function filterByAssigneeAndStatus(statusCategory) {
        // Clear all status checkboxes first
        document.querySelectorAll('#statusFilter input').forEach(cb => cb.checked = false);

        // Check assignee checkbox for current user
        document.querySelectorAll('#assigneeFilter input').forEach(cb => {
            cb.checked = (cb.value === currentUsername);
        });

        // Check status checkboxes that match the category pattern
        document.querySelectorAll('#statusFilter input').forEach(cb => {
            const s = cb.value.toLowerCase();
            let shouldCheck = false;

            if (statusCategory === 'OPEN') {
                shouldCheck = s === 'new' || s === 'open' || s.includes('new');
            } else if (statusCategory === 'IN_PROGRESS') {
                shouldCheck = s === 'in progress' || s === 'in_progress' || s === 'processing' ||
                              s.includes('progress') || s.includes('processing');
            } else if (statusCategory === 'RESOLVED') {
                shouldCheck = s === 'resolved' || s.includes('resolved') || s.includes('delivered') || s.includes('complete');
            } else if (statusCategory === 'ON_HOLD') {
                shouldCheck = s === 'on hold' || s === 'on_hold' || s.includes('hold') ||
                              s.includes('duplicate') || s.includes('cancel');
            }

            if (shouldCheck) cb.checked = true;
        });

        applyFilters();

        // Update card highlights
        document.querySelectorAll('.sf-summary-card').forEach(card => card.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    // Current selected queue
    let selectedQueue = 'all';

    // Filter by queue from queue bar
    function filterByQueue(queue, button) {
        selectedQueue = queue;

        // Update tab styles - clear all active states
        document.querySelectorAll('.sf-queue-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.sf-folder-tab').forEach(tab => tab.classList.remove('active'));

        button.classList.add('active');

        // Clear queue checkboxes in sidebar and set the correct one
        document.querySelectorAll('#queueFilter input').forEach(cb => cb.checked = false);

        if (queue !== 'all') {
            const checkbox = document.querySelector(`#queueFilter input[value="${queue}"]`);
            if (checkbox) checkbox.checked = true;
        }

        applyFilters();
    }

    // Current expanded folder ID
    let currentExpandedFolder = null;

    // Expand folder to show its queues
    function expandFolder(folderTab) {
        const folderId = folderTab.dataset.folderId;
        const queueTabs = document.getElementById('queueTabs');

        // Hide all folder queues first
        document.querySelectorAll('.sf-queue-tab.folder-queue').forEach(tab => {
            tab.style.display = 'none';
        });

        // Show only this folder's queues
        document.querySelectorAll(`.sf-queue-tab.folder-queue[data-folder-id="${folderId}"]`).forEach(tab => {
            tab.style.display = 'flex';
        });

        // Add expanded class to show back button and hide other tabs
        queueTabs.classList.add('folder-expanded');
        currentExpandedFolder = folderId;

        // Clear active states and set first queue in folder as active
        document.querySelectorAll('.sf-queue-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.sf-folder-tab').forEach(tab => tab.classList.remove('active'));

        // Select the first queue in the folder by default
        const firstFolderQueue = document.querySelector(`.sf-queue-tab.folder-queue[data-folder-id="${folderId}"]`);
        if (firstFolderQueue) {
            firstFolderQueue.classList.add('active');
            selectedQueue = firstFolderQueue.dataset.queue;

            // Update sidebar checkbox
            document.querySelectorAll('#queueFilter input').forEach(cb => cb.checked = false);
            const checkbox = document.querySelector(`#queueFilter input[value="${selectedQueue}"]`);
            if (checkbox) checkbox.checked = true;

            applyFilters();
        }
    }

    // Close folder view and show all folders/queues
    function closeFolderView() {
        const queueTabs = document.getElementById('queueTabs');

        // Remove expanded class
        queueTabs.classList.remove('folder-expanded');
        currentExpandedFolder = null;

        // Hide all folder queues
        document.querySelectorAll('.sf-queue-tab.folder-queue').forEach(tab => {
            tab.style.display = 'none';
        });

        // Reset to All Queues
        document.querySelectorAll('.sf-queue-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.sf-folder-tab').forEach(tab => tab.classList.remove('active'));

        const allQueuesBtn = document.querySelector('.sf-queue-tab[data-queue="all"]');
        if (allQueuesBtn) {
            allQueuesBtn.classList.add('active');
        }

        selectedQueue = 'all';
        document.querySelectorAll('#queueFilter input').forEach(cb => cb.checked = false);
        applyFilters();
    }

    // Toggle import dropdown
    function toggleImportDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('importDropdown');
        dropdown.classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('importDropdown');
        if (dropdown && !event.target.closest('.sf-dropdown')) {
            dropdown.classList.remove('show');
        }
    });

    // Toggle filter section
    function toggleFilter(filterId) {
        const content = document.getElementById(filterId);
        content.classList.toggle('collapsed');
    }

    // Toggle sidebar
    function toggleSidebar() {
        const sidebar = document.getElementById('filterSidebar');
        const toggle = document.querySelector('.sf-toggle-sidebar');
        const icon = document.getElementById('sidebarToggleIcon');

        sidebar.classList.toggle('collapsed');
        toggle.classList.toggle('collapsed');

        if (sidebar.classList.contains('collapsed')) {
            icon.classList.remove('fa-chevron-left');
            icon.classList.add('fa-chevron-right');
        } else {
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-left');
        }
    }

    // Clear all filters
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.querySelectorAll('.sf-filter-content input').forEach(cb => cb.checked = false);

        // Also clear bulk search and switch back to single search mode
        document.getElementById('bulkSearchInput').value = '';
        bulkSearchTerms = [];
        updateBulkSearchCount();
        if (isBulkSearchMode) {
            isBulkSearchMode = false;
            document.getElementById('bulkSearchSection').classList.add('hidden');
            document.getElementById('singleSearchSection').classList.remove('hidden');
        }

        applyFilters();
    }

    // Update charts
    function updateCharts() {
        updateStatusChart();
        updateTrendChart();
    }

    function updateStatusChart() {
        const ctx = document.getElementById('statusChart').getContext('2d');

        const statusCounts = {};
        allTickets.forEach(t => {
            const status = t.status || 'UNKNOWN';
            statusCounts[status] = (statusCounts[status] || 0) + 1;
        });

        const labels = Object.keys(statusCounts);
        const data = Object.values(statusCounts);
        const colors = labels.map(s => getStatusColor(s));

        if (statusChart) {
            statusChart.destroy();
        }

        statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels.map(s => s.replace('_', ' ')),
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15
                        }
                    }
                }
            }
        });
    }

    function updateTrendChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');

        // Group tickets by day for the last 7 days
        const days = [];
        const counts = [];
        const today = new Date();

        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));

            const count = allTickets.filter(t => {
                if (!t.created_at) return false;
                const ticketDate = new Date(t.created_at).toISOString().split('T')[0];
                return ticketDate === dateStr;
            }).length;
            counts.push(count);
        }

        if (trendChart) {
            trendChart.destroy();
        }

        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: days,
                datasets: [{
                    label: 'Tickets Created',
                    data: counts,
                    borderColor: '#0176d3',
                    backgroundColor: 'rgba(1, 118, 211, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // ============================================
    // Monday.com-style Board Functions
    // ============================================

    let mondayBoardGrouping = 'folder'; // 'folder', 'queue' or 'category'
    const groupColors = ['blue', 'green', 'orange', 'purple', 'teal', 'pink', 'indigo', 'red'];
    let groupColorMap = {};

    // Folder data from server
    const foldersData = {{ folders_data | tojson | safe }};

    function populateMondayBoard() {
        const tbody = document.getElementById('mondayBoardBody');
        if (!tbody) return;

        let html = '';

        if (mondayBoardGrouping === 'folder') {
            html = buildFolderGroupedBoard();
        } else {
            html = buildSimpleGroupedBoard();
        }

        if (html === '') {
            html = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 2rem; color: var(--sf-gray-500);">
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p>No tickets to display</p>
                    </td>
                </tr>
            `;
        }

        tbody.innerHTML = html;

        // Update button states
        document.getElementById('groupByFolderBtn')?.classList.toggle('active', mondayBoardGrouping === 'folder');
        document.getElementById('groupByQueueBtn').classList.toggle('active', mondayBoardGrouping === 'queue');
        document.getElementById('groupByCategoryBtn').classList.toggle('active', mondayBoardGrouping === 'category');
    }

    function buildFolderGroupedBoard() {
        let html = '';
        let colorIdx = 0;

        // Group tickets by queue
        const ticketsByQueue = {};
        filteredTickets.forEach(ticket => {
            const queueName = ticket.queue || 'Unassigned';
            if (!ticketsByQueue[queueName]) {
                ticketsByQueue[queueName] = [];
            }
            ticketsByQueue[queueName].push(ticket);
        });

        // Process folders
        if (foldersData && foldersData.folders && foldersData.folders.length > 0) {
            foldersData.folders.forEach(folder => {
                const folderColor = groupColors[colorIdx % groupColors.length];
                colorIdx++;

                // Count tickets in this folder
                let folderTicketCount = 0;
                const folderQueues = folder.queues || [];
                folderQueues.forEach(q => {
                    folderTicketCount += (ticketsByQueue[q.name] || []).length;
                });

                if (folderTicketCount === 0) return; // Skip empty folders

                // Folder header row
                const folderId = 'folder-' + folder.id;
                html += `
                    <tr class="monday-group-row monday-folder-row" data-group-color="${folderColor}" data-folder="${folderId}">
                        <td colspan="9">
                            <div class="monday-group-header" onclick="toggleMondayFolder('${folderId}')">
                                <span class="monday-group-chevron collapsed" id="chevron-${folderId}">
                                    <i class="fas fa-chevron-down"></i>
                                </span>
                                <i class="fas fa-folder" style="color: var(--group-color); margin-right: 0.25rem;"></i>
                                <span class="monday-group-name" style="color: var(--group-color);">${folder.name}</span>
                                <span class="monday-group-count">${folderTicketCount} Service Jobs / ${folderQueues.length} Queues</span>
                            </div>
                        </td>
                    </tr>
                `;

                // Queue rows within folder (collapsed by default)
                folderQueues.forEach(queue => {
                    const queueTickets = ticketsByQueue[queue.name] || [];
                    if (queueTickets.length === 0) return;

                    const queueId = folderId + '-queue-' + queue.name.replace(/[^a-zA-Z0-9]/g, '_');

                    // Queue header (sub-group)
                    html += `
                        <tr class="monday-group-row monday-queue-row collapsed" data-group-color="${folderColor}" data-folder="${folderId}" data-queue="${queueId}">
                            <td colspan="9">
                                <div class="monday-group-header" onclick="toggleMondayGroup('${queueId}')" style="padding-left: 2.5rem;">
                                    <span class="monday-group-chevron collapsed" id="chevron-${queueId}">
                                        <i class="fas fa-chevron-down"></i>
                                    </span>
                                    <span class="monday-group-name" style="color: var(--group-color); font-size: 0.8125rem;">${queue.name}</span>
                                    <span class="monday-group-count">${queueTickets.length} Service Jobs</span>
                                </div>
                            </td>
                        </tr>
                    `;

                    // Ticket rows (collapsed by default)
                    queueTickets.slice(0, 10).forEach(ticket => {
                        html += buildMondayItemRow(ticket, folderColor, queueId, true);
                    });

                    if (queueTickets.length > 10) {
                        html += `
                            <tr class="monday-item-row collapsed" data-group-color="${folderColor}" data-group="${queueId}">
                                <td colspan="9" style="text-align: center; padding: 0.5rem;">
                                    <span class="monday-empty-cell">+ ${queueTickets.length - 10} more tickets</span>
                                </td>
                            </tr>
                        `;
                    }

                    // Mark queue as processed
                    delete ticketsByQueue[queue.name];
                });
            });
        }

        // Process unfiled queues
        const unfiledQueues = Object.keys(ticketsByQueue).sort();
        unfiledQueues.forEach(queueName => {
            const tickets = ticketsByQueue[queueName];
            if (tickets.length === 0) return;

            const groupColor = groupColors[colorIdx % groupColors.length];
            colorIdx++;
            const groupId = 'queue-' + queueName.replace(/[^a-zA-Z0-9]/g, '_');

            // Queue header row
            html += `
                <tr class="monday-group-row" data-group-color="${groupColor}" data-group="${groupId}">
                    <td colspan="9">
                        <div class="monday-group-header" onclick="toggleMondayGroup('${groupId}')">
                            <span class="monday-group-chevron collapsed" id="chevron-${groupId}">
                                <i class="fas fa-chevron-down"></i>
                            </span>
                            <span class="monday-group-name" style="color: var(--group-color);">${queueName}</span>
                            <span class="monday-group-count">${tickets.length} Service Jobs</span>
                        </div>
                    </td>
                </tr>
            `;

            // Ticket rows (collapsed by default)
            tickets.slice(0, 10).forEach(ticket => {
                html += buildMondayItemRow(ticket, groupColor, groupId, true);
            });

            if (tickets.length > 10) {
                html += `
                    <tr class="monday-item-row collapsed" data-group-color="${groupColor}" data-group="${groupId}">
                        <td colspan="9" style="text-align: center; padding: 0.5rem;">
                            <span class="monday-empty-cell">+ ${tickets.length - 10} more tickets</span>
                        </td>
                    </tr>
                `;
            }
        });

        return html;
    }

    function buildSimpleGroupedBoard() {
        const groups = {};
        const groupField = mondayBoardGrouping === 'queue' ? 'queue' : 'category';

        filteredTickets.forEach(ticket => {
            const groupName = ticket[groupField] || 'Unassigned';
            if (!groups[groupName]) {
                groups[groupName] = [];
            }
            groups[groupName].push(ticket);
        });

        const groupNames = Object.keys(groups).sort();
        groupNames.forEach((name, idx) => {
            if (!groupColorMap[name]) {
                groupColorMap[name] = groupColors[idx % groupColors.length];
            }
        });

        let html = '';

        groupNames.forEach(groupName => {
            const tickets = groups[groupName];
            const groupColor = groupColorMap[groupName];
            const groupId = groupName.replace(/[^a-zA-Z0-9]/g, '_');

            // Group header row - collapsed by default
            html += `
                <tr class="monday-group-row" data-group-color="${groupColor}" data-group="${groupId}">
                    <td colspan="9">
                        <div class="monday-group-header" onclick="toggleMondayGroup('${groupId}')">
                            <span class="monday-group-chevron collapsed" id="chevron-${groupId}">
                                <i class="fas fa-chevron-down"></i>
                            </span>
                            <span class="monday-group-name" style="color: var(--group-color);">${groupName}</span>
                            <span class="monday-group-count">${tickets.length} ${mondayBoardGrouping === 'queue' ? 'Service Jobs' : 'Tickets'}</span>
                        </div>
                    </td>
                </tr>
            `;

            // Item rows - collapsed by default
            tickets.slice(0, 10).forEach(ticket => {
                html += buildMondayItemRow(ticket, groupColor, groupId, true);
            });

            if (tickets.length > 10) {
                html += `
                    <tr class="monday-item-row collapsed" data-group-color="${groupColor}" data-group="${groupId}">
                        <td colspan="9" style="text-align: center; padding: 0.5rem;">
                            <span class="monday-empty-cell">+ ${tickets.length - 10} more tickets</span>
                        </td>
                    </tr>
                `;
            }
        });

        return html;
    }

    function buildMondayItemRow(ticket, groupColor, groupName, collapsed = true) {
        const ticketUrl = `{{ url_for('tickets.view_ticket', ticket_id=0) }}`.replace('/0', '/' + ticket.id);
        const collapsedClass = collapsed ? 'collapsed' : '';

        // Format dates
        const createdDate = ticket.created_at ? formatMondayDate(ticket.created_at) : null;
        const updatedDate = ticket.updated_at ? formatMondayDate(ticket.updated_at) : null;
        const shippingCreatedDate = ticket.shipping_tracking_created_at ? formatMondayDate(ticket.shipping_tracking_created_at) : null;
        const itemPackedDate = ticket.item_packed_at ? formatMondayDate(ticket.item_packed_at) : null;

        // Calculate progress
        const progress = calculateTicketProgress(ticket);

        return `
            <tr class="monday-item-row ${collapsedClass}" data-group-color="${groupColor}" data-group="${groupName}">
                <td>
                    <div class="monday-item-name">
                        <a href="${ticketUrl}" class="monday-item-link">TICK-${String(ticket.id).padStart(4, '0')}</a>
                        <span class="monday-item-subject" title="${ticket.subject}">${ticket.subject}</span>
                    </div>
                </td>
                <td>
                    ${shippingCreatedDate || createdDate ?
                        `<span class="monday-date-pill blue">${shippingCreatedDate || createdDate}</span>` :
                        '<span class="monday-empty-cell">-</span>'}
                </td>
                <td>
                    ${ticket.shipping_tracking ?
                        `<span class="monday-label" title="${ticket.shipping_tracking}">
                            <i class="fas fa-shipping-fast"></i>
                            ${ticket.shipping_tracking.substring(0, 12)}${ticket.shipping_tracking.length > 12 ? '...' : ''}
                        </span>` :
                        '<span class="monday-empty-cell">-</span>'}
                </td>
                <td>
                    <div class="monday-status-cell">
                        ${buildMondayStatus(ticket.shipping_status)}
                    </div>
                </td>
                <td>
                    ${itemPackedDate ?
                        `<span class="monday-date-pill green">${itemPackedDate}</span>` :
                        '<span class="monday-empty-cell">-</span>'}
                </td>
                <td>
                    ${ticket.return_tracking ?
                        `<span class="monday-label" title="${ticket.return_tracking}">
                            <i class="fas fa-undo"></i>
                            ${ticket.return_tracking.substring(0, 12)}${ticket.return_tracking.length > 12 ? '...' : ''}
                        </span>` :
                        '<span class="monday-empty-cell">-</span>'}
                </td>
                <td>
                    <div class="monday-status-cell">
                        ${buildMondayStatus(ticket.return_status)}
                    </div>
                </td>
                <td>
                    ${updatedDate && (ticket.status === 'Resolved' || ticket.status === 'RESOLVED' || ticket.status === 'Resolved (All Package Delivered)') ?
                        `<span class="monday-date-pill green">${updatedDate}</span>` :
                        '<span class="monday-empty-cell">-</span>'}
                </td>
                <td>
                    <div class="monday-progress-bar" title="${progress}% complete">
                        <div class="monday-progress-fill ${progress >= 100 ? 'green' : 'blue'}" style="width: ${progress}%;"></div>
                    </div>
                </td>
            </tr>
        `;
    }

    function formatMondayDate(isoString) {
        if (!isoString) return null;
        const date = new Date(isoString);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${months[date.getMonth()]} ${date.getDate()}, '${String(date.getFullYear()).slice(-2)}`;
    }

    function buildMondayStatus(status) {
        if (!status || status === 'Pending') {
            return '<span class="monday-status pending">Pending</span>';
        }

        const statusLower = status.toLowerCase();

        if (statusLower.includes('deliver') && !statusLower.includes('out')) {
            return '<span class="monday-status delivered">Delivered</span>';
        } else if (statusLower.includes('out for delivery')) {
            return '<span class="monday-status out-for-delivery">Out for Delivery</span>';
        } else if (statusLower.includes('transit') || statusLower.includes('shipping') || statusLower.includes('dispatched')) {
            return '<span class="monday-status in-transit">In Transit</span>';
        } else if (statusLower.includes('fail') || statusLower.includes('exception') || statusLower.includes('return')) {
            return '<span class="monday-status failed">Exception</span>';
        } else {
            return `<span class="monday-status pending">${status}</span>`;
        }
    }

    function calculateTicketProgress(ticket) {
        let progress = 0;

        // Basic progress based on status
        if (ticket.status === 'New' || ticket.status === 'NEW') {
            progress = 10;
        } else if (ticket.status === 'In Progress' || ticket.status === 'IN_PROGRESS') {
            progress = 30;
        } else if (ticket.status === 'Processing' || ticket.status === 'PROCESSING') {
            progress = 50;
        } else if (ticket.status === 'On Hold' || ticket.status === 'ON_HOLD') {
            progress = 40;
        } else if (ticket.status === 'Resolved' || ticket.status === 'RESOLVED') {
            progress = 90;
        } else if (ticket.status === 'Resolved (All Package Delivered)' || ticket.status === 'RESOLVED_DELIVERED') {
            progress = 100;
        } else {
            progress = 20; // Custom status
        }

        // Bonus progress for tracking
        if (ticket.shipping_tracking) progress = Math.min(progress + 10, 100);
        if (ticket.shipping_status && ticket.shipping_status !== 'Pending') progress = Math.min(progress + 10, 100);
        if (ticket.return_tracking) progress = Math.min(progress + 10, 100);
        if (ticket.return_status && ticket.return_status !== 'Pending') progress = Math.min(progress + 10, 100);
        if (ticket.item_packed) progress = Math.min(progress + 5, 100);

        return progress;
    }

    function toggleMondayGroup(groupId) {
        const chevron = document.getElementById('chevron-' + groupId);
        const isCollapsed = chevron && chevron.classList.contains('collapsed');

        // Toggle chevron
        if (chevron) {
            chevron.classList.toggle('collapsed');
        }

        // Toggle item rows
        const itemRows = document.querySelectorAll(`.monday-item-row[data-group="${groupId}"]`);
        itemRows.forEach(row => {
            row.classList.toggle('collapsed', !isCollapsed);
        });
    }

    function toggleMondayFolder(folderId) {
        const chevron = document.getElementById('chevron-' + folderId);
        const isCollapsed = chevron && chevron.classList.contains('collapsed');

        // Toggle chevron
        if (chevron) {
            chevron.classList.toggle('collapsed');
        }

        // Toggle queue rows within this folder
        const queueRows = document.querySelectorAll(`.monday-queue-row[data-folder="${folderId}"]`);
        queueRows.forEach(row => {
            row.classList.toggle('collapsed', !isCollapsed);
        });

        // If expanding folder, keep item rows collapsed (user needs to click queue to expand items)
        // If collapsing folder, collapse all item rows within
        if (!isCollapsed) {
            // Collapsing folder - hide all items in all queues of this folder
            queueRows.forEach(queueRow => {
                const queueId = queueRow.getAttribute('data-queue');
                const itemRows = document.querySelectorAll(`.monday-item-row[data-group="${queueId}"]`);
                itemRows.forEach(row => row.classList.add('collapsed'));

                // Also collapse the queue chevrons
                const queueChevron = document.getElementById('chevron-' + queueId);
                if (queueChevron) queueChevron.classList.add('collapsed');
            });
        }
    }

    function toggleBoardGrouping(groupBy) {
        if (mondayBoardGrouping !== groupBy) {
            mondayBoardGrouping = groupBy;
            populateMondayBoard();
        }
    }

    function toggleBoardCollapse() {
        const board = document.getElementById('mondayBoard');
        const btn = document.getElementById('collapseBoardBtn');

        board.classList.toggle('collapsed');

        const icon = btn.querySelector('i');
        if (board.classList.contains('collapsed')) {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        } else {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
    }

    function changeChartType(chartId, type, btn) {
        // Update button states
        btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        if (chartId === 'statusChart') {
            updateStatusChartWithType(type);
        } else if (chartId === 'trendChart') {
            updateTrendChartWithType(type);
        }
    }

    function updateStatusChartWithType(type) {
        const ctx = document.getElementById('statusChart').getContext('2d');

        const statusCounts = {};
        allTickets.forEach(t => {
            const status = t.status || 'UNKNOWN';
            statusCounts[status] = (statusCounts[status] || 0) + 1;
        });

        const labels = Object.keys(statusCounts);
        const data = Object.values(statusCounts);
        const colors = labels.map(s => getStatusColor(s));

        if (statusChart) {
            statusChart.destroy();
        }

        statusChart = new Chart(ctx, {
            type: type,
            data: {
                labels: labels.map(s => s.replace('_', ' ')),
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: type === 'bar' ? 0 : 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: type === 'bar' ? 'top' : 'right',
                        display: type !== 'bar',
                        labels: {
                            boxWidth: 12,
                            padding: 15
                        }
                    }
                },
                scales: type === 'bar' ? {
                    y: { beginAtZero: true }
                } : {}
            }
        });
    }

    function updateTrendChartWithType(type) {
        const ctx = document.getElementById('trendChart').getContext('2d');

        const days = [];
        const counts = [];
        const today = new Date();

        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));

            const count = allTickets.filter(t => {
                if (!t.created_at) return false;
                const ticketDate = new Date(t.created_at).toISOString().split('T')[0];
                return ticketDate === dateStr;
            }).length;
            counts.push(count);
        }

        if (trendChart) {
            trendChart.destroy();
        }

        trendChart = new Chart(ctx, {
            type: type,
            data: {
                labels: days,
                datasets: [{
                    label: 'Tickets Created',
                    data: counts,
                    borderColor: '#0176d3',
                    backgroundColor: type === 'bar' ? '#0176d3' : 'rgba(1, 118, 211, 0.1)',
                    fill: type === 'line',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // Export tickets (simple)
    function exportTickets() {
        window.location.href = "{{ url_for('tickets.export_tickets_csv') }}";
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    // ============ Export Wizard Functions ============
    function showExportWizard() {
        document.getElementById('exportWizardModal').style.display = 'flex';
        populateExportFilters();
    }

    function hideExportWizard() {
        document.getElementById('exportWizardModal').style.display = 'none';
        document.getElementById('exportForm').reset();
        document.getElementById('exportPreviewSection').style.display = 'none';
        document.getElementById('previewButton').style.display = 'inline-block';
        document.getElementById('exportButton').style.display = 'none';
    }

    function populateExportFilters() {
        const categories = new Set();
        const priorities = new Set();
        const queues = new Set();

        allTickets.forEach(ticket => {
            if (ticket.category) categories.add(ticket.category);
            if (ticket.priority) priorities.add(ticket.priority);
            if (ticket.queue) queues.add(ticket.queue);
        });

        // Update category filter
        const categorySelect = document.getElementById('exportCategoryFilter');
        categorySelect.innerHTML = '<option value="all">All Categories</option>';
        categories.forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
        });

        // Update priority filter
        const prioritySelect = document.getElementById('exportPriorityFilter');
        prioritySelect.innerHTML = '<option value="all">All Priorities</option>';
        priorities.forEach(pri => {
            prioritySelect.innerHTML += `<option value="${pri}">${pri}</option>`;
        });

        // Update queue filter
        const queueSelect = document.getElementById('exportQueueFilter');
        queueSelect.innerHTML = '<option value="all">All Queues</option>';
        queues.forEach(queue => {
            queueSelect.innerHTML += `<option value="${queue}">${queue}</option>`;
        });

        // Load companies
        loadCompaniesForExport();
    }

    function loadCompaniesForExport() {
        fetch('/api/v1/companies')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.companies) {
                    const companySelect = document.getElementById('exportCompanyFilter');
                    companySelect.innerHTML = '<option value="all">All Companies</option>';
                    data.companies.forEach(company => {
                        let displayName = company.grouped_display_name;
                        if (company.parent_company_id && !company.is_parent_company) {
                            displayName = '   ' + displayName;
                        } else if (company.is_parent_company) {
                            displayName = ' ' + displayName;
                        }
                        companySelect.innerHTML += `<option value="${company.id}">${displayName}</option>`;
                    });
                }
            })
            .catch(error => console.error('Error loading companies:', error));
    }

    function toggleExportMode() {
        const mode = document.getElementById('exportMode').value;
        const filterSection = document.getElementById('filterExportSection');
        const selectionSection = document.getElementById('selectionExportSection');

        filterSection.style.display = mode === 'filtered' ? 'block' : 'none';
        selectionSection.style.display = mode === 'selected' ? 'block' : 'none';

        if (mode === 'selected') {
            showTicketSelection();
        }

        // Reset preview
        document.getElementById('exportPreviewSection').style.display = 'none';
        document.getElementById('previewButton').style.display = 'inline-block';
        document.getElementById('exportButton').style.display = 'none';

        // Reset filter result count
        document.getElementById('filterResultCount').textContent = '';
    }

    function applyExportFilters() {
        const filteredTickets = getFilteredExportTickets();
        const countEl = document.getElementById('filterResultCount');
        countEl.textContent = `${filteredTickets.length} ticket(s) match your filters`;
        countEl.style.color = filteredTickets.length > 0 ? '#059669' : '#dc2626';

        // Automatically show preview
        showPreview();
    }

    function showTicketSelection() {
        const selectionContainer = document.getElementById('ticketSelectionList');
        selectionContainer.innerHTML = '';

        filteredTickets.forEach(ticket => {
            const checkboxItem = document.createElement('div');
            checkboxItem.className = 'ticket-selection-item';
            checkboxItem.innerHTML = `
                <label class="ticket-selection-label">
                    <input type="checkbox" name="selectedTickets" value="${ticket.id}">
                    <span class="ticket-info">
                        <strong>#${ticket.id}</strong> - ${escapeHtml(ticket.subject)}
                        <span class="ticket-status">${ticket.status || 'Unknown'}</span>
                    </span>
                </label>
            `;
            selectionContainer.appendChild(checkboxItem);
        });
    }

    function selectAllExportTickets() {
        document.querySelectorAll('#ticketSelectionList input[name="selectedTickets"]').forEach(cb => cb.checked = true);
    }

    function clearSelectedExportTickets() {
        document.querySelectorAll('#ticketSelectionList input[name="selectedTickets"]').forEach(cb => cb.checked = false);
    }

    function filterExportTicketList() {
        const searchTerm = document.getElementById('ticketSearchInput').value.toLowerCase().trim();
        document.querySelectorAll('.ticket-selection-item').forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = (searchTerm === '' || text.includes(searchTerm)) ? '' : 'none';
        });
    }

    function showPreview() {
        const mode = document.getElementById('exportMode').value;
        let ticketsToPreview = [];

        if (mode === 'all') {
            ticketsToPreview = [...allTickets];
        } else if (mode === 'filtered') {
            ticketsToPreview = getFilteredExportTickets();
        } else if (mode === 'selected') {
            const selectedIds = Array.from(document.querySelectorAll('input[name="selectedTickets"]:checked')).map(cb => parseInt(cb.value));
            ticketsToPreview = allTickets.filter(t => selectedIds.includes(t.id));
        }

        displayPreview(ticketsToPreview);

        document.getElementById('exportPreviewSection').style.display = 'block';
        document.getElementById('previewButton').style.display = 'none';
        document.getElementById('exportButton').style.display = 'inline-block';
        document.getElementById('exportPreviewSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function getFilteredExportTickets() {
        const form = document.getElementById('exportForm');
        const dateFrom = form.querySelector('[name="dateFrom"]').value;
        const dateTo = form.querySelector('[name="dateTo"]').value;
        const category = document.getElementById('exportCategoryFilter').value;
        const priority = document.getElementById('exportPriorityFilter').value;
        const status = document.getElementById('exportStatusFilter').value;
        const queue = document.getElementById('exportQueueFilter').value;
        const company = document.getElementById('exportCompanyFilter').value;

        return allTickets.filter(ticket => {
            if (dateFrom && ticket.created < dateFrom) return false;
            if (dateTo && ticket.created > dateTo + 'T23:59:59') return false;
            if (category !== 'all' && ticket.category !== category) return false;
            if (priority !== 'all' && ticket.priority !== priority) return false;
            if (status !== 'all' && ticket.status !== status) return false;
            if (queue !== 'all' && ticket.queue !== queue) return false;
            if (company !== 'all' && ticket.companyId != company) return false;
            return true;
        });
    }

    function displayPreview(tickets) {
        const tbody = document.getElementById('previewTableBody');
        const emptyState = document.getElementById('previewEmptyState');
        const container = document.getElementById('previewTableContainer');

        document.getElementById('previewCount').textContent = tickets.length + ' tickets';

        if (tickets.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            container.querySelector('table').style.display = 'none';
        } else {
            emptyState.style.display = 'none';
            container.querySelector('table').style.display = '';
            tbody.innerHTML = tickets.slice(0, 50).map(t => `
                <tr>
                    <td>#${t.id}</td>
                    <td>${escapeHtml(t.subject)}</td>
                    <td>${t.status || '-'}</td>
                    <td>${t.priority || '-'}</td>
                    <td>${t.category || '-'}</td>
                    <td>${t.created ? new Date(t.created).toLocaleDateString() : '-'}</td>
                </tr>
            `).join('');

            if (tickets.length > 50) {
                tbody.innerHTML += `<tr><td colspan="6" style="text-align:center;color:#666;">...and ${tickets.length - 50} more tickets</td></tr>`;
            }
        }
    }

    function executeExport() {
        const mode = document.getElementById('exportMode').value;
        const params = new URLSearchParams();
        params.append('mode', mode);

        if (mode === 'filtered') {
            const form = document.getElementById('exportForm');
            const dateFrom = form.querySelector('[name="dateFrom"]').value;
            const dateTo = form.querySelector('[name="dateTo"]').value;
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            if (document.getElementById('exportCategoryFilter').value !== 'all') params.append('category', document.getElementById('exportCategoryFilter').value);
            if (document.getElementById('exportPriorityFilter').value !== 'all') params.append('priority', document.getElementById('exportPriorityFilter').value);
            if (document.getElementById('exportStatusFilter').value !== 'all') params.append('status', document.getElementById('exportStatusFilter').value);
            if (document.getElementById('exportQueueFilter').value !== 'all') params.append('queue', document.getElementById('exportQueueFilter').value);
            if (document.getElementById('exportCompanyFilter').value !== 'all') params.append('company', document.getElementById('exportCompanyFilter').value);
        } else if (mode === 'selected') {
            const selectedIds = Array.from(document.querySelectorAll('input[name="selectedTickets"]:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                alert('Please select at least one ticket to export.');
                return;
            }
            params.append('ticket_ids', selectedIds.join(','));
        }

        window.open(`{{ url_for('tickets.export_tickets_csv') }}?${params.toString()}`, '_blank');
        hideExportWizard();
    }

    // Check URL parameter to show export wizard
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('showExportWizard') === 'true') {
        // Wait for tickets to load then show wizard
        setTimeout(() => showExportWizard(), 500);
    }
</script>

<!-- Export Wizard Modal -->
<div id="exportWizardModal" class="export-wizard-modal" style="display: none;">
    <div class="export-wizard-content">
        <div class="export-wizard-header">
            <h3>Ticket Export Wizard</h3>
            <button type="button" onclick="hideExportWizard()" class="close-button">&times;</button>
        </div>

        <form id="exportForm" class="export-wizard-body">
            <div class="export-section">
                <label class="export-label">Export Mode:</label>
                <select id="exportMode" name="exportMode" onchange="toggleExportMode()" class="export-select">
                    <option value="all">Export All Tickets</option>
                    <option value="filtered">Export by Filters</option>
                    <option value="selected">Export Selected Tickets</option>
                </select>
            </div>

            <div id="filterExportSection" class="export-section" style="display: none;">
                <h4 class="export-subsection-title">Filter Options</h4>
                <div class="export-filter-grid">
                    <div class="export-filter-group full-width">
                        <label class="export-label">Date Range:</label>
                        <div class="date-range-inputs">
                            <input type="date" name="dateFrom" class="export-input" placeholder="From">
                            <span class="date-separator">to</span>
                            <input type="date" name="dateTo" class="export-input" placeholder="To">
                        </div>
                    </div>
                    <div class="export-filter-group">
                        <label class="export-label">Status:</label>
                        <select id="exportStatusFilter" name="statusFilter" class="export-select">
                            <option value="all">All Statuses</option>
                            <option value="New">New</option>
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Waiting">Waiting</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                            {% for status in custom_statuses %}
                            <option value="{{ status.name }}">{{ status.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="export-filter-group">
                        <label class="export-label">Priority:</label>
                        <select id="exportPriorityFilter" name="priorityFilter" class="export-select">
                            <option value="all">All Priorities</option>
                        </select>
                    </div>
                    <div class="export-filter-group">
                        <label class="export-label">Category:</label>
                        <select id="exportCategoryFilter" name="categoryFilter" class="export-select">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                    <div class="export-filter-group">
                        <label class="export-label">Queue:</label>
                        <select id="exportQueueFilter" name="queueFilter" class="export-select">
                            <option value="all">All Queues</option>
                        </select>
                    </div>
                    <div class="export-filter-group full-width">
                        <label class="export-label">Company:</label>
                        <select id="exportCompanyFilter" name="companyFilter" class="export-select">
                            <option value="all">All Companies</option>
                        </select>
                    </div>
                    <div class="export-filter-group full-width" style="margin-top: 8px;">
                        <button type="button" onclick="applyExportFilters()" class="wizard-button apply-filter-button">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <span id="filterResultCount" class="filter-result-count"></span>
                    </div>
                </div>
            </div>

            <div id="selectionExportSection" class="export-section" style="display: none;">
                <div class="selection-header">
                    <h4 class="export-subsection-title">Select Tickets to Export</h4>
                    <div class="selection-actions">
                        <button type="button" onclick="selectAllExportTickets()" class="selection-button">Select All</button>
                        <button type="button" onclick="clearSelectedExportTickets()" class="selection-button">Clear All</button>
                    </div>
                </div>
                <div class="ticket-search-container" style="margin-bottom: 16px;">
                    <input type="text" id="ticketSearchInput" class="ticket-search-input" placeholder="Search by ticket number or title..." onkeyup="filterExportTicketList()">
                </div>
                <div id="ticketSelectionList" class="ticket-selection-container"></div>
            </div>

            <div id="exportPreviewSection" class="export-section" style="display: none;">
                <div class="preview-header">
                    <h4 class="export-subsection-title">Export Preview</h4>
                    <div class="preview-summary"><span id="previewCount">0 tickets</span> will be exported</div>
                </div>
                <div id="previewTableContainer" class="preview-table-container">
                    <table class="preview-table">
                        <thead>
                            <tr><th>Ticket ID</th><th>Subject</th><th>Status</th><th>Priority</th><th>Category</th><th>Created Date</th></tr>
                        </thead>
                        <tbody id="previewTableBody"></tbody>
                    </table>
                    <div id="previewEmptyState" class="preview-empty-state" style="display: none;">
                        <i class="fas fa-inbox" style="font-size: 48px; color: #d1d5db; margin-bottom: 16px;"></i>
                        <p>No tickets match your current selection criteria.</p>
                    </div>
                </div>
            </div>
        </form>

        <div class="export-wizard-footer">
            <button type="button" onclick="hideExportWizard()" class="wizard-button cancel-button">Cancel</button>
            <button type="button" onclick="showPreview()" id="previewButton" class="wizard-button preview-button">Preview Export</button>
            <button type="button" onclick="executeExport()" id="exportButton" class="wizard-button export-button" style="display: none;">Export to CSV</button>
        </div>
    </div>
</div>

<style>
.export-wizard-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
.export-wizard-content { background: white; border-radius: 8px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.export-wizard-header { padding: 20px 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: #f9fafb; border-radius: 8px 8px 0 0; }
.export-wizard-header h3 { margin: 0; font-size: 1.25rem; font-weight: 600; color: #111827; }
.export-wizard-header .close-button { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
.export-wizard-body { padding: 24px; }
.export-wizard-footer { padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px; background: #f9fafb; border-radius: 0 0 8px 8px; }
.export-section { margin-bottom: 24px; }
.export-label { display: block; font-weight: 500; margin-bottom: 8px; color: #374151; font-size: 13px; }
.export-select, .export-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
.export-filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.export-filter-group { margin-bottom: 0; }
.export-filter-group.full-width { grid-column: 1 / -1; }
.export-subsection-title { font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 16px 0; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb; }
.date-range-inputs { display: flex; align-items: center; gap: 12px; }
.date-range-inputs .export-input { flex: 1; min-width: 0; }
.date-separator { color: #6b7280; font-size: 13px; flex-shrink: 0; }
.wizard-button { padding: 10px 20px; border-radius: 6px; font-weight: 500; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
.cancel-button { background: #f3f4f6; color: #374151; }
.preview-button { background: #3b82f6; color: white; }
.export-button { background: #10b981; color: white; }
.apply-filter-button { background: #6366f1; color: white; }
.wizard-button:hover { opacity: 0.9; }
.filter-result-count { margin-left: 12px; font-size: 13px; color: #374151; font-weight: 500; }
.selection-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.selection-actions { display: flex; gap: 8px; }
.selection-button { padding: 6px 12px; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; }
.ticket-selection-container { max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px; }
.ticket-selection-item { padding: 8px; border-bottom: 1px solid #f3f4f6; }
.ticket-selection-item:last-child { border-bottom: none; }
.ticket-selection-label { display: flex; align-items: center; gap: 12px; cursor: pointer; }
.ticket-selection-label input { width: 16px; height: 16px; }
.ticket-info { flex: 1; }
.ticket-status { display: inline-block; padding: 2px 8px; background: #f3f4f6; border-radius: 4px; font-size: 12px; margin-left: 8px; }
.ticket-search-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; }
.preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.preview-summary { color: #6b7280; font-size: 14px; }
.preview-count { font-weight: 600; color: #3b82f6; }
.preview-table-container { max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; }
.preview-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.preview-table th, .preview-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #f3f4f6; }
.preview-table th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; }
.preview-empty-state { padding: 40px; text-align: center; color: #6b7280; }
</style>
{% endblock %}
