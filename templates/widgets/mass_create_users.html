<div style="text-align: center;">
    <div style="width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem; background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);">
        <i class="fas fa-users-cog" style="color: white; font-size: 1.5rem;"></i>
    </div>
    <div style="font-size: 0.875rem; font-weight: 600; color: var(--sf-gray-800); margin-bottom: 0.25rem;">Mass Create Users</div>
    <div style="font-size: 0.75rem; color: var(--sf-gray-500); margin-bottom: 1rem;">Clone settings & create multiple users</div>
    <button onclick="openMassCreateModal()" style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%); color: white; border: none; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
        <i class="fas fa-user-plus"></i> Create Users
    </button>
</div>

<!-- Mass Create Users Modal -->
<div id="massCreateModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 1rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
        <!-- Modal Header -->
        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="font-size: 1.25rem; font-weight: 600; color: #111827; margin: 0;">Mass Create Users</h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0 0 0;">Clone permissions from existing user</p>
            </div>
            <button onclick="closeMassCreateModal()" style="background: none; border: none; cursor: pointer; padding: 0.5rem;">
                <i class="fas fa-times" style="color: #9ca3af; font-size: 1.25rem;"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <form id="massCreateForm" onsubmit="submitMassCreate(event)" style="padding: 1.5rem;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Step 1: Select Source User -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                    <i class="fas fa-user-shield" style="color: #8B5CF6;"></i> Clone Settings From
                </label>
                <select id="sourceUser" name="source_user_id" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem;">
                    <option value="">-- Select a user to clone --</option>
                </select>
                <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                    <i class="fas fa-info-circle"></i> User type, permissions, and settings will be copied to new users
                </p>
            </div>

            <!-- Step 2: Paste Emails -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                    <i class="fas fa-envelope" style="color: #8B5CF6;"></i> Paste Email List
                </label>
                <textarea id="emailList" placeholder="Paste emails here (one per line or comma-separated)&#10;e.g.&#10;john@company.com&#10;jane@company.com, bob@company.com"
                    style="width: 100%; height: 120px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; font-family: monospace; resize: vertical;"
                    oninput="parseEmails()"></textarea>
                <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                    <i class="fas fa-info-circle"></i> Username will be auto-generated from email (e.g., john@company.com â†’ john)
                </p>
            </div>

            <!-- Step 3: User Details Preview -->
            <div id="userFieldsContainer" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <label style="font-size: 0.875rem; font-weight: 600; color: #374151;">
                        <i class="fas fa-users" style="color: #8B5CF6;"></i> Users to Create (<span id="userCount">0</span>)
                    </label>
                    <button type="button" onclick="addEmptyRow()" style="padding: 0.375rem 0.75rem; background: #e5e7eb; color: #374151; border: none; border-radius: 0.375rem; font-size: 0.75rem; cursor: pointer;">
                        <i class="fas fa-plus"></i> Add Row
                    </button>
                </div>
                <div id="userFields" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto; padding-right: 0.5rem;">
                    <!-- User fields will be generated here -->
                </div>
            </div>

            <!-- Auto-generate Password Option -->
            <div style="margin-top: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="autoPassword" name="auto_password" checked style="accent-color: #8B5CF6;">
                    <span style="font-size: 0.875rem; color: #374151;">Auto-generate secure passwords</span>
                </label>
                <p style="font-size: 0.75rem; color: #6b7280; margin: 0.25rem 0 0 1.5rem;">
                    Passwords will be shown in the confirmation message
                </p>
            </div>

            <!-- Modal Footer -->
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                <button type="button" onclick="closeMassCreateModal()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
                <button type="submit" id="createBtn" disabled style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; opacity: 0.5;">
                    <i class="fas fa-user-plus"></i> Create Users
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .user-field-row {
        display: grid;
        grid-template-columns: 30px 1fr 1fr 30px;
        gap: 0.5rem;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: #f9fafb;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
    }
    .user-field-row input {
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.8125rem;
    }
    .user-field-row input:focus {
        outline: none;
        border-color: #8B5CF6;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
    }
    .user-num {
        width: 24px;
        height: 24px;
        background: #8B5CF6;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
    }
    .remove-row-btn {
        width: 24px;
        height: 24px;
        background: #fee2e2;
        color: #dc2626;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
    }
    .remove-row-btn:hover {
        background: #fecaca;
    }
</style>

<script>
let massCreateUsersLoaded = false;
let userRowCount = 0;

function openMassCreateModal() {
    document.getElementById('massCreateModal').style.display = 'flex';
    if (!massCreateUsersLoaded) {
        loadUsersForCloning();
        massCreateUsersLoaded = true;
    }
}

function closeMassCreateModal() {
    document.getElementById('massCreateModal').style.display = 'none';
}

function loadUsersForCloning() {
    fetch('/admin/api/users-for-cloning')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const select = document.getElementById('sourceUser');
            select.innerHTML = '<option value="">-- Select a user to clone --</option>';

            if (!data.success || !data.users) {
                console.error('API error:', data.error || 'Unknown error');
                select.innerHTML = '<option value="">Error loading users</option>';
                return;
            }

            if (data.users.length === 0) {
                select.innerHTML = '<option value="">No users available</option>';
                return;
            }

            data.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.username} (${user.user_type}${user.company ? ' - ' + user.company : ''})`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading users:', error);
            const select = document.getElementById('sourceUser');
            select.innerHTML = '<option value="">Error: ' + error.message + '</option>';
        });
}

function parseEmails() {
    const emailText = document.getElementById('emailList').value;
    const container = document.getElementById('userFieldsContainer');
    const fields = document.getElementById('userFields');

    // Parse emails - split by newlines, commas, semicolons, or spaces
    const emails = emailText
        .split(/[\n,;\s]+/)
        .map(e => e.trim().toLowerCase())
        .filter(e => e && e.includes('@'));

    if (emails.length === 0) {
        container.style.display = 'none';
        updateCreateButton();
        return;
    }

    container.style.display = 'block';
    fields.innerHTML = '';
    userRowCount = 0;

    emails.forEach((email, index) => {
        addUserRow(email);
    });

    updateCreateButton();
}

function addUserRow(email = '') {
    userRowCount++;
    const fields = document.getElementById('userFields');
    const container = document.getElementById('userFieldsContainer');
    container.style.display = 'block';

    // Generate username from email
    const username = email ? email.split('@')[0].replace(/[^a-z0-9._-]/gi, '') : '';

    const row = document.createElement('div');
    row.className = 'user-field-row';
    row.dataset.rowId = userRowCount;
    row.innerHTML = `
        <div class="user-num">${userRowCount}</div>
        <input type="text" name="username_${userRowCount}" placeholder="Username" value="${username}">
        <input type="email" name="email_${userRowCount}" placeholder="Email" value="${email}">
        <button type="button" class="remove-row-btn" onclick="removeRow(${userRowCount})">
            <i class="fas fa-times"></i>
        </button>
    `;
    fields.appendChild(row);

    document.getElementById('userCount').textContent = fields.children.length;
    updateCreateButton();
}

function addEmptyRow() {
    addUserRow('');
    // Focus the new username field
    const fields = document.getElementById('userFields');
    const lastRow = fields.lastElementChild;
    if (lastRow) {
        const usernameInput = lastRow.querySelector('input[type="text"]');
        if (usernameInput) usernameInput.focus();
    }
}

function removeRow(rowId) {
    const row = document.querySelector(`.user-field-row[data-row-id="${rowId}"]`);
    if (row) {
        row.remove();
        renumberRows();
        updateCreateButton();
    }
}

function renumberRows() {
    const fields = document.getElementById('userFields');
    const rows = fields.querySelectorAll('.user-field-row');
    rows.forEach((row, index) => {
        const num = row.querySelector('.user-num');
        if (num) num.textContent = index + 1;
    });
    document.getElementById('userCount').textContent = rows.length;
}

function updateCreateButton() {
    const sourceUser = document.getElementById('sourceUser').value;
    const fields = document.getElementById('userFields');
    const rows = fields.querySelectorAll('.user-field-row');
    const btn = document.getElementById('createBtn');

    // Check if at least one row has both username and email filled
    let hasValidRow = false;
    rows.forEach(row => {
        const username = row.querySelector('input[type="text"]').value.trim();
        const email = row.querySelector('input[type="email"]').value.trim();
        if (username && email) hasValidRow = true;
    });

    if (sourceUser && hasValidRow) {
        btn.disabled = false;
        btn.style.opacity = '1';
    } else {
        btn.disabled = true;
        btn.style.opacity = '0.5';
    }
}

document.getElementById('sourceUser').addEventListener('change', updateCreateButton);

function submitMassCreate(event) {
    event.preventDefault();

    const sourceUser = document.getElementById('sourceUser').value;
    const autoPassword = document.getElementById('autoPassword').checked;
    const fields = document.getElementById('userFields');
    const rows = fields.querySelectorAll('.user-field-row');

    // Collect user data
    const users = [];
    rows.forEach((row, index) => {
        const username = row.querySelector('input[type="text"]').value.trim();
        const email = row.querySelector('input[type="email"]').value.trim();
        if (username && email) {
            users.push({ username, email, index: index + 1 });
        }
    });

    if (users.length === 0) {
        alert('Please add at least one user with username and email');
        return;
    }

    const btn = document.getElementById('createBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

    // Build form data
    const formData = new FormData();
    formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
    formData.append('source_user_id', sourceUser);
    formData.append('user_count', users.length);
    formData.append('auto_password', autoPassword ? 'on' : '');

    users.forEach((user, i) => {
        formData.append(`username_${i + 1}`, user.username);
        formData.append(`email_${i + 1}`, user.email);
    });

    fetch('/admin/mass-create-users', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully created ${data.created_count} users!\n\n${data.message}`);
            closeMassCreateModal();
            location.reload();
        } else {
            alert('Error: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-user-plus"></i> Create Users';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating users. Please try again.');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-user-plus"></i> Create Users';
    });
}

// Close modal when clicking outside
document.getElementById('massCreateModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeMassCreateModal();
    }
});
</script>
