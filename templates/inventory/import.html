{% extends "base.html" %}

{% block title %}Import Inventory/Assets{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="p-4 mb-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if preview_data %}
        <!-- Asset Count Display -->
        <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">Import Summary</h3>
                    <div class="mt-2 text-sm text-blue-700">
                        <p>Total {{ import_type|replace('_', ' ')|title }} to be imported: <span class="font-bold">{{ preview_data|length }}</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Missing Required Fields Summary -->
        {% set missing_fields = [] %}
        {% for row in preview_data %}
            {% if import_type == 'tech_assets' %}
                {% if not row['Asset Type'] %}
                    {% set _ = missing_fields.extend([{'row': loop.index, 'field': 'Asset Type'}]) %}
                {% endif %}
                {% if not row['Asset Tag'] %}
                    {% set _ = missing_fields.extend([{'row': loop.index, 'field': 'Asset Tag'}]) %}
                {% endif %}
            {% else %}
                {% if not row['Name'] %}
                    {% set _ = missing_fields.extend([{'row': loop.index, 'field': 'Name'}]) %}
                {% endif %}
                {% if not row['Category'] %}
                    {% set _ = missing_fields.extend([{'row': loop.index, 'field': 'Category'}]) %}
                {% endif %}
            {% endif %}
        {% endfor %}

        {% if missing_fields %}
        <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Missing Required Fields</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p>Please fill in the following required fields before importing:</p>
                        <ul class="list-disc list-inside mt-1">
                            {% for item in missing_fields %}
                            <li>Row {{ item.row }}: {{ item.field }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Duplicate Items Warning -->
        {% set duplicate_items = [] %}
        {% for row in preview_data %}
            {% if row.get('is_duplicate') %}
                {% set _ = duplicate_items.append({'row': loop.index, 'warning': row.get('duplicate_warning'), 'serial': row.get('Serial Number'), 'tag': row.get('Asset Tag'), 'name': row.get('Name')}) %}
            {% endif %}
        {% endfor %}

        {% if duplicate_items %}
        <div class="mb-6 p-4 bg-red-50 border-l-4 border-red-400 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">‚ö†Ô∏è Duplicate Items Detected</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <p class="font-semibold">The following items already exist in the system and will fail to import:</p>
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            {% for item in duplicate_items[:10] %}
                            <li>
                                <strong>Row {{ item.row }}:</strong>
                                {% if item.serial %}
                                    Serial: {{ item.serial }} -
                                {% elif item.tag %}
                                    Tag: {{ item.tag }} -
                                {% elif item.name %}
                                    Name: {{ item.name }} -
                                {% endif %}
                                <span class="text-red-600">{{ item.warning }}</span>
                            </li>
                            {% endfor %}
                            {% if duplicate_items|length > 10 %}
                            <li class="text-red-600 font-semibold">... and {{ duplicate_items|length - 10 }} more duplicates</li>
                            {% endif %}
                        </ul>
                        <p class="mt-3 text-red-800 font-semibold">
                            üí° <strong>Tip:</strong> Remove these rows from your CSV or update the existing items individually in the inventory. Importing will skip these duplicate items.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Preview Data Display -->
        <div class="mb-6">
            <form id="importForm" action="{{ url_for('inventory.confirm_import') }}" method="POST" class="space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="filename" value="{{ filename }}">
                <input type="hidden" name="filepath" value="{{ session.get('import_filepath', '') }}">
                <input type="hidden" name="import_type" value="{{ import_type }}">
                <input type="hidden" name="row_count" value="{{ preview_data|length }}">
                
                <!-- Add explicit fields for Asset Tag values -->
                {% for row in preview_data %}
                    {% if not row['Asset Tag'] %}
                        <input type="hidden" name="asset_tag_{{ loop.index }}" id="direct_asset_tag_{{ loop.index0 }}" value="">
                    {% else %}
                        <input type="hidden" name="asset_tag_{{ loop.index }}" id="direct_asset_tag_{{ loop.index0 }}" value="{{ row['Asset Tag'] }}">
                    {% endif %}
                {% endfor %}
                
                <!-- Store the complete preview data -->
                {% for row in preview_data %}
                    <input type="hidden" name="preview_data[{{ loop.index0 }}]" id="preview_data_{{ loop.index0 }}" value='{{ row|tojson|safe }}'>
                {% endfor %}

                <!-- Display and input fields for missing values -->
                {% for row in preview_data %}
                    {% if import_type == 'tech_assets' %}
                        <div class="{% if row.get('is_duplicate') %}bg-red-50 border-2 border-red-300{% else %}bg-white{% endif %} rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                            {% if row.get('is_duplicate') %}
                            <div class="mb-4 p-3 bg-red-100 border border-red-400 rounded">
                                <p class="text-sm font-semibold text-red-800">
                                    ‚ö†Ô∏è DUPLICATE: {{ row.get('duplicate_warning') }}
                                </p>
                            </div>
                            {% endif %}
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Basic Information</h3>
                                    <div class="space-y-2">
                                        {% if not row['Asset Tag'] %}
                                            <div class="bg-red-50 p-2 rounded border border-red-200">
                                                <label class="text-sm font-medium">Asset Tag for Row {{ loop.index }}:</label>
                                                <div class="flex space-x-2">
                                                    <input type="text" 
                                                           name="asset_tag_input_{{ loop.index0 }}" 
                                                           class="mt-1 block w-full rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 required-field"
                                                           placeholder="Required field"
                                                           required>
                                                    <button type="button"
                                                            data-row="{{ loop.index0 }}"
                                                            data-field="Asset Tag"
                                                            class="confirm-button mt-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                                                        Confirm
                                                    </button>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="p-2">
                                                <label class="text-sm font-medium">Asset Tag:</label>
                                                <p class="text-sm">{{ row['Asset Tag'] }}</p>
                                            </div>
                                        {% endif %}

                                        <p class="text-sm"><span class="font-medium">Serial Number:</span> {{ row['Serial Number'] }}</p>
                                        <p class="text-sm"><span class="font-medium">Product:</span> {{ row['Product'] }}</p>
                                        <p class="text-sm"><span class="font-medium">Model:</span> {{ row['Model'] }}</p>
                                        <p class="text-sm"><span class="font-medium">Hardware Type:</span> {{ row['Hardware Type'] }}</p>
                                    </div>
                                </div>

                                <!-- Rest of the preview sections -->
                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Notes</h3>
                                    <div class="space-y-2">
                                        <p class="text-sm"><span class="font-medium">General Notes:</span> {{ row['Notes'] or 'N/A' }}</p>
                                        <p class="text-sm"><span class="font-medium">Technical Notes:</span> {{ row['Tech Notes'] or 'N/A' }}</p>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Hardware Specifications</h3>
                                    <div class="space-y-2">
                                        <p class="text-sm"><span class="font-medium">CPU:</span> {{ row['CPU Type'] }}, {{ row['CPU Cores'] }} cores</p>
                                        <p class="text-sm"><span class="font-medium">GPU:</span> {{ row['GPU Cores'] }} cores</p>
                                        <p class="text-sm"><span class="font-medium">Memory:</span> {{ row['Memory'] }}GB</p>
                                        <p class="text-sm"><span class="font-medium">Storage:</span> {{ row['Hard Drive'] }}GB</p>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Status & Location</h3>
                                    <div class="space-y-2">
                                        <p class="text-sm"><span class="font-medium">Status:</span> {{ row['Status'] }}</p>
                                        <p class="text-sm"><span class="font-medium">Customer:</span> {{ row['Customer'] }}</p>
                                        <p class="text-sm"><span class="font-medium">Country:</span> {{ row['Country'] }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <!-- Accessories Preview Display -->
                        <div class="{% if row.get('is_duplicate') %}bg-red-50 border-2 border-red-300{% else %}bg-white{% endif %} rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                            {% if row.get('is_duplicate') %}
                            <div class="mb-4 p-3 bg-red-100 border border-red-400 rounded">
                                <p class="text-sm font-semibold text-red-800">
                                    ‚ö†Ô∏è DUPLICATE: {{ row.get('duplicate_warning') }}
                                </p>
                            </div>
                            {% endif %}
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Basic Information</h3>
                                    <div class="space-y-2">
                                        {% if not row['Name'] %}
                                            <div class="bg-red-50 p-2 rounded border border-red-200">
                                                <label class="text-sm font-medium">Name for Row {{ loop.index }}:</label>
                                                <div class="flex space-x-2">
                                                    <input type="text" 
                                                           name="name_input_{{ loop.index0 }}" 
                                                           class="mt-1 block w-full rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 required-field"
                                                           placeholder="Required field"
                                                           required>
                                                    <button type="button"
                                                            data-row="{{ loop.index0 }}"
                                                            data-field="Name"
                                                            class="confirm-button mt-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                                                        Confirm
                                                    </button>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="p-2">
                                                <label class="text-sm font-medium">Name:</label>
                                                <p class="text-sm">{{ row['Name'] }}</p>
                                            </div>
                                        {% endif %}
                                        
                                        {% if not row['Category'] %}
                                            <div class="bg-red-50 p-2 rounded border border-red-200">
                                                <label class="text-sm font-medium">Category for Row {{ loop.index }}:</label>
                                                <div class="flex space-x-2">
                                                    <input type="text" 
                                                           name="category_input_{{ loop.index0 }}" 
                                                           class="mt-1 block w-full rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 required-field"
                                                           placeholder="Required field"
                                                           required>
                                                    <button type="button"
                                                            data-row="{{ loop.index0 }}"
                                                            data-field="Category"
                                                            class="confirm-button mt-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                                                        Confirm
                                                    </button>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="p-2">
                                                <label class="text-sm font-medium">Category:</label>
                                                <p class="text-sm">{{ row['Category'] }}</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Details</h3>
                                    <div class="space-y-2">
                                        <p class="text-sm"><span class="font-medium">Manufacturer:</span> {{ row['Manufacturer'] or 'N/A' }}</p>
                                        <p class="text-sm"><span class="font-medium">Model Number:</span> {{ row['Model Number'] or 'N/A' }}</p>
                                        <p class="text-sm"><span class="font-medium">Total Quantity:</span> {{ row['Total Quantity'] or '0' }}</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Status & Location</h3>
                                    <div class="space-y-2">
                                        <p class="text-sm"><span class="font-medium">Status:</span> {{ row['Status'] or 'Available' }}</p>
                                        <p class="text-sm"><span class="font-medium">Country:</span> {{ row['Country'] or 'N/A' }}</p>
                                        <p class="text-sm"><span class="font-medium">Notes:</span> {{ row['Notes'] or 'N/A' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- Extra debug element for the confirmations -->
                <div id="debug_confirmation_status" style="display:none;">
                    <h3>Debug Information:</h3>
                    <div id="debug_values"></div>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="submit" 
                            id="submitButton"
                            class="px-6 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors duration-200 bg-gray-400 cursor-not-allowed"
                            disabled>
                        Confirm and Process Import
                    </button>
                </div>
            </form>
        </div>
    {% else %}
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Import Inventory/Assets</h1>
            <p class="mt-2 text-gray-600">Upload a CSV file to import Tech Assets or Accessories into the inventory system</p>
        </div>

        <!-- Instructions Card -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-blue-900 mb-3">üìã Instructions</h2>
            <ol class="list-decimal list-inside space-y-2 text-blue-800">
                <li>Select the import type (Tech Assets or Accessories)</li>
                <li>Download the CSV template for your selected type</li>
                <li>Fill in your data following the format guidelines</li>
                <li>Upload the completed CSV file and preview before confirming</li>
            </ol>
        </div>

        <!-- Download Templates -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Download Templates</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <a href="{{ url_for('inventory.download_template', template_type='tech_assets') }}"
                   download
                   class="flex items-center justify-center px-4 py-3 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Tech Assets Template
                </a>
                <a href="{{ url_for('inventory.download_template', template_type='accessories') }}"
                   download
                   class="flex items-center justify-center px-4 py-3 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Accessories Template
                </a>
            </div>
        </div>

        <!-- CSV Format Requirements -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">CSV Format Requirements</h2>

            <div id="tech_assets_format">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">For Tech Assets - Required Columns:</h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-gray-600 mb-4">
                    <li><code class="bg-gray-100 px-1 rounded">ASSET TYPE</code> - Type of asset (required)</li>
                    <li><code class="bg-gray-100 px-1 rounded">ASSET TAG</code> - Unique asset tag (required)</li>
                </ul>
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Optional Columns:</h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-gray-600">
                    <li><code class="bg-gray-100 px-1 rounded">SERIAL NUMBER</code>, <code class="bg-gray-100 px-1 rounded">MODEL</code>, <code class="bg-gray-100 px-1 rounded">HARDWARE TYPE</code></li>
                    <li><code class="bg-gray-100 px-1 rounded">CPU TYPE</code>, <code class="bg-gray-100 px-1 rounded">CPU CORES</code>, <code class="bg-gray-100 px-1 rounded">GPU CORES</code>, <code class="bg-gray-100 px-1 rounded">MEMORY</code>, <code class="bg-gray-100 px-1 rounded">HARD DRIVE</code></li>
                    <li><code class="bg-gray-100 px-1 rounded">STATUS</code>, <code class="bg-gray-100 px-1 rounded">CUSTOMER</code>, <code class="bg-gray-100 px-1 rounded">COUNTRY</code>, <code class="bg-gray-100 px-1 rounded">PO</code>, <code class="bg-gray-100 px-1 rounded">RECEIVING DATE</code></li>
                    <li><code class="bg-gray-100 px-1 rounded">NOTES</code>, <code class="bg-gray-100 px-1 rounded">TECH NOTES</code>, <code class="bg-gray-100 px-1 rounded">CONDITION</code>, <code class="bg-gray-100 px-1 rounded">DIAGNOSTIC</code></li>
                    <li><code class="bg-gray-100 px-1 rounded">ERASED</code>, <code class="bg-gray-100 px-1 rounded">KEYBOARD</code>, <code class="bg-gray-100 px-1 rounded">CHARGER</code>, <code class="bg-gray-100 px-1 rounded">INCLUDED</code></li>
                </ul>
            </div>

            <div id="accessories_format" class="hidden">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">For Accessories - Required Columns:</h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-gray-600 mb-4">
                    <li><code class="bg-gray-100 px-1 rounded">NAME</code> - Name of the accessory (required)</li>
                    <li><code class="bg-gray-100 px-1 rounded">CATEGORY</code> - Category (required)</li>
                </ul>
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Optional Columns:</h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-gray-600">
                    <li><code class="bg-gray-100 px-1 rounded">MANUFACTURER</code>, <code class="bg-gray-100 px-1 rounded">MODEL NUMBER</code></li>
                    <li><code class="bg-gray-100 px-1 rounded">TOTAL QUANTITY</code>, <code class="bg-gray-100 px-1 rounded">COUNTRY</code>, <code class="bg-gray-100 px-1 rounded">STATUS</code>, <code class="bg-gray-100 px-1 rounded">NOTES</code></li>
                </ul>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mt-4">
                <p class="text-sm text-yellow-800">
                    <strong>Duplicate Detection:</strong> The system will detect existing assets by Serial Number or Asset Tag
                    and skip duplicates during import.
                </p>
            </div>
        </div>

        <!-- Upload Form -->
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Upload CSV File</h2>

            <form id="uploadForm" method="POST" enctype="multipart/form-data" class="space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div>
                    <label for="import_type" class="block text-sm font-medium text-gray-700 mb-2">Import Type</label>
                    <select name="import_type" id="import_type" required
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="tech_assets">Tech Assets</option>
                        <option value="accessories">Accessories</option>
                    </select>
                </div>

                <!-- Drag and Drop Zone -->
                <div id="dropZone"
                     class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50 hover:bg-blue-50 hover:border-blue-300 transition-colors cursor-pointer">
                    <input type="file"
                           id="file"
                           name="file"
                           accept=".csv"
                           required
                           class="hidden">
                    <div id="dropZoneContent">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="mt-2 text-sm text-gray-600">
                            <span class="font-semibold text-blue-600">Click to browse</span> or drag and drop
                        </p>
                        <p class="mt-1 text-xs text-gray-500">CSV file (Maximum 10MB)</p>
                    </div>
                    <div id="fileSelected" class="hidden">
                        <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="mt-2 text-sm font-semibold text-green-600" id="fileName"></p>
                        <p class="mt-1 text-xs text-gray-500">Click button below to import</p>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-4">
                    <a href="{{ url_for('inventory.view_inventory_sf') }}"
                       class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </a>
                    <button type="submit"
                            id="uploadBtn"
                            class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Upload and Import
                    </button>
                </div>
            </form>
        </div>

        <!-- Important Notes -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mt-6">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Important Notes:</h3>
            <ul class="list-disc list-inside space-y-1 text-sm text-gray-600">
                <li>Column headers are case-sensitive and must match exactly</li>
                <li>Empty cells are allowed for optional fields</li>
                <li>If a row has errors, it will be skipped and reported</li>
                <li>Valid rows will still be imported even if some rows fail</li>
                <li>Duplicate assets (by Serial Number or Asset Tag) will be skipped</li>
                <li>You will receive a detailed summary after import completes</li>
            </ul>
        </div>
    </div>
    {% endif %}
</div>

<!-- JavaScript for toggling format visibility and drag-drop -->
<script>
    // Toggle CSV format requirements based on import type selection
    const importTypeSelect = document.getElementById('import_type');
    if (importTypeSelect) {
        importTypeSelect.addEventListener('change', function() {
            const techFormat = document.getElementById('tech_assets_format');
            const accessoryFormat = document.getElementById('accessories_format');

            if (this.value === 'tech_assets') {
                techFormat.classList.remove('hidden');
                accessoryFormat.classList.add('hidden');
            } else {
                techFormat.classList.add('hidden');
                accessoryFormat.classList.remove('hidden');
            }
        });
    }

    // Drag and drop functionality
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('file');
    const dropZoneContent = document.getElementById('dropZoneContent');
    const fileSelected = document.getElementById('fileSelected');
    const fileName = document.getElementById('fileName');

    if (dropZone && fileInput) {
        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                showSelectedFile(this.files[0]);
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('border-blue-500', 'bg-blue-100');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-500', 'bg-blue-100');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-500', 'bg-blue-100');

            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.csv')) {
                fileInput.files = files;
                showSelectedFile(files[0]);
            } else {
                alert('Please drop a CSV file');
            }
        });

        function showSelectedFile(file) {
            dropZoneContent.classList.add('hidden');
            fileSelected.classList.remove('hidden');
            fileName.textContent = file.name;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('importForm');
        const submitButton = document.getElementById('submitButton');
        
        if (!form || !submitButton) return;

        // Function to update Asset Tag value
        function updateAssetTag(rowIndex, value) {
            const assetTagInput = document.getElementById(`direct_asset_tag_${rowIndex}`);
            if (assetTagInput) {
                assetTagInput.value = value;
                return true;
            }
            return false;
        }
        
        // Function to update preview data for both tech assets and accessories
        function updatePreviewData(rowIndex, field, value) {
            const previewDataInput = document.getElementById(`preview_data_${rowIndex}`);
            if (previewDataInput) {
                try {
                    const rowData = JSON.parse(previewDataInput.value);
                    rowData[field] = value;
                    previewDataInput.value = JSON.stringify(rowData);
                    return true;
                } catch (e) {
                    console.error('Error updating preview data:', e);
                    return false;
                }
            }
            return false;
        }

        // Function to check if all required fields are filled
        function checkAllFieldsConfirmed() {
            const importType = form.getAttribute('data-import-type') || '{{ import_type }}';
            let allValid = true;

            if (importType === 'tech_assets') {
                // Check Asset Type and Asset Tag fields
                document.querySelectorAll('[id^="preview_data_"]').forEach(input => {
                    try {
                        const rowData = JSON.parse(input.value);
                        if (!rowData['Asset Type'] || !rowData['Asset Tag']) {
                            allValid = false;
                        }
                    } catch (e) {
                        console.error('Error parsing preview data:', e);
                        allValid = false;
                    }
                });
            } else {
                // Check Name and Category fields for accessories
                document.querySelectorAll('[id^="preview_data_"]').forEach(input => {
                    try {
                        const rowData = JSON.parse(input.value);
                        if (!rowData['Name'] || !rowData['Category']) {
                            allValid = false;
                        }
                    } catch (e) {
                        console.error('Error parsing preview data:', e);
                        allValid = false;
                    }
                });
            }

            // Enable/disable submit button based on validation
            if (allValid) {
                submitButton.disabled = false;
                submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                submitButton.disabled = true;
                submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            }
        }

        // Add event listeners to confirm buttons
        document.querySelectorAll('.confirm-button').forEach(button => {
            button.addEventListener('click', function() {
                const rowIndex = this.getAttribute('data-row');
                const field = this.getAttribute('data-field');
                
                let input;
                if (field === 'Asset Tag') {
                    input = document.querySelector(`input[name="asset_tag_input_${rowIndex}"]`);
                } else if (field === 'Name') {
                    input = document.querySelector(`input[name="name_input_${rowIndex}"]`);
                } else if (field === 'Category') {
                    input = document.querySelector(`input[name="category_input_${rowIndex}"]`);
                }
                
                if (!input || !input.value.trim()) {
                    alert('Please enter a value before confirming.');
                    return;
                }

                const value = input.value.trim();
                
                // Update both preview data and specific field
                if (updatePreviewData(rowIndex, field, value)) {
                    if (field === 'Asset Tag') {
                        updateAssetTag(rowIndex, value);
                    }
                    
                    // Update UI to show confirmation
                    input.readOnly = true;
                    input.style.backgroundColor = '#f0fdf4';
                    this.textContent = 'Confirmed ‚úì';
                    this.disabled = true;
                    this.classList.remove('bg-blue-100', 'text-blue-700', 'hover:bg-blue-200');
                    this.classList.add('bg-green-100', 'text-green-700', 'confirmed');
                    
                    // Check if all fields are now valid
                    checkAllFieldsConfirmed();
                } else {
                    alert('Error updating field. Please try again.');
                }
            });
        });

        // Add input event listeners to required fields
        document.querySelectorAll('.required-field').forEach(input => {
            input.addEventListener('input', () => {
                const confirmButton = input.parentElement.querySelector('.confirm-button');
                if (confirmButton && !confirmButton.disabled) {
                    confirmButton.classList.toggle('bg-blue-200', input.value.trim() !== '');
                }
            });
        });

        // Initial check for all fields
        checkAllFieldsConfirmed();

        // Form submission handler
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            checkAllFieldsConfirmed();
            
            if (!submitButton.disabled) {
                form.submit();
            } else {
                alert('Some required fields are missing. Please confirm all required fields.');
            }
        });
    });
</script>
{% endblock %} 