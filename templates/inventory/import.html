{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h1 class="text-2xl font-bold mb-2">Data Import Tool</h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="p-4 mb-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    {% if preview_data %}
        <!-- Missing Required Fields Summary -->
        {% set missing_fields = [] %}
        {% for row in preview_data %}
            {% if import_type == 'tech_assets' %}
                {% if not row['Asset Type'] %}
                    {% set _ = missing_fields.extend([{'row': loop.index, 'field': 'Asset Type'}]) %}
                {% endif %}
                {% if not row['Asset Tag'] %}
                    {% set _ = missing_fields.extend([{'row': loop.index, 'field': 'Asset Tag'}]) %}
                {% endif %}
            {% else %}
                {% if not row['Name'] %}
                    {% set _ = missing_fields.extend([{'row': loop.index, 'field': 'Name'}]) %}
                {% endif %}
                {% if not row['Category'] %}
                    {% set _ = missing_fields.extend([{'row': loop.index, 'field': 'Category'}]) %}
                {% endif %}
            {% endif %}
        {% endfor %}

        {% if missing_fields %}
        <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Missing Required Fields</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p>Please fill in the following required fields before importing:</p>
                        <ul class="list-disc list-inside mt-1">
                            {% for item in missing_fields %}
                            <li>Row {{ item.row }}: {{ item.field }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Preview Data Display -->
        <div class="mb-6">
            <form id="importForm" action="{{ url_for('inventory.confirm_import') }}" method="POST" class="space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="filename" value="{{ filename }}">
                <input type="hidden" name="filepath" value="{{ session.get('import_filepath', '') }}">
                <input type="hidden" name="import_type" value="{{ import_type }}">
                <input type="hidden" name="row_count" value="{{ preview_data|length }}">
                
                <!-- Add explicit fields for Asset Tag values -->
                {% for row in preview_data %}
                    {% if not row['Asset Tag'] %}
                        <input type="hidden" name="asset_tag_{{ loop.index }}" id="direct_asset_tag_{{ loop.index0 }}" value="">
                    {% else %}
                        <input type="hidden" name="asset_tag_{{ loop.index }}" id="direct_asset_tag_{{ loop.index0 }}" value="{{ row['Asset Tag'] }}">
                    {% endif %}
                {% endfor %}
                
                <!-- Store the complete preview data -->
                {% for row in preview_data %}
                    <input type="hidden" name="preview_data[{{ loop.index0 }}]" id="preview_data_{{ loop.index0 }}" value='{{ row|tojson|safe }}'>
                {% endfor %}

                <!-- Display and input fields for missing values -->
                {% for row in preview_data %}
                    {% if import_type == 'tech_assets' %}
                        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Basic Information</h3>
                                    <div class="space-y-2">
                                        {% if not row['Asset Tag'] %}
                                            <div class="bg-red-50 p-2 rounded border border-red-200">
                                                <label class="text-sm font-medium">Asset Tag for Row {{ loop.index }}:</label>
                                                <div class="flex space-x-2">
                                                    <input type="text" 
                                                           name="asset_tag_input_{{ loop.index0 }}" 
                                                           class="mt-1 block w-full rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 required-field"
                                                           placeholder="Required field"
                                                           required>
                                                    <button type="button"
                                                            data-row="{{ loop.index0 }}"
                                                            data-field="Asset Tag"
                                                            class="confirm-button mt-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                                                        Confirm
                                                    </button>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="p-2">
                                                <label class="text-sm font-medium">Asset Tag:</label>
                                                <p class="text-sm">{{ row['Asset Tag'] }}</p>
                                            </div>
                                        {% endif %}

                                        <p class="text-sm"><span class="font-medium">Serial Number:</span> {{ row['Serial Number'] }}</p>
                                        <p class="text-sm"><span class="font-medium">Product:</span> {{ row['Product'] }}</p>
                                        <p class="text-sm"><span class="font-medium">Model:</span> {{ row['Model'] }}</p>
                                        <p class="text-sm"><span class="font-medium">Hardware Type:</span> {{ row['Hardware Type'] }}</p>
                                    </div>
                                </div>

                                <!-- Rest of the preview sections -->
                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Notes</h3>
                                    <div class="space-y-2">
                                        <p class="text-sm"><span class="font-medium">General Notes:</span> {{ row['Notes'] or 'N/A' }}</p>
                                        <p class="text-sm"><span class="font-medium">Technical Notes:</span> {{ row['Tech Notes'] or 'N/A' }}</p>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Hardware Specifications</h3>
                                    <div class="space-y-2">
                                        <p class="text-sm"><span class="font-medium">CPU:</span> {{ row['CPU Type'] }}, {{ row['CPU Cores'] }} cores</p>
                                        <p class="text-sm"><span class="font-medium">GPU:</span> {{ row['GPU Cores'] }} cores</p>
                                        <p class="text-sm"><span class="font-medium">Memory:</span> {{ row['Memory'] }}GB</p>
                                        <p class="text-sm"><span class="font-medium">Storage:</span> {{ row['Hard Drive'] }}GB</p>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Status & Location</h3>
                                    <div class="space-y-2">
                                        <p class="text-sm"><span class="font-medium">Status:</span> {{ row['Status'] }}</p>
                                        <p class="text-sm"><span class="font-medium">Customer:</span> {{ row['Customer'] }}</p>
                                        <p class="text-sm"><span class="font-medium">Country:</span> {{ row['Country'] }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <!-- Accessories Preview Display -->
                        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Basic Information</h3>
                                    <div class="space-y-2">
                                        {% if not row['Name'] %}
                                            <div class="bg-red-50 p-2 rounded border border-red-200">
                                                <label class="text-sm font-medium">Name for Row {{ loop.index }}:</label>
                                                <div class="flex space-x-2">
                                                    <input type="text" 
                                                           name="name_input_{{ loop.index0 }}" 
                                                           class="mt-1 block w-full rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 required-field"
                                                           placeholder="Required field"
                                                           required>
                                                    <button type="button"
                                                            data-row="{{ loop.index0 }}"
                                                            data-field="Name"
                                                            class="confirm-button mt-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                                                        Confirm
                                                    </button>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="p-2">
                                                <label class="text-sm font-medium">Name:</label>
                                                <p class="text-sm">{{ row['Name'] }}</p>
                                            </div>
                                        {% endif %}
                                        
                                        {% if not row['Category'] %}
                                            <div class="bg-red-50 p-2 rounded border border-red-200">
                                                <label class="text-sm font-medium">Category for Row {{ loop.index }}:</label>
                                                <div class="flex space-x-2">
                                                    <input type="text" 
                                                           name="category_input_{{ loop.index0 }}" 
                                                           class="mt-1 block w-full rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 required-field"
                                                           placeholder="Required field"
                                                           required>
                                                    <button type="button"
                                                            data-row="{{ loop.index0 }}"
                                                            data-field="Category"
                                                            class="confirm-button mt-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                                                        Confirm
                                                    </button>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="p-2">
                                                <label class="text-sm font-medium">Category:</label>
                                                <p class="text-sm">{{ row['Category'] }}</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Details</h3>
                                    <div class="space-y-2">
                                        <p class="text-sm"><span class="font-medium">Manufacturer:</span> {{ row['Manufacturer'] or 'N/A' }}</p>
                                        <p class="text-sm"><span class="font-medium">Model Number:</span> {{ row['Model Number'] or 'N/A' }}</p>
                                        <p class="text-sm"><span class="font-medium">Total Quantity:</span> {{ row['Total Quantity'] or '0' }}</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Status & Location</h3>
                                    <div class="space-y-2">
                                        <p class="text-sm"><span class="font-medium">Status:</span> {{ row['Status'] or 'Available' }}</p>
                                        <p class="text-sm"><span class="font-medium">Country:</span> {{ row['Country'] or 'N/A' }}</p>
                                        <p class="text-sm"><span class="font-medium">Notes:</span> {{ row['Notes'] or 'N/A' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- Extra debug element for the confirmations -->
                <div id="debug_confirmation_status" style="display:none;">
                    <h3>Debug Information:</h3>
                    <div id="debug_values"></div>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="submit" 
                            id="submitButton"
                            class="px-6 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors duration-200 bg-gray-400 cursor-not-allowed"
                            disabled>
                        Confirm and Process Import
                    </button>
                </div>
            </form>
        </div>
    {% else %}
        <!-- Upload Form -->
        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div>
                <label for="import_type" class="block text-sm font-medium text-gray-700 mb-2">Import Type</label>
                <select name="import_type" id="import_type" required
                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="tech_assets">Tech Assets</option>
                    <option value="accessories">Accessories</option>
                </select>
                <p class="mt-2 text-sm text-gray-500">Select the type of items you want to import.</p>
            </div>

            <!-- Download Template Buttons -->
            <div class="flex space-x-4">
                <div id="tech_assets_template">
                    <a href="{{ url_for('inventory.download_template', template_type='tech_assets') }}"
                       class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download Tech Assets Template
                    </a>
                </div>
                <div id="accessories_template" class="hidden">
                    <a href="{{ url_for('inventory.download_template', template_type='accessories') }}"
                       class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download Accessories Template
                    </a>
                </div>
            </div>

            <!-- File Upload Section -->
            <div class="mt-4">
                <label for="file" class="block text-sm font-medium text-gray-700 mb-2">Choose CSV File</label>
                <input type="file" name="file" id="file" accept=".csv" required
                       class="block w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-full file:border-0
                              file:text-sm file:font-semibold
                              file:bg-blue-50 file:text-blue-700
                              hover:file:bg-blue-100">
                <p class="mt-2 text-sm text-gray-500">Upload a CSV file with the required columns.</p>
            </div>

            <!-- CSV Format Guide -->
            <div class="mt-4 border-t pt-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Required CSV Columns:</h3>
                <div id="tech_assets_format" class="bg-gray-50 rounded-md p-4 text-sm text-gray-600">
                    <p class="font-medium mb-2">For Tech Assets:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>ASSET TYPE (required)</li>
                        <li>ASSET TAG (required)</li>
                        <li>SERIAL NUMBER</li>
                        <li>MODEL</li>
                        <li>HARDWARE TYPE</li>
                        <li>CPU TYPE</li>
                        <li>CPU CORES</li>
                        <li>GPU CORES</li>
                        <li>MEMORY</li>
                        <li>HARD DRIVE</li>
                        <li>STATUS</li>
                        <li>CUSTOMER</li>
                        <li>COUNTRY</li>
                        <li>PO</li>
                        <li>RECEIVING DATE</li>
                        <li>NOTES</li>
                        <li>TECH NOTES</li>
                        <li>CONDITION</li>
                        <li>DIAGNOSTIC</li>
                        <li>ERASED</li>
                        <li>KEYBOARD</li>
                        <li>CHARGER</li>
                        <li>INCLUDED</li>
                    </ul>
                </div>
                <div id="accessories_format" class="hidden bg-gray-50 rounded-md p-4 text-sm text-gray-600">
                    <p class="font-medium mb-2">For Accessories:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>NAME (required)</li>
                        <li>CATEGORY (required)</li>
                        <li>MANUFACTURER</li>
                        <li>MODEL NUMBER</li>
                        <li>TOTAL QUANTITY</li>
                        <li>COUNTRY</li>
                        <li>STATUS</li>
                        <li>NOTES</li>
                    </ul>
                </div>
            </div>

            <div class="flex justify-end space-x-4">
                <a href="{{ url_for('inventory.view_inventory') }}"
                   class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                </a>
                <button type="submit"
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Upload and Preview
                </button>
            </div>
        </form>
    {% endif %}
</div>

<!-- JavaScript for toggling template visibility -->
<script>
    // Only add import_type listener if the element exists
    const importTypeSelect = document.getElementById('import_type');
    if (importTypeSelect) {
        importTypeSelect.addEventListener('change', function() {
            const techAssetsTemplate = document.getElementById('tech_assets_template');
            const accessoriesTemplate = document.getElementById('accessories_template');
            const techFormat = document.getElementById('tech_assets_format');
            const accessoryFormat = document.getElementById('accessories_format');
            
            if (this.value === 'tech_assets') {
                techAssetsTemplate.classList.remove('hidden');
                accessoriesTemplate.classList.add('hidden');
                techFormat.classList.remove('hidden');
                accessoryFormat.classList.add('hidden');
            } else {
                techAssetsTemplate.classList.add('hidden');
                accessoriesTemplate.classList.remove('hidden');
                techFormat.classList.add('hidden');
                accessoryFormat.classList.remove('hidden');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('importForm');
        const submitButton = document.getElementById('submitButton');
        
        if (!form || !submitButton) return;

        // Function to update Asset Tag value
        function updateAssetTag(rowIndex, value) {
            const assetTagInput = document.getElementById(`direct_asset_tag_${rowIndex}`);
            if (assetTagInput) {
                assetTagInput.value = value;
                return true;
            }
            return false;
        }
        
        // Function to update preview data for both tech assets and accessories
        function updatePreviewData(rowIndex, field, value) {
            const previewDataInput = document.getElementById(`preview_data_${rowIndex}`);
            if (previewDataInput) {
                try {
                    const rowData = JSON.parse(previewDataInput.value);
                    rowData[field] = value;
                    previewDataInput.value = JSON.stringify(rowData);
                    return true;
                } catch (e) {
                    console.error('Error updating preview data:', e);
                    return false;
                }
            }
            return false;
        }

        // Function to check if all required fields are filled
        function checkAllFieldsConfirmed() {
            const importType = form.getAttribute('data-import-type') || '{{ import_type }}';
            let allValid = true;

            if (importType === 'tech_assets') {
                // Check Asset Type and Asset Tag fields
                document.querySelectorAll('[id^="preview_data_"]').forEach(input => {
                    try {
                        const rowData = JSON.parse(input.value);
                        if (!rowData['Asset Type'] || !rowData['Asset Tag']) {
                            allValid = false;
                        }
                    } catch (e) {
                        console.error('Error parsing preview data:', e);
                        allValid = false;
                    }
                });
            } else {
                // Check Name and Category fields for accessories
                document.querySelectorAll('[id^="preview_data_"]').forEach(input => {
                    try {
                        const rowData = JSON.parse(input.value);
                        if (!rowData['Name'] || !rowData['Category']) {
                            allValid = false;
                        }
                    } catch (e) {
                        console.error('Error parsing preview data:', e);
                        allValid = false;
                    }
                });
            }

            // Enable/disable submit button based on validation
            if (allValid) {
                submitButton.disabled = false;
                submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                submitButton.disabled = true;
                submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            }
        }

        // Add event listeners to confirm buttons
        document.querySelectorAll('.confirm-button').forEach(button => {
            button.addEventListener('click', function() {
                const rowIndex = this.getAttribute('data-row');
                const field = this.getAttribute('data-field');
                
                let input;
                if (field === 'Asset Tag') {
                    input = document.querySelector(`input[name="asset_tag_input_${rowIndex}"]`);
                } else if (field === 'Name') {
                    input = document.querySelector(`input[name="name_input_${rowIndex}"]`);
                } else if (field === 'Category') {
                    input = document.querySelector(`input[name="category_input_${rowIndex}"]`);
                }
                
                if (!input || !input.value.trim()) {
                    alert('Please enter a value before confirming.');
                    return;
                }

                const value = input.value.trim();
                
                // Update both preview data and specific field
                if (updatePreviewData(rowIndex, field, value)) {
                    if (field === 'Asset Tag') {
                        updateAssetTag(rowIndex, value);
                    }
                    
                    // Update UI to show confirmation
                    input.readOnly = true;
                    input.style.backgroundColor = '#f0fdf4';
                    this.textContent = 'Confirmed âœ“';
                    this.disabled = true;
                    this.classList.remove('bg-blue-100', 'text-blue-700', 'hover:bg-blue-200');
                    this.classList.add('bg-green-100', 'text-green-700', 'confirmed');
                    
                    // Check if all fields are now valid
                    checkAllFieldsConfirmed();
                } else {
                    alert('Error updating field. Please try again.');
                }
            });
        });

        // Add input event listeners to required fields
        document.querySelectorAll('.required-field').forEach(input => {
            input.addEventListener('input', () => {
                const confirmButton = input.parentElement.querySelector('.confirm-button');
                if (confirmButton && !confirmButton.disabled) {
                    confirmButton.classList.toggle('bg-blue-200', input.value.trim() !== '');
                }
            });
        });

        // Initial check for all fields
        checkAllFieldsConfirmed();

        // Form submission handler
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            checkAllFieldsConfirmed();
            
            if (!submitButton.disabled) {
                form.submit();
            } else {
                alert('Some required fields are missing. Please confirm all required fields.');
            }
        });
    });
</script>
{% endblock %} 