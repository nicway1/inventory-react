{% extends "base.html" %}

{% block content %}
<!-- Add CSRF token -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container mx-auto px-4 py-8">
    <div class="mb-6 flex justify-between items-center">
        <a href="{{ url_for('inventory.view_inventory') }}" 
           class="text-blue-600 hover:text-blue-800">
            &larr; Back to Inventory
        </a>
        <div class="flex space-x-4">
            {% if current_user.is_authenticated and current_user.permissions.can_export_data %}
            <form id="exportForm" action="{{ url_for('inventory.export_inventory', item_type='accessories') }}" method="POST" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="selected_ids" id="selectedIds" value="">
                <button type="submit" 
                        id="exportButton"
                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Export Selected
                </button>
            </form>
            {% endif %}
            
            <!-- Bulk action buttons -->
            {% if is_admin %}
            <form id="bulkDeleteForm" action="{{ url_for('inventory.bulk_delete') }}" method="POST" class="inline" onsubmit="return confirmDelete()">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="selected_asset_ids" value="[]">
                <input type="hidden" name="selected_accessory_ids" id="selectedAccessoryIdsDelete" value="[]">
                <button type="submit" id="bulkDeleteBtn" disabled
                        class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Delete Selected
                </button>
            </form>
            {% endif %}
            
            <button id="addToCheckoutList" disabled
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Add to Checkout List
            </button>
            <button id="viewCheckoutList"
                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center">
                View Checkout List
                <span id="checkoutCount" class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    0
                </span>
            </button>
            
            {% if is_admin %}
            <a href="{{ url_for('inventory.add_accessory') }}" 
               class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Add New Accessory
            </a>
            {% endif %}
        </div>
    </div>

    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">Accessories</h2>
            <p class="mt-1 text-sm text-gray-600">Keyboards, Mice, Cables, etc.</p>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-center">
                            <input type="checkbox" id="selectAllAccessories"
                                   class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Name</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Category</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Manufacturer</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Model No</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Total Quantity</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Available</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Country</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for accessory in accessories %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4 text-center">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" 
                                       class="accessory-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                       data-id="{{ accessory.id }}"
                                       data-available="{{ accessory.available_quantity }}">
                                <input type="number" 
                                       class="accessory-quantity w-16 rounded border-gray-300 shadow-sm hidden"
                                       min="1"
                                       max="{{ accessory.available_quantity }}"
                                       value="1">
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-normal">
                            <div class="text-sm font-medium text-gray-900">
                                <a href="{{ url_for('inventory.view_accessory', id=accessory.id) }}" 
                                   class="hover:text-blue-600">
                                    {{ accessory.name }}
                                </a>
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-normal text-sm text-gray-500">
                            {{ accessory.category }}
                        </td>
                        <td class="px-4 py-4 whitespace-normal text-sm text-gray-500">
                            {{ accessory.manufacturer }}
                        </td>
                        <td class="px-4 py-4 whitespace-normal text-sm text-gray-500">
                            {{ accessory.model_no }}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ accessory.total_quantity }}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ accessory.available_quantity }}
                        </td>
                        <td class="px-4 py-4 whitespace-normal text-sm text-gray-500">
                            {{ accessory.country }}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-right">
                            <div class="flex justify-end space-x-3">
                                {% if accessory.available_quantity > 0 %}
                                <form action="{{ url_for('inventory.checkout_accessory', id=accessory.id) }}" 
                                      method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="text-blue-600 hover:text-blue-900">Checkout</button>
                                </form>
                                {% endif %}
                                {% if is_admin or is_country_admin %}
                                <a href="{{ url_for('inventory.add_accessory_stock', id=accessory.id) }}" 
                                   class="text-green-600 hover:text-green-900">Add Stock</a>
                                {% endif %}
                                {% if is_admin %}
                                <a href="{{ url_for('inventory.edit_accessory', id=accessory.id) }}" 
                                   class="text-indigo-600 hover:text-indigo-900">Edit</a>
                                <form action="{{ url_for('inventory.delete_accessory', id=accessory.id) }}" 
                                      method="POST"
                                      class="inline"
                                      onsubmit="return confirm('Are you sure you want to delete this accessory?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="text-red-600 hover:text-red-900">Delete</button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Include the checkout modal -->
{% include 'inventory/includes/checkout_modal.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Get DOM elements
    const selectAllAccessories = document.getElementById('selectAllAccessories');
    const accessoryCheckboxes = document.querySelectorAll('.accessory-checkbox');
    const accessoryQuantities = document.querySelectorAll('.accessory-quantity');
    const addToCheckoutList = document.getElementById('addToCheckoutList');
    const viewCheckoutList = document.getElementById('viewCheckoutList');
    const checkoutListModal = document.getElementById('checkoutListModal');
    const closeCheckoutModal = document.getElementById('closeCheckoutModal');
    const checkoutListContent = document.getElementById('checkoutListContent');
    const clearCheckoutList = document.getElementById('clearCheckoutList');
    const processCheckout = document.getElementById('processCheckout');
    const customerSelect = document.getElementById('customerSelect');
    const checkoutCount = document.getElementById('checkoutCount');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const selectedAccessoryIdsDelete = document.getElementById('selectedAccessoryIdsDelete');

    // Initialize checkout list count
    if (checkoutCount) {
        checkoutCount.textContent = window.checkoutManager ? window.checkoutManager.checkoutList.length : 0;
    }

    // Function to show error/success messages
    function showError(message, isSuccess = false) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `fixed top-4 right-4 p-4 rounded-md ${isSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
        alertDiv.textContent = message;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 3000);
    }

    // Function to handle accessory selection
    function handleAccessorySelection(checkbox) {
        const quantityInput = checkbox.parentElement.querySelector('.accessory-quantity');
        if (checkbox.checked) {
            quantityInput.classList.remove('hidden');
        } else {
            quantityInput.classList.add('hidden');
        }
        updateSelection();
    }

    // Function to update selection state
    function updateSelection() {
        const selectedCount = [...accessoryCheckboxes].filter(cb => cb.checked).length;
        if (addToCheckoutList) addToCheckoutList.disabled = selectedCount === 0;
        if (bulkDeleteBtn) bulkDeleteBtn.disabled = selectedCount === 0;
        if (selectedAccessoryIdsDelete) {
            selectedAccessoryIdsDelete.value = JSON.stringify(
                [...accessoryCheckboxes]
                    .filter(cb => cb.checked)
                    .map(cb => parseInt(cb.dataset.id))
            );
        }
    }

    // Event listener for "Select All" checkbox
    if (selectAllAccessories) {
        selectAllAccessories.addEventListener('change', function() {
            accessoryCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                handleAccessorySelection(checkbox);
            });
        });
    }

    // Event listeners for individual checkboxes
    accessoryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            handleAccessorySelection(this);
            if (selectAllAccessories) {
                selectAllAccessories.checked = [...accessoryCheckboxes].every(cb => cb.checked);
            }
        });
    });

    // Event listeners for quantity inputs
    accessoryQuantities.forEach(input => {
        input.addEventListener('change', function() {
            const checkbox = this.parentElement.querySelector('.accessory-checkbox');
            if (checkbox.checked) {
                const accessoryId = parseInt(checkbox.dataset.id);
                const maxAvailable = parseInt(checkbox.dataset.available);
                const quantity = Math.min(Math.max(1, parseInt(this.value) || 1), maxAvailable);
                this.value = quantity;
            }
        });
    });

    // Event listener for "Add to Checkout List" button
    if (addToCheckoutList) {
        addToCheckoutList.addEventListener('click', async () => {
            try {
                const selectedIds = [...accessoryCheckboxes]
                    .filter(cb => cb.checked)
                    .map(cb => parseInt(cb.dataset.id));

                const response = await fetch('/inventory/get-checkout-items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        asset_ids: [],
                        accessory_ids: selectedIds
                    })
                });
                
                if (!response.ok) throw new Error('Failed to fetch item details');
                
                const data = await response.json();
                
                // Add accessories to checkout list with quantities
                const newAccessories = (data.accessories || []).map(acc => {
                    const quantityInput = document.querySelector(`.accessory-quantity[data-id="${acc.id}"]`);
                    return {
                        ...acc,
                        type: 'accessory',
                        quantity: quantityInput ? parseInt(quantityInput.value) || 1 : 1
                    };
                });
                
                // Add items to the shared checkout manager
                newAccessories.forEach(item => window.checkoutManager.addItem(item));
                
                // Clear selections
                accessoryCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.parentElement.querySelector('.accessory-quantity').classList.add('hidden');
                });
                if (selectAllAccessories) selectAllAccessories.checked = false;
                updateSelection();
                
                showError('Items added to checkout list', true);
            } catch (error) {
                console.error('Error adding to checkout list:', error);
                showError(error.message);
            }
        });
    }

    // Event listeners for checkout list modal
    if (viewCheckoutList) {
        viewCheckoutList.addEventListener('click', () => {
            if (window.checkoutManager) {
                const modal = document.getElementById('checkoutListModal');
                if (modal) modal.classList.remove('hidden');
                window.checkoutManager.updateUI();
            }
        });
    }

    if (closeCheckoutModal) {
        closeCheckoutModal.addEventListener('click', () => {
            checkoutListModal.classList.add('hidden');
        });
    }

    if (clearCheckoutList) {
        clearCheckoutList.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the checkout list?')) {
                accessoryCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.parentElement.querySelector('.accessory-quantity').classList.add('hidden');
                });
                if (selectAllAccessories) selectAllAccessories.checked = false;
                updateSelection();
            }
        });
    }

    if (customerSelect) {
        customerSelect.addEventListener('change', updateCheckoutList);
    }

    // Function to update checkout list UI
    function updateCheckoutList() {
        if (window.checkoutManager) {
            if (checkoutCount) {
                checkoutCount.textContent = window.checkoutManager.checkoutList.length;
            }
            if (processCheckout) {
                processCheckout.disabled = window.checkoutManager.checkoutList.length === 0 || !customerSelect.value;
            }
        }
    }

    // Function to remove item from checkout list
    window.removeFromCheckoutList = function(itemId, itemType) {
        window.checkoutManager.removeItem(itemId, itemType);
    };

    // Event listener for Process Checkout button
    if (processCheckout) {
        processCheckout.addEventListener('click', async () => {
            const customerId = customerSelect.value;
            if (!customerId) {
                showError('Please select a customer');
                return;
            }

            if (!window.checkoutManager || window.checkoutManager.checkoutList.length === 0) {
                showError('No items in checkout list');
                return;
            }

            try {
                const accessoryItems = window.checkoutManager.checkoutList
                    .filter(item => item.type === 'accessory')
                    .map(item => ({
                        id: item.id,
                        quantity: item.quantity || 1
                    }));

                const response = await fetch('/inventory/bulk-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        customer_id: customerId,
                        selected_accessory_ids: accessoryItems
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to process checkout');
                }

                const result = await response.json();
                
                if (result.warnings && result.warnings.length > 0) {
                    showError(result.warnings.join('\n'), false);
                }
                
                // Clear the checkout list
                accessoryCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.parentElement.querySelector('.accessory-quantity').classList.add('hidden');
                });
                if (selectAllAccessories) selectAllAccessories.checked = false;
                updateSelection();
                
                // Close the modal
                checkoutListModal.classList.add('hidden');
                
                // Show success message
                showError(result.message || 'Checkout processed successfully', true);
                
                // Reload the page to refresh the inventory
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                console.error('Error processing checkout:', error);
                showError(error.message);
            }
        });
    }

    // Function to confirm deletion
    window.confirmDelete = function() {
        const selectedCount = [...accessoryCheckboxes].filter(cb => cb.checked).length;
        return confirm(`Are you sure you want to delete ${selectedCount} selected item(s)? This action cannot be undone.`);
    };
});
</script>
{% endblock %} 