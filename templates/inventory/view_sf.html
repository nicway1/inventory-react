{% extends "base.html" %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Salesforce-style colors */
    :root {
        --sf-blue: #0176d3;
        --sf-blue-dark: #014486;
        --sf-blue-light: #1b96ff;
        --sf-gray-100: #f3f3f3;
        --sf-gray-200: #e5e5e5;
        --sf-gray-300: #c9c9c9;
        --sf-gray-600: #706e6b;
        --sf-gray-800: #3e3e3c;
        --sf-success: #2e844a;
        --sf-warning: #fe9339;
        --sf-error: #ea001e;
        --sf-purple: #9050e9;
    }

    /* Main layout */
    .sf-page {
        background: var(--sf-gray-100);
        min-height: 100vh;
    }

    /* Header bar */
    .sf-header {
        background: white;
        border-bottom: 1px solid var(--sf-gray-200);
        padding: 0.75rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .sf-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .sf-breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--sf-gray-600);
    }

    .sf-breadcrumb a {
        color: var(--sf-blue);
        text-decoration: none;
    }

    .sf-breadcrumb a:hover {
        text-decoration: underline;
    }

    .sf-page-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--sf-gray-800);
    }

    .sf-header-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sf-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
        font-weight: 600;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.15s ease;
        border: 1px solid transparent;
    }

    .sf-btn-neutral {
        background: white;
        border-color: var(--sf-gray-300);
        color: var(--sf-gray-800);
    }

    .sf-btn-neutral:hover {
        background: var(--sf-gray-100);
    }

    .sf-btn-brand {
        background: var(--sf-blue);
        color: white;
    }

    .sf-btn-brand:hover {
        background: var(--sf-blue-dark);
    }

    .sf-btn-success {
        background: var(--sf-success);
        color: white;
    }

    .sf-btn-success:hover {
        background: #236839;
    }

    /* Main content area */
    .sf-content {
        display: flex;
        height: calc(100vh - 60px);
    }

    /* Filters sidebar */
    .sf-sidebar {
        width: 280px;
        background: white;
        border-right: 1px solid var(--sf-gray-200);
        overflow-y: auto;
        flex-shrink: 0;
        transition: width 0.2s ease;
    }

    .sf-sidebar.collapsed {
        width: 0;
        overflow: hidden;
    }

    .sf-sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--sf-gray-100);
    }

    .sf-sidebar-title {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--sf-gray-600);
    }

    .sf-filter-section {
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-filter-header {
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
    }

    .sf-filter-header:hover {
        background: var(--sf-gray-100);
    }

    .sf-filter-label {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--sf-gray-800);
    }

    .sf-filter-count {
        font-size: 0.75rem;
        color: var(--sf-gray-600);
        background: var(--sf-gray-200);
        padding: 0.125rem 0.5rem;
        border-radius: 1rem;
    }

    .sf-filter-content {
        padding: 0 1rem 1rem;
        max-height: 200px;
        overflow-y: auto;
    }

    .sf-filter-content.collapsed {
        display: none;
    }

    .sf-checkbox-item {
        display: flex;
        align-items: center;
        padding: 0.375rem 0;
        font-size: 0.8125rem;
        color: var(--sf-gray-800);
    }

    .sf-checkbox-item input {
        margin-right: 0.5rem;
        accent-color: var(--sf-blue);
    }

    .sf-checkbox-item .count {
        margin-left: auto;
        font-size: 0.75rem;
        color: var(--sf-gray-600);
    }

    /* Search input */
    .sf-search-section {
        padding: 1rem;
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-search-input {
        width: 100%;
        padding: 0.5rem;
        font-size: 0.8125rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
    }

    .sf-search-input:focus {
        outline: none;
        border-color: var(--sf-blue);
        box-shadow: 0 0 0 2px rgba(1, 118, 211, 0.2);
    }

    /* Main area */
    .sf-main {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background: var(--sf-gray-100);
    }

    /* Summary cards */
    .sf-summary-cards {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .sf-summary-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.25rem;
        border: 1px solid var(--sf-gray-200);
    }

    .sf-summary-card.highlight {
        border-left: 4px solid var(--sf-blue);
    }

    .sf-summary-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--sf-gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .sf-summary-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--sf-gray-800);
    }

    .sf-summary-value.blue { color: var(--sf-blue); }
    .sf-summary-value.green { color: var(--sf-success); }
    .sf-summary-value.orange { color: var(--sf-warning); }
    .sf-summary-value.red { color: var(--sf-error); }
    .sf-summary-value.purple { color: var(--sf-purple); }

    .sf-summary-subtitle {
        font-size: 0.75rem;
        color: var(--sf-gray-600);
        margin-top: 0.25rem;
    }

    /* Chart container */
    .sf-chart-container {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid var(--sf-gray-200);
        margin-bottom: 0;
    }

    .sf-chart-remove-btn:hover {
        color: var(--sf-error);
        background: #fee2e2;
    }

    .sf-charts-section {
        margin-bottom: 1.5rem;
    }

    .sf-chart-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .sf-chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--sf-gray-800);
    }

    .sf-chart-body {
        padding: 1.5rem;
        height: 300px;
        position: relative;
    }

    /* Data table */
    .sf-table-container {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid var(--sf-gray-200);
        overflow: hidden;
    }

    .sf-table-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .sf-table-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--sf-gray-800);
    }

    .sf-table {
        width: 100%;
        border-collapse: collapse;
    }

    .sf-table th {
        background: var(--sf-gray-100);
        padding: 0.75rem 1rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--sf-gray-600);
        border-bottom: 1px solid var(--sf-gray-200);
        cursor: pointer;
    }

    .sf-table th:hover {
        background: var(--sf-gray-200);
    }

    .sf-table th.sortable::after {
        content: ' \2195';
        opacity: 0.4;
    }

    .sf-table th.sorted-asc::after {
        content: ' \2191';
        opacity: 1;
    }

    .sf-table th.sorted-desc::after {
        content: ' \2193';
        opacity: 1;
    }

    .sf-table td {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: var(--sf-gray-800);
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-table tr:hover {
        background: var(--sf-gray-100);
    }

    .sf-table-link {
        color: var(--sf-blue);
        text-decoration: none;
    }

    .sf-table-link:hover {
        text-decoration: underline;
    }

    /* Status badges */
    .sf-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 0.25rem;
    }

    .sf-badge-deployed { background: #d4edda; color: #155724; }
    .sf-badge-instock { background: #e8f4ff; color: #0176d3; }
    .sf-badge-readytodeploy { background: #cce5ff; color: #004085; }
    .sf-badge-shipped { background: #fff3cd; color: #856404; }
    .sf-badge-repair { background: #f8d7da; color: #721c24; }
    .sf-badge-archived { background: #e2e3e5; color: #383d41; }
    .sf-badge-disposed { background: #d6d8db; color: #1b1e21; }

    /* Loading spinner */
    .sf-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--sf-gray-600);
    }

    .sf-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--sf-gray-200);
        border-top-color: var(--sf-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Toggle sidebar button */
    .sf-toggle-sidebar {
        position: fixed;
        left: 290px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 48px;
        background: white;
        border: 1px solid var(--sf-gray-200);
        border-left: none;
        border-radius: 0 4px 4px 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        transition: left 0.2s ease;
    }

    .sf-toggle-sidebar.collapsed {
        left: 0;
    }

    .sf-toggle-sidebar:hover {
        background: var(--sf-gray-100);
    }

    /* Preview header */
    .sf-preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .sf-preview-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--sf-gray-800);
    }

    .sf-preview-subtitle {
        font-size: 0.75rem;
        color: var(--sf-gray-600);
    }

    /* No data state */
    .sf-no-data {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--sf-gray-600);
    }

    .sf-no-data-icon {
        width: 48px;
        height: 48px;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Pagination */
    .sf-pagination {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--sf-gray-200);
        background: var(--sf-gray-100);
    }

    .sf-pagination-info {
        font-size: 0.8125rem;
        color: var(--sf-gray-600);
    }

    .sf-pagination-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sf-pagination-btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
        background: white;
        cursor: pointer;
    }

    .sf-pagination-btn:hover:not(:disabled) {
        background: var(--sf-gray-100);
    }

    .sf-pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .sf-summary-cards {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 768px) {
        .sf-sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            height: calc(100vh - 60px);
            z-index: 200;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }

        .sf-summary-cards {
            grid-template-columns: 1fr 1fr;
        }
    }

    /* Bulk Actions Bar */
    .sf-bulk-actions {
        background: linear-gradient(135deg, #0176d3 0%, #014486 100%);
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        color: white;
        box-shadow: 0 2px 8px rgba(1, 118, 211, 0.3);
    }

    .sf-bulk-actions .sf-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
    }

    .sf-bulk-actions .sf-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    .sf-bulk-actions .sf-btn-brand {
        background: white;
        color: var(--sf-blue);
    }

    .sf-bulk-actions .sf-btn-brand:hover {
        background: var(--sf-gray-100);
    }

    /* Maintenance Assets Section */
    .sf-maintenance-section {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid var(--sf-gray-200);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .sf-maintenance-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: background 0.15s ease;
    }

    .sf-maintenance-header:hover {
        background: var(--sf-gray-100);
    }

    .sf-maintenance-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--sf-gray-800);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sf-maintenance-title i {
        color: #f97316;
    }

    .sf-maintenance-count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 1.5rem;
        height: 1.5rem;
        padding: 0 0.5rem;
        background: #f97316;
        color: white;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    .sf-maintenance-toggle {
        transition: transform 0.2s ease;
    }

    .sf-maintenance-toggle.collapsed {
        transform: rotate(-90deg);
    }

    .sf-maintenance-content {
        transition: max-height 0.3s ease;
        overflow: hidden;
    }

    .sf-maintenance-content.collapsed {
        max-height: 0;
    }

    .sf-maintenance-actions {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .sf-maintenance-search {
        flex: 1;
        min-width: 250px;
        max-width: 400px;
    }

    .sf-maintenance-search input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
    }

    .sf-maintenance-search input:focus {
        outline: none;
        border-color: var(--sf-blue);
        box-shadow: 0 0 0 2px rgba(1, 118, 211, 0.2);
    }

    .sf-maintenance-bulk-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sf-maintenance-table-wrapper {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
    }

    .sf-maintenance-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
    }

    .sf-maintenance-table thead {
        background: var(--sf-gray-50);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .sf-maintenance-table th {
        padding: 0.75rem 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--sf-gray-600);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--sf-gray-200);
    }

    .sf-maintenance-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--sf-gray-200);
        color: var(--sf-gray-800);
    }

    .sf-maintenance-table tbody tr:hover {
        background: var(--sf-gray-50);
    }

    .sf-maintenance-empty {
        padding: 3rem 1.25rem;
        text-align: center;
        color: var(--sf-gray-500);
    }

    .sf-maintenance-empty i {
        font-size: 3rem;
        color: var(--sf-gray-300);
        margin-bottom: 1rem;
    }

    .sf-maintenance-loading {
        padding: 3rem 1.25rem;
        text-align: center;
    }

    .sf-maintenance-status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .sf-maintenance-status-badge.pending {
        background: #fef3c7;
        color: #92400e;
    }

    .sf-maintenance-status-badge.completed {
        background: #d1fae5;
        color: #065f46;
    }

    .sf-maintenance-status-badge.ewaste {
        background: #fee2e2;
        color: #991b1b;
    }

    /* Bulk Edit Modal */
    .sf-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .sf-modal {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 24px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .sf-modal-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--sf-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .sf-modal-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--sf-gray-800);
    }

    .sf-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--sf-gray-600);
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .sf-modal-close:hover {
        color: var(--sf-gray-800);
    }

    .sf-modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }

    .sf-modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--sf-gray-200);
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .sf-form-group {
        margin-bottom: 1rem;
    }

    .sf-form-label {
        display: block;
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--sf-gray-800);
        margin-bottom: 0.375rem;
    }

    .sf-form-input, .sf-form-select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
        font-size: 0.875rem;
        transition: border-color 0.15s, box-shadow 0.15s;
    }

    .sf-form-input:focus, .sf-form-select:focus {
        outline: none;
        border-color: var(--sf-blue);
        box-shadow: 0 0 0 3px rgba(1, 118, 211, 0.15);
    }

    .sf-form-help {
        font-size: 0.75rem;
        color: var(--sf-gray-600);
        margin-top: 0.25rem;
    }

    .sf-checkbox-field {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .sf-checkbox-field input[type="checkbox"] {
        accent-color: var(--sf-blue);
    }

    /* Row checkbox styling */
    .sf-table tbody td:first-child input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--sf-blue);
        cursor: pointer;
    }

    .sf-table thead th:first-child input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--sf-blue);
        cursor: pointer;
    }

    .sf-table tr.selected {
        background-color: rgba(1, 118, 211, 0.08) !important;
    }

    /* Bulk Edit Table Styles */
    #bulkEditTable input,
    #bulkEditTable select {
        width: 100%;
        padding: 0.375rem 0.5rem;
        border: 1px solid var(--sf-gray-300);
        border-radius: 0.25rem;
        font-size: 0.8125rem;
        background: white;
    }

    #bulkEditTable input:focus,
    #bulkEditTable select:focus {
        outline: none;
        border-color: var(--sf-blue);
        box-shadow: 0 0 0 2px rgba(1, 118, 211, 0.15);
    }

    #bulkEditTable input.changed,
    #bulkEditTable select.changed {
        background-color: #fffde7;
        border-color: #ffc107;
    }

    #bulkEditTable td {
        padding: 0.5rem;
        vertical-align: middle;
    }

    #bulkEditTable tr:hover {
        background-color: var(--sf-gray-100);
    }
</style>
{% endblock %}

{% block content %}
<div class="sf-page">
    <!-- Header -->
    <div class="sf-header">
        <div class="sf-header-left">
            <div class="sf-breadcrumb">
                <a href="{{ url_for('main.index') }}">Home</a>
                <span>/</span>
                <span class="sf-page-title">IT Asset Inventory</span>
            </div>
        </div>
        <div class="sf-header-actions">
            <a href="{{ url_for('inventory.view_inventory') }}" class="sf-btn sf-btn-neutral">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Classic View
            </a>
            <button class="sf-btn sf-btn-neutral" onclick="resetFilters()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
                Reset
            </button>
            <button class="sf-btn sf-btn-success" id="exportBtn" onclick="exportAssets()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                <span id="exportBtnText">Export</span>
            </button>
            <a href="{{ url_for('inventory.add_asset') }}" class="sf-btn sf-btn-brand">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                New Asset
            </a>
            <a href="{{ url_for('inventory.add_accessory') }}" class="sf-btn sf-btn-brand" style="background: var(--sf-purple);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                New Accessory
            </a>
        </div>
    </div>

    <!-- Main content -->
    <div class="sf-content">
        <!-- Filters sidebar -->
        <div class="sf-sidebar" id="filterSidebar">
            <div class="sf-sidebar-header">
                <span class="sf-sidebar-title">Filters</span>
            </div>

            <!-- Search -->
            <div class="sf-search-section">
                <input type="text" id="searchInput" class="sf-search-input" placeholder="Search assets..." onkeyup="debounceSearch()">
            </div>

            <!-- Status Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('status')">
                    <span class="sf-filter-label">Status</span>
                    <span class="sf-filter-count" id="statusCount">0</span>
                </div>
                <div class="sf-filter-content" id="statusFilter"></div>
            </div>

            <!-- Category Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('category')">
                    <span class="sf-filter-label">Category</span>
                    <span class="sf-filter-count" id="categoryCount">0</span>
                </div>
                <div class="sf-filter-content" id="categoryFilter"></div>
            </div>

            <!-- Company Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('company')">
                    <span class="sf-filter-label">Company</span>
                    <span class="sf-filter-count" id="companyCount">0</span>
                </div>
                <div class="sf-filter-content" id="companyFilter"></div>
            </div>

            <!-- Country Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('country')">
                    <span class="sf-filter-label">Country</span>
                    <span class="sf-filter-count" id="countryCount">0</span>
                </div>
                <div class="sf-filter-content" id="countryFilter"></div>
            </div>

            <!-- Location Filter -->
            <div class="sf-filter-section">
                <div class="sf-filter-header" onclick="toggleFilter('location')">
                    <span class="sf-filter-label">Location</span>
                    <span class="sf-filter-count" id="locationCount">0</span>
                </div>
                <div class="sf-filter-content" id="locationFilter"></div>
            </div>
        </div>

        <!-- Toggle sidebar button -->
        <button class="sf-toggle-sidebar" id="toggleSidebar" onclick="toggleSidebar()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="toggleIcon">
                <polyline points="15,18 9,12 15,6"/>
            </svg>
        </button>

        <!-- Main area -->
        <div class="sf-main">
            <!-- Tab Bar -->
            <div class="sf-tab-bar" style="display: flex; gap: 0; margin-bottom: 1.5rem; border-bottom: 2px solid var(--sf-gray-200);">
                <button class="sf-tab active" id="tabTechAssets" onclick="switchTab('tech')" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; color: var(--sf-blue); background: none; border: none; border-bottom: 2px solid var(--sf-blue); margin-bottom: -2px; cursor: pointer;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem; vertical-align: middle;">
                        <rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/>
                    </svg>
                    Tech Assets
                </button>
                <button class="sf-tab" id="tabAccessories" onclick="switchTab('accessories')" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; color: var(--sf-gray-600); background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; cursor: pointer;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem; vertical-align: middle;">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                    Accessories
                </button>
                <button class="sf-tab" id="tabMaintenance" onclick="switchTab('maintenance')" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; color: var(--sf-gray-600); background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; cursor: pointer;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem; vertical-align: middle;">
                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                    </svg>
                    Maintenance
                </button>
            </div>

            <!-- Preview header -->
            <div class="sf-preview-header">
                <div>
                    <div class="sf-preview-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/>
                        </svg>
                        <span id="viewTitle">Tech Assets Overview</span>
                        <span id="loadingStatus" style="font-size: 0.75rem; color: #fe9339; margin-left: 0.5rem;">(Loading...)</span>
                    </div>
                    <div class="sf-preview-subtitle" id="assetCountText">Loading assets...</div>
                    <div id="errorMessage" style="color: #ea001e; font-size: 0.75rem; display: none;"></div>
                </div>
                <div>
                    <button class="sf-btn sf-btn-neutral" onclick="applyFilters()" title="Refresh data">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Summary cards for Tech Assets -->
            <div class="sf-summary-cards" id="techSummaryCards">
                <div class="sf-summary-card highlight">
                    <div class="sf-summary-label">Total Assets</div>
                    <div class="sf-summary-value blue" id="totalAssets">0</div>
                </div>
                <div class="sf-summary-card">
                    <div class="sf-summary-label">Deployed</div>
                    <div class="sf-summary-value green" id="deployedAssets">0</div>
                    <div class="sf-summary-subtitle">In use by customers</div>
                </div>
                <div class="sf-summary-card">
                    <div class="sf-summary-label">In Stock</div>
                    <div class="sf-summary-value blue" id="instockAssets">0</div>
                    <div class="sf-summary-subtitle">Available in warehouse</div>
                </div>
                <div class="sf-summary-card">
                    <div class="sf-summary-label">Ready to Deploy</div>
                    <div class="sf-summary-value orange" id="readyToDeployAssets">0</div>
                    <div class="sf-summary-subtitle">Prepared for shipping</div>
                </div>
                <div class="sf-summary-card">
                    <div class="sf-summary-label">Disposed</div>
                    <div class="sf-summary-value red" id="disposedAssets">0</div>
                    <div class="sf-summary-subtitle">End of life</div>
                </div>
            </div>

            <!-- Summary cards for Accessories -->
            <div class="sf-summary-cards" id="accessorySummaryCards" style="display: none;">
                <div class="sf-summary-card highlight">
                    <div class="sf-summary-label">Total Items</div>
                    <div class="sf-summary-value blue" id="totalAccessories">0</div>
                </div>
                <div class="sf-summary-card">
                    <div class="sf-summary-label">Total Quantity</div>
                    <div class="sf-summary-value green" id="totalAccessoryQty">0</div>
                    <div class="sf-summary-subtitle">All accessories</div>
                </div>
                <div class="sf-summary-card">
                    <div class="sf-summary-label">Available</div>
                    <div class="sf-summary-value blue" id="availableAccessoryQty">0</div>
                    <div class="sf-summary-subtitle">Ready for use</div>
                </div>
                <div class="sf-summary-card">
                    <div class="sf-summary-label">In Use</div>
                    <div class="sf-summary-value orange" id="inUseAccessoryQty">0</div>
                    <div class="sf-summary-subtitle">Checked out</div>
                </div>
                <div class="sf-summary-card">
                    <div class="sf-summary-label">Categories</div>
                    <div class="sf-summary-value purple" id="accessoryCategories">0</div>
                    <div class="sf-summary-subtitle">Types of items</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="sf-charts-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <span style="font-size: 0.875rem; font-weight: 600; color: var(--sf-gray-800);">Charts</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="sf-btn sf-btn-success" onclick="saveChartSettings()" id="saveChartsBtn" style="padding: 0.375rem 0.75rem;" title="Save chart configuration">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.25rem;">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            Save
                        </button>
                        <button class="sf-btn sf-btn-brand" onclick="addChart()" id="addChartBtn" style="padding: 0.375rem 0.75rem;" title="Add new chart">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.25rem;">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add Chart
                        </button>
                    </div>
                </div>
                <div id="chartsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1rem;">
                    <!-- Charts will be dynamically inserted here -->
                </div>
                <div class="sf-loading" id="chartLoading" style="display: none;">
                    <div class="sf-spinner"></div>
                </div>
            </div>

            <!-- Bulk Actions Toolbar -->
            <div id="bulkActionsBar" class="sf-bulk-actions" style="display: none;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span id="selectedCount" style="font-weight: 600;">0 items selected</span>
                    <button class="sf-btn sf-btn-brand" onclick="openBulkEditModal()">
                        <i class="fas fa-edit"></i> Bulk Edit
                    </button>
                    <button class="sf-btn sf-btn-neutral" onclick="clearSelection()">
                        <i class="fas fa-times"></i> Clear Selection
                    </button>
                </div>
            </div>

            <!-- Maintenance Assets Section -->
            <div class="sf-maintenance-section" id="maintenanceSection" style="display: none;">
                <!-- Actions Bar -->
                <div class="sf-maintenance-content" id="maintenanceContent">
                    <!-- Actions Bar -->
                    <div class="sf-maintenance-actions">
                        <div class="sf-maintenance-search">
                            <input type="text"
                                   id="maintenanceSearchInput"
                                   placeholder="Search by serial, asset tag, model..."
                                   onkeyup="searchMaintenanceAssets()">
                        </div>

                        <div class="sf-maintenance-bulk-actions">
                            {% if current_user.is_super_admin or current_user.is_developer %}
                            <button id="bulkMarkCompletedBtn"
                                    class="sf-btn sf-btn-neutral"
                                    style="background: #10b981; border-color: #10b981; color: white;"
                                    onclick="bulkMarkCompleted()"
                                    disabled>
                                <i class="fas fa-check"></i> Mark as Completed
                            </button>
                            {% endif %}

                            <button class="sf-btn sf-btn-neutral" onclick="refreshMaintenanceAssets()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="sf-maintenance-table-wrapper">
                        <table class="sf-maintenance-table">
                            <thead>
                                <tr>
                                    {% if current_user.is_super_admin or current_user.is_developer %}
                                    <th style="width: 40px;">
                                        <input type="checkbox"
                                               id="selectAllMaintenance"
                                               onchange="toggleSelectAllMaintenance()">
                                    </th>
                                    {% endif %}
                                    <th style="width: 100px;">Asset Tag</th>
                                    <th style="width: 150px;">Serial</th>
                                    <th>Product Details</th>
                                    <th style="width: 120px;">Company</th>
                                    <th style="width: 100px;">Country</th>
                                    <th style="width: 100px;">Status</th>
                                    <th style="width: 100px;">Erased</th>
                                    {% if current_user.is_super_admin or current_user.is_developer %}
                                    <th style="width: 120px;">Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody id="maintenanceTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div class="sf-maintenance-empty" id="maintenanceEmptyState" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <p>No assets require maintenance</p>
                    </div>

                    <!-- Loading State -->
                    <div class="sf-maintenance-loading" id="maintenanceLoadingState" style="display: none;">
                        <div class="sf-spinner"></div>
                        <p>Loading maintenance assets...</p>
                    </div>
                </div>
            </div>

            <!-- Data table -->
            <div class="sf-table-container">
                <div class="sf-table-header">
                    <span class="sf-table-title" id="tableTitle">Asset Details</span>
                    <span style="font-size: 0.8125rem; color: var(--sf-gray-600);" id="tableInfo">Showing 0 results</span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="sf-table">
                        <thead id="tableHead">
                            <tr id="tableHeaderRow">
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" title="Select all on this page">
                                </th>
                                <th class="sortable" data-sort="asset_tag" onclick="sortTable('asset_tag')">Asset Tag</th>
                                <th class="sortable" data-sort="name" onclick="sortTable('name')">Name</th>
                                <th class="sortable" data-sort="serial_number" onclick="sortTable('serial_number')">Serial Number</th>
                                <th class="sortable" data-sort="status" onclick="sortTable('status')">Status</th>
                                <th class="sortable" data-sort="category" onclick="sortTable('category')">Category</th>
                                <th class="sortable" data-sort="customer" onclick="sortTable('customer')">Customer</th>
                                <th class="sortable" data-sort="company" onclick="sortTable('company')">Company</th>
                                <th class="sortable" data-sort="country" onclick="sortTable('country')">Country</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="10" class="sf-loading">
                                    <div class="sf-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="sf-pagination">
                    <div class="sf-pagination-info">
                        <span>Showing <span id="pageStart">0</span> to <span id="pageEnd">0</span> of <span id="totalRecords">0</span> assets</span>
                    </div>
                    <div class="sf-pagination-controls">
                        <button class="sf-pagination-btn" onclick="changePage(-1)" id="prevBtn" disabled>Previous</button>
                        <span id="pageNumber">Page 1</span>
                        <button class="sf-pagination-btn" onclick="changePage(1)" id="nextBtn">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Edit Modal -->
<div id="bulkEditModal" class="sf-modal-overlay" style="display: none;">
    <div class="sf-modal" style="max-width: 95%; width: 1400px;">
        <div class="sf-modal-header">
            <span class="sf-modal-title">Bulk Edit <span id="bulkEditCount">0</span> Items</span>
            <button class="sf-modal-close" onclick="closeBulkEditModal()">&times;</button>
        </div>
        <div class="sf-modal-body" style="max-height: 70vh; overflow-y: auto;">
            <p style="color: var(--sf-gray-600); font-size: 0.875rem; margin-bottom: 1rem;">
                Edit individual items below. Changes are highlighted in yellow. Click "Save All Changes" to apply.
            </p>

            <div style="overflow-x: auto;">
                <table class="sf-table" id="bulkEditTable" style="font-size: 0.8125rem;">
                    <thead>
                        <tr>
                            <th style="min-width: 120px;">Asset Tag</th>
                            <th style="min-width: 150px;">Name</th>
                            <th style="min-width: 120px;">Serial Number</th>
                            <th style="min-width: 120px;">Status</th>
                            <th style="min-width: 100px;">Country</th>
                            <th style="min-width: 120px;">Company</th>
                            <th style="min-width: 120px;">Location</th>
                            <th style="min-width: 100px;">Category</th>
                        </tr>
                    </thead>
                    <tbody id="bulkEditTableBody">
                        <!-- Items will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="sf-modal-footer">
            <button class="sf-btn sf-btn-neutral" onclick="closeBulkEditModal()">Cancel</button>
            <button class="sf-btn sf-btn-brand" onclick="applyBulkEdit()">
                <i class="fas fa-check"></i> Save All Changes
            </button>
        </div>
    </div>
</div>

<script>
// Global variables
let charts = {}; // Store multiple chart instances by ID
let chartConfigs = []; // Store chart configurations [{id, chartType, groupBy}]
let nextChartId = 1;
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
let assetData = [];
let accessoryData = [];
let filteredData = [];
let filterOptions = {};
let currentPage = 1;
let selectedItems = new Set(); // Track selected item IDs for bulk edit
let pageSize = 25;
let sortField = 'asset_tag';
let sortDirection = 'asc';
let searchTimeout = null;
let currentTab = 'tech'; // 'tech' or 'accessories'

// Color palette
const colors = [
    '#0176d3', '#2e844a', '#fe9339', '#ea001e', '#9050e9',
    '#1b96ff', '#04844b', '#ff538a', '#00b4d8', '#7c868d'
];

// Status badge classes
const statusBadgeClasses = {
    'Deployed': 'sf-badge-deployed',
    'In Stock': 'sf-badge-instock',
    'Ready to Deploy': 'sf-badge-readytodeploy',
    'Shipped': 'sf-badge-shipped',
    'Repair': 'sf-badge-repair',
    'Archived': 'sf-badge-archived',
    'Disposed': 'sf-badge-disposed'
};

// Initialize
document.addEventListener('DOMContentLoaded', async function() {
    await loadChartSettings();
    await loadFilters();
    await loadAssets();
});

// Load saved chart settings
async function loadChartSettings() {
    try {
        const response = await fetch('/inventory/api/sf/chart-settings');
        const isJson = (response.headers.get('content-type') || '').includes('application/json');
        const data = isJson ? await response.json() : {};

        if (response.ok && data.success && data.charts && data.charts.length > 0) {
            chartConfigs = data.charts;
            nextChartId = Math.max(...chartConfigs.map(c => c.id)) + 1;
        } else {
            // Default: one chart
            chartConfigs = [{ id: 1, chartType: 'doughnut', groupBy: 'status' }];
            nextChartId = 2;
        }
        console.log('Loaded chart settings:', chartConfigs);
    } catch (error) {
        console.error('Error loading chart settings:', error);
        chartConfigs = [{ id: 1, chartType: 'doughnut', groupBy: 'status' }];
        nextChartId = 2;
    }
}

// Save chart settings
async function saveChartSettings() {
    const btn = document.getElementById('saveChartsBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.25rem; animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"/></svg> Saving...';
    btn.disabled = true;

    // Debug: Check if CSRF token exists
    console.log('CSRF Token:', csrfToken ? 'Present (' + csrfToken.substring(0, 20) + '...)' : 'MISSING!');
    console.log('CSRF Token length:', csrfToken ? csrfToken.length : 0);
    console.log('Chart configs to save:', chartConfigs);

    if (!csrfToken) {
        console.error('WARNING: CSRF token is empty! Check if meta tag exists:', document.querySelector('meta[name="csrf-token"]'));
    }

    try {
        const response = await fetch('/inventory/api/sf/chart-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin',  // Ensure cookies (session) are sent
            body: JSON.stringify({ charts: chartConfigs })
        });

        const contentType = response.headers.get('content-type') || '';
        let data = null;
        let rawText = '';

        if (contentType.includes('application/json')) {
            data = await response.json();
        } else {
            rawText = await response.text();
            console.error('Non-JSON response:', rawText.substring(0, 200));
        }

        if (response.ok && data && data.success) {
            console.log('Saved chart settings:', data.charts || chartConfigs);
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.25rem;"><polyline points="20 6 9 17 4 12"/></svg> Saved!';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        } else {
            // Handle different error formats
            let errorMsg = `HTTP ${response.status}`;
            if (data) {
                console.error('Error response data:', data);
                if (data.error) {
                    // Handle object error {code, message, details} or string error
                    errorMsg = typeof data.error === 'object' ? (data.error.message || data.error.details || JSON.stringify(data.error)) : data.error;
                }
            } else if (rawText) {
                errorMsg = rawText.substring(0, 100);
            }
            throw new Error(errorMsg);
        }
    } catch (error) {
        console.error('Error saving chart settings:', error);
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.25rem;"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> Error';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    }
}

// Add a new chart
function addChart() {
    const newConfig = {
        id: nextChartId++,
        chartType: 'doughnut',
        groupBy: 'status'
    };
    chartConfigs.push(newConfig);
    renderChartContainer(newConfig);
    updateSingleChart(newConfig.id);
}

// Remove a chart
function removeChart(chartId) {
    if (chartConfigs.length <= 1) {
        alert('You must have at least one chart.');
        return;
    }

    // Destroy the chart instance
    if (charts[chartId]) {
        charts[chartId].destroy();
        delete charts[chartId];
    }

    // Remove from configs
    chartConfigs = chartConfigs.filter(c => c.id !== chartId);

    // Remove DOM element
    const container = document.getElementById(`chart-container-${chartId}`);
    if (container) {
        container.remove();
    }
}

// Render a chart container
function renderChartContainer(config) {
    const container = document.getElementById('chartsContainer');
    const filterValue = config.filter ? config.filter.value : null;
    const chartHtml = `
        <div class="sf-chart-container" id="chart-container-${config.id}" style="position: relative;">
            <button onclick="removeChart(${config.id})" class="sf-chart-remove-btn" title="Remove chart" style="position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; cursor: pointer; color: var(--sf-gray-600); padding: 0.25rem; border-radius: 0.25rem; z-index: 10;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <div class="sf-chart-header">
                <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="sf-chart-title">Distribution by <span id="chartGroupLabel-${config.id}">${config.groupBy.charAt(0).toUpperCase() + config.groupBy.slice(1)}</span></span>
                    <span id="chartFilter-${config.id}" class="sf-chart-filter-badge" style="display: ${filterValue ? 'inline-flex' : 'none'}; align-items: center; gap: 0.25rem; background: var(--sf-blue); color: white; padding: 0.125rem 0.5rem; border-radius: 1rem; font-size: 0.75rem;">
                        <span id="chartFilterText-${config.id}">${filterValue || ''}</span>
                        <button onclick="clearChartFilter(${config.id})" style="background: none; border: none; color: white; cursor: pointer; padding: 0; line-height: 1; font-size: 0.875rem;">&times;</button>
                    </span>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <select id="chartGroupBy-${config.id}" class="sf-btn sf-btn-neutral" style="padding: 0.375rem 0.5rem;" onchange="updateChartGrouping(${config.id})">
                        <option value="status" ${config.groupBy === 'status' ? 'selected' : ''}>Status</option>
                        <option value="category" ${config.groupBy === 'category' ? 'selected' : ''}>Category</option>
                        <option value="company" ${config.groupBy === 'company' ? 'selected' : ''}>Company</option>
                        <option value="country" ${config.groupBy === 'country' ? 'selected' : ''}>Country</option>
                    </select>
                    <button class="sf-btn ${config.chartType === 'doughnut' ? 'sf-btn-brand' : 'sf-btn-neutral'}" style="padding: 0.25rem 0.5rem;" onclick="setChartType(${config.id}, 'doughnut')" id="btnDoughnut-${config.id}">
                        Doughnut
                    </button>
                    <button class="sf-btn ${config.chartType === 'bar' ? 'sf-btn-brand' : 'sf-btn-neutral'}" style="padding: 0.25rem 0.5rem;" onclick="setChartType(${config.id}, 'bar')" id="btnBar-${config.id}">
                        Bar
                    </button>
                </div>
            </div>
            <div class="sf-chart-body" style="height: 250px; position: relative;">
                <canvas id="chart-${config.id}"></canvas>
                <div class="sf-no-data" id="chartNoData-${config.id}" style="display: none;">
                    <svg class="sf-no-data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <span>No data available</span>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', chartHtml);
}

// Clear filter for a specific chart
function clearChartFilter(chartId) {
    const config = chartConfigs.find(c => c.id === chartId);
    if (config) {
        config.filter = null;
        // Update filter badge visibility
        const badge = document.getElementById(`chartFilter-${chartId}`);
        if (badge) badge.style.display = 'none';
        updateSingleChart(chartId);
    }
}

// Apply filter to a specific chart when clicking on a segment
function applyChartFilter(chartId, label) {
    const config = chartConfigs.find(c => c.id === chartId);
    if (config) {
        // Toggle filter: if same filter clicked again, clear it
        if (config.filter && config.filter.value === label) {
            clearChartFilter(chartId);
            return;
        }
        config.filter = { field: config.groupBy, value: label };
        // Update filter badge
        const badge = document.getElementById(`chartFilter-${chartId}`);
        const text = document.getElementById(`chartFilterText-${chartId}`);
        if (badge && text) {
            text.textContent = label;
            badge.style.display = 'inline-flex';
        }
        updateSingleChart(chartId);
    }
}

// Render all chart containers
function renderAllCharts() {
    const container = document.getElementById('chartsContainer');
    container.innerHTML = '';
    chartConfigs.forEach(config => renderChartContainer(config));
}

// Load filter options
async function loadFilters() {
    document.getElementById('loadingStatus').textContent = '(Loading filters...)';
    try {
        console.log('Loading filters...');
        const response = await fetch('/inventory/api/sf/filters');

        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }

        const data = await response.json();
        console.log('Filters response:', data);

        if (data.success) {
            filterOptions = data;
            populateFilter('statusFilter', data.statuses || [], 'status');
            // Use asset categories by default (tech assets tab)
            populateFilter('categoryFilter', data.asset_categories || data.categories || [], 'category');
            populateFilter('companyFilter', data.companies || [], 'company');
            populateFilter('countryFilter', data.countries || [], 'country');
            populateFilter('locationFilter', data.locations || [], 'location');
        } else {
            console.error('Filter API returned error:', data.error);
            document.getElementById('errorMessage').textContent = 'Filter Error: ' + (data.error || 'Unknown error');
            document.getElementById('errorMessage').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading filters:', error);
        document.getElementById('errorMessage').textContent = 'Filter Load Error: ' + error.message;
        document.getElementById('errorMessage').style.display = 'block';
    }
}

// Update category filter based on current tab
function updateCategoryFilter() {
    if (!filterOptions) return;

    if (currentTab === 'tech') {
        populateFilter('categoryFilter', filterOptions.asset_categories || filterOptions.categories || [], 'category');
    } else {
        populateFilter('categoryFilter', filterOptions.accessory_categories || [], 'category');
    }
}

// Populate a filter section
function populateFilter(containerId, options, filterType) {
    const container = document.getElementById(containerId);
    const countEl = document.getElementById(filterType + 'Count');

    if (countEl) {
        countEl.textContent = options.length;
    }

    // Add select all/deselect all toggle at the top
    const toggleHtml = `
        <div class="sf-filter-toggle" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--sf-gray-200);">
            <button type="button" onclick="selectAllFilter('${filterType}')" style="flex: 1; padding: 0.25rem 0.5rem; font-size: 0.7rem; background: var(--sf-blue); color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                Select All
            </button>
            <button type="button" onclick="deselectAllFilter('${filterType}')" style="flex: 1; padding: 0.25rem 0.5rem; font-size: 0.7rem; background: var(--sf-gray-200); color: var(--sf-gray-700); border: none; border-radius: 0.25rem; cursor: pointer;">
                Deselect All
            </button>
        </div>
    `;

    // Location filter should NOT be checked by default (show all assets including those without location)
    const checkedByDefault = filterType !== 'location';

    const optionsHtml = options.map(opt => `
        <label class="sf-checkbox-item">
            <input type="checkbox" value="${opt.value}" data-filter="${filterType}" ${checkedByDefault ? 'checked' : ''} onchange="applyFilters()">
            <span>${opt.label}</span>
            <span class="count">${opt.count}</span>
        </label>
    `).join('');

    container.innerHTML = toggleHtml + optionsHtml;
}

// Select all options in a filter
function selectAllFilter(filterType) {
    const checkboxes = document.querySelectorAll(`input[data-filter="${filterType}"]`);
    checkboxes.forEach(cb => cb.checked = true);
    applyFilters();
}

// Deselect all options in a filter
function deselectAllFilter(filterType) {
    const checkboxes = document.querySelectorAll(`input[data-filter="${filterType}"]`);
    checkboxes.forEach(cb => cb.checked = false);
    applyFilters();
}

// Load assets from API
async function loadAssets() {
    document.getElementById('chartLoading').style.display = 'flex';
    document.getElementById('loadingStatus').textContent = '(Loading assets...)';
    document.getElementById('loadingStatus').style.display = 'inline';

    try {
        console.log('Loading assets...');
        const response = await fetch('/inventory/api/sf/assets');

        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }

        const data = await response.json();
        console.log('Assets response:', data);

        if (data.success) {
            assetData = data.assets;
            console.log('Loaded', assetData.length, 'assets');
            document.getElementById('loadingStatus').style.display = 'none';
            applyFilters();
        } else {
            console.error('Assets API returned error:', data.error);
            document.getElementById('chartLoading').style.display = 'none';
            document.getElementById('loadingStatus').textContent = '(Error)';
            document.getElementById('loadingStatus').style.color = '#ea001e';
            document.getElementById('assetCountText').textContent = 'Error: ' + (data.error || 'Unknown error');
            document.getElementById('errorMessage').textContent = 'API Error: ' + (data.error || 'Unknown error');
            document.getElementById('errorMessage').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading assets:', error);
        document.getElementById('chartLoading').style.display = 'none';
        document.getElementById('loadingStatus').textContent = '(Error)';
        document.getElementById('loadingStatus').style.color = '#ea001e';
        document.getElementById('assetCountText').textContent = 'Error: ' + error.message;
        document.getElementById('errorMessage').textContent = 'Network/Fetch Error: ' + error.message;
        document.getElementById('errorMessage').style.display = 'block';
    }
}

// Apply filters
function applyFilters() {
    const filters = getSelectedFilters();
    const search = document.getElementById('searchInput').value.toLowerCase();

    console.log('applyFilters called - currentTab:', currentTab, 'search:', search);

    // Check if we're on the accessories tab
    if (currentTab === 'accessories') {
        console.log('Routing to applyAccessoryFilters, accessoryData length:', accessoryData.length);
        applyAccessoryFilters(search, filters);
        return;
    }

    filteredData = assetData.filter(asset => {
        // Check search
        if (search) {
            const searchFields = [
                asset.asset_tag, asset.name, asset.serial_number,
                asset.customer, asset.company, asset.country
            ].map(f => (f || '').toLowerCase());

            if (!searchFields.some(f => f.includes(search))) {
                return false;
            }
        }

        // Check status filter
        if (filters.statuses.length > 0 && !filters.statuses.includes(asset.status)) {
            return false;
        }

        // Check category filter
        if (filters.categories.length > 0 && !filters.categories.includes(asset.category)) {
            return false;
        }

        // Check company filter (with parent/child company grouping support)
        if (filters.companies.length > 0) {
            // Check if asset's company matches directly
            const companyMatch = filters.companies.includes(asset.company);
            // Also check if asset's parent company matches (for child companies)
            const parentMatch = asset.parent_company && filters.companies.includes(asset.parent_company);
            // Check if "Unknown" filter is selected and asset has no company
            const unknownMatch = filters.companies.includes('') && (!asset.company || asset.company.trim() === '');

            if (!companyMatch && !parentMatch && !unknownMatch) {
                return false;
            }
        }

        // Check country filter
        if (filters.countries.length > 0 && !filters.countries.includes(asset.country)) {
            return false;
        }

        // Check location filter
        if (filters.locations.length > 0 && !filters.locations.includes(asset.location)) {
            return false;
        }

        return true;
    });

    // Reset to first page
    currentPage = 1;

    // Update UI
    updateSummaryCards();
    updateChart();
    updateTable();

    document.getElementById('assetCountText').textContent = `Found ${filteredData.length} assets with current filters`;
}

// Apply filters for accessories tab
function applyAccessoryFilters(search, filters) {
    console.log('applyAccessoryFilters called - search:', search, 'accessoryData length:', accessoryData.length);

    filteredData = accessoryData.filter(accessory => {
        // Check search - search in name, category, manufacturer, model, notes, country
        if (search) {
            const searchFields = [
                accessory.name,
                accessory.category,
                accessory.manufacturer,
                accessory.model_no,
                accessory.notes,
                accessory.country
            ].map(f => (f || '').toLowerCase());

            if (!searchFields.some(f => f.includes(search))) {
                return false;
            }
        }

        // Note: We don't apply sidebar filters (category, company, location) to accessories
        // because the sidebar filters are built for assets and have different values.
        // Only apply country filter if selected (country values are consistent across both)
        if (filters.countries.length > 0) {
            // Check if the accessory's country matches any selected country
            const accessoryCountry = (accessory.country || '').toLowerCase();
            const matchesCountry = filters.countries.some(c =>
                c.toLowerCase() === accessoryCountry
            );
            if (!matchesCountry) {
                return false;
            }
        }

        return true;
    });

    // Reset to first page
    currentPage = 1;

    console.log('applyAccessoryFilters result - filteredData length:', filteredData.length);

    // Update UI
    updateAccessorySummary();
    updateChart();
    updateAccessoryTable();

    document.getElementById('assetCountText').textContent = `Found ${filteredData.length} accessories with current filters`;
}

// Get selected filter values
function getSelectedFilters() {
    const filters = {
        statuses: [],
        categories: [],
        companies: [],
        countries: [],
        locations: []
    };

    document.querySelectorAll('input[data-filter="status"]:checked').forEach(cb => {
        filters.statuses.push(cb.value);
    });
    document.querySelectorAll('input[data-filter="category"]:checked').forEach(cb => {
        filters.categories.push(cb.value);
    });
    document.querySelectorAll('input[data-filter="company"]:checked').forEach(cb => {
        filters.companies.push(cb.value);
    });
    document.querySelectorAll('input[data-filter="country"]:checked').forEach(cb => {
        filters.countries.push(cb.value);
    });
    document.querySelectorAll('input[data-filter="location"]:checked').forEach(cb => {
        filters.locations.push(cb.value);
    });

    return filters;
}

// Update summary cards
function updateSummaryCards() {
    const total = filteredData.length;
    const deployed = filteredData.filter(a => a.status === 'Deployed').length;
    const instock = filteredData.filter(a => a.status === 'In Stock').length;
    const readyToDeploy = filteredData.filter(a => a.status === 'Ready to Deploy').length;
    const disposed = filteredData.filter(a => a.status === 'Disposed').length;

    document.getElementById('totalAssets').textContent = total.toLocaleString();
    document.getElementById('deployedAssets').textContent = deployed.toLocaleString();
    document.getElementById('instockAssets').textContent = instock.toLocaleString();
    document.getElementById('readyToDeployAssets').textContent = readyToDeploy.toLocaleString();
    document.getElementById('disposedAssets').textContent = disposed.toLocaleString();
}

// Update all charts
function updateChart() {
    document.getElementById('chartLoading').style.display = 'none';

    // Render chart containers if not already done
    if (document.getElementById('chartsContainer').children.length === 0) {
        renderAllCharts();
    }

    // Update each chart
    chartConfigs.forEach(config => {
        updateSingleChart(config.id);
    });
}

// Update a single chart
function updateSingleChart(chartId) {
    const config = chartConfigs.find(c => c.id === chartId);
    if (!config) return;

    const groupBy = config.groupBy;
    const chartType = config.chartType;

    const labelEl = document.getElementById(`chartGroupLabel-${chartId}`);
    if (labelEl) {
        labelEl.textContent = groupBy.charAt(0).toUpperCase() + groupBy.slice(1);
    }

    // Apply per-chart filter if exists
    let chartData = filteredData;
    if (config.filter) {
        chartData = filteredData.filter(item => {
            const itemValue = item[config.filter.field] || 'Unknown';
            return itemValue === config.filter.value;
        });
    }

    // Group data
    const groups = {};
    chartData.forEach(asset => {
        const key = asset[groupBy] || 'Unknown';
        groups[key] = (groups[key] || 0) + 1;
    });

    const labels = Object.keys(groups).sort();
    const values = labels.map(l => groups[l]);

    const noDataEl = document.getElementById(`chartNoData-${chartId}`);
    if (labels.length === 0) {
        if (noDataEl) noDataEl.style.display = 'flex';
        if (charts[chartId]) {
            charts[chartId].destroy();
            delete charts[chartId];
        }
        return;
    }

    if (noDataEl) noDataEl.style.display = 'none';

    const canvas = document.getElementById(`chart-${chartId}`);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const isCircular = chartType === 'doughnut' || chartType === 'pie';

    const chartConfig = {
        type: chartType,
        data: {
            labels: labels,
            datasets: [{
                label: currentTab === 'tech' ? 'Assets' : 'Accessories',
                data: values,
                backgroundColor: colors.slice(0, labels.length),
                borderColor: isCircular ? 'white' : colors.slice(0, labels.length),
                borderWidth: isCircular ? 2 : 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const label = labels[index];
                    applyChartFilter(chartId, label);
                }
            },
            plugins: {
                legend: {
                    display: isCircular,
                    position: 'right',
                    onClick: (e, legendItem, legend) => {
                        // When clicking on legend item, filter by that value
                        const label = legendItem.text;
                        applyChartFilter(chartId, label);
                    }
                },
                tooltip: {
                    callbacks: {
                        footer: () => 'Click to filter this chart'
                    }
                }
            },
            scales: isCircular ? {} : {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    };

    if (charts[chartId]) {
        charts[chartId].destroy();
    }
    charts[chartId] = new Chart(ctx, chartConfig);

    // Update button states
    const btnDoughnut = document.getElementById(`btnDoughnut-${chartId}`);
    const btnBar = document.getElementById(`btnBar-${chartId}`);
    if (btnDoughnut) {
        btnDoughnut.classList.toggle('sf-btn-brand', chartType === 'doughnut');
        btnDoughnut.classList.toggle('sf-btn-neutral', chartType !== 'doughnut');
    }
    if (btnBar) {
        btnBar.classList.toggle('sf-btn-brand', chartType === 'bar');
        btnBar.classList.toggle('sf-btn-neutral', chartType !== 'bar');
    }
}

// Set chart type for a specific chart
function setChartType(chartId, type) {
    const config = chartConfigs.find(c => c.id === chartId);
    if (config) {
        config.chartType = type;
        updateSingleChart(chartId);
    }
}

// Update chart grouping for a specific chart
function updateChartGrouping(chartId) {
    const config = chartConfigs.find(c => c.id === chartId);
    const select = document.getElementById(`chartGroupBy-${chartId}`);
    if (config && select) {
        config.groupBy = select.value;
        updateSingleChart(chartId);
    }
}

// Update table
function updateTable() {
    // Sort data
    const sortedData = [...filteredData].sort((a, b) => {
        const aVal = (a[sortField] || '').toString().toLowerCase();
        const bVal = (b[sortField] || '').toString().toLowerCase();

        if (sortDirection === 'asc') {
            return aVal.localeCompare(bVal);
        } else {
            return bVal.localeCompare(aVal);
        }
    });

    // Paginate
    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = startIdx + pageSize;
    const pageData = sortedData.slice(startIdx, endIdx);

    const tbody = document.getElementById('tableBody');

    if (pageData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" style="text-align: center; padding: 2rem; color: var(--sf-gray-600);">
                    No assets found matching your filters
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = pageData.map(asset => `
            <tr class="${selectedItems.has(asset.id) ? 'selected' : ''}" data-id="${asset.id}">
                <td>
                    <input type="checkbox" class="row-checkbox" data-id="${asset.id}"
                           ${selectedItems.has(asset.id) ? 'checked' : ''}
                           onchange="toggleItemSelection(${asset.id}, this.checked)">
                </td>
                <td><a href="/inventory/sf/asset/${asset.id}" class="sf-table-link">${escapeHtml(asset.asset_tag)}</a></td>
                <td>${escapeHtml(asset.name)}</td>
                <td>${escapeHtml(asset.serial_number || '-')}</td>
                <td><span class="sf-badge ${statusBadgeClasses[asset.status] || ''}">${escapeHtml(asset.status)}</span></td>
                <td>${escapeHtml(asset.category || '-')}</td>
                <td>${escapeHtml(asset.customer || '-')}</td>
                <td>${escapeHtml(asset.company || '-')}</td>
                <td>${escapeHtml(asset.country || '-')}</td>
                <td>
                    <a href="/inventory/sf/asset/${asset.id}" class="sf-btn sf-btn-neutral" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View</a>
                </td>
            </tr>
        `).join('');
    }

    // Update select all checkbox state
    updateSelectAllCheckbox();

    // Update pagination info
    document.getElementById('pageStart').textContent = filteredData.length > 0 ? startIdx + 1 : 0;
    document.getElementById('pageEnd').textContent = Math.min(endIdx, filteredData.length);
    document.getElementById('totalRecords').textContent = filteredData.length;
    document.getElementById('pageNumber').textContent = `Page ${currentPage}`;
    document.getElementById('tableInfo').textContent = `Showing ${pageData.length} of ${filteredData.length} results`;

    // Update button states
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = endIdx >= filteredData.length;

    // Update sort indicators
    document.querySelectorAll('.sf-table th').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === sortField) {
            th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
    });
}

// Sort table
function sortTable(field) {
    if (sortField === field) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortField = field;
        sortDirection = 'asc';
    }
    updateTable();
}

// Change page
function changePage(delta) {
    const maxPage = Math.ceil(filteredData.length / pageSize);
    const newPage = currentPage + delta;

    if (newPage >= 1 && newPage <= maxPage) {
        currentPage = newPage;
        updateTable();
    }
}

// Toggle filter section
function toggleFilter(filterName) {
    const content = document.getElementById(filterName + 'Filter');
    content.classList.toggle('collapsed');
}

// Toggle sidebar
function toggleSidebar() {
    const sidebar = document.getElementById('filterSidebar');
    const toggle = document.getElementById('toggleSidebar');
    const icon = document.getElementById('toggleIcon');

    sidebar.classList.toggle('collapsed');
    toggle.classList.toggle('collapsed');

    if (sidebar.classList.contains('collapsed')) {
        icon.innerHTML = '<polyline points="9,18 15,12 9,6"/>';
    } else {
        icon.innerHTML = '<polyline points="15,18 9,12 15,6"/>';
    }
}

// Reset filters
function resetFilters() {
    document.querySelectorAll('.sf-filter-content input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
    });
    document.getElementById('searchInput').value = '';
    applyFilters();
}

// Debounced search
function debounceSearch() {
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    searchTimeout = setTimeout(() => {
        applyFilters();
    }, 300);
}

// Export assets
function exportAssets() {
    // Check if we're on tech assets or accessories tab
    const currentTab = document.querySelector('.sf-tab.active')?.dataset?.tab || 'tech';

    let dataToExport;

    if (currentTab === 'tech') {
        // For tech assets: export selected if any, otherwise export all filtered
        // Use selectedItems Set which tracks selections across pages
        if (selectedItems.size > 0) {
            // Export from the full assetData (not just current page)
            dataToExport = assetData.filter(a => selectedItems.has(a.id));
        } else {
            dataToExport = filteredData;
        }

        if (dataToExport.length === 0) {
            alert('No data to export');
            return;
        }

        const headers = [
            'Asset Tag', 'Name', 'Serial Number', 'Status', 'Category', 'Customer', 'Company', 'Country', 'Location', 'Model',
            'CPU', 'CPU Cores', 'GPU', 'GPU Cores', 'Memory', 'Memory Type', 'Storage', 'Storage Type',
            'OS', 'OS Version', 'Battery Cycles', 'Battery Health', 'WiFi MAC', 'Ethernet MAC'
        ];
        const rows = dataToExport.map(a => [
            a.asset_tag, a.name, a.serial_number, a.status, a.category,
            a.customer, a.company, a.country, a.location, a.model,
            a.cpu, a.cpu_cores, a.gpu, a.gpu_cores, a.memory, a.memory_type, a.storage, a.storage_type,
            a.os, a.os_version, a.battery_cycles, a.battery_health, a.wifi_mac, a.ethernet_mac
        ].map(val => {
            val = val || '';
            if (typeof val === 'string' && (val.includes(',') || val.includes('"'))) {
                return `"${val.replace(/"/g, '""')}"`;
            }
            return val;
        }));

        const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const filename = selectedItems.size > 0
            ? `selected_assets_${selectedItems.size}_${new Date().toISOString().split('T')[0]}.csv`
            : `asset_inventory_${new Date().toISOString().split('T')[0]}.csv`;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
    } else {
        // For accessories: export all filtered (no checkbox selection)
        dataToExport = filteredData;

        if (dataToExport.length === 0) {
            alert('No data to export');
            return;
        }

        const headers = ['Name', 'Category', 'Total Quantity', 'Available', 'In Use', 'Country', 'Company', 'Status'];
        const rows = dataToExport.map(a => [
            a.name, a.category, a.total_quantity, a.available_quantity,
            (a.total_quantity || 0) - (a.available_quantity || 0),
            a.country, a.company, a.status
        ].map(val => {
            val = val || '';
            if (typeof val === 'string' && (val.includes(',') || val.includes('"'))) {
                return `"${val.replace(/"/g, '""')}"`;
            }
            return val;
        }));

        const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `accessory_inventory_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    }
}

// Escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Update table headers based on current tab
function updateTableHeaders(tab) {
    const headerRow = document.getElementById('tableHeaderRow');
    const tableTitle = document.getElementById('tableTitle');
    if (!headerRow) return;

    // Update table title
    if (tableTitle) {
        tableTitle.textContent = tab === 'tech' ? 'Asset Details' : 'Accessory Details';
    }

    if (tab === 'tech') {
        headerRow.innerHTML = `
            <th style="width: 40px;">
                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" title="Select all on this page">
            </th>
            <th class="sortable" data-sort="asset_tag" onclick="sortTable('asset_tag')">Asset Tag</th>
            <th class="sortable" data-sort="name" onclick="sortTable('name')">Name</th>
            <th class="sortable" data-sort="serial_number" onclick="sortTable('serial_number')">Serial Number</th>
            <th class="sortable" data-sort="status" onclick="sortTable('status')">Status</th>
            <th class="sortable" data-sort="category" onclick="sortTable('category')">Category</th>
            <th class="sortable" data-sort="customer" onclick="sortTable('customer')">Customer</th>
            <th class="sortable" data-sort="company" onclick="sortTable('company')">Company</th>
            <th class="sortable" data-sort="country" onclick="sortTable('country')">Country</th>
            <th>Actions</th>
        `;
    } else {
        headerRow.innerHTML = `
            <th class="sortable" data-sort="name" onclick="sortTable('name')">Name</th>
            <th class="sortable" data-sort="category" onclick="sortTable('category')">Category</th>
            <th class="sortable" data-sort="total_quantity" onclick="sortTable('total_quantity')">Total Qty</th>
            <th class="sortable" data-sort="available_quantity" onclick="sortTable('available_quantity')">Available</th>
            <th>In Use</th>
            <th class="sortable" data-sort="country" onclick="sortTable('country')">Country</th>
            <th class="sortable" data-sort="status" onclick="sortTable('status')">Status</th>
            <th>Actions</th>
        `;
    }
}

// Switch between Tech Assets, Accessories, and Maintenance tabs
async function switchTab(tab) {
    currentTab = tab;
    currentPage = 1;

    // Update tab styles
    const techTab = document.getElementById('tabTechAssets');
    const accTab = document.getElementById('tabAccessories');
    const maintenanceTab = document.getElementById('tabMaintenance');

    // Get content sections
    const techSummary = document.getElementById('techSummaryCards');
    const accSummary = document.getElementById('accessorySummaryCards');
    const maintenanceSection = document.getElementById('maintenanceSection');
    const chartsSection = document.querySelector('.sf-charts-section');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const tableContainer = document.querySelector('.sf-table-container');

    // Reset all tab styles
    techTab.style.color = 'var(--sf-gray-600)';
    techTab.style.borderBottomColor = 'transparent';
    accTab.style.color = 'var(--sf-gray-600)';
    accTab.style.borderBottomColor = 'transparent';
    maintenanceTab.style.color = 'var(--sf-gray-600)';
    maintenanceTab.style.borderBottomColor = 'transparent';

    if (tab === 'tech') {
        techTab.style.color = 'var(--sf-blue)';
        techTab.style.borderBottomColor = 'var(--sf-blue)';

        // Show tech content, hide others
        techSummary.style.display = 'grid';
        accSummary.style.display = 'none';
        maintenanceSection.style.display = 'none';
        chartsSection.style.display = 'block';
        tableContainer.style.display = 'block';

        document.getElementById('viewTitle').textContent = 'Tech Assets Overview';

        // Update category filter and table headers
        updateCategoryFilter();
        updateTableHeaders(tab);

        // Update search placeholder
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.placeholder = 'Search assets...';
            searchInput.value = '';
        }

        // Show tech asset data
        filteredData = [...assetData];
        applyFilters();
    } else if (tab === 'accessories') {
        accTab.style.color = 'var(--sf-blue)';
        accTab.style.borderBottomColor = 'var(--sf-blue)';

        // Show accessories content, hide others
        techSummary.style.display = 'none';
        accSummary.style.display = 'grid';
        maintenanceSection.style.display = 'none';
        chartsSection.style.display = 'block';
        tableContainer.style.display = 'block';

        document.getElementById('viewTitle').textContent = 'Accessories Overview';

        // Update category filter and table headers
        updateCategoryFilter();
        updateTableHeaders(tab);

        // Update search placeholder
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.placeholder = 'Search accessories by name, category, manufacturer...';
            searchInput.value = '';
        }

        // Load accessories if not already loaded
        if (accessoryData.length === 0) {
            await loadAccessories();
        } else {
            filteredData = [...accessoryData];
            updateAccessorySummary();
            updateChart();
            updateAccessoryTable();
        }
    } else if (tab === 'maintenance') {
        maintenanceTab.style.color = 'var(--sf-blue)';
        maintenanceTab.style.borderBottomColor = 'var(--sf-blue)';

        // Show maintenance content, hide others
        techSummary.style.display = 'none';
        accSummary.style.display = 'none';
        maintenanceSection.style.display = 'block';
        chartsSection.style.display = 'none';
        tableContainer.style.display = 'none';
        if (bulkActionsBar) bulkActionsBar.style.display = 'none';

        document.getElementById('viewTitle').textContent = 'Maintenance Assets';

        // Load maintenance data if not already loaded
        if (maintenanceData.length === 0) {
            loadMaintenanceAssets();
        }
    }

    // Update export button text based on current tab and selection
    updateExportButtonText();
}

// Load accessories from API
async function loadAccessories() {
    document.getElementById('chartLoading').style.display = 'flex';
    document.getElementById('loadingStatus').textContent = '(Loading accessories...)';
    document.getElementById('loadingStatus').style.display = 'inline';

    try {
        const response = await fetch('/inventory/api/sf/accessories');

        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }

        const data = await response.json();

        if (data.success) {
            accessoryData = data.accessories;
            filteredData = [...accessoryData];
            document.getElementById('loadingStatus').style.display = 'none';
            updateAccessorySummary();
            updateChart();
            updateAccessoryTable();
            document.getElementById('assetCountText').textContent = `Found ${filteredData.length} accessories`;
        } else {
            document.getElementById('chartLoading').style.display = 'none';
            document.getElementById('loadingStatus').textContent = '(Error)';
            document.getElementById('assetCountText').textContent = 'Error: ' + (data.error || 'Unknown error');
        }
    } catch (error) {
        console.error('Error loading accessories:', error);
        document.getElementById('chartLoading').style.display = 'none';
        document.getElementById('loadingStatus').textContent = '(Error)';
        document.getElementById('assetCountText').textContent = 'Error: ' + error.message;
    }
}

// Update accessory summary cards
function updateAccessorySummary() {
    const total = filteredData.length;
    const totalQty = filteredData.reduce((sum, a) => sum + (a.total_quantity || 0), 0);
    const availableQty = filteredData.reduce((sum, a) => sum + (a.available_quantity || 0), 0);
    const inUseQty = totalQty - availableQty;
    const categories = new Set(filteredData.map(a => a.category)).size;

    document.getElementById('totalAccessories').textContent = total.toLocaleString();
    document.getElementById('totalAccessoryQty').textContent = totalQty.toLocaleString();
    document.getElementById('availableAccessoryQty').textContent = availableQty.toLocaleString();
    document.getElementById('inUseAccessoryQty').textContent = inUseQty.toLocaleString();
    document.getElementById('accessoryCategories').textContent = categories.toLocaleString();
}

// Update accessory table
function updateAccessoryTable() {
    const sortedData = [...filteredData].sort((a, b) => {
        const aVal = (a.name || '').toString().toLowerCase();
        const bVal = (b.name || '').toString().toLowerCase();
        return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    });

    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = startIdx + pageSize;
    const pageData = sortedData.slice(startIdx, endIdx);

    const tbody = document.getElementById('tableBody');

    if (pageData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 2rem; color: var(--sf-gray-600);">
                    No accessories found
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = pageData.map(acc => {
            const statusClass = (acc.status || '').toLowerCase().replace(/\s+/g, '');
            return `
            <tr>
                <td><a href="/inventory/sf/accessory/${acc.id}" class="sf-table-link">${escapeHtml(acc.name)}</a></td>
                <td>${escapeHtml(acc.category || '-')}</td>
                <td>${acc.total_quantity || 0}</td>
                <td>${acc.available_quantity || 0}</td>
                <td>${(acc.total_quantity || 0) - (acc.available_quantity || 0)}</td>
                <td>${escapeHtml(acc.country || '-')}</td>
                <td><span class="sf-badge ${statusBadgeClasses[acc.status] || ''}">${escapeHtml(acc.status || '-')}</span></td>
                <td>
                    <a href="/inventory/sf/accessory/${acc.id}" class="sf-btn sf-btn-neutral" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View</a>
                </td>
            </tr>
        `}).join('');
    }

    // Update pagination
    document.getElementById('pageStart').textContent = filteredData.length > 0 ? startIdx + 1 : 0;
    document.getElementById('pageEnd').textContent = Math.min(endIdx, filteredData.length);
    document.getElementById('totalRecords').textContent = filteredData.length;
    document.getElementById('pageNumber').textContent = `Page ${currentPage}`;
    document.getElementById('tableInfo').textContent = `Showing ${pageData.length} of ${filteredData.length} results`;

    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = endIdx >= filteredData.length;
}

// ===============================
// Bulk Edit Functions
// ===============================

// Toggle item selection
function toggleItemSelection(id, checked) {
    if (checked) {
        selectedItems.add(id);
    } else {
        selectedItems.delete(id);
    }
    updateBulkActionsBar();
    updateSelectAllCheckbox();

    // Update row styling
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (row) {
        row.classList.toggle('selected', checked);
    }
}

// Toggle select all for current page
function toggleSelectAll(checkbox) {
    const pageCheckboxes = document.querySelectorAll('.row-checkbox');
    pageCheckboxes.forEach(cb => {
        const id = parseInt(cb.dataset.id);
        if (checkbox.checked) {
            selectedItems.add(id);
            cb.checked = true;
            cb.closest('tr').classList.add('selected');
        } else {
            selectedItems.delete(id);
            cb.checked = false;
            cb.closest('tr').classList.remove('selected');
        }
    });
    updateBulkActionsBar();
}

// Update select all checkbox state
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (!selectAllCheckbox) return; // Guard against null element

    const pageCheckboxes = document.querySelectorAll('.row-checkbox');
    if (pageCheckboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        return;
    }
    const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
    selectAllCheckbox.checked = checkedCount === pageCheckboxes.length;
    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < pageCheckboxes.length;
}

// Update bulk actions bar visibility
function updateBulkActionsBar() {
    const bar = document.getElementById('bulkActionsBar');
    const countSpan = document.getElementById('selectedCount');
    if (selectedItems.size > 0) {
        bar.style.display = 'block';
        countSpan.textContent = `${selectedItems.size} item${selectedItems.size > 1 ? 's' : ''} selected`;
    } else {
        bar.style.display = 'none';
    }
    updateExportButtonText();
}

// Update export button text based on selection
function updateExportButtonText() {
    const exportBtnText = document.getElementById('exportBtnText');
    if (!exportBtnText) return;

    const currentTab = document.querySelector('.sf-tab.active')?.dataset?.tab || 'tech';

    if (currentTab === 'tech' && selectedItems.size > 0) {
        exportBtnText.textContent = `Export (${selectedItems.size})`;
    } else {
        exportBtnText.textContent = 'Export';
    }
}

// Clear selection
function clearSelection() {
    selectedItems.clear();
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.checked = false;
        cb.closest('tr').classList.remove('selected');
    });
    document.getElementById('selectAllCheckbox').checked = false;
    document.getElementById('selectAllCheckbox').indeterminate = false;
    updateBulkActionsBar();
}

// Store original values for change detection
let originalBulkEditData = {};

// Open bulk edit modal
function openBulkEditModal() {
    document.getElementById('bulkEditCount').textContent = selectedItems.size;
    document.getElementById('bulkEditModal').style.display = 'flex';

    // Build status options HTML - must match AssetStatus enum values
    const statusOptions = `
        <option value="In Stock">In Stock</option>
        <option value="Ready to Deploy">Ready to Deploy</option>
        <option value="Shipped">Shipped</option>
        <option value="Deployed">Deployed</option>
        <option value="Repair">Repair</option>
        <option value="Archived">Archived</option>
        <option value="Disposed">Disposed</option>
    `;

    // Build country options
    let countryOptions = '';
    if (filterOptions.countries) {
        filterOptions.countries.forEach(c => {
            countryOptions += `<option value="${escapeHtml(c.value)}">${escapeHtml(c.label)}</option>`;
        });
    }

    // Build company options
    let companyOptions = '';
    if (filterOptions.companies) {
        filterOptions.companies.forEach(c => {
            companyOptions += `<option value="${escapeHtml(c.value)}">${escapeHtml(c.label)}</option>`;
        });
    }

    // Build location options
    let locationOptions = '';
    if (filterOptions.locations) {
        filterOptions.locations.forEach(loc => {
            locationOptions += `<option value="${escapeHtml(loc.value)}">${escapeHtml(loc.label)}</option>`;
        });
    }

    // Get selected items data
    const selectedAssets = assetData.filter(a => selectedItems.has(a.id));
    originalBulkEditData = {};

    const tbody = document.getElementById('bulkEditTableBody');
    tbody.innerHTML = selectedAssets.map(asset => {
        // Store original values
        originalBulkEditData[asset.id] = {
            asset_tag: asset.asset_tag || '',
            name: asset.name || '',
            serial_number: asset.serial_number || '',
            status: asset.status || '',
            country: asset.country || '',
            company: asset.company || '',
            location: asset.location || '',
            category: asset.category || ''
        };

        return `
            <tr data-asset-id="${asset.id}">
                <td>
                    <input type="text" class="bulk-edit-field" data-field="asset_tag" data-id="${asset.id}"
                           value="${escapeHtml(asset.asset_tag || '')}"
                           onchange="markFieldChanged(this)">
                </td>
                <td>
                    <input type="text" class="bulk-edit-field" data-field="name" data-id="${asset.id}"
                           value="${escapeHtml(asset.name || '')}"
                           onchange="markFieldChanged(this)">
                </td>
                <td>
                    <input type="text" class="bulk-edit-field" data-field="serial_number" data-id="${asset.id}"
                           value="${escapeHtml(asset.serial_number || '')}"
                           onchange="markFieldChanged(this)">
                </td>
                <td>
                    <select class="bulk-edit-field" data-field="status" data-id="${asset.id}" onchange="markFieldChanged(this)">
                        ${statusOptions.replace(`value="${escapeHtml(asset.status)}"`, `value="${escapeHtml(asset.status)}" selected`)}
                    </select>
                </td>
                <td>
                    <select class="bulk-edit-field" data-field="country" data-id="${asset.id}" onchange="markFieldChanged(this)">
                        <option value="">--</option>
                        ${countryOptions.replace(`value="${escapeHtml(asset.country)}"`, `value="${escapeHtml(asset.country)}" selected`)}
                    </select>
                </td>
                <td>
                    <select class="bulk-edit-field" data-field="company" data-id="${asset.id}" onchange="markFieldChanged(this)">
                        <option value="">--</option>
                        ${companyOptions.replace(`value="${escapeHtml(asset.company)}"`, `value="${escapeHtml(asset.company)}" selected`)}
                    </select>
                </td>
                <td>
                    <select class="bulk-edit-field" data-field="location" data-id="${asset.id}" onchange="markFieldChanged(this)">
                        <option value="">--</option>
                        ${locationOptions.replace(`value="${escapeHtml(asset.location)}"`, `value="${escapeHtml(asset.location)}" selected`)}
                    </select>
                </td>
                <td>
                    <input type="text" class="bulk-edit-field" data-field="category" data-id="${asset.id}"
                           value="${escapeHtml(asset.category || '')}"
                           onchange="markFieldChanged(this)">
                </td>
            </tr>
        `;
    }).join('');
}

// Mark field as changed
function markFieldChanged(input) {
    const id = parseInt(input.dataset.id);
    const field = input.dataset.field;
    const originalValue = originalBulkEditData[id][field] || '';
    const currentValue = input.value || '';

    if (currentValue !== originalValue) {
        input.classList.add('changed');
    } else {
        input.classList.remove('changed');
    }
}

// Close bulk edit modal
function closeBulkEditModal() {
    document.getElementById('bulkEditModal').style.display = 'none';
}

// Apply bulk edit
async function applyBulkEdit() {
    // Collect all changes
    const updates = [];
    const fields = document.querySelectorAll('.bulk-edit-field');

    // Group by asset ID
    const assetChanges = {};
    fields.forEach(field => {
        const id = parseInt(field.dataset.id);
        const fieldName = field.dataset.field;
        const currentValue = field.value || '';
        const originalValue = originalBulkEditData[id][fieldName] || '';

        if (currentValue !== originalValue) {
            if (!assetChanges[id]) {
                assetChanges[id] = { id: id, changes: {} };
            }
            // Map field names to backend expected names
            const backendField = fieldName === 'category' ? 'asset_type' : fieldName;
            assetChanges[id].changes[backendField] = currentValue;
        }
    });

    const changedAssets = Object.values(assetChanges);

    if (changedAssets.length === 0) {
        alert('No changes detected.');
        return;
    }

    try {
        const response = await fetch('/inventory/api/sf/bulk-update-individual', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ assets: changedAssets })
        });

        // Check if response is ok before parsing JSON
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error response:', response.status, errorText);
            alert(`Server error (${response.status}): ${errorText.substring(0, 200)}`);
            return;
        }

        const data = await response.json();

        if (data.success) {
            closeBulkEditModal();
            clearSelection();

            // Show success message
            alert(`Successfully updated ${data.updated_count} items.`);

            // Reload data
            loadAssets();
        } else {
            alert('Error: ' + (data.error || 'Failed to update items'));
        }
    } catch (error) {
        console.error('Bulk update error:', error);
        alert('Error: ' + (error.message || 'An error occurred while updating items.'));
    }
}

// ============================================================================
// MAINTENANCE ASSETS SECTION
// ============================================================================

// Maintenance Section State
let maintenanceData = [];
let selectedMaintenanceAssets = new Set();

// Load maintenance assets from API
async function loadMaintenanceAssets() {
    const loadingState = document.getElementById('maintenanceLoadingState');
    const emptyState = document.getElementById('maintenanceEmptyState');
    const tableBody = document.getElementById('maintenanceTableBody');
    const searchInput = document.getElementById('maintenanceSearchInput');

    try {
        // Show loading
        loadingState.style.display = 'block';
        emptyState.style.display = 'none';
        tableBody.innerHTML = '';

        // Build URL with search parameter
        const searchTerm = searchInput.value.trim();
        const url = '/inventory/maintenance-assets' + (searchTerm ? `?search=${encodeURIComponent(searchTerm)}` : '');

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        maintenanceData = data.assets || [];

        // Update count badge
        const countBadge = document.getElementById('maintenanceCountBadge');
        countBadge.textContent = data.total_count || 0;

        // Hide loading
        loadingState.style.display = 'none';

        // Render table or show empty state
        if (maintenanceData.length === 0) {
            emptyState.style.display = 'block';
        } else {
            renderMaintenanceTable();
        }

    } catch (error) {
        console.error('Error loading maintenance assets:', error);
        loadingState.style.display = 'none';
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align: center; padding: 2rem; color: #dc2626;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error loading maintenance assets. Please try again.
                </td>
            </tr>
        `;
    }
}

// Render maintenance table
function renderMaintenanceTable() {
    const tableBody = document.getElementById('maintenanceTableBody');
    const isAdmin = {% if current_user.is_super_admin or current_user.is_developer %}true{% else %}false{% endif %};

    tableBody.innerHTML = maintenanceData.map(asset => {
        const isSelected = selectedMaintenanceAssets.has(asset.id);
        const erasedStatus = (asset.erased || '').toUpperCase();
        const erasedBadgeClass = erasedStatus === 'COMPLETED' ? 'completed' :
                                 erasedStatus === 'EWASTE' ? 'ewaste' : 'pending';

        return `
            <tr data-asset-id="${asset.id}">
                ${isAdmin ? `
                <td>
                    <input type="checkbox"
                           class="maintenance-asset-checkbox"
                           ${isSelected ? 'checked' : ''}
                           onchange="toggleMaintenanceAssetSelection(${asset.id})">
                </td>
                ` : ''}
                <td><strong>${asset.asset_tag || '-'}</strong></td>
                <td>${asset.serial_num || '-'}</td>
                <td>
                    <div>${asset.product || asset.model || '-'}</div>
                    ${asset.cpu_type ? `<div style="font-size: 0.75rem; color: var(--sf-gray-600);">${asset.cpu_type}</div>` : ''}
                </td>
                <td>${asset.customer || '-'}</td>
                <td>${asset.country || '-'}</td>
                <td>${asset.inventory || 'Unknown'}</td>
                <td>
                    <span class="sf-maintenance-status-badge ${erasedBadgeClass}">
                        ${asset.erased || 'Pending'}
                    </span>
                </td>
                ${isAdmin ? `
                <td>
                    <select class="sf-select"
                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                            onchange="updateSingleAssetStatus(${asset.id}, this.value)">
                        <option value="">Update...</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="EWASTE">E-Waste</option>
                    </select>
                </td>
                ` : ''}
            </tr>
        `;
    }).join('');

    updateBulkActionButtons();
}

// Search maintenance assets
function searchMaintenanceAssets() {
    // Debounce search
    clearTimeout(window.maintenanceSearchTimeout);
    window.maintenanceSearchTimeout = setTimeout(() => {
        loadMaintenanceAssets();
    }, 500);
}

// Refresh maintenance assets
function refreshMaintenanceAssets() {
    selectedMaintenanceAssets.clear();
    loadMaintenanceAssets();
}

// Toggle single asset selection
function toggleMaintenanceAssetSelection(assetId) {
    if (selectedMaintenanceAssets.has(assetId)) {
        selectedMaintenanceAssets.delete(assetId);
    } else {
        selectedMaintenanceAssets.add(assetId);
    }
    updateBulkActionButtons();
}

// Toggle select all
function toggleSelectAllMaintenance() {
    const selectAllCheckbox = document.getElementById('selectAllMaintenance');
    const checkboxes = document.querySelectorAll('.maintenance-asset-checkbox');

    if (selectAllCheckbox.checked) {
        maintenanceData.forEach(asset => selectedMaintenanceAssets.add(asset.id));
        checkboxes.forEach(cb => cb.checked = true);
    } else {
        selectedMaintenanceAssets.clear();
        checkboxes.forEach(cb => cb.checked = false);
    }

    updateBulkActionButtons();
}

// Update bulk action button states
function updateBulkActionButtons() {
    const bulkBtn = document.getElementById('bulkMarkCompletedBtn');
    if (bulkBtn) {
        bulkBtn.disabled = selectedMaintenanceAssets.size === 0;
    }
}

// Bulk mark as completed
async function bulkMarkCompleted() {
    if (selectedMaintenanceAssets.size === 0) return;

    if (!confirm(`Mark ${selectedMaintenanceAssets.size} asset(s) as COMPLETED?`)) {
        return;
    }

    try {
        const response = await fetch('/inventory/bulk-update-erased', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                asset_ids: Array.from(selectedMaintenanceAssets),
                erased_status: 'COMPLETED'
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update assets');
        }

        // Success - refresh data
        selectedMaintenanceAssets.clear();
        await loadMaintenanceAssets();

        // Show success message
        alert('Assets marked as completed successfully');

    } catch (error) {
        console.error('Error updating assets:', error);
        alert('Error updating assets. Please try again.');
    }
}

// Update single asset status
async function updateSingleAssetStatus(assetId, status) {
    if (!status) return;

    try {
        const response = await fetch('/inventory/bulk-update-erased', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                asset_ids: [assetId],
                erased_status: status
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update asset');
        }

        // Success - refresh data
        await loadMaintenanceAssets();

    } catch (error) {
        console.error('Error updating asset:', error);
        alert('Error updating asset. Please try again.');
    }
}


</script>
{% endblock %}
