{% extends 'base.html' %}

{% block title %}Manage Queue Permissions{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="card-title mb-0">
                <i class="fas fa-lock"></i> Support Queue Access Management
            </h4>
        </div>
        <div class="card-body">
            <p class="alert alert-info">
                <i class="fas fa-info-circle"></i> Configure which companies can access which support queues. By default, companies can see all queues unless restricted.
            </p>

            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th>Company</th>
                            {% for queue in queues %}
                            <th class="text-center">{{ queue.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for company in companies %}
                        <tr>
                            <td>{{ company.name }}</td>
                            {% for queue in queues %}
                            <td class="text-center">
                                {% set permission = permission_map.get(company.id, {}).get(queue.id, None) %}
                                <button type="button" class="btn btn-sm btn-outline-primary" data-toggle="modal" data-target="#permissionModal"
                                        data-company-id="{{ company.id }}" data-company-name="{{ company.name }}"
                                        data-queue-id="{{ queue.id }}" data-queue-name="{{ queue.name }}"
                                        data-can-view="{{ '1' if permission and permission.can_view else '0' }}"
                                        data-can-create="{{ '1' if permission and permission.can_create else '0' }}"
                                        data-permission-id="{{ permission.id if permission else '' }}">
                                    {% if permission and permission.can_view %}
                                        <i class="fas fa-check text-success"></i>
                                    {% else %}
                                        <i class="fas fa-times text-danger"></i>
                                    {% endif %}
                                </button>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Permission Modal -->
<div class="modal fade" id="permissionModal" tabindex="-1" role="dialog" aria-labelledby="permissionModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="permissionModalLabel">Edit Queue Permissions</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form action="{{ url_for('admin.update_queue_permissions') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="company_id" id="modalCompanyId">
                <input type="hidden" name="queue_id" id="modalQueueId">
                <div class="modal-body">
                    <p>Configure permissions for <strong id="modalCompanyName"></strong> to access the <strong id="modalQueueName"></strong> queue.</p>
                    
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="canView" name="can_view">
                            <label class="custom-control-label" for="canView">Can View Queue</label>
                            <small class="form-text text-muted">Allow users from this company to see this queue and its tickets</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="canCreate" name="can_create">
                            <label class="custom-control-label" for="canCreate">Can Create Tickets</label>
                            <small class="form-text text-muted">Allow users from this company to create tickets in this queue</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Permissions</button>
                </div>
            </form>

            <!-- Delete Permission Form (in modal footer) -->
            <form id="deletePermissionForm" action="{{ url_for('admin.delete_queue_permission') }}" method="POST" class="d-none">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="permission_id" id="deletePermissionId">
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#permissionModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var companyId = button.data('company-id');
        var companyName = button.data('company-name');
        var queueId = button.data('queue-id');
        var queueName = button.data('queue-name');
        var canView = button.data('can-view') === '1';
        var canCreate = button.data('can-create') === '1';
        var permissionId = button.data('permission-id');
        
        var modal = $(this);
        modal.find('#modalCompanyId').val(companyId);
        modal.find('#modalQueueId').val(queueId);
        modal.find('#modalCompanyName').text(companyName);
        modal.find('#modalQueueName').text(queueName);
        modal.find('#canView').prop('checked', canView);
        modal.find('#canCreate').prop('checked', canCreate);
        
        // Show or hide delete button based on whether a permission exists
        if (permissionId) {
            $('#deletePermissionId').val(permissionId);
            $('#deletePermissionBtn').removeClass('d-none');
        } else {
            $('#deletePermissionBtn').addClass('d-none');
        }
    });
    
    // Delete button handling
    $('#deletePermissionBtn').click(function(e) {
        e.preventDefault();
        if(confirm('Are you sure you want to reset this permission to default?')) {
            $('#deletePermissionForm').submit();
        }
    });
});
</script>
{% endblock %} 