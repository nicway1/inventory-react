{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Billing Generator</h1>
        <div class="flex space-x-3">
            <button onclick="generateBillingReport()" id="generateBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fas fa-file-invoice-dollar mr-2"></i>Generate Report
            </button>
            <button onclick="exportBillingReport()" id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" style="display: none;">
                <i class="fas fa-download mr-2"></i>Export to Excel
            </button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">Billing Filters</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
            <!-- Year/Month Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Year</label>
                <select id="yearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Years</option>
                    {% for range in date_ranges %}
                        <option value="{{ range.year }}">{{ range.year }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Month</label>
                <select id="monthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>

            <!-- Country Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                <select id="countryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Countries</option>
                    {% for country in countries %}
                        <option value="{{ country }}">{{ country }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Company Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Company</label>
                <select id="companyFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Companies</option>
                    {% for company in companies %}
                        <option value="{{ company.id }}">{{ company.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Action Button -->
            <div class="flex items-end">
                <button onclick="loadTickets()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    <i class="fas fa-search mr-2"></i>Load Tickets
                </button>
            </div>
        </div>
    </div>

    <!-- Tickets Selection Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Tickets for Billing</h2>
            <div class="flex space-x-3">
                <button onclick="selectAllTickets()" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-check-square mr-1"></i>Select All
                </button>
                <button onclick="deselectAllTickets()" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-square mr-1"></i>Deselect All
                </button>
                <span id="ticketCount" class="text-gray-600 font-medium">0 tickets found</span>
            </div>
        </div>

        <div id="ticketsContainer" class="min-h-48">
            <div class="text-center py-12 text-gray-500">
                <i class="fas fa-ticket-alt text-4xl mb-4"></i>
                <p>Select filters and click "Load Tickets" to view available tickets for billing</p>
            </div>
        </div>
    </div>

    <!-- Billing Report Section -->
    <div id="billingReportSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
        <h2 class="text-xl font-semibold mb-4">Billing Report</h2>
        <div id="billingReportContainer"></div>
    </div>
</div>

<!-- CSRF Token -->
<script>
    const csrfTokenBilling = '{{ csrf_token() }}';
    let currentTickets = [];
    let currentBillingData = {};
</script>

<script>
// Load tickets based on filters
function loadTickets() {
    const year = document.getElementById('yearFilter').value;
    const month = document.getElementById('monthFilter').value;
    const country = document.getElementById('countryFilter').value;
    const companyId = document.getElementById('companyFilter').value;
    
    if (!year && !month && !country && !companyId) {
        alert('Please select at least one filter to load tickets');
        return;
    }
    
    // Show loading state
    document.getElementById('ticketsContainer').innerHTML = `
        <div class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading tickets...</p>
        </div>
    `;
    
    fetch('/admin/billing-generator/tickets', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfTokenBilling
        },
        body: JSON.stringify({
            year: year,
            month: month,
            country: country,
            company_id: companyId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentTickets = data.tickets;
            displayTickets(data.tickets);
            updateTicketCount(data.count);
        } else {
            document.getElementById('ticketsContainer').innerHTML = `
                <div class="text-center py-12 text-red-600">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p>Error loading tickets: ${data.error}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('ticketsContainer').innerHTML = `
            <div class="text-center py-12 text-red-600">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <p>Network error occurred while loading tickets</p>
            </div>
        `;
    });
}

// Display tickets in a table
function displayTickets(tickets) {
    if (tickets.length === 0) {
        document.getElementById('ticketsContainer').innerHTML = `
            <div class="text-center py-12 text-gray-500">
                <i class="fas fa-inbox text-4xl mb-4"></i>
                <p>No tickets found matching the selected filters</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="overflow-x-auto">
            <table class="min-w-full table-auto">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllTickets(this)" class="rounded">
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Country</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
    `;
    
    tickets.forEach(ticket => {
        html += `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-4">
                    <input type="checkbox" class="ticket-checkbox rounded" value="${ticket.id}" onchange="updateGenerateButton()">
                </td>
                <td class="px-4 py-4 text-sm font-medium text-blue-600">#${ticket.id}</td>
                <td class="px-4 py-4 text-sm text-gray-900">${ticket.subject}</td>
                <td class="px-4 py-4">
                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(ticket.status)}">
                        ${ticket.status}
                    </span>
                </td>
                <td class="px-4 py-4 text-sm text-gray-600">${ticket.category}</td>
                <td class="px-4 py-4 text-sm text-gray-600">${ticket.country}</td>
                <td class="px-4 py-4 text-sm text-gray-600">${ticket.company}</td>
                <td class="px-4 py-4 text-sm text-gray-600">${new Date(ticket.created_at).toLocaleDateString()}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('ticketsContainer').innerHTML = html;
}

// Get status color classes
function getStatusColor(status) {
    switch(status.toLowerCase()) {
        case 'open': return 'bg-blue-100 text-blue-800';
        case 'in progress': return 'bg-yellow-100 text-yellow-800';
        case 'closed': return 'bg-green-100 text-green-800';
        case 'cancelled': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

// Update ticket count
function updateTicketCount(count) {
    document.getElementById('ticketCount').textContent = `${count} tickets found`;
}

// Toggle all tickets
function toggleAllTickets(checkbox) {
    const ticketCheckboxes = document.querySelectorAll('.ticket-checkbox');
    ticketCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateGenerateButton();
}

// Select all tickets
function selectAllTickets() {
    const ticketCheckboxes = document.querySelectorAll('.ticket-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    ticketCheckboxes.forEach(cb => {
        cb.checked = true;
    });
    
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = true;
    }
    
    updateGenerateButton();
}

// Deselect all tickets
function deselectAllTickets() {
    const ticketCheckboxes = document.querySelectorAll('.ticket-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    ticketCheckboxes.forEach(cb => {
        cb.checked = false;
    });
    
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
    }
    
    updateGenerateButton();
}

// Update generate button state
function updateGenerateButton() {
    const selectedTickets = document.querySelectorAll('.ticket-checkbox:checked');
    const generateBtn = document.getElementById('generateBtn');
    
    generateBtn.disabled = selectedTickets.length === 0;
}

// Generate billing report
function generateBillingReport() {
    const selectedTickets = Array.from(document.querySelectorAll('.ticket-checkbox:checked')).map(cb => cb.value);
    const year = document.getElementById('yearFilter').value;
    const month = document.getElementById('monthFilter').value;
    
    if (selectedTickets.length === 0) {
        alert('Please select at least one ticket');
        return;
    }
    
    // Show loading state
    document.getElementById('billingReportSection').style.display = 'block';
    document.getElementById('billingReportContainer').innerHTML = `
        <div class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Generating billing report...</p>
        </div>
    `;
    
    fetch('/admin/billing-generator/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfTokenBilling
        },
        body: JSON.stringify({
            ticket_ids: selectedTickets,
            year: year,
            month: month
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentBillingData = data;
            displayBillingReport(data);
            document.getElementById('exportBtn').style.display = 'inline-block';
        } else {
            document.getElementById('billingReportContainer').innerHTML = `
                <div class="text-center py-12 text-red-600">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p>Error generating report: ${data.error}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('billingReportContainer').innerHTML = `
            <div class="text-center py-12 text-red-600">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <p>Network error occurred while generating report</p>
            </div>
        `;
    });
}

// Display billing report
function displayBillingReport(data) {
    const { billing_data, year, month, month_name } = data;
    
    let html = `
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900">
                Billing Report${month_name ? ` - ${month_name} ${year}` : ''}
            </h3>
            <p class="text-gray-600">Generated on ${new Date().toLocaleDateString()}</p>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full table-auto border-collapse border border-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="border border-gray-300 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Country</th>
                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tickets</th>
                        <th class="border border-gray-300 px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Receiving Fee</th>
                        <th class="border border-gray-300 px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Storage Fee</th>
                        <th class="border border-gray-300 px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Order Fee</th>
                        <th class="border border-gray-300 px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Return Fee</th>
                        <th class="border border-gray-300 px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Intake Fee</th>
                        <th class="border border-gray-300 px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Management Fee</th>
                        <th class="border border-gray-300 px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total Amount</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
    `;
    
    let grandTotal = 0;
    let totalTickets = 0;
    
    Object.entries(billing_data).forEach(([country, data]) => {
        grandTotal += data.total_amount;
        totalTickets += data.quantity;
        
        html += `
            <tr class="hover:bg-gray-50">
                <td class="border border-gray-300 px-4 py-3 font-medium text-gray-900">${country}</td>
                <td class="border border-gray-300 px-4 py-3 text-center">${data.quantity}</td>
                <td class="border border-gray-300 px-4 py-3 text-right">$${data.fees.receiving_fee.toFixed(2)}</td>
                <td class="border border-gray-300 px-4 py-3 text-right">$${data.fees.warehouse_storage_fee.toFixed(2)}</td>
                <td class="border border-gray-300 px-4 py-3 text-right">$${data.fees.order_fee.toFixed(2)}</td>
                <td class="border border-gray-300 px-4 py-3 text-right">$${data.fees.return_fee.toFixed(2)}</td>
                <td class="border border-gray-300 px-4 py-3 text-right">$${data.fees.intake_fee.toFixed(2)}</td>
                <td class="border border-gray-300 px-4 py-3 text-right">$${data.fees.management_fee.toFixed(2)}</td>
                <td class="border border-gray-300 px-4 py-3 text-right font-bold">$${data.total_amount.toFixed(2)}</td>
            </tr>
        `;
    });
    
    // Add totals row
    html += `
                <tr class="bg-gray-100 font-bold">
                    <td class="border border-gray-300 px-4 py-3">TOTAL</td>
                    <td class="border border-gray-300 px-4 py-3 text-center">${totalTickets}</td>
                    <td class="border border-gray-300 px-4 py-3 text-right" colspan="6"></td>
                    <td class="border border-gray-300 px-4 py-3 text-right text-lg">$${grandTotal.toFixed(2)}</td>
                </tr>
            </tbody>
        </table>
    </div>
    `;
    
    document.getElementById('billingReportContainer').innerHTML = html;
}

// Export billing report
function exportBillingReport() {
    if (!currentBillingData.billing_data) {
        alert('No billing data to export');
        return;
    }
    
    fetch('/admin/billing-generator/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfTokenBilling
        },
        body: JSON.stringify(currentBillingData)
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Export failed');
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `billing_report_${currentBillingData.year || 'all'}_${currentBillingData.month || 'months'}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error exporting report. Please try again.');
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set current month and year as default
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    
    document.getElementById('yearFilter').value = currentYear;
    document.getElementById('monthFilter').value = currentMonth;
});
</script>

{% endblock %} 