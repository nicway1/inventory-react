{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-5xl mx-auto">
        <!-- Back Link -->
        <div class="mb-6">
            <a href="{{ url_for('admin.manage_users') }}"
               class="text-blue-600 hover:text-blue-800">
                ‚Üê Back to Users
            </a>
        </div>

        <!-- Page Title -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
            <div class="px-6 py-4 bg-blue-600 text-white">
                <h1 class="text-2xl font-bold">Mass Create Users</h1>
                <p class="text-blue-100 mt-1">Create multiple user accounts at once</p>
            </div>
        </div>

        <!-- Info Alert -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">
                        <strong>Note:</strong> Welcome emails will be sent automatically to all created users with their login credentials.
                    </p>
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <form id="massCreateForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <!-- Step 1: Clone Settings -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-blue-600 text-white text-sm font-bold mr-2">1</span>
                        Clone Settings (Optional)
                    </h2>
                </div>
                <div class="px-6 py-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Source User</label>
                    <select class="w-full md:w-2/3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            id="sourceUser" name="source_user_id">
                        <option value="">-- No source user (users will be created as CLIENT type) --</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-2">Clone permissions, company assignment, and user type from an existing user</p>
                </div>
            </div>

            <!-- Step 2: Email List -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-blue-600 text-white text-sm font-bold mr-2">2</span>
                        Enter Email Addresses
                    </h2>
                </div>
                <div class="px-6 py-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Addresses</label>
                    <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                              id="emailList" rows="5"
                              placeholder="Enter email addresses (one per line or comma-separated)&#10;&#10;Example:&#10;john.doe@company.com&#10;jane.smith@company.com"></textarea>
                    <button type="button"
                            class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-medium transition-colors"
                            onclick="generateUserFields()">
                        Generate User Fields
                    </button>
                </div>
            </div>

            <!-- Step 3: User Fields (Hidden by default) -->
            <div id="userFieldsSection" style="display: none;">
                <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                        <h2 class="text-lg font-semibold text-gray-800">
                            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-blue-600 text-white text-sm font-bold mr-2">3</span>
                            Configure Users & Set Passwords
                        </h2>
                    </div>
                    <div class="px-6 py-4">
                        <div id="userFieldsContainer"></div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="flex justify-center gap-4 mb-8">
                    <button type="button"
                            class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-md font-semibold text-lg transition-colors"
                            onclick="submitMassCreate()">
                        Create All Users
                    </button>
                    <a href="{{ url_for('admin.manage_users') }}"
                       class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-md font-semibold text-lg transition-colors">
                        Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" role="dialog" style="display: none;">
    <div class="modal-dialog modal-xl" role="document" style="max-width: 900px;">
        <div class="modal-content" style="border: none; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 1.5rem 2rem; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem;">
                <div>
                    <h5 class="modal-title" style="font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                        <svg style="width: 2rem; height: 2rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Users Created Successfully
                    </h5>
                    <p style="margin: 0.5rem 0 0 2.75rem; opacity: 0.9; font-size: 0.9375rem;">Welcome emails have been sent to all users</p>
                </div>
                <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1; text-shadow: none; font-size: 2rem; font-weight: 300; margin: 0; padding: 0; background: none; border: none; cursor: pointer;">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <div id="resultsContent"></div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1.25rem 2rem; background: #f9fafb; border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem;">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" style="padding: 0.625rem 1.25rem; font-weight: 600;">Close</button>
                <a href="{{ url_for('admin.manage_users') }}" class="btn btn-success" style="padding: 0.625rem 1.5rem; font-weight: 600; background: #10b981; border-color: #10b981;">
                    <svg style="width: 1.125rem; height: 1.125rem; display: inline; margin-right: 0.375rem; margin-top: -2px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    Go to User List
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.user-card {
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
    background: #fafafa;
}

.user-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
}

.results-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    overflow: hidden;
}

.results-table th {
    background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
    padding: 1rem;
    text-align: left;
    font-weight: 700;
    border-bottom: 2px solid #d1d5db;
    font-size: 0.8125rem;
    color: #374151;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.results-table td {
    padding: 1rem;
    border-bottom: 1px solid #f3f4f6;
    font-size: 0.9375rem;
}

.results-table tbody tr {
    transition: background-color 0.15s ease;
}

.results-table tbody tr:hover {
    background: #fafbfc;
}

.results-table tbody tr:last-child td {
    border-bottom: none;
}

.password-display {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    padding: 0.5rem 0.875rem;
    border-radius: 0.5rem;
    font-family: 'Courier New', 'Monaco', monospace;
    font-weight: 700;
    color: #92400e;
    font-size: 0.875rem;
    display: inline-block;
    border: 1px solid #fcd34d;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    letter-spacing: 0.025em;
}
</style>

<script>
let userCount = 0;

document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded');
    loadUsersForCloning();
});

function loadUsersForCloning() {
    console.log('Starting to load users for cloning...');

    fetch('/admin/api/users-for-cloning')
        .then(response => {
            console.log('Response received, status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            const select = document.getElementById('sourceUser');

            if (data.success && data.users && data.users.length > 0) {
                console.log('Processing ' + data.users.length + ' users');
                data.users.forEach(user => {
                    const companyInfo = user.company ? ` (${user.company})` : '';
                    const displayName = `${user.username} - ${user.user_type}${companyInfo}`;
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = displayName;
                    select.appendChild(option);
                });
                console.log('Successfully loaded ' + data.users.length + ' users');
            } else {
                console.warn('No users found or data format incorrect');
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
        });
}

function generateUserFields() {
    const emailList = document.getElementById('emailList').value.trim();

    if (!emailList) {
        alert('Please enter at least one email address');
        return;
    }

    const emails = emailList
        .split(/[\n,]+/)
        .map(e => e.trim())
        .filter(e => e.length > 0);

    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }

    const container = document.getElementById('userFieldsContainer');
    container.innerHTML = '';
    userCount = 0;

    emails.forEach(email => {
        addUserField(email);
    });

    const section = document.getElementById('userFieldsSection');
    section.style.display = 'block';

    // Smooth scroll
    setTimeout(() => {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}

function addUserField(email = '') {
    userCount++;
    const index = userCount;
    const username = email ? email.split('@')[0].toLowerCase().replace(/[^a-z0-9_]/g, '_') : '';

    const html = `
        <div class="user-card" id="userCard_${index}">
            <div class="user-card-header">
                <div class="font-semibold text-gray-700">
                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 text-white text-sm font-bold mr-2">${index}</span>
                    User #${index}
                </div>
                <button type="button" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm"
                        onclick="removeUserField(${index})">
                    Remove
                </button>
            </div>
            <div class="space-y-3">
                <div class="flex flex-col md:flex-row md:gap-4">
                    <div class="flex-1 mb-3 md:mb-0">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               name="username_${index}" value="${username}" required>
                    </div>
                    <div class="flex-1 mb-3 md:mb-0">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               name="email_${index}" value="${email}" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                    <div class="flex gap-2">
                        <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               name="password_${index}" id="password_${index}" placeholder="Enter password or click generate" required>
                        <button type="button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium whitespace-nowrap"
                                onclick="generatePassword(${index})">
                            Generate
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('userFieldsContainer').insertAdjacentHTML('beforeend', html);
}

function removeUserField(index) {
    const card = document.getElementById(`userCard_${index}`);
    card.style.opacity = '0';
    card.style.transition = 'opacity 0.3s';

    setTimeout(() => {
        card.remove();
        const remainingCards = document.querySelectorAll('.user-card');
        if (remainingCards.length === 0) {
            document.getElementById('userFieldsSection').style.display = 'none';
        }
    }, 300);
}

function generatePassword(index) {
    const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
    let password = '';
    for (let i = 0; i < 12; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    document.getElementById(`password_${index}`).value = password;
}

function submitMassCreate() {
    const users = [];
    let isValid = true;

    const userCards = document.querySelectorAll('.user-card');
    userCards.forEach(card => {
        const cardId = card.id.split('_')[1];
        const username = card.querySelector(`input[name="username_${cardId}"]`).value.trim();
        const email = card.querySelector(`input[name="email_${cardId}"]`).value.trim();
        const password = card.querySelector(`input[name="password_${cardId}"]`).value.trim();

        if (!username || !email || !password) {
            isValid = false;
        }

        users.push({ username, email, password });
    });

    if (!isValid) {
        alert('Please fill in all required fields');
        return;
    }

    if (users.length === 0) {
        alert('No users to create');
        return;
    }

    const formData = new FormData();

    // Add CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    formData.append('csrf_token', csrfToken);

    formData.append('source_user_id', document.getElementById('sourceUser').value);
    formData.append('user_count', users.length);
    formData.append('auto_password', 'false');

    users.forEach((user, idx) => {
        const index = idx + 1;
        formData.append(`username_${index}`, user.username);
        formData.append(`email_${index}`, user.email);
        formData.append(`password_${index}`, user.password);
    });

    fetch('/admin/mass-create-users', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(response => {
        if (response.success) {
            displayResults(response.users);
            document.getElementById('emailList').value = '';
            document.getElementById('userFieldsContainer').innerHTML = '';
            document.getElementById('userFieldsSection').style.display = 'none';
            document.getElementById('sourceUser').value = '';
        } else {
            alert('Error: ' + (response.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: Failed to create users');
        console.error(error);
    });
}

function displayResults(users) {
    if (!users || users.length === 0) {
        alert('No users were created');
        return;
    }

    const resultsContent = document.getElementById('resultsContent');

    let html = '<div style="max-height: 400px; overflow-y: auto;">';
    html += '<table class="results-table" style="margin: 0;">';
    html += '<thead style="position: sticky; top: 0; background: white; z-index: 10;">';
    html += '<tr>';
    html += '<th style="width: 50px; text-align: center;">#</th>';
    html += '<th style="width: 30%;">Username</th>';
    html += '<th style="width: 35%;">Email</th>';
    html += '<th style="width: 30%;">Password</th>';
    html += '</tr></thead>';
    html += '<tbody>';

    users.forEach((user, idx) => {
        html += `<tr>
            <td style="text-align: center; font-weight: 600; color: #6b7280;">${idx + 1}</td>
            <td><strong style="color: #1f2937;">${user.username}</strong></td>
            <td style="color: #6b7280;">${user.email}</td>
            <td><span class="password-display">${user.password}</span></td>
        </tr>`;
    });

    html += '</tbody></table></div>';

    resultsContent.innerHTML = html;
    openModal();
}

function openModal() {
    const modal = document.getElementById('resultsModal');
    modal.classList.add('show');
    modal.style.display = 'block';
    document.body.classList.add('modal-open');

    // Add backdrop
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.id = 'modalBackdrop';
    document.body.appendChild(backdrop);
}

// Close modal when clicking close button or backdrop
document.addEventListener('click', function(e) {
    if (e.target.matches('[data-dismiss="modal"]') || e.target.id === 'modalBackdrop') {
        const modal = document.getElementById('resultsModal');
        modal.classList.remove('show');
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');

        const backdrop = document.getElementById('modalBackdrop');
        if (backdrop) {
            backdrop.remove();
        }
    }
});
</script>
{% endblock %}
