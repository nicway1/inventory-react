{% extends "base.html" %}

{% block title %}API Documentation{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center">
                <a href="{{ url_for('admin.api_management') }}" 
                   class="mr-4 text-gray-600 hover:text-gray-900">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">üìö API Documentation</h1>
                    <p class="mt-2 text-gray-600">Complete guide to using the API endpoints</p>
                </div>
            </div>
        </div>

        <!-- Getting Started -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">üöÄ Getting Started</h2>
            </div>
            <div class="p-6">
                <div class="prose max-w-none">
                    <h3 class="text-base font-medium text-gray-900 mb-4">Authentication</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        The API supports two authentication methods:
                    </p>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Method 1: API Key Authentication</h4>
                        <p class="text-sm text-gray-600 mb-2">Use API keys for server-to-server communication:</p>
                        <pre class="text-sm text-gray-800 bg-gray-100 p-3 rounded border overflow-x-auto"><code>Authorization: Bearer YOUR_API_KEY
# or
X-API-Key: YOUR_API_KEY</code></pre>
                        
                        <h4 class="text-sm font-medium text-gray-900 mb-2 mt-4">Method 2: JWT Token Authentication</h4>
                        <p class="text-sm text-gray-600 mb-2">Use JWT tokens for user-based authentication:</p>
                        <pre class="text-sm text-gray-800 bg-gray-100 p-3 rounded border overflow-x-auto"><code># 1. Login to get JWT token
curl -X POST "{{ request.url_root }}api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "your_username", "password": "your_password"}'

# 2. Use JWT token in subsequent requests
Authorization: Bearer YOUR_JWT_TOKEN</code></pre>
                    </div>

                    <h3 class="text-base font-medium text-gray-900 mb-4">Base URL</h3>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <pre class="text-sm text-blue-800"><code>{{ request.url_root }}api/v1</code></pre>
                    </div>

                    <h3 class="text-base font-medium text-gray-900 mb-4">Response Format</h3>
                    <p class="text-sm text-gray-600 mb-4">All API responses follow a consistent JSON format:</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900 mb-2">Success Response</h4>
                            <pre class="text-sm text-gray-800 bg-gray-100 p-3 rounded border overflow-x-auto"><code>{
  "success": true,
  "data": { ... },
  "message": "Operation successful",
  "meta": { ... }
}</code></pre>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-900 mb-2">Error Response</h4>
                            <pre class="text-sm text-gray-800 bg-gray-100 p-3 rounded border overflow-x-auto"><code>{
  "error": {
    "code": "ERROR_CODE",
    "message": "Error description",
    "details": {
      "timestamp": "2024-01-15T10:30:00Z",
      "request_id": "req_123456789"
    }
  }
}</code></pre>
                        </div>
                    </div>

                    <h3 class="text-base font-medium text-gray-900 mb-4">Rate Limiting</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        API requests are rate limited per API key. Default limits are 1000 requests per hour. 
                        Rate limit information is included in response headers:
                    </p>
                    <ul class="text-sm text-gray-600 list-disc list-inside mb-6">
                        <li><code>X-RateLimit-Limit</code>: Maximum requests allowed</li>
                        <li><code>X-RateLimit-Remaining</code>: Requests remaining in current window</li>
                        <li><code>X-RateLimit-Reset</code>: Unix timestamp when limit resets</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Endpoints -->
        <div class="space-y-6">
            {% for endpoint in endpoints %}
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if endpoint.method == 'GET' %}bg-green-100 text-green-800
                                {% elif endpoint.method == 'POST' %}bg-blue-100 text-blue-800
                                {% elif endpoint.method == 'PUT' %}bg-yellow-100 text-yellow-800
                                {% elif endpoint.method == 'DELETE' %}bg-red-100 text-red-800
                                {% endif %}">
                                {{ endpoint.method }}
                            </span>
                            <h3 class="text-lg font-medium text-gray-900">{{ endpoint.name }}</h3>
                        </div>
                        {% if endpoint.auth_required %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800">
                                üîê Auth Required
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                üåê Public
                            </span>
                        {% endif %}
                    </div>
                    <div class="mt-2">
                        <code class="text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded">{{ endpoint.path }}</code>
                    </div>
                </div>
                
                <div class="p-6">
                    <p class="text-sm text-gray-600 mb-6">{{ endpoint.description }}</p>
                    
                    <!-- Permissions -->
                    {% if endpoint.permissions %}
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Required Permissions</h4>
                        <div class="flex flex-wrap gap-2">
                            {% for permission in endpoint.permissions %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                    {{ permission }}
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Parameters -->
                    {% if endpoint.parameters %}
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Parameters</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Required</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for param in endpoint.parameters %}
                                    <tr>
                                        <td class="px-4 py-2 text-sm font-medium text-gray-900">{{ param.name }}</td>
                                        <td class="px-4 py-2 text-sm text-gray-600">{{ param.type }}</td>
                                        <td class="px-4 py-2 text-sm">
                                            {% if param.required %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                    Required
                                                </span>
                                            {% else %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                    Optional
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-2 text-sm text-gray-600">{{ param.description }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Example Request -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Example Request</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <pre class="text-sm text-gray-800 overflow-x-auto"><code>curl -X {{ endpoint.method }} \
  "{{ request.url_root }}api/v1{{ endpoint.path }}" \{% if endpoint.auth_required %}
  -H "Authorization: Bearer YOUR_TOKEN" \{% endif %}
  -H "Content-Type: application/json"{% if endpoint.request_body %} \
  -d '{{ endpoint.request_body | tojson }}'{% endif %}</code></pre>
                        </div>
                    </div>
                    
                    <!-- Example Response -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Example Response</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <pre class="text-sm text-gray-800 overflow-x-auto"><code>{{ endpoint.response_example | tojson(indent=2) }}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Error Codes -->
        <div class="bg-white shadow rounded-lg mt-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">‚ö†Ô∏è Error Codes</h2>
            </div>
            <div class="p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">HTTP Status</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-4 py-2 text-sm font-medium text-gray-900">INVALID_API_KEY</td>
                                <td class="px-4 py-2 text-sm text-gray-600">401</td>
                                <td class="px-4 py-2 text-sm text-gray-600">The provided API key is invalid or expired</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-2 text-sm font-medium text-gray-900">INSUFFICIENT_PERMISSIONS</td>
                                <td class="px-4 py-2 text-sm text-gray-600">403</td>
                                <td class="px-4 py-2 text-sm text-gray-600">API key lacks required permissions for this operation</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-2 text-sm font-medium text-gray-900">RATE_LIMIT_EXCEEDED</td>
                                <td class="px-4 py-2 text-sm text-gray-600">429</td>
                                <td class="px-4 py-2 text-sm text-gray-600">Too many requests from this API key</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-2 text-sm font-medium text-gray-900">VALIDATION_ERROR</td>
                                <td class="px-4 py-2 text-sm text-gray-600">400</td>
                                <td class="px-4 py-2 text-sm text-gray-600">Request data validation failed</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-2 text-sm font-medium text-gray-900">RESOURCE_NOT_FOUND</td>
                                <td class="px-4 py-2 text-sm text-gray-600">404</td>
                                <td class="px-4 py-2 text-sm text-gray-600">Requested resource doesn't exist</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-2 text-sm font-medium text-gray-900">INTERNAL_ERROR</td>
                                <td class="px-4 py-2 text-sm text-gray-600">500</td>
                                <td class="px-4 py-2 text-sm text-gray-600">Server-side error occurred</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- iOS Integration Guide -->
        <div class="bg-white shadow rounded-lg mt-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">üì± iOS Integration Guide</h2>
            </div>
            <div class="p-6">
                <div class="prose max-w-none">
                    <h3 class="text-base font-medium text-gray-900 mb-4">Swift Example</h3>
                    <p class="text-sm text-gray-600 mb-4">Here's how to make API calls from your iOS app:</p>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <pre class="text-sm text-gray-800 overflow-x-auto"><code>import Foundation

class APIClient {
    private let baseURL = "{{ request.url_root }}api/v1"
    private let apiKey = "YOUR_API_KEY"
    
    func fetchTickets(completion: @escaping (Result&lt;[Ticket], Error&gt;) -&gt; Void) {
        guard let url = URL(string: "\(baseURL)/tickets") else { return }
        
        var request = URLRequest(url: url)
        request.setValue("Bearer \(apiKey)", forHTTPHeaderField: "Authorization")
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        
        URLSession.shared.dataTask(with: request) { data, response, error in
            // Handle response
            if let error = error {
                completion(.failure(error))
                return
            }
            
            guard let data = data else { return }
            
            do {
                let apiResponse = try JSONDecoder().decode(APIResponse&lt;[Ticket]&gt;.self, from: data)
                completion(.success(apiResponse.data))
            } catch {
                completion(.failure(error))
            }
        }.resume()
    }
}</code></pre>
                    </div>

                    <h3 class="text-base font-medium text-gray-900 mb-4">Best Practices</h3>
                    <ul class="text-sm text-gray-600 list-disc list-inside space-y-2">
                        <li>Store your API key securely using iOS Keychain</li>
                        <li>Implement proper error handling for all API responses</li>
                        <li>Use background queues for API calls to avoid blocking the UI</li>
                        <li>Implement retry logic with exponential backoff for failed requests</li>
                        <li>Cache responses locally for offline functionality</li>
                        <li>Monitor rate limits and implement appropriate delays</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}