{% extends "base.html" %}

{% block title %}Knowledge Base{% endblock %}

{% block content %}
<!-- Exact Salesforce Knowledge Base Layout -->
<div style="background: #f3f3f3; min-height: 100vh; font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;">
    
    <!-- Blue Header Section -->
    <div style="background: #1589ee; color: white; padding: 2rem 0;">
        <div class="container-fluid" style="max-width: 1200px; margin: 0 auto; padding: 0 1rem;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center;">
                    <svg style="width: 2rem; height: 2rem; margin-right: 1rem; fill: white;" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <div>
                        <h1 style="font-size: 1.75rem; font-weight: 400; margin: 0; line-height: 1.2;">Knowledge Base</h1>
                        <p style="font-size: 0.875rem; margin: 0.25rem 0 0 0; opacity: 0.9;">Find answers, procedures, and documentation</p>
                    </div>
                </div>
                {% if current_user.permissions.can_create_articles %}
                <div style="display: flex; gap: 0.5rem;">
                    <a href="{{ url_for('knowledge.admin_create_article') }}" 
                       style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1rem; border-radius: 0.25rem; text-decoration: none; font-size: 0.875rem; display: flex; align-items: center;">
                        <svg style="width: 1rem; height: 1rem; margin-right: 0.5rem; fill: white;" viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        New Article
                    </a>
                    <a href="{{ url_for('knowledge.admin_dashboard') }}" 
                       style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1rem; border-radius: 0.25rem; text-decoration: none; font-size: 0.875rem;">
                        Manage
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div style="background: #f3f3f3; padding: 1.5rem 0; border-bottom: 1px solid #e5e5e5;">
        <div class="container-fluid" style="max-width: 1200px; margin: 0 auto; padding: 0 1rem;">
            <form action="{{ url_for('knowledge.search') }}" method="GET" style="max-width: 600px; margin: 0 auto;">
                <div style="position: relative;">
                    <svg style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); width: 1.25rem; height: 1.25rem; fill: #706e6b;" viewBox="0 0 24 24">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    <input type="text" 
                           id="search-input" 
                           name="q" 
                           placeholder="Search articles, procedures, and solutions..." 
                           style="width: 100%; padding: 0.875rem 1rem 0.875rem 3rem; border: 2px solid #d8dde6; border-radius: 0.25rem; font-size: 1rem; background: white;"
                           autocomplete="off">
                    <button type="submit" 
                            style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: #1589ee; border: none; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer;">
                        <svg style="width: 1rem; height: 1rem; fill: white;" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid" style="max-width: 1200px; margin: 0 auto; padding: 2rem 1rem;">
        
        <!-- Categories Section -->
        {% if categories %}
        <div style="margin-bottom: 3rem;">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: #181818; margin-bottom: 1.5rem;">Browse by Category</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                {% for category in categories %}
                <div style="background: white; border: 1px solid #e5e5e5; border-radius: 0.5rem; overflow: hidden; transition: all 0.2s ease; cursor: pointer;" 
                     onclick="window.location.href='{{ url_for('knowledge.view_category', category_id=category.id) }}'">
                    <div style="padding: 1.5rem;">
                        <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                            <div style="background: #1589ee; padding: 0.5rem; border-radius: 0.25rem; margin-right: 1rem;">
                                <svg style="width: 1.25rem; height: 1.25rem; fill: white;" viewBox="0 0 24 24">
                                    <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                                </svg>
                            </div>
                            <h3 style="font-size: 1.125rem; font-weight: 600; color: #1589ee; margin: 0;">{{ category.name }}</h3>
                        </div>
                        {% if category.description %}
                        <p style="color: #706e6b; font-size: 0.875rem; margin-bottom: 1rem; line-height: 1.4;">{{ category.description }}</p>
                        {% endif %}
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="background: #f3f3f3; color: #706e6b; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem;">
                                {{ category.get_article_count() }} articles
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- System Documentation Section -->
        <div style="margin-bottom: 3rem;">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: #181818; margin-bottom: 1.5rem;">System Documentation</h2>
            <div style="background: linear-gradient(135deg, #0176d3 0%, #1b96ff 100%); border-radius: 0.5rem; overflow: hidden; cursor: pointer; transition: all 0.2s ease;"
                 onclick="window.location.href='{{ url_for('knowledge.list_system_docs') }}'"
                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(1,118,211,0.4)';"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <div style="padding: 1.5rem; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center;">
                        <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 0.5rem; margin-right: 1rem;">
                            <i class="fas fa-book-open" style="font-size: 1.5rem; color: white;"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.25rem; font-weight: 600; color: white; margin: 0 0 0.25rem 0;">System Docs</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 0.875rem; margin: 0;">Technical documentation, import guides, and API references that auto-sync with code updates</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="background: rgba(255,255,255,0.2); color: white; padding: 0.375rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;">
                            <i class="fas fa-sync-alt" style="margin-right: 0.25rem;"></i> Auto-Sync
                        </span>
                        <i class="fas fa-chevron-right" style="color: white; font-size: 1.25rem;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Articles Section -->
        {% if recent_articles or popular_articles %}
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Recent Articles -->
            {% if recent_articles %}
            <div>
                <h2 style="font-size: 1.25rem; font-weight: 600; color: #181818; margin-bottom: 1.5rem;">Recently Added</h2>
                <div style="background: white; border: 1px solid #e5e5e5; border-radius: 0.5rem; overflow: hidden;">
                    {% for article in recent_articles %}
                    <div style="padding: 1rem; border-bottom: 1px solid #f3f3f3; transition: background-color 0.2s ease;" 
                         onmouseover="this.style.backgroundColor='#f8f9fa'" 
                         onmouseout="this.style.backgroundColor='white'">
                        <div style="display: flex; align-items: flex-start;">
                            <div style="background: #f3f3f3; padding: 0.5rem; border-radius: 0.25rem; margin-right: 1rem; flex-shrink: 0;">
                                <svg style="width: 1rem; height: 1rem; fill: #706e6b;" viewBox="0 0 24 24">
                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                </svg>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <h3 style="margin: 0 0 0.5rem 0;">
                                    <a href="{{ url_for('knowledge.view_article', article_id=article.id) }}" 
                                       style="color: #1589ee; text-decoration: none; font-weight: 500; font-size: 0.875rem; line-height: 1.3;">
                                        {{ article.title }}
                                    </a>
                                </h3>
                                {% if article.summary %}
                                <p style="color: #706e6b; font-size: 0.75rem; margin: 0 0 0.5rem 0; line-height: 1.3;">
                                    {{ article.summary[:80] }}{% if article.summary|length > 80 %}...{% endif %}
                                </p>
                                {% endif %}
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #706e6b;">
                                    <span>
                                        {% if article.category %}{{ article.category.name }} • {% endif %}
                                        {{ article.view_count }} views
                                    </span>
                                    <span>{{ article.created_at|localtime('%b %d, %Y') }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Popular Articles -->
            {% if popular_articles %}
            <div>
                <h2 style="font-size: 1.25rem; font-weight: 600; color: #181818; margin-bottom: 1.5rem;">Most Popular</h2>
                <div style="background: white; border: 1px solid #e5e5e5; border-radius: 0.5rem; overflow: hidden;">
                    {% for article in popular_articles %}
                    <div style="padding: 1rem; border-bottom: 1px solid #f3f3f3; transition: background-color 0.2s ease;" 
                         onmouseover="this.style.backgroundColor='#f8f9fa'" 
                         onmouseout="this.style.backgroundColor='white'">
                        <div style="display: flex; align-items: flex-start;">
                            <div style="background: #f3f3f3; padding: 0.5rem; border-radius: 0.25rem; margin-right: 1rem; flex-shrink: 0;">
                                <svg style="width: 1rem; height: 1rem; fill: #706e6b;" viewBox="0 0 24 24">
                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                </svg>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <h3 style="margin: 0 0 0.5rem 0;">
                                    <a href="{{ url_for('knowledge.view_article', article_id=article.id) }}" 
                                       style="color: #1589ee; text-decoration: none; font-weight: 500; font-size: 0.875rem; line-height: 1.3;">
                                        {{ article.title }}
                                    </a>
                                </h3>
                                {% if article.summary %}
                                <p style="color: #706e6b; font-size: 0.75rem; margin: 0 0 0.5rem 0; line-height: 1.3;">
                                    {{ article.summary[:80] }}{% if article.summary|length > 80 %}...{% endif %}
                                </p>
                                {% endif %}
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #706e6b;">
                                    <span>
                                        {% if article.category %}{{ article.category.name }} • {% endif %}
                                        {{ article.view_count }} views
                                    </span>
                                    <span>Updated {{ article.updated_at|localtime('%b %d, %Y') }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Empty State -->
        {% if not recent_articles and not popular_articles %}
        <div style="text-align: center; padding: 4rem 2rem; background: white; border-radius: 0.5rem; border: 1px solid #e5e5e5;">
            <div style="background: #f3f3f3; width: 4rem; height: 4rem; border-radius: 50%; margin: 0 auto 1.5rem; display: flex; align-items: center; justify-content: center;">
                <svg style="width: 2rem; height: 2rem; fill: #706e6b;" viewBox="0 0 24 24">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
            </div>
            <h3 style="font-size: 1.25rem; font-weight: 600; color: #181818; margin-bottom: 0.5rem;">No articles in this category</h3>
            <p style="color: #706e6b; margin-bottom: 1.5rem;">Be the first to add an article to this category!</p>
            {% if current_user.permissions.can_create_articles %}
            <a href="{{ url_for('knowledge.admin_create_article') }}" 
               style="background: #1589ee; color: white; padding: 0.75rem 1.5rem; border-radius: 0.25rem; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center;">
                <svg style="width: 1rem; height: 1rem; margin-right: 0.5rem; fill: white;" viewBox="0 0 24 24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Create Article
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<style>
/* Hover effects */
div[onclick]:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

button:hover {
    background: #0070d2 !important;
}

a:hover {
    text-decoration: underline !important;
}

/* Search suggestions */
.search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #d8dde6;
    border-top: none;
    border-radius: 0 0 0.25rem 0.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
}

.search-suggestion {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f3f3f3;
    font-size: 0.875rem;
}

.search-suggestion:hover {
    background-color: #f8f9fa;
}

.search-suggestion:last-child {
    border-bottom: none;
}

/* Responsive */
@media (max-width: 768px) {
    div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
    
    div[style*="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr))"] {
        grid-template-columns: 1fr !important;
    }
}
</style>

<script>
// Enhanced search with suggestions
let searchTimeout;
const searchInput = document.getElementById('search-input');

searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    
    clearTimeout(searchTimeout);
    
    // Remove existing suggestions
    const existingSuggestions = document.querySelector('.search-suggestions');
    if (existingSuggestions) {
        existingSuggestions.remove();
    }
    
    if (query.length < 2) return;
    
    searchTimeout = setTimeout(() => {
        fetch(`{{ url_for('knowledge.search_suggestions') }}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(suggestions => {
                if (suggestions.length > 0) {
                    showSearchSuggestions(suggestions);
                }
            })
            .catch(error => console.error('Error fetching suggestions:', error));
    }, 300);
});

function showSearchSuggestions(suggestions) {
    const container = searchInput.parentElement;
    const suggestionsDiv = document.createElement('div');
    suggestionsDiv.className = 'search-suggestions';
    
    suggestions.forEach(suggestion => {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'search-suggestion';
        suggestionDiv.textContent = suggestion;
        suggestionDiv.addEventListener('click', () => {
            searchInput.value = suggestion;
            suggestionsDiv.remove();
            searchInput.form.submit();
        });
        suggestionsDiv.appendChild(suggestionDiv);
    });
    
    container.style.position = 'relative';
    container.appendChild(suggestionsDiv);
}

// Hide suggestions when clicking outside
document.addEventListener('click', function(event) {
    if (!searchInput.parentElement.contains(event.target)) {
        const suggestions = document.querySelector('.search-suggestions');
        if (suggestions) {
            suggestions.remove();
        }
    }
});

// Handle escape key
searchInput.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const suggestions = document.querySelector('.search-suggestions');
        if (suggestions) {
            suggestions.remove();
        }
    }
});
</script>
{% endblock %}